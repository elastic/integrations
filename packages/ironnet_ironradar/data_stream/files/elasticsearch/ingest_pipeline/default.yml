---
description: Pipeline for parsing the IronRadar threat intel feed.
processors:
  - json:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
      field: message
      target_field: ironradar
  - fingerprint:
      target_field: _id
      fields:
        - ironradar.indicator
        - ironradar.port
        - ironradar.threat
        - ironradar.threat_type
      ignore_missing: true

  # ecs.ecs fields
  - set:
      field: ecs.version
      value: "8.7.0"

  # ecs.event fields
  - set:
      field: event.kind
      value: enrichment
  - set:
      field: event.category
      value: threat
  - set:
      field: event.type
      value: indicator
  - rename:
      target_field: event.original
      field: message
      if: ctx.tags != null && ctx.tags.contains("preserve_original_event")
  - set:
      field: event.module
      value: ironradar
  - set:
      field: event.dataset
      value: ironradar.files

  # ecs.threat fields
  - set:
      field: threat.feed.description
      value: Threat feed from the IronNet IronRadar service.
  - set:
      field: threat.feed.name
      value: IronRadar
  - set:
      field: threat.feed.reference
      value: https://api.threatanalysis.io/integrations/all/1d/json
  - set:
      field: threat.indicator.confidence
      copy_from: ironradar.confidence
  - date:
      target_field: threat.indicator.last_seen
      field: ironradar.last_seen
      formats:
        - ISO8601
  - set:
      field: threat.indicator.marking.tlp
      copy_from: ironradar.tlp
  - set:
      field: threat.indicator.marking.tlp_version
      value: "2.1"
  - set:
      field: threat.indicator.name
      copy_from: ironradar.indicator
  - set:
      field: threat.indicator.port
      copy_from: ironradar.port
      if: ctx.ironradar.type != "file"
  - set:
      field: threat.indicator.type
      copy_from: ironradar.type
  - set:
      field: threat.software.name
      copy_from: ironradar.threat
  
  # custom fields
  - set:
      field: threat.indicator.threat_type
      copy_from: ironradar.threat_type
  
  # cleanup
  - remove:
      field: 
        - message
        - ironradar
      ignore_missing: true

on_failure:
  - set:
      field: error.message
      value: "{{ _ingest.on_failure_message }}"
