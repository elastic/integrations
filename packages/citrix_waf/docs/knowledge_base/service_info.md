# Service Info

## Common use cases

The Citrix Web App Firewall (WAF) integration provides comprehensive visibility into your web application security posture by ingesting logs from Citrix ADC and NetScaler appliances.
- **Threat Detection and Mitigation:** Identify and analyze malicious activity such as SQL injection, cross-site scripting (XSS), and buffer overflow attacks blocked by the WAF engine.
- **Compliance and Auditing:** Maintain a detailed audit trail of all web requests and security events to meet regulatory requirements (e.g., PCI-DSS, HIPAA) using structured CEF logs.
- **Security Posture Monitoring:** Track the effectiveness of WAF policies by monitoring event outcomes, block rates, and the distribution of attack types across different protected applications.
- **Operational Troubleshooting:** Correlate WAF security events with application performance data to distinguish between legitimate user issues and security-driven request blocks.

## Data types collected

This integration collects several categories of data to provide a full picture of WAF activity. Based on the integration's data streams, the following data is captured:

*   **Citrix WAF logs (via Syslog):** Collects Citrix WAF logs transmitted over the network via TCP or UDP. This includes real-time security violations and signature match events.
*   **Citrix WAF logs (via File):** Collects Citrix WAF logs from local files on the system where the Elastic Agent is running.
*   **Application Firewall Logs:** Detailed records of security violations, blocked requests, and signature matches generated by the WAF engine.
*   **Security Event Metadata:** Information regarding the specific security check triggered, the action taken (e.g., block, log), and the severity of the event.
*   **Network Metadata:** Source and destination IP addresses, ports, and transport protocols involved in the web transactions.
*   **Data Formats:** All logs are collected in Syslog format, with a strong recommendation for Common Event Format (CEF) to ensure high-fidelity parsing.

The integration includes the following data stream:
- **Citrix WAF logs (`citrix_waf.log`):** This data stream captures security and audit logs including violations, signature matches, and system events.

## Compatibility

This integration has been tested and verified for compatibility with the following third-party vendor versions:
- **Citrix ADC** version 13.1
- **NetScaler** version 10.0

The integration is designed to work with any Citrix/NetScaler appliance capable of exporting logs in the Common Event Format (CEF).

## Scaling and Performance

To ensure optimal performance in high-volume security environments, consider the following:

- **Transport/Collection Considerations:** While UDP provides lower overhead, **TCP** is recommended for high-volume environments to ensure reliable delivery and support for encrypted transport via SSL/TLS. If using the **logfile** input, ensure the host's disk I/O performance can handle the sustained write/read load and implement log rotation to prevent disk exhaustion. For network inputs, verify the `max_message_size` (default `10KiB`) is sufficient for your largest CEF payloads to prevent truncation.
- **Data Volume Management:** To optimize performance, use the `-globalBindType APPFW_GLOBAL` command on the Citrix appliance to isolate WAF-specific logs from general system logs. This reduces processing overhead on the Elastic Agent. Additionally, configure specific log levels at the source to filter out low-value debugging information, focusing collection on `NOTICE` or higher severity events.
- **Elastic Agent Scaling:** For high-throughput environments, deploy multiple Elastic Agents behind a network load balancer to distribute incoming syslog traffic. Place Agents in close network proximity to the Citrix appliances to minimize latency. Ensure Agent hosts have sufficient CPU resources for processing complex **Processors** and parsing high-velocity CEF data.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** Full administrative credentials for the Citrix ADC / NetScaler management GUI or CLI.
- **Feature Licensing:** An active license for the Citrix Web App Firewall feature must be installed on the appliance.
- **Network Connectivity:** Unrestricted network access between the Citrix appliance and the Elastic Agent on the configured Syslog port (default `9001` for this integration).
- **Auditing Configuration:** The ability to create and bind global audit policies to the `APPFW_GLOBAL` bind point.
- **CEF Support:** The appliance must be running a firmware version that supports Common Event Format (CEF) logging.

## Elastic prerequisites

- **Kibana/Elasticsearch Version:** This integration requires Elastic Stack version 8.11.0 or later.
- **Elastic Agent:** An Elastic Agent must be installed on a host reachable by the Citrix appliance and enrolled in a Fleet policy.
- **Integration Installation:** The Citrix WAF integration must be added to the Elastic Agent's policy via Kibana.
- **Connectivity:** Firewall rules must allow inbound traffic to the Elastic Agent on the specified Syslog port from the Citrix appliance's NSIP or SNIP.

## Vendor set up steps

### Step 1: Enable CEF Logging
The integration requires logs in CEF (Common Event Format) for proper field mapping.
1. Log in to the NetScaler / Citrix ADC management interface.
2. Navigate to **Security > Citrix Web App Firewall > Change Engine Settings**.
3. In the **General Settings** section, locate the **CEF Logging** checkbox.
4. Check **Enable CEF Logging**.
5. (Optional) Check **GeoLocation Logging** if you wish to include geolocation data in the logs.
6. Click **OK** to save.

*CLI Alternative:*
```bash
set appfw settings CEFLogging on
```

### Step 2: Create a Syslog Action
Define where the logs should be sent (the Elastic Agent's IP and port).
1. Navigate to **Configuration > System > Auditing > Syslog**.
2. Click on the **Servers** tab and click **Add**.
3. Configure the following details:
   - **Name**: `Elastic_Syslog_Server`
   - **IP Address**: Enter the IP address of your Elastic Agent.
   - **Port**: `9001` (or your configured port).
   - **Transport Type**: Select **UDP** or **TCP**.
   - **Log Level**: Select **ALL**.
4. Click **Create**.

*CLI Alternative:*
```bash
add audit syslogAction Elastic_Syslog_Server <Elastic_Agent_IP> -serverPort 9001 -logLevel ALL -transport TCP
```

### Step 3: Create and Bind a Syslog Policy
1. Navigate to **Configuration > System > Auditing > Syslog** and go to the **Policies** tab.
2. Click **Add**, name it `Elastic_WAF_Policy`, and select the server created in the previous step.
3. Set the Expression to `true`.
4. Navigate to **Configuration > System > Auditing > Syslog** and select **Global Bindings**.
5. Select **APPFW_GLOBAL** and bind the `Elastic_WAF_Policy` with a priority of `100`.

*CLI Alternative:*
```bash
add audit syslogPolicy Elastic_WAF_Policy true Elastic_Syslog_Server
bind audit syslogGlobal -policyName Elastic_WAF_Policy -priority 100 -globalBindType APPFW_GLOBAL
```

### Vendor Set up Resources

- [How to Send Application Firewall Messages to a Separate Syslog Server (CTX138973)](https://support.citrix.com/external/article?articleUrl=CTX138973-how-to-send-application-firewall-messages-to-a-separate-syslog-server)
- [How to Send NetScaler Application Firewall Logs to Syslog Server (CTX483235)](https://support.citrix.com/external/article?articleUrl=CTX483235-send-logs-to-external-syslog-server&language=en_US)
- [Web App Firewall logs | NetScaler Documentation](https://docs.netscaler.com/en-us/citrix-adc/current-release/application-firewall/logs.html)

## Kibana set up steps

### Collecting logs from Citrix Web App Firewall via TCP
1. In Kibana, navigate to **Management > Integrations** and search for **Citrix Web App Firewall**.
2. Click **Add Citrix Web App Firewall**.
3. Select the **Collecting logs from Citrix Web App Firewall via TCP** input type.
4. Configure the following fields:
   - **Listen Address** (`tcp_host`): The bind address to listen for TCP connections. Set to `0.0.0.0` to bind to all available interfaces. Default: `localhost`.
   - **Listen Port** (`tcp_port`): The TCP port number to listen on. Default: `9001`.
   - **Preserve original event** (`preserve_original_event`): Preserves a raw copy of the original event, added to the field `event.original`. Default: `False`.
   - **Tags** (`tags`): Custom tags to append to the event. Default: `['citrix_waf', 'forwarded']`.
   - **Processors** (`processors`): Processors used to reduce fields or enhance metadata. This executes in the agent before parsing. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
   - **SSL Configuration** (`ssl`): Specify SSL configuration options including certificate authorities and local certificates for encrypted transport.
   - **Custom TCP Options** (`tcp_options`): Specify advanced settings such as `max_message_size` (default: `10KiB`) or `line_delimiter`.
   - **Timezone** (`tz_offset`): IANA time zone or time offset (e.g. `+0200`) to use when interpreting syslog timestamps without a time zone. Default: `UTC`.
5. Save and deploy the integration.

### Collecting logs from Citrix Web App Firewall via UDP
1. In Kibana, navigate to **Management > Integrations** and search for **Citrix Web App Firewall**.
2. Click **Add Citrix Web App Firewall**.
3. Select the **Collecting logs from Citrix Web App Firewall via UDP** input type.
4. Configure the following fields:
   - **Listen Address** (`udp_host`): The bind address to listen for UDP connections. Set to `0.0.0.0` to bind to all available interfaces. Default: `localhost`.
   - **Listen Port** (`udp_port`): The UDP port number to listen on. Default: `9001`.
   - **Preserve original event** (`preserve_original_event`): Preserves a raw copy of the original event. Default: `False`.
   - **Tags** (`tags`): Custom tags to append to the event. Default: `['citrix_waf', 'forwarded']`.
   - **Processors** (`processors`): Processors used to reduce fields or enhance metadata. This executes in the agent before parsing. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
   - **Custom UDP Options** (`udp_options`): Specify advanced settings such as `max_message_size` (default: `10KiB`) or `read_buffer`.
   - **Timezone** (`tz_offset`): IANA time zone or time offset (e.g. `+0200`) to use when interpreting syslog timestamps without a time zone. Default: `UTC`.
5. Save and deploy the integration.

### Collecting logs from Citrix Web App Firewall via file
1. In Kibana, navigate to **Management > Integrations** and search for **Citrix Web App Firewall**.
2. Click **Add Citrix Web App Firewall**.
3. Select the **Collecting logs from Citrix Web App Firewall via file** input type.
4. Configure the following fields:
   - **Paths** (`paths`): List of absolute paths to the log files. Default: `['/var/log/citrix-waf.log']`.
   - **Preserve original event** (`preserve_original_event`): Preserves a raw copy of the original event. Default: `False`.
   - **Tags** (`tags`): Custom tags to append to the event. Default: `['citrix_waf', 'forwarded']`.
   - **Processors** (`processors`): Processors used to reduce fields or enhance metadata. This executes in the agent before parsing. See [Processors](https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html) for details.
   - **Timezone** (`tz_offset`): IANA time zone or time offset (e.g. `+0200`) to use when interpreting syslog timestamps without a time zone. Default: `UTC`.
5. Save and deploy the integration.

# Validation Steps

After configuration is complete, verify that data is flowing correctly.

### 1. Trigger Data Flow on Citrix WAF:
- **Generate Web Traffic:** Use a browser or `curl` to access a web application protected by the Citrix WAF.
- **Simulate Policy Violation:** Attempt to access a sensitive path (e.g., `curl http://<waf_app_ip>/etc/passwd`) to trigger a WAF block or log event.
- **Administrative Login:** Log out and log back into the Citrix ADC/NetScaler management interface to generate administrative audit logs.

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the KQL filter: `data_stream.dataset : "citrix_waf.log"`
4. Verify logs appear. Expand a log entry and confirm these fields are populated:
   - `event.dataset` (should be `citrix_waf.log`)
   - `source.ip` (representing the client IP address)
   - `event.action` (the action taken by the WAF, such as `block` or `permit`)
   - `message` (the raw CEF payload from the appliance)
5. Navigate to **Analytics > Dashboards** and search for "Citrix Web App Firewall" to verify pre-built visualizations are populating.

# Troubleshooting

## Common Configuration Issues

- **CEF Logging Disabled**: If logs are appearing in Kibana as a single unparsed string in the `message` field, verify that **CEF Logging** is enabled in the Citrix WAF Engine Settings. Without CEF format, the parser cannot identify specific security fields.
- **Global Binding Missing**: If no logs are arriving at the Elastic Agent, verify the audit policy is bound to the `APPFW_GLOBAL` bind point. Binding to `SYSTEM_GLOBAL` may result in WAF logs being mixed with system logs or suppressed depending on priority settings.
- **Port Conflicts**: Ensure that the `Listen Port` configured in Kibana (e.g., 9001) is not being used by another service on the Elastic Agent host. Use `netstat -ano` or `ss -tulpn` to verify the Agent is listening on the expected port.
- **Firewall/ACL Blocks**: Verify that any network firewalls between the Citrix appliance and the Elastic Agent are permitting traffic on the configured UDP or TCP port.

## Ingestion Errors

- **Timestamp Mismatches**: If logs appear to be missing, check for a significant time difference between the Citrix appliance and the Elastic Agent. Use the **Timezone** setting in the integration configuration to correct for offset differences.
- **Parsing Failures**: Check the `error.message` field in Kibana for messages like "Provided grok patterns did not match". This usually indicates the Citrix log format is not standard CEF. Ensure no custom syslog headers are prepended to the CEF payload on the Citrix side.
- **Truncated Logs**: If logs are incomplete, check the `max_message_size` setting in the TCP/UDP options. Large WAF events with many headers may exceed the default 10KiB limit.

## Vendor Resources

- [Web App Firewall logs - NetScaler Documentation](https://docs.netscaler.com/en-us/citrix-adc/current-release/application-firewall/logs.html)
- [NetScaler AppFirewall: Configuration, CEF logging, Signatures](https://support.citrix.com/external/article/CTX691236/netscaler-appfirewall-configuration-cef.html)
- [Send logs to external syslog server](https://support.citrix.com/external/article/CTX483235/send-logs-to-external-syslog-server.html)

# Documentation sites

- [Citrix Web App Firewall Logs and CEF Configuration](https://docs.netscaler.com/en-us/citrix-adc/current-release/application-firewall/logs.html)
- [Citrix ADC Auditing Policies](https://docs.netscaler.com/en-us/citrix-adc/current-release/application-firewall/policies/auditing-policies.html)
