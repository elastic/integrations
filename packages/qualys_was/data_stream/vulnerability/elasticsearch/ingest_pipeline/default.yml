---
description: Pipeline for processing Tenable Vulnerability Management vulnerability logs.
processors:
  - rename:
      field: message
      target_field: event.original
      if: 'ctx.event?.original == null'
      description: 'Renames the original `message` field to `event.original` to store a copy of the original message.'
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - remove:
      field: message
      ignore_missing: true
      if: 'ctx.event?.original != null'
      description: 'The `message` field is no longer required if the document has an `event.original` field.'
  - set:
      if: ctx['@timestamp'] != null
      field: event.created
      copy_from: '@timestamp'
  - json:
      field: event.original
      target_field: json
  - set:
      field: ecs.version
      value: '8.16.0'
  - fail:
      tag: cel_failure
      if: ctx.error?.message != null && ctx.message == null && ctx.event?.original == null
      message: error message set and no data to process
  - set:
      field: event.kind
      tag: set_event_kind_1
      value: event
  - set:
      field: event.category
      value: [vulnerability]
  - set:
      field: event.type
      value: [info]
  - set:
      field: vulnerability.classification
      value: CVSS
  - set:
      field: vulnerability.enumeration
      value: CWE
  - set:
      field: vulnerability.category
      value: [Web Application]
  - set:
      field: vulnerability.scanner.vendor
      value: Qualys
  - json:
      field: event.original
      target_field: json
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.Finding.detection
      tag: rename_detection
      target_field: json.detection
  - rename:
      field: json.detection.id
      tag: rename_id
      target_field: qualys_was.vulnerability.id
  - rename:
      field: json.detection.url
      tag: rename_full_url
      target_field: url.full
      ignore_missing: true
  - rename:
      field: json.detection.name
      tag: rename_vul_name
      target_field: qualys_was.vulnerability.name
  - rename:
      field: json.detection.qid
      tag: rename_qid
      target_field: qualys_was.vulnerability.qid
  - rename:
      field: json.detection.severity
      tag: rename_severity
      target_field: vulnerability.severity
      ignore_missing: true
  - date:
      field: json.detection.lastDetectedDate
      tag: rename_lastDetectedDate
      formats:
        - ISO8601
      target_field: qualys_was.vulnerability.last_found_datetime
      if: ctx.json?.detection?.lastDetectedDate != null && ctx.json.detection.lastDetectedDate != ''
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - date:
      field: json.detection.firstDetectedDate
      tag: rename_firstDetectedDate
      formats:
        - ISO8601
      target_field: qualys_was.vulnerability.first_found_datetime
      if: ctx.json?.detection?.firstDetectedDate != null && ctx.json.detection.firstDetectedDate != ''
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - date:
      field: json.detection.lastTestedDate
      tag: rename_lastTestedDate
      formats:
        - ISO8601
      target_field: qualys_was.vulnerability.last_test_datetime
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - date:
      field: json.detection.updatedDate
      tag: rename_updatedDate
      formats:
        - ISO8601
      target_field: qualys_was.vulnerability.updated_datetime
      if: ctx.json?.detection?.updatedDate != null && ctx.json.detection.updatedDate != ''
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - date:
      field: json.detection.fixedDate
      tag: rename_fixedDate
      formats:
        - ISO8601
      target_field: qualys_was.vulnerability.fixed_datetime
      if: ctx.json?.detection?.fixedDate != null && ctx.json.detection.fixedDate != ''
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: '@timestamp'
      tag: set_event_ingest_to_timestamp
      target_field: event.ingested
      ignore_missing: true
  - set:
      field: '@timestamp'
      tag: set_timestamp_last_test_datetime
      copy_from: qualys_was.vulnerability.last_test_datetime
  - rename:
      field: json.detection.potential
      tag: rename_potential
      target_field:  qualys_was.vulnerability.potential
      ignore_missing: true
  - rename:
      field: json.detection.param
      tag: rename_param
      target_field:  qualys_was.vulnerability.param
      ignore_missing: true
  - rename:
      field: json.detection.detectionScore
      tag: rename_detectionScore
      target_field:  qualys_was.vulnerability.detection_score
      ignore_missing: true
  - rename:
      field: json.detection.timesDetected
      tag: rename_timesDetected
      target_field:  qualys_was.vulnerability.times_detected
      ignore_missing: true
  - rename:
      field: json.detection.webApp.id
      tag: rename_webApp_id
      target_field:  qualys_was.vulnerability.web_app.id
  - rename:
      field: json.detection.webApp.name
      tag: rename_webApp_name
      target_field:  qualys_was.vulnerability.web_app.name
  - rename:
      field: json.detection.webApp.url
      tag: rename_webApp_url
      target_field:  qualys_was.vulnerability.web_app.url
  - foreach:
      field: json.detection.webApp.tags.list
      if: ctx.json?.detection?.webApp?.tags?.list instanceof List
      ignore_missing: true
      processor:
        append:
          field: qualys_was.vulnerability.web_app.tags
          tag: append_web_app_tags
          value:  "{{{ _ingest._value.Tag.name}}}"
          allow_duplicates: false
          on_failure:
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.detection.type
      tag: rename_type
      target_field:  qualys_was.vulnerability.type
  - rename:
      field: json.detection.status
      tag: rename_status
      target_field: qualys_was.vulnerability.status
      ignore_missing: true
  - rename:
      field: json.detection.uniqueId
      tag: rename_uniqueID
      target_field: qualys_was.vulnerability.unique_vuln_id
  - rename:
      field: json.detection.isIgnored
      tag: rename_isIgnored
      target_field: qualys_was.vulnerability.is_ignored
      ignore_missing: true
  - rename:
      field: json.detection.ignoredBy.id
      tag: rename_ignoredBy_id
      target_field: qualys_was.vulnerability.ignoredBy.id
      ignore_missing: true
  - rename:
      field: json.detection.ignoredBy.name
      tag: rename_ignoredBy_name
      target_field: qualys_was.vulnerability.ignoredBy.name
      ignore_missing: true
  - rename:
      field: json.detection.ignoredBy.username
      tag: rename_ignoredBy_username
      target_field: qualys_was.vulnerability.ignoredBy.username
      ignore_missing: true
  - rename:
      field: json.detection.ignoredComment
      tag: rename_ignoredComment
      target_field: qualys_was.vulnerability.ignoredBy.comment
      ignore_missing: true
  - rename:
      field: json.detection.ignoredReason
      tag: rename_ignoredReason
      target_field: qualys_was.vulnerability.ignoredBy.reason
      ignore_missing: true
  - date:
      field: json.detection.ignoredDate
      tag: rename_lignoredDate
      formats:
        - ISO8601
      target_field: qualys_was.vulnerability.ignoredBy.date
      ignore_failure: true
  - rename:
      field: json.detection.resultList.list
      tag: rename_result_list
      target_field: qualys_was.vulnerability.result_list
      ignore_missing: true
  - rename:
      field: json.detection.cvss3.base
      tag: rename_cvss3_base
      target_field: vulnerability.score.base
      ignore_missing: true
  - rename:
      field: json.detection.cvss3.temporal
      tag: rename_cvss3_temporal
      target_field: vulnerability.score.temporal
      ignore_missing: true
  - foreach:
      field: json.detection.cwe.list
      ignore_failure: true
      processor:
        append:
          field: vulnerability.id
          tag: append_cwe_values
          value:  "{{{_ingest._value}}}"
          allow_duplicates: false
  - script:
      description: create list of wasc references
      if: ctx.json?.detection?.wasc?.list != null && ctx.json?.detection?.wasc?.list.size() > 0
      lang: painless
      source: >
          def wascList = new ArrayList();
          for (wasc in ctx.json.detection.wasc.list) {
              wascList.add(wasc.WASC);
          }
          ctx.qualys_was.vulnerability.wasc_references = wascList;
  - script:
      description: create list of owasp references
      if: ctx.json?.detection?.owasp?.list != null && ctx.json?.detection?.owasp?.list.size() > 0
      lang: painless
      source: >
        def owaspList = new ArrayList();
        for (owasp in ctx.json.detection.owasp.list) {
            owaspList.add(owasp.OWASP);
        }
        ctx.qualys_was.vulnerability.owasp_references = owaspList;
  - fingerprint:
      fields:
        - qualys_was.vulnerability.id
        - qualys_was.vulnerability.last_test_datetime
      target_field: '_id'
      ignore_missing: true

  - remove:
      field: json.detection
      tag: remove_unused_fields
      ignore_missing: true

  # Handle knowledge_base
  - append:
      field: error.message
      if: ctx.json?.Finding.knowledge_base == null || ctx.json.Finding.knowledge_base.size() == 0
      value: 'Qualys QID not found in the Knowledge Base'
  - pipeline:
      name: '{{ IngestPipeline "pipeline_knowledge_base" }}'
      if: ctx.json?.Finding?.knowledge_base != null && ctx.json.Finding.knowledge_base.size() > 0
      tag: pipeline_knowledge_base
      ignore_missing_pipeline: true
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      ignore_failure: true
  - pipeline:
      name: '{{ IngestPipeline "pipeline_knowledge_base" }}'
      if: ctx.Finding != null && ctx.Finding.knowledge_base != null && ctx.Finding.knowledge_base.size() > 0
      tag: pipeline_knowledge_base
      ignore_missing_pipeline: true
on_failure:
   - set:
      field: event.kind
      value: pipeline_error
   - append:
      field: error.message
      value: >-
        Processor '{{ _ingest.on_failure_processor_type }}'
        {{#_ingest.on_failure_processor_tag}}with tag '{{ _ingest.on_failure_processor_tag }}'
        {{/_ingest.on_failure_processor_tag}}failed with message '{{ _ingest.on_failure_message }}'
