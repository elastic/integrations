---
description: Pipeline for processing vulnerability logs.
processors:
  - drop:
      tag: drop_empty_events_placeholder_1f3e6c12
      if: ctx.message == 'empty_events_placeholder'
  - set:
      tag: set_ecs_version_to_9_2_0_3273339c
      field: ecs.version
      value: 9.2.0
  - terminate:
      description: error message set and no data to process.
      tag: terminate_data_collection_error_4c75f12b
      if: ctx.error?.message != null && ctx.message == null && ctx.event?.original == null

  # remove agentless metadata
  - remove:
      description: Removes the fields added by Agentless as metadata, as they can collide with ECS fields.
      tag: remove_agentless_tags_44eed408
      if: ctx.organization instanceof String && ctx.division instanceof String && ctx.team instanceof String
      field:
        - organization
        - division
        - team
      ignore_missing: true

  # parse the event JSON
  - rename:
      description: Renames the original `message` field to `event.original` to store a copy of the original message. The `event.original` field is not touched if the document already has one; it may happen when Logstash sends the document.
      tag: rename_message_to_event_original_c74b1d7e
      if: ctx.event?.original == null
      field: message
      target_field: event.original
      ignore_missing: true
  - remove:
      description: The `message` field is no longer required if the document has an `event.original` field.
      tag: remove_message_84808ee4
      if: ctx.event?.original != null
      field:
        - message
      ignore_missing: true
  - json:
      tag: json_event_original_into_json_5e54dc16
      field: event.original
      target_field: json

  # Add fingerprint
  - fingerprint:
      tag: fingerprint_into__id_3606769e
      fields:
        - json.id
        - json.timelines.last_modified_at
      target_field: _id
      ignore_missing: true

  # Set event.* fields
  - set:
      tag: set_event_kind_to_event_de80643c
      field: event.kind
      value: event
  - append:
      tag: Append_event_type_to_info_8a66ccaa
      field: event.type
      value: info
  - append:
      tag: Append_event_category_to_vulnerability_5737514c
      field: event.category
      value: vulnerability

  # rename fields to snake_case (hyphen to underscore)
  - script:
      description: Convert field names from hyphen to underscore.
      tag: script_normalize_field_names_10f34910
      lang: painless
      source: |-
        // Replace '-' with '_' in field names
        String normalize(String str) {
          return str.replace('-', '_');
        }

        // Recursive function to process objects
        def normalizeFields(def obj) {
          if (obj instanceof Map) {
            def newObj = new HashMap();
            for (entry in obj.entrySet()) {
              String newKey = normalize(entry.getKey());
              newObj.put(newKey, normalizeFields(entry.getValue()));
            }
            return newObj;
          } else if (obj instanceof List) {
            def newList = new ArrayList();
            for (item in obj) {
              newList.add(normalizeFields(item));
            }
            return newList;
          }
          return obj;
        }

        // Apply transformation
        if (ctx.json != null) {
          ctx.ti_flashpoint = ctx.ti_flashpoint ?: [:];
          ctx.ti_flashpoint.vulnerability = normalizeFields(ctx.json);
          ctx.remove('json');
        }

  # Date processors
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_disclosed_at_into_ti_flashpoint_vulnerability_timelines_disclosed_at_737ff512
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.disclosed_at != null && ctx.ti_flashpoint.vulnerability.timelines.disclosed_at != ''
      field: ti_flashpoint.vulnerability.timelines.disclosed_at
      target_field: ti_flashpoint.vulnerability.timelines.disclosed_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_disclosed_at_7c062f2a
            field:
              - ti_flashpoint.vulnerability.timelines.disclosed_at
        - append:
            tag: append_error_message_b4679182
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_discovered_at_into_ti_flashpoint_vulnerability_timelines_discovered_at_f7432a5c
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.discovered_at != null && ctx.ti_flashpoint.vulnerability.timelines.discovered_at != ''
      field: ti_flashpoint.vulnerability.timelines.discovered_at
      target_field: ti_flashpoint.vulnerability.timelines.discovered_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_discovered_at_bc5f5d04
            field:
              - ti_flashpoint.vulnerability.timelines.discovered_at
        - append:
            tag: append_error_message_de16ca7c
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_exploit_published_at_into_ti_flashpoint_vulnerability_timelines_exploit_published_at_d0afead2
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.exploit_published_at != null && ctx.ti_flashpoint.vulnerability.timelines.exploit_published_at != ''
      field: ti_flashpoint.vulnerability.timelines.exploit_published_at
      target_field: ti_flashpoint.vulnerability.timelines.exploit_published_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_exploit_published_at_5a3357e8
            field:
              - ti_flashpoint.vulnerability.timelines.exploit_published_at
        - append:
            tag: append_error_message_ea67c242
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_exploited_in_the_wild_at_into_ti_flashpoint_vulnerability_timelines_exploited_in_the_wild_at_381522ac
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.exploited_in_the_wild_at != null && ctx.ti_flashpoint.vulnerability.timelines.exploited_in_the_wild_at != ''
      field: ti_flashpoint.vulnerability.timelines.exploited_in_the_wild_at
      target_field: ti_flashpoint.vulnerability.timelines.exploited_in_the_wild_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_exploited_in_the_wild_at_e407d55f
            field:
              - ti_flashpoint.vulnerability.timelines.exploited_in_the_wild_at
        - append:
            tag: append_error_message_a8c4d4cc
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_last_modified_at_into_ti_flashpoint_vulnerability_timelines_last_modified_at_f8892236
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.last_modified_at != null && ctx.ti_flashpoint.vulnerability.timelines.last_modified_at != ''
      field: ti_flashpoint.vulnerability.timelines.last_modified_at
      target_field: ti_flashpoint.vulnerability.timelines.last_modified_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_last_modified_at_49a13f40
            field:
              - ti_flashpoint.vulnerability.timelines.last_modified_at
        - append:
            tag: append_error_message_85ea3ef6
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_published_at_into_ti_flashpoint_vulnerability_timelines_published_at_6b2a37a6
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.published_at != null && ctx.ti_flashpoint.vulnerability.timelines.published_at != ''
      field: ti_flashpoint.vulnerability.timelines.published_at
      target_field: ti_flashpoint.vulnerability.timelines.published_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_published_at_7c0d2658
            field:
              - ti_flashpoint.vulnerability.timelines.published_at
        - append:
            tag: append_error_message_ee852366
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_solution_provided_at_into_ti_flashpoint_vulnerability_timelines_solution_provided_at_51cef6d4
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.solution_provided_at != null && ctx.ti_flashpoint.vulnerability.timelines.solution_provided_at != ''
      field: ti_flashpoint.vulnerability.timelines.solution_provided_at
      target_field: ti_flashpoint.vulnerability.timelines.solution_provided_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_solution_provided_at_6947d7a9
            field:
              - ti_flashpoint.vulnerability.timelines.solution_provided_at
        - append:
            tag: append_error_message_dc4e0964
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_third_party_solution_provided_at_into_ti_flashpoint_vulnerability_timelines_third_party_solution_provided_at_72a8d2da
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.third_party_solution_provided_at != null && ctx.ti_flashpoint.vulnerability.timelines.third_party_solution_provided_at != ''
      field: ti_flashpoint.vulnerability.timelines.third_party_solution_provided_at
      target_field: ti_flashpoint.vulnerability.timelines.third_party_solution_provided_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_third_party_solution_provided_at_77353778
            field:
              - ti_flashpoint.vulnerability.timelines.third_party_solution_provided_at
        - append:
            tag: append_error_message_0236f4ba
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_vendor_acknowledged_at_into_ti_flashpoint_vulnerability_timelines_vendor_acknowledged_at_1105dae0
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.vendor_acknowledged_at != null && ctx.ti_flashpoint.vulnerability.timelines.vendor_acknowledged_at != ''
      field: ti_flashpoint.vulnerability.timelines.vendor_acknowledged_at
      target_field: ti_flashpoint.vulnerability.timelines.vendor_acknowledged_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_vendor_acknowledged_at_dc2bd855
            field:
              - ti_flashpoint.vulnerability.timelines.vendor_acknowledged_at
        - append:
            tag: append_error_message_ee376d50
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      tag: date_ti_flashpoint_vulnerability_timelines_vendor_informed_at_into_ti_flashpoint_vulnerability_timelines_vendor_informed_at_d35e2608
      if: ctx.ti_flashpoint?.vulnerability?.timelines?.vendor_informed_at != null && ctx.ti_flashpoint.vulnerability.timelines.vendor_informed_at != ''
      field: ti_flashpoint.vulnerability.timelines.vendor_informed_at
      target_field: ti_flashpoint.vulnerability.timelines.vendor_informed_at
      formats:
        - ISO8601
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_timelines_vendor_informed_at_5c011989
            field:
              - ti_flashpoint.vulnerability.timelines.vendor_informed_at
        - append:
            tag: append_error_message_bc5bb068
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v2s_699adc9b
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v2s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v2s
      processor:
        date:
          tag: date__ingest__value_generated_at_into__ingest__value_generated_at_e94db8dd
          field: _ingest._value.generated_at
          target_field: _ingest._value.generated_at
          formats:
            - ISO8601
          on_failure:
            - remove:
                tag: remove__ingest__value_generated_at_bb878571
                field:
                  - _ingest._value.generated_at
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_d4b7901a
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        date:
          tag: date__ingest__value_generated_at_into__ingest__value_generated_at_9aa1db31
          field: _ingest._value.generated_at
          target_field: _ingest._value.generated_at
          formats:
            - ISO8601
          on_failure:
            - remove:
                tag: remove__ingest__value_generated_at_bf08a825
                field:
                  - _ingest._value.generated_at
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_d3b78e87
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        date:
          tag: date__ingest__value_updated_at_into__ingest__value_updated_at_5764a101
          field: _ingest._value.updated_at
          target_field: _ingest._value.updated_at
          formats:
            - ISO8601
          on_failure:
            - remove:
                tag: remove__ingest__value_updated_at_66f90147
                field:
                  - _ingest._value.updated_at
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v4s_5a0cbac6
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v4s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v4s
      processor:
        date:
          tag: date__ingest__value_generated_at_into__ingest__value_generated_at_4e3e9975
          field: _ingest._value.generated_at
          target_field: _ingest._value.generated_at
          formats:
            - ISO8601
          on_failure:
            - remove:
                tag: remove__ingest__value_generated_at_74eec5b9
                field:
                  - _ingest._value.generated_at
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v4s_590cb933
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v4s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v4s
      processor:
        date:
          tag: date__ingest__value_updated_at_into__ingest__value_updated_at_cd81df25
          field: _ingest._value.updated_at
          target_field: _ingest._value.updated_at
          formats:
            - ISO8601
          on_failure:
            - remove:
                tag: remove__ingest__value_updated_at_93d5599b
                field:
                  - _ingest._value.updated_at
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_ext_references_14beb767
      if: ctx.ti_flashpoint?.vulnerability?.ext_references instanceof List
      field: ti_flashpoint.vulnerability.ext_references
      processor:
        date:
          tag: date__ingest__value_created_at_into__ingest__value_created_at_12f913cb
          field: _ingest._value.created_at
          target_field: _ingest._value.created_at
          formats:
            - ISO8601
          on_failure:
            - remove:
                tag: remove__ingest__value_created_at_aef458b8
                field:
                  - _ingest._value.created_at

  # Convert to Long
  - convert:
      tag: convert_ti_flashpoint_vulnerability_exploits_count_to_long_72327703
      field: ti_flashpoint.vulnerability.exploits_count
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_exploits_count_47b3cb11
            field:
              - ti_flashpoint.vulnerability.exploits_count
        - append:
            tag: append_error_message_04b0fe31
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # Convert to Double
  - convert:
      tag: convert_ti_flashpoint_vulnerability_scores_cvssv3_score_to_double_b97a772c
      field: ti_flashpoint.vulnerability.scores.cvssv3_score
      type: double
      ignore_missing: true
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_scores_cvssv3_score_84b74166
            field:
              - ti_flashpoint.vulnerability.scores.cvssv3_score
        - append:
            tag: append_error_message_246f524c
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      tag: convert_ti_flashpoint_vulnerability_scores_epss_score_to_double_95df7349
      field: ti_flashpoint.vulnerability.scores.epss_score
      type: double
      ignore_missing: true
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_scores_epss_score_4ecf604e
            field:
              - ti_flashpoint.vulnerability.scores.epss_score
        - append:
            tag: append_error_message_0b0159bf
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      tag: convert_ti_flashpoint_vulnerability_scores_epss_v1_score_to_double_34c35ce5
      field: ti_flashpoint.vulnerability.scores.epss_v1_score
      type: double
      ignore_missing: true
      on_failure:
        - remove:
            tag: remove_ti_flashpoint_vulnerability_scores_epss_v1_score_c303bfb2
            field:
              - ti_flashpoint.vulnerability.scores.epss_v1_score
        - append:
            tag: append_error_message_0a6f808b
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v2s_d112382d
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v2s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v2s
      processor:
        convert:
          tag: convert__ingest__value_calculated_cvss_base_score_to_double_1108d30f
          field: _ingest._value.calculated_cvss_base_score
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                tag: remove__ingest__value_calculated_cvss_base_score_a9866cb7
                field:
                  - _ingest._value.calculated_cvss_base_score
            - append:
                tag: append_error_message_a5ba0d8d
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_fece96a1
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        convert:
          tag: convert__ingest__value_calculated_cvss_base_score_to_double_74ea9383
          field: _ingest._value.calculated_cvss_base_score
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                tag: remove__ingest__value_calculated_cvss_base_score_8d385c1b
                field:
                  - _ingest._value.calculated_cvss_base_score
            - append:
                tag: append_error_message_eb7bd3b1
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_fbce91e8
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        convert:
          tag: convert__ingest__value_temporal_score_to_double_060c9f7f
          field: _ingest._value.temporal_score
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                tag: remove__ingest__value_temporal_score_387c44e7
                field:
                  - _ingest._value.temporal_score
            - append:
                tag: append_error_message_07be273d
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v4s_152a4e85
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v4s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v4s
      processor:
        convert:
          tag: convert__ingest__value_threat_score_to_double_d3428e59
          field: _ingest._value.threat_score
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                tag: remove__ingest__value_threat_score_c7981737
                field:
                  - _ingest._value.threat_score
            - append:
                tag: append_error_message_b294d10f
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # Convert to Float
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v2s_ce123374
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v2s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v2s
      processor:
        convert:
          tag: convert__ingest__value_score_to_float_aea0fabb
          field: _ingest._value.score
          type: float
          ignore_missing: true
          on_failure:
            - remove:
                tag: remove__ingest__value_score_2d4e5774
                field:
                  - _ingest._value.score
            - append:
                tag: append_error_message_74cc1ef9
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_fcce937b
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        convert:
          tag: convert__ingest__value_score_to_float_2034b4df
          field: _ingest._value.score
          type: float
          ignore_missing: true
          on_failure:
            - remove:
                tag: remove__ingest__value_score_261237a8
                field:
                  - _ingest._value.score
            - append:
                tag: append_error_message_91e41a9d
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v4s_122a49cc
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v4s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v4s
      processor:
        convert:
          tag: convert__ingest__value_score_to_float_76ff7e33
          field: _ingest._value.score
          type: float
          ignore_missing: true
          on_failure:
            - remove:
                tag: remove__ingest__value_score_deeebd3c
                field:
                  - _ingest._value.score
            - append:
                tag: append_error_message_041ca5e1
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # Convert to String
  - convert:
      tag: convert_ti_flashpoint_vulnerability_id_to_string_d9e1251f
      field: ti_flashpoint.vulnerability.id
      type: string
      ignore_missing: true
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cwes_8a45cce2
      if: ctx.ti_flashpoint?.vulnerability?.cwes instanceof List
      field: ti_flashpoint.vulnerability.cwes
      processor:
        convert:
          tag: convert__ingest__value_cwe_id_to_string_5691ae55
          field: _ingest._value.cwe_id
          type: string
          ignore_missing: true
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_products_477bab32
      if: ctx.ti_flashpoint?.vulnerability?.products instanceof List
      field: ti_flashpoint.vulnerability.products
      processor:
        convert:
          tag: convert__ingest__value_id_to_string_7ce51ccb
          field: _ingest._value.id
          type: string
          ignore_missing: true
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_vendors_b2ba1c50
      if: ctx.ti_flashpoint?.vulnerability?.vendors instanceof List
      field: ti_flashpoint.vulnerability.vendors
      processor:
        convert:
          tag: convert__ingest__value_id_to_string_5818c7b5
          field: _ingest._value.id
          type: string
          ignore_missing: true
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v2s_cf123507
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v2s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v2s
      processor:
        convert:
          tag: convert__ingest__value_version_to_string_c850fbc8
          field: _ingest._value.version
          type: string
          ignore_missing: true
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_01ce9b5a
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        convert:
          tag: convert__ingest__value_version_to_string_c684b2d4
          field: _ingest._value.version
          type: string
          ignore_missing: true
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v4s_132a4b5f
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v4s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v4s
      processor:
        convert:
          tag: convert__ingest__value_version_to_string_eb868e40
          field: _ingest._value.version
          type: string
          ignore_missing: true

  # Map custom fields to corresponding ECS and related fields.
  - set:
      tag: set_event_created_from_ti_flashpoint_vulnerability_timelines_published_at_41756a89
      field: event.created
      copy_from: ti_flashpoint.vulnerability.timelines.published_at
      ignore_empty_value: true
  - set:
      tag: set_@timestamp_from_ti_flashpoint_vulnerability_timelines_last_modified_at_2b341595
      field: '@timestamp'
      copy_from: ti_flashpoint.vulnerability.timelines.last_modified_at
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_severity_from_ti_flashpoint_vulnerability_scores_severity_e393344e
      field: vulnerability.severity
      copy_from: ti_flashpoint.vulnerability.scores.severity
      ignore_empty_value: true
  - set:
      tag: set_event_id_from_ti_flashpoint_vulnerability_id_4910e2a1
      field: event.id
      copy_from: ti_flashpoint.vulnerability.id
      ignore_empty_value: true
  - set:
      tag: set_message_from_ti_flashpoint_vulnerability_description_974aae6a
      field: message
      copy_from: ti_flashpoint.vulnerability.description
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_description_from_ti_flashpoint_vulnerability_description_6a8f6639
      field: vulnerability.description
      copy_from: ti_flashpoint.vulnerability.description
      ignore_empty_value: true
  - append:
      tag: append_vulnerability_id_from_ti_flashpoint_vulnerability_id_4525ba71
      if: ctx.ti_flashpoint?.vulnerability?.id != null
      field: vulnerability.id
      value: '{{{ti_flashpoint.vulnerability.id}}}'
      allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cve_ids_826f991d
      if: ctx.ti_flashpoint?.vulnerability?.cve_ids instanceof List
      field: ti_flashpoint.vulnerability.cve_ids
      processor:
        append:
          tag: append_vulnerability_id_4f375211
          field: vulnerability.id
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v2s_df0233fe
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v2s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v2s
      processor:
        append:
          tag: append_vulnerability_score_base_f7474107
          field: vulnerability.score.base
          value: '{{{_ingest._value.score}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v2s_de02326b
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v2s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v2s
      processor:
        append:
          tag: append_vulnerability_id_69d71a91
          field: vulnerability.id
          value: '{{{_ingest._value.cve_id}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_911f7a2a
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        append:
          tag: append_vulnerability_score_base_411d1c33
          field: vulnerability.score.base
          value: '{{{_ingest._value.score}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v4s_164a4156
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v4s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v4s
      processor:
        append:
          tag: append_vulnerability_score_base_7bfab9df
          field: vulnerability.score.base
          value: '{{{_ingest._value.score}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_901f7897
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        append:
          tag: append_vulnerability_id_76e50f0d
          field: vulnerability.id
          value: '{{{_ingest._value.cve_id}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_8f1f7704
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        append:
          tag: append_vulnerability_score_temporal_fdfa1fab
          field: vulnerability.score.temporal
          value: '{{{_ingest._value.temporal_score}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v4s_154a3fc3
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v4s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v4s
      processor:
        append:
          tag: append_vulnerability_id_f99afcb9
          field: vulnerability.id
          value: '{{{_ingest._value.cve_id}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v2s_dd0230d8
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v2s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v2s
      processor:
        append:
          tag: append_vulnerability_score_version_5bdc7078
          field: vulnerability.score.version
          value: '{{{_ingest._value.version}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_8e1f7571
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        append:
          tag: append_vulnerability_score_version_c5945194
          field: vulnerability.score.version
          value: '{{{_ingest._value.version}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v4s_144a3e30
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v4s instanceof List
      field: ti_flashpoint.vulnerability.cvss_v4s
      processor:
        append:
          tag: append_vulnerability_score_version_17be2670
          field: vulnerability.score.version
          value: '{{{_ingest._value.version}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_of_vulnerability_score_base_e5bd7971
      if: ctx.vulnerability?.score?.base instanceof List
      field: vulnerability.score.base
      processor:
        convert:
          tag: convert__ingest__value_to_float_9acbea96
          field: _ingest._value
          type: float
          ignore_missing: true
      ignore_failure: true
  - foreach:
      tag: foreach_of_vulnerability_score_temporal_fa9e393d
      if: ctx.vulnerability?.score?.temporal instanceof List
      field: vulnerability.score.temporal
      processor:
        convert:
          tag: convert__ingest__value_to_float_c643e98a
          field: _ingest._value
          type: float
          ignore_missing: true
      ignore_failure: true
  - set:
      tag: set_vulnerability_classification_to_cvss_7b102a71
      field: vulnerability.classification
      value: cvss

  # Remove duplicate custom fields if preserve_duplicate_custom_fields are not enabled
  - foreach:
      tag: foreach_of_ti_flashpoint_vulnerability_cvss_v3s_8aeb4fce
      if: ctx.ti_flashpoint?.vulnerability?.cvss_v3s instanceof List && (ctx.tags == null || !ctx.tags.contains('preserve_duplicate_custom_fields'))
      field: ti_flashpoint.vulnerability.cvss_v3s
      processor:
        remove:
          tag: remove_custom_duplicate_fields_for_cvss_v3s_a0e5793f
          field:
            - _ingest._value.temporal_score
          ignore_missing: true
  - remove:
      tag: remove_custom_duplicate_fields_285c8bbe
      if: ctx.tags == null || !ctx.tags.contains('preserve_duplicate_custom_fields')
      field:
        - ti_flashpoint.vulnerability.timelines.published_at
        - ti_flashpoint.vulnerability.timelines.last_modified_at
        - ti_flashpoint.vulnerability.scores.severity
        - ti_flashpoint.vulnerability.id
        - ti_flashpoint.vulnerability.description
      ignore_missing: true

  # Cleanup
  - script:
      description: This script processor iterates over the whole document to remove fields with null values.
      tag: script_to_drop_null_values_8360f3de
      lang: painless
      source: |-
        void handleMap(Map map) {
        map.values().removeIf(v -> {
        	if (v instanceof Map) {
        	handleMap(v);
        	} else if (v instanceof List) {
        	handleList(v);
        	}
        	return v == null || v == '' || (v instanceof Map && v.size() == 0) || (v instanceof List && v.size() == 0)
        });
        }
        void handleList(List list) {
        list.removeIf(v -> {
        	if (v instanceof Map) {
        	handleMap(v);
        	} else if (v instanceof List) {
        	handleList(v);
        	}
        	return v == null || v == '' || (v instanceof Map && v.size() == 0) || (v instanceof List && v.size() == 0)
        });
        }
        handleMap(ctx);
  - set:
      tag: set_event_kind_to_pipeline_error_92954dfa
      if: ctx.error?.message != null
      field: event.kind
      value: pipeline_error
  - append:
      tag: append_tags_9fe66b2c
      if: ctx.error?.message != null
      field: tags
      value: preserve_original_event
      allow_duplicates: false
on_failure:
  - append:
      tag: append_error_message_e0c9bd63
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      tag: set_event_kind_to_pipeline_error_f51b77ad
      field: event.kind
      value: pipeline_error
  - append:
      tag: append_tags_d762b9c5
      field: tags
      value: preserve_original_event
      allow_duplicates: false
