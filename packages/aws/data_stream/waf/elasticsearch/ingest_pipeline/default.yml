---
description: "Pipeline for WAF logs"
processors:
- set:
    field: ecs.version
    value: '8.11.0'
- set:
    field: event.category
    value: ["web", "network"]
- append:
    field: event.type
    value: ["access"]
- rename:
    field: message
    target_field: event.original
    ignore_missing: true
    if: 'ctx.event?.original == null'
    description: 'Renames the original `message` field to `event.original` to store a copy of the original message. The `event.original` field is not touched if the document already has one; it may happen when Logstash sends the document.'
- remove:
    field: message
    ignore_missing: true
    if: 'ctx.event?.original != null'
    description: 'The `message` field is no longer required if the document has an `event.original` field.'
- json:
    field: event.original
    target_field: json
- date:
    field: json.timestamp
    target_field: '@timestamp'
    ignore_failure: true
    formats:
    - UNIX_MS
- rename:
    field: json.httpRequest.clientIp
    target_field: source.ip
    ignore_missing: true
- geoip:
    field: source.ip
    target_field: source.geo
    ignore_missing: true
- rename:
    field: json.httpRequest.country
    target_field: source.geo.country_iso_code
    ignore_missing: true
    if: ctx.source?.geo?.country_iso_code == null
- geoip:
    database_file: GeoLite2-ASN.mmdb
    field: source.ip
    target_field: source.as
    properties:
    - asn
    - organization_name
    ignore_missing: true
- rename:
    field: source.as.asn
    target_field: source.as.number
    ignore_missing: true
- rename:
    field: json.ClientASN
    target_field: source.as.number
    ignore_missing: true
    if: ctx?.source?.as?.number == null
- rename:
    field: source.as.organization_name
    target_field: source.as.organization.name
    ignore_missing: true
- convert:
    field: json.captchaResponse.responseCode
    target_field: aws.waf.captcha_response.response_code
    tag: convert_captchaResponse_responseCode_to_long
    type: long
    ignore_missing: true
    on_failure:
      - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
- date:
    field: json.captchaResponse.solveTimestamp
    target_field: aws.waf.captcha_response.solve_timestamp
    tag: date_captchaResponse_solveTimestamp
    formats:
    - UNIX_MS
    if: ctx.json?.captchaResponse?.solveTimestamp != null && ctx.json?.captchaResponse?.solveTimestamp != ''
    on_failure:
      - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
- rename:
    field: json.captchaResponse.failureReason
    tag: rename_captchaResponse_failureReason_to_captcha_response_failure_reason
    target_field: aws.waf.captcha_response.failure_reason
    ignore_missing: true
- convert:
    field: json.challengeResponse.responseCode
    target_field: aws.waf.challenge_response.response_code
    tag: convert_challengeResponse_responseCode_to_long
    type: long
    ignore_missing: true
    on_failure:
      - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
- date:
    field: json.challengeResponse.solveTimestamp
    target_field: aws.waf.challenge_response.solve_timestamp
    tag: date_challengeResponse_solveTimestamp
    formats:
    - UNIX_MS
    if: ctx.json?.challengeResponse?.solveTimestamp != null && ctx.json?.challengeResponse?.solveTimestamp != ''
    on_failure:
      - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
- rename:
    field: json.challengeResponse.failureReason
    tag: rename_challengeResponse_failureReason_to_challenge_response_failure_reason
    target_field: aws.waf.challenge_response.failure_reason
    ignore_missing: true
- convert:
    field: json.formatVersion
    target_field: aws.waf.format_version
    tag: convert_format_version_to_string
    type: string
    ignore_missing: true
- rename:
    field: json.httpRequest.fragment
    tag: rename_httpRequest_fragment_to_url_fragment
    target_field: url.fragment
    ignore_missing: true
- rename:
    field: json.httpRequest.host
    tag: rename_httpRequest_host_to_host_domain
    target_field: host.domain
    ignore_missing: true
- rename:
    field: json.httpRequest.requestId
    target_field: http.request.id
    ignore_missing: true
- rename:
    field: json.httpRequest.scheme
    tag: rename_httpRequest_scheme_to_url_scheme
    target_field: url.scheme
    ignore_missing: true
- convert:
    field: json.requestBodySize
    target_field: aws.waf.request_body_size
    tag: convert_requestBodySize_to_long
    type: long
    ignore_missing: true
    on_failure:
      - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
- convert:
    field: json.requestBodySizeInspectedByWAF
    target_field: aws.waf.request_body_size_inspected_by_waf
    tag: convert_requestBodySizeInspectedByWAF_to_long
    type: long
    ignore_missing: true
    on_failure:
      - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
- convert:
    field: json.responseCodeSent
    target_field: aws.waf.response_code_sent
    tag: convert_responseCodeSent_to_long
    type: long
    ignore_missing: true
    on_failure:
      - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
- rename:
    field: json.httpRequest.httpMethod
    target_field: http.request.method
    ignore_missing: true
- dissect:
    field: json.httpRequest.httpVersion
    pattern: "%{network.protocol}/%{http.version}"
    ignore_failure: true
- lowercase:
    field: network.protocol
    ignore_missing: true
- set:
    field: network.transport
    value: tcp
    if: ctx?.network?.protocol != null && ctx?.network?.protocol == 'http'
- rename:
    field: json.httpRequest.args
    target_field: url.query
    ignore_missing: true
- rename:
    field: json.httpRequest.uri
    target_field: url.path
    ignore_missing: true
- rename:
    field: json.ja3Fingerprint
    tag: rename_ja3Fingerprint_to_tls_client_ja3
    target_field: tls.client.ja3
    ignore_missing: true
- rename:
    field: json.ja4Fingerprint
    tag: rename_ja4Fingerprint_to_ja4_fingerprint
    target_field: aws.waf.ja4_fingerprint
    ignore_missing: true
- rename:
    field: json.labels
    tag: rename_labels_to_aws_waf_labels
    target_field: aws.waf.labels
    ignore_missing: true
- rename:
    field: json.oversizeFields
    tag: rename_oversizeFields_to_aws_waf_oversize_fields
    target_field: aws.waf.oversize_fields
    ignore_missing: true
- rename:
    field: json.terminatingRuleMatchDetails
    target_field: aws.waf.terminating_rule_match_details
    ignore_missing: true
- rename:
    field: json.ruleGroupList
    target_field: aws.waf.rule_group_list
    ignore_missing: true
- rename:
    field: json.rateBasedRuleList
    target_field: aws.waf.rate_based_rule_list
    ignore_missing: true
- rename:
    field: json.nonTerminatingMatchingRules
    target_field: aws.waf.non_terminating_matching_rules
    ignore_missing: true
- script:
    lang: painless
    source: >-
      if (ctx.json.httpRequest.headers != null) {
        ctx.aws.waf.request = new HashMap();
        ctx.aws.waf.request.headers = new HashMap();
        for (def i = 0; i < ctx.json.httpRequest.headers.length; i++) {
          ctx.aws.waf.request.headers[ctx.json.httpRequest.headers[i].name] = ctx.json.httpRequest.headers[i].value;
        }
      }
    ignore_failure: true
- script:
    lang: painless
    tag: script_request_headers_inserted
    description: Script to map requestHeadersInserted name to requestHeadersInserted value.
    if: ctx.json?.requestHeadersInserted != null && ctx.aws?.waf != null
    source: >-
      ctx.aws.waf.request_headers_inserted = new HashMap();
      for (def i = 0; i < ctx.json.requestHeadersInserted.length; i++) {
        ctx.aws.waf.request_headers_inserted[ctx.json.requestHeadersInserted[i].name] = ctx.json.requestHeadersInserted[i].value;
      }
    on_failure:
      - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
- rename:
    field: json.action
    target_field: event.action
    ignore_missing: true
- append:
    field: related.ip
    value: '{{source.ip}}'
    allow_duplicates: false
    if: ctx.source?.ip != null
- set:
    field: cloud.provider
    value: aws
- set:
    field: event.kind
    value: alert
- append:
    field: event.type
    value: allowed
    if: ctx.event.action == "ALLOW"
- append:
    field: event.type
    value: denied
    if: ctx.event.action == "BLOCK"
- rename:
    field: json.webaclId
    target_field: aws.waf.arn
    ignore_missing: true
- dissect:
    field: aws.waf.arn
    pattern: "arn:%{}:%{cloud.service.name}:%{cloud.region}:%{cloud.account.id}:%{aws.waf.id}"
    ignore_failure: true
    ignore_missing: true
- rename:
    field: json.terminatingRuleId
    target_field: rule.id
    ignore_missing: true
- rename:
    field: json.terminatingRuleType
    target_field: rule.ruleset
    ignore_missing: true
- rename:
    field: json.httpSourceName
    target_field: aws.waf.source.name
    ignore_missing: true
- rename:
    field: json.httpSourceId
    target_field: aws.waf.source.id
    ignore_missing: true

  #
  # Remove temporary fields
  #
- remove:
    field: json
    ignore_missing: true
- script:
    lang: painless
    description: This script processor iterates over the whole document to remove fields with null values.
    source: |
        void handleMap(Map map) {
            for (def x : map.values()) {
                if (x instanceof Map) {
                    handleMap(x);
                } else if (x instanceof List) {
                    handleList(x);
                }
            }
            map.values().removeIf(v -> v == null || v == "" || v == "-" || ((v instanceof List || v instanceof Map) && v.isEmpty()));
        }
        void handleList(List list) {
            for (def x : list) {
                if (x instanceof Map) {
                    handleMap(x);
                } else if (x instanceof List) {
                    handleList(x);
                }
            }
        }
        handleMap(ctx);
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}}failed with message '{{{ _ingest.on_failure_message }}}'
