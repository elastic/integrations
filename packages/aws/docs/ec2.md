# Amazon EC2

The Amazon EC2 integration allows you to monitor [Amazon Elastic Compute Cloud (Amazon EC2)](https://aws.amazon.com/ec2/)â€”a cloud compute platform.

Use the Amazon EC2 integration to collect logs and metrics related to your EC2 instances. Then visualize that data in Kibana, create alerts to notify you if something goes wrong, and reference the logs and metrics when troubleshooting an issue.

For example, you could use this data to track Amazon EC2 CPU utilization. Then you can alert when utilization for an instance crosses a predefined threshold.

**IMPORTANT: Extra AWS charges on AWS API requests will be generated by this integration. Please refer to the AWS integration for more details.**

## Data streams

The Amazon EC2 integration collects two types of data: logs and metrics.

**Logs** help you keep a record of events happening in Amazon EC2.
Logs collected by the Amazon EC2 integration include the region in which an instance is running, the operating system architecture, container information, and more. See more details in the [Logs reference](#logs-reference).

**Metrics** give you insight into the state of your Amazon EC2 instances.
Metrics collected by the Amazon EC2 integration include the Amazon EC2 instance ID, the number of earned CPU credits that an instance has accrued since it was launched or started, and more. See more details in the [Metrics reference](#metrics-reference).

## Requirements

You need Elasticsearch for storing and searching your data and Kibana for visualizing and managing it.
You can use our hosted Elasticsearch Service on Elastic Cloud, which is recommended, or self-manage the Elastic Stack on your own hardware.

Before using any AWS integration you will need:

* **AWS Credentials** to connect with your AWS account.
* **AWS Permissions** to make sure the user you're using to connect has permission to share the relevant data.

For more details about these requirements, please take a look at the [AWS integration documentation](https://docs.elastic.co/integrations/aws#requirements).

## Setup

Use this integration if you only need to collect data from the Amazon EC2 service.

If you want to collect data from two or more AWS services, consider using the **AWS** integration.
When you configure the AWS integration, you can collect data from as many AWS services as you'd like.

For step-by-step instructions on how to set up an integration, see the
[Getting started](https://www.elastic.co/guide/en/welcome-to-elastic/current/getting-started-observability.html) guide.

### Advanced options

#### CloudWatch

The CloudWatch logs input has several advanced options to fit specific use cases.

##### Latency

AWS CloudWatch Logs sometimes takes extra time to make the latest logs available to clients like the Agent.

The CloudWatch integration offers the `latency` setting to address this scenario. Latency translates the query's time range to consider the CloudWatch Logs latency. For example, a `5m` latency means the integration will query CloudWatch for logs available 5 minutes ago.

##### Number of workers

If you are collecting log events from multiple log groups using `log_group_name_prefix`, you should review the value of the `number_of_workers`.

The `number_of_workers` setting defines the number of workers assigned to reading from log groups. Each log group matching the `log_group_name_prefix` requires a worker to keep log ingestion as close to real-time as possible. For example, if `log_group_name_prefix` matches five log groups, then `number_of_workers` should be set to `5`. The default value is `1`.

## Logs reference

The `ec2` data stream supports both EC2 logs stored in AWS CloudWatch and EC2 logs stored in Amazon S3.
For logs stored in S3, you must export logs from log groups to an Amazon S3 bucket which has SQS notification setup already.

With this data stream, EC2 logs will be parsed into fields like  `ip_address`
and `process.name`. For logs from other services, please use the **AWS CloudWatch** integration.

**ECS Field Reference**

Please refer to the following [document](https://www.elastic.co/guide/en/ecs/current/ecs-field-reference.html) for detailed information on ECS fields.

**Exported fields**

| Field | Description | Type |
|---|---|---|
| @timestamp | Event timestamp. | date |
| aws.ec2.ip_address | The internet address of the requester. | keyword |
| aws.s3.bucket.arn | The AWS S3 bucket ARN. | keyword |
| aws.s3.bucket.name | The AWS S3 bucket name. | keyword |
| aws.s3.object.key | The AWS S3 Object key. | keyword |
| cloud.image.id | Image ID for the cloud instance. | keyword |
| data_stream.dataset | Data stream dataset. | constant_keyword |
| data_stream.namespace | Data stream namespace. | constant_keyword |
| data_stream.type | Data stream type. | constant_keyword |
| event.module | Event module | constant_keyword |
| host.containerized | If the host is a container. | boolean |
| host.os.build | OS build information. | keyword |
| host.os.codename | OS codename, if any. | keyword |
| input.type | Input type | keyword |
| log.offset | Log offset | long |


An example event for `ec2` looks as following:

```json
{
    "@timestamp": "2020-02-20T07:01:01.000Z",
    "agent": {
        "ephemeral_id": "d86fb0e5-bdd6-4b91-8a3e-3535b80a4118",
        "id": "acba78ef-1401-4689-977c-d8c2e5d6a8fa",
        "name": "docker-fleet-agent",
        "type": "filebeat",
        "version": "8.10.1"
    },
    "aws": {
        "ec2": {
            "ip_address": "ip-172-31-81-156"
        },
        "s3": {
            "bucket": {
                "arn": "arn:aws:s3:::elastic-package-aws-bucket-36908",
                "name": "elastic-package-aws-bucket-36908"
            },
            "object": {
                "key": "ec2.log"
            }
        }
    },
    "cloud": {
        "provider": "",
        "region": "us-east-1"
    },
    "data_stream": {
        "dataset": "aws.ec2_logs",
        "namespace": "ep",
        "type": "logs"
    },
    "ecs": {
        "version": "8.11.0"
    },
    "elastic_agent": {
        "id": "acba78ef-1401-4689-977c-d8c2e5d6a8fa",
        "snapshot": false,
        "version": "8.10.1"
    },
    "event": {
        "agent_id_status": "verified",
        "dataset": "aws.ec2_logs",
        "ingested": "2023-11-03T15:00:09Z",
        "original": "2020-02-20T07:01:01.000Z Feb 20 07:01:01 ip-172-31-81-156 systemd: Stopping User Slice of root."
    },
    "input": {
        "type": "aws-s3"
    },
    "log": {
        "file": {
            "path": "https://elastic-package-aws-bucket-36908.s3.us-east-1.amazonaws.com/ec2.log"
        },
        "offset": 0
    },
    "message": "Stopping User Slice of root.",
    "process": {
        "name": "systemd"
    },
    "tags": [
        "preserve_original_event",
        "forwarded",
        "aws-ec2-logs"
    ]
}
```

## Metrics reference

An example event for `ec2` looks as following:

```json
{
    "@timestamp": "2023-08-07T18:35:00.000Z",
    "agent": {
        "ephemeral_id": "b8cd4414-f528-43f4-b43f-0edbcc69b46f",
        "id": "72314f01-98f2-477f-978a-e98d109c640c",
        "name": "docker-fleet-agent",
        "type": "metricbeat",
        "version": "8.8.1"
    },
    "aws": {
        "cloudwatch": {
            "namespace": "AWS/EC2"
        },
        "dimensions": {
            "InstanceId": "i-0c08512debca266ab"
        },
        "ec2": {
            "instance": {
                "core": {
                    "count": 1
                },
                "image": {
                    "id": "ami-00b8290583a865359"
                },
                "monitoring": {
                    "state": "disabled"
                },
                "private": {
                    "dns_name": "ip-172-31-13-154.eu-north-1.compute.internal",
                    "ip": "172.31.13.154"
                },
                "public": {
                    "dns_name": "ec2-16-16-138-5.eu-north-1.compute.amazonaws.com",
                    "ip": "16.16.138.5"
                },
                "state": {
                    "code": 16,
                    "name": "running"
                },
                "threads_per_core": 2
            },
            "metrics": {
                "CPUCreditBalance": {
                    "avg": 576
                },
                "CPUCreditUsage": {
                    "avg": 0.29100543333333334
                },
                "CPUSurplusCreditBalance": {
                    "avg": 0
                },
                "CPUSurplusCreditsCharged": {
                    "avg": 0
                },
                "CPUUtilization": {
                    "avg": 2.8849988898518673
                },
                "NetworkIn": {
                    "rate": 26815.983333333334,
                    "sum": 1608959
                },
                "NetworkOut": {
                    "rate": 10445.916666666666,
                    "sum": 626755
                },
                "NetworkPacketsIn": {
                    "rate": 88.9,
                    "sum": 5334
                },
                "NetworkPacketsOut": {
                    "rate": 82.95,
                    "sum": 4977
                },
                "StatusCheckFailed": {
                    "avg": 0
                },
                "StatusCheckFailed_Instance": {
                    "avg": 0
                },
                "StatusCheckFailed_System": {
                    "avg": 0
                }
            }
        },
        "tags": {
            "aws:autoscaling:groupName": "eks-firehose-50c386d7-c8b1-bde8-5d42-d3841ca7ecfe",
            "aws:ec2launchtemplate:id": "lt-09e1cdf590e35c687",
            "aws:ec2launchtemplate:version": "1"
        }
    },
    "cloud": {
        "account": {
            "id": "627286350134",
            "name": "MonitoringAccount"
        },
        "availability_zone": "eu-north-1c",
        "instance": {
            "id": "i-0c08512debca266ab"
        },
        "machine": {
            "type": "t3.medium"
        },
        "provider": "aws",
        "region": "eu-north-1"
    },
    "data_stream": {
        "dataset": "aws.ec2_metrics",
        "namespace": "default",
        "type": "metrics"
    },
    "ecs": {
        "version": "8.11.0"
    },
    "elastic_agent": {
        "id": "72314f01-98f2-477f-978a-e98d109c640c",
        "snapshot": false,
        "version": "8.8.1"
    },
    "event": {
        "agent_id_status": "verified",
        "dataset": "aws.ec2_metrics",
        "duration": 5858967919,
        "ingested": "2023-08-07T18:41:31Z",
        "module": "aws"
    },
    "host": {
        "architecture": "aarch64",
        "containerized": false,
        "cpu": {
            "usage": 2.8849988898518673
        },
        "hostname": "docker-fleet-agent",
        "id": "d08b346fbb8f49f5a2bb1a477f8ceb54",
        "ip": [
            "172.20.0.7"
        ],
        "mac": [
            "02-42-AC-14-00-07"
        ],
        "name": "docker-fleet-agent",
        "network": {
            "egress": {
                "bytes": 626755,
                "packets": 4977
            },
            "ingress": {
                "bytes": 1608959,
                "packets": 5334
            }
        },
        "os": {
            "codename": "focal",
            "family": "debian",
            "kernel": "5.15.49-linuxkit-pr",
            "name": "Ubuntu",
            "platform": "ubuntu",
            "type": "linux",
            "version": "20.04.6 LTS (Focal Fossa)"
        }
    },
    "metricset": {
        "name": "cloudwatch",
        "period": 300000
    },
    "service": {
        "type": "aws"
    }
}
```

**ECS Field Reference**

Please refer to the following [document](https://www.elastic.co/guide/en/ecs/current/ecs-field-reference.html) for detailed information on ECS fields.

**Exported fields**

| Field | Description | Type | Metric Type |
|---|---|---|---|
| @timestamp | Event timestamp. | date |  |
| agent.id | Unique identifier of this agent (if one exists). Example: For Beats this would be beat.id. | keyword |  |
| aws.cloudwatch.namespace | The namespace specified when query cloudwatch api. | keyword |  |
| aws.dimensions.AutoScalingGroupName | An Auto Scaling group is a collection of instances you define if you're using Auto Scaling. | keyword |  |
| aws.dimensions.ImageId | This dimension filters the data you request for all instances running this Amazon EC2 Amazon Machine Image (AMI) | keyword |  |
| aws.dimensions.InstanceId | Amazon EC2 instance ID | keyword |  |
| aws.dimensions.InstanceType | This dimension filters the data you request for all instances running with this specified instance type. | keyword |  |
| aws.ec2.instance.core.count | The number of CPU cores for the instance. | integer |  |
| aws.ec2.instance.image.id | The ID of the image used to launch the instance. | keyword |  |
| aws.ec2.instance.monitoring.state | Indicates whether detailed monitoring is enabled. | keyword |  |
| aws.ec2.instance.private.dns_name | The private DNS name of the network interface. | keyword |  |
| aws.ec2.instance.private.ip | The private IPv4 address associated with the network interface. | ip |  |
| aws.ec2.instance.public.dns_name | The public DNS name of the instance. | keyword |  |
| aws.ec2.instance.public.ip | The address of the Elastic IP address (IPv4) bound to the network interface. | ip |  |
| aws.ec2.instance.state.code | The state of the instance, as a 16-bit unsigned integer. | integer |  |
| aws.ec2.instance.state.name | The state of the instance (pending | running | shutting-down | terminated | stopping | stopped). | keyword |  |
| aws.ec2.instance.threads_per_core | The number of threads per CPU core. | integer |  |
| aws.ec2.metrics.CPUCreditBalance.avg | The number of earned CPU credits that an instance has accrued since it was launched or started. | long | gauge |
| aws.ec2.metrics.CPUCreditUsage.avg | The number of CPU credits spent by the instance for CPU utilization. | long | gauge |
| aws.ec2.metrics.CPUSurplusCreditBalance.avg | The number of surplus credits that have been spent by an unlimited instance when its CPUCreditBalance value is zero. | long | gauge |
| aws.ec2.metrics.CPUSurplusCreditsCharged.avg | The number of spent surplus credits that are not paid down by earned CPU credits, and which thus incur an additional charge. | long | gauge |
| aws.ec2.metrics.CPUUtilization.avg | The average percentage of physical CPU time that Amazon EC2 uses to run the EC2 instance. | long | gauge |
| aws.ec2.metrics.DiskReadBytes.rate | Bytes read per second from all instance store volumes available to the instance. | long | gauge |
| aws.ec2.metrics.DiskReadBytes.sum | Total bytes read from all instance store volumes available to the instance. | long | gauge |
| aws.ec2.metrics.DiskReadOps.rate | Completed read operations per second from all instance store volumes available to the instance in a specified period of time. | long | gauge |
| aws.ec2.metrics.DiskReadOps.sum | Total completed read operations from all instance store volumes available to the instance in a specified period of time. | long | gauge |
| aws.ec2.metrics.DiskWriteBytes.rate | Bytes written per second to all instance store volumes available to the instance. | long | gauge |
| aws.ec2.metrics.DiskWriteBytes.sum | Total bytes written to all instance store volumes available to the instance. | long | gauge |
| aws.ec2.metrics.DiskWriteOps.rate | Completed write operations per second to all instance store volumes available to the instance in a specified period of time. | long | gauge |
| aws.ec2.metrics.DiskWriteOps.sum | Total completed write operations to all instance store volumes available to the instance in a specified period of time. | long | gauge |
| aws.ec2.metrics.NetworkIn.rate | The number of bytes per second received on all network interfaces by the instance. | long | gauge |
| aws.ec2.metrics.NetworkIn.sum | The number of bytes total received on all network interfaces by the instance. | long | gauge |
| aws.ec2.metrics.NetworkOut.rate | The number of bytes per second sent out on all network interfaces by the instance. | long | gauge |
| aws.ec2.metrics.NetworkOut.sum | The number of bytes total sent out on all network interfaces by the instance. | long | gauge |
| aws.ec2.metrics.NetworkPacketsIn.rate | The number of packets per second sent out on all network interfaces by the instance. | long | gauge |
| aws.ec2.metrics.NetworkPacketsIn.sum | The number of packets total sent out on all network interfaces by the instance. | long | gauge |
| aws.ec2.metrics.NetworkPacketsOut.rate | The number of packets per second sent out on all network interfaces by the instance. | long | gauge |
| aws.ec2.metrics.NetworkPacketsOut.sum | The number of packets total sent out on all network interfaces by the instance. | long | gauge |
| aws.ec2.metrics.StatusCheckFailed.avg | Reports whether the instance has passed both the instance status check and the system status check in the last minute. | long | gauge |
| aws.ec2.metrics.StatusCheckFailed_Instance.avg | Reports whether the instance has passed the instance status check in the last minute. | long | gauge |
| aws.ec2.metrics.StatusCheckFailed_System.avg | Reports whether the instance has passed the system status check in the last minute. | long | gauge |
| aws.tags | Tag key value pairs from aws resources. | flattened |  |
| cloud.account.id | The cloud account or organization id used to identify different entities in a multi-tenant environment. Examples: AWS account id, Google Cloud ORG Id, or other unique identifier. | keyword |  |
| cloud.image.id | Image ID for the cloud instance. | keyword |  |
| cloud.region | Region in which this host, resource, or service is located. | keyword |  |
| data_stream.dataset | Data stream dataset. | constant_keyword |  |
| data_stream.namespace | Data stream namespace. | constant_keyword |  |
| data_stream.type | Data stream type. | constant_keyword |  |
| event.module | Event module | constant_keyword |  |
| host.containerized | If the host is a container. | boolean |  |
| host.os.build | OS build information. | keyword |  |
| host.os.codename | OS codename, if any. | keyword |  |
