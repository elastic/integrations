config_version: 2
resource:
  url: "{{api_host}}/api/v1/computers-inventory"
  timeout: {{http_client_timeout}}
{{#if enable_request_tracer}}
  tracer:
    filename: "../../logs/jamf_pro-versions/http-request-trace-*.ndjson"
    maxbackups: 5
{{/if}}
auth:
  oauth2:
    client:
      id: {{client_id}}
      secret: {{client_secret}}
    token_url: "{{api_host}}/api/oauth/token"
    endpoint_params:
      grant_type: "client_credentials" 
interval: {{interval}}
max_executions: {{max_executions}}
tags:
{{#each tags as |tag|}}
  - {{tag}}
{{/each}}
{{#contains "forwarded" tags}}
publisher_pipeline.disable_host: true
{{/contains}}

keep_null: true
program: |
  request(
    "GET",
      state.url.trim_right("/")  + "?" +	{
      "section" : state.sections,
      "page-size": [string(state.page_size)],
      "page": [string(state.?cursor.?page.orValue(int(0)))]
    }.format_query()
  ).with({
    "Header": ({
      "Content-Type": ["application/json"]
    })
  }).do_request().as(resp,
    bytes(resp.Body).decode_json().as(body,
      resp.StatusCode != 200 ?
        {
          "events": [{
            "error": { "message": "response: " + string(resp.StatusCode) },
            "event": { "original": resp.Body }
          }]
        }
      :
        state.with({
          "events": body.results.map(e, {
              "message": e,
          }),
          "want_more": (int(state.?cursor.?page.orValue(int(0))) + 1) * int(state.page_size) < int(body.totalCount),
          "cursor": {"page": int(state.?cursor.?page.orValue(int(0))) + 1},
        })
    )
  )
state:
  page_size: {{page_size}}
  sections: [
  {{#if enable_section_general }} "GENERAL", {{/if}}
  {{#if enable_section_hardware }} "HARDWARE", {{/if}}
  {{#if enable_section_operating_system }} "OPERATING_SYSTEM", {{/if}}
  {{#if enable_section_disk_encryption }} "DISK_ENCRYPTION", {{/if}}
  {{#if enable_section_purchasing }} "PURCHASING", {{/if}}
  {{#if enable_section_applications }} "APPLICATIONS", {{/if}}
  {{#if enable_section_storage }} "STORAGE", {{/if}}
  {{#if enable_section_user_and_location  }} "USER_AND_LOCATION", {{/if}}
  {{#if enable_section_configuration_profiles }} "CONFIGURATION_PROFILES", {{/if}}
  {{#if enable_section_printers }} "PRINTERS", {{/if}}
  {{#if enable_section_services }} "SERVICES", {{/if}}
  {{#if enable_section_local_user_accounts }} "LOCAL_USER_ACCOUNTS", {{/if}}
  {{#if enable_section_certificates }} "CERTIFICATES", {{/if}}
  {{#if enable_section_attachments }} "ATTACHMENTS", {{/if}}
  {{#if enable_section_plugins }} "PLUGINS", {{/if}}
  {{#if enable_section_package_receipts }} "PACKAGE_RECEIPTS", {{/if}}
  {{#if enable_section_fonts }} "FONTS", {{/if}}
  {{#if enable_section_security }} "SECURITY", {{/if}}
  {{#if enable_section_licensed_software }} "LICENSED_SOFTWARE", {{/if}}
  {{#if enable_section_ibeacons }} "IBEACONS", {{/if}}
  {{#if enable_section_software_updates }} "SOFTWARE_UPDATES", {{/if}}
  {{#if enable_section_extension_attributes }} "EXTENSION_ATTRIBUTES", {{/if}}
  {{#if enable_section_content_caching }} "CONTENT_CACHING", {{/if}}
  {{#if enable_section_group_membership }} "GROUP_MEMBERSHIP", {{/if}}
  ]


