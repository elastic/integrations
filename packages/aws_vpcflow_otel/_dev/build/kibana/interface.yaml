---
dashboards:
  # Dashboard 3: Interface Analysis - Per-interface deep dive
  - id: aws_vpcflow_otel-interface
    name: '[AWS VPC OTEL] Interface Analysis'
    description: Per-interface analysis for investigating specific network interfaces
    filters:
      - field: data_stream.dataset
        equals: aws.vpcflow.otel
    controls:
      # Primary filters
      - type: options
        label: Cloud Account ID
        data_view: logs-*
        field: cloud.account.id
      - type: options
        label: Network Interface
        data_view: logs-*
        field: network.interface.name
      - type: options
        label: Action
        width: small
        data_view: logs-*
        field: aws.vpc.flow.action
      # Traffic filters for drill-down
      - type: options
        label: Destination Port
        width: small
        data_view: logs-*
        field: destination.port
      - type: options
        label: Protocol
        width: small
        data_view: logs-*
        field: network.protocol.name
    panels:
      # Navigation
      - size: {w: 48, h: 2}
        links:
          layout: horizontal
          items:
            - label: Overview
              dashboard: aws_vpcflow_otel-overview
            - label: Traffic Analysis
              dashboard: aws_vpcflow_otel-traffic
            - label: Interface Analysis
              dashboard: aws_vpcflow_otel-interface

      # Interface KPIs (no section header - first section)
      - title: Total Interfaces
        hide_title: true
        size: {w: 10, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.interface.name IS NOT NULL
            - STATS total_interfaces = COUNT_DISTINCT(network.interface.name)
          primary:
            field: total_interfaces
            label: Total Interfaces
            format:
              type: number
              decimals: 0
      - title: Total Flow Records
        hide_title: true
        size: {w: 9, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel"
            - STATS total_flows = COUNT()
          primary:
            field: total_flows
            label: Flow Records
            format:
              type: number
              decimals: 0
      - title: Unique Source IPs
        hide_title: true
        size: {w: 10, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND source.address IS NOT NULL
            - STATS unique_sources = COUNT_DISTINCT(source.address)
          primary:
            field: unique_sources
            label: Unique Sources
            format:
              type: number
              decimals: 0
      - title: Unique Destination IPs
        hide_title: true
        size: {w: 9, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND destination.address IS NOT NULL
            - STATS unique_destinations = COUNT_DISTINCT(destination.address)
          primary:
            field: unique_destinations
            label: Unique Destinations
            format:
              type: number
              decimals: 0
      - title: Unique Protocols
        hide_title: true
        size: {w: 10, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.protocol.name IS NOT NULL
            - STATS unique_protocols = COUNT_DISTINCT(network.protocol.name)
          primary:
            field: unique_protocols
            label: Protocols
            format:
              type: number
              decimals: 0

      # Interface Traffic Trend
      - title: Interface Traffic Over Time
        size: {w: 48, h: 10}
        esql:
          type: area
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.interface.name IS NOT NULL
            - STATS flow_count = COUNT() BY time_bucket = BUCKET(@timestamp, 50, ?_tstart, ?_tend)
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
            label: Time
            data_type: date
          metrics:
            - field: flow_count
              label: Flow Count
              format:
                type: number
                decimals: 0
          appearance:
            x_axis:
              title: '@timestamp'
            y_left_axis:
              title: Flow Count

      # Interface Traffic Analysis
      - title: Interface Traffic Analysis
        size: {w: 48, h: 13}
        esql:
          type: bar
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.interface.name IS NOT NULL AND aws.vpc.flow.action IS NOT NULL
            - STATS flow_count = COUNT() BY network.interface.name, aws.vpc.flow.action
            - SORT flow_count DESC
          mode: stacked
          dimension:
            field: network.interface.name
            label: Interface
          metrics:
            - field: flow_count
              label: Flow Count
              format:
                type: number
                decimals: 0
          breakdown:
            field: aws.vpc.flow.action
          color:
            palette: eui_amsterdam_color_blind
            assignments:
              - value: REJECT
                color: '#BD271E'
              - value: ACCEPT
                color: '#00BF6F'
          appearance:
            y_left_axis:
              title: Flow Count

      # Top Interfaces by Bandwidth
      - title: Top Interfaces by Bandwidth
        size: {w: 48, h: 13}
        esql:
          type: bar
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.interface.name IS NOT NULL AND aws.vpc.flow.bytes IS NOT NULL
            - STATS total_bytes = SUM(aws.vpc.flow.bytes) BY network.interface.name
            - SORT total_bytes DESC
            - LIMIT 10
          dimension:
            field: network.interface.name
            label: Interface
          metrics:
            - field: total_bytes
              label: Bytes
              format:
                type: bytes
          legend:
            visible: hide
          appearance:
            y_left_axis:
              title: Bytes

      # Traffic Details
      - markdown:
          content: '### Traffic Details'
        size: {w: 48, h: 3}
      - title: Accepted vs Rejected by Protocol
        size: {w: 24, h: 12}
        esql:
          type: bar
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.protocol.name IS NOT NULL AND aws.vpc.flow.action IS NOT NULL
            - STATS flow_count = COUNT() BY network.protocol.name, aws.vpc.flow.action
            - SORT flow_count DESC
          mode: stacked
          dimension:
            field: network.protocol.name
            label: Protocol
          metrics:
            - field: flow_count
              label: Flow Count
              format:
                type: number
                decimals: 0
          breakdown:
            field: aws.vpc.flow.action
          color:
            palette: eui_amsterdam_color_blind
            assignments:
              - value: REJECT
                color: '#BD271E'
              - value: ACCEPT
                color: '#00BF6F'
          appearance:
            y_left_axis:
              title: Flow Count
      - title: Bandwidth by Protocol
        size: {w: 24, h: 12}
        esql:
          type: bar
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.protocol.name IS NOT NULL AND aws.vpc.flow.bytes IS NOT NULL
            - STATS total_bytes = SUM(aws.vpc.flow.bytes) BY network.protocol.name
            - SORT total_bytes DESC
            - LIMIT 10
          dimension:
            field: network.protocol.name
            label: Protocol
          metrics:
            - field: total_bytes
              label: Bytes
              format:
                type: bytes
          legend:
            visible: hide
          appearance:
            y_left_axis:
              title: Bytes

      # Account Analysis
      - markdown:
          content: '### Account Analysis'
        size: {w: 48, h: 3}
      - title: Traffic by Cloud Account
        size: {w: 48, h: 13}
        esql:
          type: datatable
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND cloud.account.id IS NOT NULL
            - EVAL is_accepted = CASE(aws.vpc.flow.action == "ACCEPT", 1, 0)
            - EVAL is_rejected = CASE(aws.vpc.flow.action == "REJECT", 1, 0)
            - STATS total_flows = COUNT(), accepted_flows = SUM(is_accepted), rejected_flows = SUM(is_rejected), total_bytes = SUM(aws.vpc.flow.bytes),
              unique_interfaces = COUNT_DISTINCT(network.interface.name), unique_sources = COUNT_DISTINCT(source.address) BY cloud.account.id
            - EVAL rejection_rate = CASE(total_flows > 0, rejected_flows::double / total_flows::double, 0)
            - SORT total_flows DESC
            - LIMIT 100
          dimensions:
            - field: cloud.account.id
              label: Cloud Account ID
          metrics:
            - field: total_flows
              label: Total Flows
              format:
                type: number
                decimals: 0
            - field: accepted_flows
              label: Accepted
              format:
                type: number
                decimals: 0
            - field: rejected_flows
              label: Rejected
              format:
                type: number
                decimals: 0
            - field: rejection_rate
              label: Rejection %
              format:
                type: percent
                decimals: 1
            - field: total_bytes
              label: Bytes
              format:
                type: bytes
            - field: unique_interfaces
              label: Interfaces
              format:
                type: number
                decimals: 0
            - field: unique_sources
              label: Unique Sources
              format:
                type: number
                decimals: 0
          paging:
            enabled: true
            page_size: 10
