---
dashboards:
  # Dashboard 1: Overview - High-level KPIs and trends
  - id: aws_vpcflow_otel-overview
    name: '[AWS VPC OTEL] VPC Flow Logs Overview'
    description: High-level status and trends for AWS VPC Flow Logs
    filters:
      - field: data_stream.dataset
        equals: aws.vpcflow.otel
    controls:
      - type: options
        label: Cloud Account ID
        data_view: logs-*
        field: cloud.account.id
      - type: options
        label: Network Interface
        data_view: logs-*
        field: network.interface.name
      - type: options
        label: Action
        width: small
        data_view: logs-*
        field: aws.vpc.flow.action
    panels:
      # Navigation
      - size: {w: 48, h: 2}
        links:
          layout: horizontal
          items:
            - label: Overview
              dashboard: aws_vpcflow_otel-overview
            - label: Traffic Analysis
              dashboard: aws_vpcflow_otel-traffic
            - label: Interface Analysis
              dashboard: aws_vpcflow_otel-interface
      # KPI Metrics (no section header - first section)
      - title: Total Flow Records
        hide_title: true
        size: {w: 8, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel"
            - STATS total_flows = COUNT()
          primary:
            field: total_flows
            label: Flow Records
            format:
              type: number
              decimals: 0
      - title: Rejection Rate
        hide_title: true
        size: {w: 8, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel"
            - EVAL is_rejected = CASE(aws.vpc.flow.action == "REJECT", 1, 0)
            - STATS total_flows = COUNT(), rejected_flows = SUM(is_rejected)
            - EVAL rejection_rate = CASE(total_flows > 0, rejected_flows::double / total_flows::double, 0)
          primary:
            field: rejection_rate
            label: Rejection Rate
            format:
              type: percent
              decimals: 1
      - title: Total Bandwidth
        hide_title: true
        size: {w: 8, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND aws.vpc.flow.bytes IS NOT NULL
            - STATS total_bytes = SUM(aws.vpc.flow.bytes)
          primary:
            field: total_bytes
            label: Total Bandwidth
            format:
              type: bytes
      - title: Active Interfaces
        hide_title: true
        size: {w: 8, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.interface.name IS NOT NULL
            - STATS unique_interfaces = COUNT_DISTINCT(network.interface.name)
          primary:
            field: unique_interfaces
            label: Active Interfaces
            format:
              type: number
              decimals: 0
      - title: Cloud Accounts
        hide_title: true
        size: {w: 8, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND cloud.account.id IS NOT NULL
            - STATS unique_accounts = COUNT_DISTINCT(cloud.account.id)
          primary:
            field: unique_accounts
            label: Cloud Accounts
            format:
              type: number
              decimals: 0
      - title: Unique Protocols
        hide_title: true
        size: {w: 8, h: 4}
        esql:
          type: metric
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND network.protocol.name IS NOT NULL
            - STATS unique_protocols = COUNT_DISTINCT(network.protocol.name)
          primary:
            field: unique_protocols
            label: Unique Protocols
            format:
              type: number
              decimals: 0

      # Quick Insights
      - markdown:
          content: '### Quick Insights'
        size: {w: 48, h: 3}
      - title: Top 5 Interfaces by Rejected Traffic
        size: {w: 24, h: 10}
        esql:
          type: bar
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND aws.vpc.flow.action == "REJECT" AND network.interface.name IS NOT NULL
            - STATS rejected_count = COUNT() BY network.interface.name
            - SORT rejected_count DESC
            - LIMIT 5
          dimension:
            field: network.interface.name
            label: Interface
          metrics:
            - field: rejected_count
              label: Rejected Flows
              format:
                type: number
                decimals: 0
          legend:
            visible: hide
          color:
            palette: negative
          appearance:
            y_left_axis:
              title: Rejected Flows
      - title: Top 5 Rejected Destination Ports
        size: {w: 24, h: 10}
        esql:
          type: bar
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND aws.vpc.flow.action == "REJECT" AND destination.port IS NOT NULL
            - STATS rejected_count = COUNT() BY destination.port
            - SORT rejected_count DESC
            - LIMIT 5
          dimension:
            field: destination.port
            label: Dest Port
          metrics:
            - field: rejected_count
              label: Rejected Flows
              format:
                type: number
                decimals: 0
          legend:
            visible: hide
          color:
            palette: negative
          appearance:
            y_left_axis:
              title: Rejected Flows

      # Time-Series Trends
      - markdown:
          content: '### Time-Series Trends'
        size: {w: 48, h: 3}
      - title: Traffic Volume Over Time
        size: {w: 48, h: 12}
        esql:
          type: area
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND aws.vpc.flow.action IS NOT NULL
            - STATS flow_count = COUNT() BY aws.vpc.flow.action, time_bucket = BUCKET(@timestamp, 50, ?_tstart, ?_tend)
            - SORT time_bucket ASC
          mode: stacked
          dimension:
            field: time_bucket
            label: Time
            data_type: date
          metrics:
            - field: flow_count
              label: Flow Count
              format:
                type: number
                decimals: 0
          breakdown:
            field: aws.vpc.flow.action
          color:
            palette: eui_amsterdam_color_blind
            assignments:
              - value: REJECT
                color: '#BD271E'
              - value: ACCEPT
                color: '#00BF6F'
          appearance:
            x_axis:
              title: '@timestamp'
            y_left_axis:
              title: Flow Count
      - title: Bandwidth Usage Over Time
        size: {w: 48, h: 12}
        esql:
          type: line
          query:
            - FROM logs-*
            - WHERE data_stream.dataset == "aws.vpcflow.otel" AND aws.vpc.flow.bytes IS NOT NULL
            - STATS total_bytes = SUM(aws.vpc.flow.bytes) BY time_bucket = BUCKET(@timestamp, 50, ?_tstart, ?_tend)
            - SORT time_bucket ASC
          dimension:
            field: time_bucket
            label: Time
            data_type: date
          metrics:
            - field: total_bytes
              label: Bytes
              format:
                type: bytes
          appearance:
            x_axis:
              title: '@timestamp'
            y_left_axis:
              title: Bandwidth
