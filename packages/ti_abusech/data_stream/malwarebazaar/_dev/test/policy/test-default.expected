inputs:
    - data_stream:
        namespace: ep
      meta:
        package:
            name: ti_abusech
      name: test-default-ti_abusech
      streams:
        - config_version: 2
          data_stream:
            dataset: ti_abusech.malwarebazaar
            type: logs
          fields:
            _conf:
                ioc_expiration_duration: 90d
          fields_under_root: true
          interval: 10m
          program: "state.with(\n  request(\"POST\", state.url, \"query=get_recent&selector=time\").with({\n    \"Header\":{\n      \"Content-Type\": [\"application/x-www-form-urlencoded\"],\n      ?\"Auth-Key\": has(state.auth_key) ? \n        optional.of([state.auth_key]) \n      :\n        optional.none(),\n    }\n  }).do_request().as(resp, resp.StatusCode == 200 ?\n    resp.Body.decode_json().as(body, body.?query_status == optional.of(\"ok\") ?\n      {\n        \"events\": body.data.map(ind, {\n          \"message\": ind.encode_json()\n        }),\n        \"url\": state.url\n      }\n    : body.?query_status == optional.of(\"no_results\") ?\n      {\n        \"events\": [],\n        \"url\": state.url\n      }\n    :\n      {\n        \"events\": {\n          \"error\": {\n            ?\"id\": body.?query_status,\n            \"message\": \"POST \"+state.url+\": \"+(\n              size(resp.Body) != 0 ?\n                string(resp.Body)\n              :\n                string(resp.Status) + ' (' + string(resp.StatusCode) + ')'\n            ),\n          },\n        },\n        \"url\": state.url\n      }\n    )\n  :\n    {\n      \"events\": {\n        \"error\": {\n          \"code\": string(resp.StatusCode),\n          \"id\": string(resp.Status),\n          \"message\": \"POST:\"+(\n            size(resp.Body) != 0 ?\n              string(resp.Body)\n            :\n              string(resp.Status) + ' (' + string(resp.StatusCode) + ')'\n          ),\n        },\n      },\n      \"url\": state.url\n    }\n  )\n)\n"
          publisher_pipeline.disable_host: true
          redact:
            fields:
                - auth_key
          resource.timeout: 30s
          resource.tracer:
            enabled: false
            filename: ../../logs/cel/http-request-trace-*.ndjson
            maxbackups: 5
          resource.url: https://mb-api.abuse.ch/api/v1/
          state:
            auth_key: ${SECRET_0}
          tags:
            - forwarded
            - abusech-malwarebazaar
      type: cel
      use_output: default
output_permissions:
    default:
        _elastic_agent_checks:
            cluster:
                - monitor
        _elastic_agent_monitoring:
            indices: []
        uuid-for-permissions-on-related-indices:
            indices:
                - names:
                    - logs-ti_abusech.malwarebazaar-ep
                  privileges:
                    - auto_configure
                    - create_doc
secret_references:
    - {}
