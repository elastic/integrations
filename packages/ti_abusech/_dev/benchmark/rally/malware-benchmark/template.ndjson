{{- $timestamp := generate "timestamp" }}
{{- $expireDur := generate "expire_dur" }}
{{- $hostname := generate "host.name" }}
{{- $agentId := generate "agent.id" }}
{{- $fileSize := generate "filesize" }}
{{- $fileType := generate "filetype" }}
{{- $impHash := generate "imp_hash" }}
{{- $md5Hash := generate "md5_hash" }}
{{- $sha256Hash := sha256sum (generate "sha256_hash") }}
{{- $signature := generate "signature" }}
{{- $ssdeep := generate "ssdeep" }}
{{- $tlsh := generate "tlsh" }}
{{- $duration_start := generate "duration_start" }}
{{- $firstSeen := ($timestamp | date_modify (print $duration_start)).Format "2006-01-02 15:04:05" }}
{{- $virustotalPercent := generate "virustotal.percent" }}
{{- $virustotalDetectionId := generate "virustotal.detection_id" }}
{{- $virustotalResultNum := generate "virustotal.result_num" }}
{{- $virustotalResultDen := generate "virustotal.result_den" }}
{
  "@timestamp": "{{ $timestamp.Format "2006-01-02T15:04:05.999999Z07:00" }}",
  "_conf": {
    "ioc_expiration_duration": "{{ $expireDur }}d"
  },
  "agent": {
    "id": "{{$agentId}}",
    "name": "{{$hostname}}",
    "type": "filebeat",
    "version": "8.18.0",
    "ephemeral_id": "{{$agentId}}"
  },
  "data_stream": {
    "namespace": "ep",
    "type": "logs",
    "dataset": "ti_abusech.malware"
  },
  "elastic_agent": {
    "id": "60a22c30-4c80-4e95-b5b1-87ff540d8afd",
    "snapshot": false,
    "version": "8.18.0"
  },
  "message": "{\"file_size\": \"{{ $fileSize }}\",\"file_type\": \"{{ $fileType }}\",\"firstseen\": \"{{ $firstSeen }}\",\"imphash\": \"{{ $impHash }}\",\"magika\": \"{{ $fileType }}\",\"md5_hash\": \"{{ $md5Hash }}\",\"sha256_hash\": \"{{ $sha256Hash }}\",\"signature\": \"{{ $signature }}\",\"ssdeep\": \"{{ $ssdeep }}\",\"tlsh\": \"{{ $tlsh }}\",\"urlhaus_download\": \"https://urlhaus-api.abuse.ch/v1/download/{{ $sha256Hash }}/\",\"virustotal\": {\"link\": \"https://www.virustotal.com/gui/file/{{ $sha256Hash }}/detection/{{ $virustotalDetectionId }}\",\"percent\": \"{{ $virustotalPercent }}\",\"result\": \"{{ $virustotalResultNum }} / {{ $virustotalResultDen }}\"}}",
  "event": {
    "dataset": "ti_abusech.malware"
  },
  "input": {
    "type": "cel"
  },
  "tags": [
    "preserve_original_event",
    "forwarded",
    "abusech-malware"
  ]
}
