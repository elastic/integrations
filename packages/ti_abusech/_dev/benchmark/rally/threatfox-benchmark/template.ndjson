{{- $timestamp := generate "timestamp" }}
{{- $hostname := generate "host.name" }}
{{- $agentId := generate "agent.id" }}
{{- $id := generate "id" }}
{{- $threatType := generate "threat_type" }}
{{- $threatTypeDesc := generate "threat_type_desc" }}
{{- $iocType := generate "ioc.type" }}
{{- $iocTypeDesc := generate "ioc.type_desc" }}
{{- $iocIp := generate "ioc.ip" }}
{{- $iocIpPort := generate "ioc.ip_port" }}
{{- $iocUrl := generate "ioc.url" }}
{{- $iocDomain := generate "ioc.domain" }}
{{- $iocFile := generate "ioc.file" }}
{{- $confidenceLevel := generate "confidence_level" }}
{{- $duration_start := generate "duration_start" }}
{{- $duration_end := generate "duration_end" }}
{{- $firstSeen := $timestamp | date_modify (print $duration_start) }}
{{- $lastSeen := $timestamp | date_modify (print $duration_end) }}
{
  "@timestamp": "{{ $timestamp.Format "2006-01-02T15:04:05.999999Z07:00" }}",
  "agent": {
    "id": "{{$agentId}}",
    "name": "{{$hostname}}",
    "type": "filebeat",
    "version": "8.8.0",
    "ephemeral_id": "{{$agentId}}"
  },
  "data_stream": {
    "namespace": "ep",
    "type": "logs",
    "dataset": "ti_abusech.threatfox"
  },
  "elastic_agent": {
    "id": "60a22c30-4c80-4e95-b5b1-87ff540d8afd",
    "snapshot": false,
    "version": "8.12.1"
  },
  "message": "{
    \"id\":\"{{$id}}\",
{{- if eq $iocType "ip:port" }}
    \"ioc\":\"{{printf "%s:%s" $iocIp $iocIpPort}}\",
{{- else if eq $iocType "url"}}
    \"ioc\":\"{{$iocUrl}}\",
{{- else if eq $iocType "domain"}}
    \"ioc\":\"{{$iocDomain}}\",
{{- else if eq $iocType "file"}}
    \"ioc\":\"{{$iocFile}}\",
{{- end}}
    \"threat_type\":\"{{$threatType}}\",
    \"threat_type_desc\":\"{{$threatTypeDesc}}\",
    \"ioc_type\":\"{{$iocType}}\",
    \"ioc_type_desc\":\"{{$iocTypeDesc}}\",
    \"malware\":\"win.redline_stealer\",
    \"malware_printable\":\"RedLine Stealer\",
    \"malware_alias\":\"Agentemis,BEACON,CobaltStrike,cobeacon\",
    \"malware_malpedia\":\"https://malpedia.caad.fkie.fraunhofer.de/details/win.redline_stealer\",
    \"confidence_level\":{{$confidenceLevel}},
    \"first_seen\":\"{{$firstSeen.Format "2006-01-02 15:04:05 MST"}}\",
    \"last_seen\":\"{{$lastSeen.Format "2006-01-02 15:04:05 MST"}}\",
    \"reference\":\"https://intelinsights.substack.com/p/cobalt-on-the-weekends\",
    \"reporter\":\"abuse_ch\",
    \"tags\":[\"RedLineStealer\",\"CobaltStrike\",\"drb-ra\"]
  }",
  "event": {
    "dataset": "ti_abusech.threatfox"
  },
  "input": {
    "type": "cel"
  },
  "tags": [
    "preserve_original_event",
    "forwarded",
    "abusech-threatfox"
  ]
}
