{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Correlates Okta credential attack alerts with subsequent successful authentication for the same user account, identifying potential compromise following brute force, password spray, or credential stuffing attempts.",
        "false_positives": [
            "A user experiencing legitimate login issues (forgotten password, typos) may trigger credential attack alerts before successfully authenticating.",
            "Automated password reset flows where a user fails multiple times then succeeds after resetting their password."
        ],
        "from": "now-6h",
        "interval": "30m",
        "language": "esql",
        "license": "Elastic License v2",
        "name": "Okta Successful Login After Credential Attack",
        "note": "## Triage and analysis\n\n### Investigating Okta Successful Login After Credential Attack\n\nThis rule correlates credential attack alerts with subsequent successful authentication for the same user account. The correlation is user-centric, capturing IP rotation scenarios where attackers may login from a different IP after obtaining credentials.\n\n#### Possible investigation steps\n- Identify the user account and review the timeline between the attack and successful login.\n- Compare the attack source IPs versus the login source IP to identify potential IP rotation.\n- Review the original credential attack alert to understand the scope and nature of the attack.\n- Check the authentication method used and whether MFA was required and satisfied.\n- Review the session activity following the successful login for signs of account takeover.\n- Verify with the user if the login was legitimate.\n\n### False positive analysis\n- Users experiencing legitimate login issues may trigger attack alerts before successfully authenticating.\n- Automated password reset flows where a user fails multiple times then succeeds after resetting may trigger this rule.\n- The rule correlates on user identity only, so it fires when a user is targeted and later logs in, even if from different IPs.\n\n### Response and remediation\n- If compromise is suspected, reset the user's password and revoke all active sessions.\n- Reset MFA if the attacker may have enrolled their own device.\n- Block the source IP at the network perimeter.\n- Review the user's recent activity for signs of lateral movement or data access.\n- Check for persistence mechanisms such as new OAuth apps, API tokens, or enrolled devices.\n",
        "query": "FROM .alerts-security.*, logs-okta.system-* METADATA _id, _version, _index\n// Filter for credential attack alerts OR successful Okta authentications\n| WHERE\n    (\n        // Credential attack alerts from the five correlated rules\n        kibana.alert.rule.rule_id IN (\n            \"94e734c0-2cda-11ef-84e1-f661ea17fbce\",  // Credential Stuffing\n            \"42bf698b-4738-445b-8231-c834ddefd8a0\",  // Password Spraying\n            \"23f18264-2d6d-11ef-9413-f661ea17fbce\",  // DT Brute Force\n            \"5889760c-9858-4b4b-879c-e299df493295\",  // Distributed Brute Force\n            \"2d3c27d5-d133-4152-8102-8d051619ec4a\"   // Distributed Spray\n        )\n    )\n    OR (\n        // Successful Okta authentication events\n        event.dataset == \"okta.system\"\n        AND (event.action LIKE \"user.authentication.*\" OR event.action == \"user.session.start\")\n        AND okta.outcome.result == \"SUCCESS\"\n        AND okta.actor.alternate_id IS NOT NULL\n    )\n// correlation - alerts may store user/IP in different fields than raw logs\n| EVAL\n    Esql.user = COALESCE(okta.actor.alternate_id, user.name, user.email),\n    Esql.source_ip = COALESCE(okta.client.ip, client.ip, source.ip)\n// Must have user identity to correlate\n| WHERE Esql.user IS NOT NULL\n// Classify events and capture timestamps/IPs by event type\n| EVAL\n    Esql.is_attack_alert = CASE(\n        kibana.alert.rule.rule_id IN (\n            \"94e734c0-2cda-11ef-84e1-f661ea17fbce\",\n            \"42bf698b-4738-445b-8231-c834ddefd8a0\",\n            \"23f18264-2d6d-11ef-9413-f661ea17fbce\",\n            \"5889760c-9858-4b4b-879c-e299df493295\",\n            \"2d3c27d5-d133-4152-8102-8d051619ec4a\"\n        ), 1, 0\n    ),\n    Esql.is_success_login = CASE(\n        event.dataset == \"okta.system\"\n        AND okta.outcome.result == \"SUCCESS\", 1, 0\n    ),\n    Esql.attack_ip = CASE(\n        kibana.alert.rule.rule_id IN (\n            \"94e734c0-2cda-11ef-84e1-f661ea17fbce\",\n            \"42bf698b-4738-445b-8231-c834ddefd8a0\",\n            \"23f18264-2d6d-11ef-9413-f661ea17fbce\",\n            \"5889760c-9858-4b4b-879c-e299df493295\",\n            \"2d3c27d5-d133-4152-8102-8d051619ec4a\"\n        ), Esql.source_ip, null\n    ),\n    Esql.login_ip = CASE(\n        event.dataset == \"okta.system\"\n        AND okta.outcome.result == \"SUCCESS\", Esql.source_ip, null\n    ),\n    Esql.attack_ts = CASE(\n        kibana.alert.rule.rule_id IN (\n            \"94e734c0-2cda-11ef-84e1-f661ea17fbce\",\n            \"42bf698b-4738-445b-8231-c834ddefd8a0\",\n            \"23f18264-2d6d-11ef-9413-f661ea17fbce\",\n            \"5889760c-9858-4b4b-879c-e299df493295\",\n            \"2d3c27d5-d133-4152-8102-8d051619ec4a\"\n        ), @timestamp, null\n    ),\n    Esql.login_ts = CASE(\n        event.dataset == \"okta.system\"\n        AND okta.outcome.result == \"SUCCESS\", @timestamp, null\n    )\n// Aggregate by user (catches IP rotation: spray from IP A, login from IP B)\n| STATS\n    Esql.attack_count = SUM(Esql.is_attack_alert),\n    Esql.login_count = SUM(Esql.is_success_login),\n    Esql.earliest_attack = MIN(Esql.attack_ts),\n    Esql.latest_attack = MAX(Esql.attack_ts),\n    Esql.earliest_login = MIN(Esql.login_ts),\n    Esql.latest_login = MAX(Esql.login_ts),\n    Esql.attack_source_ips = VALUES(Esql.attack_ip),\n    Esql.login_source_ips = VALUES(Esql.login_ip),\n    Esql.all_source_ips = VALUES(Esql.source_ip),\n    Esql.alert_rule_ids = VALUES(kibana.alert.rule.rule_id),\n    Esql.alert_rule_names = VALUES(kibana.alert.rule.name),\n    Esql.event_action_values = VALUES(event.action),\n    Esql.geo_country_values = VALUES(client.geo.country_name),\n    Esql.geo_city_values = VALUES(client.geo.city_name),\n    Esql.source_asn_values = VALUES(source.as.number),\n    Esql.source_asn_org_values = VALUES(source.as.organization.name),\n    Esql.user_agent_values = VALUES(okta.client.user_agent.raw_user_agent),\n    Esql.device_values = VALUES(okta.client.device),\n    Esql.is_proxy_values = VALUES(okta.security_context.is_proxy)\n  BY Esql.user\n// Calculate time gap between latest attack and earliest subsequent login\n| EVAL Esql.attack_to_login_minutes = DATE_DIFF(\"minute\", Esql.latest_attack, Esql.earliest_login)\n// Correlation: attack BEFORE login + success within reasonable window (3 hours)\n| WHERE\n    Esql.attack_count > 0\n    AND Esql.login_count > 0\n    AND Esql.latest_attack < Esql.earliest_login\n    AND Esql.attack_to_login_minutes <= 180\n| SORT Esql.login_count DESC\n| KEEP Esql.*\n",
        "references": [
            "https://support.okta.com/help/s/article/Troubleshooting-Distributed-Brute-Force-andor-Password-Spray-attacks-in-Okta",
            "https://www.okta.com/identity-101/brute-force/",
            "https://developer.okta.com/docs/reference/api/system-log/",
            "https://developer.okta.com/docs/reference/api/event-types/",
            "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
            "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
            "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "related_integrations": [
            {
                "package": "okta",
                "version": "^3.0.0"
            }
        ],
        "required_fields": [
            {
                "ecs": false,
                "name": "Esql.alert_rule_ids",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.alert_rule_names",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.all_source_ips",
                "type": "ip"
            },
            {
                "ecs": false,
                "name": "Esql.attack_count",
                "type": "long"
            },
            {
                "ecs": false,
                "name": "Esql.attack_source_ips",
                "type": "ip"
            },
            {
                "ecs": false,
                "name": "Esql.attack_to_login_minutes",
                "type": "integer"
            },
            {
                "ecs": false,
                "name": "Esql.device_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.earliest_attack",
                "type": "date"
            },
            {
                "ecs": false,
                "name": "Esql.earliest_login",
                "type": "date"
            },
            {
                "ecs": false,
                "name": "Esql.event_action_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.geo_city_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.geo_country_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.is_proxy_values",
                "type": "boolean"
            },
            {
                "ecs": false,
                "name": "Esql.latest_attack",
                "type": "date"
            },
            {
                "ecs": false,
                "name": "Esql.latest_login",
                "type": "date"
            },
            {
                "ecs": false,
                "name": "Esql.login_count",
                "type": "long"
            },
            {
                "ecs": false,
                "name": "Esql.login_source_ips",
                "type": "ip"
            },
            {
                "ecs": false,
                "name": "Esql.source_asn_org_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.source_asn_values",
                "type": "long"
            },
            {
                "ecs": false,
                "name": "Esql.user",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.user_agent_values",
                "type": "keyword"
            }
        ],
        "risk_score": 73,
        "rule_id": "50742e15-c5ef-49c8-9a2d-31221d45af58",
        "setup": "## Setup\n\nThis rule requires the following:\n1. The Okta Fleet integration, Filebeat module, or similarly structured data for Okta System Logs.\n2. The correlated credential attack detection rules must be enabled (at least one):\n   - Potential Okta Credential Stuffing (Single Source) (94e734c0-2cda-11ef-84e1-f661ea17fbce)\n   - Potential Okta Password Spray (Single Source) (42bf698b-4738-445b-8231-c834ddefd8a0)\n   - Potential Okta Brute Force (Device Token Rotation) (23f18264-2d6d-11ef-9413-f661ea17fbce)\n   - Potential Okta Brute Force (Multi-Source) (5889760c-9858-4b4b-879c-e299df493295)\n   - Potential Okta Password Spray (Multi-Source) (2d3c27d5-d133-4152-8102-8d051619ec4a)\n3. Alerts from these rules must be written to the `.alerts-security.*` indices.\n\nThe rule queries both alert indices and Okta log indices to correlate attack alerts with successful logins.",
        "severity": "high",
        "tags": [
            "Domain: Identity",
            "Use Case: Identity and Access Audit",
            "Use Case: Threat Detection",
            "Data Source: Okta",
            "Data Source: Okta System Logs",
            "Tactic: Credential Access",
            "Tactic: Initial Access",
            "Resources: Investigation Guide",
            "Rule Type: Higher-Order Rule"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0006",
                    "name": "Credential Access",
                    "reference": "https://attack.mitre.org/tactics/TA0006/"
                },
                "technique": [
                    {
                        "id": "T1110",
                        "name": "Brute Force",
                        "reference": "https://attack.mitre.org/techniques/T1110/",
                        "subtechnique": [
                            {
                                "id": "T1110.001",
                                "name": "Password Guessing",
                                "reference": "https://attack.mitre.org/techniques/T1110/001/"
                            },
                            {
                                "id": "T1110.003",
                                "name": "Password Spraying",
                                "reference": "https://attack.mitre.org/techniques/T1110/003/"
                            },
                            {
                                "id": "T1110.004",
                                "name": "Credential Stuffing",
                                "reference": "https://attack.mitre.org/techniques/T1110/004/"
                            }
                        ]
                    }
                ]
            },
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0001",
                    "name": "Initial Access",
                    "reference": "https://attack.mitre.org/tactics/TA0001/"
                },
                "technique": [
                    {
                        "id": "T1078",
                        "name": "Valid Accounts",
                        "reference": "https://attack.mitre.org/techniques/T1078/",
                        "subtechnique": [
                            {
                                "id": "T1078.004",
                                "name": "Cloud Accounts",
                                "reference": "https://attack.mitre.org/techniques/T1078/004/"
                            }
                        ]
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "esql",
        "version": 1
    },
    "id": "50742e15-c5ef-49c8-9a2d-31221d45af58_1",
    "type": "security-rule"
}