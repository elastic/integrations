{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Detects the creation of a new AWS IAM Roles Anywhere profile. Roles Anywhere allows workloads or external systems to assume IAM roles from outside AWS by authenticating via trusted certificate authorities (trust anchors). Adversaries who have established persistence through a rogue trust anchor may create or modify profiles to link them with highly privileged roles, enabling long-term external access to the AWS environment. This rule identifies successful \"CreateProfile\" API calls and helps detect potentially unauthorized or risky external access configurations.",
        "false_positives": [
            "AWS Roles Anywhere profiles are legitimate profiles that can be created by administrators to allow access from any location. Ensure that the profile created is expected and that the trust policy is configured securely."
        ],
        "from": "now-6m",
        "index": [
            "filebeat-*",
            "logs-aws.cloudtrail-*"
        ],
        "investigation_fields": {
            "field_names": [
                "@timestamp",
                "user.name",
                "user_agent.original",
                "source.ip",
                "aws.cloudtrail.user_identity.arn",
                "aws.cloudtrail.user_identity.type",
                "aws.cloudtrail.user_identity.access_key_id",
                "event.action",
                "event.outcome",
                "cloud.account.id",
                "cloud.region",
                "aws.cloudtrail.request_parameters",
                "aws.cloudtrail.response_elements"
            ]
        },
        "language": "kuery",
        "license": "Elastic License v2",
        "name": "AWS IAM Roles Anywhere Profile Creation",
        "note": "## Triage and analysis\n\n> **Disclaimer**:\n> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. \n> While every effort has been made to ensure its quality, validate and adapt it to suit your operational needs.\n\n### Investigating AWS IAM Roles Anywhere Profile Creation\n\nAWS IAM Roles Anywhere allows external workloads \u2014 such as CI/CD runners, on-premises systems, or third-party services \u2014 \nto assume IAM roles securely by presenting a certificate from a trusted anchor. A profile defines the IAM roles that \ncan be assumed, the trust anchor they are associated with, and session duration limits.\n\nThis rule detects when a new Roles Anywhere profile is created using the `CreateProfile` API call. Unauthorized profile \ncreation can enable persistent external access if tied to over-privileged roles or to trust anchors associated with \nunauthorized certificate authorities (CAs). Monitoring profile creation is crucial to ensuring that only approved roles \nand anchors are in use.\n\n#### Possible investigation steps\n\n- **Identify the actor**\n  - Review `aws.cloudtrail.user_identity.arn` and `aws.cloudtrail.user_identity.access_key_id` to determine \n    which IAM user, role, or principal created the profile.\n  - Check whether this identity normally manages Roles Anywhere configurations.\n\n- **Review profile configuration**\n  - Inspect `aws.cloudtrail.request_parameters` for key values such as:\n    - `profileName`\n    - `roleArns` \u2013 confirm that the listed IAM roles are expected and not overly permissive.\n    - `trustAnchorArn` \u2013 verify the trust anchor is valid and authorized.\n    - `durationSeconds` \u2013 check for unusually long session durations.\n  - Determine if multiple roles were attached, which may indicate excessive privilege aggregation.\n\n- **Correlate related activity**\n  - Check for prior or concurrent events by the same actor, including:\n    - `CreateTrustAnchor` with external or unauthorized certificate authorities.\n    - `CreateRole`, `PutRolePolicy`, or `AttachRolePolicy` for privilege escalation paths.\n  - Review whether subsequent `AssumeRoleWithCertificate` events occurred, indicating use of the new profile.\n\n- **Assess the source context**\n  - Investigate `source.ip`, `user_agent.original`, and `source.geo` fields to identify if this request originated from an unfamiliar host, region, or automation client (e.g., `boto3`, `curl`, custom SDKs).\n  - Compare to baseline patterns of legitimate IAM or infrastructure automation.\n\n- **Validate legitimacy**\n  - Contact the responsible team (e.g., platform, PKI, or IAM administration) to confirm whether this profile creation \n    aligns with approved change management or onboarding activities.\n\n\n### False positive analysis:\n\n- **Legitimate administrative actions**\n  - IAM or PKI engineers may legitimately create profiles during setup of new external integrations or workloads. \n    Validate against change control records and deployment logs.\n- **Authorized automation**\n  - Infrastructure-as-code (IaC) pipelines (Terraform, CloudFormation, etc.) may automatically create profiles. \n    Confirm these operations are sourced from known automation accounts or IP ranges.\n- **Development and testing**\n  - Lab or sandbox accounts may test Roles Anywhere configurations with less restrictive controls. \n    Ensure alerts from non-production accounts are tuned accordingly.\n\n### Response and remediation:\n\n- **Immediate review and containment**\n  - If unauthorized, disable or delete the created profile (`aws rolesanywhere delete-profile`) and review all \n    associated IAM roles for misuse.\n  - Rotate any credentials or revoke certificates issued from unapproved trust anchors.\n\n- **Investigation**\n  - Search CloudTrail for additional related actions by the same identity, such as \n    `CreateTrustAnchor`, `AssumeRoleWithCertificate`, or cross-account access attempts.\n  - Verify whether any sessions have been initiated using the new profile and identify \n    which roles were assumed.\n\n- **Recovery and hardening**\n  - Restrict `rolesanywhere:CreateProfile` to a small set of administrative roles.\n  - Implement AWS Config or Security Hub controls to alert on unauthorized or overly \n    permissive Roles Anywhere profiles.\n  - Audit IAM role trust policies linked to external anchors and ensure adherence to the \n    principle of least privilege.\n  - Review and document all approved Roles Anywhere profiles and their corresponding trust anchors.\n\n### Additional information\n\n- **[AWS IR Playbooks](https://github.com/aws-samples/aws-incident-response-playbooks/blob/c151b0dc091755fffd4d662a8f29e2f6794da52c/playbooks/)** \n- **[AWS Customer Playbook Framework](https://github.com/aws-samples/aws-customer-playbook-framework/tree/a8c7b313636b406a375952ac00b2d68e89a991f2/docs)** \n- **Security Best Practices:** [AWS Knowledge Center \u2013 Security Best Practices](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/).\n",
        "query": "event.dataset: aws.cloudtrail\n    and event.provider: rolesanywhere.amazonaws.com\n    and event.action: CreateProfile\n    and event.outcome: success\n",
        "references": [
            "https://docs.aws.amazon.com/rolesanywhere/latest/userguide/introduction.html",
            "https://docs.datadoghq.com/security/default_rules/cloudtrail-aws-iam-roles-anywhere-trust-anchor-created/",
            "https://ermetic.com/blog/aws/keep-your-iam-users-close-keep-your-third-parties-even-closer-part-1/",
            "https://docs.aws.amazon.com/rolesanywhere/latest/APIReference/API_CreateProfile.html"
        ],
        "related_integrations": [
            {
                "integration": "cloudtrail",
                "package": "aws",
                "version": "^4.0.0"
            }
        ],
        "required_fields": [
            {
                "ecs": true,
                "name": "event.action",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.dataset",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.outcome",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.provider",
                "type": "keyword"
            }
        ],
        "risk_score": 21,
        "rule_id": "1d4ca9c0-ff1e-11ee-91cc-f661ea17fbce",
        "severity": "low",
        "tags": [
            "Domain: Cloud",
            "Data Source: AWS",
            "Data Source: Amazon Web Services",
            "Data Source: AWS IAM",
            "Use Case: Identity and Access Audit",
            "Tactic: Persistence",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0003",
                    "name": "Persistence",
                    "reference": "https://attack.mitre.org/tactics/TA0003/"
                },
                "technique": [
                    {
                        "id": "T1098",
                        "name": "Account Manipulation",
                        "reference": "https://attack.mitre.org/techniques/T1098/",
                        "subtechnique": [
                            {
                                "id": "T1098.003",
                                "name": "Additional Cloud Roles",
                                "reference": "https://attack.mitre.org/techniques/T1098/003/"
                            }
                        ]
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "query",
        "version": 6
    },
    "id": "1d4ca9c0-ff1e-11ee-91cc-f661ea17fbce_6",
    "type": "security-rule"
}