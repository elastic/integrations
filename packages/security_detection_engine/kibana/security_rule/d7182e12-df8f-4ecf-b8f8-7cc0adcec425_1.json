{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Detects when an unusual parent process like Node.js, Python, or osascript executes the pbpaste binary to access clipboard data. This technique has been used by malware like OtterCookie to steal passwords and seed phrases from the clipboard.",
        "from": "now-9m",
        "index": [
            "logs-endpoint.events.process-*"
        ],
        "language": "eql",
        "license": "Elastic License v2",
        "name": "Pbpaste Execution via Unusual Parent Process",
        "note": "## Triage and analysis\n\n> **Disclaimer**:\n> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.\n\n### Investigating Pbpaste Execution via Unusual Parent Process\n\nThe pbpaste utility on macOS retrieves data from the system clipboard, making it a target for malware seeking to steal sensitive information such as passwords, cryptocurrency seed phrases, or authentication tokens. Threat actors, particularly those behind campaigns like OtterCookie, leverage scripting interpreters such as Node.js, Python, or osascript to programmatically access clipboard contents. This detection rule identifies suspicious process chains where these interpreters spawn pbpaste, indicating potential credential theft or data harvesting activity.\n\n### Possible investigation steps\n\n- Review the process.parent.name and process.parent.executable fields to identify which scripting interpreter spawned pbpaste and determine if this is expected behavior for the user or application context.\n- Examine the process.parent.command_line field to understand what script or command initiated the clipboard access and assess whether it appears malicious or legitimate.\n- Check for any network connections made by the parent process around the same time by correlating with network events, as clipboard data is often exfiltrated shortly after collection.\n- Investigate the user account associated with the activity using the user.name field to determine if the behavior aligns with their typical work patterns.\n- Review the process.parent.code_signature fields to verify whether the parent application is signed and trusted, as unsigned or untrusted interpreters are more suspicious.\n- Search for related alerts or events on the same host within a short time window to identify if this is part of a larger attack chain.\n\n### False positive analysis\n\n- Legitimate automation tools and productivity applications may use pbpaste for clipboard operations as part of normal workflows. Verify the parent application and its purpose before escalating.\n- Development and testing environments may trigger this detection when developers test clipboard functionality. Consider adding exclusions for known development tools after verification.\n- Some password managers or clipboard utilities may spawn pbpaste for legitimate purposes. Document these applications and create targeted exceptions if confirmed safe.\n- System administration scripts that manage clipboard data should be reviewed and allowlisted if they are part of approved IT operations.\n\n### Response and remediation\n\n- Immediately isolate the affected macOS device from the network to prevent potential data exfiltration if malicious activity is confirmed.\n- Terminate the suspicious parent process and any child processes to stop ongoing clipboard harvesting activity.\n- Conduct a forensic review of the clipboard history if available, and identify what sensitive data may have been exposed.\n- Reset any credentials, API keys, or tokens that may have been present in the clipboard during the timeframe of the alert.\n- Perform a full malware scan on the affected system using endpoint security tools to identify additional indicators of compromise.\n- Review the origin of the parent script or application to understand the initial access vector and prevent reinfection.\n- Escalate to the security operations team if the activity appears to be part of a coordinated campaign affecting multiple endpoints.\n",
        "query": "process where host.os.type == \"macos\" and event.type == \"start\" and event.action == \"exec\" and\n  process.name == \"pbpaste\" and process.args_count == 1 and\n  (process.parent.name in (\"node\", \"osascript\") or process.parent.name like \"python*\") and\n  not process.parent.executable like \"/Users/*/.pyenv/versions/*/bin/python3*\"\n",
        "references": [
            "https://jp.security.ntt/tech_blog/contagious-interview-ottercookie"
        ],
        "related_integrations": [
            {
                "package": "endpoint",
                "version": "^9.0.0"
            }
        ],
        "required_fields": [
            {
                "ecs": true,
                "name": "event.action",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.type",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "host.os.type",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.args_count",
                "type": "long"
            },
            {
                "ecs": true,
                "name": "process.name",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.parent.executable",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.parent.name",
                "type": "keyword"
            }
        ],
        "risk_score": 73,
        "rule_id": "d7182e12-df8f-4ecf-b8f8-7cc0adcec425",
        "severity": "high",
        "tags": [
            "Domain: Endpoint",
            "OS: macOS",
            "Use Case: Threat Detection",
            "Tactic: Collection",
            "Data Source: Elastic Defend",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0009",
                    "name": "Collection",
                    "reference": "https://attack.mitre.org/tactics/TA0009/"
                },
                "technique": [
                    {
                        "id": "T1115",
                        "name": "Clipboard Data",
                        "reference": "https://attack.mitre.org/techniques/T1115/"
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "eql",
        "version": 1
    },
    "id": "d7182e12-df8f-4ecf-b8f8-7cc0adcec425_1",
    "type": "security-rule"
}