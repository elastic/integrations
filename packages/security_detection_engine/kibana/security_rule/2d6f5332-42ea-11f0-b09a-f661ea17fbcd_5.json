{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Identifies a high count of failed Microsoft Entra ID sign-in attempts as the result of the target user account being locked out. Adversaries may attempt to brute-force user accounts by repeatedly trying to authenticate with incorrect credentials, leading to account lockouts by Entra ID Smart Lockout policies.",
        "false_positives": [
            "Automated processes that attempt to authenticate using expired credentials or have misconfigured authentication settings may lead to false positives."
        ],
        "from": "now-60m",
        "index": [
            "filebeat-*",
            "logs-azure.signinlogs-*"
        ],
        "interval": "30m",
        "language": "kuery",
        "license": "Elastic License v2",
        "name": "Microsoft Entra ID Excessive Account Lockouts Detected",
        "note": "## Triage and analysis\n\n### Investigating Microsoft Entra ID Excessive Account Lockouts Detected\n\nThis rule detects a high number of sign-in failures due to account lockouts (error code `50053`) in Microsoft Entra ID sign-in logs. These lockouts are typically caused by repeated authentication failures, often as a result of brute-force tactics such as password spraying, credential stuffing, or automated guessing. This detection is time-bucketed and aggregates attempts to identify bursts or coordinated campaigns targeting multiple users.\n\n### Possible investigation steps\n\nPlease note this is as threshold rule that aggregates multiple account lockouts over a specified time window. To properly investigate, pivot into the individual sign-in log events that contributed to the threshold being met.\n\n- Review users impacted by pivoting searching for `user.name` in events where `azure.signinlogs.properties.status.error_code` is `50053`.\n- Analyze source addresses associated with these lockouts. Identify whether the activity originated from known malicious infrastructure (e.g., VPNs, botnets, or public cloud providers).\n- Inspect the user-agents involved in these account lockouts. Clients like `Python Requests` indicate scripted automation rather than legitimate login attempts. ROPC agents may suggest brute-forcing against legacy auth.\n- A high ratio suggests distributed attacks across multiple accounts, characteristic of password spraying.\n- Correlate client apps associated such as PowerShell or unattended sign-in clients may be targeted for automation or legacy auth bypass.\n- Review conditional access state or risk state of the user involved. If Conditional Access was not applied and risk was not flagged, policy scope or coverage should be reviewed.\n- Check for any successful sign-ins for the affected users around the same time frame to determine if any accounts were compromised prior to lockout.\n\n### False positive analysis\n\n- Misconfigured clients, scripts, or services with outdated credentials may inadvertently cause lockouts.\n- Repeated lockouts from known internal IPs or during credential rotation windows could be benign.\n- Legacy applications without modern auth support may repeatedly fail and trigger Smart Lockout.\n- Specific known user agents (e.g., corporate service accounts).\n- Internal IPs or cloud-hosted automation with expected failure behavior.\n\n### Response and remediation\n\n- Investigate locked accounts immediately. Confirm if the account was successfully accessed prior to lockout.\n- Reset credentials for impacted users and enforce MFA before re-enabling accounts.\n- Block malicious IPs or ASN at the firewall, identity provider, or Conditional Access level.\n- Audit authentication methods in use, and enforce modern auth (OAuth, SAML) over legacy protocols.\n- Strengthen Conditional Access policies to reduce exposure from weak locations, apps, or clients.\n- Conduct credential hygiene audits to assess reuse and rotation for targeted accounts.\n- If false positives are identified, create exceptions for known benign sources, users or user agents to reduce noise.\n",
        "query": "event.dataset: \"azure.signinlogs\" and event.category: \"authentication\"\n    and azure.signinlogs.category: (\"NonInteractiveUserSignInLogs\" or \"SignInLogs\")\n    and event.outcome: \"failure\"\n    and azure.signinlogs.properties.authentication_requirement: \"singleFactorAuthentication\"\n    and azure.signinlogs.properties.status.error_code: 50053\n    and azure.signinlogs.properties.user_principal_name: (* and not \"\")\n    and not source.as.organization.name: \"MICROSOFT-CORP-MSN-as-BLOCK\"\n",
        "references": [
            "https://www.microsoft.com/en-us/security/blog/2025/05/27/new-russia-affiliated-actor-void-blizzard-targets-critical-sectors-for-espionage/",
            "https://cloud.hacktricks.xyz/pentesting-cloud/azure-security/az-unauthenticated-enum-and-initial-entry/az-password-spraying",
            "https://learn.microsoft.com/en-us/security/operations/incident-response-playbook-password-spray",
            "https://www.sprocketsecurity.com/blog/exploring-modern-password-spraying",
            "https://learn.microsoft.com/en-us/purview/audit-log-detailed-properties",
            "https://learn.microsoft.com/en-us/entra/identity-platform/reference-error-codes",
            "https://github.com/0xZDH/Omnispray",
            "https://github.com/0xZDH/o365spray"
        ],
        "related_integrations": [
            {
                "package": "azure",
                "version": "^1.22.0"
            }
        ],
        "required_fields": [
            {
                "ecs": false,
                "name": "azure.signinlogs.category",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "azure.signinlogs.properties.authentication_requirement",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "azure.signinlogs.properties.status.error_code",
                "type": "integer"
            },
            {
                "ecs": false,
                "name": "azure.signinlogs.properties.user_principal_name",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.category",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.dataset",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.outcome",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "source.as.organization.name",
                "type": "keyword"
            }
        ],
        "risk_score": 73,
        "rule_id": "2d6f5332-42ea-11f0-b09a-f661ea17fbcd",
        "severity": "high",
        "tags": [
            "Domain: Cloud",
            "Domain: Identity",
            "Data Source: Azure",
            "Data Source: Entra ID",
            "Data Source: Entra ID Sign-in Logs",
            "Use Case: Identity and Access Audit",
            "Use Case: Threat Detection",
            "Tactic: Credential Access",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0006",
                    "name": "Credential Access",
                    "reference": "https://attack.mitre.org/tactics/TA0006/"
                },
                "technique": [
                    {
                        "id": "T1110",
                        "name": "Brute Force",
                        "reference": "https://attack.mitre.org/techniques/T1110/",
                        "subtechnique": [
                            {
                                "id": "T1110.001",
                                "name": "Password Guessing",
                                "reference": "https://attack.mitre.org/techniques/T1110/001/"
                            },
                            {
                                "id": "T1110.003",
                                "name": "Password Spraying",
                                "reference": "https://attack.mitre.org/techniques/T1110/003/"
                            },
                            {
                                "id": "T1110.004",
                                "name": "Credential Stuffing",
                                "reference": "https://attack.mitre.org/techniques/T1110/004/"
                            }
                        ]
                    }
                ]
            }
        ],
        "threshold": {
            "cardinality": [
                {
                    "field": "user.name",
                    "value": 15
                }
            ],
            "field": [],
            "value": 20
        },
        "timestamp_override": "event.ingested",
        "type": "threshold",
        "version": 5
    },
    "id": "2d6f5332-42ea-11f0-b09a-f661ea17fbcd_5",
    "type": "security-rule"
}