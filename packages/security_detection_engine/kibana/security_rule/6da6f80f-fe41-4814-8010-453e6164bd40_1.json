{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Detects the use of curl by a macOS application binary to connect to a raw IP URI and download a second stage payload. Threat actors often utilize a benign looking or legitimate application as a first stage dropper. Curl is commonly used as it doesn't enforce Gatekeeper checks.",
        "from": "now-9m",
        "index": [
            "logs-endpoint.events.process-*"
        ],
        "language": "eql",
        "license": "Elastic License v2",
        "name": "Suspicious Curl from macOS Application",
        "note": "## Triage and analysis\n\n> **Disclaimer**:\n> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.\n\n### Investigating Suspicious Curl from macOS Application\n\nTrojanized macOS applications often use curl to download second-stage payloads from attacker-controlled infrastructure. By leveraging curl instead of direct downloads, these malicious applications can bypass Gatekeeper quarantine checks and evade built-in macOS security mechanisms. This detection rule identifies when applications from the /Applications directory spawn curl to connect to raw IP addresses, which is highly indicative of malicious payload retrieval activity.\n\n### Possible investigation steps\n\n- Review the process.Ext.effective_parent.executable field to identify which application spawned the curl process and assess whether this application is expected to make network downloads.\n- Examine the process.args fields to extract the destination IP address and URL path being accessed, and research these indicators in threat intelligence databases.\n- Analyze the process.parent.command_line to understand the full context of how curl was invoked, including any output file paths that may indicate where payloads were written.\n- Check the code signature of the parent application using the process.code_signature fields to determine if it is validly signed and if the signature matches known good versions.\n- Investigate the origin of the suspicious application by reviewing installation logs, download history, and any recent DMG or PKG files that may have delivered the trojanized application.\n- Search for any files created on disk around the time of the curl execution to identify downloaded payloads that may have been staged for execution.\n- Correlate with other events on the same host to identify if the downloaded payload was subsequently executed.\n\n### False positive analysis\n\n- Some legitimate applications may use curl for software updates or telemetry data collection. Verify the destination IP against the application vendor's known infrastructure.\n- Development tools and IDEs may download dependencies or packages via curl during normal operations. Review the context and confirm with development teams.\n- Homebrew and package managers may spawn curl from application contexts during installations. Verify if package management activities were expected.\n- Add verified legitimate applications to the exclusion list in the query after confirming their behavior is expected.\n\n### Response and remediation\n\n- Immediately quarantine the suspicious application by moving it to a secure location and removing it from /Applications to prevent further execution.\n- Block the destination IP address at the network perimeter and on endpoint firewalls to prevent additional downloads.\n- Search the file system for any payloads that may have been downloaded and quarantine them for analysis.\n- Conduct a full malware scan on the affected system to identify any persistence mechanisms or additional malware components.\n- Report the trojanized application to Apple Security and relevant threat intelligence sharing platforms.\n- Review other systems in the environment for the same trojanized application to determine the scope of potential compromise.\n- Investigate the delivery mechanism to understand how the trojanized application was installed and prevent future infections.\n",
        "query": "process where host.os.type == \"macos\" and event.type == \"start\" and event.action == \"exec\" and \n  process.name in (\"curl\", \"nscurl\") and \n  process.args in (\"-o\", \"--output\", \"--download\", \"-dl\", \"-dir\", \"--directory\") and\n  process.args regex~ \"\"\"http.*:\\/\\/[0-9]{2,3}.[0-9]{2,3}.[0-9]{2,3}.[0-9]{2,3}\\/.*\"\"\" and \n  process.parent.name like~ (\"bash\", \"sh\", \"zsh\", \"osascript\", \"tclsh*\", \"python*\") and\n  process.Ext.effective_parent.executable like \"/Applications/*\" and\n  process.args_count <= 10 and \n  not process.args like \"/Applications/*\" and\n  not process.Ext.effective_parent.executable in (\"/Applications/iTerm.app/Contents/MacOS/iTerm2\",\n                                                   \"/Applications/Visual Studio Code.app/Contents/MacOS/Electron\", \n                                                   \"/Applications/Warp.app/Contents/MacOS/stable\")\n",
        "references": [
            "https://objective-see.org/blog/blog_0x71.html#-vpn-trojan-covid",
            "https://attack.mitre.org/techniques/T1105/"
        ],
        "related_integrations": [
            {
                "package": "endpoint",
                "version": "^8.2.0"
            }
        ],
        "required_fields": [
            {
                "ecs": true,
                "name": "event.action",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.type",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "host.os.type",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "process.Ext.effective_parent.executable",
                "type": "unknown"
            },
            {
                "ecs": true,
                "name": "process.args",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.args_count",
                "type": "long"
            },
            {
                "ecs": true,
                "name": "process.name",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.parent.name",
                "type": "keyword"
            }
        ],
        "risk_score": 73,
        "rule_id": "6da6f80f-fe41-4814-8010-453e6164bd40",
        "severity": "high",
        "tags": [
            "Domain: Endpoint",
            "OS: macOS",
            "Use Case: Threat Detection",
            "Tactic: Command and Control",
            "Data Source: Elastic Defend",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0011",
                    "name": "Command and Control",
                    "reference": "https://attack.mitre.org/tactics/TA0011/"
                },
                "technique": [
                    {
                        "id": "T1105",
                        "name": "Ingress Tool Transfer",
                        "reference": "https://attack.mitre.org/techniques/T1105/"
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "eql",
        "version": 1
    },
    "id": "6da6f80f-fe41-4814-8010-453e6164bd40_1",
    "type": "security-rule"
}