{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Identifies sign-ins on behalf of a principal user to the Microsoft Graph or legacy Azure AD API from multiple IPs using first-party Microsoft applications from the FOCI (Family of Client IDs) group. Developer tools like Azure CLI, VSCode, and Azure PowerShell accessing these resources from multiple IPs are flagged, along with any FOCI application accessing the deprecated Windows Azure Active Directory from multiple IPs. This behavior may indicate an adversary using a phished OAuth authorization code or refresh token, as seen in attacks like ConsentFix where attackers steal localhost OAuth codes and replay them from attacker infrastructure.",
        "from": "now-60m",
        "interval": "59m",
        "language": "esql",
        "license": "Elastic License v2",
        "name": "M365 Identity OAuth Flow by First-Party Microsoft App from Multiple IPs",
        "note": "## Triage and analysis\n\n### Investigating M365 Identity OAuth Flow by First-Party Microsoft App from Multiple IPs\n\nThis rule detects when the same user authenticates to Microsoft Graph or legacy Azure AD using FOCI applications from multiple IP addresses within a 30-minute window. This pattern is a strong indicator of OAuth code/token theft attacks like ConsentFix, where the victim completes the OAuth authorize flow on their device (first IP), and the attacker exchanges the stolen authorization code for tokens from their infrastructure (second IP).\n\nThe rule aggregates events by user, application, and resource, requiring both `OAuth2:Authorize` and `OAuth2:Token` requests from at least 2 different IPs to fire - this indicates the code was generated on one IP and exchanged on another.\n\n### Possible investigation steps\n\n- Review `o365.audit.UserId` to identify the affected user and determine if they are a high-value target.\n- Analyze `Esql.source_ip_values` to see all unique IP addresses used within the 30-minute window. Determine whether these originate from different geographic regions, cloud providers (AWS, Azure, GCP), or anonymizing infrastructure (Tor, VPNs).\n- Use `Esql.time_window_date_trunc` to pivot into raw events and reconstruct the full sequence of resource access events with exact timestamps.\n- Check `Esql.source_as_organization_name_values` for unfamiliar ASN organizations that may indicate attacker infrastructure.\n- Review `Esql.o365_audit_ApplicationId_values` to confirm which first-party application was used.\n- Pivot to `azure.auditlogs` to check for device join or registration events around the same timeframe, which may indicate persistence attempts.\n- Correlate with `azure.identityprotection` to identify related risk detections such as anonymized IP access or token replay.\n- Search for additional sign-ins from the IPs involved across other users to determine if this is part of a broader campaign.\n\n### False positive analysis\n\n- Developers or IT administrators working across environments (office, home, cloud VMs) may produce similar behavior.\n- Users on VPN who switch servers or traveling between networks may show multiple IPs.\n- Mobile users moving between cellular and WiFi networks during the time window.\n- Consider correlating with device compliance status to distinguish managed vs. unmanaged access.\n\n### Response and remediation\n\n- If confirmed unauthorized, immediately revoke all refresh tokens for the affected user via Entra ID.\n- Remove any devices registered during this session by checking `azure.auditlogs` for `Add device` events.\n- Notify the user and determine whether they may have shared an OAuth code via phishing.\n- Block the attacker IPs at the perimeter and add to threat intel feeds.\n- Implement Conditional Access policies to restrict OAuth flows for these applications to compliant devices and approved locations.\n- Monitor for follow-on activity like lateral movement, privilege escalation, or data exfiltration via Graph API.\n",
        "query": "from logs-o365.audit-*\n| where\n    event.dataset == \"o365.audit\" and\n    event.action == \"UserLoggedIn\" and\n    source.ip is not null and\n    o365.audit.UserId is not null and\n    o365.audit.ApplicationId is not null and\n    o365.audit.UserType in (\"0\", \"2\", \"3\", \"10\") and\n    (\n        /* Developer tools accessing Graph OR Legacy AAD */\n        (\n            o365.audit.ApplicationId in (\n                \"aebc6443-996d-45c2-90f0-388ff96faa56\",\n                \"29d9ed98-a469-4536-ade2-f981bc1d605e\",\n                \"04b07795-8ddb-461a-bbee-02f9e1bf7b46\",\n                \"1950a258-227b-4e31-a9cf-717495945fc2\"\n            ) and\n            o365.audit.ObjectId in (\n                \"00000003-0000-0000-c000-000000000000\",\n                \"00000002-0000-0000-c000-000000000000\"\n            )\n        ) or\n        /* Any FOCI app accessing Legacy AAD only */\n        (\n            o365.audit.ApplicationId in (\n                \"00b41c95-dab0-4487-9791-b9d2c32c80f2\",\n                \"1fec8e78-bce4-4aaf-ab1b-5451cc387264\",\n                \"26a7ee05-5602-4d76-a7ba-eae8b7b67941\",\n                \"27922004-5251-4030-b22d-91ecd9a37ea4\",\n                \"4813382a-8fa7-425e-ab75-3b753aab3abb\",\n                \"ab9b8c07-8f02-4f72-87fa-80105867a763\",\n                \"d3590ed6-52b3-4102-aeff-aad2292ab01c\",\n                \"872cd9fa-d31f-45e0-9eab-6e460a02d1f1\",\n                \"af124e86-4e96-495a-b70a-90f90ab96707\",\n                \"2d7f3606-b07d-41d1-b9d2-0d0c9296a6e8\",\n                \"844cca35-0656-46ce-b636-13f48b0eecbd\",\n                \"87749df4-7ccf-48f8-aa87-704bad0e0e16\",\n                \"cf36b471-5b44-428c-9ce7-313bf84528de\",\n                \"0ec893e0-5785-4de6-99da-4ed124e5296c\",\n                \"22098786-6e16-43cc-a27d-191a01a1e3b5\",\n                \"4e291c71-d680-4d0e-9640-0a3358e31177\",\n                \"57336123-6e14-4acc-8dcf-287b6088aa28\",\n                \"57fcbcfa-7cee-4eb1-8b25-12d2030b4ee0\",\n                \"66375f6b-983f-4c2c-9701-d680650f588f\",\n                \"9ba1a5c7-f17a-4de9-a1f1-6178c8d51223\",\n                \"a40d7d7d-59aa-447e-a655-679a4107e548\",\n                \"a569458c-7f2b-45cb-bab9-b7dee514d112\",\n                \"b26aadf8-566f-4478-926f-589f601d9c74\",\n                \"c0d2a505-13b8-4ae0-aa9e-cddd5eab0b12\",\n                \"d326c1ce-6cc6-4de2-bebc-4591e5e13ef0\",\n                \"e9c51622-460d-4d3d-952d-966a5b1da34c\",\n                \"eb539595-3fe1-474e-9c1d-feb3625d1be5\",\n                \"ecd6b820-32c2-49b6-98a6-444530e5a77a\",\n                \"f05ff7c9-f75a-4acd-a3b5-f4b6a870245d\",\n                \"f44b1140-bc5e-48c6-8dc0-5cf5a53c0e34\",\n                \"be1918be-3fe3-4be9-b32b-b542fc27f02e\",\n                \"cab96880-db5b-4e15-90a7-f3f1d62ffe39\",\n                \"d7b530a4-7680-4c23-a8bf-c52c121d2e87\",\n                \"dd47d17a-3194-4d86-bfd5-c6ae6f5651e3\",\n                \"e9b154d0-7658-433b-bb25-6b8e0a8a7c59\"\n            ) and\n            o365.audit.ObjectId == \"00000002-0000-0000-c000-000000000000\"\n        )\n    )\n| eval\n    Esql.time_window_date_trunc = date_trunc(30 minutes, @timestamp),\n    Esql.oauth_authorize_user_id_case = case(\n        o365.audit.ExtendedProperties.RequestType == \"OAuth2:Authorize\" and o365.audit.ExtendedProperties.ResultStatusDetail == \"Redirect\",\n        o365.audit.UserId,\n        null\n    ),\n    Esql.oauth_token_user_id_case = case(\n        o365.audit.ExtendedProperties.RequestType == \"OAuth2:Token\",\n        o365.audit.UserId,\n        null\n    )\n| stats\n    Esql.source_ip_count_distinct = count_distinct(source.ip),\n    Esql.source_ip_values = values(source.ip),\n    Esql.o365_audit_ApplicationId_values = values(o365.audit.ApplicationId),\n    Esql.source_as_organization_name_values = values(source.`as`.organization.name),\n    Esql.oauth_token_count_distinct = count_distinct(Esql.oauth_token_user_id_case),\n    Esql.oauth_authorize_count_distinct = count_distinct(Esql.oauth_authorize_user_id_case)\n  by\n    o365.audit.UserId,\n    Esql.time_window_date_trunc,\n    o365.audit.ApplicationId,\n    o365.audit.ObjectId\n| keep\n    Esql.time_window_date_trunc,\n    Esql.source_ip_values,\n    Esql.source_ip_count_distinct,\n    Esql.o365_audit_ApplicationId_values,\n    Esql.source_as_organization_name_values,\n    Esql.oauth_token_count_distinct,\n    Esql.oauth_authorize_count_distinct\n| where\n    Esql.source_ip_count_distinct >= 2 and\n    Esql.oauth_token_count_distinct > 0 and\n    Esql.oauth_authorize_count_distinct > 0\n",
        "references": [
            "https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/",
            "https://github.com/dirkjanm/ROADtools",
            "https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/",
            "https://pushsecurity.com/blog/consentfix",
            "https://github.com/secureworks/family-of-client-ids-research"
        ],
        "related_integrations": [
            {
                "package": "o365",
                "version": "^3.0.0"
            }
        ],
        "required_fields": [
            {
                "ecs": false,
                "name": "Esql.o365_audit_ApplicationId_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.oauth_authorize_count_distinct",
                "type": "long"
            },
            {
                "ecs": false,
                "name": "Esql.oauth_token_count_distinct",
                "type": "long"
            },
            {
                "ecs": false,
                "name": "Esql.source_as_organization_name_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.source_ip_count_distinct",
                "type": "long"
            },
            {
                "ecs": false,
                "name": "Esql.source_ip_values",
                "type": "ip"
            },
            {
                "ecs": false,
                "name": "Esql.time_window_date_trunc",
                "type": "date"
            }
        ],
        "risk_score": 73,
        "rule_id": "36188365-f88f-4f70-8c1d-0b9554186b9c",
        "setup": "## Setup\n\nThe Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n",
        "severity": "high",
        "tags": [
            "Domain: Cloud",
            "Domain: Email",
            "Domain: Identity",
            "Data Source: Microsoft 365",
            "Data Source: Microsoft 365 Audit Logs",
            "Use Case: Identity and Access Audit",
            "Use Case: Threat Detection",
            "Resources: Investigation Guide",
            "Tactic: Defense Evasion"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0005",
                    "name": "Defense Evasion",
                    "reference": "https://attack.mitre.org/tactics/TA0005/"
                },
                "technique": [
                    {
                        "id": "T1550",
                        "name": "Use Alternate Authentication Material",
                        "reference": "https://attack.mitre.org/techniques/T1550/",
                        "subtechnique": [
                            {
                                "id": "T1550.001",
                                "name": "Application Access Token",
                                "reference": "https://attack.mitre.org/techniques/T1550/001/"
                            }
                        ]
                    }
                ]
            },
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0006",
                    "name": "Credential Access",
                    "reference": "https://attack.mitre.org/tactics/TA0006/"
                },
                "technique": [
                    {
                        "id": "T1528",
                        "name": "Steal Application Access Token",
                        "reference": "https://attack.mitre.org/techniques/T1528/"
                    }
                ]
            },
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0001",
                    "name": "Initial Access",
                    "reference": "https://attack.mitre.org/tactics/TA0001/"
                },
                "technique": [
                    {
                        "id": "T1566",
                        "name": "Phishing",
                        "reference": "https://attack.mitre.org/techniques/T1566/",
                        "subtechnique": [
                            {
                                "id": "T1566.002",
                                "name": "Spearphishing Link",
                                "reference": "https://attack.mitre.org/techniques/T1566/002/"
                            }
                        ]
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "esql",
        "version": 6
    },
    "id": "36188365-f88f-4f70-8c1d-0b9554186b9c_6",
    "type": "security-rule"
}