{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Detects the use of process environment variables (DYLD_INSERT_LIBRARIES or LD_PRELOAD) to inject a shared library into a binary at or prior to execution. A threat actor may use this technique to load a malicious shared library for persistence, privilege escalation, and defense evasion. This activity is uncommon and typically indicates malicious behavior.",
        "from": "now-9m",
        "index": [
            "logs-endpoint.events.process-*",
            "logs-endpoint.events.library-*"
        ],
        "language": "eql",
        "license": "Elastic License v2",
        "name": "Dylib Injection via Process Environment Variables",
        "note": "## Triage and analysis\n\n> **Disclaimer**:\n> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.\n\n### Investigating Dylib Injection via Process Environment Variables\n\nDynamic library injection using DYLD_INSERT_LIBRARIES or LD_PRELOAD environment variables is a powerful technique that allows code to be loaded into a process's address space at runtime. While this capability exists for legitimate debugging and development purposes, threat actors abuse it to hook application functionality, steal credentials, intercept keystrokes, or execute malicious code within trusted processes. This detection rule identifies processes started with these injection environment variables set to non-empty values.\n\n### Possible investigation steps\n\n- Review the process.env_vars field to identify the specific dylib being injected via DYLD_INSERT_LIBRARIES or LD_PRELOAD and determine its file path.\n- Locate the injected dylib file on the file system using the path from the environment variable and calculate its hash for threat intelligence lookups.\n- Analyze the process.executable and process.name fields to identify the target application being hijacked and assess whether dylib injection makes sense for its normal operation.\n- Examine the process.parent.executable and process.command_line to understand how the process with injection was launched and trace back to the initial execution vector.\n- Review the code signature of the injected dylib using codesign or similar tools to determine if it is signed, and by whom.\n- Check for file creation events to determine when the malicious dylib was placed on the system and how it was delivered.\n- Correlate with other security events on the same host to identify if the injection is part of a larger attack chain, such as credential theft or keylogging.\n\n### False positive analysis\n\n- Xcode and iOS Simulator use DYLD_INSERT_LIBRARIES for debugging and testing purposes during application development. These paths are already excluded in the query.\n- Security research and reverse engineering tools may use library injection for analysis. Verify with security teams if such activities are expected.\n- Some legitimate applications use library injection for specific functionality. Document these applications and create targeted exceptions after verification.\n- Homebrew and development environments may occasionally use these environment variables. Confirm with development teams before creating exclusions.\n\n### Response and remediation\n\n- Immediately terminate the process using malicious dylib injection to stop any ongoing malicious activity such as credential theft or keylogging.\n- Quarantine the injected dylib file for forensic analysis and malware reverse engineering.\n- Remove the malicious dylib from the system and ensure it cannot be reloaded through persistence mechanisms.\n- Investigate how the dylib was placed on the system and remediate the initial access or delivery mechanism.\n- Review System Integrity Protection (SIP) status on the affected system, as SIP should normally prevent DYLD injection into protected system processes.\n- Scan the system for additional indicators of compromise, persistence mechanisms, or lateral movement.\n- Reset any credentials that may have been exposed through the injection, particularly if the target application handles sensitive authentication data.\n- Escalate to the incident response team for comprehensive analysis if the injection indicates active compromise.\n",
        "query": "sequence by process.entity_id with maxspan=15s\n  [process where host.os.type == \"macos\" and event.type == \"start\" and event.action == \"exec\" and\n    process.env_vars like (\"DYLD_INSERT_LIBRARIES=?*\", \"LD_PRELOAD=?*\") and\n    not process.env_vars like (\"DYLD_INSERT_LIBRARIES=\", \"LD_PRELOAD=\", \"LD_PRELOAD=<null>\") and\n    not process.executable like (\"/Users/*/Library/Developer/Xcode/*\", \"/Users/*/Library/Developer/CoreSimulator/*\") and\n    not process.parent.executable like (\"/usr/bin/xcrun\", \"/Applications/Xcode*.app/*\", \"/Library/Developer/*\")]\n  [library where host.os.type == \"macos\" and event.action == \"load\" and\n    not dll.name like (\"*.aot\", \"*.so\") and\n    not dll.code_signature.trusted == true and\n    not dll.path like (\"/System/*\", \"/usr/lib/*\", \"/opt/homebrew/*\", \"/private/var/folders/*\",\n                       \"/Library/Apple/*\", \"/Library/Developer/*\",\n                       \"/Users/*/Library/Developer/Xcode/*\", \"/Users/*/Library/Developer/CoreSimulator/*\")]\n",
        "references": [
            "https://wojciechregula.blog/post/learn-xpc-exploitation-part-3-code-injections/",
            "https://attack.mitre.org/techniques/T1574/006/"
        ],
        "related_integrations": [
            {
                "package": "endpoint",
                "version": "^8.2.0"
            }
        ],
        "required_fields": [
            {
                "ecs": true,
                "name": "dll.code_signature.trusted",
                "type": "boolean"
            },
            {
                "ecs": true,
                "name": "dll.name",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "dll.path",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.action",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.type",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "host.os.type",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.entity_id",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.env_vars",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.executable",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.parent.executable",
                "type": "keyword"
            }
        ],
        "risk_score": 73,
        "rule_id": "fb8790fc-d485-45e2-8d6e-2fb813f4af95",
        "severity": "high",
        "tags": [
            "Domain: Endpoint",
            "OS: macOS",
            "Use Case: Threat Detection",
            "Tactic: Defense Evasion",
            "Tactic: Persistence",
            "Data Source: Elastic Defend",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0005",
                    "name": "Defense Evasion",
                    "reference": "https://attack.mitre.org/tactics/TA0005/"
                },
                "technique": [
                    {
                        "id": "T1574",
                        "name": "Hijack Execution Flow",
                        "reference": "https://attack.mitre.org/techniques/T1574/",
                        "subtechnique": [
                            {
                                "id": "T1574.006",
                                "name": "Dynamic Linker Hijacking",
                                "reference": "https://attack.mitre.org/techniques/T1574/006/"
                            }
                        ]
                    }
                ]
            },
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0003",
                    "name": "Persistence",
                    "reference": "https://attack.mitre.org/tactics/TA0003/"
                },
                "technique": [
                    {
                        "id": "T1574",
                        "name": "Hijack Execution Flow",
                        "reference": "https://attack.mitre.org/techniques/T1574/",
                        "subtechnique": [
                            {
                                "id": "T1574.006",
                                "name": "Dynamic Linker Hijacking",
                                "reference": "https://attack.mitre.org/techniques/T1574/006/"
                            }
                        ]
                    }
                ]
            }
        ],
        "type": "eql",
        "version": 1
    },
    "id": "fb8790fc-d485-45e2-8d6e-2fb813f4af95_1",
    "type": "security-rule"
}