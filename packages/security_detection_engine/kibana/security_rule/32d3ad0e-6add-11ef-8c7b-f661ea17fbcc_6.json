{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Detects successful Microsoft 365 portal logins from rare locations. Rare locations are defined as locations that are not commonly associated with the user's account. This behavior may indicate an adversary attempting to access a Microsoft 365 account from an unusual location or behind a VPN.",
        "false_positives": [
            "False positives may occur when users are using a VPN or when users are traveling to different locations\"",
            "Mobile access may also result in false positives, as users may log in from various locations while on the go."
        ],
        "from": "now-15m",
        "history_window_start": "now-14d",
        "index": [
            "filebeat-*",
            "logs-o365.audit-*"
        ],
        "investigation_fields": {
            "field_names": [
                "@timestamp",
                "organization.id",
                "o365.audit.UserId",
                "o365.audit.ActorIpAddress",
                "o365.audit.ApplicationId",
                "o365.audit.ExtendedProperties.RequestType",
                "o365.audit.Target.ID",
                "source.geo.region_iso_code"
            ]
        },
        "language": "kuery",
        "license": "Elastic License v2",
        "name": "M365 Portal Login (Atypical Travel)",
        "new_terms_fields": [
            "o365.audit.UserId",
            "source.geo.region_iso_code"
        ],
        "note": "## Triage and analysis\n\n### Investigating M365 Portal Login (Atypical Travel)\n\nMicrosoft 365 is a cloud-based suite offering productivity tools accessible from anywhere, making it crucial for business operations. Adversaries may exploit this by logging in from uncommon locations, potentially using VPNs to mask their origin. The detection rule identifies successful logins from atypical locations, flagging potential unauthorized access attempts by analyzing login events and user location patterns.\n\n### Possible investigation steps\n\n- Review the user associated with these sign-ins to determine if the login attempt was legitimate or if further investigation is needed.\n- Analyze the geographic locations of the logins to identify any patterns or anomalies that may indicate malicious activity.\n- Review the ISP information for the login attempts to identify any unusual or suspicious providers.\n- Review the authorization request type to understand the context of the login attempts and whether they align with the user's typical behavior.\n- Analyze the client application used for the login attempts to determine if it is consistent with the user's normal usage patterns (Teams, Office, etc.)\n- Analyze the user-agent associated with the login attempts to identify any unusual or suspicious patterns.\n\n### False positive analysis\n\n- Users traveling or using VPNs may trigger this alert. Verify with the user if they were traveling or using a VPN at the time of the login attempt.\n- Mobile access may also result in false positives, as users may log in from various locations while on the go.\n\n### Response and remediation\n\n- Investigate the login attempt further by checking for any additional context or related events that may provide insight into the user's behavior.\n- If the login attempt is deemed suspicious, consider implementing additional security measures, such as requiring multi-factor authentication (MFA) for logins from unusual locations.\n- Educate users about the risks of accessing corporate resources from unfamiliar locations and the importance of using secure connections (e.g., VPNs) when doing so.\n- Monitor for any subsequent login attempts from the same location or IP address to identify potential patterns of malicious activity.\n",
        "query": "event.dataset:o365.audit and\n    event.provider:AzureActiveDirectory and\n    event.action:UserLoggedIn and\n    event.outcome:success and\n    o365.audit.Target.Type:(0 or 10 or 2 or 3 or 5 or 6) and\n    o365.audit.UserId:(* and not \"Not Available\") and\n    source.geo.region_iso_code:* and\n    o365.audit.Target.ID:(\n        00000006-0000-0ff1-ce00-000000000000 or\n        4765445b-32c6-49b0-83e6-1d93765276ca\n    ) and not o365.audit.ApplicationId:(\n        29d9ed98-a469-4536-ade2-f981bc1d605e or\n        38aa3b87-a06d-4817-b275-7a316988d93b or\n        a809996b-059e-42e2-9866-db24b99a9782\n    ) and not o365.audit.ExtendedProperties.RequestType:(\n        \"Cmsi:Cmsi\" or\n        \"Consent:Set\" or\n        \"Login:reprocess\" or\n        \"Login:resume\" or\n        \"MessagePrompt:MessagePrompt\" or\n        \"SAS:EndAuth\"\n    )\n",
        "references": [
            "https://www.huntress.com/blog/time-travelers-busted-how-to-detect-impossible-travel-"
        ],
        "related_integrations": [
            {
                "package": "o365",
                "version": "^2.0.0"
            }
        ],
        "required_fields": [
            {
                "ecs": true,
                "name": "event.action",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.dataset",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.outcome",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.provider",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "o365.audit.ApplicationId",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "o365.audit.ExtendedProperties.RequestType",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "o365.audit.Target.ID",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "o365.audit.Target.Type",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "o365.audit.UserId",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "source.geo.region_iso_code",
                "type": "keyword"
            }
        ],
        "risk_score": 47,
        "rule_id": "32d3ad0e-6add-11ef-8c7b-f661ea17fbcc",
        "severity": "medium",
        "tags": [
            "Domain: Cloud",
            "Domain: SaaS",
            "Data Source: Microsoft 365",
            "Data Source: Microsoft 365 Audit Logs",
            "Use Case: Threat Detection",
            "Use Case: Identity and Access Audit",
            "Tactic: Initial Access",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0001",
                    "name": "Initial Access",
                    "reference": "https://attack.mitre.org/tactics/TA0001/"
                },
                "technique": [
                    {
                        "id": "T1078",
                        "name": "Valid Accounts",
                        "reference": "https://attack.mitre.org/techniques/T1078/",
                        "subtechnique": [
                            {
                                "id": "T1078.004",
                                "name": "Cloud Accounts",
                                "reference": "https://attack.mitre.org/techniques/T1078/004/"
                            }
                        ]
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "new_terms",
        "version": 6
    },
    "id": "32d3ad0e-6add-11ef-8c7b-f661ea17fbcc_6",
    "type": "security-rule"
}