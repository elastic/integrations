{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Identifies the creation of a launch agent or daemon property list file containing abnormal or suspicious values. An adversary may establish persistence by installing a new launch agent or daemon which executes at login. This rule looks for plist files created in LaunchAgents/LaunchDaemons directories with paths commonly used by malware.",
        "from": "now-9m",
        "index": [
            "logs-endpoint.events.file-*"
        ],
        "language": "eql",
        "license": "Elastic License v2",
        "name": "Persistence via Suspicious Launch Agent or Launch Daemon",
        "note": "## Triage and analysis\n\n> **Disclaimer**:\n> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.\n\n### Investigating Persistence via Suspicious Launch Agent or Launch Daemon\n\nLaunchAgents and LaunchDaemons are the standard macOS mechanisms for starting programs automatically at user login or system boot. While essential for legitimate software, these persistence mechanisms are heavily abused by malware including RustBucket (DPRK), Shlayer, and CloudMensis. This detection rule identifies plist file creation in LaunchAgent/LaunchDaemon directories when performed by suspicious processes including scripts executing from temporary directories, unsigned binaries, or scripting interpreters like Python and osascript.\n\n### Possible investigation steps\n\n- Examine the file.path to identify the specific plist file created and its location (user vs system LaunchAgent/LaunchDaemon directory).\n- Read the plist contents using plutil or defaults to identify the Program or ProgramArguments configured for execution.\n- Analyze the process.executable to understand what created the plist file and assess whether execution from that location (temp directory, hidden folder) is suspicious.\n- Check the process.name and process.code_signature fields to determine if the creating process was a scripting interpreter or unsigned binary.\n- Locate the binary or script referenced in the plist and calculate its hash for threat intelligence lookups.\n- Review the parent process chain to trace back to the initial execution vector that led to plist creation.\n- Correlate with other file and process events to identify additional malware components that may have been deployed simultaneously.\n\n### False positive analysis\n\n- Legitimate software installers may create LaunchAgents/LaunchDaemons during setup, but typically from signed installer processes rather than scripts in temp directories.\n- Development and testing environments may use scripting languages to create launch items. Verify with development teams if such activities are expected.\n- Several legitimate signing IDs are already excluded including vim, JetBrains Toolbox, and Sublime Text.\n- System utilities like cfprefsd may modify plist files during normal operations and are excluded.\n- Enterprise deployment tools may use scripts to configure launch items. Document and exclude approved deployment processes.\n\n### Response and remediation\n\n- Immediately unload the suspicious LaunchAgent or LaunchDaemon using launchctl unload with the plist path.\n- Remove the malicious plist file from the LaunchAgent or LaunchDaemon directory.\n- Locate and remove the executable or script referenced in the plist's Program or ProgramArguments keys.\n- Check for other persistence mechanisms that may have been deployed by the same threat actor.\n- Review system logs for evidence of the persistence mechanism executing and what actions it performed.\n- If the detection matches patterns of known malware families (RustBucket, Shlayer), perform comprehensive IOC searches and threat hunting.\n- Reset any credentials that may have been accessed while the malicious process was running.\n- Monitor for recreation of similar plist files to detect persistent access or ongoing compromise.\n",
        "query": "file where host.os.type == \"macos\" and event.type != \"deletion\" and \n  file.extension == \"plist\" and\n  file.path like (\"/Library/LaunchAgents/*\", \"/Library/LaunchDaemons/*\", \n                  \"/Users/*/Library/LaunchAgents/*\", \"/System/Library/LaunchAgents/*\",\n                  \"/System/Library/LaunchDaemons/*\") and\n  (process.executable like (\"/private/tmp/*\", \"/private/var/root/Library/*\", \"/var/tmp/*\", \n                            \"/tmp/*\", \"/var/folders/*\", \"/Users/Shared/*\", \"/var/root/*\",\n                            \"/Library/WebServer/*\", \"/Library/Graphics/*\", \"/Library/Fonts/*\") or\n   process.name like~ (\"python*\", \"osascript\", \"bash\", \"zsh\", \"sh\", \"curl\", \"nscurl\", \"wget\", \"java\")) and\n  not process.executable like (\"/System/*\", \"/Library/PrivilegedHelperTools/*\") and\n  not (process.code_signature.signing_id in (\"com.apple.vim\", \"com.apple.cat\", \"com.apple.cfprefsd\",\n                                            \"com.jetbrains.toolbox\", \"com.apple.pico\", \"com.apple.shove\",\n                                            \"com.sublimetext.4\", \"com.apple.ditto\") and process.code_signature.trusted == true)\n",
        "references": [
            "https://medium.com/red-teaming-with-a-blue-team-mentality/a-brief-look-at-macos-detections-and-post-infection-analysis-b0ede7ecfeb9",
            "https://objective-see.org/blog",
            "https://www.elastic.co/security-labs/DPRK-strikes-using-a-new-variant-of-rustbucket"
        ],
        "related_integrations": [
            {
                "package": "endpoint",
                "version": "^8.2.0"
            }
        ],
        "required_fields": [
            {
                "ecs": true,
                "name": "event.type",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "file.extension",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "file.path",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "host.os.type",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.code_signature.signing_id",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.code_signature.trusted",
                "type": "boolean"
            },
            {
                "ecs": true,
                "name": "process.executable",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "process.name",
                "type": "keyword"
            }
        ],
        "risk_score": 73,
        "rule_id": "62ba8542-1246-4647-9b84-98aa1bc0760a",
        "severity": "high",
        "tags": [
            "Domain: Endpoint",
            "OS: macOS",
            "Use Case: Threat Detection",
            "Tactic: Persistence",
            "Data Source: Elastic Defend",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0003",
                    "name": "Persistence",
                    "reference": "https://attack.mitre.org/tactics/TA0003/"
                },
                "technique": [
                    {
                        "id": "T1547",
                        "name": "Boot or Logon Autostart Execution",
                        "reference": "https://attack.mitre.org/techniques/T1547/",
                        "subtechnique": [
                            {
                                "id": "T1547.011",
                                "name": "Plist Modification",
                                "reference": "https://attack.mitre.org/techniques/T1547/011/"
                            }
                        ]
                    },
                    {
                        "id": "T1543",
                        "name": "Create or Modify System Process",
                        "reference": "https://attack.mitre.org/techniques/T1543/",
                        "subtechnique": [
                            {
                                "id": "T1543.001",
                                "name": "Launch Agent",
                                "reference": "https://attack.mitre.org/techniques/T1543/001/"
                            },
                            {
                                "id": "T1543.004",
                                "name": "Launch Daemon",
                                "reference": "https://attack.mitre.org/techniques/T1543/004/"
                            }
                        ]
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "eql",
        "version": 1
    },
    "id": "62ba8542-1246-4647-9b84-98aa1bc0760a_1",
    "type": "security-rule"
}