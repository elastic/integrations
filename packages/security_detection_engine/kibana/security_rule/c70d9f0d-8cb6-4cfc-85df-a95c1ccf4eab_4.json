{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "Detects sensitive AWS IAM API operations executed using temporary session credentials (access key IDs beginning with \"ASIA\"). Temporary credentials are commonly issued through sts:GetSessionToken, sts:AssumeRole, or AWS SSO logins and are meant for short-term use. It is unusual for legitimate users or automated processes to perform privileged IAM actions (e.g., creating users, updating policies, or enabling/disabling MFA) with session tokens. This behavior may indicate credential theft, session hijacking, or the abuse of a privileged role\u2019s temporary credentials.",
        "false_positives": [
            "Some CI/CD pipelines or administrative users may use session tokens. Review user context, IP, and timing to validate. Console login sessions result in temporary \"ASIA\" credentials and can typically be ignored for this alert. This can be verified in \"event.original\" as \"sessionCredentialFromConsole: true\""
        ],
        "from": "now-6m",
        "history_window_start": "now-14d",
        "index": [
            "filebeat-*",
            "logs-aws.cloudtrail-*"
        ],
        "investigation_fields": {
            "field_names": [
                "@timestamp",
                "user.name",
                "user_agent.original",
                "source.ip",
                "aws.cloudtrail.user_identity.arn",
                "aws.cloudtrail.user_identity.type",
                "aws.cloudtrail.user_identity.access_key_id",
                "event.action",
                "event.outcome",
                "cloud.account.id",
                "cloud.region",
                "aws.cloudtrail.request_parameters"
            ]
        },
        "language": "kuery",
        "license": "Elastic License v2",
        "name": "AWS IAM API Calls via Temporary Session Tokens",
        "new_terms_fields": [
            "aws.cloudtrail.user_identity.arn"
        ],
        "note": "## Triage and analysis\n\n> **Disclaimer**:\n> This investigation guide was created using generative AI technology and has been reviewed to improve its accuracy and relevance. \n> While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit your specific environment and operational needs.\n\n### Investigating AWS IAM API Calls via Temporary Session Tokens\n\nTemporary session credentials in AWS (identified by access keys beginning with \"ASIA\") are typically short-lived tokens \nissued by the AWS Security Token Service (STS). While they are legitimate and often used by developers or automation pipelines, \ntheir use in direct IAM management or privilege modification is highly unusual and may indicate credential misuse.\n\nAttackers who compromise IAM users, roles, or federated identities can obtain session tokens to blend in with normal operations. \nThey may then execute sensitive IAM API actions such as `CreateAccessKey`, `PutUserPolicy`, or `UpdateAssumeRolePolicy` to \nestablish persistence, escalate privileges, or disable protections.\n\n#### Possible investigation steps\n\n- **Identify the actor**\n  - Review `aws.cloudtrail.user_identity.arn` and `aws.cloudtrail.user_identity.type` to determine the originating user or role.\n  - Check `event.original` if ingested, look for `sessionCredentialFromConsole: true`. If this is present, the temporary session token was created as part of a legitimate console login session and this alert can be ignored. \n  - Examine `aws.cloudtrail.user_identity.session_context.mfa_authenticated` \u2014 absence of MFA may indicate token misuse.\n\n- **Analyze the API context**\n  - Review `event.action` and `aws.cloudtrail.request_parameters` for the exact IAM operation performed.\n  - Identify whether the action modifies roles, user policies, trust relationships, or credentials.\n  - Determine if this session token was associated with prior `sts:GetSessionToken`, `sts:AssumeRole`, or `AWS SSO` events.\n\n- **Evaluate source and behavior**\n  - Inspect `source.ip` and `user_agent.original` for unexpected origins or tools.\n  - Check if the request came from known infrastructure (e.g., CI/CD nodes, bastion hosts) or an anomalous network.\n  - Compare `@timestamp` against normal operating hours or deployment schedules.\n\n- **Correlate related activity**\n  - Look for subsequent or preceding activity using the same access key:\n    - IAM changes (`CreateUser`, `AttachUserPolicy`, `EnableMFADevice`)\n    - STS operations (`AssumeRole`, `GetCallerIdentity`)\n    - CloudTrail or GuardDuty configuration changes (possible defense evasion)\n  - If applicable, search for multiple users exhibiting similar patterns, a sign of large-scale token misuse.\n\n### False positive analysis\n\n- **Expected automation**\n  - Some CI/CD pipelines, monitoring tools, or AWS SDK-based automation may perform IAM operations using temporary credentials.\n  - Validate whether the IAM user or assumed role performing these actions belongs to an authorized automation workflow.\n- **Administrative operations**\n  - Security or DevOps engineers may temporarily use session credentials for maintenance or testing.\n  - Cross-reference with recent change tickets or known operations schedules.\n- **Federated identity scenarios**\n  - Federated logins (via AWS SSO or external IdPs) can also generate temporary \"ASIA\" credentials. Verify if the source identity \n    aligns with expected roles or groups.\n- **Console Login Session**\n  - Console login sessions result in temporary \"ASIA\" credentials and can typically be ignored for this alert. This can be verified in `event.original` as `sessionCredentialFromConsole: true`\n\n### Response and remediation\n\n- **Containment**\n  - If activity is unauthorized, immediately revoke the temporary session by invalidating the associated IAM credentials.\n  - Rotate long-term credentials (access keys, passwords) for the parent IAM user or role.\n\n- **Investigation**\n  - Search for all actions linked to the same `access_key_id` to assess potential persistence or lateral movement.\n  - Examine the creation of new users, keys, or policies during or shortly after the detected session.\n\n- **Recovery and hardening**\n  - Require MFA for all privileged actions using `aws:MultiFactorAuthPresent` conditions.\n  - Implement detection coverage for follow-on persistence actions such as:\n    - `iam:CreateAccessKey`\n    - `iam:PutUserPolicy`\n    - `iam:UpdateAssumeRolePolicy`\n  - Educate administrative users and developers on secure token handling and the risks of shared credential reuse.\n\n### Additional information\n\nFor more information on detecting and mitigating session token abuse:\n- **[AWS Security Token Service (STS) Documentation](https://docs.aws.amazon.com/STS/latest/APIReference/Welcome.html)**\n- **[AWS IR Playbooks](https://github.com/aws-samples/aws-incident-response-playbooks/blob/c151b0dc091755fffd4d662a8f29e2f6794da52c/playbooks/)** \n- **[AWS Customer Playbook Framework](https://github.com/aws-samples/aws-customer-playbook-framework/tree/a8c7b313636b406a375952ac00b2d68e89a991f2/docs)** \n- **Security Best Practices:** [AWS Knowledge Center \u2013 Security Best Practices](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/).\n",
        "query": "event.dataset: aws.cloudtrail\n    and event.provider: (\"iam.amazonaws.com\")\n    and event.outcome: \"success\"\n    and aws.cloudtrail.user_identity.type: \"IAMUser\"\n    and aws.cloudtrail.user_identity.access_key_id: ASIA*\n    and source.ip: *\n    and not user_agent.original : \"AWS Internal\"\n",
        "references": [
            "https://www.sygnia.co/blog/sygnia-investigation-bybit-hack/"
        ],
        "related_integrations": [
            {
                "integration": "cloudtrail",
                "package": "aws",
                "version": "^4.0.0"
            }
        ],
        "required_fields": [
            {
                "ecs": false,
                "name": "aws.cloudtrail.user_identity.access_key_id",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "aws.cloudtrail.user_identity.type",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.dataset",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.outcome",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "event.provider",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "source.ip",
                "type": "ip"
            },
            {
                "ecs": true,
                "name": "user_agent.original",
                "type": "keyword"
            }
        ],
        "risk_score": 21,
        "rule_id": "c70d9f0d-8cb6-4cfc-85df-a95c1ccf4eab",
        "severity": "low",
        "tags": [
            "Domain: Cloud",
            "Data Source: AWS",
            "Data Source: Amazon Web Services",
            "Data Source: AWS CloudTrail",
            "Data Source: AWS IAM",
            "Data Source: AWS STS",
            "Tactic: Persistence",
            "Tactic: Privilege Escalation",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0003",
                    "name": "Persistence",
                    "reference": "https://attack.mitre.org/tactics/TA0003/"
                },
                "technique": [
                    {
                        "id": "T1098",
                        "name": "Account Manipulation",
                        "reference": "https://attack.mitre.org/techniques/T1098/"
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "new_terms",
        "version": 4
    },
    "id": "c70d9f0d-8cb6-4cfc-85df-a95c1ccf4eab_4",
    "type": "security-rule"
}