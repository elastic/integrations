{
    "attributes": {
        "author": [
            "Elastic"
        ],
        "description": "This rule detects authenticated sessions accessing secret stores across multiple cloud providers from the same source address within a short period of time. Adversaries with access to compromised credentials or session tokens may attempt to retrieve secrets from services such as AWS Secrets Manager, Google Secret Manager, or Azure Key Vault in rapid succession to expand their access or exfiltrate sensitive information.",
        "from": "now-9m",
        "interval": "5m",
        "language": "esql",
        "license": "Elastic License v2",
        "name": "Multiple Cloud Secrets Accessed by Source Address",
        "note": "## Triage and analysis\n\n### Multiple Cloud Secrets Accessed by Source Address\n\nThis alert identifies a single source IP address accessing secret-management APIs across **multiple cloud providers**\n(e.g., AWS Secrets Manager, Google Secret Manager, Azure Key Vault) within a short timeframe.\nThis behavior is strongly associated with **credential theft, session hijacking, or token replay**, where an adversary\nuses stolen authenticated sessions to harvest secrets across cloud environments.\n\nUnexpected cross-cloud secret retrieval is uncommon and typically indicates automation misuse or malicious activity.\n\n### Possible investigation steps\n\n- Validate the principal\n  - Identify the user, service account, workload identity, or application making the requests.\n  - Confirm whether this identity is expected to operate across more than one cloud provider.\n- Review related activity\n  - Look for additional alerts involving the same identity, source IP, or token over the last 24\u201348 hours.\n  - Identify whether the source IP has been observed performing unusual authentication, privilege escalation,\n    or reconnaissance.\n- Check application or service context\n  - Determine whether any workload legitimately pulls secrets from multiple cloud providers.\n  - Review deployment pipelines or integration layers that might legitimately bridge AWS, Azure, and GCP.\n- Analyze user agent and invocation patterns\n  - Compare `user_agent.original` or equivalent fields against expected SDKs or automation tools.\n  - Suspicious indicators include CLI tools, unknown libraries, browser user agents, or custom scripts.\n- Inspect IP reputation and origin\n  - Determine whether the source IP corresponds to a managed workload (EC2, GCE, Azure VM) or an unexpected host.\n  - Validate that the associated instance or host is under your control and behaving normally.\n- Review IAM permissions and accessed secrets\n  - Check the policies attached to the identity.\n  - Verify whether the accessed secrets are sensitive, unused, or unrelated to the identity\u2019s purpose.\n- Assess potential compromise scope\n  - If compromise is suspected, enumerate other assets accessed by the same identity in the last 24 hours.\n  - Look for lateral movement, privilege escalation, or abnormal API usage.\n\n### False positive analysis\n\n- Validate whether the source IP is associated with a legitimate multi-cloud orchestration tool, automation pipeline,\n  or shared CI/CD system.\n- Confirm that the identity is authorized to access secrets across multiple cloud services.\n- If activity is expected, consider adding exceptions that pair account identity, source IP, and expected user agent\n  to reduce noise.\n\n### Response and remediation\n\n- Initiate incident response** if the activity is unauthorized or suspicious.\n- Restrict or disable** the affected credentials or service accounts.\n- Rotate all accessed secrets** and review other secrets the identity can access.\n- Analyze systems** that may have leaked credentials, such as compromised hosts or exposed tokens.\n- Harden identity security:\n  - Enforce MFA for users where applicable.\n  - Reduce permissions to least privilege.\n  - Review trust relationships, workload identities, and cross-cloud integrations.\n- Search for persistence mechanisms** such as newly created keys, roles, or service accounts.\n- Improve monitoring and audit visibility** by ensuring logging is enabled across all cloud environments.\n- Determine root cause** (phishing, malware, token replay, exposed credential, etc.) and close the vector to prevent recurrence.\n",
        "query": "FROM logs-azure.platformlogs-*, logs-aws.cloudtrail-*, logs-gcp.audit-*  METADATA _id, _version, _index \n| WHERE \n  ( \n    /* AWS Secrets Manager */ \n    (event.dataset == \"aws.cloudtrail\" AND event.provider == \"secretsmanager.amazonaws.com\" AND event.action == \"GetSecretValue\") OR \n    \n    // Azure Key Vault (platform logs)\n    (event.dataset == \"azure.platformlogs\" AND event.action IN (\"SecretGet\", \"KeyGet\")) or \n    \n    /* Google Secret Manager */ \n    (event.dataset IN (\"googlecloud.audit\", \"gcp.audit\") AND \n     event.action IN (\"google.cloud.secretmanager.v1.SecretManagerService.AccessSecretVersion\", \"google.cloud.secretmanager.v1.SecretManagerService.GetSecretRequest\"))\n   ) AND source.ip IS NOT NULL\n// Unified user identity (raw)\n| EVAL Esql_priv.user_id =\n    COALESCE(\n      client.user.id,\n      aws.cloudtrail.user_identity.arn,\n      NULL\n    )\n// Cloud vendor label based on dataset\n| EVAL Esql.cloud_vendor = CASE(\n    event.dataset == \"aws.cloudtrail\", \"aws\",\n    event.dataset == \"azure.platformlogs\", \"azure\",\n    event.dataset IN (\"googlecloud.audit\",\"gcp.audit\"), \"gcp\",\n    \"unknown\"\n  )\n// Vendor+tenant label, e.g. aws:123456789012, azure:tenant, gcp:project\n| EVAL Esql.tenant_label = CASE(\n    Esql.cloud_vendor == \"aws\", CONCAT(\"aws:\", cloud.account.id),\n    Esql.cloud_vendor == \"azure\", CONCAT(\"azure:\", cloud.account.id),\n    Esql.cloud_vendor == \"gcp\", CONCAT(\"gcp:\", cloud.account.id),\n    NULL\n  )\n| STATS\n    // Core counts\n    Esql.events_count = COUNT(*),\n    Esql.vendor_count_distinct = COUNT_DISTINCT(Esql.cloud_vendor),\n    // Action & data source context\n    Esql.event_action_values = VALUES(event.action),\n    Esql.data_source_values = VALUES(event.dataset),\n    // Cloud vendor + tenant context\n    Esql.cloud_vendor_values = VALUES(Esql.cloud_vendor),\n    Esql.tenant_label_values = VALUES(Esql.tenant_label),\n    // Hyperscaler-specific IDs\n    Esql.aws_account_id_values = VALUES(CASE(Esql.cloud_vendor == \"aws\", cloud.account.id, NULL)),\n    Esql.azure_tenant_id_values = VALUES(CASE(Esql.cloud_vendor == \"azure\", cloud.account.id, NULL)),\n    Esql.gcp_project_id_values = VALUES(CASE(Esql.cloud_vendor == \"gcp\", cloud.account.id, NULL)),\n    // Generic cloud metadata\n    Esql.cloud_region_values = VALUES(cloud.region),\n    Esql.cloud_service_name_values = VALUES(cloud.service.name),\n    // Identity (privileged)\n    Esql_priv.user_values = VALUES(Esql_priv.user_id),\n    Esql_priv.client_user_id_values = VALUES(client.user.id),\n    Esql_priv.aws_user_identity_arn_values = VALUES(aws.cloudtrail.user_identity.arn),\n    // Namespace values\n    Esql.data_stream_namespace_values = VALUES(data_stream.namespace)\n  BY source.ip\n// Require multi-vendor cred-access from same source IP\n| WHERE Esql.vendor_count_distinct >= 2\n| SORT Esql.events_count DESC\n| KEEP Esql.*, Esql_priv.*, source.ip\n",
        "references": [
            "https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html",
            "https://docs.cloud.google.com/secret-manager/docs/samples/secretmanager-access-secret-version",
            "https://learn.microsoft.com/en-us/azure/key-vault/secrets/about-secrets",
            "https://www.wiz.io/blog/shai-hulud-2-0-ongoing-supply-chain-attack"
        ],
        "related_integrations": [
            {
                "package": "aws",
                "version": "^4.0.0"
            },
            {
                "package": "gcp",
                "version": "^2.0.0"
            },
            {
                "package": "azure",
                "version": "^1.0.0"
            },
            {
                "integration": "cloudtrail",
                "package": "aws",
                "version": "^4.0.0"
            },
            {
                "integration": "platformlogs",
                "package": "azure",
                "version": "^1.0.0"
            }
        ],
        "required_fields": [
            {
                "ecs": false,
                "name": "Esql.aws_account_id_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.azure_tenant_id_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.cloud_region_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.cloud_service_name_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.cloud_vendor_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.data_source_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.data_stream_namespace_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.event_action_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.events_count",
                "type": "long"
            },
            {
                "ecs": false,
                "name": "Esql.gcp_project_id_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.tenant_label_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql.vendor_count_distinct",
                "type": "long"
            },
            {
                "ecs": false,
                "name": "Esql_priv.aws_user_identity_arn_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql_priv.client_user_id_values",
                "type": "keyword"
            },
            {
                "ecs": false,
                "name": "Esql_priv.user_values",
                "type": "keyword"
            },
            {
                "ecs": true,
                "name": "source.ip",
                "type": "ip"
            }
        ],
        "risk_score": 73,
        "rule_id": "472b4944-d810-43cf-83dc-7d080ae1b8dd",
        "setup": "This multi-datasource rule relies on additional configurations from each hyperscaler.\n\n- GCP Audit: [Enable DATA_READ for the Secret Manager API service](https://docs.cloud.google.com/logging/docs/audit/configure-data-access)\n- Azure: [Enable Diagnostic Logging for the Key Vault Service](https://learn.microsoft.com/en-us/azure/key-vault/general/howto-logging?tabs=azure-cli)\n- AWS: Secrets Manager read access is automatically logged by CloudTrail.\n",
        "severity": "high",
        "tags": [
            "Domain: Cloud",
            "Domain: IAM",
            "Domain: Storage",
            "Data Source: AWS",
            "Data Source: Amazon Web Services",
            "Data Source: AWS Secrets Manager",
            "Data Source: Azure",
            "Data Source: Azure Activity Logs",
            "Data Source: GCP",
            "Data Source: Google Cloud Platform",
            "Tactic: Credential Access",
            "Resources: Investigation Guide"
        ],
        "threat": [
            {
                "framework": "MITRE ATT&CK",
                "tactic": {
                    "id": "TA0006",
                    "name": "Credential Access",
                    "reference": "https://attack.mitre.org/tactics/TA0006/"
                },
                "technique": [
                    {
                        "id": "T1555",
                        "name": "Credentials from Password Stores",
                        "reference": "https://attack.mitre.org/techniques/T1555/",
                        "subtechnique": [
                            {
                                "id": "T1555.006",
                                "name": "Cloud Secrets Management Stores",
                                "reference": "https://attack.mitre.org/techniques/T1555/006/"
                            }
                        ]
                    }
                ]
            }
        ],
        "timestamp_override": "event.ingested",
        "type": "esql",
        "version": 3
    },
    "id": "472b4944-d810-43cf-83dc-7d080ae1b8dd_3",
    "type": "security-rule"
}