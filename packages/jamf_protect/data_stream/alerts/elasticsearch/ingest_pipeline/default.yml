---
description: Pipeline for processing sample logs
processors:
- json:
    field: message
    target_field: jamf_protect.alerts
- date:
    field: jamf_protect.alerts.input.match.event.timestamp
    formats:
    - UNIX

#######################
## ECS Event Mapping ##
#######################
#   - rename:
#       field: jamf_protect.alerts.input.match.event.timestamp
#       target_field: event.start
#       ignore_missing: true
#       ignore_failure: true
- date:
    field: jamf_protect.alerts.input.match.event.timestamp
    target_field: event.start
    formats: 
    - UNIX
    if: ctx.jamf_protect?.alerts?.match?.event?.timestamp != null
- rename:
    field: jamf_protect.alerts.input.match.facts.human
    target_field: message
    ignore_missing: true
- rename:
    field: jamf_protect.alerts.input.match.uuid
    target_field: event.id
    ignore_missing: true
- rename:
    field: ctx.jamf_protect?.alerts?.match?.facts[0]?.severity
    target_field: event.severity
    ignore_missing: true
    if: ctx.jamf_protect?.alerts?.match?.facts != null
- set:
    field: event.kind
    value: alert
- set:
    field: event.outcome
    value: success
    if: ctx.jamf_protect?.alerts?.match.actions.name == "Prevented"
- set:
    field: event.outcome
    value: failure
    if: ctx.jamf_protect?.alerts?.match.actions.name == "false"
- set:
    field: event.outcome
    value: unknown
    if: ctx?.event?.outcome == null

#######################
## ECS Host Mapping ##
#######################
- rename:
    field: jamf_protect.alerts.input.host.hostname
    target_field: host.hostname
    ignore_missing: true
- rename:
    field: jamf_protect.alerts.input.host.ips
    target_field: host.ip
    ignore_missing: true
    if: ctx.jamf_protect?.alerts?.host.ips != null && ctx.jamf_protect?.alerts?.host.ips != ""
- rename:
    field: jamf_protect.alerts.input.host.os
    target_field: host.os.full
    ignore_missing: true
- set:
    field: host.os.family
    value: macos

########################
## ECS Source Mapping ##
########################
- rename:
    field: jamf_protect.alerts.input.host.ips
    target_field: source.ip
- script:
    description: Script processor to capture user names from related.users array
    tag: set-process-command_line
    lang: painless
    source: |
        if (ctx.jamf_protect?.alerts?.related?.users != null) {
          ArrayList userNames = new ArrayList();
          for (def user : ctx.jamf_protect.alerts.related.users) {
            if (user.containsKey('name')) {
              userNames.add(user.name);
            }
          }
          ctx.user_names = userNames;
        }
      

#########################
## ECS Related Mapping ##
#########################
- append:
    field: related.hosts
    value: "{{ host.name }}"
    if: ctx?.jamf_protect?.alerts.host.hostname != null
    allow_duplicates: false
- append:
    field: related.ip
    value: "{{ source.ip }}"
    if: ctx?.jamf_protect?.alerts.host.ips != null
    allow_duplicates: false


#Calling pipelines for specific eventTypes with non-generic fields
#   - pipeline:
#       name: '{{ IngestPipeline "gpfsevent" }}'
#       if: ctx.jamf_protect?.alerts?.eventType == 'GPFSEvent'
    

on_failure:
- set:
    field: error.message
    value: '{{ _ingest.on_failure_message }}'