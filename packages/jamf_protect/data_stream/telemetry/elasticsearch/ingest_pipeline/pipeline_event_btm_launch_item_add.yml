---
description: Pipeline for Jamf Protect Telemetry events.
processors:

##########################
## ECS Event Specific ##
##########################
    - set:
        field: event.reason
        value: Appleâ€™s Background Task Manager notified that an item has been added
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.item.app_url
        target_field: custom.btm_item_app_url
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.item.item_url
        target_field: custom.btm_item_url
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.item.uid
        target_field: custom.btm_item_user_uid
        type: string
        ignore_missing: true
        ignore_failure: true
    # - convert:
    #     field: jamf_protect.telemetry.event.btm_launch_item_add.item.item_type
    #     target_field: custom.btm_item_type
    #     type: string
    #     ignore_missing: true
    #     ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.item.legacy
        target_field: custom.btm_item_is_legacy
        type: boolean
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.item.managed
        target_field: custom.btm_item_is_managed
        type: boolean
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.executable_path
        target_field: custom.btm_executable_path
        type: string
        ignore_missing: true
        ignore_failure: true
    - script:
        lang: painless
        source: >
            if (ctx.jamf_protect?.telemetry?.event?.btm_launch_item_add?.item?.item_type != null) {
                def itemType = ctx.jamf_protect.telemetry.event.btm_launch_item_add.item.item_type;
                def itemTypeMap = [
                0: 'User_Item',
                1: 'App',
                2: 'LoginItem',
                3: 'LaunchAgent',
                4: 'LaunchDaemon'
                ];
                def itemTypeString = itemTypeMap.containsKey(itemType) ? itemTypeMap[itemType] : 'Unknown';
                ctx.custom = ctx.custom != null ? ctx.custom : new HashMap();
                ctx.custom.btm_item_type = itemTypeString;
            }
##########################
## ECS Process ##
##########################
    - append:
        field: event.type
        value: change
    - append:
        field: event.category
        value: configuration 
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.start_time
        target_field: process.start
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.start_time
        target_field: process.start
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.audit_token.egid
        target_field: jamf_protect.telemetry.event.btm_launch_item_add.app.audit_token.egid
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.audit_token.egid
        target_field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.audit_token.egid
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.audit_token.euid
        target_field: jamf_protect.telemetry.event.btm_launch_item_add.app.audit_token.euid
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.audit_token.euid
        target_field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.audit_token.euid
        type: string
        ignore_missing: true
        ignore_failure: true
    - append:
        field: user.effective.id
        value: '{{{jamf_protect.telemetry.event.btm_launch_item_add.app.audit_token.euid}}}'
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.app?.audit_token?.euid != null
        allow_duplicates: false
        ignore_failure: true
    - append:
        field: user.effective.id
        value: '{{{jamf_protect.telemetry.event.btm_launch_item_add.instigator.audit_token.euid}}}'
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.instigator?.audit_token?.euid != null
        allow_duplicates: false
        ignore_failure: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.is_platform_binary
        target_field: custom.platform_binary
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.is_platform_binary
        target_field: custom.platform_binary
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.is_es_client
        target_field: custom.es_client
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.is_es_client
        target_field: custom.es_client
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.cdhash
        target_field: custom.code_directory_hash
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.cdhash
        target_field: custom.code_directory_hash
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.executable.sha1
        target_field: process.hash.sha1
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.executable.sha1
        target_field: process.hash.sha1
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.executable.sha256
        target_field: process.hash.sha256
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.executable.sha256
        target_field: process.hash.sha256
        ignore_missing: true
    - append:
        field: process.hash.sha1
        value: '{{{jamf_protect.telemetry.event.btm_launch_item_add.app.executable.sha1}}}'
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.app?.instigator?.executable?.sha1 != null
        allow_duplicates: false
        ignore_failure: true
    - append:
        field: process.hash.sha1
        value: '{{{jamf_protect.telemetry.event.btm_launch_item_add.instigator.executable.sha1}}}'
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.instigator?.instigator?.executable?.sha1 != null
        allow_duplicates: false
        ignore_failure: true
    - append:
        field: related.hash
        value: '{{{jamf_protect.telemetry.event.btm_launch_item_add.app.executable.sha1}}}'
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.app?.instigator?.executable?.sha1 != null
        allow_duplicates: false
        ignore_failure: true
    - append:
        field: related.hash
        value: '{{{jamf_protect.telemetry.event.btm_launch_item_add.instigator.executable.sha1}}}'
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.instigator?.instigator?.executable?.sha1 != null
        allow_duplicates: false
        ignore_failure: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.tty.path
        target_field: custom.tty
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.tty.path
        target_field: custom.tty
        ignore_missing: true
    - set:
        field: process.interactive
        value: true
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.app?.tty != null
    - set:
        field: process.interactive
        value: true
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.instigator?.tty != null
    - set:
        field: process.interactive
        value: false
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.app?.tty == null
    - set:
        field: process.interactive
        value: false
        if: ctx.jamf_protect.telemetry?.event?.btm_launch_item_add?.instigator?.tty == null
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.audit_token.pid
        target_field: process.pid
        type: long
        ignore_missing: true
        on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.audit_token.pid
        target_field: process.pid
        type: long
        ignore_missing: true
        on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.audit_token.uuid
        target_field: process.entity_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.audit_token.uuid
        target_field: process.entity_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.executable.path
        target_field: process.executable
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.executable.path
        target_field: process.executable
        ignore_missing: true

    - rename:
        field: jamf_protect.telemetry.thread.thread_id
        target_field: process.thread.id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.signing_id
        target_field: process.code_signature.signing_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.signing_id
        target_field: process.code_signature.signing_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.team_id
        target_field: process.code_signature.team_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.team_id
        target_field: process.code_signature.team_id
        ignore_missing: true

##########################
## ECS Parent Process ##
##########################

    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.parent_audit_token.uuid
        target_field: process.parent.entity_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.parent_audit_token.uuid
        target_field: process.parent.entity_id
        ignore_missing: true

    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.parent_audit_token.pid
        target_field: process.parent.pid
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.parent_audit_token.pid
        target_field: process.parent.pid
        ignore_missing: true

    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.parent_audit_token.euid
        target_field: process.parent.user.id
        type: string
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.parent_audit_token.euid
        target_field: process.parent.user.id
        type: string
        ignore_missing: true

    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.parent_audit_token.ruid
        target_field: process.parent.real_user.id
        type: string
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.parent_audit_token.ruid
        target_field: process.parent.real_user.id
        type: string
        ignore_missing: true

    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.parent_audit_token.rgid
        target_field: process.parent.real_group.id
        type: string
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.parent_audit_token.rgid
        target_field: process.parent.real_group.id
        type: string
        ignore_missing: true

##########################
## ECS Responsible Process ##
##########################

    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.responsible_audit_token.uuid
        target_field: process.group_leader.entity_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.responsible_audit_token.uuid
        target_field: process.group_leader.entity_id
        ignore_missing: true

    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.responsible_audit_token.pid
        target_field: process.group_leader.pid
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.responsible_audit_token.pid
        target_field: process.group_leader.pid
        ignore_missing: true

    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.responsible_audit_token.euid
        target_field: process.group_leader.user.id
        type: string
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.responsible_audit_token.euid
        target_field: process.group_leader.user.id
        type: string
        ignore_missing: true

    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.responsible_audit_token.ruid
        target_field: process.group_leader.real_user.id
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.responsible_audit_token.ruid
        target_field: process.group_leader.real_user.id
        type: string
        ignore_missing: true
        ignore_failure: true

    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.app.responsible_audit_token.rgid
        target_field: process.group_leader.real_group.id
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.btm_launch_item_add.instigator.responsible_audit_token.rgid
        target_field: process.group_leader.real_group.id
        type: string
        ignore_missing: true
        ignore_failure: true

    - pipeline:
        name: '{{ IngestPipeline "pipeline_object_process" }}'
        if: ctx.jamf_protect?.telemetry?.event?.btm_launch_item_add?.instigator == null && ctx.jamf_protect?.telemetry?.event?.btm_launch_item_add?.app == null

