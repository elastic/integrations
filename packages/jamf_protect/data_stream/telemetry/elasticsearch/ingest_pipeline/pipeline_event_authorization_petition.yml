---
description: Pipeline for Jamf Protect Telemetry events.
processors:

##########################
## ECS Event Specific ##
##########################
    - set:
        field: event.reason
        value: A process has its rights petition judged
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.rights
        target_field: custom.authorization_petition_rights
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.right_count
        target_field: custom.authorization_petition_right_count
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.flags
        target_field: custom.authorization_petition_flags
        ignore_missing: true
    # - script:
    #     lang: painless
    #     source: >
    #         if (ctx.jamf_protect?.telemetry?.event?.authorization_petition?.results != null) {
    #             def resultsArray = ctx.jamf_protect.telemetry.event.authorization_petition.results;
    #             for (int i = 0; i < resultsArray.length; i++) {
    #             def result = resultsArray[i];
    #             if (result != null) {
    #                 ctx.custom = ctx.custom != null ? ctx.custom : new HashMap();
    #                 if (result.granted != null) {
    #                 ctx.custom.authorization_granted = Boolean.parseBoolean(result.granted.toString());
    #                 }
    #                 if (result.right_name != null) {
    #                 ctx.custom.authorization_right_name = result.right_name.toString();
    #                 }
    #                 if (result.rule_class != null) {
    #                 ctx.custom.authorization_rule_class = result.rule_class.toString();
    #                 }
    #                 // Break after finding the first valid result
    #                 break;
    #             }
    #             }
    #         }
##########################
## ECS Process ##
##########################
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.start_time
        target_field: process.start
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.audit_token.egid
        target_field: jamf_protect.telemetry.event.authorization_petition.instigator.audit_token.egid
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.audit_token.euid
        target_field: jamf_protect.telemetry.event.authorization_petition.instigator.audit_token.euid
        type: string
        ignore_missing: true
        ignore_failure: true
    - append:
        field: user.effective.id
        value: '{{{jamf_protect.telemetry.event.authorization_petition.instigator.audit_token.euid}}}'
        if: ctx.jamf_protect.telemetry?.event?.authorization_petition?.instigator?.audit_token?.euid != null
        allow_duplicates: false
        ignore_failure: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.executable.sha1
        target_field: process.hash.sha1
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.executable.sha256
        target_field: process.hash.sha256
        ignore_missing: true
    - append:
        field: process.hash.sha1
        value: '{{{jamf_protect.telemetry.event.authorization_petition.instigator.executable.sha1}}}'
        if: ctx.jamf_protect.telemetry?.event?.authorization_petition?.instigator?.executable?.sha1 != null
        allow_duplicates: false
        ignore_failure: true
    - append:
        field: related.hash
        value: '{{{jamf_protect.telemetry.event.authorization_petition.instigator.executable.sha1}}}'
        if: ctx.jamf_protect.telemetry?.event?.authorization_petition?.instigator?.executable?.sha1 != null
        allow_duplicates: false
        ignore_failure: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.tty.path
        target_field: process.tty
        ignore_missing: true
    - set:
        field: process.interactive
        value: true
        if: ctx.jamf_protect.telemetry?.event?.authorization_petition?.instigator?.tty != null
    - set:
        field: process.interactive
        value: false
        if: ctx.jamf_protect.telemetry?.event?.authorization_petition?.instigator?.tty == null
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.audit_token.pid
        target_field: process.pid
        type: long
        ignore_missing: true
        on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.audit_token.uuid
        target_field: process.entity_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.executable.path
        target_field: process.executable
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.thread.thread_id
        target_field: process.thread.id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.db_path
        target_field: process.working_directory
        ignore_missing: true
        if: ctx.jamf_protect?.telemetry?.event?.authorization_petition?.db_path != null
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.signing_id
        target_field: process.code_signature.signing_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.team_id
        target_field: process.code_signature.team_id
        ignore_missing: true

##########################
## ECS Parent Process ##
##########################

    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.parent_audit_token.uuid
        target_field: process.parent.entity_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.parent_audit_token.pid
        target_field: process.parent.pid
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.parent_audit_token.euid
        target_field: process.parent.user.id
        type: string
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.parent_audit_token.ruid
        target_field: process.parent.real_user.id
        type: string
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.parent_audit_token.rgid
        target_field: process.parent.real_group.id
        type: string
        ignore_missing: true

##########################
## ECS Responsible Process ##
##########################

    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.responsible_audit_token.uuid
        target_field: process.group_leader.entity_id
        ignore_missing: true
    - rename:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.responsible_audit_token.pid
        target_field: process.group_leader.pid
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.responsible_audit_token.euid
        target_field: process.group_leader.user.id
        type: string
        ignore_missing: true
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.responsible_audit_token.ruid
        target_field: process.group_leader.real_user.id
        type: string
        ignore_missing: true
        ignore_failure: true
    - convert:
        field: jamf_protect.telemetry.event.authorization_petition.instigator.responsible_audit_token.rgid
        target_field: process.group_leader.real_group.id
        type: string
        ignore_missing: true
        ignore_failure: true