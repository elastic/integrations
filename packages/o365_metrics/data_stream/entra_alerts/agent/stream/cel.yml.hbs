config_version: 2
interval: {{interval}}
token_scopes:
  - "https://management.microsoft.com/.default"
auth.oauth2:
    client.id: {{client_id}}
    client.secret: {{client_secret}}
    provider: azure
    scopes: 
{{#each token_scopes as |token_scope|}}
      - {{token_scope}}
{{/each}}
    endpoint_params: 
        grant_type: client_credentials
{{#if token_url}}
    token_url: {{token_url}}/{{azure_tenant_id}}/oauth2/v2.0/token
{{else if azure_tenant_id}}
    azure.tenant_id: {{azure_tenant_id}}
{{/if}}

resource.url: {{url}}
{{#if resource_ssl}}
resource.ssl: 
  {{resource_ssl}}
{{/if}}
{{#if resource_timeout}}
resource.timeout: {{resource_timeout}}
{{/if}}
{{#if proxy_url}}
resource.proxy_url: {{proxy_url}}
{{/if}}
{{#if resource_retry_max_attempts}}
resource.retry.max_attempts: {{resource_retry_max_attempts}}
{{/if}}
{{#if resource_retry_wait_min}}
resource.retry.wait_min: {{resource_retry_wait_min}}
{{/if}}
{{#if resource_retry_wait_max}}
resource.retry.wait_max: {{resource_retry_wait_max}}
{{/if}}
{{#if resource_redirect_forward_headers}}
resource.redirect.forward_headers: {{resource_redirect_forward_headers}}
{{/if}}
{{#if resource_redirect_headers_ban_list}}
resource.redirect.headers_ban_list:
{{#each resource_redirect_headers_ban_list as |item|}}
  - {{item}}
{{/each}}
{{/if}}
{{#if resource_redirect_max_redirects}}
resource.redirect.max_redirects: {{resource_redirect_max_redirects}}
{{/if}}
{{#if resource_rate_limit_limit}}
resource.rate_limit.limit: {{resource_rate_limit_limit}}
{{/if}}
{{#if resource_rate_limit_burst}}
resource.rate_limit.burst: {{resource_rate_limit_burst}}
{{/if}}
{{#if enable_request_tracer}}
resource.tracer.filename: "../../logs/cel/http-request-trace-*.ndjson"
{{/if}}

tags:
{{#if preserve_original_event}}
  - preserve_original_event
{{/if}}
{{#each tags as |tag|}}
  - {{tag}}
{{/each}}
{{#contains "forwarded" tags}}
publisher_pipeline.disable_host: true
{{/contains}}
{{#if processors}}
processors:
{{processors}}
{{/if}}

state:
  want_more: false
  url: "https://management.microsoft.com/v1.0"
  worklist: []
  next: 0
  base:
    tenant_id: "{{azure_tenant_id}}"
    period: "{{period}}"

redact:
  fields:
    - base.tenant_id

program: |
  (
      state.with(
          request(
            "GET",
            state.url + "/providers/Microsoft.ADHybridHealthService/services/GetServices/PremiumCheck"
          ).do_request().as(resp, resp.StatusCode == 200 ?
            bytes(resp.Body).decode_json().as(body, {
              "worklist": body.value.collate("serviceName"),
            })
          :
            {
              "events": {
                "error": {
                  "code": string(resp.StatusCode),
                  "id": string(resp.Status),
                  "message": "GET /GetServices/PremiumCheck:" + (
                    size(resp.Body) != 0 ?
                      string(resp.Body)
                    :
                      string(resp.Status) + ' (' + string(resp.StatusCode) + ')'
                  ),
                },
              },
              "want_more": false,
            }
        ))
  ).as(state, state.with(
        request(
          "GET",
          state.url + "/providers/Microsoft.ADHybridHealthService/services/" + state.worklist[state.next] + "/alerts"
        ).do_request().as(resp, resp.StatusCode == 200 ?
          bytes(resp.Body).decode_json().as(body,{
            "events": (
                body.value.map(alert, {
                 "o365": {
                    "metrics": {
                      "entra": {
                        "alerts": {
                          "alert_id": alert.alertId,
                          "level": alert.level,
                          "state": alert.state,
                          "short_name": alert.shortName,
                          "display_name": alert.displayName,
                          "description": alert.description,
                          "remediation": alert.remediation,
                          "scope": alert.scope,
                          "created_date": alert.createdDate,
                          "resolved_date": alert.resolvedDate,
                          "last_updated": alert.lastUpdated,
                          "monitor_role_type": alert.monitorRoleType,
                          "tenant_id": alert.tenantId,
                          "service_id": alert.serviceId,
                          "service_member_id": alert.serviceMemberId
                        }
                      }
                    }
                  }
                })
            ),
            "worklist": int(state.next) + 1 < size(state.worklist) ? state.worklist : [],
            "next": int(state.next) + 1 < size(state.worklist) ? int(state.next) + 1 : 0,
            "want_more": int(state.next) + 1 < size(state.worklist)   
          })
        :
          {
            "events": {
              "error": {
                "code": string(resp.StatusCode),
                "id": string(resp.Status),
                "message": "GET /services/" + state.worklist[state.next] + "/alerts:" + (
                  size(resp.Body) != 0 ?
                    string(resp.Body)
                  :
                    string(resp.Status) + ' (' + string(resp.StatusCode) + ')'
                ),
              },
            },
            "want_more": false,
          }
        )
    )
  )