---
description: Pipeline for processing the Nginx OTEL Metrics
processors:
  - dot_expander:
      field: nginx.requests
      ignore_failure: true
  - rename:
      field: nginx.requests
      target_field: nginx.stubstatus.requests
      ignore_missing: true
  - dot_expander:
      field: nginx.connections_accepted
      ignore_failure: true
  - rename:
      field: nginx.connections_accepted
      target_field: nginx.stubstatus.accepts
      ignore_missing: true 
  - dot_expander:
      field: nginx.connections_handled
      ignore_failure: true
  - rename:
      field: nginx.connections_handled
      target_field: nginx.stubstatus.handled
      ignore_missing: true
  - dot_expander:
      field: nginx.connections_current
      override: true
  - rename:
      field: nginx.connections_current
      target_field: nginx.stubstatus.waiting
      ignore_missing: true
      if: ctx?.labels.state == 'waiting'
  - rename:
      field: nginx.connections_current
      target_field: nginx.stubstatus.writing
      ignore_missing: true
      if: ctx?.labels.state == 'writing'
  - rename:
      field: nginx.connections_current
      target_field: nginx.stubstatus.reading
      ignore_missing: true
      if: ctx?.labels.state == 'reading'
  - rename:
      field: nginx.connections_current
      target_field: nginx.stubstatus.active
      ignore_missing: true
      if: ctx?.labels.state == 'active'
  - script: 
      if: ctx?.nginx?.stubstatus?.accepts != null && ctx?.nginx?.stubstatus?.handled != null
      lang: painless
      source: >
        double dropped = ctx.nginx.stubstatus.accepts - ctx.nginx.stubstatus.handled;
        ctx.nginx.stubstatus.dropped = dropped;
on_failure:
  - set:
      field: error.message
      value: '{{ _ingest.on_failure_message }}'