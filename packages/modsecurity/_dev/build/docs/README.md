# ModSecurity Audit Integration for Elastic

## Overview

The ModSecurity Audit integration for Elastic allows you to collect and parse audit logs from ModSecurity, the open-source web application firewall (WAF). By ingesting these logs, you can monitor for web application attacks, analyze security events, and gain insights into traffic patterns and potential threats identified by ModSecurity rules.

This integration facilitates security monitoring and threat detection for web applications protected by ModSecurity.

### Compatibility

This integration has been tested with ModSecurity v3 when used with both the NGINX and Apache connectors.

For the integration to correctly parse the logs, ModSecurity must be configured to output logs in JSON format.

### How it works

The integration works by using Elastic Agent with the `logfile` input to tail the ModSecurity JSON audit log file. The agent sends the log data to Elasticsearch, where it is processed by the integration's ingest pipeline, which parses, enriches, and structures the data for analysis and visualization in Kibana.

## What data does this integration collect?

This integration collects audit logs generated by ModSecurity. The `auditlog` data stream includes detailed information about each transaction, such as request and response headers, rule matches, timing information, and unique transaction IDs. This data is crucial for security analysis and incident response.

### Supported use cases

- **Threat Detection:** Monitor for common web attacks like SQL injection, cross-site scripting (XSS), and remote code execution.
- **Security Visibility:** Gain a centralized view of security alerts across all web applications protected by ModSecurity.
- **Incident Analysis:** Investigate security events with detailed transactional logs to understand the nature and scope of an attack.
- **Compliance:** Retain and analyze audit logs to meet compliance requirements.

## What do I need to use this integration?

You need an operational ModSecurity instance configured to write audit logs to a file in JSON format. Elastic Agent must be installed on a host that has access to these log files.

## How do I deploy this integration?

### Agent-based deployment

Elastic Agent must be installed to collect logs and send them to Elastic. For detailed installation instructions, refer to the [Elastic Agent documentation](docs-content://reference/fleet/install-elastic-agents.md). Only one Elastic Agent is needed per host.

### Onboard / configure

#### 1. Configure ModSecurity Logging

On your ModSecurity server, you must configure the audit log engine to write logs in JSON format. Add or modify the following directives in your ModSecurity configuration file (e.g., `modsecurity.conf`):

```
# Turn on the audit engine
SecAuditEngine On

# Specify the parts of the transaction to log.
# IMPORTANT: Do not include 'K' as it can generate excessively long log entries.
SecAuditLogParts ABDEFHIJZ

# Use the Serial log type
SecAuditLogType Serial

# Define the path to your audit log file. This path will be used in the Elastic Agent configuration.
SecAuditLog /var/log/modsec_audit.json

# Set the log format to JSON
SecAuditLogFormat JSON
```

Ensure the user running Elastic Agent has read permissions for the specified log file (`/var/log/modsec_audit.json` in this example).

#### 2. Configure the Integration in Kibana

1.  In Kibana, navigate to **Management > Integrations**.
2.  In the search bar, enter "ModSecurity" and select the **ModSecurity Audit** integration.
3.  Click **Add ModSecurity Audit**.
4.  Configure the integration:
    *   **Integration name:** Provide a descriptive name, such as `modsecurity-prod`.
    *   **Paths:** Enter the path to your ModSecurity audit log file (e.g., `/var/log/modsec_audit.json` or `/var/log/modsec-audit*`).
5.  Click **Save and continue**. This will create a new agent policy.
6.  Add the policy to the Elastic Agents that need to collect ModSecurity logs.

### Validation

1.  After configuring the integration, trigger some traffic to your web application that is monitored by ModSecurity. You can trigger a known WAF rule to ensure an audit event is generated.
2.  In Kibana, navigate to the **Discover** tab.
3.  In the data view dropdown, select `logs-modsecurity.auditlog-*`.
4.  Verify that log messages from your ModSecurity instance are appearing. It may take a few minutes for the data to be indexed.
5.  You can also navigate to the dashboards associated with the ModSecurity Audit integration to see visualizations of your data.

## Troubleshooting

### No Data is Being Ingested

-   **Check File Permissions:** Ensure the user running Elastic Agent has read access to the ModSecurity audit log file and its parent directories.
-   **Verify Log Format:** Confirm that your ModSecurity configuration is set to `SecAuditLogFormat JSON`. The integration cannot parse logs in the native format.
-   **Check Agent Logs:** Look for errors in the Elastic Agent logs. For more details, see the [Troubleshoot common problems](https://www.elastic.co/docs/troubleshoot/ingest/fleet/common-problems) guide.

### Log Parsing Issues

Be careful not to include the `K` part in the `SecAuditLogParts` directive in your ModSecurity configuration. This part includes a list of all matching rules and can make the raw log event too long to be processed correctly.

## Reference

### auditlog

The `auditlog` data stream collects and parses audit logs from ModSecurity.

#### auditlog fields

{{ fields "auditlog" }}

#### auditlog sample event

{{ event "auditlog" }}

### Inputs used
{{ inputDocs }}
