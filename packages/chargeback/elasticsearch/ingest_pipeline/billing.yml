---
description: 'Chargeback:\n
- Set composite_key from @timestamp and deployment_id.\n
- Set deployment_group from deployment tag `chargeback_group`'
processors:
  - script:
      ignore_failure: true
      lang: painless
      source: |
        if (ctx['@timestamp'] != null) {
            ctx.composite_key = ZonedDateTime.parse(ctx['@timestamp']).toLocalDate().toString() + '_' + ctx.deployment_id;
        }
      tag: ess_billing
  - set:
      field: deployment_group
      value: ""
  - script:
      description: "Extract chargeback_group from deployment_tags"
      if: ctx?.ess?.billing?.deployment_tags != null && ctx.ess.billing.deployment_tags instanceof List
      lang: painless
      source: |
        try {
          boolean found = false;
          for (tag in ctx.ess.billing.deployment_tags) {
            if (tag instanceof String && tag.startsWith('chargeback_group:')) {
              ctx.deployment_group = tag.substring('chargeback_group:'.length());
              found = true;
              break;
            }
          }
          if (!found) {
            if (ctx.tags == null) {
              ctx.tags = new ArrayList();
            }
            ctx.tags.add("chargeback_group_missing");
          }
        } catch (Exception err) {
          if (ctx.tags == null) {
            ctx.tags = new ArrayList();
          }
          ctx.tags.add("chargeback_script_error");
        }
  - pipeline:
      description: '[Fleet] Global pipeline for all data streams'
      ignore_missing_pipeline: true
      name: global@custom
  - pipeline:
      description: '[Fleet] Pipeline for all data streams of type `metrics`'
      ignore_missing_pipeline: true
      name: metrics@custom
  - pipeline:
      description: '[Fleet] Pipeline for all data streams of type `metrics` defined by the `chargeback` integration'
      ignore_missing_pipeline: true
      name: metrics-chargeback.integration@custom
  - pipeline:
      description: '[Fleet] Pipeline for the `chargeback.billing` dataset'
      ignore_missing_pipeline: true
      name: metrics-chargeback.billing@custom
