---
description:
  This data stream is meant for routing only, we want to avoid that data is written to it.
  We'll use the dataset that is specified in the ECS JSON log message, or use 'generic' as the default.
processors:
  - remove:
      field: data_stream.dataset
      ignore_missing: true
  - remove:
      field: event.dataset
      ignore_missing: true
  - set:
      description: Uses event.dataset as a default for data_stream.dataset if the latter is not set.
      field: data_stream.dataset
      copy_from: event.dataset
      if: ctx.event?.dataset instanceof String && ctx.event.dataset.length() > 1
      override: false
  - script:
      source: |
        ctx.data_stream.dataset = /[\/*?"<>|, #:-]/.matcher(ctx.data_stream.dataset).replaceAll('_')
      if: ctx.data_stream?.dataset != null
  - script:
      source: |
        ctx.data_stream.namespace = /[\/*?"<>|, #:]/.matcher(ctx.data_stream.namespace).replaceAll('_')
      if: ctx.data_stream?.namespace != null
  - set:
      field: data_stream.type
      value: logs
  - set:
      field: data_stream.dataset
      value: kibana-logs
      override: false
  - set:
      field: data_stream.namespace
      value: platform-observability
      override: false
  - set:
      field: event.dataset
      copy_from: data_stream.dataset
  - rename:
      field: message
      target_field: _ecs_json_message
      if: |-
        def message = ctx.message;
        return message != null
            && message.startsWith('{')
            && message.endsWith('}')
            && message.contains('"@timestamp"')
      ignore_missing: true
  - json:
      field: _ecs_json_message
      add_to_root: true
      add_to_root_conflict_strategy: merge
      allow_duplicate_keys: true
      if: ctx.containsKey('_ecs_json_message')
      on_failure:
        - rename:
            field: _ecs_json_message
            target_field: message
            ignore_missing: true
        - set:
            field: error.message
            value: Error while parsing JSON
            override: false
  - remove:
      field: _ecs_json_message
      ignore_missing: true
  - remove:
      field: _tag
      ignore_missing: true
  - remove:
      field: right
      ignore_missing: true
