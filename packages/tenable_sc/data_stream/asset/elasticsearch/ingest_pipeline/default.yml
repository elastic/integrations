---
description: Pipeline for Tenable.sc asset logs
processors:
  - set:
      field: ecs.version
      value: '1.12.0'
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
  - json:
      field: event.original
      target_field: json
      ignore_failure: true
  - date:
      field: json.timestamp
      target_field: "@timestamp"
      ignore_failure: true
      formats:
          - UNIX
  - set:
      field: event.type
      value: info
  - set:
      field: event.kind
      value: state
  - set:
      field: event.category
      value: host
  - append: 
      field: related.ip
      value: "{{{json.ip}}}"
  - set: 
      field: host.ip
      copy_from: json.ip
  - rename: 
      field: json.ip
      target_field: tenable_sc.asset.ip
  - rename: 
      field: json.uuid
      target_field: tenable_sc.asset.uuid
  - convert: 
      field: json.score
      type: long
      ignore_failure: true
  - rename: 
      field: json.score
      target_field: tenable_sc.asset.score
  - convert: 
      field: json.total
      type: long
      ignore_failure: true
  - rename: 
      field: json.total
      target_field: tenable_sc.asset.total
  - convert: 
      field: json.severityInfo
      type: long
      ignore_failure: true
  - rename: 
      field: json.severityInfo
      target_field: tenable_sc.asset.severity.info
  - convert: 
      field: json.severityLow
      type: long
      ignore_failure: true
  - rename: 
      field: json.severityLow
      target_field: tenable_sc.asset.severity.low
  - convert: 
      field: json.severityMedium
      type: long
      ignore_failure: true
  - rename: 
      field: json.severityMedium
      target_field: tenable_sc.asset.severity.medium
  - convert: 
      field: json.severityHigh
      type: long
      ignore_failure: true
  - rename: 
      field: json.severityHigh
      target_field: tenable_sc.asset.severity.high
  - convert: 
      field: json.severityCritical
      type: long
      ignore_failure: true
  - rename: 
      field: json.severityCritical
      target_field: tenable_sc.asset.severity.critical
  - set: 
      field: host.mac
      copy_from: json.macAddress 
  - rename: 
      field: json.macAddress
      target_field: tenable_sc.asset.mac
  - rename: 
      field: json.policyName
      target_field: tenable_sc.asset.policy.name
  - rename: 
      field: json.pluginSet
      target_field: tenable_sc.asset.plugin_set
  - set: 
      field: tenable_sc.asset.netbios.name
      copy_from: json.netbiosName
  - set: 
      field: host.hostname
      copy_from: json.dnsName
  - set: 
      field: tenable_sc.asset.dns.name
      copy_from: json.dnsName
  - script:
      lang: painless
      source: |
        def domain = "";
        def nameArray = ctx.json.dnsName.toString().splitOnToken(".");
        if (nameArray?.length > 0) {
          for (int i = 1; i < nameArray.length; i++) {
            domain += nameArray[i] + (i < nameArray.length - 1 ? "." : "");
          }
          ctx.host.name = nameArray[0];
          ctx.host.domain = domain; 
        }
  - append:
      field: related.hosts
      value: "{{{host.hostname}}}"
      allow_duplicates: false
  - append:
      field: related.hosts
      value: "{{{host.name}}}"
      allow_duplicates: false
  - append:
      field: related.hosts
      value: "{{{json.netbiosName}}}"
      allow_duplicates: false
  - rename: 
      field: json.osCPE
      target_field: tenable_sc.asset.os_cpe
  - rename: 
      field: json.biosGUID
      target_field: tenable_sc.asset.bios.guid
  - rename: 
      field: json.tpmID
      target_field: tenable_sc.asset.tpm.id
  - rename: 
      field: json.mcafeeGUID
      target_field: tenable_sc.asset.mcafee.guid
  - rename: 
      field: json.lastAuthRun
      target_field: tenable_sc.asset.last_auth_run
  - rename: 
      field: json.lastUnauthRun
      target_field: tenable_sc.asset.last_unauth_run
  - rename: 
      field: json.hostUniqueness
      target_field: tenable_sc.asset.host_uniqueness
  - rename: 
      field: json.uniqueness
      target_field: tenable_sc.asset.uniqueness
  - rename: 
      field: json.repository.id 
      target_field: tenable_sc.asset.repository.id
  - rename: 
      field: json.repository.name 
      target_field: tenable_sc.asset.repository.name
  - rename: 
      field: json.repository.description
      target_field: tenable_sc.asset.repository.description
  - rename: 
      field: json.repository.sciID 
      target_field: tenable_sc.asset.repository.sci.id
  - rename: 
      field: json.repository.dataFormat 
      target_field: tenable_sc.asset.repository.data_format
  - script:
      description: Drops null/empty values recursively
      lang: painless
      source: |
        boolean drop(Object o) {
          if (o == null || o == "") {
            return true;
          } else if (o instanceof Map) {
            ((Map) o).values().removeIf(v -> drop(v));
            return (((Map) o).size() == 0);
          } else if (o instanceof List) {
            ((List) o).removeIf(v -> drop(v));
            return (((List) o).length == 0);
          }
          return false;
        }
        drop(ctx);
  - remove: 
      field: json
      if: ctx?.json != null
  - remove:
      field: event.original
      if: "ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))"
      ignore_failure: true
      ignore_missing: true
on_failure:
  - set:
      field: error.message
      value: "{{{ _ingest.on_failure_message }}}"
