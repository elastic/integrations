---
description: Pipeline for Tenable.sc plugin logs
processors:
  - set:
      field: ecs.version
      value: '1.12.0'
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
  - json:
      field: event.original
      target_field: json
      ignore_failure: true
  - date:
      field: json.modifiedTime
      target_field: "@timestamp"
      ignore_failure: true
      formats:
        - UNIX
  - fingerprint:
      fields:
        - json.modifiedTime
        - json.id
        - json.name
        - json.type
        - json.description
        - json.version
        - json.sourceFile
        - json.cpe
        - json.dependencies
        - json.riskFactor
        - json.vprContext
        - json.vprScore
        - json.baseScore
        - json.temporalScore
        - json.cvssVector
        - json.cvssV3Vector
        - json.pluginModDate
        - json.patchPubDate
        - json.vulnPubDate
        - json.family
      target_field: _id
      ignore_missing: true
  - set:
      field: event.type
      value: info
  - set:
      field: event.kind
      value: event
  - rename:
      field: json.id
      target_field: tenable_sc.plugin.id
  - rename:
      field: json.name
      target_field: tenable_sc.plugin.name
  - rename:
      field: json.description
      target_field: tenable_sc.plugin.description
  - rename:
      field: json.type
      target_field: tenable_sc.plugin.type
  - rename:
      field: json.copyright
      target_field: tenable_sc.plugin.copyright
  - rename:
      field: json.version
      target_field: tenable_sc.plugin.version
  - convert: 
      field: tenable_sc.plugin.version
      type: double
      ignore_failure: true
  - rename:
      field: json.sourceFile
      target_field: tenable_sc.plugin.source_file
  - split:
      field: json.dependencies
      target_field: tenable_sc.plugin.dependencies
      separator: ","
      ignore_missing: true
  - rename:
      field: json.requiredPorts
      target_field: tenable_sc.plugin.required_ports
  - rename:
      field: json.requiredUDPPorts
      target_field: tenable_sc.plugin.required_udp_ports
  - split:
      field: json.cpe
      target_field: tenable_sc.plugin.cpe
      separator: '\n'
      ignore_missing: true
  - rename:
      field: json.srcPort
      target_field: tenable_sc.plugin.src_port
      if: ctx?.json?.srcPort != null
  - rename:
      field: json.dstPort
      target_field: tenable_sc.plugin.dst_port
      if: ctx?.json?.dstPort != null
  - rename:
      field: json.protocol
      target_field: tenable_sc.plugin.protocol
  - rename:
      field: json.riskFactor
      target_field: tenable_sc.plugin.risk_factor  
  - rename:
      field: json.solution
      target_field: tenable_sc.plugin.solution
  - split:
      field: json.seeAlso
      target_field: tenable_sc.plugin.see_also
      separator: '\n'
      ignore_missing: true
  - rename:
      field: json.synopsis
      target_field: tenable_sc.plugin.synopsis
  - rename:
      field: json.checkType
      target_field: tenable_sc.plugin.check_type
      if: ctx?.json?.checkType != ''
  - rename:
      field: json.exploitEase
      target_field: tenable_sc.plugin.exploit.ease
  - rename:
      field: json.exploitAvailable
      target_field: tenable_sc.plugin.exploit.is_available
  - rename:
      field: json.exploitFrameworks
      target_field: tenable_sc.plugin.exploit.frameworks
  - rename:
      field: json.cvssVector
      target_field: tenable_sc.plugin.cvss_vector
      if: ctx?.json?.cvssVector != ''
  - rename:
      field: json.cvssVectorBF
      target_field: tenable_sc.plugin.cvss_vector_bf
      if: ctx?.json?.cvssVectorBF != '0'
  - rename:
      field: json.baseScore
      target_field: tenable_sc.plugin.base_score
      if: ctx?.json?.baseScore != null
  - convert:
      field: tenable_sc.plugin.base_score
      type: double
      ignore_failure: true
  - rename:
      field: json.temporalScore
      target_field: tenable_sc.plugin.temporal_score
      if: ctx?.json?.temporalScore != null
  - convert:
      field: tenable_sc.plugin.temporal_score
      type: double
      ignore_failure: true
  - rename:
      field: json.cvssV3Vector
      target_field: tenable_sc.plugin.cvssv3_vector
      if: ctx?.json?.cvssV3Vector != ''
  - rename:
      field: json.cvssV3VectorBF
      target_field: tenable_sc.plugin.cvssv3_vector_bf
      if: ctx?.json?.cvssV3VectorBF != '0'
  - convert:
      field: json.cvssV3BaseScore
      type: double
      ignore_failure: true
  - rename:
      field: json.cvssV3BaseScore
      target_field: tenable_sc.plugin.cvssv3_base_score
      if: ctx?.json?.cvssV3BaseScore != null
  - convert:
      field: json.cvssV3TemporalScore
      type: double
      ignore_failure: true
  - rename:
      field: json.cvssV3TemporalScore
      target_field: tenable_sc.plugin.cvssv3_temporal_score
      if: ctx?.json?.cvssV3TemporalScore != null
  - convert:
      field: json.vprScore
      type: double
      ignore_failure: true
  - rename:
      field: json.vprScore
      target_field: tenable_sc.plugin.vpr.score
  - json: 
      field: json.vprContext
      target_field: json.vprContext
      ignore_failure: true
  - script:
      if: ctx?.json?.vprContext != null
      lang: painless
      source: >-
        def parts = ctx.json.vprContext;
        if (parts != null && parts.length > 0) {
          Map map = new HashMap();
          for (int i = 0; i < parts.length; i++) {
            map.put(parts[i]["id"], parts[i]["value"])
          }
          ctx.tenable_sc.plugin.vpr.context = map;
          ctx.tenable_sc.plugin.vpr.context._original = parts;
        }
  - rename:
      field: json.stigSeverity
      target_field: tenable_sc.plugin.stig_severity
      if: ctx?.json?.stigSeverity != null
  - set: 
      field: tenable_sc.plugin.is_plugin_published
      value: false
  - set: 
      field: tenable_sc.plugin.is_plugin_published
      value: true
      if: ctx?.json?.pluginPubDate != '-1'
  - date:
      field: json.pluginPubDate
      target_field: tenable_sc.plugin.plugin_pub_date
      if: ctx?.json?.pluginPubDate != '-1'
      ignore_failure: true
      formats:
        - UNIX
  - set: 
      field: tenable_sc.plugin.is_plugin_modified
      value: false
  - set: 
      field: tenable_sc.plugin.is_plugin_modified
      value: true
      if: ctx?.json?.pluginModDate != '-1'
  - date:
      field: json.pluginModDate
      target_field: tenable_sc.plugin.plugin_mod_date
      if: ctx?.json?.pluginModDate != '-1'
      ignore_failure: true
      formats:
        - UNIX
  - set: 
      field: tenable_sc.plugin.is_patch_published
      value: false
  - set: 
      field: tenable_sc.plugin.is_patch_published
      value: true
      if: ctx?.json?.patchPubDate != '-1'
  - date:
      field: json.patchPubDate
      target_field: tenable_sc.plugin.patch_pub_date
      if: ctx?.json?.patchPubDate != '-1'
      ignore_failure: true
      formats:
        - UNIX
  - set: 
      field: tenable_sc.plugin.is_patch_modified
      value: false
  - set: 
      field: tenable_sc.plugin.is_patch_modified
      value: true
      if: ctx?.json?.patchModDate != '-1'
  - date:
      field: json.patchModDate
      target_field: tenable_sc.plugin.patch_mod_date
      if: ctx?.json?.patchModDate != '-1'
      ignore_failure: true
      formats:
        - UNIX
  - set: 
      field: tenable_sc.plugin.is_vulnerability_published
      value: false
  - set: 
      field: tenable_sc.plugin.is_vulnerability_published
      value: true
      if: ctx?.json?.vulnPubDate != '-1'
  - date:
      field: json.vulnPubDate
      target_field: tenable_sc.plugin.vuln_pub_date
      if: ctx?.json?.vulnPubDate != '-1'
      ignore_failure: true
      formats:
        - UNIX
  - date:
      field: json.modifiedTime
      target_field: tenable_sc.plugin.modified_time
      ignore_failure: true
      formats:
        - UNIX
  - rename:
      field: json.md5
      target_field: tenable_sc.plugin.md5
  - split:
      field: json.xrefs
      target_field: tenable_sc.plugin.xrefs
      separator: ", "
      ignore_missing: true
  - rename:
      field: json.source
      target_field: tenable_sc.plugin.source
      ignore_missing: true
  - rename:
      field: json.family.id
      target_field: tenable_sc.plugin.family.id
  - rename:
      field: json.family.name
      target_field: tenable_sc.plugin.family.name
  - rename:
      field: json.family.type
      target_field: tenable_sc.plugin.family.type
  - script:
      description: Drops null/empty values recursively
      lang: painless
      source: |
        boolean drop(Object o) {
          if (o == null || o == "") {
            return true;
          } else if (o instanceof Map) {
            ((Map) o).values().removeIf(v -> drop(v));
            return (((Map) o).size() == 0);
          } else if (o instanceof List) {
            ((List) o).removeIf(v -> drop(v));
            return (((List) o).length == 0);
          }
          return false;
        }
        drop(ctx);
  - remove:
      field: json
      if: ctx?.json != null
  - remove:
      field: event.original
      if: "ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))"
      ignore_failure: true
      ignore_missing: true
on_failure:
  - set:
      field: error.message
      value: '{{{ _ingest.on_failure_message }}}'