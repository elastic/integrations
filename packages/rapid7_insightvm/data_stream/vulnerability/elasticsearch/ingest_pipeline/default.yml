---
description: Pipeline for processing Rapid7 InsightVM Vulnerability logs.
processors:
  - set:
      field: ecs.version
      value: '8.6.0'
  - set:
      field: event.kind
      value: event
  - set:
      field: event.category
      value: [vulnerability]
  - set:
      field: event.type
      value: [info]
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
  - json:
      field: event.original
      tag: 'json_decoding'
      target_field: json
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'   
  - drop:
      if: ctx.json?.data != null && ctx.json.data.isEmpty()
  - fingerprint:
      fields:
        - json.id
        - json.modified
        - json.added
        - json.description
        - json.cves
        - json.published
      target_field: '_id'
      ignore_missing: true
  - date:
      field: json.added
      tag: 'date_added'
      target_field: rapid7.insightvm.vulnerability.added
      formats:
        - ISO8601
      if: ctx.json?.added != null && ctx.json?.added != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.categories
      target_field: rapid7.insightvm.vulnerability.categories
      ignore_missing: true
  - append:
      field: vulnerability.category
      value: '{{{rapid7.insightvm.vulnerability.categories}}}'
      if: ctx.rapid7?.insightvm?.vulnerability?.categories != null
      allow_duplicates: false
  - set:
      field: vulnerability.classification
      value: 'CVSS'
  - set:
      field: vulnerability.scanner.vendor
      value: 'Rapid7'
  - set:
      field: vulnerability.enumeration
      value: 'CVE'
      if: ctx.json?.cves != null && ctx.json?.cves?.startsWith('CVE')
  - split:
      field: json.cves
      target_field: rapid7.insightvm.vulnerability.cves
      separator: ','
      ignore_missing: true
      if: ctx.json?.cves != null && ctx.json.cves != ''
  - set:
      field: vulnerability.id
      copy_from: rapid7.insightvm.vulnerability.cves
      ignore_empty_value: true
  - rename:
      field: json.cvss_v2_access_complexity
      target_field: rapid7.insightvm.vulnerability.cvss.v2.access_complexity
      ignore_missing: true
  - rename:
      field: json.cvss_v2_access_vector
      target_field: rapid7.insightvm.vulnerability.cvss.v2.access_vector
      ignore_missing: true
  - rename:
      field: json.cvss_v2_authentication
      target_field: rapid7.insightvm.vulnerability.cvss.v2.authentication
      ignore_missing: true
  - rename:
      field: json.cvss_v2_availability_impact
      target_field: rapid7.insightvm.vulnerability.cvss.v2.availability_impact
      ignore_missing: true
  - rename:
      field: json.cvss_v2_confidentiality_impact
      target_field: rapid7.insightvm.vulnerability.cvss.v2.confidentiality_impact
      ignore_missing: true
  - convert:
      field: json.cvss_v2_exploit_score
      tag: 'convert_cvss_v2_exploit_score_to_double'
      target_field: rapid7.insightvm.vulnerability.cvss.v2.exploit_score
      if: ctx.json?.cvss_v2_exploit_score != ''
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.cvss_v2_impact_score
      tag: 'convert_cvss_v2_impact_score_to_double'
      target_field: rapid7.insightvm.vulnerability.cvss.v2.impact_score
      if: ctx.json?.cvss_v2_impact_score != ''
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.cvss_v2_integrity_impact
      target_field: rapid7.insightvm.vulnerability.cvss.v2.integrity_impact
      ignore_missing: true
  - convert:
      field: json.cvss_v2_score
      tag: 'convert_cvss_v2_score_to_double'
      target_field: rapid7.insightvm.vulnerability.cvss.v2.score
      if: ctx.json?.cvss_v2_score != ''
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - append:
      field: vulnerability.score.base
      value: '{{{rapid7.insightvm.vulnerability.cvss.v2.score}}}'
      if: ctx.rapid7?.insightvm?.vulnerability?.cvss.v2.score != null
      allow_duplicates: false
  - rename:
      field: json.cvss_v2_vector
      target_field: rapid7.insightvm.vulnerability.cvss.v2.vector
      ignore_missing: true
  - rename:
      field: json.cvss_v3_attack_complexity
      target_field: rapid7.insightvm.vulnerability.cvss.v3.attack_complexity
      ignore_missing: true
  - rename:
      field: json.cvss_v3_attack_vector
      target_field: rapid7.insightvm.vulnerability.cvss.v3.attack_vector
      ignore_missing: true
  - rename:
      field: json.cvss_v3_availability_impact
      target_field: rapid7.insightvm.vulnerability.cvss.v3.availability_impact
      ignore_missing: true
  - rename:
      field: json.cvss_v3_confidentiality_impact
      target_field: rapid7.insightvm.vulnerability.cvss.v3.confidentiality_impact
      ignore_missing: true
  - convert:
      field: json.cvss_v3_exploit_score
      tag: 'convert_cvss_v3_exploit_score_to_double'
      target_field: rapid7.insightvm.vulnerability.cvss.v3.exploit_score
      if: ctx.json?.cvss_v3_exploit_score != ''
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.cvss_v3_impact_score
      tag: 'convert_cvss_v3_impact_score_to_double'
      target_field: rapid7.insightvm.vulnerability.cvss.v3.impact_score
      if: ctx.json?.cvss_v3_impact_score != ''
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.cvss_v3_integrity_impact
      target_field: rapid7.insightvm.vulnerability.cvss.v3.integrity_impact
      ignore_missing: true
  - rename:
      field: json.cvss_v3_privileges_required
      target_field: rapid7.insightvm.vulnerability.cvss.v3.privileges_required
      ignore_missing: true
  - rename:
      field: json.cvss_v3_scope
      target_field: rapid7.insightvm.vulnerability.cvss.v3.scope
      ignore_missing: true
  - convert:
      field: json.cvss_v3_score
      tag: 'convert_cvss_v3_score_to_double'
      target_field: rapid7.insightvm.vulnerability.cvss.v3.score
      if: ctx.json?.cvss_v3_score != ''
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - append:
      field: vulnerability.score.base
      value: '{{{rapid7.insightvm.vulnerability.cvss.v3.score}}}'
      if: ctx.rapid7?.insightvm?.vulnerability?.cvss.v3.score != null
      allow_duplicates: false
  - foreach:
      field: vulnerability.score.base
      if: ctx.vulnerability?.score?.base instanceof List
      processor:
        convert:
          field: _ingest._value
          tag: 'convert_vulnerability_score_base_to_double'
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.cvss_v3_user_interaction
      target_field: rapid7.insightvm.vulnerability.cvss.v3.user_interaction
      ignore_missing: true
  - rename:
      field: json.cvss_v3_vector
      target_field: rapid7.insightvm.vulnerability.cvss.v3.vector
      ignore_missing: true
  - convert:
      field: json.denial_of_service
      tag: 'convert_denial_of_service_to_boolean'
      target_field: rapid7.insightvm.vulnerability.denial_of_service
      if: ctx.json?.denial_of_service != ''
      type: boolean
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.description
      target_field: rapid7.insightvm.vulnerability.description
      ignore_missing: true
  - set:
      field: vulnerability.description
      copy_from: rapid7.insightvm.vulnerability.description
      ignore_empty_value: true
  - rename:
      field: json.exploits
      target_field: rapid7.insightvm.vulnerability.exploits
      ignore_missing: true
  - rename:
      field: json.id
      target_field: rapid7.insightvm.vulnerability.id
      ignore_missing: true
  - set:
      field: event.id
      copy_from: rapid7.insightvm.vulnerability.id
      ignore_empty_value: true
  - rename:
      field: json.links
      target_field: rapid7.insightvm.vulnerability.links
      ignore_missing: true
  - rename:
      field: json.malware_kits
      target_field: rapid7.insightvm.vulnerability.malware_kits
      ignore_missing: true
  - date:
      field: json.modified
      tag: 'date_set_timestamp'
      target_field: rapid7.insightvm.vulnerability.modified
      formats:
        - ISO8601
      if: ctx.json?.modified != null && ctx.json?.modified != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: '@timestamp'
      copy_from: rapid7.insightvm.vulnerability.modified
      ignore_empty_value: true
  - convert:
      field: json.pci_cvss_score
      tag: 'convert_pci_cvss_score_to_double'
      target_field: rapid7.insightvm.vulnerability.pci.cvss_score
      if: ctx.json?.pci_cvss_score != ''
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.pci_fail
      tag: 'convert_pci_fail_to_boolean'
      target_field: rapid7.insightvm.vulnerability.pci.fail
      if: ctx.json?.pci_fail != ''
      type: boolean
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.pci_severity_score
      tag: 'convert_pci_severity_score_to_long'
      target_field: rapid7.insightvm.vulnerability.pci.severity_score
      if: ctx.json?.pci_severity_score != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.pci_special_notes
      target_field: rapid7.insightvm.vulnerability.pci.special_notes
      ignore_missing: true
  - rename:
      field: json.pci_status
      target_field: rapid7.insightvm.vulnerability.pci.status
      ignore_missing: true
  - date:
      field: json.published
      tag: 'date_published'
      target_field: rapid7.insightvm.vulnerability.published
      formats:
        - ISO8601
      if: ctx.json?.published != null && ctx.json?.published != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.references
      target_field: rapid7.insightvm.vulnerability.references
      ignore_missing: true
  - set:
      field: vulnerability.reference
      copy_from: rapid7.insightvm.vulnerability.references
      ignore_empty_value: true
  - convert:
      field: json.risk_score
      tag: 'convert_risk_score_to_double'
      target_field: rapid7.insightvm.vulnerability.risk_score
      if: ctx.json?.risk_score != ''
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.risk_score
      copy_from: rapid7.insightvm.vulnerability.risk_score
      ignore_empty_value: true
  - script:
      description: Normalize event.risk_score to event.risk_score_norm
      lang: painless
      if: ctx.event?.risk_score != null
      ignore_failure: true
      source:
        def normalizedRiskScore = ctx.event.risk_score / 10.0;
        ctx.event.risk_score_norm = normalizedRiskScore;
  - rename:
      field: json.severity
      target_field: rapid7.insightvm.vulnerability.severity
      ignore_missing: true
  - set:
      field: vulnerability.severity
      copy_from: rapid7.insightvm.vulnerability.severity
      ignore_empty_value: true
  - convert:
      field: json.severity_score
      tag: 'convert_severity_score_to_long'
      target_field: rapid7.insightvm.vulnerability.severity_score
      if: ctx.json?.severity_score != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.severity
      copy_from: rapid7.insightvm.vulnerability.severity_score
      ignore_empty_value: true
  - rename:
      field: json.title
      target_field: rapid7.insightvm.vulnerability.title
      ignore_missing: true
  - remove:
      field: json
      ignore_missing: true
  - remove:
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      field:
        - rapid7.insightvm.vulnerability.modified
        - rapid7.insightvm.vulnerability.severity_score
        - rapid7.insightvm.vulnerability.categories
        - rapid7.insightvm.vulnerability.description
        - rapid7.insightvm.vulnerability.id
        - rapid7.insightvm.vulnerability.cves
        - rapid7.insightvm.vulnerability.references
        - rapid7.insightvm.vulnerability.cvss.v2.score
        - rapid7.insightvm.vulnerability.cvss.v3.score
        - rapid7.insightvm.vulnerability.severity
      ignore_missing: true
  - remove:
      field: event.original
      if: ctx.tags == null || !(ctx.tags.contains('preserve_original_event'))
      ignore_missing: true
  - script:
      lang: painless
      description: Drops null/empty values recursively.
      source: |-
        boolean drop(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(v -> drop(v));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(v -> drop(v));
            return (((List) object).length == 0);
          }
          return false;
        }
        drop(ctx);
  - set:
      field: event.kind
      value: pipeline_error
      if: ctx.error?.message != null
on_failure:
  - append:
      field: error.message
      value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
