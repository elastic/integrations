config_version: "2"
interval: {{interval}}
request.method: "GET"

{{#if zone_id}}
request.url: https://api.cloudflare.com/client/v4/zones/{{ zone_id }}/logs/received
{{/if}}
{{#if ssl}}
request.ssl: {{ssl}}
{{/if}}
{{#if http_client_timeout}}
request.timeout: {{http_client_timeout}}
{{/if}}

{{!-- request.rate_limit:
  limit: '[[.last_response.header.Get "X-Rate-Limit-Limit"]]'
  remaining: '[[.last_response.header.Get "X-Rate-Limit-Remaining"]]'
  reset: '[[.last_response.header.Get "X-Rate-Limit-Reset"]]' --}}
request.transforms:
  - set:
      target: header.X-Auth-Email
      value: "{{auth_email}}"
  - set:
      target: header.X-Auth-Key
      value: "{{auth_key}}"
  - set:
      target: url.params.start
      value: "[[.cursor.last_execution_datetime]]"
      default: '[[formatDate (now (parseDuration "-{{initial_interval}}"))]]'
  - set:
      target: url.params.end
      value: '[[formatDate now]]'

response.decode_as: application/x-ndjson
cursor:
  last_execution_datetime:
    value: "[[formatDate now]]"


{{#if tags.length}}
tags:
{{else if preserve_original_event}}
tags:
{{/if}}
{{#each tags as |tag i|}}
  - {{tag}}
{{/each}}
{{#if preserve_original_event}}
  - preserve_original_event
{{/if}}
{{#contains tags "forwarded"}}
publisher_pipeline.disable_host: true
{{/contains}}

fields:
  _conf:
    keep_original_message: {{keep_original_message}}
fields_under_root: true