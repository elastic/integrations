---
description: Pipeline for parsing Azure logs.
processors:
  - set:
      field: ecs.version
      value: "8.11.0"
  # TODO: we can remove this processor when https://github.com/elastic/beats/issues/40561
  # is fixed and released.
  - rename:
      field: azure
      target_field: azure-eventhub
      if: "ctx.azure?.eventhub != null"
      ignore_missing: true
  - set:
      field: event.kind
      value: event

  #
  # Set `event.dataset` value based on the event category.
  # ------------------------------------------------------
  #
  # In the `routing_rules.yml` file, we use the
  # `event.dataset` value to route the event to
  # the appropriate data stream.
  #

  - json:
      field: message
      target_field: tmp_json
      description: "Parses the message field as JSON and stores it in a temporary field to identify the event dataset."

  - rename:
      field: tmp_json.category
      target_field: routing.category
      ignore_missing: true
      description: "Set routing.category to tmp_json.category if it exists"

  # Unfortunately, some Azure services produce logs with field names capitalized,
  # violating the spec [1].
  #
  # We need to convert them to lowercase to properly identify the event dataset
  # and apply the correct routing rules.
  #
  # Note: the target data stream is responsible to deal with the capitalized names.
  #
  # [1]: https://learn.microsoft.com/en-us/azure/azure-monitor/platform/resource-logs-schema#top-level-common-schema
  - rename:
      field: tmp_json.Category
      target_field: routing.category
      if: "ctx.routing?.category == null"
      ignore_missing: true
      description: "Rename the invalid `Category` field to `category` to apply the correct routing rules."

  # Unfortunately, some Azure services generate logs with
  # `CategoryValue` field instead of `Category` field.
  #
  # We need to rename `CategoryValue` as `category` to
  # apply the correct routing rules.
  #
  # Refs;
  # - https://github.com/elastic/integrations/issues/15206
  - rename:
      field: tmp_json.CategoryValue
      target_field: routing.category
      if: ctx.routing?.category == null
      ignore_missing: true
      description: "Rename the invalid `CategoryValue` field to `category` to apply the correct routing rules."

  # Remove the temporary field used to identify the event dataset.
  - remove:
      field: tmp_json
      ignore_missing: true
      description: "Removes the temporary field used to identify the event dataset."

  # Defaults to azure.events if the `category` field is not present.
  - set:
      field: event.dataset
      value: azure.events
      description: "Sets the default event dataset."

  # Sets the event dataset based on the `category` field.
  - set:
      field: event.dataset
      value: azure.platformlogs
      if: "ctx.routing?.category != null"
      description: "If the event has a category field, we consider it a platform log."
  - set:
      field: event.dataset
      value: azure.activitylogs
      if: 'ctx.routing?.category == "Administrative" || ctx.routing?.category == "Security" || ctx.routing?.category == "ServiceHealth" || ctx.routing?.category == "Alert" || ctx.routing?.category == "Recommendation" || ctx.routing?.category == "Policy" || ctx.routing?.category == "Autoscale" || ctx.routing?.category == "ResourceHealth"'
  - set:
      field: event.dataset
      value: azure.application_gateway
      if: 'ctx.routing?.category == "ApplicationGatewayFirewallLog" || ctx.routing?.category == "ApplicationGatewayAccessLog"'
  - set:
      field: event.dataset
      value: azure.auditlogs
      if: 'ctx.routing?.category == "AuditLogs"'
  - set:
      field: event.dataset
      value: azure.firewall_logs
      if: 'ctx.routing?.category == "AzureFirewallApplicationRule" || ctx.routing?.category == "AzureFirewallNetworkRule" || ctx.routing?.category == "AzureFirewallDnsProxy" || ctx.routing?.category == "AZFWApplicationRule" || ctx.routing?.category == "AZFWNetworkRule" || ctx.routing?.category == "AZFWNatRule" || ctx.routing?.category == "AZFWDnsQuery"'
  - set:
      field: event.dataset
      value: azure.graphactivitylogs
      if: 'ctx.routing?.category == "MicrosoftGraphActivityLogs"'
  - set:
      field: event.dataset
      value: azure.identity_protection
      if: 'ctx.routing?.category == "RiskyUsers" || ctx.routing?.category == "UserRiskEvents"'
  - set:
      field: event.dataset
      value: azure.provisioning
      if: 'ctx.routing?.category == "ProvisioningLogs"'
  - set:
      field: event.dataset
      value: azure.signinlogs
      # Use same logic as the `signinlogs` stream that drops any document that doesn't end with `SignInLogs`.
      if: 'ctx.routing?.category.endsWith("SignInLogs")'
  - set:
      field: event.dataset
      value: azure.springcloudlogs
      if: 'ctx.routing?.category == "SystemLogs" || ctx.routing?.category == "ApplicationConsole" || ctx.routing?.category == "IngressLogs" || ctx.routing?.category == "BuildLogs" || ctx.routing?.category == "ContainerEventLogs"'
      description: "Azure Spring Apps log categories (refs: https://learn.microsoft.com/en-us/azure/azure-monitor/reference/supported-logs/microsoft-appplatform-spring-logs)"

#
#
# Error handling
#

on_failure:
  - set:
      field: error.message
      value: "{{ _ingest.on_failure_message }}"
