---
description: Pipeline for parsing Azure Provisioning logs.
processors:
  - set:
      field: ecs.version
      value: '8.5.0'
  - rename:
      field: azure
      target_field: azure-eventhub
      ignore_missing: true
  - script:
      source: ctx.message = ctx.message.replace(params.empty_field_name, '')
      params:
        empty_field_name: '"":"",'
      ignore_failure: true
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      if: 'ctx.event?.original == null'
      description: 'Renames the original `message` field to `event.original` to store a copy of the original message. The `event.original` field is not touched if the document already has one; it may happen when Logstash sends the document.'
  - remove:
      field: message
      ignore_missing: true
      if: 'ctx.event?.original != null'
      description: 'The `message` field is no longer required if the document has an `event.original` field.'
  - json:
      field: event.original
      target_field: azure.provisioninglogs
  - drop:
      description: Drop events that are not Azure Provisioning logs.
      if: ctx?.azure?.provisioninglogs?.category == null || ctx.azure.provisioninglogs.category != 'ProvisioningLogs'
  #
  # Common fields
  #      
  - date:
      field: azure.provisioninglogs.time
      target_field: '@timestamp'
      ignore_failure: true
      formats:
        - ISO8601
  - remove:
      field: azure.provisioninglogs.time
      ignore_missing: true
  - rename:
      field: azure.provisioninglogs.resourceId
      target_field: azure.resource_id
      ignore_missing: true
  - convert:
        field: azure.provisioninglogs.callerIpAddress
        target_field: source.ip
        type: ip
        ignore_missing: true
        on_failure:
        - rename: 
            field: azure.provisioninglogs.callerIpAddress
            target_field: source.address
            ignore_missing: true 
            ignore_failure: true
  - remove:
      field: azure.provisioninglogs.callerIpAddress
      if: 'ctx.source?.ip != null'
      ignore_missing: true
  - geoip:
      field: source.ip
      target_field: source.geo
      ignore_missing: true
  - geoip:
      database_file: GeoLite2-ASN.mmdb
      field: source.ip
      target_field: source.as
      properties:
        - asn
        - organization_name
      ignore_missing: true
  - rename:
      field: azure.provisioninglogs.durationMs
      target_field: event.duration
      ignore_missing: true
  - script:
      lang: painless
      source: if (ctx.event.duration!= null) {ctx.event.duration = ctx.event.duration
        * params.param_nano;}
      params:
        param_nano: 1000000
      ignore_failure: true
  - rename:
      field: azure.provisioninglogs.resultType
      target_field: azure.provisioninglogs.result_type
      ignore_missing: true
  - convert:
      field: azure.provisioninglogs.result_type
      target_field: event.outcome
      type: string
      if: "ctx?.azure?.provisioninglogs?.result_type != null && ctx.azure.provisioninglogs.result_type instanceof String && (ctx.azure.provisioninglogs.result_type.toLowerCase() == 'success' || ctx.azure.provisioninglogs.result_type.toLowerCase() == 'failure')"
  - rename:
      field: azure.provisioninglogs.operationName
      target_field: azure.provisioninglogs.operation_name
      ignore_missing: true
  - convert:
      field: azure.provisioninglogs.operation_name
      target_field: event.action
      type: string
      ignore_missing: true
  - rename:
      field: azure.provisioninglogs.operationVersion
      target_field: azure.provisioninglogs.operation_version
      ignore_missing: true
  - rename:
      field: azure.provisioninglogs.tenantId
      target_field: azure.tenant_id
      ignore_missing: true
  - rename:
      field: azure.provisioninglogs.Level
      target_field: azure.provisioninglogs.level
      ignore_missing: true
  - rename:
      field: azure.provisioninglogs.resultSignature
      target_field: azure.provisioninglogs.result_signature
      ignore_missing: true
  - rename:
      field: azure.provisioninglogs.correlationId
      target_field: azure.correlation_id
      ignore_missing: true
  #
  # Provisioning-related fields
  #
  - rename:
     field: azure.provisioninglogs.properties.tenantId
     target_field: azure.provisioninglogs.properties.tenant_id
     ignore_missing: true  
  - rename:
     field: azure.provisioninglogs.properties.activityDateTime
     target_field: azure.provisioninglogs.properties.activity_datetime
     ignore_missing: true  
  - rename:
     field: azure.provisioninglogs.properties.changeId
     target_field: azure.provisioninglogs.properties.change_id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.cycleId
     target_field: azure.provisioninglogs.properties.cycle_id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.durationInMilliseconds
     target_field: azure.provisioninglogs.properties.duration_ms
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.initiatedBy
     target_field: azure.provisioninglogs.properties.initiated_by
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.initiated_by.Id
     target_field: azure.provisioninglogs.properties.initiated_by.id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.initiated_by.Name
     target_field: azure.provisioninglogs.properties.initiated_by.name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.initiated_by.Type
     target_field: azure.provisioninglogs.properties.initiated_by.type
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.jobId
     target_field: azure.provisioninglogs.properties.job_id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.modifiedProperties
     target_field: azure.provisioninglogs.properties.modified_properties
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.modified_properties.displayName
     target_field: azure.provisioninglogs.properties.modified_properties.display_name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.modified_properties.newValue
     target_field: azure.provisioninglogs.properties.modified_properties.new_value
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.modified_properties.oldValue
     target_field: azure.provisioninglogs.properties.modified_properties.old_value
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.provisioningAction
     target_field: azure.provisioninglogs.properties.provisioning_action
     ignore_missing: true
  # provisioningStatusInfo
  # https://docs.microsoft.com/en-us/graph/api/resources/provisioningerrorinfo?view=graph-rest-1.0     
  - rename:
     field: azure.provisioninglogs.properties.provisioningStatusInfo
     target_field: azure.provisioninglogs.properties.provisioning_status_info
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.provisioning_status_info.Status
     target_field: azure.provisioninglogs.properties.provisioning_status_info.status
     ignore_missing: true
  - remove:
     field: azure.provisioninglogs.properties.provisioning_status_info.errorInformation
     ignore_missing: true
     if: "ctx?.azure?.provisioninglogs?.properties?.provisioning_status_info?.errorInformation == null"
     description: "Remove errorInformation if it is null to avoid field value parsing errors"
  - rename:
     field: azure.provisioninglogs.properties.provisioning_status_info.errorInformation
     target_field: azure.provisioninglogs.properties.provisioning_status_info.error_information
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.provisioning_status_info.error_information.additionalDetails
     target_field: azure.provisioninglogs.properties.provisioning_status_info.error_information.additional_details
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.provisioning_status_info.error_information.errorCategory
     target_field: azure.provisioninglogs.properties.provisioning_status_info.error_information.error_category
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.provisioning_status_info.error_information.errorCode
     target_field: azure.provisioninglogs.properties.provisioning_status_info.error_information.error_code
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.provisioning_status_info.error_information.recommendedAction
     target_field: azure.provisioninglogs.properties.provisioning_status_info.error_information.recommended_action
     ignore_missing: true

  # servicePrincipal
  # https://docs.microsoft.com/en-us/graph/api/resources/provisioningserviceprincipal?view=graph-rest-1.0
  - rename:
     field: azure.provisioninglogs.properties.servicePrincipal
     target_field: azure.provisioninglogs.properties.service_principal
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.service_principal.Id
     target_field: azure.provisioninglogs.properties.service_principal.id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.service_principal.Name
     target_field: azure.provisioninglogs.properties.service_principal.name
     ignore_missing: true
  # sourceIdentity
  # https://docs.microsoft.com/en-us/graph/api/resources/provisionedidentity?view=graph-rest-1.0
  - rename:
     field: azure.provisioninglogs.properties.sourceIdentity
     target_field: azure.provisioninglogs.properties.source_identity
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_identity.Id
     target_field: azure.provisioninglogs.properties.source_identity.id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_identity.Name
     target_field: azure.provisioninglogs.properties.source_identity.name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_identity.identityType
     target_field: azure.provisioninglogs.properties.source_identity.identity_type
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_identity.details.DisplayName
     target_field: azure.provisioninglogs.properties.source_identity.details.display_name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_identity.details.UserPrincipalName
     target_field: azure.provisioninglogs.properties.source_identity.details.user_principal_name
     ignore_missing: true
  # targetIdentity
  # https://docs.microsoft.com/en-us/graph/api/resources/provisionedidentity?view=graph-rest-1.0
  - rename:
     field: azure.provisioninglogs.properties.targetIdentity
     target_field: azure.provisioninglogs.properties.target_identity
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_identity.Id
     target_field: azure.provisioninglogs.properties.target_identity.id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_identity.Name
     target_field: azure.provisioninglogs.properties.target_identity.name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_identity.identityType
     target_field: azure.provisioninglogs.properties.target_identity.identity_type
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_identity.details.DisplayName
     target_field: azure.provisioninglogs.properties.target_identity.details.display_name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_identity.details.UserPrincipalName
     target_field: azure.provisioninglogs.properties.target_identity.details.user_principal_name
     ignore_missing: true
  # sourceSystem
  # https://docs.microsoft.com/en-us/graph/api/resources/provisioningsystem?view=graph-rest-1.0
  - rename:
     field: azure.provisioninglogs.properties.sourceSystem
     target_field: azure.provisioninglogs.properties.source_system
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_system.Id
     target_field: azure.provisioninglogs.properties.source_system.id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_system.Name
     target_field: azure.provisioninglogs.properties.source_system.name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_system.details.ApplicationId
     target_field: azure.provisioninglogs.properties.source_system.details.application_id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_system.details.ServicePrincipalDisplayName
     target_field: azure.provisioninglogs.properties.source_system.details.dervice_principal_display_name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.source_system.details.ServicePrincipalId
     target_field: azure.provisioninglogs.properties.source_system.details.service_principal_id
     ignore_missing: true
  # targetSystem
  # https://docs.microsoft.com/en-us/graph/api/resources/provisioningsystem?view=graph-rest-1.0
  - rename:
     field: azure.provisioninglogs.properties.targetSystem
     target_field: azure.provisioninglogs.properties.target_system
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_system.Id
     target_field: azure.provisioninglogs.properties.target_system.id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_system.Name
     target_field: azure.provisioninglogs.properties.target_system.name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_system.details.ApplicationId
     target_field: azure.provisioninglogs.properties.target_system.details.application_id
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_system.details.ServicePrincipalDisplayName
     target_field: azure.provisioninglogs.properties.target_system.details.dervice_principal_display_name
     ignore_missing: true
  - rename:
     field: azure.provisioninglogs.properties.target_system.details.ServicePrincipalId
     target_field: azure.provisioninglogs.properties.target_system.details.service_principal_id
     ignore_missing: true
  # statusInfo
#   - rename:
#      field: azure.provisioninglogs.properties.statusInfo
#      target_field: azure.provisioninglogs.properties.status_info
#      ignore_missing: true
  - remove:
     field: azure.provisioninglogs.properties.statusInfo
     description: |
        It looks like statusInfo contains the same information as provisioningStatusInfo, so we remove it. The statusInfo field is not documented at https://docs.microsoft.com/en-us/azure/azure-monitor/reference/tables/aadprovisioninglogs.
     ignore_missing: true
  # provisioningSteps
  # https://docs.microsoft.com/en-us/graph/api/resources/provisioningstep?view=graph-rest-1.0
  - rename:
     field: azure.provisioninglogs.properties.provisioningSteps
     target_field: azure.provisioninglogs.properties.provisioning_steps
     ignore_missing: true
  - foreach:
      field: azure.provisioninglogs.properties.provisioning_steps
      ignore_missing: true
      processor:
        rename:
          field: _ingest._value.provisioningStepType
          target_field: _ingest._value.provisioning_step_type
          ignore_missing: true
        # set:
        #   field: _ingest._value.provisioning_step_type
        # value: "{{_ingest._value.provisioningStepType}}"
        #   ignore_missing: true
        # script:
        #   lang: painless
        #   if: ctx._ingest.provisioningStepType instanceof Long
        #   source: |
        #     def status = ctx._ingest.provisioningStepType;
        #     if (status == 0) {
        #      ctx._ingest.provisioning_step_type = "success";
        #     } else if (status == 1) {
        #      ctx._ingest.provisioning_step_type = "failure";
        #     } else if (status == 2) {
        #      ctx._ingest.provisioning_step_type = "warning";
        #     } else {
        #      ctx._ingest.provisioning_step_type = "unknown";
        #       }

#   - remove:
#       field: azure.provisioninglogs.properties.provisioning_status_info.Status
#       ignore_missing: true

  - rename:
     field: azure.provisioninglogs.properties.activityDateTime
     target_field: azure.provisioninglogs.properties.activity_datetime
     ignore_missing: true
  - set:
      field: event.kind
      value: event
  - pipeline:
      name: '{{ IngestPipeline "azure-shared-pipeline" }}'
  - remove:
      field: event.original
      if: "ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))"
      ignore_failure: true
      ignore_missing: true
on_failure:
  - set:
      field: error.message
      value: |-
        Processor "{{ _ingest.on_failure_processor_type }}" with tag "{{ _ingest.on_failure_processor_tag }}" in pipeline "{{ _ingest.on_failure_pipeline }}" failed with message "{{ _ingest.on_failure_message }}"
