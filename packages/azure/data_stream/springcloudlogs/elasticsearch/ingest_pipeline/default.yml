---
description: Pipeline for parsing azure spring cloud logs.
processors:
  - set:
      field: event.ingested
      value: '{{_ingest.timestamp}}'
  - set:
      field: ecs.version
      value: "1.10.0"
  - rename:
      field: azure
      target_field: azure-eventhub
      ignore_missing: true
  - script:
      source: ctx.message = ctx.message.replace(params.empty_field_name, '')
      params:
        empty_field_name: '"":"",'
      ignore_failure: true
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
  - json:
      field: event.original
      target_field: azure.springcloudlogs
  - date:
      field: azure.springcloudlogs.time
      target_field: '@timestamp'
      ignore_failure: true
      formats:
        - ISO8601
  - remove:
      field: azure.springcloudlogs.time
      ignore_missing: true
  - rename:
      field: azure.springcloudlogs.resourceId
      target_field: azure.resource_id
      ignore_missing: true
  - rename:
      field: azure.springcloudlogs.Region
      target_field: cloud.region
      ignore_missing: true
  - json:
      field: azure.springcloudlogs.properties.log
      target_field: azure.springcloudlogs.properties.log
      ignore_failure: true
  - rename:
      field: azure.springcloudlogs.EventName
      target_field: event.action
      ignore_missing: true
  - grok:
      field: azure.springcloudlogs.callerIpAddress
      patterns:
        - \[%{IPORHOST:source.ip}\]:%{INT:source.port:int}
        - "%{IPORHOST:source.ip}:%{INT:source.port:int}"
        - "%{IPORHOST:source.ip}"
      ignore_missing: true
      ignore_failure: true
  - remove:
      field: azure.springcloudlogs.callerIpAddress
      if: 'ctx.source?.ip != null'
      ignore_missing: true
  - set:
      field: client.ip
      value: '{{source.ip}}'
      ignore_empty_value: true
  - append:
      field: related.ip
      value: '{{source.ip}}'
      allow_duplicates: false
      if: 'ctx.source?.ip != null'
  - rename:
      field: azure.springcloudlogs.level
      target_field: log.level
      ignore_missing: true
  - rename:
      field: azure.springcloudlogs.durationMs
      target_field: event.duration
      ignore_missing: true
  - rename:
      field: azure.springcloudlogs.location
      target_field: geo.name
      ignore_missing: true
  - set:
      field: event.kind
      value: event
  - pipeline:
      name: '{{ IngestPipeline "azure-shared-pipeline" }}'
  - remove:
      field: event.original
      if: "ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))"
      ignore_failure: true
      ignore_missing: true
on_failure:
- set:
    field: error.message
    value: '{{ _ingest.on_failure_message }}'
