---
description: Pipeline for processing Azure Firewall DNS proxy rule logs.
processors:
  - grok:
      field: json.properties.msg
      patterns:
        - "^DNS Request: %{IPORHOST:source.address}:%{NUMBER:source.port:long} - %{DATA:azure.firewall.event_original_uid} %{DATA:dns.question.type} %{DATA:dns.question.class} %{DATA:dns.question.name}. %{DATA:network.transport} %{NUMBER:source.bytes:long} %{DATA:azure.firewall.dnssec_bool_flag:boolean} %{NUMBER:azure.firewall.dnssec_buffer_size:long} %{DATA:dns.response_code} %{DATA:dns.header_flags} %{NUMBER:destination.bytes:long} %{DATA:azure.firewall.duration}$"

  - grok:
      field: source.address
      patterns:
        - "%{IP:source.ip}"
        - "%{HOSTNAME:source.domain}"
      ignore_missing: true
      
  - geoip:
      database_file: GeoLite2-ASN.mmdb
      field: source.ip
      target_field: source.as
      properties:
        - asn
        - organization_name
      ignore_missing: true
  - rename:
      field: source.as.asn
      target_field: source.as.number
      ignore_missing: true
  - rename:
      field: source.as.organization_name
      target_field: source.as.organization.name
      ignore_missing: true
  - uppercase:
      field: dns.header_flags
      "ignore_missing": true
  - split:
      field: dns.header_flags
      separator: ","
      ignore_missing: true
  - convert:
      field: source.bytes
      type: long
      ignore_missing: true
  - convert:
      field: destination.bytes
      type: long
      ignore_missing: true
  - convert:
      field: azure.firewall.dnssec_bool_flag
      type: boolean
      ignore_missing: true
  - convert:
      field: azure.firewall.dnssec_buffer_size
      type: long
      ignore_missing: true


on_failure:
  - append:
      field: error.message
      value: >-
        error in DNS Proxy pipeline:
        error in [{{_ingest.on_failure_processor_type}}] processor{{#_ingest.on_failure_processor_tag}}
        with tag [{{_ingest.on_failure_processor_tag }}]{{/_ingest.on_failure_processor_tag}}
        {{ _ingest.on_failure_message }}