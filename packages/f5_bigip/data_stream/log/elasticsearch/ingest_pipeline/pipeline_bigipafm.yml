---
description: Pipeline for F5 BIG-IP Advanced Firewall Manager logs.
processors:
  - date:
      field: json.date_time
      target_field: f5_bigip.log.date_time
      if: ctx.json?.date_time != null && ctx.json.date_time != ''
      formats:
        - MMM dd yyyy HH:mm:ss
        - ISO8601
      on_failure:
      - append:
          field: error.message
          value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: '@timestamp'
      copy_from: f5_bigip.log.date_time
      ignore_failure: true
  - convert:
      field: json.dest_ip
      target_field: f5_bigip.log.dest.ip
      if: ctx.json?.dest_ip != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: destination.ip
      copy_from: f5_bigip.log.dest.ip
      ignore_failure: true
  - append:
      field: related.ip
      value: '{{{destination.ip}}}'
      allow_duplicates: false
      ignore_failure: true
  - convert:
      field: json.dest_port
      target_field: f5_bigip.log.dest.port
      if: ctx.json?.dest_port != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: destination.port
      copy_from: f5_bigip.log.dest.port
      ignore_failure: true
  - rename:
      field: json.action
      target_field: f5_bigip.log.action
      ignore_missing: true
  - set:
      field: event.action
      copy_from: f5_bigip.log.action
      ignore_failure: true
  - convert:
      field: json.severity
      target_field: f5_bigip.log.severity.code
      if: ctx.json?.severity != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: event.severity
      copy_from: f5_bigip.log.severity.code
      ignore_failure: true
  - rename:
      field: json.ip_protocol
      target_field: f5_bigip.log.ip_protocol
      ignore_missing: true
  - set:
      field: network.transport
      copy_from: f5_bigip.log.ip_protocol
      ignore_failure: true
  - lowercase:
      field: network.transport
      ignore_failure: true
  - convert:
      field: json.source_ip
      target_field: f5_bigip.log.source.ip
      if: ctx.json?.source_ip != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: source.ip
      copy_from: f5_bigip.log.source.ip
      ignore_failure: true
  - append:
      field: related.ip
      value: '{{{source.ip}}}'
      allow_duplicates: false
      ignore_failure: true
  - convert:
      field: json.source_port
      target_field: f5_bigip.log.source.port
      if: ctx.json?.source_port != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: source.port
      copy_from: f5_bigip.log.source.port
      ignore_failure: true
  - rename:
      field: json.source_user_group
      target_field: f5_bigip.log.source.user_group
      ignore_missing: true
  - set:
      field: source.user.group.name
      copy_from: f5_bigip.log.source.user_group
      ignore_failure: true
  - rename:
      field: json.source_user
      target_field: f5_bigip.log.source.user
      ignore_missing: true
  - set:
      field: source.user.name
      copy_from: f5_bigip.log.source.user
      ignore_failure: true
  - append:
      field: related.user
      value: '{{{source.user.name}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.acl_policy_name
      target_field: f5_bigip.log.acl.policy.name
      ignore_missing: true
  - rename:
      field: json.acl_policy_type
      target_field: f5_bigip.log.acl.policy.type
      ignore_missing: true
  - rename:
      field: json.acl_rule_name
      target_field: f5_bigip.log.acl.rule.name
      ignore_missing: true
  - convert:
      field: json.bigip_mgmt_ip
      target_field: f5_bigip.log.mgmt_ip
      if: ctx.json?.bigip_mgmt_ip != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      value: '{{{f5_bigip.log.mgmt_ip}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.context_name
      target_field: f5_bigip.log.context.name
      ignore_missing: true
  - rename:
      field: json.context_type
      target_field: f5_bigip.log.context.type
      ignore_missing: true
  - rename:
      field: json.dest_fqdn
      target_field: f5_bigip.log.dest.fqdn
      ignore_missing: true
  - set:
      field: destination.domain
      copy_from: f5_bigip.log.dest.fqdn
      ignore_failure: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.dest.fqdn}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.device_product
      target_field: f5_bigip.log.device.product
      ignore_missing: true
  - rename:
      field: json.device_vendor
      target_field: f5_bigip.log.device.vendor
      ignore_missing: true
  - rename:
      field: json.device_version
      target_field: f5_bigip.log.device.version
      ignore_missing: true
  - rename:
      field: json.drop_reason
      target_field: f5_bigip.log.drop_reason
      ignore_missing: true
  - rename:
      field: json.dst_geo
      target_field: f5_bigip.log.dst.geo
      ignore_missing: true
  - rename:
      field: json.errdefs_msg_name
      target_field: f5_bigip.log.errdefs.msg_name
      ignore_missing: true
  - rename:
      field: json.errdefs_msgno
      target_field: f5_bigip.log.errdefs.msgno
      ignore_missing: true
  - rename:
      field: json.flow_id
      target_field: f5_bigip.log.flow.id
      ignore_missing: true
  - rename:
      field: json.partition_name
      target_field: f5_bigip.log.partition_name
      ignore_missing: true
  - rename:
      field: json.route_domain
      target_field: f5_bigip.log.route_domain
      ignore_missing: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.route_domain}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.sa_translation_pool
      target_field: f5_bigip.log.sa_translation.pool
      ignore_missing: true
  - rename:
      field: json.sa_translation_type
      target_field: f5_bigip.log.sa_translation.type
      ignore_missing: true
  - rename:
      field: json.send_to_vs
      target_field: f5_bigip.log.send_to_vs
      ignore_missing: true
  - rename:
      field: json.source_fqdn
      target_field: f5_bigip.log.source.fqdn
      ignore_missing: true
  - set:
      field: source.domain
      copy_from: f5_bigip.log.source.fqdn
      ignore_failure: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.source.fqdn}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.src_geo
      target_field: f5_bigip.log.src.geo
      ignore_missing: true
  - rename:
      field: json.telemetryEventCategory
      target_field: f5_bigip.log.telemetry.event.category
      ignore_missing: true
  - rename:
      field: json.tenant
      target_field: f5_bigip.log.tenant
      ignore_missing: true
  - convert:
      field: json.translated_dest_ip
      target_field: f5_bigip.log.translated.dest.ip
      if: ctx.json?.translated_dest_ip != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      value: '{{{f5_bigip.log.translated.dest.ip}}}'
      allow_duplicates: false
      ignore_failure: true
  - convert:
      field: json.translated_dest_port
      target_field: f5_bigip.log.translated.dest.port
      if: ctx.json?.translated_dest_port != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.translated_ip_protocol
      target_field: f5_bigip.log.translated.ip_protocol
      ignore_missing: true
  - rename:
      field: json.translated_route_domain
      target_field: f5_bigip.log.translated.route_domain
      ignore_missing: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.translated.route_domain}}}'
      allow_duplicates: false
      ignore_failure: true
  - convert:
      field: json.translated_source_ip
      target_field: f5_bigip.log.translated.source.ip
      if: ctx.json?.translated_source_ip != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      value: '{{{f5_bigip.log.translated.source.ip}}}'
      allow_duplicates: false
      ignore_failure: true
  - convert:
      field: json.translated_source_port
      target_field: f5_bigip.log.translated.source.port
      if: ctx.json?.translated_source_port != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.translated_vlan
      target_field: f5_bigip.log.translated.vlan
      ignore_missing: true
  - rename:
      field: json.acl_rule_uuid
      target_field: f5_bigip.log.acl.rule.uuid
      ignore_missing: true
  - rename:
      field: json.src_zone
      target_field: f5_bigip.log.src.zone
      ignore_missing: true
  - rename:
      field: json.dest_ipint_categories
      target_field: f5_bigip.log.dest.ipint_categories
      ignore_missing: true
  - rename:
      field: json.dest_vlan
      target_field: f5_bigip.log.dest.vlan
      ignore_missing: true
  - rename:
      field: json.dest_zone
      target_field: f5_bigip.log.dest.zone
      ignore_missing: true
  - rename:
      field: json.source_ipint_categories
      target_field: f5_bigip.log.source.ipint_categories
      ignore_missing: true
  - rename:
      field: json.vlan
      target_field: f5_bigip.log.vlan
      ignore_missing: true
  - remove:
      field: json
      ignore_missing: true
  - remove:
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      field:
        - f5_bigip.log.date_time
        - f5_bigip.log.dest.ip
        - f5_bigip.log.dest.port
        - f5_bigip.log.action
        - f5_bigip.log.hostname
        - f5_bigip.log.severity.code
        - f5_bigip.log.dest.fqdn
        - f5_bigip.log.source.fqdn
        - f5_bigip.log.application.name
        - f5_bigip.log.ip_protocol
        - f5_bigip.log.source.ip
        - f5_bigip.log.source.port
        - f5_bigip.log.source.user_group
        - f5_bigip.log.source.user
      ignore_failure: true
      ignore_missing: true
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: '{{{ _ingest.on_failure_message }}}'