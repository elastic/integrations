---
description: Pipeline for F5 BIG-IP Application Security Manager logs.
processors:
  - date:
      field: json.date_time
      target_field: f5_bigip.log.date_time
      if: ctx.json?.date_time != null && ctx.json.date_time != ''
      formats:
        - yyyy-MM-dd HH:mm:ss
        - ISO8601
      on_failure:
      - append:
          field: error.message
          value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: '@timestamp'
      copy_from: f5_bigip.log.date_time
      ignore_failure: true
  - convert:
      field: json.ip_client
      target_field: f5_bigip.log.client.ip
      if: ctx.json?.ip_client != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: client.ip
      copy_from: f5_bigip.log.client.ip
      ignore_failure: true
  - append:
      field: related.ip
      value: '{{{client.ip}}}'
      allow_duplicates: false
      ignore_failure: true
  - convert:
      field: json.dest_ip
      target_field: f5_bigip.log.dest.ip
      if: ctx.json?.dest_ip != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: destination.ip
      copy_from: f5_bigip.log.dest.ip
      ignore_failure: true
  - append:
      field: related.ip
      value: '{{{destination.ip}}}'
      allow_duplicates: false
      ignore_failure: true
  - convert:
      field: json.dest_port
      target_field: f5_bigip.log.dest.port
      if: ctx.json?.dest_port != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: destination.port
      copy_from: f5_bigip.log.dest.port
      ignore_failure: true
  - rename:
      field: json.geo_location
      target_field: f5_bigip.log.geo.location
      ignore_missing: true
  - set:
      field: host.geo.country_iso_code
      copy_from: f5_bigip.log.geo.location
      ignore_failure: true
  - rename:
      field: json.device_id
      target_field: f5_bigip.log.device.id
      ignore_missing: true
  - set:
      field: host.id
      copy_from: f5_bigip.log.device.id
      ignore_failure: true
  - append:
      field: related.hosts
      value: '{{{host.id}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.method
      target_field: f5_bigip.log.method
      ignore_missing: true
  - set:
      field: http.request.method
      copy_from: f5_bigip.log.method
      ignore_failure: true
  - rename:
      field: json.severity
      target_field: f5_bigip.log.severity.name
      ignore_missing: true
  - set:
      field: log.level
      copy_from: f5_bigip.log.severity.name
      ignore_failure: true
  - lowercase:
      field: log.level
      ignore_failure: true
  - rename:
      field: json.protocol
      target_field: f5_bigip.log.protocol
      ignore_missing: true
  - set:
      field: network.protocol
      copy_from: f5_bigip.log.protocol
      ignore_failure: true
  - lowercase:
      field: network.protocol
      ignore_failure: true
  - convert:
      field: json.src_port
      target_field: f5_bigip.log.src.port
      if: ctx.json?.src_port != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: source.port
      copy_from: f5_bigip.log.src.port
      ignore_failure: true
  - rename:
      field: json.username
      target_field: f5_bigip.log.username
      ignore_missing: true
  - set:
      field: user.name
      copy_from: f5_bigip.log.username
      ignore_failure: true
  - append:
      field: related.user
      value: '{{{user.name}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.attack_type
      target_field: f5_bigip.log.attack.type
      ignore_missing: true
  - rename:
      field: json.blocking_exception_reason
      target_field: f5_bigip.log.blocking_exception_reason
      ignore_missing: true
  - rename:
      field: json.captcha_result
      target_field: f5_bigip.log.captcha_result
      ignore_missing: true
  - rename:
      field: json.fragment
      target_field: f5_bigip.log.fragment
      ignore_missing: true
  - rename:
      field: json.http_class_name
      target_field: f5_bigip.log.http.class_name
      ignore_missing: true
  - rename:
      field: json.ip_address_intelligence
      target_field: f5_bigip.log.ip_address_intelligence
      ignore_missing: true
  - convert:
      field: json.management_ip_address
      target_field: f5_bigip.log.management.ip_address
      if: ctx.json?.management_ip_address != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      value: '{{{f5_bigip.log.management.ip_address}}}'
      allow_duplicates: false
      ignore_failure: true
  - convert:
      field: json.management_ip_address_2
      target_field: f5_bigip.log.management.ip_address_2
      if: ctx.json?.management_ip_address_2 != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      value: '{{{f5_bigip.log.management.ip_address_2}}}'
      allow_duplicates: false
      ignore_failure: true
  - date:
      field: json.policy_apply_date
      target_field: f5_bigip.log.policy.apply_date
      if: ctx.json?.policy_apply_date != null && ctx.json.policy_apply_date != ''
      formats:
        - yyyy-MM-dd HH:mm:ss
      on_failure:
      - append:
          field: error.message
          value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.policy_name
      target_field: f5_bigip.log.policy.name
      ignore_missing: true
  - rename:
      field: json.query_string
      target_field: f5_bigip.log.query.string
      ignore_missing: true
  - rename:
      field: json.request
      target_field: f5_bigip.log.request.detail
      ignore_missing: true
  - rename:
      field: json.request_status
      target_field: f5_bigip.log.request.status
      ignore_missing: true
  - convert:
      field: json.response_code
      target_field: f5_bigip.log.response.code
      if: ctx.json?.response_code != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.route_domain
      target_field: f5_bigip.log.route_domain
      ignore_missing: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.route_domain}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.session_id
      target_field: f5_bigip.log.session.id
      ignore_missing: true
  - rename:
      field: json.sig_ids
      target_field: f5_bigip.log.sig.ids
      ignore_missing: true
  - rename:
      field: json.sig_names
      target_field: f5_bigip.log.sig.names
      ignore_missing: true
  - rename:
      field: json.staged_sig_ids
      target_field: f5_bigip.log.staged.sig.ids
      ignore_missing: true
  - rename:
      field: json.staged_sig_names
      target_field: f5_bigip.log.staged.sig.names
      ignore_missing: true
  - rename:
      field: json.staged_threat_campaign_names
      target_field: f5_bigip.log.staged.threat_campaign_names
      ignore_missing: true
  - rename:
      field: json.sub_violations
      target_field: f5_bigip.log.sub_violations
      ignore_missing: true
  - rename:
      field: json.support_id
      target_field: f5_bigip.log.support.id
      ignore_missing: true
  - rename:
      field: json.telemetryEventCategory
      target_field: f5_bigip.log.telemetry.event.category
      ignore_missing: true
  - rename:
      field: json.tenant
      target_field: f5_bigip.log.tenant
      ignore_missing: true
  - rename:
      field: json.threat_campaign_names
      target_field: f5_bigip.log.threat_campaign_names
      ignore_missing: true
  - rename:
      field: json.uri
      target_field: f5_bigip.log.uri
      ignore_missing: true
  - convert:
      field: json.violation_rating
      target_field: f5_bigip.log.violation.rating
      if: ctx.json?.violation_rating != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.violations
      target_field: f5_bigip.log.violations
      ignore_missing: true
  - rename:
      field: json.virus_name
      target_field: f5_bigip.log.virus_name
      ignore_missing: true
  - rename:
      field: json.web_application_name
      target_field: f5_bigip.log.web_application_name
      ignore_missing: true
  - rename:
      field: json.websocket_direction
      target_field: f5_bigip.log.websocket.direction
      ignore_missing: true
  - rename:
      field: json.websocket_message_type
      target_field: f5_bigip.log.websocket.message_type
      ignore_missing: true
  - convert:
      field: json.x_forwarded_for_header_value
      target_field: f5_bigip.log.x_forwarded_for_header_value
      if: ctx.json?.x_forwarded_for_header_value != ''
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      value: '{{{f5_bigip.log.x_forwarded_for_header_value}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.geo_info
      target_field: f5_bigip.log.geo.info
      ignore_missing: true
  - rename:
      field: json.headers
      target_field: f5_bigip.log.headers
      ignore_missing: true
  - rename:
      field: json.ip_route_domain
      target_field: f5_bigip.log.ip_route_domain
      ignore_missing: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.ip_route_domain}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.is_trunct
      target_field: f5_bigip.log.is_trunct
      ignore_missing: true
  - rename:
      field: json.resp
      target_field: f5_bigip.log.resp
      ignore_missing: true
  - rename:
      field: json.unit_host
      target_field: f5_bigip.log.unit_host
      ignore_missing: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.unit_host}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.violate_details
      target_field: f5_bigip.log.violate_details
      ignore_missing: true
  - rename:
      field: json.microservice
      target_field: f5_bigip.log.microservice
      ignore_missing: true
  - rename:
      field: json.response
      target_field: f5_bigip.log.response.value
      ignore_missing: true
  - rename:
      field: json.sig_cves
      target_field: f5_bigip.log.sig.cves
      ignore_missing: true
  - rename:
      field: json.staged_sig_cves
      target_field: f5_bigip.log.staged.sig.cves
      ignore_missing: true
  - rename:
      field: json.tap_event_id
      target_field: f5_bigip.log.tap.event_id
      ignore_missing: true
  - rename:
      field: json.tap_vid
      target_field: f5_bigip.log.tap.vid
      ignore_missing: true
  - rename:
      field: json.vs_name
      target_field: f5_bigip.log.vs_name
      ignore_missing: true
  - rename:
      field: json.compression_method
      target_field: f5_bigip.log.compression_method
      ignore_missing: true
  - rename:
      field: json.client_type
      target_field: f5_bigip.log.client.type
      ignore_missing: true
  - rename:
      field: json.conviction_traps
      target_field: f5_bigip.log.conviction_traps
      ignore_missing: true
  - rename:
      field: json.credential_stuffing_lookup_result
      target_field: f5_bigip.log.credential_stuffing_lookup_result
      ignore_missing: true
  - rename:
      field: json.enforced_by
      target_field: f5_bigip.log.enforced_by
      ignore_missing: true
  - rename:
      field: json.enforcement_action
      target_field: f5_bigip.log.enforcement_action
      ignore_missing: true
  - date:
      field: json.epoch_time
      target_field: f5_bigip.log.epoch_time
      if: ctx.json?.epoch_time != null && ctx.json.epoch_time != ''
      formats:
        - UNIX
      on_failure:
      - append:
          field: error.message
          value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.ip_with_route_domain
      target_field: f5_bigip.log.ip_with_route_domain
      ignore_missing: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.ip_with_route_domain}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.is_truncated
      target_field: f5_bigip.log.is_truncated
      ignore_missing: true
  - rename:
      field: json.likely_false_positive_sig_ids
      target_field: f5_bigip.log.likely_false_positive_sig_ids
      ignore_missing: true
  - rename:
      field: json.login_result
      target_field: f5_bigip.log.login_result
      ignore_missing: true
  - rename:
      field: json.mobile_application_name
      target_field: f5_bigip.log.mobile_application.name
      ignore_missing: true
  - rename:
      field: json.mobile_application_version
      target_field: f5_bigip.log.mobile_application.version
      ignore_missing: true
  - rename:
      field: json.operation_id
      target_field: f5_bigip.log.operation.id
      ignore_missing: true
  - rename:
      field: json.password_hash_prefix
      target_field: f5_bigip.log.password_hash_prefix
      ignore_missing: true
  - rename:
      field: json.protocol_info
      target_field: f5_bigip.log.protocol_info
      ignore_missing: true
  - rename:
      field: json.sig_set_names
      target_field: f5_bigip.log.sig.set_names
      ignore_missing: true
  - convert:
      field: json.slot_number
      target_field: f5_bigip.log.slot.number
      if: ctx.json?.slot_number != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.staged_sig_set_names
      target_field: f5_bigip.log.staged.sig.set_names
      ignore_missing: true
  - rename:
      field: json.tap_requested_actions
      target_field: f5_bigip.log.tap.requested_actions
      ignore_missing: true
  - convert:
      field: json.tap_sent_token
      target_field: f5_bigip.log.tap.sent_token
      if: ctx.json?.tap_sent_token != ''
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.tap_transaction_id
      target_field: f5_bigip.log.tap.transaction_id
      ignore_missing: true
  - rename:
      field: json.unit_hostname
      target_field: f5_bigip.log.unit_hostname
      ignore_missing: true
  - append:
      field: related.hosts
      value: '{{{f5_bigip.log.unit_hostname}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.violation_details
      target_field: f5_bigip.log.violation.details
      ignore_missing: true
  - remove:
      field: json
      ignore_missing: true
  - remove:
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      field:
        - f5_bigip.log.date_time
        - f5_bigip.log.client.ip
        - f5_bigip.log.dest.ip
        - f5_bigip.log.dest.port
        - f5_bigip.log.geo.location
        - f5_bigip.log.device.id
        - f5_bigip.log.hostname
        - f5_bigip.log.method
        - f5_bigip.log.protocol
        - f5_bigip.log.src.port
        - f5_bigip.log.severity.name
        - f5_bigip.log.username
        - f5_bigip.log.application.name
      ignore_failure: true
      ignore_missing: true
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: '{{{ _ingest.on_failure_message }}}'
