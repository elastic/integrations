{
  "id": "high_disk_io_latency",
  "type": "alerting_rule_template",
  "attributes": {
    "name": "[System] High Disk I/O Latency",
    "tags": ["System"],
    "ruleTypeId": ".es-query",
    "schedule": {
      "interval": "1m"
    },
    "params": {
      "searchType": "esqlQuery",
      "timeWindowSize": 5,
      "timeWindowUnit": "m",
      "esqlQuery": {
        "esql": "// Alert when average disk I/O latency exceeds storage-type thresholds within the 5 minute lookback.\n// Groups by host and device, excludes loop/ram/sr/dm devices, and clamps counter resets.\n// Adjust latency thresholds in the final WHERE clause as needed.\nFROM metrics-system.diskio-*\n| WHERE @timestamp >= NOW() - 5 MINUTES\n  AND system.diskio.name NOT RLIKE \"(loop|ram|sr|dm-)\"\n| STATS\n    read_time_delta = MAX(system.diskio.read.time) - MIN(system.diskio.read.time),\n    write_time_delta = MAX(system.diskio.write.time) - MIN(system.diskio.write.time),\n    read_ops_delta = MAX(system.diskio.read.count) - MIN(system.diskio.read.count),\n    write_ops_delta = MAX(system.diskio.write.count) - MIN(system.diskio.write.count),\n    first_ts = MIN(@timestamp),\n    last_ts = MAX(@timestamp)\n  BY host.name, system.diskio.name\n| EVAL elapsed_ms = TO_DOUBLE(TO_LONG(last_ts) - TO_LONG(first_ts))\n| WHERE elapsed_ms >= 60000\n| EVAL read_time_delta = CASE(read_time_delta >= 0, read_time_delta, 0)\n| EVAL write_time_delta = CASE(write_time_delta >= 0, write_time_delta, 0)\n| EVAL read_ops_delta = CASE(read_ops_delta >= 0, read_ops_delta, 0)\n| EVAL write_ops_delta = CASE(write_ops_delta >= 0, write_ops_delta, 0)\n| EVAL total_ops = read_ops_delta + write_ops_delta\n| WHERE total_ops >= 100\n| EVAL io_time_ms = read_time_delta + write_time_delta\n| WHERE io_time_ms > 0\n| EVAL avg_latency_ms = io_time_ms / TO_DOUBLE(total_ops)\n| EVAL avg_iops = total_ops / (elapsed_ms / 1000)\n| EVAL device_type = CASE(\n    system.diskio.name RLIKE \"^nvme[0-9]\", \"ssd\",\n    avg_latency_ms < 3 AND avg_iops > 100, \"ssd\",\n    avg_latency_ms > 15, \"hdd\",\n    \"unknown\"\n  )\n| WHERE (device_type == \"ssd\" AND avg_latency_ms > 5)\n    OR (device_type == \"hdd\" AND avg_latency_ms > 30)\n    OR (device_type == \"unknown\" AND avg_latency_ms > 10)"
      },
      "groupBy": "row",
      "timeField": "@timestamp"
    },
    "alertDelay": {
      "active": 3
    }
  },
  "managed": true,
  "coreMigrationVersion": "8.8.0",
  "typeMigrationVersion": "10.1.0"
}
