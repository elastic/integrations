{
    "id": "high_disk_io_latency",
    "type": "alerting_rule_template",
    "attributes": {
        "name": "[System] High Disk I/O Latency",
        "tags": [
            "System"
        ],
        "ruleTypeId": ".es-query",
        "schedule": {
            "interval": "1m"
        },
        "params": {
            "searchType": "esqlQuery",
            "timeWindowSize": 5,
            "timeWindowUnit": "m",
            "esqlQuery": {
                "esql": "// Alert when average disk I/O latency exceeds storage-type thresholds within the configured lookback window.\n// Groups by host and device, excludes loop/ram/sr/dm devices, and clamps counter resets.\n// Adjust latency thresholds in the final WHERE clause as needed.\nFROM metrics-system.diskio-*\n| WHERE `system.diskio.name` NOT RLIKE \"(loop|ram|sr|dm-)\"\n| STATS\nmax_read_time = MAX(`system.diskio.read.time`::LONG),\nmin_read_time = MIN(`system.diskio.read.time`::LONG),\nmax_write_time = MAX(`system.diskio.write.time`::LONG),\nmin_write_time = MIN(`system.diskio.write.time`::LONG),\nmax_read_ops = MAX(`system.diskio.read.count`::LONG),\nmin_read_ops = MIN(`system.diskio.read.count`::LONG),\nmax_write_ops = MAX(`system.diskio.write.count`::LONG),\nmin_write_ops = MIN(`system.diskio.write.count`::LONG),\nfirst_ts = MIN(@timestamp),\nlast_ts = MAX(@timestamp)\nBY `host.name`, `system.diskio.name`\n| EVAL elapsed_ms = TO_DOUBLE(TO_LONG(last_ts) - TO_LONG(first_ts))\n| WHERE elapsed_ms >= 60000\n| EVAL read_time_delta = CASE(max_read_time >= min_read_time, max_read_time - min_read_time, 0)\n| EVAL write_time_delta = CASE(max_write_time >= min_write_time, max_write_time - min_write_time, 0)\n| EVAL read_ops_delta = CASE(max_read_ops >= min_read_ops, max_read_ops - min_read_ops, 0)\n| EVAL write_ops_delta = CASE(max_write_ops >= min_write_ops, max_write_ops - min_write_ops, 0)\n| EVAL total_ops = read_ops_delta + write_ops_delta\n| WHERE total_ops >= 100\n| EVAL io_time_ms = read_time_delta + write_time_delta\n| WHERE io_time_ms > 0\n| EVAL avg_latency_ms = io_time_ms / TO_DOUBLE(total_ops)\n| EVAL avg_iops = CASE(elapsed_ms > 0, total_ops / (elapsed_ms / 1000.0), 0.0)\n| EVAL device_type = CASE(\n`system.diskio.name` RLIKE \"^nvme[0-9]\", \"ssd\",\navg_latency_ms < 3 AND avg_iops > 100, \"ssd\",\navg_latency_ms > 15, \"hdd\",\n\"unknown\"\n)\n| WHERE (device_type == \"ssd\" AND avg_latency_ms > 5)\nOR (device_type == \"hdd\" AND avg_latency_ms > 30)\nOR (device_type == \"unknown\" AND avg_latency_ms > 10)"
            },
            "groupBy": "row",
            "timeField": "@timestamp"
        },
        "alertDelay": {
            "active": 3
        }
    },
    "managed": true,
    "coreMigrationVersion": "8.8.0",
    "typeMigrationVersion": "10.1.0"
}
