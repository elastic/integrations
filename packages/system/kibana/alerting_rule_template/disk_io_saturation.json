{
  "id": "disk_io_saturation",
  "type": "alerting_rule_template",
  "attributes": {
    "name": "[System] Disk I/O Saturation",
    "tags": ["System"],
    "ruleTypeId": ".es-query",
    "schedule": {
      "interval": "1m"
    },
    "params": {
      "searchType": "esqlQuery",
      "timeWindowSize": 5,
      "timeWindowUnit": "m",
      "esqlQuery": {
        "esql": "// Alert when disk devices show sustained saturation via utilization and queue depth metrics.\n// Groups by host/device, enforces minimum work, and uses Little's Law to estimate queue depth.\n// Adjust utilization or queue depth thresholds in the final WHERE clause as needed.\nFROM metrics-system.diskio-*\n| WHERE @timestamp >= NOW() - 5 MINUTES\n  AND system.diskio.name NOT RLIKE \"(loop|ram|sr|dm-)\"\n| STATS\n    io_time_delta = MAX(system.diskio.io.time) - MIN(system.diskio.io.time),\n    read_time_delta = MAX(system.diskio.read.time) - MIN(system.diskio.read.time),\n    write_time_delta = MAX(system.diskio.write.time) - MIN(system.diskio.write.time),\n    read_ops_delta = MAX(system.diskio.read.count) - MIN(system.diskio.read.count),\n    write_ops_delta = MAX(system.diskio.write.count) - MIN(system.diskio.write.count),\n    first_ts = MIN(@timestamp),\n    last_ts = MAX(@timestamp)\n  BY host.name, system.diskio.name\n| EVAL elapsed_ms = TO_DOUBLE(TO_LONG(last_ts) - TO_LONG(first_ts))\n| WHERE elapsed_ms >= 60000\n| EVAL io_time_delta = CASE(io_time_delta >= 0, io_time_delta, 0)\n| EVAL read_time_delta = CASE(read_time_delta >= 0, read_time_delta, 0)\n| EVAL write_time_delta = CASE(write_time_delta >= 0, write_time_delta, 0)\n| EVAL read_ops_delta = CASE(read_ops_delta >= 0, read_ops_delta, 0)\n| EVAL write_ops_delta = CASE(write_ops_delta >= 0, write_ops_delta, 0)\n| EVAL total_ops = read_ops_delta + write_ops_delta\n| WHERE total_ops >= 100\n| EVAL io_util_pct = 100 * io_time_delta / elapsed_ms\n| EVAL avg_iops = total_ops / (elapsed_ms / 1000)\n| EVAL total_io_time_ms = read_time_delta + write_time_delta\n| EVAL avg_latency_ms = CASE(\n    total_ops > 0 AND total_io_time_ms > 0,\n    total_io_time_ms / TO_DOUBLE(total_ops),\n    0\n  )\n| EVAL est_queue_depth = CASE(\n    avg_latency_ms > 0 AND avg_iops > 0,\n    (avg_iops * avg_latency_ms) / 1000,\n    0\n  )\n| WHERE io_util_pct > 90\n    OR est_queue_depth > 10\n    OR (io_util_pct > 70 AND est_queue_depth > 5)"
      },
      "groupBy": "row",
      "timeField": "@timestamp"
    },
    "alertDelay": {
      "active": 3
    }
  },
  "managed": true,
  "coreMigrationVersion": "8.8.0",
  "typeMigrationVersion": "10.1.0"
}
