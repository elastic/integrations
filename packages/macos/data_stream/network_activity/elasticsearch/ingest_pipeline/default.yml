---
description: Pipeline for processing network activity logs.
processors:
  - append:
      field: event.category
      tag: set_event_category
      value: network
  - append:
      field: event.type
      tag: append_info_into_event_type_in_network
      value: info
  - pipeline:
      name: '{{ IngestPipeline "common-pipeline" }}'
      tag: run-common-pipeline
  - grok:
      description: Grok the eventMessage.
      tag: grok-event-message
      field: macos.event.message.description
      ignore_missing: true
      patterns:
        - '^\[%{WORD}\] %{DATA}\:(?:%{SPACE}mach=%{WORD:macos.event.message.mach:boolean})?(?:%{SPACE}listener=%{WORD:macos.event.message.listener:boolean})?(?:%{SPACE}peer=%{WORD:macos.event.message.peer:boolean})?(?:%{SPACE}name=%{GREEDYDATA:macos.event.message.name})?'
        - '^%{WORD} \[%{DATA}\](?:%{SPACE}flags=\[%{DATA:macos.event.message.flags}\])?(?:%{SPACE}seq=%{DATA:macos.event.message.seq},)?(?:%{SPACE}ack=%{DATA:macos.event.message.ack},)?(?:%{SPACE}win=%{DATA:macos.event.message.win})?(?:%{SPACE}state=%{DATA:macos.event.message.state})?(?:%{SPACE}rcv_nxt=%{DATA:macos.event.message.rcv_nxt},)?(?:snd_una=%{DATA:macos.event.message.snd_una})'
        - '^%{WORD} \[%{DATA}\](?:%{SPACE}flags=\[%{DATA:macos.event.message.flags}\])?(?:%{SPACE}seq=%{DATA:macos.event.message.seq},)?(?:%{SPACE}ack=%{DATA:macos.event.message.ack},)?(?:%{SPACE}win=%{DATA:macos.event.message.win})?(?:%{SPACE}state=%{DATA:macos.event.message.state})?(?:%{SPACE}rcv_nxt=%{DATA:macos.event.message.rcv_nxt},)?(?:snd_una=%{DATA:macos.event.message.snd_una})'
        - '^nw_protocol_boringssl_signal_connected\(%{NUMBER}\) \[%{DATA:macos.event.message.connection_identifier}\]\[%{DATA}\] TLS connected \[(?:version\(%{DATA:macos.event.message.tls_version}\))?(?:%{SPACE}ciphersuite\(%{DATA:macos.event.message.cipher_suite}\))?(?:%{SPACE}group\(%{DATA:macos.event.message.group}\))?(?:%{SPACE}signature_alg\(%{DATA:process.code_signature.digest_algorithm}\))?(?:%{SPACE}alpn\(%{DATA:macos.event.message.alpn}\))?(?:%{SPACE}resumed\(%{DATA:macos.event.message.resumed}\))?(?:%{SPACE}offered_ticket\(%{DATA:macos.event.message.offered_ticket}\))?(?:%{SPACE}false_started\(%{DATA:macos.event.message.false_started}\))?(?:%{SPACE}ocsp_received\(%{DATA:macos.event.message.ocsp_received}\))?(?:%{SPACE}sct_received\(%{DATA:macos.event.message.sct_received}\))?(?:%{SPACE}connect_time\(%{DATA:macos.event.message.connection_time}\))?(?:%{SPACE}flight_time\(%{DATA:macos.event.message.flight_time}\))?(?:%{SPACE}rtt\(%{DATA:macos.event.message.rtt}\))?(?:%{SPACE}write_stalls\(%{DATA:macos.event.message.write_stalls:long}\))?(?:%{SPACE}read_stalls\(%{DATA:macos.event.message.read_stalls:long}\))?(?:%{SPACE}pake\(%{DATA:macos.event.message.pake}\))?\]'
        - '^Task \<%{DATA:macos.event.message.task_uid}\>.\<%{NUMBER}\>%{SPACE}summary for %{DATA} \{(?:transaction_duration_ms=%{NUMBER:macos.event.message.transaction_duration_ms:long},)?(?:%{SPACE}response_status=%{NUMBER:http.response.status_code:long},)?(?:%{SPACE}connection=%{NUMBER:macos.event.message.connection:long},)?(?:%{SPACE}protocol=%{DATA:macos.event.message.protocol},)?(?:%{SPACE}domain_lookup_duration_ms=%{NUMBER:macos.event.message.domain_lookup_duration_ms:long},)?(?:%{SPACE}connect_duration_ms=%{NUMBER:macos.event.message.connection_duration_ms:long},)?(?:%{SPACE}secure_connection_duration_ms=%{NUMBER:macos.event.message.secure_connection_duration_ms:long},)?(?:%{SPACE}private_relay=%{WORD:macos.event.message.private_relay:boolean},)?(?:%{SPACE}request_start_ms=%{NUMBER:macos.event.message.request_start_ms:long},)?(?:%{SPACE}request_duration_ms=%{NUMBER:macos.event.message.request_duration_ms:long},)?(?:%{SPACE}response_start_ms=%{NUMBER:macos.event.message.response_start_ms:long},)?(?:%{SPACE}response_duration_ms=%{NUMBER:macos.event.message.response_duration_ms:long},)?(?:%{SPACE}request_bytes=%{NUMBER:http.request.bytes:long},)?(?:%{SPACE}response_bytes=%{NUMBER:http.response.bytes:long},)?(?:%{SPACE}cache_hit=%{WORD:macos.event.message.cache_hit:boolean})?\}'
        - '^%{DATA} \[%{DATA:macos.event.message.connection_identifier}\]%{SPACE}\[%{UUID:macos.event.message.connection_uuid} <private>:%{NUMBER:source.port:long}<-><private>:%{NUMBER:destination.port:long}\]%{SPACE}Init: %{NUMBER:macos.event.message.init_flag:long}, Conn_Time: %{DATA:macos.event.message.connection_time}, SYNs: %{NUMBER:macos.event.message.syns:long}, WR_T: %{DATA:macos.event.message.wr_t_in_out}, RD_T: %{DATA:macos.event.message.rd_t_in_out}, TFO: %{DATA:macos.event.message.tfo_in_out_miss}, ECN: %{DATA:macos.event.message.ecn_in_out_miss}, Accurate ECN %{GREEDYDATA}: %{GREEDYDATA:macos.event.message.accurate_ecn}, TS: %{NUMBER:macos.event.message.timestamp_enabled:long}, TSO: %{NUMBER:macos.event.message.tso_enabled:long}%{SPACE}rtt_cache: %{DATA:macos.event.message.rtt_cache}, rtt_upd: %{NUMBER:macos.event.message.rtt_updates:long}, rtt: %{DATA:macos.event.message.rtt}, rtt_var: %{DATA:macos.event.message.rtt_var_ms} rtt_nc: %{DATA:macos.event.message.rtt_nc_ms}, rtt_var_nc: %{DATA:macos.event.message.rtt_var_nc_ms} base rtt: %{GREEDYDATA:macos.event.message.base_rtt_ms}%{SPACE}ACKs-compressed: %{NUMBER:macos.event.message.acks_compressed:long}, ACKs delayed: %{NUMBER:macos.event.message.acks_delayed:long} delayed ACKs sent: %{NUMBER:macos.event.message.delayed_acks_sent:long}'
        - '^\[C%{NUMBER:macos.event.message.connection_id} %{UUID:macos.event.message.session_uuid} (Hostname\#)?%{DATA:host.id}:%{NUMBER:macos.event.message.hostname_port:long} %{DATA}(, bundle id: %{DATA:macos.event.message.bundle_id})?(, pid: %{DATA:process.pid:long})?(, account id: %{DATA:macos.event.message.account_id})?(, url: %{DATA:url.original})?(, url hash: %{BASE16NUM:macos.event.message.url_hash})?(, traffic class: %{NUMBER:macos.event.message.traffic_class})?(, expected workload: %{NUMBER:macos.event.message.expected_workload})?(, %{GREEDYDATA})?, attribution: %{DATA:macos.event.message.attribution}(, %{GREEDYDATA})?\] cancelled\n\t\[C%{DATA:macos.event.message.connection_detail} %{UUID:macos.event.message.connection_uuid} %{IP:source.ip}:%{NUMBER:source.port:long}<->(IPv4#)?%{DATA:macos.event.message.server_id}:%{NUMBER:destination.port:long}\]\n\tConnected Path: %{DATA:macos.event.message.path_status}(, %{DATA})?(, interface: %{DATA:macos.event.message.interface})?(, %{GREEDYDATA})?\n\tPrivacy Stance: %{DATA:macos.event.message.privacy_stance}\n\tDuration: %{DATA:macos.event.message.duration}, DNS @%{DATA:macos.event.message.dns_start} took %{DATA:macos.event.message.dns_duration}, TCP @%{DATA:macos.event.message.tcp_start} took %{DATA:macos.event.message.tcp_duration}, TLS %{DATA:macos.event.message.tls_version} took %{DATA:macos.event.message.tls_duration}\n\tbytes in\/out: %{NUMBER:source.bytes:long}\/%{NUMBER:destination.bytes:long}, packets in\/out: %{NUMBER:source.packets:long}\/%{NUMBER:destination.packets:long}, rtt: %{DATA:macos.event.message.rtt}, retransmitted bytes: %{NUMBER:macos.event.message.retransmitted_bytes:long}, out-of-order bytes: %{NUMBER:macos.event.message.out_of_order_bytes:long}\n\tecn packets sent\/acked\/marked\/lost: %{NUMBER:macos.event.message.ecn_sent:long}\/%{NUMBER:macos.event.message.ecn_acked:long}\/%{NUMBER:macos.event.message.ecn_marked:long}\/%{NUMBER:macos.event.message.ecn_lost:long}$'
        - '%{GREEDYDATA:macos.event.message.original}'
  - script:
      lang: painless
      tag: calculate_total_bytes
      description: calculate total bytes of in and out if in and out are not null.
      if: ctx.source?.bytes != null && ctx.destination?.bytes != null
      source: |
        ctx.network = new HashMap();
        ctx.network.bytes = ctx.source.bytes + ctx.destination.bytes
  - script:
      lang: painless
      tag: calculate_total_packets
      description: calculate total packets of in and out if in and out are not null.
      if: ctx.source?.packets != null && ctx.destination?.packets != null
      source: |
        if (ctx.network == null) {
          ctx.network = new HashMap();
        }
        ctx.network.packets = ctx.source.packets + ctx.destination.packets
  - uri_parts:
      field: url.original
      tag: uri_parts_url_original
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - append:
      field: related.hosts
      tag: append_host_id_into_related_hosts
      value: '{{{host.id}}}'
      allow_duplicates: false
      if: ctx.host?.id != null
  - append:
      field: related.ip
      tag: append_source_ip_into_related_ip
      value: '{{{source.ip}}}'
      allow_duplicates: false
      if: ctx.source?.ip != null
  - set:
      field: macos.event.message.resumed
      tag: set_event_message_resumed_true
      value: true
      if: ctx.macos?.event?.message?.resumed == '1'
  - set:
      field: macos.event.message.resumed
      tag: set_event_message_resumed_false
      value: false
      if: ctx.macos?.event?.message?.resumed == '0'
  - set:
      field: macos.event.message.offered_ticket
      tag: set_event_message_offered_ticket_true
      value: true
      if: ctx.macos?.event?.message?.offered_ticket == '1'
  - set:
      field: macos.event.message.offered_ticket
      tag: set_event_message_offered_ticket_false
      value: false
      if: ctx.macos?.event?.message?.offered_ticket == '0'
  - set:
      field: macos.event.message.false_started
      tag: set_event_message_false_started_true
      value: true
      if: ctx.macos?.event?.message?.false_started == '1'
  - set:
      field: macos.event.message.false_started
      tag: set_event_message_false_started_false
      value: false
      if: ctx.macos?.event?.message?.false_started == '0'
  - set:
      field: macos.event.message.ocsp_received
      tag: set_event_message_oscp_received_true
      value: true
      if: ctx.macos?.event?.message?.ocsp_received == '1'
  - set:
      field: macos.event.message.ocsp_received
      tag: set_event_message_oscp_received_false
      value: false
      if: ctx.macos?.event?.message?.ocsp_received == '0'
  - set:
      field: macos.event.message.sct_received
      tag: set_event_message_sct_received_true
      value: true
      if: ctx.macos?.event?.message?.sct_received == '1'
  - set:
      field: macos.event.message.sct_received
      tag: set_event_message_sct_received_false
      value: false
  - dissect:
      field: macos.event.message.ecn_in_out_miss
      tag: dissect_ecn_in_out_miss
      pattern: '%{macos.event.message.ecn_in}/%{macos.event.message.ecn_out}/%{macos.event.message.ecn_miss}'
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.ecn_in
      tag: convert_macos_event_message_ecn_in_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.ecn_out
      tag: convert_macos_event_message_ecn_out_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.ecn_miss
      tag: convert_macos_event_message_ecn_miss_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - dissect:
      field: macos.event.message.rd_t_in_out
      tag: dissect_rd_t_in_out
      pattern: '%{macos.event.message.rd_t_in}/%{macos.event.message.rd_t_out}'
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.rd_t_in
      tag: convert_macos_event_message_rd_t_in_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.rd_t_out
      tag: convert_macos_event_message_rd_t_out_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - dissect:
      field: macos.event.message.tfo_in_out_miss
      tag: dissect_tfo_in_out_miss
      pattern: '%{macos.event.message.tfo_in}/%{macos.event.message.tfo_out}/%{macos.event.message.tfo_miss}'
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.tfo_in
      tag: convert_macos_event_message_tfo_in_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.tfo_out
      tag: convert_macos_event_message_tfo_out_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.tfo_miss
      tag: convert_macos_event_message_tfo_miss_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - dissect:
      field: macos.event.message.wr_t_in_out
      tag: dissect_wr_t_in_out
      pattern: '%{macos.event.message.wr_t_in}/%{macos.event.message.wr_t_out}'
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.wr_t_in
      tag: convert_macos_event_message_wr_t_in_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: macos.event.message.wr_t_out
      tag: convert_macos_event_message_wr_t_out_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - dissect:
      field: macos.event.message.accurate_ecn
      tag: dissect_accurate_ecn
      pattern: '%{macos.event.message.accurate_ecn_client}/%{macos.event.message.accurate_ecn_server}'
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - remove:
      field:
        - macos.event.message.original
        - macos.event.message.ecn_in_out_miss
        - macos.event.message.rd_t_in_out
        - macos.event.message.tfo_in_out_miss
        - macos.event.message.wr_t_in_out
        - macos.event.message.accurate_ecn
      tag: remove_non_required_fields
      ignore_missing: true
on_failure:
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}}failed with message '{{{ _ingest.on_failure_message }}}'
  - set:
      field: event.kind
      tag: set_pipeline_error_to_event_kind
      value: pipeline_error
