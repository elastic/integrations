---
description: Ingest pipeline for Varonis DatAdvantage syslog messages
processors:
############
# ECS Fields
############
  - set:
      field: ecs.version
      value: '8.11.0'

  - set:
      field: event.kind
      value: event

  - append:
      field: event.category
      value: configuration
      allow_duplicates: false

  - append:
      field: event.type
      value: info
      allow_duplicates: false

  - set:
      field: event.dataset
      value: varonis.logs

  - set:
      field: event.module
      value: varonis

############
# syslog Fields
############
  - convert:
      field: cef.extensions.deviceCustomNumber1
      type: integer
      target_field: varonis.logs.rule_id
      ignore_missing: true
      if: ctx.cef?.extensions?.deviceCustomNumber1Label == "RuleID"

  - convert:
      field: cef.extensions.deviceCustomString1
      type: string
      target_field: varonis.logs.mail_recipient
      ignore_missing: true
      if: ctx.cef?.extensions?.deviceCustomString1Label == "MailRecipient"

  - convert:
      field: cef.extensions.deviceCustomString2
      type: string
      target_field: varonis.logs.rule_name
      ignore_missing: true
      if: ctx.cef?.extensions?.deviceCustomString2Label == "RuleName"

  - convert:
      field: cef.extensions.deviceCustomString3
      type: string
      target_field: varonis.logs.attachment_name
      ignore_missing: true
      if: ctx.cef?.extensions?.deviceCustomString3Label == "AttachmentName"

  - convert:
      field: cef.extensions.deviceCustomString4
      type: string
      target_field: varonis.logs.client_access_type
      ignore_missing: true
      if: ctx.cef?.extensions?.deviceCustomString4Label == "ClientAccessType"

  - convert:
      field: cef.extensions.deviceCustomString5
      type: string
      target_field: varonis.logs.mailbox_access_type
      ignore_missing: true
      if: ctx.cef?.extensions?.deviceCustomString5Label == "MailboxAccessType"

  - convert:
      field: cef.extensions.deviceCustomString6
      type: string
      target_field: varonis.logs.changed_permissions
      ignore_missing: true
      if: ctx.cef?.extensions?.deviceCustomString6Label == "ChangedPermissions"

  - rename:
      field: cef.extensions.deviceEventCategory
      target_field: varonis.logs.event_category
      ignore_missing: true

  - rename:
      field: cef.extensions.oldFilePermission
      target_field: varonis.logs.old_file_permission
      ignore_missing: true

  # write a processor to lowercase the value of event.outcome
  - lowercase:
      field: event.outcome
      target_field: event.outcome
      ignore_missing: true

  ####################
  ## Cleanup Fields ##
  ####################
  - remove:
      field:
        - cef
        - log
      ignore_failure: true
      ignore_missing: true

on_failure:
  - append:
      field: error.message
      value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
