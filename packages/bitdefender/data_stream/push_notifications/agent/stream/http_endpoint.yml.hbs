type: http_endpoint
enabled: true
prefix: json

{{! Setting content-type: "" so that it disables the content-type validation as BitDefender does not send this in their request headers}}
content_type: ""

{{#if listen_address}}
listen_address: {{listen_address}}
{{/if}}
{{#if listen_port}}
listen_port: {{listen_port}}
{{/if}}
{{#if url}}
url: {{url}}
{{/if}}

{{#if authorization_value}}
secret.header: Authorization
secret.value: "{{authorization_value}}"
{{/if}}

{{#if ssl}}
ssl: {{ssl}}
{{/if}}

{{#if jsonrpc_format}}
program: |
  has(obj.jsonrpc) ?
    obj.params.events.map(e, {
      "message": e
    })
  : 
    [{"message": "Not jsonrpc formatted message root1"}]
  
  {{!-- debug("HAS_OBJECT-JSONRPC", has(obj.jsonrpc)) ?
    [{"message": debug("OBJECT-ID", obj.id)}] --}}

  {{!-- has(obj.jsonrpc) ?
    has(obj.params) ?
      has(obj.params.events) ?
        obj.params.events.map(e, {
          "message": e
        })
      :
        [{"message": "Not jsonrpc formatted message root3"}]
    : 
      [{"message": "Not jsonrpc formatted message root2"}]
  : 
    [{"message": "Not jsonrpc formatted message root1"}] --}}
{{!-- program: |
  {
    "events": [
      "message": "{\"aph_type\":\"phishing\"}"
    ],
    "error": "Not jsonrpc formatted message",
  } --}}
{{/if}}

{{#if preserve_original_event}}
preserve_original_event: true
{{/if}}

tags:
{{#if preserve_original_event}}
  - preserve_original_event
{{/if}}
{{#if preserve_duplicate_custom_fields}}
  - preserve_duplicate_custom_fields
{{/if}}
{{#each tags as |tag|}}
  - {{tag}}
{{/each}}
{{#contains "forwarded" tags}}
publisher_pipeline.disable_host: true
{{/contains}}
processors:
- add_locale: ~
- add_fields:
    target: _tmp
    fields:
      bitdefender_id: "{{push_notification_configuration_id}}"
      {{#if tenants}}
      tenants:
        {{#each tenants}}
          {{this}}
        {{/each}}
      {{/if}}
{{#if processors}}
{{processors}}
{{/if}}
