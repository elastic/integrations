inputs:
    - data_stream:
        namespace: ep
      meta:
        package:
            name: sentinel_one
      name: test-all-sentinel_one
      streams:
        - config_version: 2
          data_stream:
            dataset: sentinel_one.unified_alert
          interval: 30s
          processors:
            - add_fields:
                fields:
                    id: "574734885120952459"
                    name: myproject
                target: project
            - add_tags:
                tags:
                    - web
                    - production
                target: environment
          program: |-
            (
              state.?want_more.orValue(false) ?
                state
              :
                state.with({
                  "start_time": state.?cursor.last_timestamp.orValue((now - duration(state.initial_interval)).as(t, int(t)*1000 + t.getMilliseconds())),
                  "end_time": now.as(t, int(t)*1000 + t.getMilliseconds()),
                })
            ).as(state, state.with(
              post_request(
                state.url.trim_right("/") + "/web/api/v2.1/unifiedalerts/graphql",
                "application/json",
                {
                  "query": state.query,
                  "variables": {
                    "first": state.batch_size,
                    ?"after": state.?end_cursor.value,
                    "filters": [{
                      "fieldId": state.collect_alert_updation ? "updatedAt" : "detectedAt",
                      "dateTimeRange": {
                        "start": state.start_time,
                        "startInclusive": false,
                        "end": state.end_time
                      }
                    }],
                    "sort": {
                      "by": state.collect_alert_updation ? "updatedAt" : "detectedAt",
                      "order": "ASC"
                    }
                  }
                }.encode_json()
              ).with({
                "Header":{
                  "Authorization": ["Bearer " + string(state.api_token)],
                  "Content-Type": ["application/json"],
                }
              }).do_request().as(resp, resp.StatusCode == 200 ?
                resp.Body.decode_json().as(body, {
                  "events": (
                    size(body.data.alerts.edges) != 0 ?
                      body.data.alerts.edges.map(e, {"message": e.node.encode_json()})
                    :
                      [{"message": "retry"}]
                  ),
                  "end_cursor": {
                    ?"value": body.?data.alerts.pageInfo.hasNextPage.orValue(false) ?
                      body.?data.alerts.pageInfo.endCursor
                    :
                      optional.none()
                  },
                  // Two-phase: first by detectedAt (collect_alert_updation=false), then by updatedAt (collect_alert_updation=true).
                  // hasNextPage=false flips the phase; want_more=false only when update phase is done.
                  "want_more": body.?data.alerts.pageInfo.hasNextPage.orValue(false) || !state.collect_alert_updation,
                  "collect_alert_updation": (
                    body.?data.alerts.pageInfo.hasNextPage.orValue(false) ?
                      state.collect_alert_updation
                    :
                      !state.collect_alert_updation
                  ),
                  "cursor": {
                    ?"last_timestamp": body.?data.alerts.pageInfo.hasNextPage.orValue(false) || !state.collect_alert_updation ?
                      state.?cursor.last_timestamp
                    :
                      optional.of(state.end_time)
                  }
                })
              :
                {
                  "events": {
                    "error": {
                      "code": string(resp.StatusCode),
                      "id": string(resp.Status),
                      "message": "POST " + state.url.trim_right("/") + "/web/api/v2.1/unifiedalerts/graphql:" + (
                        size(resp.Body) != 0 ?
                          string(resp.Body)
                        :
                          string(resp.Status) + ' (' + string(resp.StatusCode) + ')'
                      ),
                    },
                  },
                  "end_cursor": {},
                  "collect_alert_updation": false,
                  "want_more": false,
                }
              )
            ))
          publisher_pipeline.disable_host: true
          redact:
            fields:
                - api_token
          resource.proxy_url: https://user:P%40ssword%23@0.0.0.0:0000
          resource.ssl:
            certificate: |
                -----BEGIN CERTIFICATE-----
                MIIDCjCCAfKgAwIBAgITJ706Mu2wJlKckpIvkWxEHvEyijANBgkqhkiG9w0BAQsF
                ADAUMRIwEAYDVQQDDAlsb2NhbGhvc3QwIBcNMTkwNzIyMTkyOTA0WhgPMjExOTA2
                MjgxOTI5MDRaMBQxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcNAQEB
                BQADggEPADCCAQoCggEBANce58Y/JykI58iyOXpxGfw0/gMvF0hUQAcUrSMxEO6n
                fZRA49b4OV4SwWmA3395uL2eB2NB8y8qdQ9muXUdPBWE4l9rMZ6gmfu90N5B5uEl
                94NcfBfYOKi1fJQ9i7WKhTjlRkMCgBkWPkUokvBZFRt8RtF7zI77BSEorHGQCk9t
                /D7BS0GJyfVEhftbWcFEAG3VRcoMhF7kUzYwp+qESoriFRYLeDWv68ZOvG7eoWnP
                PsvZStEVEimjvK5NSESEQa9xWyJOmlOKXhkdymtcUd/nXnx6UTCFgnkgzSdTWV41
                CI6B6aJ9svCTI2QuoIq2HxX/ix7OvW1huVmcyHVxyUECAwEAAaNTMFEwHQYDVR0O
                BBYEFPwN1OceFGm9v6ux8G+DZ3TUDYxqMB8GA1UdIwQYMBaAFPwN1OceFGm9v6ux
                8G+DZ3TUDYxqMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAG5D
                874A4YI7YUwOVsVAdbWtgp1d0zKcPRR+r2OdSbTAV5/gcS3jgBJ3i1BN34JuDVFw
                3DeJSYT3nxy2Y56lLnxDeF8CUTUtVQx3CuGkRg1ouGAHpO/6OqOhwLLorEmxi7tA
                H2O8mtT0poX5AnOAhzVy7QW0D/k4WaoLyckM5hUa6RtvgvLxOwA0U+VGurCDoctu
                8F4QOgTAWyh8EZIwaKCliFRSynDpv3JTUwtfZkxo6K6nce1RhCWFAsMvDZL8Dgc0
                yvgJ38BRsFOtkRuAGSf6ZUwTO8JJRRIFnpUzXflAnGivK9M13D5GEQMmIl6U9Pvk
                sxSmbIUfc2SGJGCJD4I=
                -----END CERTIFICATE-----
            certificate_authorities:
                - |
                  -----BEGIN CERTIFICATE-----
                  MIIDCjCCAfKgAwIBAgITJ706Mu2wJlKckpIvkWxEHvEyijANBgkqhkiG9w0BAQsF
                  ADAUMRIwEAYDVQQDDAlsb2NhbGhvc3QwIBcNMTkwNzIyMTkyOTA0WhgPMjExOTA2
                  MjgxOTI5MDRaMBQxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcNAQEB
                  BQADggEPADCCAQoCggEBANce58Y/JykI58iyOXpxGfw0/gMvF0hUQAcUrSMxEO6n
                  fZRA49b4OV4SwWmA3395uL2eB2NB8y8qdQ9muXUdPBWE4l9rMZ6gmfu90N5B5uEl
                  94NcfBfYOKi1fJQ9i7WKhTjlRkMCgBkWPkUokvBZFRt8RtF7zI77BSEorHGQCk9t
                  /D7BS0GJyfVEhftbWcFEAG3VRcoMhF7kUzYwp+qESoriFRYLeDWv68ZOvG7eoWnP
                  PsvZStEVEimjvK5NSESEQa9xWyJOmlOKXhkdymtcUd/nXnx6UTCFgnkgzSdTWV41
                  CI6B6aJ9svCTI2QuoIq2HxX/ix7OvW1huVmcyHVxyUECAwEAAaNTMFEwHQYDVR0O
                  BBYEFPwN1OceFGm9v6ux8G+DZ3TUDYxqMB8GA1UdIwQYMBaAFPwN1OceFGm9v6ux
                  8G+DZ3TUDYxqMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAG5D
                  874A4YI7YUwOVsVAdbWtgp1d0zKcPRR+r2OdSbTAV5/gcS3jgBJ3i1BN34JuDVFw
                  3DeJSYT3nxy2Y56lLnxDeF8CUTUtVQx3CuGkRg1ouGAHpO/6OqOhwLLorEmxi7tA
                  H2O8mtT0poX5AnOAhzVy7QW0D/k4WaoLyckM5hUa6RtvgvLxOwA0U+VGurCDoctu
                  8F4QOgTAWyh8EZIwaKCliFRSynDpv3JTUwtfZkxo6K6nce1RhCWFAsMvDZL8Dgc0
                  yvgJ38BRsFOtkRuAGSf6ZUwTO8JJRRIFnpUzXflAnGivK9M13D5GEQMmIl6U9Pvk
                  sxSmbIUfc2SGJGCJD4I=
                  -----END CERTIFICATE-----
            cipher_suites:
                - ECDHE-ECDSA-AES-128-CBC-SHA
                - ECDHE-ECDSA-AES-256-GCM-SHA384
            curve_types:
                - P-256
            enabled: true
            key: |
                -----BEGIN PRIVATE KEY-----
                MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDXHufGPycpCOfI
                sjl6cRn8NP4DLxdIVEAHFK0jMRDup32UQOPW+DleEsFpgN9/ebi9ngdjQfMvKnUP
                Zrl1HTwVhOJfazGeoJn7vdDeQebhJfeDXHwX2DiotXyUPYu1ioU45UZDAoAZFj5F
                KJLwWRUbfEbRe8yO+wUhKKxxkApPbfw+wUtBicn1RIX7W1nBRABt1UXKDIRe5FM2
                MKfqhEqK4hUWC3g1r+vGTrxu3qFpzz7L2UrRFRIpo7yuTUhEhEGvcVsiTppTil4Z
                HcprXFHf5158elEwhYJ5IM0nU1leNQiOgemifbLwkyNkLqCKth8V/4sezr1tYblZ
                nMh1cclBAgMBAAECggEBAKdP5jyOicqknoG9/G564RcDsDyRt64NuO7I6hBg7SZx
                Jn7UKWDdFuFP/RYtoabn6QOxkVVlydp5Typ3Xu7zmfOyss479Q/HIXxmmbkD0Kp0
                eRm2KN3y0b6FySsS40KDRjKGQCuGGlNotW3crMw6vOvvsLTlcKgUHF054UVCHoK/
                Piz7igkDU7NjvJeha53vXL4hIjb10UtJNaGPxIyFLYRZdRPyyBJX7Yt3w8dgz8WM
                epOPu0dq3bUrY3WQXcxKZo6sQjE1h7kdl4TNji5jaFlvD01Y8LnyG0oThOzf0tve
                Gaw+kuy17gTGZGMIfGVcdeb+SlioXMAAfOps+mNIwTECgYEA/gTO8W0hgYpOQJzn
                BpWkic3LAoBXWNpvsQkkC3uba8Fcps7iiEzotXGfwYcb5Ewf5O3Lrz1EwLj7GTW8
                VNhB3gb7bGOvuwI/6vYk2/dwo84bwW9qRWP5hqPhNZ2AWl8kxmZgHns6WTTxpkRU
                zrfZ5eUrBDWjRU2R8uppgRImsxMCgYEA2MxuL/C/Ko0d7XsSX1kM4JHJiGpQDvb5
                GUrlKjP/qVyUysNF92B9xAZZHxxfPWpdfGGBynhw7X6s+YeIoxTzFPZVV9hlkpAA
                5igma0n8ZpZEqzttjVdpOQZK8o/Oni/Q2S10WGftQOOGw5Is8+LY30XnLvHBJhO7
                TKMurJ4KCNsCgYAe5TDSVmaj3dGEtFC5EUxQ4nHVnQyCpxa8npL+vor5wSvmsfUF
                hO0s3GQE4sz2qHecnXuPldEd66HGwC1m2GKygYDk/v7prO1fQ47aHi9aDQB9N3Li
                e7Vmtdn3bm+lDjtn0h3Qt0YygWj+wwLZnazn9EaWHXv9OuEMfYxVgYKpdwKBgEze
                Zy8+WDm5IWRjn8cI5wT1DBT/RPWZYgcyxABrwXmGZwdhp3wnzU/kxFLAl5BKF22T
                kRZ+D+RVZvVutebE9c937BiilJkb0AXLNJwT9pdVLnHcN2LHHHronUhV7vetkop+
                kGMMLlY0lkLfoGq1AxpfSbIea9KZam6o6VKxEnPDAoGAFDCJm+ZtsJK9nE5GEMav
                NHy+PwkYsHhbrPl4dgStTNXLenJLIJ+Ke0Pcld4ZPfYdSyu/Tv4rNswZBNpNsW9K
                0NwJlyMBfayoPNcJKXrH/csJY7hbKviAHr1eYy9/8OL0dHf85FV+9uY5YndLcsDc
                nygO9KTJuUiBrLr0AHEnqko=
                -----END PRIVATE KEY-----
            supported_protocols:
                - TLSv1.2
          resource.timeout: 10s
          resource.tracer:
            enabled: true
            filename: ../../logs/cel/http-request-trace-*.ndjson
            maxbackups: 5
          resource.url: http://host.tld
          state:
            api_token: ${SECRET_0}
            batch_size: 100
            collect_alert_updation: false
            initial_interval: 24h
            query: |
                query GetAllUnifiedAlerts(
                  $after: String
                  $first: Int
                  $filters: [FilterInput!]
                  $sort: SortInput
                ) {
                  alerts(
                    after: $after
                    first: $first
                    filters: $filters
                    sort: $sort
                  ) {
                    totalCount
                    pageInfo {
                      hasNextPage
                      hasPreviousPage
                      startCursor
                      endCursor
                    }
                    edges {
                      cursor
                      node {
                        id
                        aiInvestigation {
                          purpleAiStatus
                          status
                          verdict
                        }
                        analystVerdict
                        analytics {
                          category
                          name
                          typeValue
                          uid
                        }
                        assets {
                          accessible
                          agentUuid
                          agentVersion
                          assetTypeClassifier
                          category
                          connectivityToConsole
                          decommissioned
                          id
                          lastLoggedInUser
                          name
                          origin
                          osType
                          osVersion
                          pendingReboot
                          policy
                          role
                          status
                          subcategory
                        }
                        assignee {
                          email
                          fullName
                          userId
                        }
                        attackSurfaces
                        availableActionIds
                        classification
                        confidenceLevel
                        createdAt
                        dataSources
                        description
                        detectedAt
                        detectionSource {
                          product
                          vendor
                        }
                        detectionTime {
                          assets {
                            accessible
                            asset {
                              agentVersion
                              consoleIpAddress
                              domain
                              ipV4
                              ipV6
                              lastLoggedInUser
                              osName
                              osRevision
                              osType
                              policy
                              subscriptionTime
                            }
                            cloud {
                              accountId
                              cloudProvider
                              image
                              instanceId
                              instanceSize
                              location
                              network
                              providerDetails {
                                ... on DetectionAws {
                                  accountId
                                  imageId
                                  instanceId
                                  instanceType
                                  region
                                  role
                                  securityGroups
                                  subnetIds
                                  tags
                                  vpcId
                                }
                                ... on DetectionAzure {
                                  imageId
                                  instanceId
                                  instanceType
                                  region
                                  resourceGroup
                                  subscriptionId
                                  tags
                                }
                                ... on DetectionGcp {
                                  imageId
                                  instanceId
                                  instanceType
                                  projectId
                                  serviceAccount
                                  tags
                                  vpcId
                                  zone
                                }
                              }
                              tags
                            }
                            kubernetes {
                              clusterName
                              containerId
                              containerImageName
                              containerLabels
                              containerName
                              controllerLabels
                              controllerName
                              controllerType
                              namespaceLabels
                              namespaceName
                              nodeLabels
                              nodeName
                              podLabels
                              podName
                            }
                            origin
                            scope {
                              accountId
                              accountName
                              groupName
                              siteName
                            }
                          }
                          attacker {
                            host
                            ip
                          }
                          scope {
                            accountId
                            accountName
                            groupName
                            siteName
                          }
                          targetUser {
                            domain
                            emailAddress
                            name
                          }
                        }
                        exclusionHash
                        externalId
                        firstSeenAt
                        lastSeenAt
                        name
                        noteExists
                        process {
                          cmdLine
                          file {
                            certSubject
                            md5
                            name
                            path
                            sha1
                            sha256
                          }
                          parentName
                        }
                        realTime {
                          scope {
                            account {
                              id
                              name
                            }
                            group {
                              id
                              name
                            }
                            site {
                              id
                              name
                            }
                          }
                        }
                        result
                        severity
                        sloDetails {
                          timeToResolveData {
                            actionComplete
                            actionDue
                            completion
                            completionTime
                            status
                            target
                            targetTime
                          }
                          timeToResponseData {
                            actionComplete
                            actionDue
                            completion
                            completionTime
                            status
                            target
                            targetTime
                          }
                        }
                        status
                        storylineId
                        ticketId
                        updatedAt
                      }
                    }
                  }
                }
            want_more: false
          tags:
            - preserve_original_event
            - preserve_duplicate_custom_fields
            - forwarded
            - sentinel_one-unified_alert
            - test-policy
      type: cel
      use_output: default
output_permissions:
    default:
        _elastic_agent_checks:
            cluster:
                - monitor
        _elastic_agent_monitoring:
            indices: []
        uuid-for-permissions-on-related-indices:
            indices:
                - names:
                    - logs-sentinel_one.unified_alert-ep
                  privileges:
                    - auto_configure
                    - create_doc
secret_references:
    - {}
