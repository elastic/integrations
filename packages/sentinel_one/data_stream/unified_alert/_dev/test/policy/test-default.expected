inputs:
    - data_stream:
        namespace: ep
      meta:
        package:
            name: sentinel_one
      name: test-default-sentinel_one
      streams:
        - config_version: 2
          data_stream:
            dataset: sentinel_one.unified_alert
          interval: 1m
          program: |-
            (
              state.?want_more.orValue(false) ?
                state
              :
                state.with({
                  "start_time": state.?cursor.last_timestamp.orValue((now - duration(state.initial_interval)).as(t, int(t)*1000 + t.getMilliseconds())),
                  "end_time": now.as(t, int(t)*1000 + t.getMilliseconds()),
                })
            ).as(state, state.with(
              post_request(
                state.url.trim_right("/") + "/web/api/v2.1/unifiedalerts/graphql",
                "application/json",
                {
                  "query": state.query,
                  "variables": {
                    "first": state.batch_size,
                    ?"after": state.?end_cursor.value,
                    "filters": [{
                      "fieldId": state.collect_alert_updation ? "updatedAt" : "detectedAt",
                      "dateTimeRange": {
                        "start": state.start_time,
                        "startInclusive": false,
                        "end": state.end_time
                      }
                    }],
                    "sort": {
                      "by": state.collect_alert_updation ? "updatedAt" : "detectedAt",
                      "order": "ASC"
                    }
                  }
                }.encode_json()
              ).with({
                "Header":{
                  "Authorization": ["Bearer " + string(state.api_token)],
                  "Content-Type": ["application/json"],
                }
              }).do_request().as(resp, resp.StatusCode == 200 ?
                resp.Body.decode_json().as(body, {
                  "events": (
                    size(body.data.alerts.edges) != 0 ?
                      body.data.alerts.edges.map(e, {"message": e.node.encode_json()})
                    :
                      [{"message": "retry"}]
                  ),
                  "end_cursor": {
                    ?"value": body.?data.alerts.pageInfo.hasNextPage.orValue(false) ?
                      body.?data.alerts.pageInfo.endCursor
                    :
                      optional.none()
                  },
                  // Two-phase: first by detectedAt (collect_alert_updation=false), then by updatedAt (collect_alert_updation=true).
                  // hasNextPage=false flips the phase; want_more=false only when update phase is done.
                  "want_more": body.?data.alerts.pageInfo.hasNextPage.orValue(false) || !state.collect_alert_updation,
                  "collect_alert_updation": (
                    body.?data.alerts.pageInfo.hasNextPage.orValue(false) ?
                      state.collect_alert_updation
                    :
                      !state.collect_alert_updation
                  ),
                  "cursor": {
                    ?"last_timestamp": body.?data.alerts.pageInfo.hasNextPage.orValue(false) || !state.collect_alert_updation ?
                      state.?cursor.last_timestamp
                    :
                      optional.of(state.end_time)
                  }
                })
              :
                {
                  "events": {
                    "error": {
                      "code": string(resp.StatusCode),
                      "id": string(resp.Status),
                      "message": "POST " + state.url.trim_right("/") + "/web/api/v2.1/unifiedalerts/graphql:" + (
                        size(resp.Body) != 0 ?
                          string(resp.Body)
                        :
                          string(resp.Status) + ' (' + string(resp.StatusCode) + ')'
                      ),
                    },
                  },
                  "end_cursor": {},
                  "collect_alert_updation": false,
                  "want_more": false,
                }
              )
            ))
          publisher_pipeline.disable_host: true
          redact:
            fields:
                - api_token
          resource.ssl: null
          resource.timeout: 30s
          resource.tracer:
            enabled: false
            filename: ../../logs/cel/http-request-trace-*.ndjson
            maxbackups: 5
          resource.url: http://host.tld
          state:
            api_token: ${SECRET_0}
            batch_size: 1000
            collect_alert_updation: false
            initial_interval: 24h
            query: |
                query GetAllUnifiedAlerts(
                  $after: String
                  $first: Int
                  $filters: [FilterInput!]
                  $sort: SortInput
                ) {
                  alerts(
                    after: $after
                    first: $first
                    filters: $filters
                    sort: $sort
                  ) {
                    totalCount
                    pageInfo {
                      hasNextPage
                      hasPreviousPage
                      startCursor
                      endCursor
                    }
                    edges {
                      cursor
                      node {
                        id
                        aiInvestigation {
                          purpleAiStatus
                          status
                          verdict
                        }
                        analystVerdict
                        analytics {
                          category
                          name
                          typeValue
                          uid
                        }
                        assets {
                          accessible
                          agentUuid
                          agentVersion
                          assetTypeClassifier
                          category
                          connectivityToConsole
                          decommissioned
                          id
                          lastLoggedInUser
                          name
                          origin
                          osType
                          osVersion
                          pendingReboot
                          policy
                          role
                          status
                          subcategory
                        }
                        assignee {
                          email
                          fullName
                          userId
                        }
                        attackSurfaces
                        availableActionIds
                        classification
                        confidenceLevel
                        createdAt
                        dataSources
                        description
                        detectedAt
                        detectionSource {
                          product
                          vendor
                        }
                        detectionTime {
                          assets {
                            accessible
                            asset {
                              agentVersion
                              consoleIpAddress
                              domain
                              ipV4
                              ipV6
                              lastLoggedInUser
                              osName
                              osRevision
                              osType
                              policy
                              subscriptionTime
                            }
                            cloud {
                              accountId
                              cloudProvider
                              image
                              instanceId
                              instanceSize
                              location
                              network
                              providerDetails {
                                ... on DetectionAws {
                                  accountId
                                  imageId
                                  instanceId
                                  instanceType
                                  region
                                  role
                                  securityGroups
                                  subnetIds
                                  tags
                                  vpcId
                                }
                                ... on DetectionAzure {
                                  imageId
                                  instanceId
                                  instanceType
                                  region
                                  resourceGroup
                                  subscriptionId
                                  tags
                                }
                                ... on DetectionGcp {
                                  imageId
                                  instanceId
                                  instanceType
                                  projectId
                                  serviceAccount
                                  tags
                                  vpcId
                                  zone
                                }
                              }
                              tags
                            }
                            kubernetes {
                              clusterName
                              containerId
                              containerImageName
                              containerLabels
                              containerName
                              controllerLabels
                              controllerName
                              controllerType
                              namespaceLabels
                              namespaceName
                              nodeLabels
                              nodeName
                              podLabels
                              podName
                            }
                            origin
                            scope {
                              accountId
                              accountName
                              groupName
                              siteName
                            }
                          }
                          attacker {
                            host
                            ip
                          }
                          scope {
                            accountId
                            accountName
                            groupName
                            siteName
                          }
                          targetUser {
                            domain
                            emailAddress
                            name
                          }
                        }
                        exclusionHash
                        externalId
                        firstSeenAt
                        lastSeenAt
                        name
                        noteExists
                        process {
                          cmdLine
                          file {
                            certSubject
                            md5
                            name
                            path
                            sha1
                            sha256
                          }
                          parentName
                        }
                        realTime {
                          scope {
                            account {
                              id
                              name
                            }
                            group {
                              id
                              name
                            }
                            site {
                              id
                              name
                            }
                          }
                        }
                        result
                        severity
                        sloDetails {
                          timeToResolveData {
                            actionComplete
                            actionDue
                            completion
                            completionTime
                            status
                            target
                            targetTime
                          }
                          timeToResponseData {
                            actionComplete
                            actionDue
                            completion
                            completionTime
                            status
                            target
                            targetTime
                          }
                        }
                        status
                        storylineId
                        ticketId
                        updatedAt
                      }
                    }
                  }
                }
            want_more: false
          tags:
            - forwarded
            - sentinel_one-unified_alert
      type: cel
      use_output: default
output_permissions:
    default:
        _elastic_agent_checks:
            cluster:
                - monitor
        _elastic_agent_monitoring:
            indices: []
        uuid-for-permissions-on-related-indices:
            indices:
                - names:
                    - logs-sentinel_one.unified_alert-ep
                  privileges:
                    - auto_configure
                    - create_doc
secret_references:
    - {}
