---
description: Pipeline for processing unified alert logs.
processors:
  - drop:
      if: ctx.message == 'retry'
      tag: drop_retry_events
  - set:
      field: ecs.version
      tag: set_ecs_version
      value: 9.3.0
  - terminate:
      tag: data_collection_error
      if: ctx.error?.message != null && ctx.message == null && ctx.event?.original == null
      description: error message set and no data to process.
  - remove:
      field:
        - organization
        - division
        - team
      ignore_missing: true
      if: ctx.organization instanceof String && ctx.division instanceof String && ctx.team instanceof String
      tag: remove_agentless_tags
      description: >-
        Removes the fields added by Agentless as metadata,
        as they can collide with ECS fields.

  # parse the event JSON
  - rename:
      field: message
      tag: rename_message_to_event_original
      target_field: event.original
      ignore_missing: true
      description: Renames the original `message` field to `event.original` to store a copy of the original message.
      if: ctx.event?.original == null
  - remove:
      field: message
      tag: remove_message
      ignore_missing: true
      description: The `message` field is no longer required if the document has an `event.original` field.
      if: ctx.event?.original != null
  - json:
      field: event.original
      tag: json_event_original
      target_field: json
  - fingerprint:
      fields:
        - json.updatedAt
        - json.detectedAt
        - json.id
        - json.externalId
      target_field: _id
      tag: fingerprint_unified_alert
      ignore_missing: true

  # rename to snake case
  - script:
      tag: script_convert_camelcase_to_snake_case
      lang: painless
      description: Convert camelCase to snake_case
      if: ctx.json != null
      source: |
        // Helper function to convert camelCase to snake_case
        String camelToSnake(String str) {
          def result = "";
          def lastCharWasUpperCase = false;
          for (int i = 0; i < str.length(); i++) {
            char c = str.charAt(i);
            if (Character.isUpperCase(c)) {
              if (i > 0 && !lastCharWasUpperCase) {
                result += "_";
              }
              result += Character.toLowerCase(c);
              lastCharWasUpperCase = true;
            } else {
              result += c;
              lastCharWasUpperCase = false;
            }
          }
          return result;
        }
        // Recursive function to handle nested fields
        def convertToSnakeCase(def obj) {
          if (obj instanceof Map) {
            // Convert each key in the map
            def newObj = [:];
            for (entry in obj.entrySet()) {
              // Skip fields that contain '@' in their name
              if (!entry.getKey().contains("@")) {
                String newKey = camelToSnake(entry.getKey());
                newObj[newKey] = convertToSnakeCase(entry.getValue());
              }
            }
            return newObj;
          } else if (obj instanceof List) {
            // If it's a list, process each item recursively
            def newList = [];
            for (item in obj) {
              newList.add(convertToSnakeCase(item));
            }
            return newList;
          } else {
            return obj;
          }
        }
        // Apply the conversion
        ctx.sentinel_one = ctx.sentinel_one ?: [:];
        ctx.sentinel_one.unified_alert = convertToSnakeCase(ctx.json);
  - set:
      field: sentinel_one.site.id
      copy_from: sentinel_one.unified_alert.real_time.scope.site.id
      tag: set_sentinel_one_site_id
      ignore_empty_value: true
  - set:
      field: sentinel_one.site.name
      copy_from: sentinel_one.unified_alert.real_time.scope.site.name
      tag: set_sentinel_one_site_name
      ignore_empty_value: true
  - set:
      field: sentinel_one.account.name
      copy_from: sentinel_one.unified_alert.real_time.scope.account.name
      tag: set_sentinel_one_account_name
      ignore_empty_value: true
  - set:
      field: sentinel_one.account.id
      copy_from: sentinel_one.unified_alert.real_time.scope.account.id
      tag: set_sentinel_one_account_id
      ignore_empty_value: true
  - set:
      field: sentinel_one.threat_classification.name
      copy_from: sentinel_one.unified_alert.classification
      tag: set_sentinel_one_threat_classification_name
      ignore_empty_value: true

  # convert values
  - date:
      field: sentinel_one.unified_alert.created_at
      tag: date_created_at
      target_field: sentinel_one.unified_alert.created_at
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.created_at != null && ctx.sentinel_one.unified_alert.created_at != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.created_at
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: sentinel_one.unified_alert.assets
      tag: foreach_assets_accessible
      if: ctx.sentinel_one?.unified_alert?.assets instanceof List
      processor:
        convert:
          field: _ingest._value.accessible
          tag: convert_assets_accessible_to_boolean
          type: boolean
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.accessible
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: sentinel_one.unified_alert.assets
      tag: foreach_assets_decommissioned
      if: ctx.sentinel_one?.unified_alert?.assets instanceof List
      processor:
        convert:
          field: _ingest._value.decommissioned
          tag: convert_assets_decommissioned_to_boolean
          type: boolean
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.decommissioned
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: sentinel_one.unified_alert.assets
      tag: foreach_assets_pending_reboot
      if: ctx.sentinel_one?.unified_alert?.assets instanceof List
      processor:
        convert:
          field: _ingest._value.pending_reboot
          tag: convert_assets_pending_reboot_to_boolean
          type: boolean
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.pending_reboot
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: sentinel_one.unified_alert.detected_at
      tag: date_detected_at
      target_field: sentinel_one.unified_alert.detected_at
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.detected_at != null && ctx.sentinel_one.unified_alert.detected_at != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.detected_at
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: sentinel_one.unified_alert.detection_time.assets
      tag: foreach_detection_time_assets_accessible
      if: ctx.sentinel_one?.unified_alert?.detection_time?.assets instanceof List
      processor:
        convert:
          field: _ingest._value.accessible
          tag: convert_detection_time_assets_accessible_to_boolean
          type: boolean
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.accessible
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: sentinel_one.unified_alert.detection_time.assets
      tag: foreach_detection_time_assets_asset_console_ip_address
      if: ctx.sentinel_one?.unified_alert?.detection_time?.assets instanceof List
      processor:
        convert:
          field: _ingest._value.asset.console_ip_address
          tag: convert_detection_time_assets_asset_console_ip_address_to_ip
          type: ip
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.asset.console_ip_address
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: sentinel_one.unified_alert.detection_time.assets
      tag: foreach_detection_time_assets_asset_ip_v4
      if: ctx.sentinel_one?.unified_alert?.detection_time?.assets instanceof List
      processor:
        convert:
          field: _ingest._value.asset.ip_v4
          tag: convert_detection_time_assets_asset_ip_v4_to_ip
          type: ip
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.asset.ip_v4
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: sentinel_one.unified_alert.detection_time.assets
      tag: foreach_detection_time_assets_asset_ip_v6
      if: ctx.sentinel_one?.unified_alert?.detection_time?.assets instanceof List
      processor:
        convert:
          field: _ingest._value.asset.ip_v6
          tag: convert_detection_time_assets_asset_ip_v6_to_ip
          type: ip
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.asset.ip_v6
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: sentinel_one.unified_alert.detection_time.assets
      tag: foreach_detection_time_assets_asset_subscription_time
      if: ctx.sentinel_one?.unified_alert?.detection_time?.assets instanceof List
      processor:
        date:
          field: _ingest._value.asset.subscription_time
          tag: date_detection_time_assets_asset_subscription_time
          target_field: _ingest._value.asset.subscription_time
          formats:
            - ISO8601
          on_failure:
            - remove:
                field: _ingest._value.asset.subscription_time
                ignore_missing: true
  - convert:
      field: sentinel_one.unified_alert.detection_time.attacker.ip
      tag: convert_detection_time_attacker_ip_to_ip
      type: ip
      ignore_missing: true
      if: ctx.sentinel_one?.unified_alert?.detection_time?.attacker?.ip != null && ctx.sentinel_one.unified_alert.detection_time.attacker.ip != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.detection_time.attacker.ip
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: sentinel_one.unified_alert.first_seen_at
      tag: date_first_seen_at
      target_field: sentinel_one.unified_alert.first_seen_at
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.first_seen_at != null && ctx.sentinel_one.unified_alert.first_seen_at != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.first_seen_at
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: sentinel_one.unified_alert.last_seen_at
      tag: date_last_seen_at
      target_field: sentinel_one.unified_alert.last_seen_at
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.last_seen_at != null && ctx.sentinel_one.unified_alert.last_seen_at != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.last_seen_at
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.note_exists
      tag: convert_note_exists_to_boolean
      type: boolean
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.note_exists
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.action_complete
      tag: convert_slo_details_time_to_resolve_data_action_complete_to_boolean
      type: boolean
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.action_complete
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.action_due
      tag: convert_slo_details_time_to_resolve_data_action_due_to_long
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.action_due
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.completion
      tag: convert_slo_details_time_to_resolve_data_completion_to_long
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.completion
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.completion_time
      tag: date_slo_details_time_to_resolve_data_completion_time
      target_field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.completion_time
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.slo_details?.time_to_resolve_data?.completion_time != null && ctx.sentinel_one.unified_alert.slo_details.time_to_resolve_data.completion_time != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.completion_time
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.target
      tag: convert_slo_details_time_to_resolve_data_target_to_long
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.target
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.target_time
      tag: date_slo_details_time_to_resolve_data_target_time
      target_field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.target_time
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.slo_details?.time_to_resolve_data?.target_time != null && ctx.sentinel_one.unified_alert.slo_details.time_to_resolve_data.target_time != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_resolve_data.target_time
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.slo_details.time_to_response_data.action_complete
      tag: convert_slo_details_time_to_response_data_action_complete_to_boolean
      type: boolean
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_response_data.action_complete
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.slo_details.time_to_response_data.action_due
      tag: convert_slo_details_time_to_response_data_action_due_to_long
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_response_data.action_due
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.slo_details.time_to_response_data.completion
      tag: convert_slo_details_time_to_response_data_completion_to_long
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_response_data.completion
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: sentinel_one.unified_alert.slo_details.time_to_response_data.completion_time
      tag: date_slo_details_time_to_response_data_completion_time
      target_field: sentinel_one.unified_alert.slo_details.time_to_response_data.completion_time
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.slo_details?.time_to_response_data?.completion_time != null && ctx.sentinel_one.unified_alert.slo_details.time_to_response_data.completion_time != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_response_data.completion_time
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: sentinel_one.unified_alert.slo_details.time_to_response_data.target
      tag: convert_slo_details_time_to_response_data_target_to_long
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_response_data.target
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: sentinel_one.unified_alert.slo_details.time_to_response_data.target_time
      tag: date_slo_details_time_to_response_data_target_time
      target_field: sentinel_one.unified_alert.slo_details.time_to_response_data.target_time
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.slo_details?.time_to_response_data?.target_time != null && ctx.sentinel_one.unified_alert.slo_details.time_to_response_data.target_time != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.slo_details.time_to_response_data.target_time
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: sentinel_one.unified_alert.updated_at
      tag: date_updated_at
      target_field: sentinel_one.unified_alert.updated_at
      formats:
        - ISO8601
      if: ctx.sentinel_one?.unified_alert?.updated_at != null && ctx.sentinel_one.unified_alert.updated_at != ''
      on_failure:
        - remove:
            field: sentinel_one.unified_alert.updated_at
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # populate ECS fields
  - set:
      field: message
      tag: set_message_from_unified_alert_name
      copy_from: sentinel_one.unified_alert.name
      ignore_empty_value: true

  # event.*
  - set:
      field: event.kind
      tag: set_event_kind_to_alert
      value: alert
  - append:
      field: event.category
      tag: append_malware_into_event_category
      value: malware
      if: ctx.sentinel_one?.unified_alert?.classification != null && ['MALWARE','RANSOMWARE','TROJAN','DOWNLOADER','WORM','VIRUS','SPYWARE','KEYLOGGER','INFO_STEALER','ROOTKIT','BACKDOOR','DROPPER','COINMINER','CRYPTOMINER','MINER','PACKED','LINUX_MALWARE','MALICIOUS_OFFICE_DOC','MALICIOUS_PDF','GENERIC_HEURISTIC','PUA','ROGUE','TOOLBAR'].contains(ctx.sentinel_one.unified_alert.classification)
  - append:
      field: event.category
      tag: append_intrusion_detection_into_event_category
      value: intrusion_detection
      if: ctx.sentinel_one?.unified_alert?.classification != null && ['COMMAND_AND_CONTROL','EXPLOIT','HACKTOOL','ENUMERATION','INTERACTIVE_SHELL','REMOTE_SHELL','LATERAL_MOVEMENT','MANUAL'].contains(ctx.sentinel_one.unified_alert.classification)
  - append:
      field: event.category
      tag: append_network_into_event_category
      value: network
      if: ctx.sentinel_one?.unified_alert?.classification != null && ctx.sentinel_one.unified_alert.classification == 'NETWORK'
  - append:
      field: event.category
      tag: append_email_into_event_category
      value: email
      if: ctx.sentinel_one?.unified_alert?.classification != null && ctx.sentinel_one.unified_alert.classification == 'PHISHING'
  - append:
      field: event.type
      tag: append_info_into_event_type
      value: info
  - set:
      field: event.created
      tag: set_event_created_from_unified_alert_created_at
      copy_from: sentinel_one.unified_alert.created_at
      ignore_empty_value: true
  - set:
      field: event.start
      tag: set_event_start_from_unified_alert_first_seen_at
      copy_from: sentinel_one.unified_alert.first_seen_at
      ignore_empty_value: true
  - set:
      field: event.end
      tag: set_event_end_from_unified_alert_last_seen_at
      copy_from: sentinel_one.unified_alert.last_seen_at
      ignore_empty_value: true
  - set:
      field: event.id
      tag: set_event_id_from_unified_alert_id
      copy_from: sentinel_one.unified_alert.id
      ignore_empty_value: true
  - set:
      field: event.outcome
      tag: set_event_outcome_to_success
      value: success
      if: ctx.sentinel_one?.unified_alert?.result != null && ctx.sentinel_one.unified_alert.result.equalsIgnoreCase("mitigated")
  - set:
      field: event.outcome
      tag: set_event_outcome_to_failure
      value: failure
      if: ctx.sentinel_one?.unified_alert?.result != null && ctx.sentinel_one.unified_alert.result.equalsIgnoreCase("unmitigated")
  - script:
      lang: painless
      description: Script to set event.severity.
      tag: set_event_severity
      if: ctx.sentinel_one?.unified_alert?.severity instanceof String
      source: |-
        ctx.event = ctx.event ?: [:];
        String severity = ctx.sentinel_one.unified_alert.severity;
        if (severity.equalsIgnoreCase("low")) {
          ctx.event.severity = 21;
        } else if (severity.equalsIgnoreCase("medium")) {
          ctx.event.severity = 47;
        } else if (severity.equalsIgnoreCase("high")) {
          ctx.event.severity = 73;
        } else if (severity.equalsIgnoreCase("critical")) {
          ctx.event.severity = 99;
        }
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: '@timestamp'
      tag: set_@timestamp_from_unified_alert_updated_at
      copy_from: sentinel_one.unified_alert.updated_at
      ignore_empty_value: true

  # group.*
  - set:
      field: group.name
      copy_from: sentinel_one.unified_alert.real_time.scope.group.name
      tag: set_group_name
      ignore_empty_value: true
  - set:
      field: group.id
      copy_from: sentinel_one.unified_alert.real_time.scope.group.id
      tag: set_group_id
      ignore_empty_value: true

  # source.*
  - set:
      field: source.domain
      tag: set_source_domain_from_unified_alert_detection_time_attacker_host
      copy_from: sentinel_one.unified_alert.detection_time.attacker.host
      ignore_empty_value: true
  - set:
      field: source.ip
      tag: set_source_ip_from_unified_alert_detection_time_attacker_ip
      copy_from: sentinel_one.unified_alert.detection_time.attacker.ip
      ignore_empty_value: true

  # user.*
  - set:
      field: user.domain
      tag: set_user_domain_from_unified_alert_detection_time_target_user_domain
      copy_from: sentinel_one.unified_alert.detection_time.target_user.domain
      ignore_empty_value: true
  - set:
      field: user.email
      tag: set_user_email_from_unified_alert_detection_time_target_user_email_address
      copy_from: sentinel_one.unified_alert.detection_time.target_user.email_address
      ignore_empty_value: true
  - set:
      field: user.name
      tag: set_user_name_from_unified_alert_detection_time_target_user_name
      copy_from: sentinel_one.unified_alert.detection_time.target_user.name
      ignore_empty_value: true

  # ECS mapping from assets[0] and detection_time.assets[0]
  - script:
      description: Extract ECS fields from assets[] and detection_time.assets[].
      tag: script_extract_ecs_from_single_asset
      lang: painless
      params:
        os_type:
          - linux
          - macos
          - unix
          - windows
          - ios
          - android
      source: |-
        // In SentinelOne, it appears that each alert is typically associated with a single primary asset.
        // Therefore, we will extract ECS fields from the first asset in the assets array

        ctx.related = ctx.related ?: [:];
        ctx.related.hosts = ctx.related.hosts ?: [];
        ctx.related.user = ctx.related.user ?: [];
        ctx.related.ip = ctx.related.ip ?: [];
        ctx.host = ctx.host ?: [:];
        ctx.host.ip = ctx.host.ip ?: [];
        ctx.host.os = ctx.host.os ?: [:];
        ctx.cloud = ctx.cloud ?: [:];
        ctx.cloud.instance = ctx.cloud.instance ?: [:];
        ctx.cloud.machine = ctx.cloud.machine ?: [:];
        ctx.cloud.account = ctx.cloud.account ?: [:];
        ctx.cloud.machine.type = ctx.cloud.machine.type ?: [];
        ctx.cloud.region = ctx.cloud.region ?: [];
        ctx.cloud.instance.id = ctx.cloud.instance.id ?: [];
        ctx.cloud.account.id = ctx.cloud.account.id ?: [];
        ctx.cloud.account.name = ctx.cloud.account.name ?: [];
        ctx.cloud.project = ctx.cloud.project ?: [:];
        ctx.cloud.project.id = ctx.cloud.project.id ?: [];
        ctx.container = ctx.container ?: [:];
        ctx.container.id = ctx.container.id ?: [];
        ctx.container.name = ctx.container.name ?: [];
        ctx.container.image = ctx.container.image ?: [:];
        ctx.container.image.name = ctx.container.image.name ?: [];
        ctx.container.labels = ctx.container.labels ?: [];
        ctx.orchestrator = ctx.orchestrator ?: [:];
        ctx.orchestrator.cluster = ctx.orchestrator.cluster ?: [:];
        ctx.orchestrator.namespace = ctx.orchestrator.namespace ?: [];
        ctx.orchestrator.resource = ctx.orchestrator.resource ?: [:];
        ctx.orchestrator.resource.parent = ctx.orchestrator.resource.parent ?: [:];
        ctx.orchestrator.resource.parent.type = ctx.orchestrator.resource.parent.type ?: [];
        ctx.orchestrator.resource.label = ctx.orchestrator.resource.label ?: [];
        ctx.orchestrator.resource.name = ctx.orchestrator.resource.name ?: [];
        ctx.observer = ctx.observer ?: [:];

        def assets = ctx.sentinel_one?.unified_alert?.assets;
        if (assets instanceof List && assets.size() > 0) {
          def asset = assets[0];
          if (asset.agent_uuid != null) { ctx.observer.serial_number = asset.agent_uuid; }
          if (asset.agent_version != null) { ctx.observer.version = asset.agent_version; }
          if (asset.id != null) { ctx.related.hosts.add(asset.id); }
          if (asset.name != null) { ctx.related.hosts.add(asset.name); ctx.host.name = asset.name; }
          if (asset.subcategory != null) { ctx.host.type = asset.subcategory; }
          if (asset.last_logged_in_user != null) { ctx.related.user.add(asset.last_logged_in_user); }
        }

        def dtAssets = ctx.sentinel_one?.unified_alert?.detection_time?.assets;
        if (dtAssets instanceof List && dtAssets.size() > 0) {
          def a = dtAssets[0].asset;
          def c = dtAssets[0].cloud;
          def pd = c?.provider_details;
          def k = dtAssets[0].kubernetes;
          if (a != null) {
            if (a.console_ip_address != null) { ctx.host.ip.add(a.console_ip_address); ctx.related.ip.add(a.console_ip_address); }
            if (a.ip_v4 != null) { ctx.host.ip.add(a.ip_v4); ctx.related.ip.add(a.ip_v4); }
            if (a.ip_v6 != null) { ctx.host.ip.add(a.ip_v6); ctx.related.ip.add(a.ip_v6); }
            if (a.last_logged_in_user != null) { ctx.related.user.add(a.last_logged_in_user); }
            if (a.os_name != null) { ctx.host.os.name = a.os_name; }
            if (a.os_revision != null) { ctx.host.os.version = a.os_revision; }
            if (a.os_type != null) {
              String os_type = a.os_type.toLowerCase();
              for (String os: params.os_type) {
                if (os_type.contains(os)) {
                  ctx.host.os.type = os;
                  return;
                }
              }
            }
          }
          if (c != null) {
            if (c.account_id != null) { ctx.cloud.account.name = c.account_id; }
            if (c.cloud_provider != null) { ctx.cloud.provider = c.cloud_provider; }
            if (c.instance_id != null) { ctx.cloud.instance.id = c.instance_id; }
            if (c.instance_size != null) { ctx.cloud.machine.type = c.instance_size; }
            if (c.location != null) { ctx.cloud.region = c.location; }
            if (pd != null) {
              if (pd.account_id != null) { ctx.cloud.account.id = pd.account_id; }
              if (pd.instance_id != null && ctx.cloud?.instance?.id == null) { ctx.cloud.instance.id = pd.instance_id; }
              if (pd.instance_type != null && ctx.cloud?.machine?.type == null) { ctx.cloud.machine.type = pd.instance_type; }
              if (pd.project_id != null) { ctx.cloud.project.id = pd.project_id; }
              if (pd.region != null && ctx.cloud?.region == null) { ctx.cloud.region = pd.region; }
              if (pd.service_account != null) { ctx.cloud.account.id = pd.service_account; }
              if (pd.subscription_id != null) { ctx.cloud.account.id = pd.subscription_id; }
            }
          }
          if (k != null) {
            if (k.cluster_name != null) { ctx.orchestrator.cluster.name = k.cluster_name; }
            if (k.container_id != null) { ctx.container.id = k.container_id; }
            if (k.container_image_name != null) { ctx.container.image.name = k.container_image_name; }
            if (k.container_name != null) { ctx.container.name = k.container_name; }
            if (k.controller_type != null) { ctx.orchestrator.resource.parent.type = k.controller_type; }
            if (k.namespace_name != null) { ctx.orchestrator.namespace = k.namespace_name; }
            if (k.pod_labels != null) { ctx.orchestrator.resource.label = k.pod_labels; }
            if (k.pod_name != null) { ctx.orchestrator.resource.name = k.pod_name; }
          }
        }
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # process.*
  - set:
      field: process.command_line
      tag: set_process_command_line_from_unified_alert_process_cmd_line
      copy_from: sentinel_one.unified_alert.process.cmd_line
      ignore_empty_value: true
  - set:
      field: process.parent.command_line
      tag: set_process_parent_command_line_from_unified_alert_process_parent_name
      copy_from: sentinel_one.unified_alert.process.parent_name
      ignore_empty_value: true
  
  # file.*
  - set:
      field: file.hash.md5
      tag: set_file_hash_md5_from_unified_alert_process_file_md5
      copy_from: sentinel_one.unified_alert.process.file.md5
      ignore_empty_value: true
  - set:
      field: file.name
      tag: set_file_name_from_unified_alert_process_file_name
      copy_from: sentinel_one.unified_alert.process.file.name
      ignore_empty_value: true
  - set:
      field: file.path
      tag: set_file_path_from_unified_alert_process_file_path
      copy_from: sentinel_one.unified_alert.process.file.path
      ignore_empty_value: true
  - set:
      field: file.hash.sha1
      tag: set_file_hash_sha1_from_unified_alert_process_file_sha1
      copy_from: sentinel_one.unified_alert.process.file.sha1
      ignore_empty_value: true
  - set:
      field: file.hash.sha256
      tag: set_file_hash_sha256_from_unified_alert_process_file_sha256
      copy_from: sentinel_one.unified_alert.process.file.sha256
      ignore_empty_value: true
  
  # related.*
  - append:
      field: related.hosts
      tag: append_unified_alert_detection_time_attacker_host_into_related_hosts
      value: '{{{sentinel_one.unified_alert.detection_time.attacker.host}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.detection_time?.attacker?.host != null
  - append:
      field: related.ip
      tag: append_unified_alert_detection_time_attacker_ip_into_related_ip
      value: '{{{sentinel_one.unified_alert.detection_time.attacker.ip}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.detection_time?.attacker?.ip != null
  - append:
      field: related.user
      tag: append_unified_alert_detection_time_target_user_email_address_into_related_user
      value: '{{{sentinel_one.unified_alert.detection_time.target_user.email_address}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.detection_time?.target_user?.email_address != null
  - append:
      field: related.user
      tag: append_unified_alert_detection_time_target_user_name_into_related_user
      value: '{{{sentinel_one.unified_alert.detection_time.target_user.name}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.detection_time?.target_user?.name != null
  - append:
      field: related.user
      tag: append_unified_alert_assignee_email_into_related_user
      value: '{{{sentinel_one.unified_alert.assignee.email}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.assignee?.email != null
  - append:
      field: related.user
      tag: append_unified_alert_assignee_full_name_into_related_user
      value: '{{{sentinel_one.unified_alert.assignee.full_name}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.assignee?.full_name != null
  - append:
      field: related.user
      tag: append_unified_alert_assignee_user_id_into_related_user
      value: '{{{sentinel_one.unified_alert.assignee.user_id}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.assignee?.user_id != null
  - append:
      field: related.hash
      tag: append_unified_alert_process_file_md5_into_related_hash
      value: '{{{sentinel_one.unified_alert.process.file.md5}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.process?.file?.md5 != null
  - append:
      field: related.hash
      tag: append_unified_alert_process_file_sha1_into_related_hash
      value: '{{{sentinel_one.unified_alert.process.file.sha1}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.process?.file?.sha1 != null
  - append:
      field: related.hash
      tag: append_unified_alert_process_file_sha256_into_related_hash
      value: '{{{sentinel_one.unified_alert.process.file.sha256}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.process?.file?.sha256 != null
  - append:
      field: related.hash
      tag: append_unified_alert_exclusion_hash_into_related_hash
      value: '{{{sentinel_one.unified_alert.exclusion_hash}}}'
      allow_duplicates: false
      if: ctx.sentinel_one?.unified_alert?.exclusion_hash != null

  # remove custom duplicate fields (already mapped to ECS)
  - foreach:
      field: sentinel_one.unified_alert.assets
      tag: foreach_sentinel_one_unified_alert_assets
      if: ctx.sentinel_one?.unified_alert?.assets instanceof List
      processor:
        remove:
          field:
            - _ingest._value.agent_uuid
            - _ingest._value.agent_version
            - _ingest._value.name
            - _ingest._value.subcategory
          tag: remove_custom_duplicate_fields_from_sentinel_one_unified_alert_assets
          ignore_missing: true
          if: ctx.tags == null || !ctx.tags.contains('preserve_duplicate_custom_fields')
  - foreach:
      field: sentinel_one.unified_alert.detection_time.assets
      tag: foreach_sentinel_one_unified_alert_detection_time_assets
      if: ctx.sentinel_one?.unified_alert?.detection_time?.assets instanceof List
      processor:
        remove:
          field:
            - _ingest._value.asset.os_name
            - _ingest._value.asset.os_revision
            - _ingest._value.cloud.account_id
            - _ingest._value.cloud.cloud_provider
            - _ingest._value.cloud.instance_id
            - _ingest._value.cloud.instance_size
            - _ingest._value.cloud.location
            - _ingest._value.cloud.provider_details.account_id
            - _ingest._value.cloud.provider_details.subscription_id
            - _ingest._value.cloud.provider_details.project_id
            - _ingest._value.cloud.provider_details.service_account
            - _ingest._value.kubernetes.cluster_name
            - _ingest._value.kubernetes.container_id
            - _ingest._value.kubernetes.container_name
            - _ingest._value.kubernetes.controller_type
            - _ingest._value.kubernetes.namespace_name
            - _ingest._value.kubernetes.pod_labels
            - _ingest._value.kubernetes.pod_name
          tag: remove_custom_duplicate_fields_from_sentinel_one_unified_alert_detection_time_assets
          ignore_missing: true
          if: ctx.tags == null || !ctx.tags.contains('preserve_duplicate_custom_fields')
  - remove:
      field:
        - sentinel_one.unified_alert.created_at
        - sentinel_one.unified_alert.detection_time.attacker.host
        - sentinel_one.unified_alert.detection_time.attacker.ip
        - sentinel_one.unified_alert.detection_time.target_user.domain
        - sentinel_one.unified_alert.detection_time.target_user.email_address
        - sentinel_one.unified_alert.detection_time.target_user.name
        - sentinel_one.unified_alert.first_seen_at
        - sentinel_one.unified_alert.id
        - sentinel_one.unified_alert.last_seen_at
        - sentinel_one.unified_alert.process.cmd_line
        - sentinel_one.unified_alert.process.file.md5
        - sentinel_one.unified_alert.process.file.name
        - sentinel_one.unified_alert.process.file.path
        - sentinel_one.unified_alert.process.file.sha1
        - sentinel_one.unified_alert.process.file.sha256
        - sentinel_one.unified_alert.process.parent_name
        - sentinel_one.unified_alert.real_time.scope.group.name
        - sentinel_one.unified_alert.real_time.scope.group.id
        - sentinel_one.unified_alert.updated_at
      tag: remove_custom_duplicate_fields
      ignore_missing: true
      if: ctx.tags == null || !ctx.tags.contains('preserve_duplicate_custom_fields')
  - remove:
      field: json
      tag: remove_json
      ignore_missing: true
  - script:
      tag: script_to_drop_null_values
      lang: painless
      description: This script processor iterates over the whole document to remove fields with null values.
      source: |-
        void handleMap(Map map) {
          map.values().removeIf(v -> {
            if (v instanceof Map) {
              handleMap(v);
            } else if (v instanceof List) {
              handleList(v);
            }
            return v == null || v == '' || (v instanceof Map && v.size() == 0) || (v instanceof List && v.size() == 0)
          });
        }
        void handleList(List list) {
          list.removeIf(v -> {
            if (v instanceof Map) {
              handleMap(v);
            } else if (v instanceof List) {
              handleList(v);
            }
            return v == null || v == '' || (v instanceof Map && v.size() == 0) || (v instanceof List && v.size() == 0)
          });
        }
        handleMap(ctx);
  - set:
      field: event.kind
      tag: set_pipeline_error_into_event_kind
      value: pipeline_error
      if: ctx.error?.message != null
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
      if: ctx.error?.message != null
on_failure:
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}}failed with message '{{{ _ingest.on_failure_message }}}'
  - set:
      field: event.kind
      tag: set_pipeline_error_to_event_kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
