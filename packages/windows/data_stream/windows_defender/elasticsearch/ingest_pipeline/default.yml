---
description: Pipeline for Microsoft-Windows-Windows Defender/Operational events
processors:
  ## ECS and Event fields.

  - set:
      field: ecs.version
      value: '8.11.0'
  - set:
      field: log.level
      copy_from: winlog.level
      ignore_empty_value: true
      ignore_failure: true
      if: ctx.winlog?.level != ""
  - date:
      field: winlog.time_created
      tag: "time_created_date"
      formats:
        - ISO8601
      if: ctx.winlog?.time_created != null
      on_failure:
        - remove:
            field: winlog.time_created
            ignore_failure: true
        - append:
            field: error.message
            value: "fail-{{{ _ingest.on_failure_processor_tag }}}"
        - fail:
            message: "Processor {{ _ingest.on_failure_processor_type }} with tag {{ _ingest.on_failure_processor_tag }} in pipeline {{ _ingest.on_failure_pipeline }} failed with message: {{ _ingest.on_failure_message }}"

  - set:
      field: event.kind
      value: event
  - set:
      field: event.code
      value: '{{winlog.event_id}}'
  - set:
      field: event.category
      value: process
  - set:
      field: event.type
      value: start
  - convert:
      field: winlog.record_id
      type: string
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: winlog.event_data.AS security intelligence creation time
      target_field: winlog.event_data.AS_security_intelligence_creation_time
      ignore_missing: true
  - rename:
      field: winlog.event_data.AS security intelligence version
      target_field: winlog.event_data.AS_security_intelligence_version
      ignore_missing: true
  - rename:
      field: winlog.event_data.AV security intelligence creation time
      target_field: winlog.event_data.AV_security_intelligence_creation_time
      ignore_missing: true
  - rename:
      field: winlog.event_data.AV security intelligence version
      target_field: winlog.event_data.AV_security_intelligence_version
      ignore_missing: true
  - rename:
      field: winlog.event_data.BM state
      target_field: winlog.event_data.BM_state
      ignore_missing: true
  - rename:
      field: winlog.event_data.Engine up-to-date
      target_field: winlog.event_data.Engine_up-to-date
      ignore_missing: true
  - rename:
      field: winlog.event_data.Engine version
      target_field: winlog.event_data.Engine_version
      ignore_missing: true
  - rename:
      field: winlog.event_data.IOAV state
      target_field: winlog.event_data.IOAV_state
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last AS security intelligence age
      target_field: winlog.event_data.Last_AS_security_intelligence_age
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last AV security intelligence age
      target_field: winlog.event_data.Last_AV_security_intelligence_age
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last full scan age
      target_field: winlog.event_data.Last_full_scan_age
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last full scan end time
      target_field: winlog.event_data.Last_full_scan_end_time
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last full scan source
      target_field: winlog.event_data.Last_full_scan_source
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last full scan start time
      target_field: winlog.event_data.Last_full_scan_start_time
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last quick scan age
      target_field: winlog.event_data.Last_quick_scan_age
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last quick scan end time
      target_field: winlog.event_data.Last_quick_scan_end_time
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last quick scan source
      target_field: winlog.event_data.Last_quick_scan_source
      ignore_missing: true
  - rename:
      field: winlog.event_data.Last quick scan start time
      target_field: winlog.event_data.Last_quick_scan_start_time
      ignore_missing: true
  - rename:
      field: winlog.event_data.Latest engine version
      target_field: winlog.event_data.Latest_engine_version
      ignore_missing: true
  - rename:
      field: winlog.event_data.Latest platform version
      target_field: winlog.event_data.Latest_platform_version
      ignore_missing: true
  - rename:
      field: winlog.event_data.NRI engine version
      target_field: winlog.event_data.NRI_engine_version
      ignore_missing: true
  - rename:
      field: winlog.event_data.NRI security intelligence version
      target_field: winlog.event_data.NRI_security_intelligence_version
      ignore_missing: true
  - rename:
      field: winlog.event_data.OA state
      target_field: winlog.event_data.OA_state
      ignore_missing: true
  - rename:
      field: winlog.event_data.Platform up-to-date
      target_field: winlog.event_data.Platform_up-to-date
      ignore_missing: true
  - rename:
      field: winlog.event_data.Platform version
      target_field: winlog.event_data.Platform_version
      ignore_missing: true
  - rename:
      field: winlog.event_data.Product Name
      target_field: winlog.event_data.Product_Name
      ignore_missing: true
  - rename:
      field: winlog.event_data.Product status
      target_field: winlog.event_data.Product_status
      ignore_missing: true
  - rename:
      field: winlog.event_data.RTP state
      target_field: winlog.event_data.RTP_state
      ignore_missing: true
  

  ## User fields.

  - set:
      field: user.id
      copy_from: winlog.user.identifier
      ignore_failure: true
      ignore_empty_value: true
  - split:
      field: winlog.event_data.User
      target_field: "_temp.user_parts"
      separator: '\\'
      if: ctx.winlog?.event_data?.User != null
  - set:
      field: user.domain
      value: "{{_temp.user_parts.0}}"
      ignore_failure: true
      ignore_empty_value: true
      if: ctx._temp?.user_parts != null && ctx._temp.user_parts.size() == 2
  - set:
      field: user.name
      value: "{{_temp.user_parts.1}}"
      ignore_failure: true
      ignore_empty_value: true
      if: ctx._temp?.user_parts != null && ctx._temp.user_parts.size() == 2
  - rename:
      field: winlog.user.name
      target_field: user.name
      ignore_failure: true
      ignore_missing: true
      if: ctx.user?.name == null
      
    ## User data fields.
  - convert:
      field: winlog.user_data.TargetProcessId
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            field: winlog.user_data.TargetProcessId
            ignore_failure: true

    ## File Fields

  - grok:
      field: winlog.user_data.FullFilePath
      ignore_missing: true
      patterns:
      - '(?<file.name>([^\\]*$))'
      if: ctx.winlog?.user_data?.FullFilePath != "-"

  - set:
      field: file.hash.sha256
      copy_from: winlog.user_data.FileHash
      ignore_empty_value: true
      if: ctx.winlog?.user_data?.FileHash != "-"
      
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: "{{ _ingest.on_failure_message }}"
