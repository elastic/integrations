---
description: Pipeline for processing BeyondInsight and Password Safe asset logs.
processors:
  - terminate:
      tag: data_collection_error
      if: ctx.error?.message != null && ctx.message == null && ctx.event?.original == null
      description: error message set and no data to process.
  - fingerprint:
      fields:
        - event.original
      target_field: _id
  - json:
      field: event.original
      tag: json_event_original
      target_field: beyondinsight_password_safe.asset
  - convert:
      field: beyondinsight_password_safe.asset.AssetID
      type: string
      if: ctx.beyondinsight_password_safe?.asset?.AssetID != null
  - rename:
      field: beyondinsight_password_safe.asset.AssetID
      target_field: beyondinsight_password_safe.asset.asset_id
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.AssetName
      target_field: beyondinsight_password_safe.asset.asset_name
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.AssetType
      target_field: beyondinsight_password_safe.asset.asset_type
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.CreateDate
      target_field: beyondinsight_password_safe.asset.create_date
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.DnsName
      target_field: beyondinsight_password_safe.asset.dns_name
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.DomainName
      target_field: beyondinsight_password_safe.asset.domain_name
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.IPAddress
      target_field: beyondinsight_password_safe.asset.ip_address
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.LastUpdateDate
      target_field: beyondinsight_password_safe.asset.last_update_date
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.MacAddress
      target_field: beyondinsight_password_safe.asset.mac_address
      ignore_missing: true
  - rename:
      field: beyondinsight_password_safe.asset.OperatingSystem
      target_field: beyondinsight_password_safe.asset.operating_system
      ignore_missing: true
  - convert:
      field: beyondinsight_password_safe.asset.WorkgroupID
      type: string
      if: ctx.beyondinsight_password_safe?.asset?.WorkgroupID != null
  - rename:
      field: beyondinsight_password_safe.asset.WorkgroupID
      target_field: beyondinsight_password_safe.asset.workgroup_id
      ignore_missing: true

####################
# ECS Fields #
####################
  - set:
      field: ecs.version
      value: '8.11.0'

  - set:
      field: event.kind
      value: asset

  - append:
      field: event.category
      value: host

  - append:
      field: event.type
      value: info

  - set:
      field: host.name
      copy_from: beyondinsight_password_safe.asset.asset_name

  - append:
      field: related.hosts
      value: '{{{beyondinsight_password_safe.asset.asset_name}}}'
      allow_duplicates: false
      if: ctx.beyondinsight_password_safe.asset.asset_name != null

  - gsub:
      field: beyondinsight_password_safe.asset.mac_address
      ignore_missing: true
      pattern: '[:.]'
      replacement: '-'
      tag: gsub_mac_address
  - uppercase:
      field: beyondinsight_password_safe.asset.mac_address
      ignore_missing: true
  - append:
      if: ctx.beyondinsight_password_safe.asset?.mac_address != null && ctx.beyondinsight_password_safe.asset.mac_address != ''
      field: host.mac
      value: '{{{beyondinsight_password_safe.asset.mac_address}}}'

  - append:
      if: ctx.beyondinsight_password_safe.asset?.mac_address != null && ctx.beyondinsight_password_safe.asset.mac_address != ''
      field: related.hosts
      value: '{{{beyondinsight_password_safe.asset.mac_address}}}'
      allow_duplicates: false

  - set:
      field: os.name
      value: "{{{beyondinsight_password_safe.asset.operating_system}}}"
      ignore_empty_value: true

  - set:
      field: host.domain
      copy_from: beyondinsight_password_safe.asset.domain_name
      if: ctx.beyondinsight_password_safe.asset.domain_name != null

  - set:
     field: "@timestamp"
     copy_from: beyondinsight_password_safe.asset.last_update_date
     ignore_empty_value: true

  - append:
      field: related.hosts
      value: '{{{beyondinsight_password_safe.asset.domain_name}}}'
      allow_duplicates: false
      if: ctx.beyondinsight_password_safe.asset.domain_name != null

 #################### Override host.ip ######################
  - gsub:
      description: Remove leading zeros from IP address octets.
      field: beyondinsight_password_safe.asset.ip_address
      pattern: "\\b0+(\\d)"
      replacement: "$1"
      if: ctx.beyondinsight_password_safe?.asset?.ip_address != null
  - convert:
      field: beyondinsight_password_safe.asset.ip_address
      type: ip
      if: ctx.beyondinsight_password_safe?.asset?.ip_address != null
      on_failure:
        - remove:
            field: beyondinsight_password_safe.asset.ip_address
  - append:
      if: ctx.beyondinsight_password_safe?.asset.ip_address != null
      field: host.ip
      value: "{{{beyondinsight_password_safe.asset.ip_address}}}"
      allow_duplicates: false
  - append:
      if: ctx.beyondinsight_password_safe?.asset.ip_address != null
      field: related.hosts
      value: '{{{beyondinsight_password_safe.asset.ip_address}}}'
      allow_duplicates: false

  - geoip:
      field: host.ip
      target_field: host.geo
      ignore_missing: true
      ignore_failure: true

on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{#_ingest.on_failure_processor_tag}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{/_ingest.on_failure_processor_tag}}failed with message '{{{ _ingest.on_failure_message }}}'
