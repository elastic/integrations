---
description: Pipeline for processing Cisco Aironet Logs
processors:
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      ignore_failure: true
  - set:
      field: ecs.version
      value: '8.3.1'
  - grok:
      field: event.original
      patterns:
        - "%{SYSLOG_HEADER}:\\s%%{GREEDYDATA:_temp_.full_message}"
      pattern_definitions:
        SYSLOG_HEADER: "%{SYSLOGFACILITY}%{DATA:host.name}:\\s\\*%{DATA:process.name}:\\s%{AIRONET_DATE:_temp_.raw_date}"
        SYSLOGFACILITY: "<%{NONNEGINT:log.syslog.priority:int}>"
        AIRONET_DATE: "%{MONTH} %{MONTHDAY} %{TIME}"
  - script:
      lang: painless
      source: |
        if (ctx.log?.syslog?.priority != null) {
          def severity = new HashMap();
          severity['code'] = ctx.log.syslog.priority&0x7;
          ctx.log.syslog['severity'] = severity;
          def facility = new HashMap();
          facility['code'] = ctx.log.syslog.priority>>3;
          ctx.log.syslog['facility'] = facility;
        }
  - grok:
      field: _temp_.full_message
      patterns:
        - "%{DATA:event.provider}-%{INT:event.severity}-%{DATA:event.reason}: %{GREEDYDATA:message}"
  #- grok:
  #    field: _temp_.full_message
  #    patterns:
  #      - "%{DATA:event.action}:%{GREEDYDATA:_temp_.full_message}"
  #
  # Set log.level
  #
  - set:
      field: "log.level"
      value: unknown
  - set:
      field: "log.level"
      if: "ctx.log.syslog.severity.code == 1"
      value: alert
  - set:
      field: "log.level"
      if: "ctx.log.syslog.severity.code == 2"
      value: critical
  - set:
      field: "log.level"
      if: "ctx.log.syslog.severity.code == 3"
      value: error
  - set:
      field: "log.level"
      if: "ctx.log.syslog.severity.code == 4"
      value: warning
  - set:
      field: "log.level"
      if: "ctx.log.syslog.severity.code == 5"
      value: notification
  - set:
      field: "log.level"
      if: "ctx.log.syslog.severity.code == 6"
      value: informational
  - set:
      field: "log.level"
      if: "ctx.log.syslog.severity.code == 7"
      value: debug
  #
  # Parse the date included in logs
  #
  - date:
      if: "ctx.event?.timezone == null && ctx._temp_?.raw_date != null"
      field: "_temp_.raw_date"
      target_field: "@timestamp"
      formats:
        - "MMM d HH:mm:ss.SSS"
  - remove:
      field: _temp_
      ignore_failure: true
      ignore_missing: true

on_failure:
  - set:
      field: error.message
      value: '{{ _ingest.on_failure_message }}'