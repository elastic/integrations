---
description: Pipeline for Fortinet FortiManager.
processors:
  - set:
      field: ecs.version
      value: 8.11.0
  - set:
      field: event.kind
      value: event
  - set:
      field: event.type
      value: [info]
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - grok:
      field: event.original
      ecs_compatibility: v1
      patterns:
        - "^(?:<%{NUMBER:fortimanager.log.priority_number:long}>)?%{GREEDYDATA:syslog5424_sd}$"
  - gsub:
      field: syslog5424_sd
      pattern: "[\u0000-\u001F\u007F]"
      replacement: ""
  - script:
      lang: painless
      if: ctx.syslog5424_sd != null
      description: |
        Splits syslog5424_sd KV list by space and then each by "=" taking into account quoted values.
      source: |
        def splitUnquoted(String input, String sep) {
          def tokens = [];
          def startPosition = 0;
          def isInQuotes = false;
          char quote = (char)"\"";
          for (def currentPosition = 0; currentPosition < input.length(); currentPosition++) {
              if (input.charAt(currentPosition) == quote) {
                  isInQuotes = !isInQuotes;
              }
              else if (input.charAt(currentPosition) == (char)sep && !isInQuotes) {
                  def token = input.substring(startPosition, currentPosition).trim();
                  if (!token.equals("")) {
                    tokens.add(token);
                  }
                  startPosition = currentPosition + 1;
              }
          }
        
          def lastToken = input.substring(startPosition);
          if (!lastToken.equals(sep) && !lastToken.equals("")) {
              tokens.add(lastToken.trim());
          }
          return tokens;
        }
        
        def arr = splitUnquoted(ctx.syslog5424_sd, " ");
        
        Map map = new HashMap();
        Pattern pattern = /^\"|\"$/;
        for (def i = 0; i < arr?.length; i++) {
          def kv = splitUnquoted(arr[i], "=");
          if (kv.length == 2) {
            map[kv[0]] = pattern.matcher(kv[1]).replaceAll("");
          }
        }
        if (ctx.fortinet == null) {
          ctx.fortinet = new HashMap();
        }
        ctx._temp = map;
  - script:
      lang: painless
      source: |
        def fw = ctx._temp;
        if (fw != null) {
            // We will remove any keys that are non-words to avoid polluting documents
            def pat = /\W+/; 
            fw.entrySet().removeIf(entry -> entry.getValue() == "N/A" || pat.matcher(entry.getKey()).find());
        }
  - rename:
      field: _temp.changes
      target_field: fortimanager.log.changes
      ignore_missing: true
  - rename:
      field: _temp.pri
      target_field: fortimanager.log.pri
      ignore_missing: true
  - rename:
      field: _temp.intfname
      target_field: fortimanager.log.intfname
      ignore_missing: true
  - rename:
      field: _temp.importance
      target_field: fortimanager.log.importance
      ignore_missing: true
  - rename:
      field: _temp.function
      target_field: fortimanager.log.function
      ignore_missing: true
  - rename:
      field: _temp.detail
      target_field: fortimanager.log.detail
      ignore_missing: true
  - rename:
      field: _temp.desc
      target_field: fortimanager.log.desc
      ignore_missing: true
  - rename:
      field: _temp.dbver
      target_field: fortimanager.log.db.ver
      ignore_missing: true
  - rename:
      field: _temp.app
      target_field: fortimanager.log.app
      ignore_missing: true
  - rename:
      field: _temp.bid
      target_field: fortimanager.log.bid
      ignore_missing: true
  - rename:
      field: _temp.profname
      target_field: fortimanager.log.prof_name
      ignore_missing: true
  - rename:
      field: _temp.epid
      target_field: fortimanager.log.epid
      ignore_missing: true
  - rename:
      field: _temp.dstepid
      target_field: fortimanager.log.dste.pid
      ignore_missing: true
  - rename:
      field: _temp.dsteuid
      target_field: fortimanager.log.dste.uid
      ignore_missing: true
  - rename:
      field: _temp.id
      target_field: fortimanager.log.event.id
      ignore_missing: true
  - rename:
      field: _temp.event_type
      target_field: fortimanager.log.event.type
      ignore_missing: true
  - set:
      field: event.id
      copy_from: fortimanager.log.event.id
      ignore_empty_value: true
  - rename:
      field: _temp.userid
      target_field: fortimanager.log.user.id
      ignore_missing: true
  - rename:
      field: _temp.user
      target_field: fortimanager.log.user.name
      ignore_missing: true
  - rename:
      field: _temp.user_type
      target_field: fortimanager.log.user.type
      ignore_missing: true
  - rename:
      field: _temp.userfrom
      target_field: fortimanager.log.user.from
      ignore_missing: true
  - set:
      field: user.name
      copy_from: fortimanager.log.user.name
      ignore_empty_value: true
  - set:
      field: user.id
      copy_from: fortimanager.log.user.id
      ignore_empty_value: true
  - rename:
      field: _temp.dmstate
      target_field: fortimanager.log.dm_state
      ignore_missing: true
  - rename:
      field: _temp.dvid
      target_field: fortimanager.log.dvid
      ignore_missing: true
  - rename:
      field: _temp.dvmdb_obj
      target_field: fortimanager.log.dvmdb_obj
      ignore_missing: true
  - rename:
      field: _temp.fips_err
      target_field: fortimanager.log.fips.err
      ignore_missing: true
  - rename:
      field: _temp.fips_method
      target_field: fortimanager.log.fips.method
      ignore_missing: true
  - convert:
      field: _temp.module
      tag: 'convert_module_to_long'
      target_field: fortimanager.log.module
      type: long
      ignore_missing: true
      if: ctx._temp?.module != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.metafield
      target_field: fortimanager.log.meta_field.name
      ignore_missing: true
  - rename:
      field: _temp.metafield_stat
      target_field: fortimanager.log.meta_field.stat
      ignore_missing: true
  - convert:
      field: _temp.metafield_leng
      tag: 'convert_metafield_leng_to_long'
      target_field: fortimanager.log.meta_field.leng
      type: long
      ignore_missing: true
      if: ctx._temp?.metafield_leng != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.pkg
      target_field: fortimanager.log.pkg.name
      ignore_missing: true
  - rename:
      field: _temp.pkgadom
      target_field: fortimanager.log.pkg.adom
      ignore_missing: true
  - rename:
      field: _temp.pkgname
      target_field: fortimanager.log.pkg.name
      ignore_missing: true
  - convert:
      field: _temp.pkg_oid
      tag: 'convert_pkg_oid_to_string'
      target_field: fortimanager.log.pkg.oid
      type: string
      ignore_missing: true
      if: ctx._temp?.pkg_oid != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.ppkgname
      target_field: fortimanager.log.pkg.gname
      ignore_missing: true
  - rename:
      field: _temp.vd
      target_field: fortimanager.log.vdom
      ignore_missing: true
  - rename:
      field: _temp.adminprof
      target_field: fortimanager.log.admin_prof
      ignore_missing: true
  - rename:
      field: _temp.oper_stat
      target_field: fortimanager.log.operstat
      ignore_missing: true
  - rename:
      field: _temp.uploading_oper
      target_field: fortimanager.log.uploading.oper
      ignore_missing: true
  - rename:
      field: _temp.uploading_server_type
      target_field: fortimanager.log.uploading.server_type
      ignore_missing: true
  - convert:
      field: _temp.uploading_pid
      tag: 'convert_uploading_pid_to_string'
      target_field: fortimanager.log.uploading.pid
      type: string
      ignore_missing: true
      if: ctx._temp?.uploading_pid != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.uploading_cur_number
      tag: 'convert_uploading_cur_number_to_long'
      target_field: fortimanager.log.uploading.cur_number
      type: long
      ignore_missing: true
      if: ctx._temp?.uploading_cur_number != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.uploading_max_allowed
      tag: 'convert_uploading_max_allowed_to_long'
      target_field: fortimanager.log.uploading.max_allowed
      type: long
      ignore_missing: true
      if: ctx._temp?.uploading_max_allowed != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.adom
      target_field: fortimanager.log.adom.name
      ignore_missing: true
  - set:
      field: user.domain
      copy_from: fortimanager.log.adom.name
      ignore_empty_value: true
  - convert:
      field: _temp.adom_oid
      tag: 'convert_adom_oid_to_string'
      target_field: fortimanager.log.adom.oid
      type: string
      ignore_missing: true
      if: ctx._temp?.adom_oid != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.adomlock
      target_field: fortimanager.log.adom.lock
      ignore_missing: true
  - rename:
      field: _temp.dbstatus
      target_field: fortimanager.log.db.status
      ignore_missing: true
  - rename:
      field: _temp.disk_stat_before
      target_field: fortimanager.log.disk.status.before
      ignore_missing: true
  - rename:
      field: _temp.disk_stat_current
      target_field: fortimanager.log.disk.status.current
      ignore_missing: true
  - convert:
      field: _temp.disk_label
      tag: 'convert_disk_label_to_long'
      target_field: fortimanager.log.disk.label
      type: long
      ignore_missing: true
      if: ctx._temp?.disk_label != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.log_id
      target_field: fortimanager.log.id
      ignore_missing: true
  - rename:
      field: _temp.peer
      target_field: fortimanager.log.peer
      ignore_missing: true
  - rename:
      field: _temp.performed_on
      target_field: fortimanager.log.performed_on
      ignore_missing: true
  - rename:
      field: _temp.log_path
      target_field: fortimanager.log.path
      ignore_missing: true
  - rename:
      field: _temp.logdev_id
      target_field: fortimanager.log.device_log.id
      ignore_missing: true
  - rename:
      field: _temp.logdev_last_logging
      target_field: fortimanager.log.device_log.last_logging
      ignore_missing: true
  - rename:
      field: _temp.logdev_name
      target_field: fortimanager.log.device_log.name
      ignore_missing: true
  - rename:
      field: _temp.logdev_offline_duration
      target_field: fortimanager.log.device_log.offline_duration
      ignore_missing: true
  - rename:
      field: _temp.package
      target_field: fortimanager.log.package.name
      ignore_missing: true
  - rename:
      field: _temp.package_desc
      target_field: fortimanager.log.package.desc
      ignore_missing: true
  - rename:
      field: _temp.package_type
      target_field: fortimanager.log.package.type
      ignore_missing: true
  - rename:
      field: _temp.logid
      target_field: fortimanager.log.id
      ignore_missing: true
  - rename:
      field: _temp.pty_err
      target_field: fortimanager.log.pty.err
      ignore_missing: true
  - rename:
      field: _temp.pty_oper
      target_field: fortimanager.log.pty.oper
      ignore_missing: true
  - rename:
      field: _temp.pty_sess
      target_field: fortimanager.log.pty.sess
      ignore_missing: true
  - rename:
      field: _temp.pty_step
      target_field: fortimanager.log.pty.step
      ignore_missing: true
  - rename:
      field: _temp.raid_stat_before
      target_field: fortimanager.log.raid_state.before
      ignore_missing: true
  - rename:
      field: _temp.raid_stat_current
      target_field: fortimanager.log.raid_state.current
      ignore_missing: true
  - rename:
      field: _temp.remote_filename
      target_field: fortimanager.log.remote.filename
      ignore_missing: true
  - rename:
      field: _temp.remote_host
      target_field: fortimanager.log.remote.host
      ignore_missing: true
  - rename:
      field: _temp.remote_path
      target_field: fortimanager.log.remote.path
      ignore_missing: true
  - convert:
      field: _temp.remote_ip
      tag: 'convert_remote_ip_to_ip'
      target_field: fortimanager.log.remote.ip
      type: ip
      ignore_missing: true
      if: ctx._temp?.remote_ip != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      value: '{{{fortimanager.log.remote.ip}}}'
      if: ctx._temp?.remote?.ip != null
      allow_duplicates: false
  - set:
      field: source.ip
      copy_from: fortimanager.log.remote.ip
      ignore_empty_value: true
  - convert:
      field: _temp.remote_port
      tag: 'convert_remote_port_to_long'
      target_field: fortimanager.log.remote.port
      type: long
      ignore_missing: true
      if: ctx._temp?.remote_port != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: source.port
      copy_from: fortimanager.log.remote.port
      ignore_empty_value: true
  - rename:
      field: _temp.sensor_name
      target_field: fortimanager.log.sensor.name
      ignore_missing: true
  - rename:
      field: _temp.sensor_st
      target_field: fortimanager.log.sensor.st
      ignore_missing: true
  - rename:
      field: _temp.sensor_val
      target_field: fortimanager.log.sensor.val
      ignore_missing: true
  - rename:
      field: _temp.upgrade_adom
      target_field: fortimanager.log.upgrade.adom
      ignore_missing: true
  - rename:
      field: _temp.upgrade_from
      target_field: fortimanager.log.upgrade.from
      ignore_missing: true
  - rename:
      field: _temp.upgrade_to
      target_field: fortimanager.log.upgrade.to
      ignore_missing: true
  - rename:
      field: _temp.runfrom
      target_field: fortimanager.log.run_from
      ignore_missing: true
  - rename:
      field: _temp.devname
      target_field: fortimanager.log.dev.name
      ignore_missing: true
  - set:
      field: host.hostname
      copy_from: fortimanager.log.dev.name
      ignore_empty_value: true
  - rename:
      field: _temp.devid
      target_field: fortimanager.log.dev.id
      ignore_missing: true
  - convert:
      field: _temp.dev_oid
      tag: 'convert_dev_oid_to_string'
      target_field: fortimanager.log.dev.oid
      type: string
      ignore_missing: true
      if: ctx._temp?.dev_oid != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.devlog
      target_field: fortimanager.log.dev.log
      ignore_missing: true
  - rename:
      field: _temp.devgrps
      target_field: fortimanager.log.dev.grps
      ignore_missing: true
  - convert:
      field: _temp.session_id
      tag: 'convert_session_id_to_string'
      target_field: fortimanager.log.session_id
      type: string
      ignore_missing: true
      if: ctx._temp?.session_id != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.revision
      tag: 'convert_revision_to_long'
      target_field: fortimanager.log.revision
      type: long
      ignore_missing: true
      if: ctx._temp?.revision != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.setup
      tag: 'convert_setup_to_long'
      target_field: fortimanager.log.setup
      type: long
      ignore_missing: true
      if: ctx._temp?.setup != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.valid
      tag: 'convert_valid_to_long'
      target_field: fortimanager.log.valid
      type: long
      ignore_missing: true
      if: ctx._temp?.valid != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.rate
      tag: 'convert_rate_to_long'
      target_field: fortimanager.log.rate
      type: long
      ignore_missing: true
      if: ctx._temp?.rate != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.logratelimit
      tag: 'convert_logratelimit_to_long'
      target_field: fortimanager.log.rate_limit
      type: long
      ignore_missing: true
      if: ctx._temp?.logratelimit != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.logratepeak
      tag: 'convert_logratepeak_to_long'
      target_field: fortimanager.log.rate_peak
      type: long
      ignore_missing: true
      if: ctx._temp?.logratepeak != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.memusage
      tag: 'convert_memusage_to_long'
      target_field: fortimanager.log.mem_usage
      type: long
      ignore_missing: true
      if: ctx._temp?.memusage != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.device
      target_field: fortimanager.log.device.name
      ignore_missing: true
  - set:
      field: observer.name
      copy_from: fortimanager.log.device.name
      ignore_empty_value: true
  - rename:
      field: _temp.device_id
      target_field: fortimanager.log.device.id
      ignore_missing: true
  - set:
      field: device.id
      copy_from: fortimanager.log.device.id
      ignore_empty_value: true
  - rename:
      field: _temp.action
      target_field: fortimanager.log.action
      ignore_missing: true
  - set:
      field: event.action
      copy_from: fortimanager.log.action
      ignore_empty_value: true
  - set:
      field: event.timezone
      copy_from: _temp.tz
      ignore_empty_value: true
  - append:
      field: related.hosts
      value: '{{{host.hostname}}}'
      if: ctx.host?.hostname != null
      allow_duplicates: false
  - rename:
      field: _temp.msg
      target_field: fortimanager.log.msg
      ignore_missing: true
  - set:
      field: message
      copy_from: fortimanager.log.msg
      ignore_empty_value: true
  - convert:
      field: _temp.pid
      tag: 'convert_pid_to_long'
      target_field: fortimanager.log.pid
      type: long
      ignore_missing: true
      if: ctx._temp?.pid != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: process.pid
      copy_from: fortimanager.log.pid
      ignore_empty_value: true
  - script:
      lang: painless
      description: Combines date, time, and timezone fields together.
      source: >-
        if (ctx._temp?.time != null && ctx._temp?.date != null && ctx._temp?.tz != null) {
          ctx._temp.date = ctx._temp.date + 'T' + ctx._temp.time + ctx._temp.tz;
        }
  - date:
      field: _temp.date
      tag: 'date_set_timestamp'
      formats:
        - ISO8601
      if: ctx._temp?.date != null && ctx._temp.date != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: _temp.date
      tag: 'date_rename_to_custom_date'
      target_field: fortimanager.log.date
      formats:
        - ISO8601
      if: ctx._temp?.date != null && ctx._temp.date != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.extrainfo
      target_field: fortimanager.log.extra_info
      ignore_missing: true
  - rename:
      field: _temp.newname
      target_field: fortimanager.log.new.name
      ignore_missing: true
  - rename:
      field: _temp.new_version
      target_field: fortimanager.log.new.version
      ignore_missing: true
  - rename:
      field: _temp.new_value
      target_field: fortimanager.log.new.value
      ignore_missing: true
  - rename:
      field: _temp.instpkg
      target_field: fortimanager.log.inst.pkg
      ignore_missing: true
  - rename:
      field: _temp.inst_dev
      target_field: fortimanager.log.inst.dev
      ignore_missing: true
  - rename:
      field: _temp.inst_adom
      target_field: fortimanager.log.inst.adom
      ignore_missing: true
  - rename:
      field: _temp.certname
      target_field: fortimanager.log.cert.name
      ignore_missing: true
  - rename:
      field: _temp.certtype
      target_field: fortimanager.log.cert.type
      ignore_missing: true
  - rename:
      field: _temp.attrname
      target_field: fortimanager.log.attribute_name
      ignore_missing: true
  - rename:
      field: _temp.authmsg
      target_field: fortimanager.log.auth_msg
      ignore_missing: true
  - rename:
      field: _temp.object
      target_field: fortimanager.log.object
      ignore_missing: true
  - rename:
      field: _temp.offline_stat
      target_field: fortimanager.log.offline_stat
      ignore_missing: true
  - rename:
      field: _temp.old_value
      target_field: fortimanager.log.old_value
      ignore_missing: true
  - rename:
      field: _temp.pre_version
      target_field: fortimanager.log.pre_version
      ignore_missing: true
  - rename:
      field: _temp.operation
      target_field: fortimanager.log.operation
      ignore_missing: true
  - rename:
      field: _temp.objattr
      target_field: fortimanager.log.obj.attr
      ignore_missing: true
  - rename:
      field: _temp.objname
      target_field: fortimanager.log.obj.name
      ignore_missing: true
  - rename:
      field: _temp.objtype
      target_field: fortimanager.log.obj.type
      ignore_missing: true
  - rename:
      field: _temp.path
      target_field: fortimanager.log.obj.path
      ignore_missing: true
  - rename:
      field: _temp.level
      target_field: fortimanager.log.level
      ignore_missing: true
  - set:
      field: log.level
      copy_from: fortimanager.log.level
      ignore_empty_value: true
  - rename:
      field: _temp.file
      target_field: fortimanager.log.file
      ignore_missing: true
  - set:
      field: file.name
      copy_from: fortimanager.log.file
      ignore_empty_value: true
  - rename:
      field: _temp.confstatus
      target_field: fortimanager.log.conf_status
      ignore_missing: true
  - rename:
      field: _temp.constmsg
      target_field: fortimanager.log.const_msg
      ignore_missing: true
  - rename:
      field: _temp.euid
      target_field: fortimanager.log.euid
      ignore_missing: true
  - rename:
      field: _temp.error
      target_field: fortimanager.log.error
      ignore_missing: true
  - convert:
      field: _temp.errcode
      tag: 'convert_errcode_to_string'
      target_field: fortimanager.log.err_code
      type: string
      ignore_missing: true
      if: ctx._temp?.errcode != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: error.code
      copy_from: fortimanager.log.err_code
      ignore_empty_value: true
  - rename:
      field: _temp.connect_status
      target_field: fortimanager.log.connect_status
      ignore_missing: true
  - rename:
      field: _temp.condition
      target_field: fortimanager.log.condition
      ignore_missing: true
  - rename:
      field: _temp.comment
      target_field: fortimanager.log.comment
      ignore_missing: true
  - rename:
      field: _temp.cmd_from
      target_field: fortimanager.log.cmd_from
      ignore_missing: true
  - rename:
      field: _temp.cli_act
      target_field: fortimanager.log.cli_act
      ignore_missing: true
  - rename:
      field: _temp.cause
      target_field: fortimanager.log.cause
      ignore_missing: true
  - rename:
      field: _temp.category
      target_field: fortimanager.log.category
      ignore_missing: true
  - rename:
      field: _temp.zip_path
      target_field: fortimanager.log.zip_path
      ignore_missing: true
  - rename:
       field: _temp.whitelist_size
       target_field: fortimanager.log.whitelist_size
       ignore_missing: true
  - rename:
       field: _temp.zip_path
       target_field: fortimanager.log.zip_path
       ignore_missing: true
  - rename:
       field: _temp.version
       target_field: fortimanager.log.version
       ignore_missing: true
  - rename:
       field: _temp.version
       target_field: fortimanager.log.version
       ignore_missing: true
  - rename:
       field: _temp.vdoms
       target_field: fortimanager.log.vdoms
       ignore_missing: true
  - rename:
       field: _temp.vdom
       target_field: fortimanager.log.vdom
       ignore_missing: true
  - rename:
       field: _temp.ustr
       target_field: fortimanager.log.ustr
       ignore_missing: true
  - rename:
       field: _temp.type
       target_field: fortimanager.log.type
       ignore_missing: true
  - rename:
       field: _temp.type
       target_field: fortimanager.log.type
       ignore_missing: true
  - rename:
       field: _temp.url
       target_field: fortimanager.log.url
       ignore_missing: true
  - rename:
       field: _temp.upg_act
       target_field: fortimanager.log.upg_act
       ignore_missing: true
  - rename:
       field: _temp.uid
       target_field: fortimanager.log.uid
       ignore_missing: true
  - rename:
       field: _temp.upddb_ver
       target_field: fortimanager.log.upddb_ver
       ignore_missing: true
  - rename:
       field: _temp.to_version
       target_field: fortimanager.log.to_version
       ignore_missing: true
  - rename:
       field: _temp.to_release
       target_field: fortimanager.log.to_release
       ignore_missing: true
  - rename:
       field: _temp.title
       target_field: fortimanager.log.title
       ignore_missing: true
  - rename:
       field: _temp.title
       target_field: fortimanager.log.title
       ignore_missing: true
  - rename:
       field: _temp.sw_version
       target_field: fortimanager.log.sw_version
       ignore_missing: true
  - rename:
       field: _temp.subtype
       target_field: fortimanager.log.subtype
       ignore_missing: true
  - rename:
       field: _temp.status
       target_field: fortimanager.log.status
       ignore_missing: true
  - rename:
       field: _temp.state
       target_field: fortimanager.log.state
       ignore_missing: true
  - rename:
       field: _temp.shutdown_reason
       target_field: fortimanager.log.shutdown_reason
       ignore_missing: true
  - rename:
       field: _temp.state
       target_field: fortimanager.log.state
       ignore_missing: true
  - rename:
       field: _temp.service
       target_field: fortimanager.log.service
       ignore_missing: true
  - rename:
       field: _temp.serial
       target_field: fortimanager.log.serial
       ignore_missing: true
  - rename:
       field: _temp.script
       target_field: fortimanager.log.script
       ignore_missing: true
  - rename:
       field: _temp.rundb_ver
       target_field: fortimanager.log.rundb_ver
       ignore_missing: true
  - rename:
       field: _temp.result
       target_field: fortimanager.log.result
       ignore_missing: true
  - rename:
      field: _temp.reboot_reason
      target_field: fortimanager.log.reboot_reason
      ignore_missing: true
  - rename:
      field: _temp.protocol
      target_field: fortimanager.log.protocol
      ignore_missing: true
  - set:
      field: network.transport
      copy_from: fortimanager.log.protocol
      ignore_empty_value: true
  - lowercase:
      field: network.transport
      ignore_missing: true
  - convert:
      field: _temp.address
      tag: 'convert_address_to_ip'
      target_field: fortimanager.log.address
      type: ip
      ignore_missing: true
      if: ctx._temp?.address != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      value: '{{{fortimanager.log.address}}}'
      if: ctx._temp?.address != null
      allow_duplicates: false
  - append:
      field: related.user
      value: '{{{user.id}}}'
      if: ctx.user?.id != null
      allow_duplicates: false
  - append:
      field: related.user
      value: '{{{user.name}}}'
      if: ctx.user?.name != null
      allow_duplicates: false
  - append:
      field: related.user
      value: '{{{user.domain}}}'
      if: ctx.user?.domain != null
      allow_duplicates: false
  - set:
      field: observer.serial_number
      copy_from: fortimanager.log.serial
      ignore_empty_value: true
  - date:
      field: _temp.end_time
      tag: 'date_end_time'
      target_field: fortimanager.log.end_time
      formats:
        - ISO8601
        - epoch_millis
      if: ctx._temp?.end_time != null && ctx._temp.end_time != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.end
      copy_from: fortimanager.log.end_time
      ignore_empty_value: true
  - date:
      field: _temp.start_time
      tag: 'date_start_time'
      target_field: fortimanager.log.start_time
      formats:
        - ISO8601
      if: ctx._temp?.start_time != null && ctx._temp.start_time != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.start
      copy_from: fortimanager.log.start_time
      ignore_empty_value: true
  - date:
      field: _temp.itime
      tag: 'date_itime'
      target_field: fortimanager.log.itime
      formats:
        - ISO8601
        - epoch_millis
      if: ctx._temp?.itime != null && ctx._temp.itime != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.use_mb
      tag: 'convert_use_mb_long'
      target_field: fortimanager.log.use_mb
      type: long
      ignore_missing: true
      if: ctx._temp?.use_mb != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: _temp.expiration
      tag: 'date_expiration'
      target_field: fortimanager.log.expiration
      formats:
        - ISO8601
        - epoch_millis
      if: ctx._temp?.expiration != null && ctx._temp.expiration != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: _temp.lickey_type
      target_field: fortimanager.log.lickey_type
      ignore_missing: true
  - rename:
      field: _temp.lnk_path
      target_field: fortimanager.log.lnk_path
      ignore_missing: true
  - rename:
      field: _temp.local_file
      target_field: fortimanager.log.local_file
      ignore_missing: true
  - convert:
      field: _temp.license_type
      tag: 'convert_license_type_to_long'
      target_field: fortimanager.log.license_type
      type: long
      ignore_missing: true
      if: ctx._temp?.license_type != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.quota
      tag: 'convert_quota_to_long'
      target_field: fortimanager.log.quota
      type: long
      ignore_missing: true
      if: ctx._temp?.quota != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.percent
      tag: 'convert_percent_to_long'
      target_field: fortimanager.log.percent
      type: long
      ignore_missing: true
      if: ctx._temp?.percent != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.capacity
      tag: 'convert_capacity_to_long'
      target_field: fortimanager.log.capacity
      type: long
      ignore_missing: true
      if: ctx._temp?.capacity != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.cpuusage
      tag: 'convert_cpuusage_to_long'
      target_field: fortimanager.log.cpu_usage
      type: long
      ignore_missing: true
      if: ctx._temp?.cpuusage != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.lograte
      tag: 'convert_logarte_to_long'
      target_field: fortimanager.log.rate_value
      type: long
      ignore_missing: true
      if: ctx._temp?.lograte != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.log_size
      tag: 'convert_size_to_long'
      target_field: fortimanager.log.size
      type: long
      ignore_missing: true
      if: ctx._temp?.log_size != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.max_mb
      tag: 'convert_max_mb_to_long'
      target_field: fortimanager.log.max_mb
      type: long
      ignore_missing: true
      if: ctx._temp?.max_mb != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.msgrate
      tag: 'convert_msgrate_to_long'
      target_field: fortimanager.log.msg_rate
      type: long
      ignore_missing: true
      if: ctx._temp?.msgrate != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.rolling_cur_number
      tag: 'convert_rolling_cur_number_to_long'
      target_field: fortimanager.log.rolling.cur_number
      type: long
      ignore_missing: true
      if: ctx._temp?.rolling_cur_number != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.rolling_max_allowed
      tag: 'convert_rolling_max_allowed_to_long'
      target_field: fortimanager.log.rolling.max_allowed
      type: long
      ignore_missing: true
      if: ctx._temp?.rolling_max_allowed != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: _temp.to_build
      tag: 'convert_to_build_to_long'
      target_field: fortimanager.log.to_build
      type: long
      ignore_missing: true
      if: ctx._temp?.to_build != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - script:
      if: "ctx.fortimanager?.log?.subtype != null"
      lang: painless
      description: Adding data to the product field on the basis of event subtype.
      source: >-
        def fortimanager_product = ["system", "fgfm", "devcfg", "glbcfg", "scrmgr", "webport", "scfw", "scply", "scvpn", "epmgr", "rev", "dm", "rtmon", "lrmgr", "HA", "fmwmgr", "fgd", "fctmgr", "fmlmgr", "iolog", "objcfg", "devmgr", "dvm", "fmgws", "logd", "fips", "devops", "docker"];
        def fortianalyzer_product = ["faz", "fazsys", "logdev", "logging", "logfile", "report", "eventmgmt", "logdb", "hcache", "diskquota", "fortiview", "ediscovery", "fazha", "aid"];
        if (fortimanager_product.contains(ctx.fortimanager.log.subtype)) {
          ctx.fortimanager.log.product = "fortimanager";
        }
        if (fortianalyzer_product.contains(ctx.fortimanager.log.subtype)) {
          ctx.fortimanager.log.product = "fortianalyzer";
        }
  - remove:
      field:
        - temp
        - _temp
        - syslog5424_sd
      ignore_missing: true
  - remove:
      field: event.original
      if: ctx.tags == null || !(ctx.tags.contains('preserve_original_event'))
      ignore_missing: true
  - remove:
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      field:
        - fortimanager.log.action
        - fortimanager.log.adom.name
        - fortimanager.log.date
        - fortimanager.log.dev.name
        - fortimanager.log.device.id
        - fortimanager.log.device.name
        - fortimanager.log.end_time
        - fortimanager.log.err_code
        - fortimanager.log.event.id
        - fortimanager.log.file
        - fortimanager.log.level
        - fortimanager.log.msg
        - fortimanager.log.pid
        - fortimanager.log.protocol
        - fortimanager.log.remote.ip
        - fortimanager.log.remote.port
        - fortimanager.log.serial
        - fortimanager.log.start_time
        - fortimanager.log.user.id
        - fortimanager.log.user.name
      ignore_missing: true
  - script:
      lang: painless
      source: |-
        boolean drop(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(v -> drop(v));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(v -> drop(v));
            return (((List) object).length == 0);
          }
          return false;
        }
        drop(ctx);
      description: Drops null/empty values recursively.
  - set:
      field: event.kind
      value: pipeline_error
      if: ctx.error?.message != null
on_failure:
  - append:
      field: error.message
      value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
