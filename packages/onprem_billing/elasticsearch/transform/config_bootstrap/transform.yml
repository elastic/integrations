description: Bootstrap onprem_billing_config lookup index with organization defaults and discovered deployments using mERU (milli-ERU) as the internal unit.
source:
  index:
    - "monitoring-indices"
    - "*:monitoring-indices"
  runtime_mappings:
    config_type:
      type: keyword
      script:
        source: "emit('deployment')"
    deployment_id:
      type: keyword
      script:
        source: "emit(doc['elasticsearch.cluster.name'].value)"
    deployment_name:
      type: keyword
      script:
        source: "emit(doc['elasticsearch.cluster.name'].value)"
    # Default: 1 ERU = 1000 mERU, so 1 ERU/day = 1000 mERU/day
    daily_meru:
      type: long
      script:
        source: "emit(1000L)"
    # Default deployment_erus (what the user will configure)
    deployment_erus:
      type: double
      script:
        source: "emit(1.0)"
    # Placeholder so dest index mapping includes deployment_tags; user overwrites via _update
    deployment_tags:
      type: keyword
      script:
        source: "emit('')"
dest:
  index: onprem_billing_config
pivot:
  group_by:
    config_type:
      terms:
        field: config_type
    deployment_id:
      terms:
        field: deployment_id
    deployment_name:
      terms:
        field: deployment_name
    deployment_tags:
      terms:
        field: deployment_tags
  aggregations:
    daily_meru:
      max:
        field: daily_meru
    deployment_erus:
      max:
        field: deployment_erus
settings:
  deduce_mappings: false
  unattended: true
_meta:
  managed: true
  run_as_kibana_system: false
  fleet_transform_version: 0.2.0
