---
description: Pipeline for processing Neon events.
processors:
    - set:
          field: ecs.version
          value: 8.17.0
          tag: set_ecs_version
    - terminate:
          if: ctx.error?.message != null && ctx.message == null && ctx.event?.original == null
          description: error message set and no data to process.
          tag: data_collection_error
    - set:
          field: event.kind
          value: event
          tag: set_event_kind
    - append:
          field: event.category
          value: network
          tag: append_event_category
    - append:
          field: event.type
          value: info
          tag: append_event_type
    - rename:
          field: message
          target_field: event.original
          ignore_missing: true
          if: ctx.event?.original == null
          tag: rename_message_original
    - remove:
          field: message
          ignore_missing: true
          if: 'ctx.event?.original != null'
          description: 'The `message` field is no longer required if the document has an `event.original` field.'
          tag: remove_field_message
    - remove:
          field:
              - organization
              - division
              - team
          ignore_missing: true
          if: ctx.organization instanceof String && ctx.division instanceof String && ctx.team instanceof String
          description: >-
              Removes the fields added by Agentless as metadata,
              as they can collide with ECS fields.
          tag: remove_agentless_fields
    - json:
          field: event.original
          target_field: json
          ignore_failure: true
          tag: json_parse_original
    - fingerprint:
          fields:
              - json.inserted_at
              - json.updated_at
              - json.id
          target_field: _id
          tag: fingerprint_id_field
    - date:
          field: json.event_timestamp
          target_field: neon_cyber.events.event_timestamp
          tag: date_event_timestamp
          formats:
              - ISO8601
    - date:
          field: json.event_timestamp
          target_field: '@timestamp'
          tag: date_event_timestamp
          formats:
              - ISO8601
    - rename:
          field: json.id
          target_field: neon_cyber.events.id
          tag: rename_events_id
    - rename:
          field: json.deployment_id
          target_field: neon_cyber.events.deployment_id
          tag: rename_deployment_id
    - rename:
          field: json.client_id
          target_field: neon_cyber.events.client_id
          tag: rename_client_id
    - rename:
          field: json.registration_id
          target_field: neon_cyber.events.registration_id
          tag: rename_registration_id
    - rename:
          field: json.event_type
          target_field: neon_cyber.events.event_type
          tag: rename_event_type
    - rename:
          field: json.arch
          target_field: host.architecture
          ignore_missing: true
          tag: rename_host_architecture
    - rename:
          field: json.os
          target_field: host.os.platform
          ignore_missing: true
          tag: rename_host_os_platform
    - rename:
          field: json.latitude
          target_field: host.geo.location.lat
          ignore_missing: true
          tag: rename_host_geo_lat
    - rename:
          field: json.longitude
          target_field: host.geo.location.lon
          ignore_missing: true
          tag: rename_host_geo_lon
    - rename:
          field: json.ip
          target_field: client.nat.ip
          ignore_missing: true
          tag: rename_client_nat_ip
    - rename:
          field: json.ip_latitude
          target_field: client.geo.location.lat
          ignore_missing: true
          tag: rename_client_geo_lat
    - rename:
          field: json.ip_longitude
          target_field: client.geo.location.lon
          ignore_missing: true
          tag: rename_client_geo_lon
    - rename:
          field: json.city
          target_field: client.geo.city_name
          ignore_missing: true
          tag: rename_client_city_name
    - rename:
          field: json.country
          target_field: client.geo.country_name
          ignore_missing: true
          tag: rename_client_country
    - rename:
          field: json.postal_code
          target_field: client.geo.postal_code
          ignore_missing: true
          tag: rename_client_postal_code
    - rename:
          field: json.region_code
          target_field: client.geo.region_iso_code
          ignore_missing: true
          tag: rename_client_iso_code
    - rename:
          field: json.region_name
          target_field: client.geo.region_name
          ignore_missing: true
          tag: rename_client_region_name
    - rename:
          field: json.asn
          target_field: client.as.number
          ignore_missing: true
          tag: rename_client_as_number
    - rename:
          field: json.asn_isp
          target_field: client.as.organization.name
          ignore_missing: true
          tag: rename_client_as_organization
    - rename:
          field: json.name
          target_field: user_agent.name
          ignore_missing: true
          tag: rename_user_agent_name
    - rename:
          field: json.version
          target_field: user_agent.version
          ignore_missing: true
          tag: rename_user_agent_version
    - rename:
          field: json.ua
          target_field: user_agent.original
          ignore_missing: true
          tag: rename_user_agent_original
    - rename:
          field: json.url
          target_field: neon_cyber.events.url
          ignore_missing: true
          tag: rename_events_url
    - rename:
          field: json.agent
          target_field: neon_cyber.events.agent
          ignore_missing: true
          tag: rename_neon_agent
    - rename:
          field: json.display
          target_field: neon_cyber.events.display
          ignore_missing: true
          tag: rename_events_display
    - rename:
          field: json.tab_id
          target_field: neon_cyber.events.tab_id
          ignore_missing: true
          tag: rename_events_tab_id
    - rename:
          field: json.frame_id
          target_field: neon_cyber.events.frame_id
          ignore_missing: true
          tag: rename_events_frame_id
    - rename:
          field: json.parent_frame_id
          target_field: neon_cyber.events.parent_frame_id
          ignore_missing: true
          tag: rename_events_parent_frame_id
    - rename:
          field: json.download_id
          target_field: neon_cyber.events.download_id
          ignore_missing: true
          tag: rename_events_download_id
    - rename:
          field: json.filename
          target_field: neon_cyber.events.filename
          ignore_missing: true
          tag: rename_events_filename
    - rename:
          field: json.mime
          target_field: neon_cyber.events.mime
          ignore_missing: true
          tag: rename_events_mime
    - rename:
          field: json.incognito
          target_field: neon_cyber.events.incognito
          ignore_missing: true
          tag: rename_events_incognito
    - rename:
          field: json.referrer
          target_field: neon_cyber.events.referrer
          ignore_missing: true
          tag: rename_events_referrer
    - rename:
          field: json.danger
          target_field: neon_cyber.events.danger
          ignore_missing: true
          tag: rename_events_danger
    - rename:
          field: json.total_bytes
          target_field: neon_cyber.events.total_bytes
          ignore_missing: true
          tag: rename_events_total_bytes
    - rename:
          field: json.description
          target_field: neon_cyber.events.description
          ignore_missing: true
          tag: rename_events_description
    - rename:
          field: json.catalog_id
          target_field: neon_cyber.events.catalog_id
          ignore_missing: true
          tag: rename_events_catalog_id
    - rename:
          field: json.catalog_name
          target_field: neon_cyber.events.catalog_name
          ignore_missing: true
          tag: rename_events_catalog_name
    - rename:
          field: json.domains
          target_field: neon_cyber.events.domains
          ignore_missing: true
          tag: rename_events_domains
    - date:
          field: json.start_timestamp
          target_field: neon_cyber.events.start_timestamp
          formats:
              - ISO8601
          if: ctx.json?.start_timestamp != null
          tag: date_events_start_timestamp
    - date:
          field: json.end_timestamp
          target_field: neon_cyber.events.end_timestamp
          formats:
              - ISO8601
          if: ctx.json?.end_timestamp != null
          tag: date_events_end_timestamp
    - rename:
          field: json.cumulative
          target_field: neon_cyber.events.cumulative
          ignore_missing: true
          tag: rename_events_cumulative
    - rename:
          field: json.auth_method
          target_field: neon_cyber.events.auth_method
          ignore_missing: true
          tag: rename_events_auth_method
    - rename:
          field: json.login
          target_field: neon_cyber.events.login
          ignore_missing: true
          tag: rename_events_login
    - rename:
          field: json.mfa
          target_field: neon_cyber.events.mfa
          ignore_missing: true
          tag: rename_events_mfa
    - rename:
          field: json.email
          target_field: neon_cyber.events.email
          ignore_missing: true
          tag: rename_events_email
    - rename:
          field: json.autofill
          target_field: neon_cyber.events.autofill
          ignore_missing: true
          tag: rename_events_autofill
    - rename:
          field: json.filehash
          target_field: neon_cyber.events.filehash
          ignore_missing: true
          tag: rename_events_filehash
    - rename:
          field: json.extensions
          target_field: neon_cyber.events.extensions
          if: ctx.json.extensions != null
          ignore_failure: true
          tag: rename_events_extensions
    - rename:
          field: json.ext_id
          target_field: neon_cyber.events.ext_id
          ignore_missing: true
          tag: rename_events_ext_id
    - rename:
          field: json.ext_name
          target_field: neon_cyber.events.ext_name
          ignore_missing: true
          tag: rename_events_ext_name
    - rename:
          field: json.ext_enabled
          target_field: neon_cyber.events.ext_enabled
          ignore_missing: true
          tag: rename_events_ext_enabled
    - rename:
          field: json.ext_description
          target_field: neon_cyber.events.ext_description
          ignore_missing: true
          tag: rename_events_ext_description
    - rename:
          field: json.ext_install_type
          target_field: neon_cyber.events.ext_install_type
          ignore_missing: true
          tag: rename_events_ext_install_type
    - rename:
          field: json.ext_host_permissions
          target_field: neon_cyber.events.ext_host_permissions
          ignore_missing: true
          tag: rename_events_ext_host_permissions
    - rename:
          field: json.ext_permissions
          target_field: neon_cyber.events.ext_permissions
          ignore_missing: true
          tag: rename_events_ext_permissions
    - remove:
          field: json.event_timestamp
          tag: remove_event_timestamp
    - remove:
          field: json.inserted_at
          tag: remove_inserted_at
    - remove:
          field: json.updated_at
          tag: remove_updated_at
    - remove:
          field: json.start_timestamp
          if: ctx.json?.start_timestamp != null
          tag: remove_start_timestamp
    - remove:
          field: json.end_timestamp
          if: ctx.json?.end_timestamp != null
          tag: remove_ent_timestamp
    - script:
          tag: drop_nulls
          description: Drops null/empty values recursively.
          lang: painless
          source: |
              boolean dropEmptyFields(Object object) {
                  if (object == null || object == '') {
                  return true;
                  } else if (object instanceof Map) {
                  ((Map) object).values().removeIf(value -> dropEmptyFields(value));
                  return (((Map) object).size() == 0);
                  } else if (object instanceof List) {
                  ((List) object).removeIf(value -> dropEmptyFields(value));
                  return (((List) object).length == 0);
                  }
                  return false;
              }
              dropEmptyFields(ctx);
on_failure:
    - append:
          field: error.message
          value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
          tag: append_error_message
    - set:
          field: event.kind
          value: pipeline_error
          tag: set_pipeline_error_to_event_kind
    - append:
          field: tags
          value: preserve_original_event
          allow_duplicates: false
          tag: append_tags
