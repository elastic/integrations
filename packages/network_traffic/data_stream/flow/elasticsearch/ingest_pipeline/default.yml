---
description: Pipeline for processing traffic flows
processors:
- set:
    field: ecs.version
    value: '8.7.0'
##
# Set {host,source,destination}.mac to dash separated upper case value
# as per ECS recommendation
##
- gsub:
    field: host.mac
    pattern: '[-:.]'
    replacement: ''
    ignore_missing: true
- gsub:
    field: host.mac
    pattern: '(..)(?!$)'
    replacement: '$1-'
    ignore_missing: true
- uppercase:
    field: host.mac
    ignore_missing: true
- set:
    field: observer.vendor
    value: Elastic
- set:
    field: observer.product
    value: Packetbeat
- set:
    field: observer.type
    value: sensor
- append:
    field: related.hosts
    value: "{{{observer.hostname}}}"
    if: ctx.observer?.hostname != null && ctx.observer?.hostname != ''
    allow_duplicates: false
- foreach:
    if: ctx.observer?.ip != null && ctx.observer.ip instanceof List
    field: observer.ip
    processor:
      append:
        field: related.ip
        value: '{{{_ingest._value}}}'
        allow_duplicates: false
- remove:
    if: ctx.tags.contains('forwarded')
    field: host.name
    ignore_missing: true
- gsub:
    field: source.mac
    pattern: '[-:.]'
    replacement: ''
    ignore_missing: true
- gsub:
    field: source.mac
    pattern: '(..)(?!$)'
    replacement: '$1-'
    ignore_missing: true
- uppercase:
    field: source.mac
    ignore_missing: true
- gsub:
    field: destination.mac
    pattern: '[-:.]'
    replacement: ''
    ignore_missing: true
- gsub:
    field: destination.mac
    pattern: '(..)(?!$)'
    replacement: '$1-'
    ignore_missing: true
- uppercase:
    field: destination.mac
    ignore_missing: true

- pipeline:
    if: ctx._conf?.geoip_enrich != null && ctx._conf.geoip_enrich
    name: '{{ IngestPipeline "geoip" }}'
- remove:
    field: _conf
    ignore_missing: true

on_failure:
- set:
    field: error.message
    value: "{{ _ingest.on_failure_message }}"
