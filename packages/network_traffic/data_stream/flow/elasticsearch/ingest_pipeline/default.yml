---
description: Pipeline for processing traffic flows
processors:
  - set:
      field: ecs.version
      value: 8.7.0
  ##
  # Set {host,source,destination}.mac to dash separated upper case value
  # as per ECS recommendation
  ##
  - gsub:
      field: host.mac
      ignore_missing: true
      pattern: '[-:.]'
      replacement: ''
      tag: gsub host mac
  - gsub:
      field: host.mac
      ignore_missing: true
      pattern: (..)(?!$)
      replacement: $1-
      tag: gsub host mac
  - uppercase:
      field: host.mac
      ignore_missing: true
  - gsub:
      field: source.mac
      ignore_missing: true
      pattern: '[-:.]'
      replacement: ''
      tag: gsub source mac
  - gsub:
      field: source.mac
      ignore_missing: true
      pattern: (..)(?!$)
      replacement: $1-
      tag: gsub source mac
  - uppercase:
      field: source.mac
      ignore_missing: true
  - gsub:
      field: destination.mac
      ignore_missing: true
      pattern: '[-:.]'
      replacement: ''
      tag: gsub dest mac
  - gsub:
      field: destination.mac
      ignore_missing: true
      pattern: (..)(?!$)
      replacement: $1-
      tag: gsub dest mac
  - uppercase:
      field: destination.mac
      ignore_missing: true
  - pipeline:
      if: ''ctx._conf?.geoip_enrich != null && ctx._conf.geoip_enrich''
      name: '{{ IngestPipeline "geoip" }}'
      tag: pipeline
  - remove:
      field: _conf
      ignore_missing: true
on_failure:
  - set:
      field: error.message
      value: |-
        Processor "{{ _ingest.on_failure_processor_type }}" with tag "{{ _ingest.on_failure_processor_tag }}" in pipeline "{{ _ingest.on_failure_pipeline }}" failed with message "{{ _ingest.on_failure_message }}"
  - set:
      field: event.kind
      value: pipeline_error
