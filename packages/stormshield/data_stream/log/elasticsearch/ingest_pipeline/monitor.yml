---
description: Pipeline for processing monitor logs from Stormshield appliances.
processors:
  - script:
      tag: script_process_devices
      lang: painless
      description: Process device stat fields.
      params:
        devices:
          - agg
          - ipsec
          - sslvpn
          - Wifi
          - Qid
          - Vlan
          - Ethernet
        stats:
          - name
          - incoming_throughput
          - maximum_incoming_throughput
          - outgoing_throughput
          - maximum_outgoing_throughput
          - packets_accepted
          - packets_blocked
      source: >-
        def deviceStats = [:];
        ctx.stormshield.forEach((k, v) -> {
          params.devices.forEach(d -> {
            if (k.startsWith(d)) {
              deviceStats[k] = [:];
              deviceStats[k]["value"] = v;
              deviceStats[k]["stem"] = d;
            }
        
            return true;
          });
        });
        
        if (deviceStats.isEmpty()) {
          return;
        }
        ctx.stormshield.device_stats = [:];
        def result = [:];
        for (entry in deviceStats.entrySet()) {
          def entryValue = entry.getValue();
          def stem = entryValue["stem"];
          if (!result.containsKey(stem)) {
            result[stem] = [];
          }
          def values = entryValue["value"].splitOnToken(',', 7);
          def item = [:];
          item["original"] = entry.getKey();
          for (int i = 0; i < values.length; ++i) {
            if (i == 0) {
              item[params.stats[i]] = values[i];
            } else {
              item[params.stats[i]] = Long.parseLong(values[i]);        
            }
          }
          result[stem].add(item);
          ctx.stormshield.remove(entry.getKey());
        }
        for (entry in result.entrySet()) {
          result[entry.getKey()].sort((a, b) -> a["original"].compareTo(b["original"]));
        }
        ctx.stormshield.device_stats = result;
on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error