---
description: Pipeline for processing sample logs
processors:
  - set:
      field: ecs.version
      value: '8.11.0'

  #
  # The syslog header should have been stripped off, so we need to process the key=value data
  # We will be using painless here, because it is the best option we have.
  - script:
      tag: stormshield_kv_parse
      description: Parse key/value pairs from message.
      lang: painless
      source: >-
        ctx["_fields_"] = new HashMap();

        def kvStart = 0;
        def kvSplit = 0;
        def kvEnd = 0;
        def inQuote = false;

        for (int i = 0, n = ctx["message"].length(); i < n; ++i) {
          char c = ctx["message"].charAt(i);
          if (c == (char)'"') {
            inQuote = !inQuote;
          }
          if (inQuote) {
            continue;
          }
          
          if (c == (char)'=') {
            kvSplit = i;
          }
          if (c == (char)' ') {
            if (kvStart != kvSplit) {
              def key = ctx["message"].substring(kvStart, kvSplit);
              def value = ctx["message"].substring(kvSplit + 1, i).replace("\"", "");
              ctx["_fields_"][key] = value;
            }

            kvStart = i + 1;
            kvSplit = i + 1;
          }
        }
  - rename:
      field: _fields_.msg
      target_field: event.log.msg
      ignore_missing: true
      if: ctx.event?.log?.msg == null
on_failure:
- set:
    field: error.message
    value: '{{ _ingest.on_failure_message }}'
