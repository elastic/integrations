# Service Info

## Common use cases

The Stormshield Network Security (SNS) integration enables the ingestion and analysis of security events from Stormshield Next-Generation Firewalls into the Elastic Stack.
- **Threat Detection and Response:** Monitor firewall filter and alarm logs to identify, investigate, and mitigate malicious traffic patterns or intrusion attempts in real-time.
- **Compliance and Auditing:** Maintain comprehensive audit trails of administrative changes and system events to satisfy regulatory requirements like GDPR, PCI-DSS, or HIPAA.
- **Network Traffic Monitoring:** Gain deep visibility into network behavior by analyzing traffic logs and NAT events to optimize bandwidth and identify unauthorized application usage.
- **System Health and Performance:** Track system-level events and alarms to proactively manage firewall performance and ensure high availability across the security infrastructure.

## Data types collected

The **Stormshield SNS logs** integration collects a variety of security and system events from SNS instances. Each data stream provides specific insights into network activity:

- **Stormshield logs (via UDP):** This data stream collects Stormshield logs via the UDP protocol. It is designed for high-speed log ingestion where minor packet loss is acceptable. It populates the `log` dataset.
- **Stormshield logs (via TCP):** This data stream collects Stormshield logs via the TCP protocol. It provides reliable delivery of security events, ensuring no logs are lost during transit. It populates the `log` dataset.
- **Firewall Logs:** Detailed records of filter and NAT policy decisions, including source/destination IP addresses, ports, and protocols.
- **Audit and Administrative Logs:** Events related to administrative logins, configuration changes (`serverd`), and system-level operations.
- **Alarm Logs:** Security-specific alerts generated by the SNS Intrusion Prevention System (IPS) and detection engines.
- **Traffic Statistics:** Ingests periodic statistics to monitor bandwidth usage and application performance.

## Compatibility

This integration is compatible with the following third-party vendor systems:
- **Stormshield Network Security (SNS)** firewalls running the unified firmware base.
- **SNS v4.x** is the primarily documented and tested version for these log formats.

## Scaling and Performance

To ensure optimal performance in high-volume security environments, consider the following:

- **Transport/Collection Considerations:** The integration supports both **UDP** and **TCP**. While UDP offers lower overhead for high-volume environments, it does not guarantee delivery. For critical security auditing where log integrity is paramount, TCP should be used to ensure the Elastic Agent receives every event, though this adds connection overhead.
- **Data Volume Management:** To manage high data volumes, configure the SNS appliance to forward only necessary event families. Limit "Filter Policy" logs to high-risk rules rather than logging all traffic. Avoid forwarding debug-level logs to minimize the load on the ingest pipeline and storage. Use the **Processors** configuration to drop redundant fields at the source.
- **Elastic Agent Scaling:** For high-throughput environments processing thousands of events per second, deploy dedicated Elastic Agents on high-performance hosts. If volume exceeds the capacity of a single agent, distribute traffic across multiple Agents using a network load balancer to ensure high availability and horizontal scaling.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** Root or full administrator credentials for the Stormshield Network Security web administration interface.
- **Network Connectivity:** Ensure the SNS appliance can reach the Elastic Agent host over the network.
- **Port Availability:** Open the required Syslog ports (default `514` for UDP or `601` for TCP) in any intermediate firewalls.
- **Knowledge of Agent IP:** You must have the static IP address or FQDN of the host where the Elastic Agent is installed.
- **Licensing:** An active SNS license that supports remote logging features.

## Elastic prerequisites

- **Elastic Agent:** An active Elastic Agent must be installed and enrolled in a policy.
- **Elastic Stack Version:** Kibana version 8.11.4 or higher (or 9.0.0+) is required for this integration.
- **Connectivity:** The host running the Elastic Agent must be reachable by the SNS appliance on the configured syslog port.
- **Permissions:** Elastic Stack user with permissions to manage Integrations and Fleet policies.

## Vendor set up steps

To configure Stormshield Network Security (SNS) to forward logs to the Elastic Agent, follow these steps:

### For Syslog Collection (UDP or TCP):

1. Log in to the Stormshield Network Security web administration interface.
2. Navigate to the **CONFIGURATION** tab on the left sidebar.
3. Go to **NOTIFICATIONS > LOGS - SYSLOG - IPFIX**.
4. In the **Syslog** section, ensure the service is enabled by switching the status to **ON**.
5. Select a **Profile** slot to edit (e.g., Profile 1).
6. In the **IP Address** field, enter the IP address of the host where the Elastic Agent is running.
7. Enter the **Port** number matching your Elastic Agent configuration (e.g., `514` for UDP or `601` for TCP).
8. Select the **Protocol** (**UDP** or **TCP**) that matches your integration input.
9. Choose the **Format**: **RFC5424** is recommended for modern logging, though **Legacy** (BSD) is also supported.
10. In the **Advanced properties** section, enable the specific log families you wish to send. Ensure **Filter Policy**, **Administration**, **System**, and **Alarms** are active.
11. Click **Apply** to save the syslog configuration.

### Enabling Traffic Logs for Specific Rules:

1. Navigate to **Configuration > Security policy > Filter - NAT**.
2. Identify the security rules for which you want to collect logs.
3. Double-click a rule to open its properties.
4. Go to the **Action** menu or the General tab.
5. Set the **Log level** to **Standard (connection log)**.
6. Click **OK** and then click **Apply** at the top of the interface to deploy the policy change.

### Vendor Set up Resources

- [Stormshield SNS Log Configuration Documentation](https://documentation.stormshield.eu/SNS/v4/en/Content/Description_of_Audit_logs/Configure_logs.htm) - Detailed guide on configuring SNS logs and syslog profiles.
- [FireMon - Stormshield Device Configuration Guide](https://docs.firemon.com/feature/Content/ADMINISTRATION/DEVICE/Devices/StormShield/Stormshield_Network_Security.htm?TocPath=Administration|Device|Devices|Choose+a+Device+to+Onboard|_____51) - Additional reference for device onboarding and log management.

## Kibana set up steps

1. In Kibana, navigate to **Management > Integrations**.
2. Search for and select **StormShield SNS**.
3. Click **Add StormShield SNS**.
4. Configure the inputs based on your SNS configuration:

### Collecting logs from Stormshield SNS via UDP
This input collects Stormshield logs via the UDP protocol.
- **Listen Address** (`udp_host`): The bind address to listen for UDP connections. Set to `0.0.0.0` to bind to all available interfaces. Default: `localhost`.
- **Listen Port** (`udp_port`): The UDP port number to listen on. Default: `514`.
- **Preserve original event** (`preserve_original_event`): Preserves a raw copy of the original event, added to the field `event.original`. Default: `False`.
- **Tags** (`tags`): A list of tags to add to the events. Default: `['forwarded']`.
- **Custom UDP Options** (`udp_options`): Specify custom configuration options for the UDP input such as `read_buffer`, `max_message_size`, or `timeout`.
- **Processors** (`processors`): Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata. This executes in the agent before the logs are parsed.

### Collecting logs from Stormshield SNS via TCP
This input collects Stormshield logs via the TCP protocol.
- **Listen Address** (`tcp_host`): The bind address to listen for TCP connections. Set to `0.0.0.0` to bind to all available interfaces. Default: `localhost`.
- **Listen Port** (`tcp_port`): The TCP port number to listen on. Default: `601`.
- **Preserve original event** (`preserve_original_event`): Preserves a raw copy of the original event, added to the field `event.original`. Default: `False`.
- **Tags** (`tags`): A list of tags to add to the events. Default: `['forwarded']`.
- **Custom TCP Options** (`tcp_options`): Specify custom configuration options for the TCP input such as `framing: rfc6587`.
- **SSL Configuration** (`ssl`): SSL configuration options including `certificate` and `key` for encrypted log transmission.
- **Processors** (`processors`): Processors are used to reduce the number of fields in the exported event or to enhance the event with metadata. This executes in the agent before the logs are parsed.

5. Follow the prompts to add the integration to an Elastic Agent policy.
6. Save and deploy the integration.

# Validation Steps

After configuration is complete, verify that data is flowing correctly.

### 1. Trigger Data Flow on Stormshield:
- **Generate Web Traffic:** From a client workstation behind the Stormshield firewall, browse several external websites to generate Filter and NAT logs.
- **Generate Administrative Audit:** Log out and log back into the Stormshield web administration interface to trigger an administration event.
- **Generate Configuration Event:** Enter configuration mode, make a minor change (such as a rule description), save it, and exit to trigger a `serverd` log.
- **Trigger Alarm:** If a test environment is available, attempt a restricted access pattern (such as an Nmap scan) to trigger an intrusion detection alarm.

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the KQL filter: `data_stream.dataset : "stormshield.log"`
4. Verify logs appear. Expand a log entry and confirm these fields:
   - `event.dataset` (should be `stormshield.log`)
   - `source.ip` and/or `destination.ip`
   - `event.action` or `event.outcome`
   - `message` (the raw log payload)
5. Navigate to **Analytics > Dashboards** and search for "StormShield SNS" to view pre-built visualizations.

# Troubleshooting

## Common Configuration Issues

- **Mismatched Syslog Ports**: Ensure the port configured in the Stormshield "Logs - Syslog - IPFIX" section exactly matches the **Listen Port** configured in the Kibana integration settings.
- **Protocol Mismatch**: If SNS is configured to send via TCP but the Agent is listening on UDP (or vice versa), logs will not be ingested. Verify both sides use the same protocol.
- **Firewall Blocking**: Check local host firewalls on the Elastic Agent machine (e.g., `iptables` or Windows Firewall) to ensure they are not blocking incoming traffic on the configured syslog ports.
- **Binding to Localhost**: If the **Listen Address** in Kibana is set to `localhost`, the Agent will only accept logs from its own host. Change this to `0.0.0.0` to receive logs from the SNS appliance over the network.

## Ingestion Errors

- **Parsing Failures**: If logs appear in Kibana but contain a `tags: ["_syslog_parse_failure"]` or similar error, verify the **Format** in the SNS appliance (RFC5424 vs Legacy). The integration expects standard syslog formats.
- **Format Mismatch**: Ensure the `framing` option in TCP settings matches the SNS output (standard or RFC6587) to avoid message splitting issues.
- **Checking Error Messages**: Monitor the `error.message` field in Discover to identify specific mapping or processing failures that occur during ingestion.

## Vendor Resources

Refer to the official vendor website for additional resources.

# Documentation sites

- [Stormshield SNS Log Configuration Documentation](https://documentation.stormshield.eu/SNS/v4/en/Content/Description_of_Audit_logs/Configure_logs.htm)
- Refer to the official vendor website for additional documentation.