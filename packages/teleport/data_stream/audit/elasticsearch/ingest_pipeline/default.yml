---
description: Pipeline for processing Teleport audit logs
processors:
  - set:
      field: ecs.version
      tag: set_ecs_version
      value: 8.11.0
  - rename:
      field: message
      target_field: event.original
      tag: rename_message
      ignore_missing: true
      if: ctx.event?.original == null
  - remove:
      field: message
      ignore_missing: true
      tag: remove_message
      if: ctx.event?.original != null
  - json:
      field: event.original
      tag: json_original
      target_field: teleport.audit
  # all event types
  - date:
      field: teleport.audit.time
      target_field: '@timestamp'
      formats:
        - ISO8601
      if: ctx.teleport?.audit?.time != null
  - remove:
      field: teleport.audit.time
      ignore_missing: true
  - rename:
      field: teleport.audit.error
      target_field: error.message
      ignore_missing: true
  - rename:
      field: teleport.audit.uid
      target_field: event.id
      ignore_missing: true
  - rename:
      field: teleport.audit.event
      target_field: event.action
      ignore_missing: true
  - rename:
      field: teleport.audit.ei
      target_field: event.sequence
      ignore_missing: true
  - rename:
      field: teleport.audit.sid
      target_field: teleport.audit.session_id
      ignore_missing: true
  - rename:
      field: teleport.audit.size
      target_field: teleport.audit.terminal_size
      ignore_missing: true
  - rename:
      field: teleport.audit.cluster_name
      target_field: orchestrator.cluster.name
      ignore_missing: true
  - rename:
      field: teleport.audit.login
      target_field: server.user.name
      ignore_missing: true
  - rename:
      field: teleport.audit.user
      target_field: user.name
      ignore_missing: true
  # exec event type
  - rename:
      field: teleport.audit.command
      target_field: process.command_line
      ignore_missing: true
  - rename:
      field: teleport.audit.exitCode
      target_field: process.exit_code
      ignore_missing: true
  - rename:
      field: teleport.audit.exitError
      target_field: error.message
      ignore_missing: true

  # SessionMetadata is a common session event metadata
  -  rename:
       field: teleport.audit.session_id
       target_field: teleport.audit.session.session_id
       ignore_missing: true
  -  rename:
       field: teleport.audit.with_mfa
       target_field: teleport.audit.session.with_mfa
       ignore_missing: true
  -  rename:
       field: teleport.audit.private_key_policy
       target_field: teleport.audit.session.private_key_policy
       ignore_missing: true

  # UserMetadata is a common user event metadata
  -  rename:
       field: teleport.audit.user
       target_field: teleport.audit.user.user
       ignore_missing: true
  -  rename:
       field: teleport.audit.login
       target_field: teleport.audit.user.login
       ignore_missing: true
  -  rename:
       field: teleport.audit.impersonator
       target_field: teleport.audit.user.impersonator
       ignore_missing: true
  -  rename:
       field: teleport.audit.aws_role_arn
       target_field: teleport.audit.user.aws_role_arn
       ignore_missing: true
  -  rename:
       field: teleport.audit.access_requests
       target_field: teleport.audit.user.access_requests
       ignore_missing: true
  -  rename:
       field: teleport.audit.azure_identity
       target_field: teleport.audit.user.azure_identity
       ignore_missing: true
  -  rename:
       field: teleport.audit.gcp_service_account
       target_field: teleport.audit.user.gcp_service_account
       ignore_missing: true
  -  rename:
       field: teleport.audit.trusted_device
       target_field: teleport.audit.user.trusted_device
       ignore_missing: true
  -  rename:
       field: teleport.audit.required_private_key_policy
       target_field: teleport.audit.user.required_private_key_policy
       ignore_missing: true
  -  rename:
       field: teleport.audit.user_kind
       target_field: teleport.audit.user.user_kind
       ignore_missing: true

  # https://github.com/gravitational/teleport/blob/43b272c546f59ff4e4cc7fb115419839aa4d364e/api/proto/teleport/legacy/types/events/events.proto
  # DatabaseMetadata contains common database information.
  - rename:
      field: teleport.audit.db_service
      target_field: teleport.audit.database.service
      ignore_missing: true
  - rename:
      field: teleport.audit.db_protocol
      target_field: teleport.audit.database.protocol
      ignore_missing: true
  - rename:
      field: teleport.audit.db_uri
      target_field: teleport.audit.database.uri
      ignore_missing: true
  - rename:
      field: teleport.audit.db_name
      target_field: teleport.audit.database.name
      ignore_missing: true
  - rename:
      field: teleport.audit.db_user
      target_field: teleport.audit.database.user
      ignore_missing: true
  - rename:
      field: teleport.audit.db_labels
      target_field: teleport.audit.database.labels
      ignore_missing: true
  - rename:
      field: teleport.audit.db_aws_region
      target_field: teleport.audit.database.aws.region
      ignore_missing: true
  - rename:
      field: teleport.audit.db_aws_redshift_cluster_id
      target_field: teleport.audit.database.aws.redshift_cluster_id
      ignore_missing: true
  - rename:
      field: teleport.audit.db_gcp_project_id
      target_field: teleport.audit.database.gcp.project_id
      ignore_missing: true
  - rename:
      field: teleport.audit.db_gcp_instance_id
      target_field: teleport.audit.database.gcp.instance_id
      ignore_missing: true
  - rename:
      field: teleport.audit.db_type
      target_field: teleport.audit.database.type
      ignore_missing: true
  - rename:
      field: teleport.audit.db_origin
      target_field: teleport.audit.database.origin
      ignore_missing: true

  # KubernetesClusterMetadata contains common metadata for kubernetes-related events.
  - rename:
      field: teleport.audit.kubernetes_cluster
      target_field: teleport.audit.kubernetes.cluster
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_users
      target_field: teleport.audit.kubernetes.users
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_groups
      target_field: teleport.audit.kubernetes.groups
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_labels
      target_field: teleport.audit.kubernetes.labels
      ignore_missing: true

  # KubernetesPodMetadata contains common metadata for kubernetes pod-related events.
  - rename:
      field: teleport.audit.kubernetes_pod_name
      target_field: teleport.audit.kubernetes_pod.pod_name
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_pod_namespace
      target_field: teleport.audit.kubernetes_pod.pod_namespace
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_container_name
      target_field: teleport.audit.kubernetes_pod.container_name
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_container_image
      target_field: teleport.audit.kubernetes_pod.container_image
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_node_name
      target_field: teleport.audit.kubernetes_pod.node_name
      ignore_missing: true

  # Server is a server metadata
  -  rename:
       field: teleport.audit.namespace
       target_field: teleport.audit.server.namespace
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_id
       target_field: teleport.audit.server.server_id
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_hostname
       target_field: teleport.audit.server.server_hostname
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_addr
       target_field: teleport.audit.server.server_addr
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_labels
       target_field: teleport.audit.server.server_labels
       ignore_missing: true
  -  rename:
       field: teleport.audit.forwarded_by
       target_field: teleport.audit.server.forwarded_by
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_sub_kind
       target_field: teleport.audit.server.server_sub_kind
       ignore_missing: true

  # resize event type
  - grok:
      field: teleport.audit.terminal_size
      patterns:
        - "%{NUMBER:process.tty.columns}:%{NUMBER:process.tty.rows}"
      ignore_missing: true
      ignore_failure: true
  # scp event type
  - rename:
      field: teleport.audit.path
      target_field: file.path
      ignore_missing: true
  - rename:
      field: teleport.audit.len
      target_field: file.size
      ignore_missing: true
  # the rest of the pipeline
  - dot_expander:
      path: teleport.audit
      field: addr.remote
  - dot_expander:
      path: teleport.audit
      field: addr.local
  - rename:
      field: teleport.audit.required_private_key_policy
      target_field: teleport.audit.policy.required_private_key
      ignore_missing: true
  - rename:
      field: teleport.audit.method
      target_field: event.method
      ignore_missing: true
  - rename:
      field: teleport.audit.mfa_device
      target_field: mfa_device
      ignore_missing: true
  - rename:
      field: mfa_device.mfa_device_uuid
      target_field: mfa_device.uuid
      ignore_missing: true
  - rename:
      field: mfa_device.mfa_device_name
      target_field: mfa_device.name
      ignore_missing: true
  - rename:
      field: mfa_device.mfa_device_type
      target_field: mfa_device.type
      ignore_missing: true
  - rename:
      field: teleport.audit.code
      target_field: event.code
      ignore_missing: true
  - rename:
      field: teleport.audit.user_agent
      target_field: user_agent.original
      ignore_missing: true
  - script:
      lang: painless
      description: Adds the URI identifier to make uri_parts processor work
      if: ctx?.teleport?.audit?.addr?.remote != null
      source: |
        ctx.teleport.audit.addr.remote = "//" + ctx.teleport.audit.addr.remote;
  - uri_parts:
      field: teleport.audit.addr.remote
      tag: split_teleport_audit_remote_address
      target_field: teleport.audit.remote
      remove_if_successful: true
      keep_original: true
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: teleport.audit.remote.domain
      target_field: client.ip
      ignore_missing: true
  - rename:
      field: teleport.audit.client_ip
      target_field: client.ip
      ignore_missing: true
  - rename:
      field: teleport.audit.remote.port
      target_field: client.port
      ignore_missing: true
  - rename:
      field: teleport.audit.identity.roles
      target_field: user.roles
      ignore_missing: true
  - rename:
      field: teleport.audit.identity.route_to_database.protocol
      target_field: network.protocol
      ignore_missing: true
  - rename:
      field: teleport.audit.tx
      target_field: source.bytes
      ignore_missing: true
  - rename:
      field: teleport.audit.rx
      target_field: destination.bytes
      ignore_missing: true
  - date:
      field: teleport.audit.session_start
      target_field: event.start
      formats:
        - ISO8601
      if: ctx.teleport?.audit?.session_start != null
  - date:
      field: teleport.audit.session_stop
      target_field: event.end
      formats:
        - ISO8601
      if: ctx.teleport?.audit?.session_stop != null
  - script:
      lang: painless
      description: Adds the URI identifier to make uri_parts processor work
      if: ctx?.teleport?.audit?.addr?.local != null
      source: |
        ctx.teleport.audit.addr.local = "//" + ctx.teleport.audit.addr.local;
  - uri_parts:
      field: teleport.audit.addr.local
      tag: split_teleport_audit_local_address
      target_field: teleport.audit.local
      remove_if_successful: true
      keep_original: true
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: teleport.audit.local.domain
      target_field: server.ip
      ignore_missing: true
  - rename:
      field: teleport.audit.local.port
      target_field: server.port
      ignore_missing: true
  - rename:
      field: teleport.audit.url
      target_field: url.full
      ignore_missing: true
  - rename:
      field: teleport.audit.server_hostname
      target_field: server.domain
      ignore_missing: true
  - rename:
      field: teleport.audit.proto
      target_field: network.protocol
      ignore_missing: true
  - script:
      description: Drops null/empty values recursively.
      tag: script_drop_null_empty_values
      lang: painless
      source: "boolean dropEmptyFields(Object object) {\n  if (object == null || object\
      \ == \"\") {\n    return true;\n  } else if (object instanceof Map) {\n    ((Map)\
      \ object).values().removeIf(value -> dropEmptyFields(value));\n    return (((Map)\
      \ object).size() == 0);\n  } else if (object instanceof List) {\n    ((List)\
      \ object).removeIf(value -> dropEmptyFields(value));\n    return (((List) object).length\
      \ == 0);\n  }\n  return false;\n}\ndropEmptyFields(ctx);\n"
  - geoip:
      field: client.ip
      tag: geoip_client_ip
      target_field: client.geo
      ignore_missing: true
  - geoip:
      ignore_missing: true
      database_file: GeoLite2-ASN.mmdb
      field: client.ip
      tag: geoip_client_asn
      target_field: client.as
      properties:
        - asn
        - organization_name
  - rename:
      field: client.as.asn
      tag: rename_client_as_asn
      target_field: client.as.number
      ignore_missing: true
  - rename:
      field: client.as.organization_name
      tag: rename_client_as_organization_name
      target_field: client.as.organization.name
      ignore_missing: true
  - geoip:
      field: destination.ip
      tag: geoip_destination_ip
      target_field: destination.geo
      ignore_missing: true
  - geoip:
      database_file: GeoLite2-ASN.mmdb
      field: destination.ip
      tag: geoip_destination_asn
      target_field: destination.as
      properties:
        - asn
        - organization_name
      ignore_missing: true
  - rename:
      field: destination.as.asn
      tag: rename_destination_as_asn
      target_field: destination.as.number
      ignore_missing: true
  - rename:
      field: destination.as.organization_name
      tag: rename_destination_as_organization_name
      target_field: destination.as.organization.name
      ignore_missing: true
  - append:
      field: event.type
      value:
        - start
      allow_duplicates: false
      if: ctx.event?.action == 'user.login' && ctx.teleport?.audit?.success == true
  - append:
      field: event.category
      value:
        - authentication
      allow_duplicates: false
      if: ctx.event?.action == 'user.login'
  - append:
      field: event.type
      value:
        - creation
      allow_duplicates: false
      if: ctx.event?.action == 'cert.create'
  - append:
      field: event.category
      value:
        - iam
      allow_duplicates: false
      if: ctx.event?.action == 'cert.create'
  - append:
      field: event.type
      value:
        - start
      allow_duplicates: false
      if: ctx.event?.action == 'session.start'
  - append:
      field: event.category
      value:
        - session
      allow_duplicates: false
      if: ctx.event?.action == 'session.start'
  - append:
      field: event.type
      value:
        - info
      allow_duplicates: false
      if: ctx.event?.action == 'session.leave'
  - append:
      field: event.category
      value:
        - session
      allow_duplicates: false
      if: ctx.event?.action == 'session.leave'
  - append:
      field: event.type
      value:
        - info
      allow_duplicates: false
      if: ctx.event?.action == 'session.data'
  - append:
      field: event.category
      value:
        - session
      allow_duplicates: false
      if: ctx.event?.action == 'session.data'
  - append:
      field: event.type
      value:
        - end
      allow_duplicates: false
      if: ctx.event?.action == 'session.end'
  - append:
      field: event.category
      value:
        - session
      allow_duplicates: false
      if: ctx.event?.action == 'session.end'
  - append:
      field: event.type
      value:
        - info
      allow_duplicates: false
      if: ctx.event?.action == 'session.upload'
  - append:
      field: event.category
      value:
        - session
      allow_duplicates: false
      if: ctx.event?.action == 'session.upload'
  - append:
      field: event.type
      value:
        - creation
      allow_duplicates: false
      if: ctx.event?.action == 'role.created'
  - append:
      field: event.category
      value:
        - iam
      allow_duplicates: false
      if: ctx.event?.action == 'role.created'
  - append:
      field: event.type
      value:
        - creation
      allow_duplicates: false
      if: ctx.event?.action == 'user.create'
  - append:
      field: event.category
      value:
        - iam
      allow_duplicates: false
      if: ctx.event?.action == 'user.create'
  - append:
      field: event.type
      value:
        - end
      allow_duplicates: false
      if: ctx.event?.action == 'user.login' && ctx.teleport?.audit?.success == false
  - append:
      field: event.type
      value:
        - end
      allow_duplicates: false
      if: ctx.event?.action == 'user.login' && ctx.teleport?.audit?.success == false
  - append:
      field: event.outcome
      value:
        - success
      allow_duplicates: false
      if: ctx.teleport?.audit?.success == true
  - remove:
      field: teleport.audit.success
      if: ctx.teleport?.audit?.success == true
  - append:
      field: event.outcome
      value:
        - failure
      allow_duplicates: false
      if: ctx.teleport?.audit?.success == false
  - remove:
      field: teleport.audit.success
      if: ctx.teleport?.audit?.success == false
  - append:
      field: related.ip
      value:
        - '{{{teleport.audit.addr.remote}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.addr?.remote != null
  - append:
      field: related.ip
      value:
        - '{{{teleport.audit.addr.local}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.addr?.local != null
  - append:
      field: related.ip
      value:
        - '{{{teleport.audit.identity.client_ip}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.identity?.client_ip != null
  - append:
      field: related.user
      value:
        - '{{{user.name}}}'
      allow_duplicates: false
      if: ctx?.user?.name != null
  - append:
      field: related.user
      value:
        - '{{{teleport.audit.identity.user}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.identity?.user != null
  - append:
      field: related.user
      value:
        - '{{{teleport.audit.identity.logins}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.identity?.logins != null
  - append:
      field: related.user
      value:
        - '{{{teleport.audit.participants}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.participants != null
  - append:
      field: related.hosts
      value:
        - '{{{teleport.audit.server_hostname}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.server_hostname != null
  - append:
      field: related.hosts
      value:
        - '{{{teleport.audit.server_labels.hostname}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.server_labels?.hostname != null
  - append:
      field: related.hosts
      value:
        - '{{{teleport.audit.server_addr}}}'
      allow_duplicates: false
      if: ctx?.teleport?.audit?.server_addr != null
  - remove:
      field: event.original
      tag: remove_original_event
      if: ctx?.tags == null || !(ctx.tags.contains("preserve_original_event"))
      ignore_failure: true
      ignore_missing: true
on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}}
      in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
