---
description: >
  Pipeline to group Teleport audit fields into metadata groups.
  See https://github.com/gravitational/teleport/blob/master/api/proto/teleport/legacy/types/events/events.proto
processors:

  # Metadata is a common event metadata.
  # All of these fields are mapped to ECS fields.
  - rename:
      field: teleport.audit.ei
      target_field: event.sequence
      ignore_missing: true
  - rename:
      field: teleport.audit.event
      target_field: event.action
      ignore_missing: true
  - rename:
      field: teleport.audit.uid
      target_field: event.id
      ignore_missing: true
  - rename:
      field: teleport.audit.code
      target_field: event.code
      ignore_missing: true
  - date:
      field: teleport.audit.time
      target_field: '@timestamp'
      formats:
        - ISO8601
      if: ctx.teleport?.audit?.time != null
  - remove:
      field: teleport.audit.time
      ignore_missing: true
  - rename:
      field: teleport.audit.cluster_name
      target_field: orchestrator.cluster.name
      ignore_missing: true

  # SessionMetadata is a common session event metadata
  # See session.yml for field definitions.
  -  rename:
       field: teleport.audit.sid
       target_field: teleport.audit.session.session_id
       ignore_missing: true
  -  rename:
       field: teleport.audit.with_mfa
       target_field: teleport.audit.session.mfa_device_id
       ignore_missing: true
  -  rename:
       field: teleport.audit.private_key_policy
       target_field: teleport.audit.session.private_key_policy
       ignore_missing: true

  # UserMetadata is a common user event metadata
  # See user.yml for field definitions.
  -  rename:
       field: teleport.audit.user
       target_field: user.name
       ignore_missing: true
  -  rename:
       field: teleport.audit.login
       target_field: teleport.audit.user.os_login
       ignore_missing: true
  -  rename:
       field: teleport.audit.impersonator
       target_field: teleport.audit.user.impersonator
       ignore_missing: true
  -  rename:
       field: teleport.audit.aws_role_arn
       target_field: teleport.audit.user.aws_role_arn
       ignore_missing: true
  -  rename:
       field: teleport.audit.access_requests
       target_field: teleport.audit.user.access_requests
       ignore_missing: true
  -  rename:
       field: teleport.audit.azure_identity
       target_field: teleport.audit.user.azure_identity
       ignore_missing: true
  -  rename:
       field: teleport.audit.gcp_service_account
       target_field: teleport.audit.user.gcp_service_account
       ignore_missing: true
  -  rename:
       field: teleport.audit.trusted_device
       target_field: teleport.audit.user.trusted_device
       ignore_missing: true
  -  rename:
       field: teleport.audit.required_private_key_policy
       target_field: teleport.audit.user.required_private_key_policy
       ignore_missing: true
  -  set:
       field: teleport.audit.user.kind
       value: unspecified
       if: ctx.teleport?.audit?.user_kind == 0
  -  set:
       field: teleport.audit.user.kind
       value: human
       if: ctx.teleport?.audit?.user_kind == 1
  -  set:
       field: teleport.audit.user.kind
       value: bot
       if: ctx.teleport?.audit?.user_kind == 2
  - remove:
      field: teleport.audit.user_kind
      ignore_missing: true
      if: ctx.teleport?.audit?.user?.kind != null

  # Server is a server metadata
  # See server.yml for field definitions.
  -  rename:
       field: teleport.audit.namespace
       target_field: group.name
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_id
       target_field: host.id
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_hostname
       target_field: host.hostname
       ignore_missing: true
  - script:
      tag: add_tmp_server_addr
      lang: painless
      description: Adds the URI identifier to make uri_parts processor work
      if: ctx?.teleport?.audit?.server_addr != null
      source: |
        ctx.teleport.audit.tmp_server_addr = "//" + ctx.teleport.audit.server_addr;
  - uri_parts:
      tag: parse_tmp_server_addr
      field: teleport.audit.tmp_server_addr
      target_field: teleport.audit.server.address
      keep_original: false
      ignore_missing: true
      ignore_failure: true
  - remove:
      field: teleport.audit.tmp_server_addr
      ignore_missing: true
  - rename:
      field: teleport.audit.server_addr
      target_field: teleport.audit.server.address.original
      ignore_missing: true
  -  rename:
       field: teleport.audit.server_labels
       target_field: teleport.audit.server.labels
       ignore_missing: true
  -  rename:
       field: teleport.audit.forwarded_by
       target_field: teleport.audit.server.forwarded_by
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_sub_kind
       target_field: teleport.audit.server.sub_kind
       ignore_missing: true
  -  rename:
       field: teleport.audit.server_version
       target_field: teleport.audit.server.version
       ignore_missing: true
  - rename:
      field: teleport.audit.server.address.ip
      target_field: host.ip
      ignore_missing: true
  - rename:
      field: teleport.audit.server.address.port
      target_field: host.port
      ignore_missing: true

  # Connection contains connection info.
  # See connection.yml for field definitions.
  - rename:
      field: teleport.audit.proto
      target_field: network.protocol
      ignore_missing: true

  # Extract data from addr.local field.
  - dot_expander:
      path: teleport.audit
      field: addr.local
  - script:
      tag: add_tmp_addr_local
      lang: painless
      description: Adds the URI identifier to make uri_parts processor work
      if: ctx?.teleport?.audit?.addr?.local != null
      source: |
        ctx.teleport.audit.tmp_addr_local = "//" + ctx.teleport.audit.addr.local;
  - uri_parts:
      tag: parse_tmp_addr_local
      field: teleport.audit.tmp_addr_local
      target_field: teleport.audit.connection.local_address
      keep_original: false
      ignore_missing: true
      ignore_failure: true
  - remove:
      field: teleport.audit.tmp_addr_local
      ignore_missing: true
  - rename:
      field: teleport.audit.addr.local
      target_field: teleport.audit.connection.local_address.original
      ignore_missing: true
  - rename:
      field: teleport.audit.connection.local_address.domain
      target_field: server.ip
      ignore_missing: true
  - rename:
      field: teleport.audit.connection.local_address.port
      target_field: server.port
      ignore_missing: true

  # Extract data from addr.remote field.
  - dot_expander:
      path: teleport.audit
      field: addr.remote
  - script:
      tag: add_tmp_addr_remote
      lang: painless
      description: Adds the URI identifier to make uri_parts processor work
      if: ctx?.teleport?.audit?.addr?.remote != null
      source: |
        ctx.teleport.audit.tmp_addr_remote = "//" + ctx.teleport.audit.addr.remote;
  - uri_parts:
      tag: parse_tmp_addr_remote
      field: teleport.audit.tmp_addr_remote
      target_field: teleport.audit.connection.remote_address
      keep_original: false
      ignore_missing: true
      ignore_failure: true
  - remove:
      field: teleport.audit.tmp_addr_remote
      ignore_missing: true
  - rename:
      field: teleport.audit.addr.remote
      target_field: teleport.audit.connection.remote_address.original
      ignore_missing: true
  - rename:
      field: teleport.audit.connection.remote_address.domain
      target_field: client.ip
      ignore_missing: true
  - rename:
      field: teleport.audit.connection.remote_address.port
      target_field: client.port
      ignore_missing: true


  # ClientMetadata identifies the originating client for an event.
  # All of these fields are mapped to ECS fields.
  - rename:
      field: teleport.audit.user_agent
      target_field: user_agent
      ignore_missing: true
  - user_agent:
      field: user_agent
      ignore_missing: true

  # KubernetesClusterMetadata contains common metadata for kubernetes-related events.
  # See kubernetes.yml for field definitions.
  - rename:
      field: teleport.audit.kubernetes_cluster
      target_field: teleport.audit.kubernetes.cluster
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_users
      target_field: teleport.audit.kubernetes.users
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_groups
      target_field: teleport.audit.kubernetes.groups
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_labels
      target_field: teleport.audit.kubernetes.labels
      ignore_missing: true

  # KubernetesPodMetadata contains common metadata for kubernetes pod-related events.
  # See kubernetes_pod.yml for field definitions.
  - rename:
      field: teleport.audit.kubernetes_pod_name
      target_field: teleport.audit.kubernetes_pod.pod_name
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_pod_namespace
      target_field: teleport.audit.kubernetes_pod.pod_namespace
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_container_name
      target_field: teleport.audit.kubernetes_pod.container_name
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_container_image
      target_field: teleport.audit.kubernetes_pod.container_image
      ignore_missing: true
  - rename:
      field: teleport.audit.kubernetes_node_name
      target_field: teleport.audit.kubernetes_pod.node_name
      ignore_missing: true

  # SAMLIdPServiceProviderMetadata contains common metadata for SAML IdP service provider events.
  # See saml_idp_service_provider.yml for field definitions.
  -  rename:
       field: teleport.audit.service_provider_entity_id
       target_field: teleport.audit.saml_idp_service_provider.entity_id
       ignore_missing: true
  -  rename:
       field: teleport.audit.service_provider_shortcut
       target_field: teleport.audit.saml_idp_service_provider.shortcut
       ignore_missing: true
  -  rename:
       field: teleport.audit.attribute_mapping
       target_field: teleport.audit.saml_idp_service_provider.attribute_mapping
       ignore_missing: true

  # Okta related events metadata.
  # See okta.yml for field definitions.
  -  rename:
       field: teleport.audit.added
       target_field: teleport.audit.okta.resources_updated.added
       ignore_missing: true
  -  rename:
       field: teleport.audit.updated
       target_field: teleport.audit.okta.resources_updated.updated
       ignore_missing: true
  -  rename:
       field: teleport.audit.deleted
       target_field: teleport.audit.okta.resources_updated.deleted
       ignore_missing: true
  -  rename:
       field: teleport.audit.source
       target_field: teleport.audit.okta.assignment.source
       ignore_missing: true
  -  rename:
       field: teleport.audit.starting_status
       target_field: teleport.audit.okta.assignment.starting_status
       ignore_missing: true
  -  rename:
       field: teleport.audit.ending_status
       target_field: teleport.audit.okta.assignment.ending_status
       ignore_missing: true

  # AccessListMember, AccessListReviewMembershipRequirementsChanged, AccessListReviewMetadata,
  # LockMetadata, skipped.

  # Session related events metadata.
  # See session.yml for field definitions.
  -  rename:
       field: teleport.audit.size
       target_field: teleport.audit.session.terminal_size
       ignore_missing: true
  - grok:
      field: teleport.audit.session.terminal_size
      patterns:
        - "%{NUMBER:process.tty.columns}:%{NUMBER:process.tty.rows}"
      ignore_missing: true
      ignore_failure: true
  -  rename:
       field: teleport.audit.initial_command
       target_field: process.command_line
       ignore_missing: true
  -  rename:
       field: teleport.audit.session_recording
       target_field: teleport.audit.session.session_recording
       ignore_missing: true
  -  rename:
       field: teleport.audit.enhanced_recording
       target_field: teleport.audit.session.enhanced_recording
       ignore_missing: true
  -  rename:
       field: teleport.audit.interactive
       target_field: teleport.audit.session.interactive
       ignore_missing: true
  -  rename:
       field: teleport.audit.participants
       target_field: teleport.audit.session.participants
       ignore_missing: true
  -  rename:
       field: teleport.audit.session_start
       target_field: event.start
       ignore_missing: true
  -  rename:
       field: teleport.audit.session_stop
       target_field: event.end
       ignore_missing: true

  # Desktop events metadata
  # See desktop.yml for field definitions.
#  -  rename:
#       field: teleport.audit.message
#       target_field: teleport.audit.desktop.message
#       ignore_missing: true
#  -  rename:
#       field: teleport.audit.ms
#       target_field: teleport.audit.desktop.delay_milliseconds
#       ignore_missing: true
  -  rename:
       field: teleport.audit.length
       target_field: teleport.audit.desktop.length
       ignore_missing: true
  -  rename:
       field: teleport.audit.directory_name
       target_field: teleport.audit.desktop.directory_name
       ignore_missing: true
  -  rename:
       field: teleport.audit.directory_id
       target_field: teleport.audit.desktop.directory_id
       ignore_missing: true
  -  rename:
       field: teleport.audit.file_path
       target_field: teleport.audit.desktop.path
       ignore_missing: true
  -  rename:
       field: teleport.audit.offset
       target_field: teleport.audit.desktop.offset
       ignore_missing: true
  -  rename:
       field: teleport.audit.windows_desktop_service
       target_field: teleport.audit.desktop.windows_desktop_service
       ignore_missing: true
  - script:
      tag: add_tmp_desktop_addr
      lang: painless
      description: Adds the URI identifier to make uri_parts processor work
      if: ctx?.teleport?.audit?.desktop_addr != null
      source: |
        ctx.teleport.audit.tmp_desktop_addr = "//" + ctx.teleport.audit.desktop_addr;
  - uri_parts:
      tag: parse_tmp_desktop_addr
      field: teleport.audit.tmp_desktop_addr
      target_field: teleport.audit.desktop.address
      keep_original: false
      ignore_missing: true
      ignore_failure: true
  - remove:
      field: teleport.audit.tmp_desktop_addr
      ignore_missing: true
  - rename:
      field: teleport.audit.desktop_addr
      target_field: teleport.audit.desktop.address.original
      ignore_missing: true
  -  rename:
       field: teleport.audit.windows_domain
       target_field: teleport.audit.desktop.windows_domain
       ignore_missing: true
  -  rename:
       field: teleport.audit.windows_user
       target_field: teleport.audit.desktop.windows_user
       ignore_missing: true
  -  rename:
       field: teleport.audit.desktop_labels
       target_field: teleport.audit.desktop.labels
       ignore_missing: true
  -  rename:
       field: teleport.audit.desktop_name
       target_field: teleport.audit.desktop.desktop_name
       ignore_missing: true
  -  rename:
       field: teleport.audit.allow_user_creation
       target_field: teleport.audit.desktop.allow_user_creation
       ignore_missing: true
  
  # FileTransferRequestEvent happens when a FileTransferRequest is created, updated, approved, or denied.
  # See file_transfer_request.yml for field definitions.
  - rename:
      field: teleport.audit.requestID
      target_field: teleport.audit.file_transfer_request.request_id
      ignore_missing: true
  - rename:
      field: teleport.audit.approvers
      target_field: teleport.audit.file_transfer_request.approvers
      ignore_missing: true
  - rename:
      field: teleport.audit.requester
      target_field: teleport.audit.file_transfer_request.requester
      ignore_missing: true
  - rename:
      field: teleport.audit.location
      target_field: teleport.audit.file_transfer_request.location
      ignore_missing: true
  - rename:
      field: teleport.audit.download
      target_field: teleport.audit.file_transfer_request.is_download
      ignore_missing: true
  - rename:
      field: teleport.audit.filename
      target_field: teleport.audit.file_transfer_request.filename
      ignore_missing: true

  # Process metadata
  # See process.yml for field definitions.
  -  rename:
       field: teleport.audit.pid
       target_field: process.pid
       ignore_missing: true
  -  rename:
       field: teleport.audit.cgroup_id
       target_field: teleport.audit.process.cgroup_id
       ignore_missing: true
  -  rename:
       field: teleport.audit.program
       target_field: process.executable
       ignore_missing: true
  - append:
      field: event.outcome
      value:
        - success
      allow_duplicates: false
      if: ctx.teleport?.audit?.success == true
  - remove:
      field: teleport.audit.success
      if: ctx.teleport?.audit?.success == true
  - append:
      field: event.outcome
      value:
        - failure
      allow_duplicates: false
      if: ctx.teleport?.audit?.success == false
  - remove:
      field: teleport.audit.success
      if: ctx.teleport?.audit?.success == false
  -  rename:
       field: teleport.audit.error
       target_field: error.id
       ignore_missing: true
  -  rename:
       field: teleport.audit.message
       target_field: error.message
       ignore_missing: true
  -  rename:
       field: teleport.audit.ppid
       target_field: process.ppid
       ignore_missing: true
  -  rename:
       field: teleport.audit.path
       target_field: file.path
       ignore_missing: true
  -  rename:
       field: teleport.audit.argv
       target_field: process.args
       ignore_missing: true
  -  rename:
       field: teleport.audit.return_code
       target_field: process.exit_code
       ignore_missing: true
  -  rename:
       field: teleport.audit.flags
       target_field: teleport.audit.process.flags
       ignore_missing: true

  # Network metadata
  # See network.yml for field definitions.
  -  rename:
       field: teleport.audit.src_addr
       target_field: source.ip
       ignore_missing: true
  -  rename:
       field: teleport.audit.dst_addr
       target_field: destination.ip
       ignore_missing: true
  -  rename:
       field: teleport.audit.dst_port
       target_field: destination.port
       ignore_missing: true
  -  rename:
       field: teleport.audit.version
       target_field: teleport.audit.network.tcp_version
       ignore_missing: true
  -  set:
       field: teleport.audit.network.operation
       value: connect
       if: ctx?.teleport?.audit?.operation == 0
  -  set:
       field: teleport.audit.network.operation
       value: send
       if: ctx?.teleport?.audit?.operation == 1
  - remove:
      field: teleport.audit.operation
      ignore_missing: true
  -  set:
       field: teleport.audit.network.action
       value: observed
       if: ctx?.teleport?.audit?.action == 0
  -  set:
       field: teleport.audit.network.action
       value: denied
       if: ctx?.teleport?.audit?.action == 1
  - remove:
      field: teleport.audit.action
      ignore_missing: true
  -  rename:
       field: teleport.audit.tx
       target_field: teleport.audit.network.bytes_transmitted
       ignore_missing: true
  -  rename:
       field: teleport.audit.rx
       target_field: teleport.audit.network.bytes_received
       ignore_missing: true

  # Resource metadata
  # See resource.yml for field definitions.
  -  rename:
       field: teleport.audit.name
       target_field: teleport.audit.resource.name
       ignore_missing: true
  -  rename:
       field: teleport.audit.expires
       target_field: teleport.audit.resource.expires
       ignore_missing: true
  -  rename:
       field: teleport.audit.updated_by
       target_field: teleport.audit.resource.updated_by
       ignore_missing: true
  -  rename:
       field: teleport.audit.ttl
       target_field: teleport.audit.resource.ttl
       ignore_missing: true



  # DatabaseMetadata contains common database information.
  # See database.yml for field definitions.
  - rename:
      field: teleport.audit.db_service
      target_field: teleport.audit.database.service
      ignore_missing: true
  - rename:
      field: teleport.audit.db_protocol
      target_field: teleport.audit.database.protocol
      ignore_missing: true
  - rename:
      field: teleport.audit.db_uri
      target_field: teleport.audit.database.uri
      ignore_missing: true
  - rename:
      field: teleport.audit.db_name
      target_field: teleport.audit.database.name
      ignore_missing: true
  - rename:
      field: teleport.audit.db_user
      target_field: teleport.audit.database.user
      ignore_missing: true
  - rename:
      field: teleport.audit.db_labels
      target_field: teleport.audit.database.labels
      ignore_missing: true
  - rename:
      field: teleport.audit.db_aws_region
      target_field: teleport.audit.database.aws.region
      ignore_missing: true
  - rename:
      field: teleport.audit.db_aws_redshift_cluster_id
      target_field: teleport.audit.database.aws.redshift_cluster_id
      ignore_missing: true
  - rename:
      field: teleport.audit.db_gcp_project_id
      target_field: teleport.audit.database.gcp.project_id
      ignore_missing: true
  - rename:
      field: teleport.audit.db_gcp_instance_id
      target_field: teleport.audit.database.gcp.instance_id
      ignore_missing: true
  - rename:
      field: teleport.audit.db_type
      target_field: teleport.audit.database.type
      ignore_missing: true
  - rename:
      field: teleport.audit.db_origin
      target_field: teleport.audit.database.origin
      ignore_missing: true

on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}}
      in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
