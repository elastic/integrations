---
description: Pipeline for PFsense Unbound DNS logs
processors:
  - grok:
      tag: grok_message_88ceaee5
      field: message
      patterns:
        - '%{LOGLEVEL:log.level}: %{IP:source.address} %{HOSTNAME:_tmp.question.name}(\.) %{WORD:_tmp.question.type} %{WORD:_tmp.question.class}'
      on_failure:
        - drop:
            tag: drop_5ac9753c
            description: Drop if not a query log
  - append:
      tag: append_event_type_ac4d9a80
      field: event.type
      value: connection
      allow_duplicates: false
      if: ctx.source?.address != null
  - append:
      tag: append_event_type_6887ab9d
      field: event.type
      value: end
      allow_duplicates: false
      if: ctx.message.toLowerCase().contains('disconnected')
  - set:
      tag: set_network_protocol_96a840d1
      field: network.protocol
      value: dns
  - set:
      tag: set_dns_type_4812efdb
      field: dns.type
      value: question
      if: ctx._tmp?.question?.name != null
  - registered_domain:
      tag: registered_domain__tmp_question_name_to_dns_question_a89b448b
      field: _tmp.question.name
      target_field: dns.question
      ignore_missing: true
  - rename:
      tag: rename_dns_question_domain_to_dns_question_name_88a92ba9
      field: dns.question.domain
      target_field: dns.question.name
      ignore_missing: true
  - rename:
      tag: rename__tmp_question_type_to_dns_question_type_e2286aa7
      field: _tmp.question.type
      target_field: dns.question.type
      ignore_missing: true
  - rename:
      tag: rename__tmp_question_class_to_dns_question_class_e864f0db
      field: _tmp.question.class
      target_field: dns.question.class
      ignore_missing: true
  - convert:
      tag: convert_source_address_to_source_ip_f5632a20
      field: source.address
      target_field: source.ip
      type: ip
      ignore_failure: true
      ignore_missing: true
  - set:
      tag: set_client_721030b3
      field: client
      copy_from: source
      ignore_empty_value: true
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{#_ingest.on_failure_processor_tag}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{/_ingest.on_failure_processor_tag}}in pipeline '{{{ _ingest.pipeline }}}'
        failed with message '{{{ _ingest.on_failure_message }}}'
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
