---
description: Pipeline for PFsense OpenVPN logs
processors:
  - grok:
      tag: grok_message_52bb7c6e
      field: message
      patterns:
        - '%{SOURCE}%{SPACE}peer%{SPACE}info:%{SPACE}%{GREEDYDATA:pfsense.openvpn.peer_info}'
        - '%{SOURCE}%{SPACE}\[%{USERNAME:user.name}\]%{SPACE}%{GREEDYDATA}'
        - "user%{SPACE}'%{USERNAME:user.name}'%{GREEDYDATA}"
        - '%{USERNAME:user.name}/%{SOURCE}%{DATA}IPv4=(%{IP:source.nat.ip}|%{GREEDYDATA}),%{SPACE}IPv6=(%{IP:source.nat.ip}|%{GREEDYDATA})'
        - '%{GREEDYDATA}%{SOURCE}'
        - '%{GREEDYDATA}'
      pattern_definitions:
        SOURCE: '%{IP:source.address}:%{NONNEGINT:source.port:long}'
        USERNAME: '[a-zA-Z0-9._-]+'
  - append:
      tag: append_event_category_e7e9b076
      field: event.category
      value: authentication
      allow_duplicates: false
      if: ctx.message.contains('auth')
  - append:
      tag: append_event_type_ac4d9a80
      field: event.type
      value: connection
      allow_duplicates: false
      if: ctx.source?.address != null
  - append:
      tag: append_event_type_3f43a39d
      field: event.type
      value: info
      allow_duplicates: false
  - append:
      tag: append_event_outcome_42491fe9
      field: event.outcome
      value: failure
      allow_duplicates: false
      if: ctx.message.toLowerCase().contains('error') || ctx.message.toLowerCase().contains('not auth')
  - append:
      tag: append_event_type_6cc50f6b
      field: event.type
      value: start
      allow_duplicates: false
      if: ctx.message.toLowerCase().contains('initiat')
  - set:
      tag: set_source_ip_0313ebc9
      field: source.ip
      value: "{{{source.address}}}"
      ignore_empty_value: true
  - set:
      tag: set_network_protocol_1caba15c
      field: network.protocol
      value: openvpn
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{#_ingest.on_failure_processor_tag}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{/_ingest.on_failure_processor_tag}}in pipeline '{{{ _ingest.pipeline }}}'
        failed with message '{{{ _ingest.on_failure_message }}}'
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
