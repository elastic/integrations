---
description: Pipeline for PFsense Firewall logs
processors:
    - grok:
        tag: grok_message_518a3bd8
        field: message
        patterns:
        - "%{PF_LOG_ENTRY}%{GREEDYDATA}"
        pattern_definitions:
            PF_LOG_ENTRY: "%{PF_LOG_DATA}%{PF_IP_SPECIFIC_DATA}%{PF_IP_DATA}%{PF_PROTOCOL_DATA}?"
            PF_LOG_DATA: "%{INT},%{INT}?,,%{WORD:rule.id},%{DATA:observer.ingress.interface.name},%{PF_REASON:event.reason},%{WORD:event.action},%{WORD:network.direction},"
            PF_REASON: '[a-zA-Z-]+'
            PF_IP_DATA: "%{NONNEGINT:network.bytes:long},%{IP:source.address},%{IP:destination.address},"
            PF_IP_SPECIFIC_DATA: "%{PF_IPv4_SPECIFIC_DATA}|%{PF_IPv6_SPECIFIC_DATA}"
            PF_IPv4_SPECIFIC_DATA: "(?<network.type>(4)),%{BASE16NUM:pfsense.ip.tos},%{WORD:pfsense.ip.ecn}?,%{NONNEGINT:pfsense.ip.ttl:long},%{NONNEGINT:pfsense.ip.id:long},%{NONNEGINT:pfsense.ip.offset:long},(?:%{WORD:pfsense.ip.flags}|%{PF_SPEC:pfsense.ip.flags}),%{INT:network.iana_number},%{WORD:network.transport},"
            PF_IPv6_SPECIFIC_DATA: "(?<network.type>(6)),%{BASE16NUM:pfsense.ip.tos},%{WORD:pfsense.ip.flow_label},%{WORD:pfsense.ip.flags},%{PF_TRANSPORT:network.transport},%{INT:network.iana_number},"
            PF_PROTOCOL_DATA: "%{PF_TCP_DATA}|%{PF_UDP_DATA}|%{PF_ICMP_DATA}|%{PF_IGMP_DATA}|%{PF_IPv6_VAR}|%{PF_IPv6_ICMP}"
            PF_IPv6_VAR: "%{GREEDYDATA}"
            PF_IPv6_ICMP: ''
            PF_TCP_DATA: "%{INT:source.port:long},%{INT:destination.port:long},%{NONNEGINT:pfsense.tcp.length:long},%{WORD:pfsense.tcp.flags}?,%{NONNEGINT:pfsense.tcp.seq:long}?:?%{NONNEGINT},%{NONNEGINT:pfsense.tcp.ack:long}?,%{NONNEGINT:pfsense.tcp.window:long}?,%{WORD:pfsense.tcp.urg}?,%{GREEDYDATA:pfsense.tcp.options}"
            PF_UDP_DATA: "%{INT:source.port:long},%{INT:destination.port:long},%{NONNEGINT:pfsense.udp.length:long}$"
            PF_IGMP_DATA: "datalength=%{NONNEGINT:network.packets:long}"
            PF_ICMP_DATA: "%{PF_ICMP_TYPE}%{PF_ICMP_RESPONSE}"
            PF_ICMP_TYPE: "(?<pfsense.icmp.type>(request|reply|unreachproto|unreachport|unreach|timeexceed|paramprob|redirect|maskreply|needfrag|tstamp|tstampreply)),"
            PF_ICMP_RESPONSE: "%{PF_ICMP_ECHO_REQ_REPLY}|%{PF_ICMP_UNREACHPORT}|%{PF_ICMP_UNREACHPROTO}|%{PF_ICMP_UNREACHABLE}|%{PF_ICMP_NEED_FLAG}|%{PF_ICMP_TSTAMP}|%{PF_ICMP_TSTAMP_REPLY}"
            PF_ICMP_ECHO_REQ_REPLY: "%{NONNEGINT:pfsense.icmp.id:long},%{NONNEGINT:pfsense.icmp.seq:long}"
            PF_ICMP_UNREACHPORT: "\\[?%{IP:pfsense.icmp.destination.ip}\\]?,\\[?%{WORD:pfsense.icmp.unreachable.protocol_id}\\]?,\\[?%{NONNEGINT:pfsense.icmp.unreachable.port:long}\\]?"
            PF_ICMP_UNREACHPROTO: "\\[?%{IP:pfsense.icmp.destination.ip}\\]?,\\[?%{WORD:pfsense.icmp.unreachable.protocol_id}\\]?"
            PF_ICMP_UNREACHABLE: "%{GREEDYDATA:pfsense.icmp.unreachable.other}"
            PF_ICMP_NEED_FLAG: "%{IP:pfsense.icmp.destination.ip},%{NONNEGINT:pfsense.icmp.mtu:long}"
            PF_ICMP_TSTAMP: "%{INT:pfsense.icmp.id},%{INT:pfsense.icmp.seq}"
            PF_ICMP_TSTAMP_REPLY: "%{INT:pfsense.icmp.id},%{INT:pfsense.icmp.seq},%{INT:pfsense.icmp.otime},%{INT:pfsense.icmp.rtime},%{INT:pfsense.icmp.ttime}"
            PF_SPEC: "[+]"
            PF_TRANSPORT: "[0-9a-zA-Z-]+"
    - set:
        tag: set_event_kind_de80643c
        field: event.kind
        value: event
    - append:
        tag: append_event_type_6c6f283d
        field: event.type
        value: connection
        allow_duplicates: false
        if: ctx.source?.address != null && ctx.destination?.address != null
    - append:
        tag: append_event_type_fcaacaaf
        field: event.type
        value: denied
        allow_duplicates: false
        if: ctx.event.action == 'block'
    - append:
        tag: append_event_type_77f1e2f8
        field: event.type
        value: allowed
        allow_duplicates: false
        if: ctx.event.action == 'pass'
    - lowercase:
        tag: lowercase_network_transport_bc8c1c12
        field: network.transport
        ignore_missing: true
    - remove:
        tag: remove_ack_number_9a55d0f3
        field: ack_number
        ignore_missing: true
        if: ctx.ack_number == null || ctx.ack_number == ''
    - network_direction:
        tag: network_direction_6d15af04
        internal_networks_field: _tmp.internal_networks
    - split:
        tag: split_pfsense_tcp_options_a6459ab2
        field: pfsense.tcp.options
        separator: ';'
        ignore_missing: true
        ignore_failure: true
    - date:
        tag: date_pfsense_icmp_otime_a8122a08
        field: pfsense.icmp.otime
        ignore_failure: true
        formats:
            - UNIX
            - UNIX_MS
    - date:
        tag: date_pfsense_icmp_rtime_6f2f5bb7
        field: pfsense.icmp.rtime
        ignore_failure: true
        formats:
            - UNIX
            - UNIX_MS
    - date:
        tag: date_pfsense_icmp_ttime_c5011051
        field: pfsense.icmp.ttime
        ignore_failure: true
        formats:
            - UNIX
            - UNIX_MS
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{#_ingest.on_failure_processor_tag}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{/_ingest.on_failure_processor_tag}}in pipeline '{{{ _ingest.pipeline }}}'
        failed with message '{{{ _ingest.on_failure_message }}}'
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
