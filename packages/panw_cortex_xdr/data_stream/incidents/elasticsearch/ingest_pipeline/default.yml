---
description: Pipeline for Palo Alto XDR Incident API.
processors:
  - set:
      field: ecs.version
      value: '8.9.0'
  - set:
      field: event.kind
      value: alert
  - append:
      field: event.category
      value: malware
  - append:
      field: event.type
      value: info
  - rename:
      field: message
      target_field: event.original
  - json:
      field: event.original
      target_field: panw_cortex.xdr
  - drop:
      if: ctx.panw_cortex?.xdr?.reply?.result_count != null && ctx.panw_cortex?.xdr?.reply?.result_count == 0
  - fingerprint:
      fields:
        - panw_cortex.xdr.alert_count
        - panw_cortex.xdr.incident_id
      target_field: "_id"
      ignore_missing: true
  - script:
      description: Drops null/empty values recursively
      lang: painless
      source: |
        boolean drop(Object o) {
          if (o == null || o == "") {
            return true;
          } else if (o instanceof Map) {
            ((Map) o).values().removeIf(v -> drop(v));
            return (((Map) o).size() == 0);
          } else if (o instanceof List) {
            ((List) o).removeIf(v -> drop(v));
            return (((List) o).length == 0);
          }
          return false;
        }
        drop(ctx);
  - date:
      field: panw_cortex.xdr.creation_time
      formats:
        - UNIX_MS
      if: ctx.panw_cortex?.xdr?.creation_time != null
  - date:
      field: panw_cortex.xdr.modification_time
      formats:
        - UNIX_MS
      if: ctx.panw_cortex?.xdr?.modification_time != null
  - rename:
      field: panw_cortex.xdr.name
      target_field: message
      ignore_missing: true
  - set:
      field: event.severity
      value: 0
      if: ctx.panw_cortex?.xdr?.severity == "unknown"
  - set:
      field: event.severity
      value: 1
      if: ctx.panw_cortex?.xdr?.severity == "informational"
  - set:
      field: event.severity
      value: 2
      if: ctx.panw_cortex?.xdr?.severity == "low"
  - set:
      field: event.severity
      value: 3
      if: ctx.panw_cortex?.xdr?.severity == "medium"
  - set:
      field: event.severity
      value: 4
      if: ctx.panw_cortex?.xdr?.severity == "high"
  - rename:
      field: panw_cortex.xdr.incident_id
      target_field: event.id
      ignore_missing: true
  - rename:
      field: panw_cortex.xdr.description
      target_field: event.reason
      ignore_missing: true
      if: "ctx.panw_cortex?.xdr?.description != null && ctx.panw_cortex.xdr.description instanceof String"
  #---------------------------------------------
  - rename:
      field: panw_cortex.xdr.agent_device_domain
      target_field: host.domain
      ignore_missing: true
  - rename:
      field: panw_cortex.xdr.agent_fqdn
      target_field: host.hostname
      ignore_missing: true
  - rename:
      field: panw_cortex.xdr.host_name
      target_field: host.hostname
      ignore_missing: true
      if: ctx.host?.hostname == null
  - lowercase:
      target_field: host.name
      field: host.hostname
      if: ctx.host?.hostname != null
  - rename:
      field: panw_cortex.xdr.endpoint_id
      target_field: host.id
      ignore_missing: true
  - split:
      field: panw_cortex.xdr.mac
      target_field: host.mac
      separator: ","
      ignore_missing: true
      if: ctx.host?.mac == null
  - remove:
      field:
        - panw_cortex.xdr.mac
      ignore_missing: true
      if: ctx.host?.mac != null
  - script:
      if: ctx.panw_cortex?.xdr?.mitre_techniques_ids_and_names != null
      lang: painless
      description: "Extract Mitre Techniques and append it to Threat ECS fields"
      source: |-
        void addTechnique(def ctx, def x, def y) {
          if (ctx?.threat == null) {
            ctx.threat = new HashMap();
          }
          if (ctx?.threat.technique == null) {
            ctx.threat.technique = new HashMap();
          }
          if (ctx?.threat.technique.id == null) {
            ctx.threat.technique.id = new ArrayList();
          }
          if (ctx?.threat.technique.name == null) {
            ctx.threat.technique.name = new ArrayList();
          }
          if (!ctx.threat?.technique?.id.contains(x)) {
            ctx.threat.technique.id.add(x);
          }
          if (!ctx.threat?.technique?.name.contains(y)) {
            ctx.threat.technique.name.add(y);
          }
        }
        for (mitre_technique in ctx.panw_cortex?.xdr?.mitre_techniques_ids_and_names) {
          addTechnique(ctx, mitre_technique.splitOnToken(' - ')[0], mitre_technique.splitOnToken(' - ')[1]);
        }
  - script:
      if: ctx.panw_cortex?.xdr?.mitre_tactics_ids_and_names != null
      lang: painless
      description: "Extract Mitre Tactics and append it to Threat ECS fields"
      source: |-
        void addTactic(def ctx, def x, def y) {
          if (ctx?.threat == null) {
          ctx.threat = new HashMap();
          }
          if (ctx?.threat.tactic == null) {
          ctx.threat.tactic = new HashMap();
          }
          if (ctx?.threat.tactic.id == null) {
          ctx.threat.tactic.id = new ArrayList();
          }
          if (ctx?.threat.tactic.name == null) {
          ctx.threat.tactic.name = new ArrayList();
          }
          if (!ctx.threat?.tactic?.id.contains(x)) {
          ctx.threat.tactic.id.add(x);
          }
          if (!ctx.threat?.tactic?.name.contains(y)) {
          ctx.threat.tactic.name.add(y);
          }
        }
        for (mitre_tactic in ctx.panw_cortex?.xdr?.mitre_tactics_ids_and_names) {
            addTactic(ctx, mitre_tactic.splitOnToken(' - ')[0], mitre_tactic.splitOnToken(' - ')[1]);
        }
  - set:
      field: threat.framework
      value: "MITRE ATT&CK"
      if: "ctx.threat?.technique != null || ctx.threat?.tactic != null"

  
  - append:
      field: related.hash
      value: "{{{process.parent.hash.md5}}}"
      allow_duplicates: false
      if: ctx.process?.parent?.hash?.md5 != null
  - append:
      field: related.hash
      value: "{{{process.parent.hash.sha256}}}"
      allow_duplicates: false
      if: ctx.process?.parent?.hash?.sha256 != null
  - append:
      field: related.hash
      value: "{{{process.hash.md5}}}"
      allow_duplicates: false
      if: ctx.process?.hash?.md5 != null
  - append:
      field: related.hash
      value: "{{{process.hash.sha256}}}"
      allow_duplicates: false
      if: ctx.process?.hash?.sha256 != null
  - append:
      field: related.hash
      value: "{{{file.hash.sha256}}}"
      allow_duplicates: false
      if: ctx.file?.hash?.sha256 != null
  - append:
      field: related.hash
      value: "{{{file.hash.md5}}}"
      allow_duplicates: false
      if: ctx.file?.hash?.md5 != null
  - append:
      field: related.user
      value: "{{{user.name}}}"
      allow_duplicates: false
      if: ctx.user?.name != null
  - foreach:
      field: panw_cortex.xdr.tags
      if: ctx.panw_cortex?.xdr?.tags != null
      processor: 
        append:
          field: tags
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
      
  - remove:
      field:
        - panw_cortex.xdr.host_name
        - panw_cortex.xdr.severity
        - panw_cortex.xdr.tags
        - panw_cortex.xdr.mitre_techniques_id_and_names
        - panw_cortex.xdr.mitre_tactics_id_and_names
      ignore_missing: true
  - remove:
      field: event.original
      if: "ctx?.tags == null || !(ctx.tags.contains('preserve_original_event'))"
      ignore_failure: true
      ignore_missing: true
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: '{{{ _ingest.on_failure_message }}}'
