---
description: Pipeline for processing Trend Micro Vision One Alert logs.
processors:
  - set:
      field: ecs.version
      value: '8.11.0'
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - set:
      field: event.kind
      value: event
  - set:
      field: event.category
      value: [intrusion_detection]
  - set:
      field: event.type
      value: [info]
  - json:
      field: event.original
      target_field: json
      ignore_failure: true
  - drop:
      if: ctx.json?.items != null && ctx.json.items.isEmpty()
  - fingerprint:
      fields:
        - json.eventTime
        - json.rt_utc
        - json.uuid
        - json.request
        - json.requests
      target_field: _id
      ignore_missing: true
  - date:
      field: json.eventTime
      if: ctx.json?.eventTime != null && ctx.json.eventTime != ''
      formats:
        - UNIX_MS
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.domainName
      target_field: trend_micro_vision_one.detection.domain.name
      ignore_missing: true
  - set:
      field: destination.domain
      copy_from: trend_micro_vision_one.detection.domain.name
      ignore_failure: true
  - convert:
      field: json.dst
      target_field: trend_micro_vision_one.detection.destination.ip
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: destination.ip
      copy_from: trend_micro_vision_one.detection.destination.ip
      ignore_failure: true
  - convert:
      field: json.dpt
      target_field: trend_micro_vision_one.detection.destination.port
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: destination.port
      copy_from: trend_micro_vision_one.detection.destination.port
      ignore_failure: true
  - rename:
      field: json.act
      target_field: trend_micro_vision_one.detection.action
      ignore_missing: true
  - set:
      field: event.action
      copy_from: trend_micro_vision_one.detection.action
      ignore_failure: true
  - lowercase:
      field: event.action
      ignore_missing: true
  - rename:
      field: json.eventId
      target_field: trend_micro_vision_one.detection.event_id
      ignore_missing: true
  - set:
      field: event.id
      copy_from: trend_micro_vision_one.detection.event_id
      ignore_failure: true
  - rename:
      field: json.objectFileHashMd5
      target_field: trend_micro_vision_one.detection.object.file.hash.md5
      ignore_missing: true
  - set:
      field: file.hash.md5
      copy_from: trend_micro_vision_one.detection.object.file.hash.md5
      ignore_failure: true
  - rename:
      field: json.objectFileHashSha1
      target_field: trend_micro_vision_one.detection.object.file.hash.sha1
      ignore_missing: true
  - set:
      field: file.hash.sha1
      copy_from: trend_micro_vision_one.detection.object.file.hash.sha1
      ignore_failure: true
  - rename:
      field: json.objectFileHashSha256
      target_field: trend_micro_vision_one.detection.object.file.hash.sha256
      ignore_missing: true
  - set:
      field: file.hash.sha256
      copy_from: trend_micro_vision_one.detection.object.file.hash.sha256
      ignore_failure: true
  - rename:
      field: json.fileName
      target_field: trend_micro_vision_one.detection.file_name
      ignore_missing: true
  - set:
      field: file.name
      copy_from: trend_micro_vision_one.detection.file_name
      ignore_failure: true
  - rename:
      field: json.filePathName
      target_field: trend_micro_vision_one.detection.file_path_name
      ignore_missing: true
  - set:
      field: file.path
      copy_from: trend_micro_vision_one.detection.file_path_name
      ignore_failure: true
  - convert:
      field: json.fileSize
      target_field: trend_micro_vision_one.detection.file_size
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: file.size
      copy_from: trend_micro_vision_one.detection.file_size
      ignore_failure: true
  - rename:
      field: json.hostName
      target_field: trend_micro_vision_one.detection.hostname
      ignore_missing: true
  - set:
      field: host.hostname
      copy_from: trend_micro_vision_one.detection.hostname
      ignore_failure: true
  - rename:
      field: json.endpointGUID
      target_field: trend_micro_vision_one.detection.endpoint.guid
      ignore_missing: true
  - set:
      field: host.id
      copy_from: trend_micro_vision_one.detection.endpoint.guid
      ignore_failure: true
  - foreach:
      field: json.endpointIp
      processor:
        append:
          field: trend_micro_vision_one.detection.endpoint.ip
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
          ignore_failure: true
      ignore_missing: true
      ignore_failure: true
  - set:
      field: host.ip
      copy_from: trend_micro_vision_one.detection.endpoint.ip
      ignore_failure: true
  - gsub:
      field: json.endpointMacAddress
      pattern: '[-:.]'
      replacement: '-'
      ignore_missing: true
  - uppercase:
      field: json.endpointMacAddress
      ignore_missing: true
  - rename:
      field: json.endpointMacAddress
      target_field: trend_micro_vision_one.detection.endpoint.mac
      ignore_missing: true
  - append:
      field: host.mac
      value: '{{{trend_micro_vision_one.detection.endpoint.mac}}}'
      if: ctx.trend_micro_vision_one?.detection?.endpoint?.mac != null
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: json.endpointHostName
      target_field: trend_micro_vision_one.detection.endpoint.hostname
      ignore_missing: true
  - set:
      field: host.name
      copy_from: trend_micro_vision_one.detection.endpoint.hostname
      ignore_failure: true
  - rename:
      field: json.httpReferer
      target_field: trend_micro_vision_one.detection.http_referer
      ignore_missing: true
  - set:
      field: http.request.referrer
      copy_from: trend_micro_vision_one.detection.http_referer
      ignore_failure: true
  - rename:
      field: json.cat
      target_field: trend_micro_vision_one.detection.severity_level
      ignore_missing: true
  - set:
      field: event.severity
      copy_from: trend_micro_vision_one.detection.severity_level
      ignore_failure: true
  - rename:
      field: json.deviceDirection
      target_field: trend_micro_vision_one.detection.device.direction
      ignore_missing: true
  - set:
      field: network.direction
      copy_from: trend_micro_vision_one.detection.device.direction
      ignore_failure: true
  - lowercase:
      field: network.direction
      ignore_missing: true
  - rename:
      field: json.app
      target_field: trend_micro_vision_one.detection.protocol
      ignore_missing: true
  - set:
      field: network.protocol
      copy_from: trend_micro_vision_one.detection.protocol
      ignore_failure: true
  - lowercase:
      field: network.protocol
      ignore_missing: true
  - rename:
      field: json.dhost
      target_field: trend_micro_vision_one.detection.device.host
      ignore_missing: true
  - set:
      field: observer.hostname
      copy_from: trend_micro_vision_one.detection.device.host
      ignore_failure: true
  - gsub:
      field: json.deviceMacAddress
      pattern: '[-:.]'
      replacement: '-'
      ignore_missing: true
  - uppercase:
      field: json.deviceMacAddress
      ignore_missing: true
  - rename:
      field: json.deviceMacAddress
      target_field: trend_micro_vision_one.detection.device.mac
      ignore_missing: true
  - append:
      field: observer.mac
      value: '{{{trend_micro_vision_one.detection.device.mac}}}'
      if: ctx.trend_micro_vision_one?.detection?.device?.mac != null
  - rename:
      field: json.processCmd
      target_field: trend_micro_vision_one.detection.process.cmd
      ignore_missing: true
  - set:
      field: process.command_line
      copy_from: trend_micro_vision_one.detection.process.cmd
      ignore_failure: true
  - rename:
      field: json.processName
      target_field: trend_micro_vision_one.detection.process.name
      ignore_missing: true
  - set:
      field: process.name
      copy_from: trend_micro_vision_one.detection.process.name
      ignore_failure: true
  - convert:
      field: json.processPid
      target_field: trend_micro_vision_one.detection.process.pid
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: process.pid
      copy_from: trend_micro_vision_one.detection.process.pid
      ignore_failure: true
  - convert:
      field: json.src
      target_field: trend_micro_vision_one.detection.source.ip
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: source.ip
      copy_from: trend_micro_vision_one.detection.source.ip
      ignore_failure: true
  - convert:
      field: json.spt
      target_field: trend_micro_vision_one.detection.source.port
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: source.port
      copy_from: trend_micro_vision_one.detection.source.port
      ignore_failure: true
  - rename:
      field: json.tacticId
      target_field: trend_micro_vision_one.detection.tactic_id
      ignore_missing: true
  - set:
      field: threat.tactic.id
      copy_from: trend_micro_vision_one.detection.tactic_id
      ignore_failure: true
  - rename:
      field: json.requestClientApplication
      target_field: trend_micro_vision_one.detection.request_client_application
      ignore_missing: true
  - set:
      field: url.request
      copy_from: trend_micro_vision_one.detection.request_client_application
      ignore_failure: true
  - user_agent:
      field: url.request
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.actResult
      target_field: trend_micro_vision_one.detection.action_result
      ignore_missing: true
  - rename:
      field: json.behaviorCat
      target_field: trend_micro_vision_one.detection.behavior_category
      ignore_missing: true
  - rename:
      field: json.blocking
      target_field: trend_micro_vision_one.detection.block
      ignore_missing: true
  - rename:
      field: json.clientFlag
      target_field: trend_micro_vision_one.detection.client_flag
      ignore_missing: true
  - rename:
      field: json.component
      target_field: trend_micro_vision_one.detection.component_version
      ignore_missing: true
  - convert:
      field: json.compressedFileSize
      target_field: trend_micro_vision_one.detection.compressed_file_size
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.dstGroup
      target_field: trend_micro_vision_one.detection.destination.ip_group
      ignore_missing: true
  - rename:
      field: json.cccaDetection
      target_field: trend_micro_vision_one.detection.detection
      ignore_missing: true
  - rename:
      field: json.cccaDetectionSource
      target_field: trend_micro_vision_one.detection.detection_source
      ignore_missing: true
  - rename:
      field: json.detectionType
      target_field: trend_micro_vision_one.detection.detection_type
      ignore_missing: true
  - convert:
      field: json.cccaRiskLevel
      target_field: trend_micro_vision_one.detection.risk_level
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.mDeviceGUID
      target_field: trend_micro_vision_one.detection.device.guid
      ignore_missing: true
  - rename:
      field: json.deviceGUID
      target_field: trend_micro_vision_one.detection.device.id
      ignore_missing: true
  - convert:
      field: json.mDevice
      target_field: trend_micro_vision_one.detection.device.ip
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.deviceProcessName
      target_field: trend_micro_vision_one.detection.device.process_name
      ignore_missing: true
  - date:
      field: json.end
      target_field: trend_micro_vision_one.detection.end_time
      if: ctx.json?.end != null && ctx.json.end != ''
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.engType
      target_field: trend_micro_vision_one.detection.engine_type
      ignore_missing: true
  - rename:
      field: json.engVer
      target_field: trend_micro_vision_one.detection.engine_version
      ignore_missing: true
  - rename:
      field: json.eventName
      target_field: trend_micro_vision_one.detection.event_name
      ignore_missing: true
  - date:
      field: json.eventTimeDT
      target_field: trend_micro_vision_one.detection.event_time_dt
      if: ctx.json?.eventTimeDT != null && ctx.json.eventTimeDT != ''
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.fileHash
      target_field: trend_micro_vision_one.detection.file_hash
      ignore_missing: true
  - rename:
      field: json.fileOperation
      target_field: trend_micro_vision_one.detection.file_operation
      ignore_missing: true
  - rename:
      field: json.filePath
      target_field: trend_micro_vision_one.detection.file_path
      ignore_missing: true
  - rename:
      field: json.firstAct
      target_field: trend_micro_vision_one.detection.first_action
      ignore_missing: true
  - rename:
      field: json.firstActResult
      target_field: trend_micro_vision_one.detection.first_action_result
      ignore_missing: true
  - rename:
      field: json.fullPath
      target_field: trend_micro_vision_one.detection.full_path
      ignore_missing: true
  - rename:
      field: json.interestedHost
      target_field: trend_micro_vision_one.detection.interested.host
      ignore_missing: true
  - convert:
      field: json.interestedIp
      target_field: trend_micro_vision_one.detection.interested.ip
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - gsub:
      field: json.interestedMacAddress
      pattern: '[-:.]'
      replacement: '-'
      ignore_missing: true
  - uppercase:
      field: json.interestedMacAddress
      ignore_missing: true
  - rename:
      field: json.interestedMacAddress
      target_field: trend_micro_vision_one.detection.interested.mac
      ignore_missing: true
  - rename:
      field: json.malName
      target_field: trend_micro_vision_one.detection.malware_name
      ignore_missing: true
  - rename:
      field: json.malType
      target_field: trend_micro_vision_one.detection.malware_type
      ignore_missing: true
  - rename:
      field: json.objectCmd
      target_field: trend_micro_vision_one.detection.object.cmd
      ignore_missing: true
  - rename:
      field: json.objectFileName
      target_field: trend_micro_vision_one.detection.object.file.name
      ignore_missing: true
  - rename:
      field: json.objectFilePath
      target_field: trend_micro_vision_one.detection.object.file.path
      ignore_missing: true
  - rename:
      field: json.objectName
      target_field: trend_micro_vision_one.detection.object.name
      ignore_missing: true
  - convert:
      field: json.objectPid
      target_field: trend_micro_vision_one.detection.object.pid
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.objectSigner
      target_field: trend_micro_vision_one.detection.object.signer
      ignore_missing: true
  - rename:
      field: json.parentCmd
      target_field: trend_micro_vision_one.detection.parent.cmd
      ignore_missing: true
  - rename:
      field: json.parentFileHashSha1
      target_field: trend_micro_vision_one.detection.parent.file.hash.sha1
      ignore_missing: true
  - rename:
      field: json.parentFileHashSha256
      target_field: trend_micro_vision_one.detection.parent.file.hash.sha256
      ignore_missing: true
  - rename:
      field: json.parentFilePath
      target_field: trend_micro_vision_one.detection.parent.file.path
      ignore_missing: true
  - rename:
      field: json.peerHost
      target_field: trend_micro_vision_one.detection.peer.host
      ignore_missing: true
  - convert:
      field: json.peerIp
      target_field: trend_micro_vision_one.detection.peer.ip
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.processFileHashMd5
      target_field: trend_micro_vision_one.detection.process.file.hash.md5
      ignore_missing: true
  - rename:
      field: json.processFileHashSha1
      target_field: trend_micro_vision_one.detection.process.file.hash.sha1
      ignore_missing: true
  - rename:
      field: json.processFileHashSha256
      target_field: trend_micro_vision_one.detection.process.file.hash.sha256
      ignore_missing: true
  - rename:
      field: json.processFilePath
      target_field: trend_micro_vision_one.detection.process.file.path
      ignore_missing: true
  - rename:
      field: json.processSigner
      target_field: trend_micro_vision_one.detection.process.signer
      ignore_missing: true
  - rename:
      field: json.request
      target_field: trend_micro_vision_one.detection.request
      ignore_missing: true
  - rename:
      field: json.requests
      target_field: trend_micro_vision_one.detection.request
      ignore_missing: true
      on_failure:
        - rename:
            field: json.requests
            target_field: trend_micro_vision_one.detection.requests
            ignore_missing: true
        - append:
            field: error.message
            value: 'request string and requests array both present in same document'
  - uri_parts:
      field: trend_micro_vision_one.detection.request
      if: ctx.trend_micro_vision_one?.detection?.request != null
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.productCode
      target_field: trend_micro_vision_one.detection.product.code
      ignore_missing: true
  - rename:
      field: json.mpname
      target_field: trend_micro_vision_one.detection.mproduct.name
      ignore_missing: true
  - rename:
      field: json.pname
      target_field: trend_micro_vision_one.detection.product.name
      ignore_missing: true
  - rename:
      field: json.mpver
      target_field: trend_micro_vision_one.detection.mproduct.version
      ignore_missing: true
  - rename:
      field: json.pver
      target_field: trend_micro_vision_one.detection.product.version
      ignore_missing: true
  - rename:
      field: json.appGroup
      target_field: trend_micro_vision_one.detection.protocol_group
      ignore_missing: true
  - set:
      field: trend_micro_vision_one.detection.related_apt
      value: false
      if: ctx.json?.aptRelated == '0';
  - set:
      field: trend_micro_vision_one.detection.related_apt
      value: true
      if: ctx.json?.aptRelated == '1';
  - date:
      field: json.rt
      target_field: trend_micro_vision_one.detection.rt
      if: ctx.json?.rt != null && ctx.json.rt != ''
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - date:
      field: json.rt_utc
      target_field: trend_micro_vision_one.detection.rt_utc
      if: ctx.json?.rt_utc != null && ctx.json.rt_utc != ''
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.searchDL
      target_field: trend_micro_vision_one.detection.search_data_lake
      ignore_missing: true
  - rename:
      field: json.mitreMapping
      target_field: trend_micro_vision_one.detection.security_analytics.engine.name
      ignore_missing: true
  - rename:
      field: json.mitreVersion
      target_field: trend_micro_vision_one.detection.security_analytics.engine.version
      ignore_missing: true
  - rename:
      field: json.srcGroup
      target_field: trend_micro_vision_one.detection.source.group
      ignore_missing: true
  - rename:
      field: json.threatName
      target_field: trend_micro_vision_one.detection.threat_name
      ignore_missing: true
  - rename:
      field: json.eventSubName
      target_field: trend_micro_vision_one.detection.sub_name
      ignore_missing: true
  - rename:
      field: json.tags
      target_field: trend_micro_vision_one.detection.tags
      ignore_missing: true
  - convert:
      field: json.cnt
      target_field: trend_micro_vision_one.detection.total_count
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.uuid
      target_field: trend_micro_vision_one.detection.uuid
      ignore_missing: true
  - convert:
      field: json.aggregatedCount
      target_field: trend_micro_vision_one.detection.aggregated_count
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      field: json.fileType
      target_field: trend_micro_vision_one.detection.file_type
      ignore_missing: true
  - set:
      field: file.type
      copy_from: trend_micro_vision_one.detection.file_type
      ignore_failure: true
  - rename:
      field: json.fileType
      target_field: trend_micro_vision_one.detection.file_type
      ignore_missing: true
  - set:
      field: file.type
      copy_from: trend_micro_vision_one.detection.file_type
      ignore_failure: true
  - rename:
      field: json.osName
      target_field: trend_micro_vision_one.detection.os.name
      ignore_missing: true
  - set:
      field: host.os.name
      copy_from: trend_micro_vision_one.detection.os.name
      ignore_failure: true
  - rename:
      field: json.policyName
      target_field: trend_micro_vision_one.detection.policy.name
      ignore_missing: true
  - rename:
      field: json.requestBase
      target_field: trend_micro_vision_one.detection.request_base
      ignore_missing: true
  - rename:
      field: json.suid
      target_field: trend_micro_vision_one.detection.suid
      ignore_missing: true
  - rename:
      field: json.urlCat
      target_field: trend_micro_vision_one.detection.url_cat
      ignore_missing: true
  - rename:
      field: json.userDomain
      target_field: trend_micro_vision_one.detection.user.domain
      ignore_missing: true
  - set:
      field: user.domain
      copy_from: trend_micro_vision_one.detection.user.domain
      ignore_failure: true
  - rename:
      field: json.profile
      target_field: trend_micro_vision_one.detection.profile
      ignore_missing: true
  - rename:
      field: json.principalName
      target_field: trend_micro_vision_one.detection.principal_name
      ignore_missing: true
  - rename:
      field: json.policyUuid
      target_field: trend_micro_vision_one.detection.policy.uuid
      ignore_missing: true
  - rename:
      field: json.sender
      target_field: trend_micro_vision_one.detection.sender
      ignore_missing: true
  - rename:
      field: json.logKey
      target_field: trend_micro_vision_one.detection.policy.logkey
      ignore_missing: true
  - rename:
      field: json.mimeType
      target_field: trend_micro_vision_one.detection.mime_type
      ignore_missing: true
  - convert:
      field: json.clientIp
      target_field: trend_micro_vision_one.detection.client_ip
      type: ip
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      field: client.ip
      copy_from: trend_micro_vision_one.detection.client_ip
      ignore_failure: true
  - remove:
      field: json
      ignore_missing: true
  - append:
      field: related.hash
      value: '{{{file.hash.md5}}}'
      if: ctx.file?.hash?.md5 != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hash
      value: '{{{file.hash.sha1}}}'
      if: ctx.file?.hash?.sha1 != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hash
      value: '{{{file.hash.sha256}}}'
      if: ctx.file?.hash?.sha256 != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hash
      value: '{{{trend_micro_vision_one.detection.file_hash}}}'
      if: ctx.trend_micro_vision_one?.detection?.file_hash != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hash
      value: '{{{trend_micro_vision_one.detection.parent.file.hash.sha1}}}'
      if: ctx.trend_micro_vision_one?.detection?.parent?.file?.hash?.sha1 != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hash
      value: '{{{trend_micro_vision_one.detection.parent.file.hash.sha256}}}'
      if: ctx.trend_micro_vision_one?.detection?.parent?.file?.hash?.sha256 != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hash
      value: '{{{trend_micro_vision_one.detection.process.file.hash.md5}}}'
      if: ctx.trend_micro_vision_one?.detection?.process?.file?.hash?.md5 != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hash
      value: '{{{trend_micro_vision_one.detection.process.file.hash.sha1}}}'
      if: ctx.trend_micro_vision_one?.detection?.process?.file?.hash?.sha1 != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hash
      value: '{{{trend_micro_vision_one.detection.process.file.hash.sha256}}}'
      if: ctx.trend_micro_vision_one?.detection?.process?.file?.hash?.sha256 != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hosts
      value: '{{{host.hostname}}}'
      if: ctx.host?.hostname != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hosts
      value: '{{{host.name}}}'
      if: ctx.host?.name != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.hosts
      value: '{{{observer.hostname}}}'
      if: ctx.observer?.hostname != null
      allow_duplicates: false
      ignore_failure: true
  - foreach:
      field: destination.ip
      processor:
        append:
          field: related.ip
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
          ignore_failure: true
      ignore_missing: true
      ignore_failure: true
  - foreach:
      field: source.ip
      processor:
        append:
          field: related.ip
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
          ignore_failure: true
      ignore_missing: true
      ignore_failure: true
  - foreach:
      field: trend_micro_vision_one.detection.device.ip
      processor:
        append:
          field: related.ip
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
          ignore_failure: true
      ignore_missing: true
      ignore_failure: true
  - foreach:
      field: trend_micro_vision_one.detection.interested.ip
      processor:
        append:
          field: related.ip
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
          ignore_failure: true
      ignore_missing: true
      ignore_failure: true
  - foreach:
      field: trend_micro_vision_one.detection.peer.ip
      processor:
        append:
          field: related.ip
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
          ignore_failure: true
      ignore_missing: true
      ignore_failure: true
  - foreach:
      field: client.ip
      processor:
        append:
          field: related.ip
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
          ignore_failure: true
      ignore_missing: true
      ignore_failure: true
  - remove:
      field:
        - trend_micro_vision_one.detection.domain.name
        - trend_micro_vision_one.detection.destination.ip
        - trend_micro_vision_one.detection.destination.port
        - trend_micro_vision_one.detection.action
        - trend_micro_vision_one.detection.event_id
        - trend_micro_vision_one.detection.object.file.hash.md5
        - trend_micro_vision_one.detection.object.file.hash.sha1
        - trend_micro_vision_one.detection.object.file.hash.sha256
        - trend_micro_vision_one.detection.file_name
        - trend_micro_vision_one.detection.file_path_name
        - trend_micro_vision_one.detection.file_size
        - trend_micro_vision_one.detection.hostname
        - trend_micro_vision_one.detection.endpoint.guid
        - trend_micro_vision_one.detection.endpoint.ip
        - trend_micro_vision_one.detection.endpoint.mac
        - trend_micro_vision_one.detection.endpoint.hostname
        - trend_micro_vision_one.detection.http_referer
        - trend_micro_vision_one.detection.severity_level
        - trend_micro_vision_one.detection.device.direction
        - trend_micro_vision_one.detection.protocol
        - trend_micro_vision_one.detection.device.host
        - trend_micro_vision_one.detection.device.mac
        - trend_micro_vision_one.detection.process.cmd
        - trend_micro_vision_one.detection.process.name
        - trend_micro_vision_one.detection.process.pid
        - trend_micro_vision_one.detection.source.ip
        - trend_micro_vision_one.detection.source.port
        - trend_micro_vision_one.detection.tactic_id
        - trend_micro_vision_one.detection.request_client_application
        - trend_micro_vision_one.detection.file_type
        - trend_micro_vision_one.detection.os.name
        - trend_micro_vision_one.detection.user.domain
        - trend_micro_vision_one.detection.client_ip
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      ignore_failure: true
      ignore_missing: true
  - remove:
      field: event.original
      if: ctx.tags == null || !(ctx.tags.contains('preserve_original_event'))
      ignore_failure: true
      ignore_missing: true
  - script:
      description: Drops null/empty values recursively.
      lang: painless
      source: |
        boolean dropEmptyFields(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(value -> dropEmptyFields(value));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(value -> dropEmptyFields(value));
            return (((List) object).length == 0);
          }
          return false;
        }
        dropEmptyFields(ctx);
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: '{{{ _ingest.on_failure_message }}}'
