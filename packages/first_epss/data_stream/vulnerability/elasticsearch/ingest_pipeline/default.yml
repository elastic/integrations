---
description: Pipeline for processing First EPSS data.
processors:
  - set:
      field: ecs.version
      tag: set_ecs_version
      value: 8.11.0
  - terminate:
      tag: data_collection_error
      if: ctx.error?.message != null && ctx.message == null && ctx.event?.original == null
      description: error message set and no data to process.
  - set:
      field: event.kind
      tag: set_event_kind_1
      value: enrichment
  - append:
      field: event.category
      tag: append_event_catgeory
      value: vulnerability
      allow_duplicates: false
  - append:
      field: event.type
      tag: append_event_type
      value: info
      allow_duplicates: false
  - json:
      field: message
      tag: json_message
      target_field: json
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.cve
      tag: rename_cve
      target_field: first_epss.vulnerability.cve
  - set:
      field: vulnerability.id
      tag: set_vulnerability_id
      copy_from: first_epss.vulnerability.cve
      ignore_empty_value: true
  - date:
      field: json.date
      tag: date_date
      formats: [yyyy-MM-dd]
      target_field: first_epss.vulnerability.date
  - convert:
      field: json.epss
      tag: convert_epss_to_float
      target_field: first_epss.vulnerability.epss
      type: float
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.percentile
      tag: convert_percentile_to_float
      target_field: first_epss.vulnerability.percentile
      type: float
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - script:
      lang: painless
      tag: script_to_set_vulnerability_reference
      description: Script to set vunlerability.reference
      if: ctx.vulnerability?.id != null
      source: >-
        ctx.vulnerability.reference = 'https://api.first.org/data/v1/epss?pretty=true&cve=' + ctx.vulnerability.id;
  - remove:
      tag: remove_json
      field:
        - json
        - message
      ignore_missing: true
on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
