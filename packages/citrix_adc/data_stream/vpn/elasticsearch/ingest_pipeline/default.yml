---
description: Pipeline for parsing Citrix ADC VPN metrics.
processors:
  - set:
      field: ecs.version
      value: 8.11.0
      ignore_failure: true
      ignore_empty_value: true
  - set:
      field: event.type
      value: ["info"]
      ignore_failure: true
      ignore_empty_value: true
  - set:
      field: event.kind
      value: event
      ignore_failure: true
      ignore_empty_value: true
  - set:
      field: event.category
      value: ["web"]
      ignore_failure: true
      ignore_empty_value: true
  - set:
      field: event.module
      value: citrix_adc
      ignore_failure: true
      ignore_empty_value: true
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      if: 'ctx.event?.original == null'
  - json:
      field: event.original
      target_field: json
      ignore_failure: true
  - rename:
      field: json.vpn.cfghtmlservedrate
      target_field: citrix_adc.vpn.configuration_request_served.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.cpsconnfailurerate
      target_field: citrix_adc.vpn.cps.failure.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.cpsconnsuccessrate
      target_field: citrix_adc.vpn.cps.success.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.csrequesthitrate
      target_field: citrix_adc.vpn.client_server.request.hit.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.fsrequestrate
      target_field: citrix_adc.vpn.file_system.request.received.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.icalicensefailurerate
      target_field: citrix_adc.vpn.ica.license_failure.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksclienterrorrate
      target_field: citrix_adc.vpn.socks.client_error.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksconnreqrcvdrate
      target_field: citrix_adc.vpn.socks.connection.request.received.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksconnreqsentrate
      target_field: citrix_adc.vpn.socks.connection.request.sent.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksconnresprcvdrate
      target_field: citrix_adc.vpn.socks.connection.response.received.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksconnrespsentrate
      target_field: citrix_adc.vpn.socks.connection.response.sent.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksmethreqrcvdrate
      target_field: citrix_adc.vpn.socks.method.request.received.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksmethreqsentrate
      target_field: citrix_adc.vpn.socks.method.request.sent.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksmethresprcvdrate
      target_field: citrix_adc.vpn.socks.method.response.received.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksmethrespsentrate
      target_field: citrix_adc.vpn.socks.method.response.sent.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.socksservererrorrate
      target_field: citrix_adc.vpn.socks.server_error.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.staconnfailurerate
      target_field: citrix_adc.vpn.sta.connection.failure.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.staconnsuccessrate
      target_field: citrix_adc.vpn.sta.connection.success.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.starequestsentrate
      target_field: citrix_adc.vpn.sta.request.sent.rate
      ignore_missing: true
      ignore_failure: true
  - rename:
      field: json.vpn.staresponserecvdrate
      target_field: citrix_adc.vpn.sta.response.received.rate
      ignore_missing: true
      ignore_failure: true
  # Renaming and converting fields to double
  - convert:
      field: json.vpn.cfghtmlserved
      target_field: citrix_adc.vpn.configuration_request_served.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.cpsconnfailure
      target_field: citrix_adc.vpn.cps.failure.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.cpsconnsuccess
      target_field: citrix_adc.vpn.cps.success.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.csrequesthit
      target_field: citrix_adc.vpn.client_server.request.hit.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.totalfsrequest
      target_field: citrix_adc.vpn.file_system.request.received.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.icalicensefailure
      target_field: citrix_adc.vpn.ica.license_failure.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.indexhtmlhit
      target_field: citrix_adc.vpn.login_page.hits
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.vpnlicensefail
      target_field: citrix_adc.vpn.login_failed.license_unavailable.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksclienterror
      target_field: citrix_adc.vpn.socks.client_error.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksconnreqrcvd
      target_field: citrix_adc.vpn.socks.connection.request.received.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksconnreqsent
      target_field: citrix_adc.vpn.socks.connection.request.sent.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksconnresprcvd
      target_field: citrix_adc.vpn.socks.connection.response.received.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksconnrespsent
      target_field: citrix_adc.vpn.socks.connection.response.sent.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksmethreqrcvd
      target_field: citrix_adc.vpn.socks.method.request.received.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksmethreqsent
      target_field: citrix_adc.vpn.socks.method.request.sent.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksmethresprcvd
      target_field: citrix_adc.vpn.socks.method.response.received.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksmethrespsent
      target_field: citrix_adc.vpn.socks.method.response.sent.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.socksservererror
      target_field: citrix_adc.vpn.socks.server_error.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.staconnfailure
      target_field: citrix_adc.vpn.sta.connection.failure.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.staconnsuccess
      target_field: citrix_adc.vpn.sta.connection.success.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.starequestsent
      target_field: citrix_adc.vpn.sta.request.sent.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - convert:
      field: json.vpn.staresponserecvd
      target_field: citrix_adc.vpn.sta.response.received.count
      type: double
      ignore_missing: true
      ignore_failure: true
  - script:
      description: Drops null/empty values recursively.
      lang: painless
      source: |
        boolean drop(Object o) {
          if (o == null || o == "") {
            return true;
          } else if (o instanceof Map) {
            ((Map) o).values().removeIf(v -> drop(v));
            return (((Map) o).size() == 0);
          } else if (o instanceof List) {
            ((List) o).removeIf(v -> drop(v));
            return (((List) o).length == 0);
          }
          return false;
        }
        drop(ctx);
  - remove:
      field: event.original
      if: "ctx.tags == null || !(ctx.tags.contains('preserve_original_event'))"
      ignore_missing: true
      ignore_failure: true
  - remove:
      field:
        - json
      ignore_missing: true
      ignore_failure: true
on_failure:
  - set:
      field: error.message
      value: "{{{_ingest.on_failure_message}}}"
