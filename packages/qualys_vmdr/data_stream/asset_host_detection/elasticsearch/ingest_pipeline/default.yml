---
description: Pipeline for processing Asset Host Detection data.
processors:
  - set:
      field: ecs.version
      tag: set_ecs_version
      value: 8.11.0

  # Set up tag logic for choosing which cloud metadata to include.
  - append:
      field: tags
      value: ["elastic_cloud_data", "provider_cloud_data"]
      if: ctx.tags?.contains('both') == true
  - script:
      lang: painless
      if: ctx.tags?.contains('both') == true
      source: ctx.tags.remove(ctx.tags.indexOf('both'));
  - script:
      lang: painless
      if: ctx.cloud == null && ctx.tags?.contains('elastic_cloud_data') == true
      source: ctx.tags.remove(ctx.tags.indexOf('elastic_cloud_data'));
  - set:
      field: _conf.want_provider_cloud
      value: true
      if: ctx.tags?.contains('provider_cloud_data') == true
  - remove:
      description: Remove elastic agent-provided cloud metadata fields if not requested.
      field: cloud
      if: ctx.tags != null && !ctx.tags.contains('elastic_cloud_data')
      ignore_missing: true
      ignore_failure: true

  - fail:
      tag: cel_failure
      if: ctx.error?.message != null && ctx.message == null && ctx.event?.original == null
      message: error message set and no data to process
  - set:
      field: event.kind
      tag: set_event_kind_1
      value: alert
  - set:
      field: event.category
      tag: set_event_catgeory
      value: [host]
  - set:
      field: event.type
      tag: set_event_type
      value: [info]
  - set:
      field: observer.vendor
      tag: set_observer_vendor
      value: 'Qualys VMDR'
  - set:
      field: vulnerability.scanner.vendor
      tag: set_vulnerability_scanner_vendor
      value: Qualys
  - json:
      field: message
      tag: json_message
      target_field: json
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.ASSET_ID
      target_field: qualys_vmdr.asset_host_detection.asset_id
      tag: convert_ASSET_ID_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.DNS
      tag: rename_DNS
      target_field: qualys_vmdr.asset_host_detection.dns
      ignore_missing: true
  - rename:
      field: json.DNS_DATA.DOMAIN
      tag: rename_DNS_DATA.DOMAIN
      target_field: qualys_vmdr.asset_host_detection.dns_data.domain
      ignore_missing: true
  - rename:
      field: json.DNS_DATA.FQDN
      tag: rename_DNS_DATA.FQDN
      target_field: qualys_vmdr.asset_host_detection.dns_data.fqdn
      ignore_missing: true
  - rename:
      field: json.DNS_DATA.HOSTNAME
      tag: rename_DNS_DATA.HOSTNAME
      target_field: qualys_vmdr.asset_host_detection.dns_data.hostname
      ignore_missing: true
  - append:
      field: related.hosts
      tag: append_hostname_into_related_hosts
      value: '{{{qualys_vmdr.asset_host_detection.dns_data.hostname}}}'
      allow_duplicates: false
      if: ctx.qualys_vmdr?.asset_host_detection?.dns_data?.hostname != null
  - set:
      field: host.name
      tag: set_host_name
      value: '{{{qualys_vmdr.asset_host_detection.dns_data.fqdn}}}'
      ignore_empty_value: true
  - set:
      field: host.name
      tag: set_host_name_if_null
      value: '{{{qualys_vmdr.asset_host_detection.dns_data.hostname}}}'
      if: ctx.host?.name == null
      ignore_empty_value: true
  - set:
      field: host.hostname
      tag: set_host_hostname
      value: '{{{qualys_vmdr.asset_host_detection.dns_data.hostname}}}'
      ignore_empty_value: true
  - append:
      field: related.hosts
      tag: append_fqdn_into_related_hosts
      value: '{{{qualys_vmdr.asset_host_detection.dns_data.fqdn}}}'
      allow_duplicates: false
      if: ctx.qualys_vmdr?.asset_host_detection?.dns_data?.fqdn != null
  - rename:
      field: json.ID
      tag: rename_ID
      target_field: qualys_vmdr.asset_host_detection.id
      ignore_missing: true
  - set:
      field: resource.id
      tag: set_resource_id
      copy_from: qualys_vmdr.asset_host_detection.id
      ignore_empty_value: true
  - set:
      field: resource.name
      tag: set_resource_name
      copy_from: host.name
      ignore_empty_value: true
  - set:
      field: host.id
      tag: set_host_id
      copy_from: qualys_vmdr.asset_host_detection.id
      ignore_empty_value: true
  - append:
      field: related.hosts
      tag: append_host_id_into_related_hosts
      value: '{{{host.id}}}'
      allow_duplicates: false
      if: ctx.host?.id != null
  - rename:
      field: json.NETBIOS
      tag: rename_NETBIOS
      target_field: qualys_vmdr.asset_host_detection.netbios
      ignore_missing: true
  - set:
      field: host.domain
      tag: set_host_domain
      copy_from: qualys_vmdr.asset_host_detection.netbios
      ignore_empty_value: true
  - append:
      field: related.hosts
      tag: append_host_domain_into_related_hosts
      value: '{{{host.domain}}}'
      allow_duplicates: false
      if: ctx.host?.domain != null
  - convert:
      field: json.NETWORK_ID
      tag: convert_NETWORK_ID_to_string
      target_field: qualys_vmdr.asset_host_detection.network_id
      type: string
      ignore_missing: true
      if: ctx.json?.NETWORK_ID != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.EC2_INSTANCE_ID
      tag: rename_EC2_INSTANCE_ID
      target_field: qualys_vmdr.asset_host_detection.ec2_instance_id
      ignore_missing: true
  - rename:
      field: json.CLOUD_RESOURCE_ID
      tag: rename_CLOUD_RESOURCE_ID
      target_field: qualys_vmdr.asset_host_detection.cloud_resource_id
      ignore_missing: true
  - set:
      field: cloud.instance.id
      tag: set_cloud_instance_id
      copy_from: qualys_vmdr.asset_host_detection.cloud_resource_id
      if: ctx._conf?.want_provider_cloud == true
      ignore_empty_value: true
  - rename:
      field: json.CLOUD_SERVICE
      tag: rename_CLOUD_SERVICE
      target_field: qualys_vmdr.asset_host_detection.cloud_service
      ignore_missing: true
  - set:
      field: cloud.service.name
      tag: set_cloud_service_name
      copy_from: qualys_vmdr.asset_host_detection.cloud_service
      if: ctx._conf?.want_provider_cloud == true
      ignore_empty_value: true
  - rename:
      field: json.CLOUD_PROVIDER
      tag: rename_CLOUD_PROVIDER
      target_field: qualys_vmdr.asset_host_detection.cloud_provider
      ignore_missing: true
  - lowercase:
      field: qualys_vmdr.asset_host_detection.cloud_provider
      target_field: cloud.provider
      tag: lowercase_cloud_provider
      if: ctx._conf?.want_provider_cloud == true
      ignore_missing: true
  - rename:
      field: json.QG_HOSTID
      tag: rename_QG_HOSTID
      target_field: qualys_vmdr.asset_host_detection.qg_hostid
      ignore_missing: true
  - append:
      field: related.hosts
      tag: append_qg_host_id_into_related_hosts
      value: '{{{qualys_vmdr.asset_host_detection.qg_hostid}}}'
      allow_duplicates: false
      if: ctx.qualys_vmdr?.asset_host_detection?.qg_hostid != null
  - rename:
      field: json.OS_CPE
      tag: rename_OS_CPE
      target_field: qualys_vmdr.asset_host_detection.os_cpe
      ignore_missing: true
  - rename:
      field: json.OS
      tag: rename_OS
      target_field: qualys_vmdr.asset_host_detection.os
      ignore_missing: true
  - set:
      field: host.os.full
      tag: set_host_os_full
      copy_from: qualys_vmdr.asset_host_detection.os
      ignore_empty_value: true
  - set:
      field: host.os.platform
      tag: set_host_os_platform_linux
      value: linux
      if: ctx.host?.os?.full != null && ctx.host.os.full.toLowerCase().contains('linux')
      ignore_empty_value: true
  - set:
      field: host.os.platform
      tag: set_host_os_platform_windows
      value: windows
      if: ctx.host?.os?.full != null && ctx.host.os.full.toLowerCase().contains('windows')
      ignore_empty_value: true
  - set:
      field: host.os.type
      tag: set_host_os_type
      copy_from: host.os.platform
      ignore_empty_value: true
  - set:
      field: host.os.platform
      tag: set_host_os_platform_darwin
      value: darwin
      if: ctx.host?.os?.full != null && ctx.host.os.full.toLowerCase().contains('macos')
      ignore_empty_value: true
  - set:
      field: host.os.type
      tag: set_host_os_type_macos
      value: macos
      if: ctx.host?.os?.full != null && ctx.host.os.full.toLowerCase().contains('macos')
      ignore_empty_value: true
  - rename:
      field: json.TRACKING_METHOD
      tag: rename_TRACKING_METHOD
      target_field: qualys_vmdr.asset_host_detection.tracking_method
      ignore_missing: true
  - convert:
      field: json.IP
      tag: convert_IP_to_ip
      target_field: qualys_vmdr.asset_host_detection.ip
      type: ip
      ignore_missing: true
      if: ctx.json?.IP != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      tag: append_ip_into_related_ip
      value: '{{{qualys_vmdr.asset_host_detection.ip}}}'
      allow_duplicates: false
      if: ctx.qualys_vmdr?.asset_host_detection?.ip != null
  - convert:
      field: json.IPV6
      tag: convert_IPV6_to_ip
      target_field: qualys_vmdr.asset_host_detection.ipv6
      type: ip
      ignore_missing: true
      if: ctx.json?.IPV6 != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - append:
      field: related.ip
      tag: append_ipv6_into_related_ip
      value: '{{{qualys_vmdr.asset_host_detection.ipv6}}}'
      allow_duplicates: false
      if: ctx.qualys_vmdr?.asset_host_detection?.ipv6 != null
  - append:
      field: host.ip
      tag: append_host_ip
      value: '{{{qualys_vmdr.asset_host_detection.ip}}}'
      allow_duplicates: false
      if: ctx.qualys_vmdr?.asset_host_detection?.ip != null
  - date:
      field: json.LAST_PC_SCANNED_DATE
      tag: date_LAST_PC_SCANNED_DATE
      target_field: qualys_vmdr.asset_host_detection.last_pc_scanned_date
      formats:
        - ISO8601
      if: ctx.json?.LAST_PC_SCANNED_DATE != null && ctx.json.LAST_PC_SCANNED_DATE != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: json.LAST_SCAN_DATETIME
      tag: date_LAST_SCAN_DATETIME
      target_field: qualys_vmdr.asset_host_detection.last_scan_datetime
      formats:
        - ISO8601
      if: ctx.json?.LAST_SCAN_DATETIME != null && ctx.json.LAST_SCAN_DATETIME != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: json.LAST_VM_AUTH_SCANNED_DATE
      tag: date_LAST_VM_AUTH_SCANNED_DATE
      target_field: qualys_vmdr.asset_host_detection.last_vm_auth_scanned_date
      formats:
        - ISO8601
      if: ctx.json?.LAST_VM_AUTH_SCANNED_DATE != null && ctx.json.LAST_VM_AUTH_SCANNED_DATE != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: json.LAST_VM_SCANNED_DATE
      tag: date_LAST_VM_SCANNED_DATE
      target_field: qualys_vmdr.asset_host_detection.last_vm_scanned_date
      formats:
        - ISO8601
      if: ctx.json?.LAST_VM_SCANNED_DATE != null && ctx.json.LAST_VM_SCANNED_DATE != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.LAST_VM_AUTH_SCANNED_DURATION
      tag: convert_LAST_VM_AUTH_SCANNED_DURATION_to_long
      target_field: qualys_vmdr.asset_host_detection.last_vm_auth_scanned_duration
      type: long
      ignore_missing: true
      if: ctx.json?.LAST_VM_AUTH_SCANNED_DURATION != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.LAST_VM_SCANNED_DURATION
      tag: convert_LAST_VM_SCANNED_DURATION_to_long
      target_field: qualys_vmdr.asset_host_detection.last_vm_scanned_duration
      type: long
      ignore_missing: true
      if: ctx.json?.LAST_VM_SCANNED_DURATION != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: json.TAGS.TAG
      if: ctx.json?.TAGS?.TAG instanceof List
      tag: foreach_rename_TAG_ID
      processor:
        rename:
          field: _ingest._value.TAG_ID
          tag: rename_qualys_vmdr_asset_host_detection_tags_TAG_ID_1
          target_field: _ingest._value.id
          ignore_missing: true
  - foreach:
      field: json.TAGS.TAG
      if: ctx.json?.TAGS?.TAG instanceof List
      tag: foreach_rename_TAG_NAME
      processor:
        rename:
          field: _ingest._value.NAME
          tag: rename_qualys_vmdr_asset_host_detection_tags_NAME_1
          target_field: _ingest._value.name
          ignore_missing: true
  - foreach:
      field: json.TAGS.TAG
      if: ctx.json?.TAGS?.TAG instanceof List
      tag: foreach_rename_COLOR
      processor:
        rename:
          field: _ingest._value.COLOR
          tag: rename_qualys_vmdr_asset_host_detection_tags_COLOR_1
          target_field: _ingest._value.color
          ignore_missing: true
  - foreach:
      field: json.TAGS.TAG
      if: ctx.json?.TAGS?.TAG instanceof List
      tag: foreach_rename_TAG_BACKGROUND_COLOR
      processor:
        rename:
          field: _ingest._value.BACKGROUND_COLOR
          tag: rename_qualys_vmdr_asset_host_detection_BACKGROUND_COLOR_NAME_1
          target_field: _ingest._value.background_color
          ignore_missing: true
  - rename:
      field: json.TAGS.TAG
      tag: rename_TAGS_TAG
      target_field: qualys_vmdr.asset_host_detection.tags
      ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.tags.NAME
      tag: rename_qualys_vmdr_asset_host_detection_tags_NAME_2
      target_field: qualys_vmdr.asset_host_detection.tags.name
      ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.tags.TAG_ID
      tag: rename_qualys_vmdr_asset_host_detection_tags_TAG_ID_2
      target_field: qualys_vmdr.asset_host_detection.tags.id
      ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.tags.COLOR
      tag: rename_qualys_vmdr_asset_host_detection_tags_COLOR_2
      target_field: qualys_vmdr.asset_host_detection.tags.color
      ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.tags.BACKGROUND_COLOR
      tag: rename_qualys_vmdr_asset_host_detection_tags_BACKGROUND_COLOR_2
      target_field: qualys_vmdr.asset_host_detection.tags.background_color
      ignore_missing: true
  - rename:
      field: json.METADATA.EC2.ATTRIBUTE
      tag: rename_METADATA_EC2_ATTRIBUTE
      target_field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List
      tag: foreach_rename_metadata_ec2_attribute_NAME
      processor:
        rename:
          field: _ingest._value.NAME
          tag: rename_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_NAME_1
          target_field: _ingest._value.name
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.NAME
      tag: rename_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_NAME_2
      target_field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.name
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List
      tag: foreach_rename_metadata_ec2_attribute_LAST_STATUS
      processor:
        rename:
          field: _ingest._value.LAST_STATUS
          tag: rename_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_LAST_STATUS_1
          target_field: _ingest._value.last.status
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.LAST_STATUS
      tag: rename_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_LAST_STATUS_2
      target_field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.last.status
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List
      tag: foreach_rename_metadata_ec2_attribute_VALUE
      processor:
        rename:
          field: _ingest._value.VALUE
          tag: rename_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_VALUE_1
          target_field: _ingest._value.value
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.VALUE
      tag: rename_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_VALUE_2
      target_field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.value
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List
      tag: foreach_rename_metadata_ec2_attribute_LAST_ERROR
      processor:
        rename:
          field: _ingest._value.LAST_ERROR
          tag: rename_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_LAST_ERROR_1
          target_field: _ingest._value.last.error.value
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.LAST_ERROR
      tag: rename_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_LAST_ERROR_2
      target_field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.last.error.value
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List
      tag: foreach_date_metadata_ec2_attribute_LAST_SUCCESS_DATE
      processor:
        date:
          field: _ingest._value.LAST_SUCCESS_DATE
          tag: date_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_LAST_SUCCESS_DATE_1
          target_field: _ingest._value.last.success_date
          formats:
            - ISO8601
          ignore_failure: true
  - date:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.LAST_SUCCESS_DATE
      tag: date_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_LAST_SUCCESS_DATE_2
      if: (!(ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List)) && ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute?.LAST_SUCCESS_DATE != null && ctx.qualys_vmdr.asset_host_detection.metadata.ec2.attribute.LAST_SUCCESS_DATE != ''
      target_field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.last.success_date
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List
      tag: foreach_date_metadata_ec2_attribute_LAST_ERROR_DATE
      processor:
        date:
          field: _ingest._value.LAST_ERROR_DATE
          tag: date_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_LAST_ERROR_DATE_1
          target_field: _ingest._value.last.error.date
          formats:
            - ISO8601
          ignore_failure: true
  - date:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.LAST_ERROR_DATE
      tag: date_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_LAST_ERROR_DATE_2
      if: (!(ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List)) && ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute?.LAST_ERROR_DATE != null && ctx.qualys_vmdr.asset_host_detection.metadata.ec2.attribute.LAST_ERROR_DATE != ''
      target_field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute.last.error.date
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.ec2.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List
      tag: foreach_remove_metadata_ec2_attribute_fields
      processor:
        remove:
          field:
            - _ingest._value.LAST_SUCCESS_DATE
            - _ingest._value.LAST_ERROR_DATE
          tag: remove_qualys_vmdr_asset_host_detection_metadata_ec2_attribute_fields
          ignore_missing: true
  - rename:
      field: json.METADATA.GOOGLE.ATTRIBUTE
      tag: rename_METADATA_GOOGLE_ATTRIBUTE
      target_field: qualys_vmdr.asset_host_detection.metadata.google.attribute
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List
      tag: foreach_rename_metadata_google_attribute_NAME
      processor:
        rename:
          field: _ingest._value.NAME
          tag: rename_qualys_vmdr_asset_host_detection_metadata_google_attribute_NAME_1
          target_field: _ingest._value.name
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute.NAME
      tag: rename_qualys_vmdr_asset_host_detection_metadata_google_attribute_NAME_2
      target_field: qualys_vmdr.asset_host_detection.metadata.google.attribute.name
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List
      tag: foreach_rename_metadata_google_attribute_LAST_STATUS
      processor:
        rename:
          field: _ingest._value.LAST_STATUS
          tag: rename_qualys_vmdr_asset_host_detection_metadata_google_attribute_LAST_STATUS_1
          target_field: _ingest._value.last.status
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute.LAST_STATUS
      tag: rename_qualys_vmdr_asset_host_detection_metadata_google_attribute_LAST_STATUS_2
      target_field: qualys_vmdr.asset_host_detection.metadata.google.attribute.last.status
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List
      tag: foreach_rename_metadata_google_attribute_VALUE
      processor:
        rename:
          field: _ingest._value.VALUE
          tag: rename_qualys_vmdr_asset_host_detection_metadata_google_attribute_VALUE_1
          target_field: _ingest._value.value
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute.VALUE
      tag: rename_qualys_vmdr_asset_host_detection_metadata_google_attribute_VALUE_2
      target_field: qualys_vmdr.asset_host_detection.metadata.google.attribute.value
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List
      tag: foreach_rename_metadata_google_attribute_LAST_ERROR
      processor:
        rename:
          field: _ingest._value.LAST_ERROR
          tag: rename_qualys_vmdr_asset_host_detection_metadata_google_attribute_LAST_ERROR_1
          target_field: _ingest._value.last.error.value
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute.LAST_ERROR
      tag: rename_qualys_vmdr_asset_host_detection_metadata_google_attribute_LAST_ERROR_2
      target_field: qualys_vmdr.asset_host_detection.metadata.google.attribute.last.error.value
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List
      tag: foreach_date_metadata_google_attribute_LAST_SUCCESS_DATE
      processor:
        date:
          field: _ingest._value.LAST_SUCCESS_DATE
          tag: date_qualys_vmdr_asset_host_detection_metadata_google_attribute_LAST_SUCCESS_DATE_1
          target_field: _ingest._value.last.success_date
          formats:
            - ISO8601
          ignore_failure: true
  - date:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute.LAST_SUCCESS_DATE
      tag: date_qualys_vmdr_asset_host_detection_metadata_google_attribute_LAST_SUCCESS_DATE_2
      if: (!(ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List)) && ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute?.LAST_SUCCESS_DATE != null && ctx.qualys_vmdr.asset_host_detection.metadata.google.attribute.LAST_SUCCESS_DATE != ''
      target_field: qualys_vmdr.asset_host_detection.metadata.google.attribute.last.success_date
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List
      tag: foreach_date_metadata_google_attribute_LAST_ERROR_DATE
      processor:
        date:
          field: _ingest._value.LAST_ERROR_DATE
          tag: date_qualys_vmdr_asset_host_detection_metadata_google_attribute_LAST_ERROR_DATE_1
          target_field: _ingest._value.last.error.date
          formats:
            - ISO8601
          ignore_failure: true
  - date:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute.LAST_ERROR_DATE
      tag: date_qualys_vmdr_asset_host_detection_metadata_google_attribute_LAST_ERROR_DATE_2
      if: (!(ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List)) && ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute?.LAST_ERROR_DATE != null && ctx.qualys_vmdr.asset_host_detection.metadata.google.attribute.LAST_ERROR_DATE != ''
      target_field: qualys_vmdr.asset_host_detection.metadata.google.attribute.last.error.date
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.google.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List
      tag: foreach_remove_metadata_google_attribute_fields
      processor:
        remove:
          field:
            - _ingest._value.LAST_SUCCESS_DATE
            - _ingest._value.LAST_ERROR_DATE
          tag: remove_qualys_vmdr_asset_host_detection_metadata_google_attribute_fields
          ignore_missing: true
  - rename:
      field: json.METADATA.AZURE.ATTRIBUTE
      tag: rename_METADATA_AZURE_ATTRIBUTE
      target_field: qualys_vmdr.asset_host_detection.metadata.azure.attribute
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List
      tag: foreach_rename_metadata_azure_attribute_NAME
      processor:
        rename:
          field: _ingest._value.NAME
          tag: rename_qualys_vmdr_asset_host_detection_metadata_azure_attribute_NAME_1
          target_field: _ingest._value.name
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.NAME
      tag: rename_qualys_vmdr_asset_host_detection_metadata_azure_attribute_NAME_2
      target_field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.name
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List
      tag: foreach_rename_metadata_azure_attribute_LAST_STATUS
      processor:
        rename:
          field: _ingest._value.LAST_STATUS
          tag: rename_qualys_vmdr_asset_host_detection_metadata_azure_attribute_LAST_STATUS_1
          target_field: _ingest._value.last.status
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.LAST_STATUS
      tag: rename_qualys_vmdr_asset_host_detection_metadata_azure_attribute_LAST_STATUS_2
      target_field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.last.status
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List
      tag: foreach_rename_metadata_azure_attribute_VALUE
      processor:
        rename:
          field: _ingest._value.VALUE
          tag: rename_qualys_vmdr_asset_host_detection_metadata_azure_attribute_VALUE_1
          target_field: _ingest._value.value
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.VALUE
      tag: rename_qualys_vmdr_asset_host_detection_metadata_azure_attribute_VALUE_2
      target_field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.value
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List
      tag: foreach_rename_metadata_azure_attribute_LAST_ERROR
      processor:
        rename:
          field: _ingest._value.LAST_ERROR
          tag: rename_qualys_vmdr_asset_host_detection_metadata_azure_attribute_LAST_ERROR_1
          target_field: _ingest._value.last.error.value
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.LAST_ERROR
      tag: rename_qualys_vmdr_asset_host_detection_metadata_azure_attribute_LAST_ERROR_2
      target_field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.last.error.value
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List
      tag: foreach_date_metadata_azure_attribute_LAST_SUCCESS_DATE
      processor:
        date:
          field: _ingest._value.LAST_SUCCESS_DATE
          tag: date_qualys_vmdr_asset_host_detection_metadata_azure_attribute_LAST_SUCCESS_DATE_1
          target_field: _ingest._value.last.success_date
          formats:
            - ISO8601
          ignore_failure: true
  - date:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.LAST_SUCCESS_DATE
      tag: date_qualys_vmdr_asset_host_detection_metadata_azure_attribute_LAST_SUCCESS_DATE_2
      if: (!(ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List)) && ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute?.LAST_SUCCESS_DATE != null && ctx.qualys_vmdr.asset_host_detection.metadata.azure.attribute.LAST_SUCCESS_DATE != ''
      target_field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.last.success_date
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List
      tag: foreach_date_metadata_azure_attribute_LAST_ERROR_DATE
      processor:
        date:
          field: _ingest._value.LAST_ERROR_DATE
          tag: date_qualys_vmdr_asset_host_detection_metadata_azure_attribute_LAST_ERROR_DATE_1
          target_field: _ingest._value.last.error.date
          formats:
            - ISO8601
          ignore_failure: true
  - date:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.LAST_ERROR_DATE
      tag: date_qualys_vmdr_asset_host_detection_metadata_azure_attribute_LAST_ERROR_DATE_2
      if: (!(ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List)) && ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute?.LAST_ERROR_DATE != null && ctx.qualys_vmdr.asset_host_detection.metadata.azure.attribute.LAST_ERROR_DATE != ''
      target_field: qualys_vmdr.asset_host_detection.metadata.azure.attribute.last.error.date
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: qualys_vmdr.asset_host_detection.metadata.azure.attribute
      if: ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List
      tag: foreach_remove_metadata_azure_attribute_fields
      processor:
        remove:
          field:
            - _ingest._value.LAST_SUCCESS_DATE
            - _ingest._value.LAST_ERROR_DATE
          tag: remove_qualys_vmdr_asset_host_detection_metadata_azure_attribute_fields
          ignore_missing: true
  - rename:
      field: json.CLOUD_PROVIDER_TAGS.CLOUD_TAG
      tag: rename_CLOUD_PROVIDER_TAGS_CLOUD_TAG
      target_field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag
      if: ctx.qualys_vmdr?.asset_host_detection?.cloud_provider_tags?.cloud_tag instanceof List
      tag: foreach_rename_cloud_provider_tags_NAME
      processor:
        rename:
          field: _ingest._value.NAME
          tag: rename_qualys_vmdr_asset_host_detection_cloud_provider_tags_cloud_tag_NAME_1
          target_field: _ingest._value.name
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag.NAME
      tag: rename_qualys_vmdr_asset_host_detection_cloud_provider_tags_cloud_tag_NAME_2
      target_field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag.name
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag
      if: ctx.qualys_vmdr?.asset_host_detection?.cloud_provider_tags?.cloud_tag instanceof List
      tag: foreach_rename_cloud_provider_tags_VALUE
      processor:
        rename:
          field: _ingest._value.VALUE
          tag: rename_qualys_vmdr_asset_host_detection_cloud_provider_tags_cloud_tag_VALUE_1
          target_field: _ingest._value.value
          ignore_missing: true
  - rename:
      field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag.VALUE
      tag: rename_qualys_vmdr_asset_host_detection_cloud_provider_tags_cloud_tag_VALUE_2
      target_field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag.value
      ignore_missing: true
  - foreach:
      field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag
      if: ctx.qualys_vmdr?.asset_host_detection?.cloud_provider_tags?.cloud_tag instanceof List
      tag: foreach_date_cloud_provider_tags_LAST_SUCCESS_DATE
      processor:
        date:
          field: _ingest._value.LAST_SUCCESS_DATE
          tag: date_qualys_vmdr_asset_host_detection_cloud_provider_tags_cloud_tag_LAST_SUCCESS_DATE_1
          target_field: _ingest._value.last_success_date
          formats:
            - ISO8601
          ignore_failure: true
  - date:
      field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag.LAST_SUCCESS_DATE
      tag: date_qualys_vmdr_asset_host_detection_cloud_provider_tags_cloud_tag_LAST_SUCCESS_DATE_2
      if: (!(ctx.qualys_vmdr?.asset_host_detection?.cloud_provider_tags?.cloud_tag instanceof List)) && ctx.qualys_vmdr?.asset_host_detection?.cloud_provider_tags?.cloud_tag?.LAST_SUCCESS_DATE != null && ctx.qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag.LAST_SUCCESS_DATE != ''
      target_field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag.last_success_date
      formats:
        - ISO8601
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag
      if: ctx.qualys_vmdr?.asset_host_detection?.cloud_provider_tags?.cloud_tag instanceof List
      tag: foreach_remove_cloud_provider_tags_fields
      processor:
        remove:
          field:
            - _ingest._value.LAST_SUCCESS_DATE
          tag: remove_qualys_vmdr_asset_host_detection_cloud_provider_tags_cloud_tag_fields
          ignore_missing: true

  - script:
      lang: painless
      tag: cloud_provider_attributes
      if: >-
        ctx._conf?.want_provider_cloud == true && (
          ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List ||
          ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List ||
          ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List
        )
      source: |-
        def accIDs = new ArrayList();
        def projIDs = new ArrayList();
        def names = new ArrayList();
        def regions = new ArrayList();
        def types = new ArrayList();
        def zones = new ArrayList();
        // Collate attributes.
        if (ctx.qualys_vmdr?.asset_host_detection?.metadata?.ec2?.attribute instanceof List) {
          for (def attr: ctx.qualys_vmdr.asset_host_detection.metadata.ec2.attribute) {
            if (attr.value == null && attr.value == "") {
              continue;
            }
            if (attr.name == "latest/dynamic/instance-identity/document/accountId") {
              accIDs.add(attr.value);
              continue;
            }
            if (attr.name == "latest/dynamic/instance-identity/document/instanceType") {
              types.add(attr.value);
              continue;
            }
            if (attr.name == "latest/dynamic/instance-identity/document/region") {
              regions.add(attr.value);
              continue;
            }
            if (attr.name == "latest/dynamic/instance-identity/document/availabilityZone") {
              zones.add(attr.value);
            }
          }
        }
        if (ctx.qualys_vmdr?.asset_host_detection?.metadata?.google?.attribute instanceof List) {
          for (def attr: ctx.qualys_vmdr.asset_host_detection.metadata.google.attribute) {
            if (attr.value == null && attr.value == "") {
              continue;
            }
            if (attr.name == "projectId") {
              names.add(attr.value);
              continue;
            }
            if (attr.name == "projectIdNo") {
              projIDs.add(attr.value);
              continue;
            }
            if (attr.name == "machineType") {
              types.add(attr.value);
              continue;
            }
            if (attr.name == "location") {
              regions.add(attr.value);
              continue;
            }
            if (attr.name == "zone") {
              zones.add(attr.value);
            }
          }
        }
        if (ctx.qualys_vmdr?.asset_host_detection?.metadata?.azure?.attribute instanceof List) {
          for (def attr: ctx.qualys_vmdr.asset_host_detection.metadata.azure.attribute) {
            if (attr.value == null && attr.value == "") {
              continue;
            }
            if (attr.name == "subscriptionId") {
              projIDs.add(attr.value);
              continue;
            }
            if (attr.name == "location") {
              regions.add(attr.value);
            }
          }
        }
        // Apply collation.
        if (accIDs.length != 0) {
          if (ctx.cloud == null) {
            ctx.cloud = new HashMap();
          }
          if (ctx.cloud.account == null) {
            ctx.cloud.account = new HashMap();
          }
          ctx.cloud.account.id = accIDs;
        }
        if (projIDs.length != 0) {
          if (ctx.cloud == null) {
            ctx.cloud = new HashMap();
          }
          if (ctx.cloud.project == null) {
            ctx.cloud.project = new HashMap();
          }
          ctx.cloud.project.id = projIDs;
          if (ctx.cloud?.account?.id == null) {
            if (ctx.cloud.account == null) {
              ctx.cloud.account = new HashMap();
            }
            ctx.cloud.account.id = projIDs;
          }
        }
        if (names.length != 0) {
          if (ctx.cloud == null) {
            ctx.cloud = new HashMap();
          }
          if (ctx.cloud.project == null) {
            ctx.cloud.project = new HashMap();
          }
          ctx.cloud.project.name = names;
          if (ctx.cloud?.account?.name == null) {
            if (ctx.cloud.account == null) {
              ctx.cloud.account = new HashMap();
            }
            ctx.cloud.account.name = names;
          }
        }
        if (regions.length != 0) {
          if (ctx.cloud == null) {
            ctx.cloud = new HashMap();
          }
          ctx.cloud.region = regions;
        }
        if (types.length != 0) {
          if (ctx.cloud == null) {
            ctx.cloud = new HashMap();
          }
          if (ctx.cloud.machine == null) {
            ctx.cloud.machine = new HashMap();
          }
          ctx.cloud.machine.type = types;
        }
        if (zones.length != 0) {
          if (ctx.cloud == null) {
            ctx.cloud = new HashMap();
          }
          ctx.cloud.availability_zone = zones;
        }

  - set:
      field: cloud.instance.name
      copy_from: qualys_vmdr.asset_host_detection.dns_data.hostname
      if: ctx._conf?.want_provider_cloud == true
      ignore_empty_value: true

  - script:
      lang: painless
      tag: script_to_set_IS_DISABLED
      description: Script to set IS_DISABLED for 0 and 1 values.
      if: ctx.json?.DETECTION_LIST != null
      source: >-
        def obj = ctx.json.DETECTION_LIST;
        if (obj.containsKey("IS_DISABLED") && obj.get("IS_DISABLED").equals('0')) {
          obj.remove("IS_DISABLED");
          obj.put("IS_DISABLED", false);
        } else if (obj.containsKey("IS_DISABLED") && obj.get("IS_DISABLED").equals('1')) {
          obj.remove("IS_DISABLED");
          obj.put("IS_DISABLED", true);
        }
  - script:
      lang: painless
      tag: script_to_set_IS_IGNORED
      description: Script to set IS_IGNORED for 0 and 1 values.
      if: ctx.json?.DETECTION_LIST != null
      source: >-
        def obj = ctx.json.DETECTION_LIST;
        if (obj.containsKey("IS_IGNORED") && obj.get("IS_IGNORED").equals('0')) {
          obj.remove("IS_IGNORED");
          obj.put("IS_IGNORED", false);
        } else if (obj.containsKey("IS_IGNORED") && obj.get("IS_IGNORED").equals('1')) {
          obj.remove("IS_IGNORED");
          obj.put("IS_IGNORED", true);
        }
  - rename:
      field: json.DETECTION_LIST
      tag: rename_DETECTION_LIST
      target_field: qualys_vmdr.asset_host_detection.vulnerability
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.UNIQUE_VULN_ID != null
      field: qualys_vmdr.asset_host_detection.vulnerability.UNIQUE_VULN_ID
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_UNIQUE_VULN_ID
      target_field: qualys_vmdr.asset_host_detection.vulnerability.unique_vuln_id
      ignore_missing: true
  - set:
      field: event.id
      tag: set_event_id
      copy_from: qualys_vmdr.asset_host_detection.vulnerability.unique_vuln_id
      ignore_empty_value: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.PROTOCOL != null
      field: qualys_vmdr.asset_host_detection.vulnerability.PROTOCOL
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_PROTOCOL_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.protocol
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.FQDN != null
      field: qualys_vmdr.asset_host_detection.vulnerability.FQDN
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_FQDN_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.fqdn
      ignore_missing: true
  - append:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.fqdn != null
      field: related.hosts
      tag: append_qualys_vmdr_asset_host_detection_vulnerability_fqdn_into_related_hosts_1
      value: '{{{qualys_vmdr.asset_host_detection.vulnerability.fqdn}}}'
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.INSTANCE != null
      field: qualys_vmdr.asset_host_detection.vulnerability.INSTANCE
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_INSTANCE_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.instance
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.SERVICE != null
      field: qualys_vmdr.asset_host_detection.vulnerability.SERVICE
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_SERVICE_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.service
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.AFFECT_RUNNING_KERNEL != null
      field: qualys_vmdr.asset_host_detection.vulnerability.AFFECT_RUNNING_KERNEL
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_AFFECT_RUNNING_KERNEL_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.affect_running_kernel
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.AFFECT_RUNNING_SERVICE != null
      field: qualys_vmdr.asset_host_detection.vulnerability.AFFECT_RUNNING_SERVICE
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_AFFECT_RUNNING_SERVICE_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.affect_running_service
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.AFFECT_EXPLOITABLE_CONFIG != null
      field: qualys_vmdr.asset_host_detection.vulnerability.AFFECT_EXPLOITABLE_CONFIG
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_AFFECT_EXPLOITABLE_CONFIG_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.affect_exploitable_config
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.ASSET_CVE != null
      field: qualys_vmdr.asset_host_detection.vulnerability.ASSET_CVE
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_ASSET_CVE_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.asset_cve
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.QID != null
      field: qualys_vmdr.asset_host_detection.vulnerability.QID
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_QID_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.qid
      ignore_missing: true
  - set:
      field: vulnerability.id
      tag: set_vulnerability_id
      copy_from: qualys_vmdr.asset_host_detection.vulnerability.qid
      ignore_empty_value: true
  - convert:
      field: qualys_vmdr.asset_host_detection.vulnerability.qid
      tag: convert_qualys_vmdr_asset_host_detection_vulnerability_qid_1_to_integer
      type: integer
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: vulnerability.enumeration
      tag: set_vulnerability_enumeration
      value: QID
      ignore_empty_value: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.RESULTS != null
      field: qualys_vmdr.asset_host_detection.vulnerability.RESULTS
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_RESULTS_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.results
      ignore_missing: true
  # The next two gsub processors facilitate `splitOnToken` in the subsequent script processor, which otherwise cannot split \n or \t.
  - gsub:
      field: qualys_vmdr.asset_host_detection.vulnerability.results
      pattern: '\n'
      replacement: ';;'
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.results != null && ctx.qualys_vmdr.asset_host_detection.vulnerability.results.startsWith("Package")
      tag: gsub_qualys_vmdr_asset_host_detection_vulnerability_results_line
      ignore_missing: true
  - gsub:
      field: qualys_vmdr.asset_host_detection.vulnerability.results
      pattern: '\t'
      replacement: '||'
      tag: gsub_qualys_vmdr_asset_host_detection_vulnerability_results_tab
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.results != null && ctx.qualys_vmdr.asset_host_detection.vulnerability.results.startsWith("Package")
      ignore_missing: true
  - script:
      lang: painless
      tag: script_to_extract_package_fields
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.results != null
      description: Extract package fields
      source: |-
        String results = ctx.qualys_vmdr.asset_host_detection.vulnerability.results;
        if (results.startsWith("Package||")) {
          if (ctx.package == null) {
            ctx.package = new HashMap();
            ctx.qualys_vmdr.asset_host_detection.package_nested = new HashMap();
          }
          if (ctx.package.name == null) {
            ctx.package.name = new ArrayList();
            ctx.qualys_vmdr.asset_host_detection.package_nested.name = new ArrayList();
          }
          if (ctx.package.version == null) {
            ctx.package.version = new ArrayList();
            ctx.qualys_vmdr.asset_host_detection.package_nested.version = new ArrayList();
          }
          if (ctx.package.fixed_version == null) {
            ctx.package.fixed_version = new ArrayList();
            ctx.qualys_vmdr.asset_host_detection.package_nested.fixed_version = new ArrayList();
          }
          def res = results.splitOnToken(";;");
          for (int i=1; i < res.length; i++) {
            def pkg = res[i].splitOnToken("||");
            ctx.package.name.add(pkg[0]);
            ctx.qualys_vmdr.asset_host_detection.package_nested.name.add(pkg[0]);
            ctx.package.version.add(pkg[1]);
            ctx.qualys_vmdr.asset_host_detection.package_nested.version.add(pkg[1]);
            if (pkg.length == 3) {
              ctx.package.fixed_version.add(pkg[2]);
              ctx.qualys_vmdr.asset_host_detection.package_nested.fixed_version.add(pkg[2]);
            }
          }
        }
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: vulnerability.package.name
      tag: set_vulnerability_package_name
      copy_from: package.name
      ignore_empty_value: true
  - set:
      field: vulnerability.package.version
      tag: set_vulnerability_package_version
      copy_from: package.version
      ignore_empty_value: true
  - set:
      field: vulnerability.package.fixed_version
      tag: set_vulnerability_package_fixed_version
      copy_from: package.fixed_version
      ignore_empty_value: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.STATUS != null
      field: qualys_vmdr.asset_host_detection.vulnerability.STATUS
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_STATUS_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.status
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.TYPE != null
      field: qualys_vmdr.asset_host_detection.vulnerability.TYPE
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_TYPE_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.type
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.QDS != null
      field: qualys_vmdr.asset_host_detection.vulnerability.QDS
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_QDS_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.qds
      ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.qds != null
      field: qualys_vmdr.asset_host_detection.vulnerability.qds.#text
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_qds_#text_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.qds.score
      ignore_missing: true
  - convert:
      field: qualys_vmdr.asset_host_detection.vulnerability.qds.score
      tag: convert_qualys_vmdr_asset_host_detection_vulnerability_qds_score_1_to_long
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.SSL != null
      field: qualys_vmdr.asset_host_detection.vulnerability.SSL
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_SSL_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.ssl
      ignore_missing: true
  - date:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.FIRST_FOUND_DATETIME != null
      field: qualys_vmdr.asset_host_detection.vulnerability.FIRST_FOUND_DATETIME
      tag: date_qualys_vmdr_asset_host_detection_vulnerability_FIRST_FOUND_DATETIME_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.first_found_datetime
      formats:
        - ISO8601
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.FIRST_REOPENED_DATETIME != null
      field: qualys_vmdr.asset_host_detection.vulnerability.FIRST_REOPENED_DATETIME
      tag: date_qualys_vmdr_asset_host_detection_vulnerability_FIRST_REOPENED_DATETIME_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.first_reopened_datetime
      formats:
        - ISO8601
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.LAST_FOUND_DATETIME != null
      field: qualys_vmdr.asset_host_detection.vulnerability.LAST_FOUND_DATETIME
      tag: date_qualys_vmdr_asset_host_detection_vulnerability_LAST_FOUND_DATETIME_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.last_found_datetime
      formats:
        - ISO8601
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: qualys_vmdr.asset_host_detection.vulnerability.LAST_REOPENED_DATETIME
      tag: date_qualys_vmdr_asset_host_detection_vulnerability_LAST_REOPENED_DATETIME_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.last_reopened_datetime
      formats:
        - ISO8601
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: qualys_vmdr.asset_host_detection.vulnerability.LAST_PROCESSED_DATETIME
      tag: date_qualys_vmdr_asset_host_detection_vulnerability_LAST_PROCESSED_DATETIME_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.last_processed_datetime
      formats:
        - ISO8601
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.LAST_TEST_DATETIME != null
      field: qualys_vmdr.asset_host_detection.vulnerability.LAST_TEST_DATETIME
      tag: date_qualys_vmdr_asset_host_detection_vulnerability_LAST_TEST_DATETIME_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.last_test_datetime
      formats:
        - ISO8601
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.LAST_UPDATE_DATETIME != null
      field: qualys_vmdr.asset_host_detection.vulnerability.LAST_UPDATE_DATETIME
      tag: date_qualys_vmdr_asset_host_detection_vulnerability_LAST_UPDATE_DATETIME_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.last_update_datetime
      formats:
        - ISO8601
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.LAST_FIXED_DATETIME != null
      field: qualys_vmdr.asset_host_detection.vulnerability.LAST_FIXED_DATETIME
      tag: date_qualys_vmdr_asset_host_detection_vulnerability_LAST_FIXED_DATETIME_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.last_fixed_datetime
      formats:
        - ISO8601
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.SEVERITY != null
      field: qualys_vmdr.asset_host_detection.vulnerability.SEVERITY
      target_field: qualys_vmdr.asset_host_detection.vulnerability.severity
      tag: convert_qualys_vmdr_asset_host_detection_vulnerability_SEVERITY_to_long_1
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.IS_IGNORED != null
      field: qualys_vmdr.asset_host_detection.vulnerability.IS_IGNORED
      target_field: qualys_vmdr.asset_host_detection.vulnerability.is_ignored
      tag: convert_qualys_vmdr_asset_host_detection_vulnerability_IS_IGNORED_to_boolean
      type: boolean
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.IS_DISABLED != null
      field: qualys_vmdr.asset_host_detection.vulnerability.IS_DISABLED
      target_field: qualys_vmdr.asset_host_detection.vulnerability.is_disabled
      tag: convert_qualys_vmdr_asset_host_detection_vulnerability_IS_DISABLED_to_boolean
      type: boolean
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.TIMES_FOUND != null
      field: qualys_vmdr.asset_host_detection.vulnerability.TIMES_FOUND
      target_field: qualys_vmdr.asset_host_detection.vulnerability.times_found
      tag: convert_qualys_vmdr_asset_host_detection_vulnerability_TIMES_FOUND_to_long_1
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.TIMES_REOPENED != null
      field: qualys_vmdr.asset_host_detection.vulnerability.TIMES_REOPENED
      target_field: qualys_vmdr.asset_host_detection.vulnerability.times_reopened
      tag: convert_qualys_vmdr_asset_host_detection_vulnerability_TIMES_REOPENED_to_long_1
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.PORT != null
      field: qualys_vmdr.asset_host_detection.vulnerability.PORT
      target_field: qualys_vmdr.asset_host_detection.vulnerability.port
      tag: convert_qualys_vmdr_asset_host_detection_vulnerability_PORT_to_long_1
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.QDS_FACTORS?.QDS_FACTOR != null
      field: qualys_vmdr.asset_host_detection.vulnerability.QDS_FACTORS.QDS_FACTOR
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_QDS_FACTORS_QDS_FACTOR_1
      target_field: qualys_vmdr.asset_host_detection.vulnerability.qds_factors
      ignore_missing: true
  - foreach:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.qds_factors != null
      field: qualys_vmdr.asset_host_detection.vulnerability.qds_factors
      ignore_missing: true
      tag: foreach_nested
      processor:
        rename:
          field: _ingest._value.#text
          tag: rename_qualys_vmdr_asset_host_detection_vulnerability_qds_factors_#text_1
          target_field: _ingest._value.text
          ignore_missing: true
  - rename:
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.qds_factors != null
      field: qualys_vmdr.asset_host_detection.vulnerability.qds_factors.#text
      tag: rename_qualys_vmdr_asset_host_detection_vulnerability_qds_factors_#text_2
      target_field: qualys_vmdr.asset_host_detection.vulnerability.qds_factors.text
      ignore_missing: true
  - script:
      lang: painless
      tag: script_to_assign_vulnerability_score_base
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.qds_factors instanceof List
      description: Assign vulnerbaility.score.base from array field qualys_vmdr.asset_host_detection.vulnerability.qds_factors
      source: |-
        def cvss_score;
        if (ctx.qualys_vmdr.asset_host_detection.vulnerability.qds_factors instanceof List) {
          for (def attr: ctx.qualys_vmdr.asset_host_detection.vulnerability.qds_factors) {
            if (attr.text == null && attr.text == "") {
              continue;
            }
            if (attr.name == "CVSS") {
              cvss_score = attr.text;
            }
          }
          if (cvss_score != null) {
            if (ctx.vulnerability == null) {
              ctx.vulnerability = new HashMap();
            }
            if (ctx.vulnerability.score == null) {
              ctx.vulnerability.score = new HashMap();
            }
            ctx.vulnerability.score.base = Float.parseFloat(cvss_score);
            ctx.vulnerability.classification = "CVSS";
          }
        }
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - script:
      lang: painless
      tag: script_to_assign_vulnerability_score_version
      if: ctx.qualys_vmdr?.asset_host_detection?.vulnerability?.qds_factors instanceof List
      description: Assign vulnerbaility.score.version from array field qualys_vmdr.asset_host_detection.vulnerability.qds_factors
      source: |-
        def cvss_version;
        def pattern = /CVSS:([234]\.\d)/;
        
        if (ctx.qualys_vmdr.asset_host_detection.vulnerability.qds_factors instanceof List) {
          for (def attr: ctx.qualys_vmdr.asset_host_detection.vulnerability.qds_factors) {
            if (attr.text == null && attr.value == "") {
              continue;
            }
            if (attr.name == "CVSS_vector") {
              def matcher = pattern.matcher(attr.text);
              if (matcher.find()) {
                  cvss_version = matcher.group(1);
              } 
            }
          }
          
          if (cvss_version != null) {
            if (ctx.vulnerability == null) {
              ctx.vulnerability = new HashMap();
            }
            if (ctx.vulnerability.score == null) {
              ctx.vulnerability.score = new HashMap();
              
            }
            ctx.vulnerability.score.version = cvss_version;
          }
        }
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - script:
      lang: painless
      tag: script_to_assign_vulnerability_severity
      if: ctx.vulnerability?.score?.base != null
      description: Assign vulnerbaility.severity from field vulnerability.score.base
      source: |-
        // CVSS score between 9.0 and 10.0)
        if (9.0 <= ctx.vulnerability.score.base) {
          ctx.vulnerability.severity = "critical";
        }
        // CVSS score between 7.0 and 8.9
        else if (7.0 <= ctx.vulnerability.score.base) {
          ctx.vulnerability.severity = "high";
        }
        // CVSS score between 4.0 and 6.9
        else if (4.0 <= ctx.vulnerability.score.base) {
          ctx.vulnerability.severity = "medium";
        }
        // CVSS score between 0.1 and 3.9
        else if (0.1 <= ctx.vulnerability.score.base) {
          ctx.vulnerability.severity = "low";
        }
        else if (ctx.vulnerability.score.base == 0) {
          ctx.vulnerability.severity = "none";
        }
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  # Handle KNOWLEDGE_BASE json
  - pipeline:
      name: '{{ IngestPipeline "pipeline_knowledge_base" }}'
      if: ctx.json?.KNOWLEDGE_BASE != null
      tag: pipeline_knowledge_base
      ignore_missing_pipeline: true
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      ignore_failure: true
  - remove:
      tag: remove_json
      field:
        - json
        - message
        - _conf
        - qualys_vmdr.asset_host_detection.vulnerability.FIRST_FOUND_DATETIME
        - qualys_vmdr.asset_host_detection.vulnerability.FIRST_REOPENED_DATETIME
        - qualys_vmdr.asset_host_detection.vulnerability.IS_DISABLED
        - qualys_vmdr.asset_host_detection.vulnerability.LAST_FOUND_DATETIME
        - qualys_vmdr.asset_host_detection.vulnerability.LAST_REOPENED_DATETIME
        - qualys_vmdr.asset_host_detection.vulnerability.LAST_PROCESSED_DATETIME
        - qualys_vmdr.asset_host_detection.vulnerability.LAST_TEST_DATETIME
        - qualys_vmdr.asset_host_detection.vulnerability.LAST_UPDATE_DATETIME
        - qualys_vmdr.asset_host_detection.vulnerability.LAST_FIXED_DATETIME
        - qualys_vmdr.asset_host_detection.vulnerability.PORT
        - qualys_vmdr.asset_host_detection.vulnerability.QDS_FACTORS
        - qualys_vmdr.asset_host_detection.vulnerability.SEVERITY
        - qualys_vmdr.asset_host_detection.vulnerability.TIMES_FOUND
        - qualys_vmdr.asset_host_detection.vulnerability.TIMES_REOPENED
        - qualys_vmdr.asset_host_detection.vulnerability.IS_IGNORED
        - qualys_vmdr.asset_host_detection.cloud_provider_tags.cloud_tag.LAST_SUCCESS_DATE
        - qualys_vmdr.asset_host_detection.metadata.ec2.attribute.LAST_ERROR_DATE
        - qualys_vmdr.asset_host_detection.metadata.ec2.attribute.LAST_SUCCESS_DATE
        - qualys_vmdr.asset_host_detection.metadata.google.attribute.LAST_ERROR_DATE
        - qualys_vmdr.asset_host_detection.metadata.google.attribute.LAST_SUCCESS_DATE
        - qualys_vmdr.asset_host_detection.metadata.azure.attribute.LAST_ERROR_DATE
        - qualys_vmdr.asset_host_detection.metadata.azure.attribute.LAST_SUCCESS_DATE
      ignore_missing: true
  - remove:
      field:
        - qualys_vmdr.asset_host_detection.netbios
        - qualys_vmdr.asset_host_detection.ip
        - qualys_vmdr.asset_host_detection.id
        - qualys_vmdr.asset_host_detection.os
      tag: remove_preserve_duplicate_custom_fields
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      ignore_missing: true
  - script:
      lang: painless
      tag: script_to_remove_null_values
      description: Drops null/empty values recursively.
      source: |-
        boolean drop(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(v -> drop(v));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(v -> drop(v));
            return (((List) object).length == 0);
          }
          return false;
        }
        drop(ctx);
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - script:
      tag: script_to_truncate_long_fields
      lang: painless
      description: Truncate fields that are over length.
      source: |-
        def filterMassive(def src) {
          if (src instanceof Map) {
            for (def entry: src.entrySet()) {
              entry.setValue(filterMassive(entry.getValue()));
            }
            return src;
          } else if (src instanceof List) {
            for (int i = 0; i < src.length; i++) {
              src[i] = filterMassive(src[i]);
            }
            return src;
          } else if (src instanceof String && src.length() > 32766) {
            return src.substring(0, 32700)+' (truncated)';
          }
          return src;
        }
        filterMassive(ctx);
  - set:
      field: event.kind
      tag: set_event_kind_2
      value: pipeline_error
      if: ctx.error?.message != null
  - append:
      field: tags
      tag: append_tags_preserve_original_event_1
      value: preserve_original_event
      allow_duplicates: false
      if: ctx.error?.message != null
on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false