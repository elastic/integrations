inputs:
    - data_stream:
        namespace: ep
      meta:
        package:
            name: crowdstrike
      name: test-default-crowdstrike
      streams:
        - auth.oauth2:
            client.id: test_client_id
            client.secret: ${SECRET_0}
            token_url: http://host.tld/oauth2/token
          config_version: 2
          data_stream:
            dataset: crowdstrike.vulnerability
          interval: 24h
          program: |-
            (
              state.?want_more.orValue(false) ?
                state
              :
                state.with(
                  {
                    "start_time": state.?cursor.last_timestamp.orValue(
                      (now - duration(state.initial_interval)).format(time_layout.RFC3339)
                    ),
                  }
                )
            ).as(state,
              state.with(
                request(
                  "GET",
                  state.url.trim_right("/") + "/spotlight/combined/vulnerabilities/v1?" + {
                    ?"after": state.?next.page_token.optMap(v, [v]),
                    "limit": [string(state.batch_size)],
                    "filter": [
                      [
                        "updated_timestamp:>'" + state.start_time + "'",
                        ?state.?query.optMap(q, "(" + q + ")"),
                      ].join("+"),
                    ],
                    ?"facet": has(state.facet) ?
                      optional.of(state.facet.split(","))
                    :
                      optional.none(),
                  }.format_query()
                ).do_request().as(resp, (resp.StatusCode == 200) ?
                  bytes(resp.Body).decode_json().as(body,
                    (size(body.?errors.orValue([])) > 0) ?
                      {
                        "events": body.errors.map(error,
                          {
                            "error": {
                              "code": string(error.code),
                              "id": string(error.code),
                              "message": string(error.message),
                            },
                          }
                        ),
                        "next": {},
                        "want_more": false,
                      }
                    :
                      {
                        "events": has(body.resources) ?
                          body.resources.map(e,
                            {
                              "message": e.encode_json(),
                            }
                          )
                        :
                          [],
                        "next": {
                          ?"page_token": (body.?meta.pagination.after.orValue("") != "") ?
                            optional.of(body.meta.pagination.after)
                          :
                            optional.none(),
                        },
                        "cursor": {
                          // The API response is sorted chronologically based on the last updated timestamp,
                          // in the next interval we start from the last event (newest) time.
                          ?"last_timestamp": (has(body.resources) && body.resources.size() > 0) ?
                            optional.of(timestamp(body.resources[size(body.resources) - 1].updated_timestamp).format(time_layout.RFC3339))
                          :
                            state.?cursor.last_timestamp,
                        },
                        "want_more": body.?meta.pagination.after.orValue("") != "",
                      }
                  )
                :
                  {
                    "events": {
                      "error": {
                        "code": string(resp.StatusCode),
                        "id": string(resp.Status),
                        "message": "GET " + state.url.trim_right("/") + "/spotlight/combined/vulnerabilities/v1:" + (
                          (size(resp.Body) != 0) ?
                            string(resp.Body)
                          :
                            string(resp.Status) + " (" + string(resp.StatusCode) + ")"
                        ),
                      },
                    },
                    "next": {},
                    "want_more": false,
                  }
                )
              )
            )
          publisher_pipeline.disable_host: true
          redact:
            fields: null
          resource.ssl: null
          resource.timeout: 30s
          resource.tracer:
            enabled: false
            filename: ../../logs/cel/http-request-trace-*.ndjson
            maxbackups: 5
          resource.url: http://host.tld
          state:
            batch_size: 5000
            facet: host_info,remediation,cve,evaluation_logic
            initial_interval: 2160h
          tags:
            - preserve_original_event
            - preserve_duplicate_custom_fields
            - forwarded
            - crowdstrike-vulnerability
      type: cel
      use_output: default
output_permissions:
    default:
        _elastic_agent_checks:
            cluster:
                - monitor
        _elastic_agent_monitoring:
            indices: []
        uuid-for-permissions-on-related-indices:
            indices:
                - names:
                    - logs-crowdstrike.vulnerability-ep
                  privileges:
                    - auto_configure
                    - create_doc
secret_references:
    - {}
