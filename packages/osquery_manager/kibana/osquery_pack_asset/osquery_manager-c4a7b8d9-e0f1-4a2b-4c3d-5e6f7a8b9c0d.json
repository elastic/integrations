{
    "attributes": {
        "description": "Forensic pack for data exfiltration and collection detection â€” shell/PowerShell history, suspicious browser activity, and disk information.",
        "name": "forensic-data-exfiltration",
        "version": 1,
        "queries": [
            {
                "id": "powershell_history_windows_elastic",
                "query": "-- Comprehensive PowerShell Forensic Monitoring Query (Hybrid Approach)\n-- Uses powershell_events for Event ID 4104 (Script Block Logging) with automatic reconstruction\n-- Uses windows_eventlog for Event ID 4103 (Module Logging) and 4688 (Process Creation)\n-- Focus: Fileless malware detection, obfuscated command tracking\n-- Last updated: 2025-12-09\n--\n-- PREREQUISITES:\n-- 1. Windows Script Block Logging must be enabled (GPO or registry)\n-- 2. Elastic Agent osquery integration requires this config in Fleet policy:\n--    { \"options\": { \"disable_events\": \"false\", \"enable_powershell_events_subscriber\": \"true\", \"enable_windows_events_subscriber\": \"true\" } }\n--\n-- PERFORMANCE TIP: For large environments, add time filter to powershell_events:\n-- WHERE time > (strftime('%s', 'now') - 86400)  -- last 24 hours\n\n-- Part 1: Script Block Logging (Event ID 4104) via powershell_events\n-- Benefits: Automatic script reconstruction across fragmented blocks\nSELECT\n    datetime AS event_time,\n    time,\n    4104 AS eventid,\n    'Microsoft-Windows-PowerShell' AS provider_name,\n    NULL AS level,\n    NULL AS task,\n    NULL AS computer_name,\n    'Microsoft-Windows-PowerShell/Operational' AS channel,\n    NULL AS pid,\n    NULL AS tid,\n    NULL AS data,\n    NULL AS ps_provider_name,\n    NULL AS context_info,\n    NULL AS payload,\n    script_block_id,\n    script_block_count,\n    script_text,\n    script_name,\n    script_path,\n    NULL AS command_line,\n    NULL AS process_name,\n    NULL AS parent_process_name\nFROM powershell_events\n\nUNION ALL\n\n-- Part 2: Module Logging (Event ID 4103) via windows_eventlog\n-- Captures obfuscated command context and payload\nSELECT\n    datetime AS event_time,\n    NULL AS time,\n    eventid,\n    provider_name,\n    level,\n    task,\n    computer_name,\n    channel,\n    pid,\n    tid,\n    data,\n    json_extract(data, '$.EventData.ProviderName') AS ps_provider_name,\n    json_extract(data, '$.EventData.ContextInfo') AS context_info,\n    json_extract(data, '$.EventData.Payload') AS payload,\n    NULL AS script_block_id,\n    NULL AS script_block_count,\n    NULL AS script_text,\n    NULL AS script_name,\n    NULL AS script_path,\n    NULL AS command_line,\n    NULL AS process_name,\n    NULL AS parent_process_name\nFROM windows_eventlog\nWHERE \n    channel = 'Microsoft-Windows-PowerShell/Operational'\n    AND eventid = 4103\n\nUNION ALL\n\n-- Part 3: Process Creation (Event ID 4688) via windows_eventlog\n-- Captures command line and parent/child process relationships\nSELECT\n    datetime AS event_time,\n    NULL AS time,\n    eventid,\n    provider_name,\n    level,\n    task,\n    computer_name,\n    channel,\n    pid,\n    tid,\n    data,\n    NULL AS ps_provider_name,\n    NULL AS context_info,\n    NULL AS payload,\n    NULL AS script_block_id,\n    NULL AS script_block_count,\n    NULL AS script_text,\n    NULL AS script_name,\n    NULL AS script_path,\n    json_extract(data, '$.EventData.CommandLine') AS command_line,\n    json_extract(data, '$.EventData.NewProcessName') AS process_name,\n    json_extract(data, '$.EventData.ParentProcessName') AS parent_process_name\nFROM windows_eventlog\nWHERE \n    channel = 'Security'\n    AND eventid = 4688\n    AND data LIKE '%powershell%'\n\nORDER BY event_time DESC;",
                "interval": 300,
                "platform": "windows",
                "timeout": 180,
                "ecs_mapping": [
                    {
                        "key": "event.category",
                        "value": {
                            "value": [
                                "process"
                            ]
                        }
                    },
                    {
                        "key": "event.type",
                        "value": {
                            "value": [
                                "info"
                            ]
                        }
                    },
                    {
                        "key": "event.action",
                        "value": {
                            "value": "osquery.powershell_history"
                        }
                    },
                    {
                        "key": "event.created",
                        "value": {
                            "field": "event_time"
                        }
                    },
                    {
                        "key": "event.code",
                        "value": {
                            "field": "eventid"
                        }
                    },
                    {
                        "key": "event.provider",
                        "value": {
                            "field": "provider_name"
                        }
                    },
                    {
                        "key": "log.level",
                        "value": {
                            "field": "level"
                        }
                    },
                    {
                        "key": "process.pid",
                        "value": {
                            "field": "pid"
                        }
                    },
                    {
                        "key": "process.thread.id",
                        "value": {
                            "field": "tid"
                        }
                    },
                    {
                        "key": "powershell.provider.name",
                        "value": {
                            "field": "ps_provider_name"
                        }
                    },
                    {
                        "key": "powershell.context_info",
                        "value": {
                            "field": "context_info"
                        }
                    },
                    {
                        "key": "powershell.payload",
                        "value": {
                            "field": "payload"
                        }
                    },
                    {
                        "key": "powershell.file.script_block_id",
                        "value": {
                            "field": "script_block_id"
                        }
                    },
                    {
                        "key": "powershell.file.script_block_count",
                        "value": {
                            "field": "script_block_count"
                        }
                    },
                    {
                        "key": "powershell.file.script_block_text",
                        "value": {
                            "field": "script_text"
                        }
                    },
                    {
                        "key": "file.name",
                        "value": {
                            "field": "script_name"
                        }
                    },
                    {
                        "key": "file.path",
                        "value": {
                            "field": "script_path"
                        }
                    },
                    {
                        "key": "process.command_line",
                        "value": {
                            "field": "command_line"
                        }
                    },
                    {
                        "key": "process.name",
                        "value": {
                            "field": "process_name"
                        }
                    },
                    {
                        "key": "process.parent.name",
                        "value": {
                            "field": "parent_process_name"
                        }
                    },
                    {
                        "key": "tags",
                        "value": {
                            "value": [
                                "osquery",
                                "powershell",
                                "execution",
                                "windows"
                            ]
                        }
                    }
                ]
            },
            {
                "id": "shell_history_linux_darwin_elastic",
                "query": "-- Shell History - Command Execution Forensics with Anti-Forensics Detection\n-- Platforms: Linux, macOS\n-- Uses LEFT JOIN to detect users with no shell history (anti-forensics indicator)\n-- Note: UID >= 500 captures regular users on both macOS (500+) and Linux (1000+)\n-- Note: Look for suspicious patterns and users with no_history_suspicious='yes'\nSELECT\n  u.username,\n  u.uid,\n  u.gid,\n  u.directory AS user_home,\n  sh.command,\n  sh.history_file,\n  CASE\n    WHEN sh.history_file LIKE '%bash_history%' THEN 'bash'\n    WHEN sh.history_file LIKE '%zsh_history%' THEN 'zsh'\n    WHEN sh.history_file LIKE '%fish_history%' THEN 'fish'\n    WHEN sh.history_file LIKE '%ash_history%' THEN 'ash'\n    WHEN sh.history_file LIKE '%ksh_history%' THEN 'ksh'\n    WHEN sh.history_file LIKE '%tcsh_history%' OR sh.history_file LIKE '%.history%' THEN 'tcsh'\n    WHEN sh.history_file LIKE '%csh_history%' THEN 'csh'\n    ELSE 'unknown'\n  END AS shell_type,\n  CASE\n    WHEN sh.command IS NULL THEN 'yes'\n    ELSE 'no'\n  END AS no_history_suspicious\nFROM users u\nLEFT JOIN shell_history sh ON sh.uid = u.uid\nWHERE (u.uid >= 500 OR sh.command IS NOT NULL)\n  AND (sh.command IS NULL OR sh.command != '')\nORDER BY u.username, sh.time DESC",
                "interval": 3600,
                "platform": "linux,darwin",
                "timeout": 180,
                "ecs_mapping": [
                    {
                        "key": "event.category",
                        "value": {
                            "value": [
                                "process"
                            ]
                        }
                    },
                    {
                        "key": "event.type",
                        "value": {
                            "value": [
                                "info"
                            ]
                        }
                    },
                    {
                        "key": "event.action",
                        "value": {
                            "value": "osquery.shell_history"
                        }
                    },
                    {
                        "key": "user.name",
                        "value": {
                            "field": "username"
                        }
                    },
                    {
                        "key": "user.id",
                        "value": {
                            "field": "uid"
                        }
                    },
                    {
                        "key": "user.group.id",
                        "value": {
                            "field": "gid"
                        }
                    },
                    {
                        "key": "process.command_line",
                        "value": {
                            "field": "command"
                        }
                    },
                    {
                        "key": "file.path",
                        "value": {
                            "field": "history_file"
                        }
                    },
                    {
                        "key": "tags",
                        "value": {
                            "value": [
                                "osquery",
                                "shell_history",
                                "forensics",
                                "linux",
                                "macos"
                            ]
                        }
                    }
                ]
            },
            {
                "id": "browser_history_suspicious_elastic",
                "query": "-- Browser history from Elastic osquery extension\n-- Supports: Chrome, Edge, Firefox, Safari\n-- Filters out common legitimate domains (allowlist) to surface suspicious/malicious activity\n-- NOTE: Avoids regex_match() to prevent Windows failures due to the 256-byte regex limit\nWITH\n  allow_suffix(suffix) AS (\n    VALUES\n      -- Search engines\n      ('google.com'), ('googleapis.com'), ('gstatic.com'), ('bing.com'), ('yahoo.com'), ('duckduckgo.com'), ('baidu.com'), ('yandex.ru'),\n      -- Microsoft ecosystem\n      ('microsoft.com'), ('microsoftonline.com'), ('office.com'), ('office365.com'), ('windows.net'), ('windows.com'), ('live.com'), ('outlook.com'), ('azure.com'), ('visualstudio.com'),\n      -- Apple ecosystem\n      ('apple.com'), ('icloud.com'), ('itunes.com'),\n      -- Amazon/AWS\n      ('amazon.com'), ('amazonaws.com'), ('aws.amazon.com'),\n      -- Social media\n      ('facebook.com'), ('fb.com'), ('instagram.com'), ('twitter.com'), ('x.com'), ('linkedin.com'), ('reddit.com'), ('pinterest.com'), ('tiktok.com'), ('snapchat.com'), ('whatsapp.com'), ('discord.com'), ('telegram.org'),\n      -- Video/Streaming\n      ('youtube.com'), ('youtu.be'), ('netflix.com'), ('hulu.com'), ('disneyplus.com'), ('twitch.tv'), ('vimeo.com'), ('spotify.com'), ('soundcloud.com'),\n      -- Shopping/Commerce\n      ('ebay.com'), ('walmart.com'), ('target.com'), ('bestbuy.com'), ('etsy.com'), ('shopify.com'), ('paypal.com'), ('stripe.com'),\n      -- News/Media\n      ('cnn.com'), ('bbc.com'), ('bbc.co.uk'), ('nytimes.com'), ('reuters.com'), ('wsj.com'), ('theguardian.com'), ('forbes.com'), ('bloomberg.com'),\n      -- Cloud/Storage\n      ('dropbox.com'), ('box.com'), ('onedrive.com'), ('drive.google.com'),\n      -- CDN/Infrastructure\n      ('cloudflare.com'), ('akamai.net'), ('akamaized.net'), ('fastly.net'), ('cloudfront.net'), ('azureedge.net'), ('cdnjs.com'), ('jsdelivr.net'), ('unpkg.com'),\n      -- Developer/Tech\n      ('github.com'), ('github.io'), ('gitlab.com'), ('stackoverflow.com'), ('stackexchange.com'), ('npmjs.com'), ('docker.com'), ('atlassian.com'), ('atlassian.net'), ('jira.com'), ('bitbucket.org'), ('mozilla.org'), ('mozilla.com'),\n      -- Business tools\n      ('slack.com'), ('zoom.us'), ('zoom.com'), ('teams.microsoft.com'), ('salesforce.com'), ('hubspot.com'), ('zendesk.com'), ('intercom.com'), ('notion.so'),\n      -- Security vendors\n      ('elastic.co'), ('splunk.com'), ('crowdstrike.com'), ('virustotal.com'), ('malwarebytes.com'), ('norton.com'), ('mcafee.com'), ('kaspersky.com'),\n      -- Other common legitimate\n      ('wikipedia.org'), ('wikimedia.org'), ('archive.org'), ('w3.org'), ('jquery.com'), ('bootstrapcdn.com'), ('fontawesome.com'), ('fonts.googleapis.com'), ('recaptcha.net'), ('googletagmanager.com'), ('google-analytics.com'), ('doubleclick.net'), ('googlesyndication.com')\n  ),\n  -- Handle ccTLD variants that were previously expressed as regex (e.g. google.co.[a-z]{2})\n  allow_glob(pattern) AS (\n    VALUES\n      ('google.co.[a-z][a-z]'), ('*.google.co.[a-z][a-z]'),\n      ('amazon.co.[a-z][a-z]'), ('*.amazon.co.[a-z][a-z]')\n  )\nSELECT\n  datetime AS event_time,\n  url,\n  title,\n  browser,\n  user AS username,\n  domain,\n  transition_type\nFROM elastic_browser_history\nWHERE\n  NOT (\n    EXISTS (\n      SELECT 1\n      FROM allow_suffix s\n      WHERE lower(domain) = s.suffix\n         OR lower(domain) LIKE '%.' || s.suffix\n    )\n    OR EXISTS (\n      SELECT 1\n      FROM allow_glob g\n      WHERE lower(domain) GLOB g.pattern\n    )\n  )\nORDER BY event_time DESC;",
                "interval": 3600,
                "platform": "linux,darwin,windows",
                "ecs_mapping": [
                    {
                        "key": "event.category",
                        "value": {
                            "value": [
                                "web"
                            ]
                        }
                    },
                    {
                        "key": "event.type",
                        "value": {
                            "value": [
                                "access"
                            ]
                        }
                    },
                    {
                        "key": "event.created",
                        "value": {
                            "field": "event_time"
                        }
                    },
                    {
                        "key": "event.action",
                        "value": {
                            "value": "osquery.browser_history_suspicious"
                        }
                    },
                    {
                        "key": "url.full",
                        "value": {
                            "field": "url"
                        }
                    },
                    {
                        "key": "url.domain",
                        "value": {
                            "field": "domain"
                        }
                    },
                    {
                        "key": "user_agent.name",
                        "value": {
                            "field": "browser"
                        }
                    },
                    {
                        "key": "user.name",
                        "value": {
                            "field": "username"
                        }
                    },
                    {
                        "key": "tags",
                        "value": {
                            "value": [
                                "osquery",
                                "browser_history",
                                "forensics",
                                "threat_hunting",
                                "filtered"
                            ]
                        }
                    }
                ]
            },
            {
                "id": "disk_info_windows_elastic",
                "query": "-- Windows physical disk hardware inventory\n-- Source: disk_info table (WMI Win32_DiskDrive)\n-- Use case: Asset inventory, hardware verification\nSELECT\n    disk_index,\n    name,\n    id,\n    pnp_device_id,\n    type,\n    manufacturer AS vendor,\n    hardware_model AS model,\n    serial,\n    description,\n    partitions,\n    disk_size,\n    -- Convert to human-readable size\n    ROUND(disk_size / 1073741824.0, 2) AS disk_size_gb\nFROM disk_info;",
                "interval": 3600,
                "platform": "windows",
                "ecs_mapping": [
                    {
                        "key": "event.category",
                        "value": {
                            "value": [
                                "host"
                            ]
                        }
                    },
                    {
                        "key": "event.type",
                        "value": {
                            "value": [
                                "info"
                            ]
                        }
                    },
                    {
                        "key": "event.action",
                        "value": {
                            "value": "osquery.disk_info"
                        }
                    },
                    {
                        "key": "file.device",
                        "value": {
                            "field": "name"
                        }
                    },
                    {
                        "key": "device.serial_number",
                        "value": {
                            "field": "serial"
                        }
                    },
                    {
                        "key": "device.vendor.name",
                        "value": {
                            "field": "vendor"
                        }
                    },
                    {
                        "key": "device.model.name",
                        "value": {
                            "field": "model"
                        }
                    },
                    {
                        "key": "device.type",
                        "value": {
                            "field": "type"
                        }
                    },
                    {
                        "key": "tags",
                        "value": {
                            "value": [
                                "osquery",
                                "inventory",
                                "disk",
                                "windows"
                            ]
                        }
                    }
                ]
            }
        ]
    },
    "coreMigrationVersion": "9.3.0",
    "id": "osquery_manager-c4a7b8d9-e0f1-4a2b-4c3d-5e6f7a8b9c0d",
    "references": [],
    "type": "osquery-pack-asset"
}
