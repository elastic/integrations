{
    "attributes": {
        "created_at": "2026-01-20T00:00:00.000Z",
        "created_by": "elastic",
        "description": "Comprehensive RDP authentication and session tracking query. Queries Security channel (Event IDs 4624, 4625, 4634, 4647, 4778, 4779 with LogonType 3, 7, 10), TerminalServices-LocalSessionManager (Event IDs 21-25, 39, 40), TerminalServices-RemoteConnectionManager (Event ID 1149), and System channel (Event ID 9009). Detects RDP logons, logoffs, session reconnects/disconnects, and lateral movement.",
        "ecs_mapping": [
            {
                "key": "event.category",
                "value": {
                    "value": ["session"]
                }
            },
            {
                "key": "event.type",
                "value": {
                    "value": ["info"]
                }
            },
            {
                "key": "event.action",
                "value": {
                    "value": "osquery.rdp_authentication"
                }
            },
            {
                "key": "event.code",
                "value": {
                    "field": "eventid"
                }
            },
            {
                "key": "event.created",
                "value": {
                    "field": "event_time"
                }
            },
            {
                "key": "log.level",
                "value": {
                    "field": "level"
                }
            },
            {
                "key": "user.name",
                "value": {
                    "field": "user_name"
                }
            },
            {
                "key": "user.domain",
                "value": {
                    "field": "domain_name"
                }
            },
            {
                "key": "event.reason",
                "value": {
                    "field": "event_description"
                }
            },
            {
                "key": "source.ip",
                "value": {
                    "field": "source_ip"
                }
            },
            {
                "key": "source.port",
                "value": {
                    "field": "source_port"
                }
            },
            {
                "key": "winlog.channel",
                "value": {
                    "field": "channel"
                }
            },
            {
                "key": "winlog.logon.type",
                "value": {
                    "field": "logon_type"
                }
            },
            {
                "key": "winlog.logon.id",
                "value": {
                    "field": "logon_id"
                }
            },
            {
                "key": "winlog.event_data.WorkstationName",
                "value": {
                    "field": "workstation_name"
                }
            },
            {
                "key": "winlog.event_data.LogonProcessName",
                "value": {
                    "field": "logon_process"
                }
            },
            {
                "key": "winlog.event_data.AuthenticationPackageName",
                "value": {
                    "field": "auth_package"
                }
            },
            {
                "key": "winlog.event_data.SubjectUserName",
                "value": {
                    "field": "subject_user"
                }
            },
            {
                "key": "winlog.event_data.SubjectDomainName",
                "value": {
                    "field": "subject_domain"
                }
            },
            {
                "key": "winlog.event_data.Status",
                "value": {
                    "field": "status_code"
                }
            },
            {
                "key": "winlog.event_data.SubStatus",
                "value": {
                    "field": "sub_status_code"
                }
            },
            {
                "key": "winlog.event_data.FailureReason",
                "value": {
                    "field": "failure_reason"
                }
            },
            {
                "key": "process.pid",
                "value": {
                    "field": "pid"
                }
            },
            {
                "key": "tags",
                "value": {
                    "value": ["osquery", "rdp", "authentication", "lateral_movement", "windows"]
                }
            }
        ],
        "id": "rdp_authentication_windows_elastic",
        "interval": "3600",
        "platform": "windows",
        "query": "-- Windows RDP Authentication and Session Events\n-- Coverage: Security, System, and TerminalServices event logs\n--\n-- Security Channel Events:\n--   4624 (LogonType 3,7,10): Successful logon\n--   4625: Failed logon\n--   4634: Logoff\n--   4647: User-initiated logoff\n--   4778: Session reconnect\n--   4779: Session disconnect\n--\n-- TerminalServices-LocalSessionManager/Operational:\n--   21: RDP Local Connected\n--   22: RDP Remote Connected\n--   23: RDP Session Logoff\n--   24: RDP Local Disconnected\n--   25: RDP Remote Reconnection\n--   39: RDP Remote Disconnected (Formal)\n--   40: RDP Remote Disconnected (Reason)\n--\n-- TerminalServices-RemoteConnectionManager/Operational:\n--   1149: RDP Initiation Successful\n--\n-- System Channel:\n--   9009: Desktop Window Manager Closed\n\n-- Part 1: Security Channel - Authentication Events\nSELECT\n    datetime AS event_time,\n    computer_name,\n    'Security' AS channel,\n    eventid,\n    provider_name,\n    level,\n    json_extract(data, '$.EventData.TargetDomainName') AS domain_name,\n    json_extract(data, '$.EventData.TargetUserName') AS user_name,\n    json_extract(data, '$.EventData.LogonType') AS logon_type,\n    json_extract(data, '$.EventData.IpAddress') AS source_ip,\n    json_extract(data, '$.EventData.IpPort') AS source_port,\n    json_extract(data, '$.EventData.WorkstationName') AS workstation_name,\n    json_extract(data, '$.EventData.LogonProcessName') AS logon_process,\n    json_extract(data, '$.EventData.AuthenticationPackageName') AS auth_package,\n    json_extract(data, '$.EventData.TargetLogonId') AS logon_id,\n    json_extract(data, '$.EventData.SubjectUserName') AS subject_user,\n    json_extract(data, '$.EventData.SubjectDomainName') AS subject_domain,\n    json_extract(data, '$.EventData.Status') AS status_code,\n    json_extract(data, '$.EventData.SubStatus') AS sub_status_code,\n    json_extract(data, '$.EventData.FailureReason') AS failure_reason,\n    CASE\n        WHEN eventid = 4624 AND json_extract(data, '$.EventData.LogonType') = '10' THEN 'RDP_LOGON_SUCCESSFUL_NEW'\n        WHEN eventid = 4624 AND json_extract(data, '$.EventData.LogonType') = '3' THEN 'LOGON_SUCCESSFUL_NETWORK'\n        WHEN eventid = 4624 AND json_extract(data, '$.EventData.LogonType') = '7' THEN 'LOGON_SUCCESSFUL_UNLOCK'\n        WHEN eventid = 4625 AND json_extract(data, '$.EventData.LogonType') = '10' THEN 'RDP_LOGON_FAILED'\n        WHEN eventid = 4625 AND json_extract(data, '$.EventData.LogonType') = '3' THEN 'LOGON_FAILED_NETWORK'\n        WHEN eventid = 4634 THEN 'LOGOFF_DISCONNECT'\n        WHEN eventid = 4647 THEN 'USER_INITIATED_LOGOFF'\n        WHEN eventid = 4778 THEN 'SESSION_RECONNECTED'\n        WHEN eventid = 4779 THEN 'SESSION_DISCONNECTED'\n        ELSE 'UNKNOWN_' || eventid\n    END AS event_description,\n    pid,\n    data\nFROM windows_eventlog\nWHERE \n    channel = 'Security'\n    AND (\n        (eventid IN (4624, 4634) AND json_extract(data, '$.EventData.LogonType') IN ('3', '7', '10'))\n        OR eventid IN (4778, 4625, 4779, 4647)\n    )\n\nUNION ALL\n\n-- Part 2: TerminalServices-LocalSessionManager - RDP Session Events\nSELECT\n    datetime AS event_time,\n    computer_name,\n    'Microsoft-Windows-TerminalServices-LocalSessionManager/Operational' AS channel,\n    eventid,\n    provider_name,\n    level,\n    COALESCE(\n        SUBSTR(json_extract(data, '$.UserData.EventXML.User'), 1, INSTR(json_extract(data, '$.UserData.EventXML.User'), '\\\\') - 1),\n        json_extract(data, '$.UserData.EventXML.Param2')\n    ) AS domain_name,\n    COALESCE(\n        SUBSTR(json_extract(data, '$.UserData.EventXML.User'), INSTR(json_extract(data, '$.UserData.EventXML.User'), '\\\\') + 1),\n        json_extract(data, '$.UserData.EventXML.Param1')\n    ) AS user_name,\n    NULL AS logon_type,\n    COALESCE(\n        json_extract(data, '$.UserData.EventXML.Address'),\n        json_extract(data, '$.UserData.EventXML.Param3')\n    ) AS source_ip,\n    NULL AS source_port,\n    NULL AS workstation_name,\n    NULL AS logon_process,\n    NULL AS auth_package,\n    json_extract(data, '$.UserData.EventXML.SessionID') AS logon_id,\n    NULL AS subject_user,\n    NULL AS subject_domain,\n    NULL AS status_code,\n    NULL AS sub_status_code,\n    json_extract(data, '$.UserData.EventXML.Reason') AS failure_reason,\n    CASE eventid\n        WHEN 21 THEN 'RDP_LOCAL_CONNECTED'\n        WHEN 22 THEN 'RDP_REMOTE_CONNECTED'\n        WHEN 23 THEN 'RDP_SESSION_LOGOFF'\n        WHEN 24 THEN 'RDP_LOCAL_DISCONNECTED'\n        WHEN 25 THEN 'RDP_REMOTE_RECONNECTION'\n        WHEN 39 THEN 'RDP_REMOTE_DISCONNECTED_FORMAL'\n        WHEN 40 THEN 'RDP_REMOTE_DISCONNECTED_REASON'\n        ELSE 'UNKNOWN_TSL_' || eventid\n    END AS event_description,\n    pid,\n    data\nFROM windows_eventlog\nWHERE \n    channel = 'Microsoft-Windows-TerminalServices-LocalSessionManager/Operational'\n    AND eventid IN (21, 22, 23, 24, 25, 39, 40)\n\nUNION ALL\n\n-- Part 3: TerminalServices-RemoteConnectionManager - RDP Initiation\nSELECT\n    datetime AS event_time,\n    computer_name,\n    'Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational' AS channel,\n    eventid,\n    provider_name,\n    level,\n    json_extract(data, '$.UserData.EventXML.Param2') AS domain_name,\n    json_extract(data, '$.UserData.EventXML.Param1') AS user_name,\n    NULL AS logon_type,\n    json_extract(data, '$.UserData.EventXML.Param3') AS source_ip,\n    NULL AS source_port,\n    NULL AS workstation_name,\n    NULL AS logon_process,\n    NULL AS auth_package,\n    NULL AS logon_id,\n    NULL AS subject_user,\n    NULL AS subject_domain,\n    NULL AS status_code,\n    NULL AS sub_status_code,\n    NULL AS failure_reason,\n    'RDP_INITIATION_SUCCESSFUL' AS event_description,\n    pid,\n    data\nFROM windows_eventlog\nWHERE \n    channel = 'Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational'\n    AND eventid = 1149\n\nUNION ALL\n\n-- Part 4: System Channel - Desktop Window Manager Closed\nSELECT\n    datetime AS event_time,\n    computer_name,\n    'System' AS channel,\n    eventid,\n    provider_name,\n    level,\n    NULL AS domain_name,\n    NULL AS user_name,\n    NULL AS logon_type,\n    NULL AS source_ip,\n    NULL AS source_port,\n    NULL AS workstation_name,\n    NULL AS logon_process,\n    NULL AS auth_package,\n    NULL AS logon_id,\n    NULL AS subject_user,\n    NULL AS subject_domain,\n    NULL AS status_code,\n    NULL AS sub_status_code,\n    NULL AS failure_reason,\n    'DESKTOPWINDOWMANAGER_CLOSED' AS event_description,\n    pid,\n    data\nFROM windows_eventlog\nWHERE \n    channel = 'System'\n    AND eventid = 9009\n\nORDER BY event_time DESC;",
        "updated_at": "2026-01-20T00:00:00.000Z",
        "updated_by": "elastic",
        "version": "1.0.0"
    },
    "coreMigrationVersion": "9.3.0",
    "id": "osquery_manager-d8d79510-6f58-44e1-b7fc-63a073158096",
    "references": [],
    "type": "osquery-saved-query",
    "updated_at": "2026-01-20T00:00:00.000Z",
    "version": "WzEsMV0="
}
