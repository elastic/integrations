{
    "attributes": {
        "created_at": "2025-11-20T00:00:00.000Z",
        "created_by": "elastic",
        "description": "Comprehensive Windows LNK shortcut file forensics across all critical locations: user/system Startup folders (persistence), Desktop folders, Recent Items (user activity), Quick Launch, SendTo menu, and Start Menu Programs. Enriched with hash values for LNK files themselves. Detects risky executables, suspicious command-line arguments (encoded commands, download cradles, UNC paths, hidden windows), and large LNK files. Uses the users table to dynamically enumerate all user directories. KNOWN LIMITATION: shortcut_target_path and dependent fields (process.executable, process.command_line, file.code_signature.*, registry.path, user.id) may return empty due to osquery parsing issue; these will auto-populate when osquery fixes the bug. Location-based detection, file timestamps, and LNK file hashes remain fully functional. RELATED QUERY: Use lnk_yara_detection_windows_elastic for content-based YARA scanning that detects malicious patterns directly in LNK binary content, bypassing shortcut_target_path limitations.",
        "ecs_mapping": [
            {
                "key": "file.path",
                "value": {
                    "field": "path"
                }
            },
            {
                "key": "file.name",
                "value": {
                    "field": "filename"
                }
            },
            {
                "key": "file.directory",
                "value": {
                    "field": "directory"
                }
            },
            {
                "key": "file.size",
                "value": {
                    "field": "size"
                }
            },
            {
                "key": "file.created",
                "value": {
                    "field": "btime"
                }
            },
            {
                "key": "file.mtime",
                "value": {
                    "field": "mtime"
                }
            },
            {
                "key": "file.accessed",
                "value": {
                    "field": "atime"
                }
            },
            {
                "key": "file.ctime",
                "value": {
                    "field": "ctime"
                }
            },
            {
                "key": "file.type",
                "value": {
                    "field": "type"
                }
            },
            {
                "key": "file.hash.md5",
                "value": {
                    "field": "md5"
                }
            },
            {
                "key": "file.hash.sha1",
                "value": {
                    "field": "sha1"
                }
            },
            {
                "key": "file.hash.sha256",
                "value": {
                    "field": "sha256"
                }
            },
            {
                "key": "file.extension",
                "value": {
                    "field": "extension"
                }
            },
            {
                "key": "file.code_signature.subject_name",
                "value": {
                    "field": "authenticode_subject"
                }
            },
            {
                "key": "file.code_signature.issuer",
                "value": {
                    "field": "authenticode_issuer"
                }
            },
            {
                "key": "file.code_signature.status",
                "value": {
                    "field": "authenticode_result"
                }
            },
            {
                "key": "process.executable",
                "value": {
                    "field": "shortcut_target_path"
                }
            },
            {
                "key": "process.command_line",
                "value": {
                    "field": "combined_command"
                }
            },
            {
                "key": "user.id",
                "value": {
                    "field": "shellbags_sid"
                }
            },
            {
                "key": "registry.path",
                "value": {
                    "field": "shellbags_source"
                }
            }
        ],
        "id": "lnk_forensics_windows_elastic",
        "interval": "3600",
        "platform": "windows",
        "query": "-- Windows LNK Shortcut File Forensics with Suspicious Pattern Detection + Shellbags Enrichment\n-- Source: file table with native Windows shortcut parsing + shellbags registry data + authenticode signatures\n-- Focus: Risky executables, malicious arguments, large files, persistence mechanisms\n-- Scope: Comprehensive coverage of forensically significant LNK locations (startup, desktop, recent, quick launch, sendto, start menu)\n-- Related: Use lnk_yara_detection_windows_elastic for content-based YARA scanning of LNK binary patterns\n-- Note: shortcut_target_path may return empty due to osquery parsing issue; YARA query bypasses this limitation\n\nWITH user_lnk_paths AS (\n    -- Per-user LNK locations\n    SELECT \n        u.username,\n        u.directory || '\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup' AS user_startup,\n        u.directory || '\\Desktop' AS user_desktop,\n        u.directory || '\\AppData\\Roaming\\Microsoft\\Windows\\Recent' AS user_recent,\n        u.directory || '\\AppData\\Roaming\\Microsoft\\Internet Explorer\\Quick Launch' AS user_quicklaunch,\n        u.directory || '\\AppData\\Roaming\\Microsoft\\Windows\\SendTo' AS user_sendto,\n        u.directory || '\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs' AS user_startmenu\n    FROM users u\n    WHERE u.directory LIKE 'C:\\Users\\%'\n      AND u.username NOT IN ('Default', 'Default User', 'Public', 'All Users')\n),\nlnk_files AS (\n    -- User Startup folders (highest priority - persistence)\n    SELECT f.*, 'user_startup' AS location_type\n    FROM user_lnk_paths p\n    CROSS JOIN file f\n    WHERE f.directory = p.user_startup AND f.filename LIKE '%.lnk'\n    \n    UNION ALL\n    \n    -- System-wide Startup folder (persistence)\n    SELECT f.*, 'system_startup' AS location_type\n    FROM file f\n    WHERE f.directory = 'C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup'\n      AND f.filename LIKE '%.lnk'\n    \n    UNION ALL\n    \n    -- User Desktop folders\n    SELECT f.*, 'user_desktop' AS location_type\n    FROM user_lnk_paths p\n    CROSS JOIN file f\n    WHERE f.directory = p.user_desktop AND f.filename LIKE '%.lnk'\n    \n    UNION ALL\n    \n    -- Public Desktop\n    SELECT f.*, 'public_desktop' AS location_type\n    FROM file f\n    WHERE f.directory = 'C:\\Users\\Public\\Desktop'\n      AND f.filename LIKE '%.lnk'\n    \n    UNION ALL\n    \n    -- Recent Items (user activity tracking)\n    SELECT f.*, 'recent_items' AS location_type\n    FROM user_lnk_paths p\n    CROSS JOIN file f\n    WHERE f.directory = p.user_recent AND f.filename LIKE '%.lnk'\n    \n    UNION ALL\n    \n    -- Quick Launch\n    SELECT f.*, 'quick_launch' AS location_type\n    FROM user_lnk_paths p\n    CROSS JOIN file f\n    WHERE f.directory = p.user_quicklaunch AND f.filename LIKE '%.lnk'\n    \n    UNION ALL\n    \n    -- SendTo menu\n    SELECT f.*, 'sendto' AS location_type\n    FROM user_lnk_paths p\n    CROSS JOIN file f\n    WHERE f.directory = p.user_sendto AND f.filename LIKE '%.lnk'\n    \n    UNION ALL\n    \n    -- Start Menu Programs (user)\n    SELECT f.*, 'user_startmenu' AS location_type\n    FROM user_lnk_paths p\n    CROSS JOIN file f\n    WHERE f.directory = p.user_startmenu AND f.filename LIKE '%.lnk'\n    \n    UNION ALL\n    \n    -- Start Menu Programs (system-wide)\n    SELECT f.*, 'system_startmenu' AS location_type\n    FROM file f\n    WHERE f.directory = 'C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs'\n      AND f.filename LIKE '%.lnk'\n),\nlnk_enriched AS (\n    SELECT\n        lnk.path,\n        lnk.filename,\n        lnk.directory,\n        lnk.size,\n        lnk.btime,\n        lnk.mtime,\n        lnk.atime,\n        lnk.ctime,\n        lnk.type,\n        lnk.shortcut_target_path,\n        lnk.shortcut_target_type,\n        lnk.shortcut_target_location,\n        lnk.shortcut_start_in,\n        lnk.shortcut_run,\n        lnk.shortcut_comment,\n        lnk.location_type,\n        'lnk' AS extension,\n        CASE \n            WHEN lnk.shortcut_target_path IS NOT NULL AND lnk.shortcut_comment IS NOT NULL \n            THEN lnk.shortcut_target_path || ' ' || lnk.shortcut_comment\n            WHEN lnk.shortcut_target_path IS NOT NULL \n            THEN lnk.shortcut_target_path\n            ELSE lnk.shortcut_comment\n        END AS combined_command\n    FROM lnk_files lnk\n)\nSELECT \n    lnk.path,\n    lnk.filename,\n    lnk.directory,\n    lnk.size,\n    lnk.btime,\n    lnk.mtime,\n    lnk.atime,\n    lnk.ctime,\n    lnk.type,\n    lnk.shortcut_target_path,\n    lnk.shortcut_target_type,\n    lnk.shortcut_target_location,\n    lnk.shortcut_start_in,\n    lnk.shortcut_run,\n    lnk.shortcut_comment,\n    lnk.combined_command,\n    lnk.location_type,\n    lnk.extension,\n    h.md5,\n    h.sha1,\n    h.sha256,\n    a.subject_name AS authenticode_subject,\n    a.issuer_name AS authenticode_issuer,\n    a.result AS authenticode_result,\n    a.serial_number AS authenticode_serial,\n    sb.sid AS shellbags_sid,\n    sb.source AS shellbags_source,\n    sb.modified_time AS shellbags_modified_time,\n    sb.created_time AS shellbags_created_time,\n    sb.accessed_time AS shellbags_accessed_time,\n    sb.mft_entry AS shellbags_mft_entry,\n    CASE WHEN lnk.size > 20000 THEN 1 ELSE 0 END AS large_size_flag,\n    CASE WHEN lnk.location_type IN ('user_startup', 'system_startup') THEN 1 ELSE 0 END AS startup_persistence_flag,\n    CASE \n        WHEN lnk.shortcut_target_path LIKE '%\\cmd.exe' \n            OR lnk.shortcut_target_path LIKE '%\\powershell.exe'\n            OR lnk.shortcut_target_path LIKE '%\\pwsh.exe'\n            OR lnk.shortcut_target_path LIKE '%\\cscript.exe'\n            OR lnk.shortcut_target_path LIKE '%\\wscript.exe'\n            OR lnk.shortcut_target_path LIKE '%\\rundll32.exe'\n            OR lnk.shortcut_target_path LIKE '%\\regsvr32.exe'\n            OR lnk.shortcut_target_path LIKE '%\\mshta.exe'\n            OR lnk.shortcut_target_path LIKE '%\\wmic.exe'\n            OR lnk.shortcut_target_path LIKE '%\\conhost.exe'\n            OR lnk.shortcut_target_path LIKE '%\\certutil.exe'\n            OR lnk.shortcut_target_path LIKE '%\\bitsadmin.exe'\n        THEN 1 ELSE 0 \n    END AS risky_executable_flag,\n    CASE \n        WHEN lnk.combined_command LIKE '%\\AppData\\%'\n            OR lnk.combined_command LIKE '%\\Users\\Public\\%'\n            OR lnk.combined_command LIKE '%\\Temp\\%'\n            OR lnk.combined_command LIKE '%comspec%'\n            OR lnk.combined_command LIKE '%&cd&echo%'\n            OR lnk.combined_command LIKE '% -NoP %'\n            OR lnk.combined_command LIKE '% -nop %'\n            OR lnk.combined_command LIKE '% -W Hidden %'\n            OR lnk.combined_command LIKE '% -w hidden %'\n            OR lnk.combined_command LIKE '% -WindowStyle Hidden %'\n            OR lnk.combined_command LIKE '% -decode %'\n            OR lnk.combined_command LIKE '% /decode %'\n            OR lnk.combined_command LIKE '% -e %JAB%'\n            OR lnk.combined_command LIKE '% -e %SUVYI%'\n            OR lnk.combined_command LIKE '% -e %SQBFAFgA%'\n            OR lnk.combined_command LIKE '% -e %aWV4I%'\n            OR lnk.combined_command LIKE '% -e %aQBlAHgA%'\n            OR lnk.combined_command LIKE '% -enc %'\n            OR lnk.combined_command LIKE '% -EncodedCommand %'\n            OR lnk.combined_command LIKE '%start /b%'\n            OR lnk.combined_command LIKE '%start \\b%'\n            OR lnk.combined_command LIKE '%.downloadstring(%'\n            OR lnk.combined_command LIKE '%.downloadfile(%'\n            OR lnk.combined_command LIKE '%Invoke-WebRequest%'\n            OR lnk.combined_command LIKE '%iwr %'\n            OR lnk.combined_command LIKE '%iex %'\n            OR lnk.combined_command LIKE '%Invoke-Expression%'\n        THEN 1 ELSE 0\n    END AS suspicious_arguments_flag,\n    CASE \n        WHEN lnk.combined_command LIKE '%http://%'\n            OR lnk.combined_command LIKE '%https://%'\n            OR lnk.combined_command LIKE '%ftp://%'\n            OR lnk.combined_command LIKE '%ftps://%'\n        THEN 1 ELSE 0\n    END AS http_download_flag,\n    CASE \n        WHEN lnk.combined_command LIKE '% \\\\\\\\%'\n            OR lnk.shortcut_start_in LIKE '\\\\\\\\%'\n        THEN 1 ELSE 0\n    END AS unc_path_flag,\n    CASE \n        WHEN LENGTH(lnk.shortcut_comment) > 250 \n        THEN 1 ELSE 0\n    END AS large_arguments_flag\nFROM lnk_enriched lnk\nLEFT JOIN hash h ON lnk.path = h.path\nLEFT JOIN authenticode a ON a.path = lnk.shortcut_target_path\nLEFT JOIN shellbags sb ON sb.path = lnk.shortcut_start_in\nWHERE (\n    -- Always include startup locations (persistence focus)\n    lnk.location_type IN ('user_startup', 'system_startup')\n    -- For other locations, filter for suspicious indicators\n    OR lnk.size > 20000\n    OR lnk.shortcut_target_path LIKE '%\\cmd.exe'\n    OR lnk.shortcut_target_path LIKE '%\\powershell.exe'\n    OR lnk.shortcut_target_path LIKE '%\\pwsh.exe'\n    OR lnk.shortcut_target_path LIKE '%\\cscript.exe'\n    OR lnk.shortcut_target_path LIKE '%\\wscript.exe'\n    OR lnk.shortcut_target_path LIKE '%\\rundll32.exe'\n    OR lnk.shortcut_target_path LIKE '%\\regsvr32.exe'\n    OR lnk.shortcut_target_path LIKE '%\\mshta.exe'\n    OR lnk.shortcut_target_path LIKE '%\\wmic.exe'\n    OR lnk.shortcut_target_path LIKE '%\\conhost.exe'\n    OR lnk.shortcut_target_path LIKE '%\\certutil.exe'\n    OR lnk.shortcut_target_path LIKE '%\\bitsadmin.exe'\n    OR lnk.combined_command LIKE '%\\AppData\\%'\n    OR lnk.combined_command LIKE '%\\Users\\Public\\%'\n    OR lnk.combined_command LIKE '%\\Temp\\%'\n    OR lnk.combined_command LIKE '%comspec%'\n    OR lnk.combined_command LIKE '%&cd&echo%'\n    OR lnk.combined_command LIKE '% -NoP %'\n    OR lnk.combined_command LIKE '% -nop %'\n    OR lnk.combined_command LIKE '% -W Hidden %'\n    OR lnk.combined_command LIKE '% -w hidden %'\n    OR lnk.combined_command LIKE '% -WindowStyle Hidden %'\n    OR lnk.combined_command LIKE '% -decode %'\n    OR lnk.combined_command LIKE '% /decode %'\n    OR lnk.combined_command LIKE '% -e %JAB%'\n    OR lnk.combined_command LIKE '% -e %SUVYI%'\n    OR lnk.combined_command LIKE '% -e %SQBFAFgA%'\n    OR lnk.combined_command LIKE '% -e %aWV4I%'\n    OR lnk.combined_command LIKE '% -e %aQBlAHgA%'\n    OR lnk.combined_command LIKE '% -enc %'\n    OR lnk.combined_command LIKE '% -EncodedCommand %'\n    OR lnk.combined_command LIKE '%start /b%'\n    OR lnk.combined_command LIKE '%start \\b%'\n    OR lnk.combined_command LIKE '%.downloadstring(%'\n    OR lnk.combined_command LIKE '%.downloadfile(%'\n    OR lnk.combined_command LIKE '%Invoke-WebRequest%'\n    OR lnk.combined_command LIKE '%iwr %'\n    OR lnk.combined_command LIKE '%iex %'\n    OR lnk.combined_command LIKE '%Invoke-Expression%'\n    OR lnk.combined_command LIKE '%http://%'\n    OR lnk.combined_command LIKE '%https://%'\n    OR lnk.combined_command LIKE '%ftp://%'\n    OR lnk.combined_command LIKE '%ftps://%'\n    OR lnk.combined_command LIKE '% \\\\\\\\%'\n    OR lnk.shortcut_start_in LIKE '\\\\\\\\%'\n    OR LENGTH(lnk.shortcut_comment) > 250\n)\n-- Exclude common legitimate shortcuts (noise reduction)\nAND lnk.filename NOT IN (\n    'Excel.lnk', 'Word.lnk', 'PowerPoint.lnk', 'Outlook.lnk', 'OneNote.lnk',\n    'Access.lnk', 'Publisher.lnk', 'Visio.lnk', 'Project.lnk', 'Teams.lnk',\n    'Windows Media Player.lnk', 'Windows Explorer.lnk', 'Internet Explorer.lnk',\n    'Microsoft Edge.lnk', 'Google Chrome.lnk', 'Firefox.lnk', 'Safari.lnk',\n    'Notepad.lnk', 'Calculator.lnk', 'Paint.lnk', 'Snipping Tool.lnk',\n    'Control Panel.lnk', 'Task Manager.lnk', 'File Explorer.lnk',\n    'Visual Studio Code.lnk', 'Visual Studio.lnk', 'Slack.lnk', 'Zoom.lnk',\n    'Adobe Acrobat.lnk', 'Adobe Reader.lnk', 'Spotify.lnk', 'Discord.lnk'\n)\nORDER BY \n    -- Priority: Startup locations first\n    CASE WHEN lnk.location_type IN ('user_startup', 'system_startup') THEN 1 ELSE 2 END,\n    -- Then by risky executable\n    CASE \n        WHEN lnk.shortcut_target_path LIKE '%\\cmd.exe' \n            OR lnk.shortcut_target_path LIKE '%\\powershell.exe'\n            OR lnk.shortcut_target_path LIKE '%\\pwsh.exe'\n            OR lnk.shortcut_target_path LIKE '%\\cscript.exe'\n            OR lnk.shortcut_target_path LIKE '%\\wscript.exe'\n            OR lnk.shortcut_target_path LIKE '%\\rundll32.exe'\n            OR lnk.shortcut_target_path LIKE '%\\regsvr32.exe'\n            OR lnk.shortcut_target_path LIKE '%\\mshta.exe'\n            OR lnk.shortcut_target_path LIKE '%\\wmic.exe'\n            OR lnk.shortcut_target_path LIKE '%\\conhost.exe'\n            OR lnk.shortcut_target_path LIKE '%\\certutil.exe'\n            OR lnk.shortcut_target_path LIKE '%\\bitsadmin.exe'\n        THEN 1 ELSE 2 \n    END,\n    lnk.location_type,\n    lnk.mtime DESC;",
        "updated_at": "2025-11-28T00:00:00.000Z",
        "updated_by": "elastic",
        "tags": [
            "forensics",
            "persistence",
            "lateral-movement",
            "user-activity",
            "file-analysis",
            "malware-detection",
            "command-and-control"
        ],
        "mitre_attack": [
            {
                "id": "T1547.001",
                "tactic": "Persistence",
                "technique": "Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder",
                "reference": "https://attack.mitre.org/techniques/T1547/001/"
            },
            {
                "id": "T1204.002",
                "tactic": "Execution",
                "technique": "User Execution: Malicious File",
                "reference": "https://attack.mitre.org/techniques/T1204/002/"
            },
            {
                "id": "T1021",
                "tactic": "Lateral Movement",
                "technique": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
            },
            {
                "id": "T1059.001",
                "tactic": "Execution",
                "technique": "Command and Scripting Interpreter: PowerShell",
                "reference": "https://attack.mitre.org/techniques/T1059/001/"
            },
            {
                "id": "T1059.003",
                "tactic": "Execution",
                "technique": "Command and Scripting Interpreter: Windows Command Shell",
                "reference": "https://attack.mitre.org/techniques/T1059/003/"
            },
            {
                "id": "T1105",
                "tactic": "Command and Control",
                "technique": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
            }
        ]
    },
    "coreMigrationVersion": "8.3.0",
    "id": "osquery_manager-a1b2c3d4-lnk1-11ef-8f39-bf9c07530bbb",
    "references": [],
    "type": "osquery-saved-query",
    "updated_at": "2025-11-28T00:00:00.000Z",
    "version": "WzEsMV0="
}
