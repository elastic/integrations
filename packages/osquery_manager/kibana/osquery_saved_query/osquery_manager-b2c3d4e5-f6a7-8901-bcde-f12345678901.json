{
    "attributes": {
        "created_at": "2025-12-08T00:00:00.000Z",
        "created_by": "elastic",
        "description": "Detects suspicious Linux cron jobs using dual-detection approach: (1) Non-whitelisted cron jobs not in known-good allowlist and (2) Living off the Land (LOTL) attack indicators. Identifies both non-standard cron jobs AND abuse of legitimate Unix tools (curl|bash, nc -e, base64 -d, etc.) for persistence, privilege escalation, and lateral movement. Uses path-based and command-based whitelist filtering to auto-exclude legitimate system cron jobs (cron.d, cron.daily, package managers, system maintenance tasks) while flagging suspicious patterns regardless of location. Supports multiple distributions (Ubuntu, Debian, CentOS, RHEL, Fedora, openSUSE). Note: This query is Linux-only (crontab table). For Windows persistence, use scheduled_tasks queries. For macOS persistence, use launchd queries. Maps to MITRE ATT&CK T1053.003 (Cron), T1059.004 (Unix Shell), T1105 (Ingress Tool Transfer).",
        "ecs_mapping": [
            {
                "key": "event.category",
                "value": {
                    "value": ["configuration"]
                }
            },
            {
                "key": "event.type",
                "value": {
                    "value": ["info"]
                }
            },
            {
                "key": "event.action",
                "value": {
                    "value": "osquery.crontab"
                }
            },
            {
                "key": "rule.description",
                "value": {
                    "field": "detection_reason"
                }
            },
            {
                "key": "rule.name",
                "value": {
                    "field": "detection_method"
                }
            },
            {
                "key": "rule.category",
                "value": {
                    "field": "cron_type"
                }
            },
            {
                "key": "service.name",
                "value": {
                    "field": "crontab_owner"
                }
            },
            {
                "key": "process.command_line",
                "value": {
                    "field": "command"
                }
            },
            {
                "key": "process.executable",
                "value": {
                    "field": "executable_path"
                }
            },
            {
                "key": "file.path",
                "value": {
                    "field": "crontab_path"
                }
            },
            {
                "key": "file.hash.sha256",
                "value": {
                    "field": "sha256"
                }
            },
            {
                "key": "file.hash.sha1",
                "value": {
                    "field": "sha1"
                }
            },
            {
                "key": "file.hash.md5",
                "value": {
                    "field": "md5"
                }
            },
            {
                "key": "file.size",
                "value": {
                    "field": "file_size"
                }
            },
            {
                "key": "file.mtime",
                "value": {
                    "field": "modified_time"
                }
            },
            {
                "key": "file.ctime",
                "value": {
                    "field": "changed_time"
                }
            },
            {
                "key": "file.directory",
                "value": {
                    "field": "directory"
                }
            },
            {
                "key": "user.id",
                "value": {
                    "field": "uid"
                }
            },
            {
                "key": "user.group.id",
                "value": {
                    "field": "gid"
                }
            },
            {
                "key": "file.mode",
                "value": {
                    "field": "mode"
                }
            },
            {
                "key": "user.name",
                "value": {
                    "field": "crontab_owner"
                }
            },
            {
                "key": "tags",
                "value": {
                    "value": ["osquery", "persistence", "crontab", "linux"]
                }
            }
        ],
        "id": "crontab_linux_elastic",
        "interval": "3600",
        "platform": "linux",
        "query": "-- Detects suspicious cron jobs via whitelist and LOTL patterns\n-- MITRE: T1053.003, T1059.004, T1105\n-- Multi-distro support: Ubuntu, Debian, CentOS, RHEL, Fedora, openSUSE, Arch\n\nWITH non_whitelisted AS (\n    SELECT \n        c.command,\n        c.path AS crontab_path,\n        c.event,\n        c.minute,\n        c.hour,\n        c.day_of_month,\n        c.month,\n        c.day_of_week,\n        CASE \n            WHEN c.command LIKE '/%' THEN \n                CASE \n                    WHEN INSTR(c.command, ' ') > 0 THEN SUBSTR(c.command, 1, INSTR(c.command, ' ') - 1)\n                    ELSE c.command\n                END\n            ELSE NULL\n        END AS executable_path,\n        CASE\n            WHEN c.path LIKE '/var/spool/cron/crontabs/%' THEN REPLACE(c.path, '/var/spool/cron/crontabs/', '')\n            WHEN c.path LIKE '/var/spool/cron/%' THEN REPLACE(c.path, '/var/spool/cron/', '')\n            ELSE 'system'\n        END AS crontab_owner,\n        1 AS is_non_whitelisted,\n        0 AS is_lotl\n    FROM crontab AS c\n    WHERE c.command IS NOT NULL\n        AND c.command != ''\n        -- Allowlist: System cron with standard executable paths\n        AND NOT (\n            (c.path LIKE '/etc/cron.d/%' \n                OR c.path LIKE '/etc/cron.daily/%' \n                OR c.path LIKE '/etc/cron.hourly/%' \n                OR c.path LIKE '/etc/cron.weekly/%' \n                OR c.path LIKE '/etc/cron.monthly/%'\n                OR c.path = '/etc/crontab'\n            )\n            AND (\n                c.command LIKE '/usr/bin/%'\n                OR c.command LIKE '/usr/sbin/%'\n                OR c.command LIKE '/bin/%'\n                OR c.command LIKE '/sbin/%'\n                OR c.command LIKE '/usr/local/bin/%'\n                OR c.command LIKE '/usr/local/sbin/%'\n            )\n        )\n        -- Allowlist: Package managers and system maintenance\n        AND NOT (\n            c.command LIKE '%apt %'\n            OR c.command LIKE '%apt-get %'\n            OR c.command LIKE '%dpkg %'\n            OR c.command LIKE '%yum %'\n            OR c.command LIKE '%dnf %'\n            OR c.command LIKE '%zypper %'\n            OR c.command LIKE '%pacman %'\n            OR c.command LIKE '%anacron %'\n            OR c.command LIKE '%logrotate %'\n            OR c.command LIKE '%mandb %'\n            OR c.command LIKE '%man-db %'\n            OR c.command LIKE '%updatedb %'\n            OR c.command LIKE '%mlocate %'\n            OR c.command LIKE '%run-parts %'\n            OR (c.command LIKE '%/etc/cron.%' AND c.path LIKE '/etc/crontab')\n        )\n        -- Allowlist: Ubuntu/Debian system packages\n        AND NOT (\n            c.path LIKE '/etc/cron.d/%'\n            AND (\n                c.command LIKE '%debian-sa1%'\n                OR c.command LIKE '%/usr/lib/sysstat/%'\n                OR c.command LIKE '%e2scrub%'\n                OR c.command LIKE '%/usr/lib/%/e2fsprogs/%'\n                OR c.command LIKE '%apt-compat%'\n                OR c.command LIKE '%dpkg%'\n                OR c.command LIKE '%update-notifier%'\n                OR c.command LIKE '%popularity-contest%'\n            )\n        )\n        -- Allowlist: System binaries from /etc/cron.d/ (excludes /tmp, /var/tmp, /dev/shm)\n        AND NOT (\n            c.path LIKE '/etc/cron.d/%'\n            AND (\n                c.command LIKE '%/sbin/%'\n                OR c.command LIKE '%/usr/sbin/%'\n                OR c.command LIKE '%/bin/%'\n                OR c.command LIKE '%/usr/bin/%'\n                OR c.command LIKE '%/usr/lib/%'\n            )\n            AND c.command NOT LIKE '%/tmp/%'\n            AND c.command NOT LIKE '%/var/tmp/%'\n            AND c.command NOT LIKE '%/dev/shm/%'\n        )\n        -- Allowlist: Root crontabs with standard paths (excludes curl, wget, nc)\n        AND NOT (\n            c.path = '/var/spool/cron/crontabs/root'\n            AND (\n                c.command LIKE '/usr/bin/%'\n                OR c.command LIKE '/usr/sbin/%'\n                OR c.command LIKE '/bin/%'\n                OR c.command LIKE '/sbin/%'\n            )\n            AND c.command NOT LIKE '%curl%'\n            AND c.command NOT LIKE '%wget%'\n            AND c.command NOT LIKE '%nc %'\n            AND c.command NOT LIKE '%netcat%'\n        )\n),\nlotl_indicators AS (\n    SELECT \n        c.command,\n        c.path AS crontab_path,\n        c.event,\n        c.minute,\n        c.hour,\n        c.day_of_month,\n        c.month,\n        c.day_of_week,\n        CASE \n            WHEN c.command LIKE '/%' THEN \n                CASE \n                    WHEN INSTR(c.command, ' ') > 0 THEN SUBSTR(c.command, 1, INSTR(c.command, ' ') - 1)\n                    ELSE c.command\n                END\n            ELSE NULL\n        END AS executable_path,\n        CASE\n            WHEN c.path LIKE '/var/spool/cron/crontabs/%' THEN REPLACE(c.path, '/var/spool/cron/crontabs/', '')\n            WHEN c.path LIKE '/var/spool/cron/%' THEN REPLACE(c.path, '/var/spool/cron/', '')\n            ELSE 'system'\n        END AS crontab_owner,\n        0 AS is_non_whitelisted,\n        1 AS is_lotl,\n        CASE\n            WHEN c.command LIKE '%curl%|%bash%' OR c.command LIKE '%curl%|%sh%' THEN 'Download and pipe to shell (curl|bash)'\n            WHEN c.command LIKE '%wget%|%bash%' OR c.command LIKE '%wget%|%sh%' THEN 'Download and pipe to shell (wget|sh)'\n            WHEN c.command LIKE '%curl %http%' OR c.command LIKE '%wget %http%' THEN 'Download utility with remote URL'\n            WHEN c.command LIKE '%nc -e%' OR c.command LIKE '%ncat -e%' THEN 'Reverse shell via netcat'\n            WHEN c.command LIKE '%/dev/tcp/%' OR c.command LIKE '%/dev/udp/%' THEN 'Bash network redirection (reverse shell)'\n            WHEN c.command LIKE '%socat%TCP%' OR c.command LIKE '%socat%EXEC%' THEN 'Socat reverse shell'\n            WHEN c.command LIKE '%base64 -d%' OR c.command LIKE '%base64 --decode%' OR c.command LIKE '%base64 -D%' THEN 'Base64 decode for obfuscation'\n            WHEN c.command LIKE '%echo%|%base64%' THEN 'Base64 encoded command execution'\n            WHEN c.command LIKE '%bash -c%' OR c.command LIKE '%sh -c%' THEN 'Shell command execution via -c flag'\n            WHEN c.command LIKE '%bash -i%' OR c.command LIKE '%sh -i%' THEN 'Interactive shell invocation'\n            WHEN c.command LIKE '%python -c%' OR c.command LIKE '%python3 -c%' THEN 'Python one-liner execution'\n            WHEN c.command LIKE '%perl -e%' THEN 'Perl one-liner execution'\n            WHEN c.command LIKE '%ruby -e%' THEN 'Ruby one-liner execution'\n            WHEN c.command LIKE '%php -r%' THEN 'PHP one-liner execution'\n            WHEN c.command LIKE '%/tmp/%' THEN 'Execution from /tmp directory'\n            WHEN c.command LIKE '%/dev/shm/%' THEN 'Execution from /dev/shm (world-writable memory)'\n            WHEN c.command LIKE '%/var/tmp/%' THEN 'Execution from /var/tmp directory'\n            WHEN c.command LIKE '%./%' OR c.command LIKE '%/.%' THEN 'Execution from hidden directory'\n            WHEN c.command LIKE '%sudo -n%' OR c.command LIKE '%sudo --non-interactive%' THEN 'Sudo without password prompt'\n            WHEN c.command LIKE '%chmod +s%' OR c.command LIKE '%chmod 4755%' OR c.command LIKE '%chmod 4777%' THEN 'Setuid bit modification (privilege escalation)'\n            WHEN c.command LIKE '%authorized_keys%' AND (c.command LIKE '%echo%' OR c.command LIKE '%cat%' OR c.command LIKE '%>>%') THEN 'SSH authorized_keys manipulation'\n            WHEN c.command LIKE '%crontab -e%' OR c.command LIKE '%crontab -%' THEN 'Crontab modification (persistence)'\n            WHEN c.command LIKE '%nohup%&%' OR c.command LIKE '%disown%' THEN 'Background process persistence'\n            WHEN c.command LIKE '%nc %' OR c.command LIKE '%netcat%' THEN 'Netcat network utility abuse'\n            WHEN c.command LIKE '%eval%' OR c.command LIKE '%exec%' THEN 'Eval/exec command execution'\n            ELSE 'Unknown LOTL pattern'\n        END AS detection_reason\n    FROM crontab AS c\n    WHERE c.command IS NOT NULL\n        AND c.command != ''\n        AND (\n            c.command LIKE '%curl%|%bash%'\n            OR c.command LIKE '%curl%|%sh%'\n            OR c.command LIKE '%wget%|%bash%'\n            OR c.command LIKE '%wget%|%sh%'\n            OR c.command LIKE '%curl %http%'\n            OR c.command LIKE '%wget %http%'\n            OR c.command LIKE '%nc -e%'\n            OR c.command LIKE '%ncat -e%'\n            OR c.command LIKE '%/dev/tcp/%'\n            OR c.command LIKE '%/dev/udp/%'\n            OR c.command LIKE '%socat%TCP%'\n            OR c.command LIKE '%socat%EXEC%'\n            OR c.command LIKE '%base64 -d%'\n            OR c.command LIKE '%base64 --decode%'\n            OR c.command LIKE '%base64 -D%'\n            OR c.command LIKE '%echo%|%base64%'\n            OR c.command LIKE '%bash -c%'\n            OR c.command LIKE '%sh -c%'\n            OR c.command LIKE '%bash -i%'\n            OR c.command LIKE '%sh -i%'\n            OR c.command LIKE '%python -c%'\n            OR c.command LIKE '%python3 -c%'\n            OR c.command LIKE '%perl -e%'\n            OR c.command LIKE '%ruby -e%'\n            OR c.command LIKE '%php -r%'\n            OR c.command LIKE '%/tmp/%'\n            OR c.command LIKE '%/dev/shm/%'\n            OR c.command LIKE '%/var/tmp/%'\n            OR c.command LIKE '%./%'\n            OR c.command LIKE '%/.%'\n            OR c.command LIKE '%sudo -n%'\n            OR c.command LIKE '%sudo --non-interactive%'\n            OR c.command LIKE '%chmod +s%'\n            OR c.command LIKE '%chmod 4755%'\n            OR c.command LIKE '%chmod 4777%'\n            OR (c.command LIKE '%authorized_keys%' AND (c.command LIKE '%echo%' OR c.command LIKE '%cat%' OR c.command LIKE '%>>%'))\n            OR c.command LIKE '%crontab -e%'\n            OR c.command LIKE '%crontab -%'\n            OR c.command LIKE '%nohup%&%'\n            OR c.command LIKE '%disown%'\n            OR c.command LIKE '%nc %'\n            OR c.command LIKE '%netcat%'\n            OR c.command LIKE '%eval%'\n            OR c.command LIKE '%exec%'\n        )\n),\ncombined AS (\n    SELECT \n        c.command,\n        c.path AS crontab_path,\n        c.event,\n        c.minute,\n        c.hour,\n        c.day_of_month,\n        c.month,\n        c.day_of_week,\n        COALESCE(\n            MAX(li.executable_path),\n            MAX(nw.executable_path)\n        ) AS executable_path,\n        COALESCE(\n            MAX(li.crontab_owner),\n            MAX(nw.crontab_owner)\n        ) AS crontab_owner,\n        CASE \n            WHEN MAX(COALESCE(li.is_lotl, 0)) = 1 \n            THEN 'Cron Job (LOTL)'\n            ELSE 'Cron Job'\n        END AS cron_type,\n        CASE \n            WHEN MAX(COALESCE(li.is_lotl, 0)) = 1 AND MAX(COALESCE(nw.is_non_whitelisted, 0)) = 1 \n            THEN 'LOTL_INDICATOR + NON_WHITELISTED'\n            WHEN MAX(COALESCE(li.is_lotl, 0)) = 1 \n            THEN 'LOTL_INDICATOR'\n            ELSE 'NON_WHITELISTED'\n        END AS detection_method,\n        CASE \n            WHEN MAX(COALESCE(li.is_lotl, 0)) = 1 AND MAX(COALESCE(nw.is_non_whitelisted, 0)) = 1 \n            THEN MAX(li.detection_reason) || ' + Not in known-good allowlist'\n            WHEN MAX(COALESCE(li.is_lotl, 0)) = 1 \n            THEN MAX(li.detection_reason)\n            ELSE 'Cron job not in known-good allowlist'\n        END AS detection_reason\n    FROM crontab AS c\n    LEFT JOIN non_whitelisted AS nw ON c.command = nw.command AND c.path = nw.crontab_path\n    LEFT JOIN lotl_indicators AS li ON c.command = li.command AND c.path = li.crontab_path\n    WHERE COALESCE(nw.is_non_whitelisted, 0) = 1 OR COALESCE(li.is_lotl, 0) = 1\n    GROUP BY c.command, c.path, c.event, c.minute, c.hour, c.day_of_month, c.month, c.day_of_week\n)\nSELECT \n    c.command,\n    c.crontab_path,\n    c.event,\n    c.minute,\n    c.hour,\n    c.day_of_month,\n    c.month,\n    c.day_of_week,\n    c.executable_path,\n    c.crontab_owner,\n    c.cron_type,\n    c.detection_method,\n    c.detection_reason,\n    h.sha256,\n    h.sha1,\n    h.md5,\n    f.size AS file_size,\n    datetime(f.mtime, 'unixepoch') AS modified_time,\n    datetime(f.ctime, 'unixepoch') AS changed_time,\n    f.directory,\n    f.uid,\n    f.gid,\n    f.mode\nFROM combined AS c\nLEFT JOIN hash AS h ON c.executable_path = h.path\nLEFT JOIN file AS f ON c.executable_path = f.path\nORDER BY \n    CASE WHEN c.detection_method LIKE 'LOTL_INDICATOR%' THEN 0 ELSE 1 END,\n    c.detection_reason,\n    c.crontab_owner,\n    c.command",
        "updated_at": "2025-12-08T00:00:00.000Z",
        "updated_by": "elastic"
    },
    "coreMigrationVersion": "9.2.0",
    "id": "osquery_manager-b2c3d4e5-f6a7-8901-bcde-f12345678901",
    "references": [],
    "type": "osquery-saved-query",
    "updated_at": "2025-12-08T00:00:00.000Z",
    "version": "WzEwNTUzLDJd"
}
