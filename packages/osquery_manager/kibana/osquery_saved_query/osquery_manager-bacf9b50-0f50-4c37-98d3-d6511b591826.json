{
  "attributes": {
    "created_at": "2025-11-05T09:19:01.000Z",
    "created_by": "elastic",
    "description": "Detect Windows scheduled task persistence with comprehensive risk scoring (0-100), PowerShell argument analysis (encoded commands, hidden execution, download cradles), LOLBin detection (15+ binaries), digital signature validation, and threat intelligence correlation. Identifies C2 beaconing patterns, hidden tasks, and staged malware execution.",
    "ecs_mapping": [
      {
        "key": "process.name",
        "value": {
          "field": "task_name"
        }
      },
      {
        "key": "process.command_line",
        "value": {
          "field": "action"
        }
      },
      {
        "key": "process.hash.sha256",
        "value": {
          "field": "executable_sha256"
        }
      },
      {
        "key": "process.hash.md5",
        "value": {
          "field": "executable_md5"
        }
      },
      {
        "key": "process.code_signature.status",
        "value": {
          "field": "signature_status"
        }
      },
      {
        "key": "process.code_signature.subject_name",
        "value": {
          "field": "cert_subject"
        }
      },
      {
        "key": "event.risk_score",
        "value": {
          "field": "task_risk_score"
        }
      },
      {
        "key": "event.severity",
        "value": {
          "field": "risk_level"
        }
      },
      {
        "key": "event.start",
        "value": {
          "field": "last_run_timestamp"
        }
      },
      {
        "key": "event.category",
        "value": {
          "value": [
            "process"
          ]
        }
      },
      {
        "key": "event.type",
        "value": {
          "value": [
            "info",
            "start"
          ]
        }
      },
      {
        "key": "threat.technique.id",
        "value": {
          "field": "mitre_attack_techniques"
        }
      },
      {
        "key": "tags",
        "value": {
          "value": [
            "persistence",
            "scheduled_task",
            "lolbin",
            "risk_scored"
          ]
        }
      }
    ],
    "id": "scheduled_tasks_persistence_elastic",
    "interval": "3600",
    "platform": "windows",
    "query": "WITH task_analysis AS (\n  SELECT\n    st.name AS task_name,\n    st.path AS task_path,\n    st.action,\n    st.enabled,\n    st.state,\n    st.hidden,\n    st.last_run_time,\n    st.next_run_time,\n\n    CASE\n      -- Quoted paths: \"C:\\Path\\file.exe\" args\n      WHEN st.action LIKE '\"%' THEN\n        RTRIM(SUBSTR(st.action, 2, INSTR(SUBSTR(st.action, 2), '\"') - 1))\n      -- Unquoted paths with drive letter and arguments\n      WHEN st.action LIKE '_:\\%' AND INSTR(st.action, ' ') > 0 THEN\n        SUBSTR(st.action, 1, INSTR(st.action, ' ') - 1)\n      -- Unquoted paths without arguments\n      WHEN st.action LIKE '_:\\%' THEN\n        st.action\n      -- PowerShell resolution (64-bit default, case-insensitive)\n      WHEN LOWER(st.action) LIKE '%powershell.exe%' OR LOWER(st.action) LIKE '%powershell %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' OR LOWER(st.action) LIKE '%wow64%' THEN\n            'C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe'\n          ELSE\n            'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe'\n        END\n      -- cmd.exe resolution\n      WHEN LOWER(st.action) LIKE '%cmd.exe%' OR LOWER(st.action) LIKE '%cmd %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' THEN\n            'C:\\Windows\\SysWOW64\\cmd.exe'\n          ELSE\n            'C:\\Windows\\System32\\cmd.exe'\n        END\n      -- wscript.exe resolution\n      WHEN LOWER(st.action) LIKE '%wscript.exe%' OR LOWER(st.action) LIKE '%wscript %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' THEN\n            'C:\\Windows\\SysWOW64\\wscript.exe'\n          ELSE\n            'C:\\Windows\\System32\\wscript.exe'\n        END\n      -- cscript.exe resolution\n      WHEN LOWER(st.action) LIKE '%cscript.exe%' OR LOWER(st.action) LIKE '%cscript %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' THEN\n            'C:\\Windows\\SysWOW64\\cscript.exe'\n          ELSE\n            'C:\\Windows\\System32\\cscript.exe'\n        END\n      -- rundll32.exe resolution\n      WHEN LOWER(st.action) LIKE '%rundll32.exe%' OR LOWER(st.action) LIKE '%rundll32 %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' THEN\n            'C:\\Windows\\SysWOW64\\rundll32.exe'\n          ELSE\n            'C:\\Windows\\System32\\rundll32.exe'\n        END\n      -- regsvr32.exe resolution\n      WHEN LOWER(st.action) LIKE '%regsvr32.exe%' OR LOWER(st.action) LIKE '%regsvr32 %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' THEN\n            'C:\\Windows\\SysWOW64\\regsvr32.exe'\n          ELSE\n            'C:\\Windows\\System32\\regsvr32.exe'\n        END\n      -- mshta.exe resolution\n      WHEN LOWER(st.action) LIKE '%mshta.exe%' OR LOWER(st.action) LIKE '%mshta %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' THEN\n            'C:\\Windows\\SysWOW64\\mshta.exe'\n          ELSE\n            'C:\\Windows\\System32\\mshta.exe'\n        END\n      -- certutil.exe resolution\n      WHEN LOWER(st.action) LIKE '%certutil.exe%' OR LOWER(st.action) LIKE '%certutil %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' THEN\n            'C:\\Windows\\SysWOW64\\certutil.exe'\n          ELSE\n            'C:\\Windows\\System32\\certutil.exe'\n        END\n      -- bitsadmin.exe resolution\n      WHEN LOWER(st.action) LIKE '%bitsadmin.exe%' OR LOWER(st.action) LIKE '%bitsadmin %' THEN\n        'C:\\Windows\\System32\\bitsadmin.exe'\n      -- msiexec.exe resolution\n      WHEN LOWER(st.action) LIKE '%msiexec.exe%' OR LOWER(st.action) LIKE '%msiexec %' THEN\n        CASE\n          WHEN LOWER(st.action) LIKE '%syswow64%' THEN\n            'C:\\Windows\\SysWOW64\\msiexec.exe'\n          ELSE\n            'C:\\Windows\\System32\\msiexec.exe'\n        END\n      -- regasm.exe resolution (.NET Framework tool)\n      WHEN LOWER(st.action) LIKE '%regasm.exe%' THEN\n        'C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\regasm.exe'\n      -- regsvcs.exe resolution (.NET Framework tool)\n      WHEN LOWER(st.action) LIKE '%regsvcs.exe%' THEN\n        'C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\regsvcs.exe'\n      -- installutil.exe resolution (.NET Framework tool)\n      WHEN LOWER(st.action) LIKE '%installutil.exe%' THEN\n        'C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\installutil.exe'\n      -- forfiles.exe resolution\n      WHEN LOWER(st.action) LIKE '%forfiles.exe%' OR LOWER(st.action) LIKE '%forfiles %' THEN\n        'C:\\Windows\\System32\\forfiles.exe'\n      -- pcalua.exe resolution (Program Compatibility Assistant)\n      WHEN LOWER(st.action) LIKE '%pcalua.exe%' OR LOWER(st.action) LIKE '%pcalua %' THEN\n        'C:\\Windows\\System32\\pcalua.exe'\n      -- msxsl.exe resolution\n      WHEN LOWER(st.action) LIKE '%msxsl.exe%' THEN\n        'C:\\Windows\\System32\\msxsl.exe'\n      -- Environment variable expansion: %SystemRoot%\\System32\\...\n      WHEN st.action LIKE '%SystemRoot%\\System32\\%' THEN\n        REPLACE(\n          CASE\n            WHEN INSTR(st.action, ' ') > 0 THEN\n              SUBSTR(st.action, 1, INSTR(st.action, ' ') - 1)\n            ELSE st.action\n          END,\n          '%SystemRoot%', 'C:\\Windows'\n        )\n      -- Environment variable expansion: %windir%\\System32\\...\n      WHEN st.action LIKE '%windir%\\System32\\%' THEN\n        REPLACE(\n          CASE\n            WHEN INSTR(st.action, ' ') > 0 THEN\n              SUBSTR(st.action, 1, INSTR(st.action, ' ') - 1)\n            ELSE st.action\n          END,\n          '%windir%', 'C:\\Windows'\n        )\n      ELSE NULL\n    END AS extracted_path,\n\n    CASE\n      WHEN st.action LIKE '%powershell%' THEN 'POWERSHELL'\n      WHEN st.action LIKE '%cmd.exe%' OR st.action LIKE '%cmd %' THEN 'CMD'\n      WHEN st.action LIKE '%wscript%' THEN 'WSCRIPT'\n      WHEN st.action LIKE '%cscript%' THEN 'CSCRIPT'\n      WHEN st.action LIKE '%rundll32%' THEN 'RUNDLL32'\n      WHEN st.action LIKE '%regsvr32%' THEN 'REGSVR32'\n      WHEN st.action LIKE '%mshta%' THEN 'MSHTA'\n      WHEN st.action LIKE '%certutil%' THEN 'CERTUTIL'\n      WHEN st.action LIKE '%bitsadmin%' THEN 'BITSADMIN'\n      WHEN st.action LIKE '%msiexec%' THEN 'MSIEXEC'\n      WHEN st.action LIKE '%regasm%' OR st.action LIKE '%regsvcs%' THEN 'COM_REGISTRATION'\n      WHEN st.action LIKE '%installutil%' THEN 'INSTALLUTIL'\n      WHEN st.action LIKE '%forfiles%' THEN 'FORFILES'\n      WHEN st.action LIKE '%pcalua%' THEN 'PCALUA'\n      WHEN st.action LIKE '%msxsl%' THEN 'MSXSL'\n      ELSE 'OTHER'\n    END AS lolbin_type,\n\n    CASE\n      WHEN st.path LIKE '%\\\\Temp\\\\%' THEN 'TEMP'\n      WHEN st.path LIKE '%\\\\AppData\\\\Local\\\\%' THEN 'APPDATA_LOCAL'\n      WHEN st.path LIKE '%\\\\AppData\\\\Roaming\\\\%' THEN 'APPDATA_ROAMING'\n      WHEN st.path LIKE '%\\\\Users\\\\Public\\\\%' THEN 'PUBLIC'\n      WHEN st.path LIKE '\\\\Microsoft\\\\Windows\\\\%' THEN 'MICROSOFT'\n      ELSE 'CUSTOM'\n    END AS path_class,\n\n    CASE\n      WHEN st.action LIKE '%-enc%' OR st.action LIKE '%-EncodedCommand%' OR st.action LIKE '%-e %' THEN 1\n      ELSE 0\n    END AS has_encoded,\n\n    CASE\n      WHEN st.action LIKE '%-WindowStyle Hidden%' OR st.action LIKE '%-w hidden%' OR st.action LIKE '%-w h%' THEN 1\n      ELSE 0\n    END AS has_hidden_window,\n\n    CASE\n      WHEN st.action LIKE '%-ExecutionPolicy Bypass%' OR st.action LIKE '%-ep bypass%' OR st.action LIKE '%-ep bp%' THEN 1\n      ELSE 0\n    END AS has_bypass_policy,\n\n    CASE\n      WHEN st.action LIKE '%-NonInteractive%' OR st.action LIKE '%-noni%' THEN 1\n      ELSE 0\n    END AS has_noninteractive,\n\n    CASE\n      WHEN st.action LIKE '%DownloadString%'\n        OR st.action LIKE '%Invoke-WebRequest%'\n        OR st.action LIKE '%IWR %'\n        OR st.action LIKE '%wget %'\n        OR st.action LIKE '%curl %'\n        OR st.action LIKE '%Start-BitsTransfer%' THEN 1\n      ELSE 0\n    END AS has_download_cradle,\n\n    CASE\n      WHEN st.action LIKE '%http://%' OR st.action LIKE '%https://%' OR st.action LIKE '%ftp://%' THEN 1\n      ELSE 0\n    END AS has_url,\n\n    CASE\n      WHEN st.action LIKE '%[Convert]::FromBase64String%'\n        OR st.action LIKE '%[System.Convert]::FromBase64String%' THEN 1\n      ELSE 0\n    END AS has_base64_decode\n\n  FROM scheduled_tasks st\n\n  WHERE st.enabled = 1\n    AND (\n      st.action LIKE '%powershell%'\n      OR st.action LIKE '%cmd%'\n      OR st.action LIKE '%wscript%'\n      OR st.action LIKE '%cscript%'\n      OR st.action LIKE '%rundll32%'\n      OR st.action LIKE '%regsvr32%'\n      OR st.action LIKE '%mshta%'\n      OR st.action LIKE '%certutil%'\n      OR st.action LIKE '%bitsadmin%'\n      OR st.action LIKE '%msiexec%'\n      OR st.action LIKE '%regasm%'\n      OR st.action LIKE '%regsvcs%'\n      OR st.action LIKE '%installutil%'\n      OR st.action LIKE '%forfiles%'\n      OR st.action LIKE '%pcalua%'\n      OR st.action LIKE '%msxsl%'\n\n      OR st.path LIKE '%\\\\Temp\\\\%'\n      OR st.path LIKE '%\\\\AppData\\\\%'\n      OR st.path LIKE '%\\\\Users\\\\Public\\\\%'\n      OR st.path LIKE '%\\\\ProgramData\\\\%'\n\n      OR st.path NOT LIKE '\\\\Microsoft\\\\Windows\\\\%'\n    )\n)\nSELECT\n  (\n    CASE\n      WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 AND ta.has_download_cradle = 1 THEN 40\n      WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 THEN 35\n      WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_download_cradle = 1 THEN 30\n      WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_hidden_window = 1 THEN 25\n      WHEN ta.lolbin_type IN ('REGSVR32', 'MSHTA') THEN 30\n      WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN 25\n      WHEN ta.lolbin_type IN ('POWERSHELL', 'CMD') THEN 15\n      WHEN ta.lolbin_type IN ('WSCRIPT', 'CSCRIPT') THEN 20\n      WHEN ta.lolbin_type IN ('COM_REGISTRATION', 'INSTALLUTIL') THEN 22\n      WHEN ta.lolbin_type IN ('RUNDLL32', 'FORFILES', 'PCALUA', 'MSXSL') THEN 18\n      ELSE 5\n    END +\n\n    CASE\n      WHEN ta.path_class = 'TEMP' THEN 25\n      WHEN ta.path_class = 'APPDATA_LOCAL' THEN 20\n      WHEN ta.path_class = 'APPDATA_ROAMING' THEN 18\n      WHEN ta.path_class = 'PUBLIC' THEN 18\n      WHEN ta.path_class = 'CUSTOM' THEN 10\n      WHEN ta.path_class = 'MICROSOFT' THEN 0\n      ELSE 5\n    END +\n\n    CASE\n      WHEN ta.next_run_time - ta.last_run_time <= 300 THEN 20\n      WHEN ta.next_run_time - ta.last_run_time <= 900 THEN 15\n      WHEN ta.next_run_time - ta.last_run_time <= 3600 THEN 10\n      WHEN ta.last_run_time = 0 THEN 8\n      ELSE 5\n    END +\n\n    CASE\n      WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN 10\n      WHEN a.result = 'unsigned' THEN 10\n      WHEN a.result = 'invalid' THEN 8\n      WHEN a.result IS NULL AND ta.extracted_path IS NOT NULL THEN 6\n      ELSE 0\n    END +\n\n    CASE WHEN ta.hidden = 1 THEN 5 ELSE 0 END\n\n  ) AS task_risk_score,\n\n  CASE\n    WHEN (\n      CASE\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 AND ta.has_download_cradle = 1 THEN 40\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 THEN 35\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_download_cradle = 1 THEN 30\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_hidden_window = 1 THEN 25\n        WHEN ta.lolbin_type IN ('REGSVR32', 'MSHTA') THEN 30\n        WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN 25\n        WHEN ta.lolbin_type IN ('POWERSHELL', 'CMD') THEN 15\n        WHEN ta.lolbin_type IN ('WSCRIPT', 'CSCRIPT') THEN 20\n        WHEN ta.lolbin_type IN ('COM_REGISTRATION', 'INSTALLUTIL') THEN 22\n        WHEN ta.lolbin_type IN ('RUNDLL32', 'FORFILES', 'PCALUA', 'MSXSL') THEN 18\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.path_class = 'TEMP' THEN 25\n        WHEN ta.path_class = 'APPDATA_LOCAL' THEN 20\n        WHEN ta.path_class = 'APPDATA_ROAMING' THEN 18\n        WHEN ta.path_class = 'PUBLIC' THEN 18\n        WHEN ta.path_class = 'CUSTOM' THEN 10\n        WHEN ta.path_class = 'MICROSOFT' THEN 0\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.next_run_time - ta.last_run_time <= 300 THEN 20\n        WHEN ta.next_run_time - ta.last_run_time <= 900 THEN 15\n        WHEN ta.next_run_time - ta.last_run_time <= 3600 THEN 10\n        WHEN ta.last_run_time = 0 THEN 8\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN 10\n        WHEN a.result = 'unsigned' THEN 10\n        WHEN a.result = 'invalid' THEN 8\n        WHEN a.result IS NULL AND ta.extracted_path IS NOT NULL THEN 6\n        ELSE 0\n      END +\n      CASE WHEN ta.hidden = 1 THEN 5 ELSE 0 END\n    ) >= 80 THEN 'CRITICAL'\n    WHEN (\n      CASE\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 AND ta.has_download_cradle = 1 THEN 40\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 THEN 35\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_download_cradle = 1 THEN 30\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_hidden_window = 1 THEN 25\n        WHEN ta.lolbin_type IN ('REGSVR32', 'MSHTA') THEN 30\n        WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN 25\n        WHEN ta.lolbin_type IN ('POWERSHELL', 'CMD') THEN 15\n        WHEN ta.lolbin_type IN ('WSCRIPT', 'CSCRIPT') THEN 20\n        WHEN ta.lolbin_type IN ('COM_REGISTRATION', 'INSTALLUTIL') THEN 22\n        WHEN ta.lolbin_type IN ('RUNDLL32', 'FORFILES', 'PCALUA', 'MSXSL') THEN 18\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.path_class = 'TEMP' THEN 25\n        WHEN ta.path_class = 'APPDATA_LOCAL' THEN 20\n        WHEN ta.path_class = 'APPDATA_ROAMING' THEN 18\n        WHEN ta.path_class = 'PUBLIC' THEN 18\n        WHEN ta.path_class = 'CUSTOM' THEN 10\n        WHEN ta.path_class = 'MICROSOFT' THEN 0\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.next_run_time - ta.last_run_time <= 300 THEN 20\n        WHEN ta.next_run_time - ta.last_run_time <= 900 THEN 15\n        WHEN ta.next_run_time - ta.last_run_time <= 3600 THEN 10\n        WHEN ta.last_run_time = 0 THEN 8\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN 10\n        WHEN a.result = 'unsigned' THEN 10\n        WHEN a.result = 'invalid' THEN 8\n        WHEN a.result IS NULL AND ta.extracted_path IS NOT NULL THEN 6\n        ELSE 0\n      END +\n      CASE WHEN ta.hidden = 1 THEN 5 ELSE 0 END\n    ) >= 60 THEN 'HIGH'\n    WHEN (\n      CASE\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 AND ta.has_download_cradle = 1 THEN 40\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 THEN 35\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_download_cradle = 1 THEN 30\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_hidden_window = 1 THEN 25\n        WHEN ta.lolbin_type IN ('REGSVR32', 'MSHTA') THEN 30\n        WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN 25\n        WHEN ta.lolbin_type IN ('POWERSHELL', 'CMD') THEN 15\n        WHEN ta.lolbin_type IN ('WSCRIPT', 'CSCRIPT') THEN 20\n        WHEN ta.lolbin_type IN ('COM_REGISTRATION', 'INSTALLUTIL') THEN 22\n        WHEN ta.lolbin_type IN ('RUNDLL32', 'FORFILES', 'PCALUA', 'MSXSL') THEN 18\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.path_class = 'TEMP' THEN 25\n        WHEN ta.path_class = 'APPDATA_LOCAL' THEN 20\n        WHEN ta.path_class = 'APPDATA_ROAMING' THEN 18\n        WHEN ta.path_class = 'PUBLIC' THEN 18\n        WHEN ta.path_class = 'CUSTOM' THEN 10\n        WHEN ta.path_class = 'MICROSOFT' THEN 0\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.next_run_time - ta.last_run_time <= 300 THEN 20\n        WHEN ta.next_run_time - ta.last_run_time <= 900 THEN 15\n        WHEN ta.next_run_time - ta.last_run_time <= 3600 THEN 10\n        WHEN ta.last_run_time = 0 THEN 8\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN 10\n        WHEN a.result = 'unsigned' THEN 10\n        WHEN a.result = 'invalid' THEN 8\n        WHEN a.result IS NULL AND ta.extracted_path IS NOT NULL THEN 6\n        ELSE 0\n      END +\n      CASE WHEN ta.hidden = 1 THEN 5 ELSE 0 END\n    ) >= 40 THEN 'MEDIUM'\n    ELSE 'LOW'\n  END AS risk_level,\n\n  ta.task_name,\n  ta.task_path,\n  ta.action,\n  ta.lolbin_type,\n  ta.path_class,\n  ta.enabled,\n  ta.state,\n  ta.hidden,\n\n  ta.extracted_path,\n  CASE\n    WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN 'MISSING'\n    WHEN ta.extracted_path IS NOT NULL AND f.path IS NOT NULL THEN 'EXISTS'\n    ELSE 'NOT_EXTRACTED'\n  END AS executable_status,\n\n  f.size AS executable_size,\n  datetime(f.ctime, 'unixepoch') AS executable_created,\n  datetime(f.mtime, 'unixepoch') AS executable_modified,\n\n  h.sha256 AS executable_sha256,\n  h.md5 AS executable_md5,\n\n  a.result AS signature_status,\n  a.subject_name AS cert_subject,\n  a.issuer_name AS cert_issuer,\n\n  datetime(ta.last_run_time, 'unixepoch') AS last_run_timestamp,\n  datetime(ta.next_run_time, 'unixepoch') AS next_run_timestamp,\n  CAST((strftime('%s', 'now') - ta.last_run_time) / 3600 AS INTEGER) AS hours_since_last_run,\n\n  ta.has_encoded,\n  ta.has_hidden_window,\n  ta.has_bypass_policy,\n  ta.has_noninteractive,\n  ta.has_download_cradle,\n  ta.has_url,\n  ta.has_base64_decode,\n\n  CASE\n    WHEN ta.has_encoded = 1 THEN\n      'CRITICAL: PowerShell with -EncodedCommand detected. Decode Base64 to analyze: echo <BASE64_STRING> | base64 --decode or use CyberChef. May contain obfuscated malware payload. MITRE T1059.001, T1027.'\n    WHEN ta.has_download_cradle = 1 AND ta.has_url = 1 THEN\n      'CRITICAL: Task downloads content from URL - likely C2 beacon or stage-2 payload retrieval. Analyze network traffic, check URL reputation (VirusTotal, URLhaus). Review Task Scheduler event logs (Event ID 4698 for creation). MITRE T1105.'\n    WHEN ta.lolbin_type IN ('REGSVR32', 'MSHTA') THEN\n      'HIGH: Known LOLBin abuse technique. RegSvr32: Squiblydoo (T1218.010), Mshta: HTA execution (T1218.005). Review action for remote script/COM object execution.'\n    WHEN ta.hidden = 1 THEN\n      'INVESTIGATE: Hidden task - not visible in Task Scheduler UI. Check Task Scheduler Operational log (Event IDs 4698-creation, 4699-deletion, 4702-update). Common stealth technique (T1053.005).'\n    WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN\n      'INVESTIGATE: Task uses file download utility. Certutil: -urlcache -split -f pattern. BitsAdmin: /transfer pattern. May stage payloads. Check file hashes against threat intel.'\n    WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN\n      'WARNING: Task action executable not found on disk. Possible cleanup post-execution, or task configuration error. Review Task Scheduler logs for historical execution.'\n    WHEN ta.path_class IN ('TEMP', 'APPDATA_LOCAL', 'APPDATA_ROAMING') THEN\n      'REVIEW: Task in user-writable location. Verify legitimacy against approved software baseline. User-writable persistence is common in malware (T1053.005).'\n    WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_bypass_policy = 1 THEN\n      'ATTENTION: PowerShell with execution policy bypass. Common technique to run unsigned scripts. Review full command line, check script content if -File or -Command used.'\n    WHEN a.result = 'unsigned' THEN\n      'REVIEW: Task executable is unsigned. Higher risk of malware. Hash: ' || COALESCE(h.sha256, 'N/A') || '. Check against VirusTotal, NSRL.'\n    ELSE\n      'Review task action and compare against baseline. Check Task Scheduler logs for creation timestamp. Verify task legitimacy with asset owner.'\n  END AS analyst_notes,\n\n  CASE\n    WHEN (\n      CASE\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 AND ta.has_download_cradle = 1 THEN 40\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 THEN 35\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_download_cradle = 1 THEN 30\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_hidden_window = 1 THEN 25\n        WHEN ta.lolbin_type IN ('REGSVR32', 'MSHTA') THEN 30\n        WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN 25\n        WHEN ta.lolbin_type IN ('POWERSHELL', 'CMD') THEN 15\n        WHEN ta.lolbin_type IN ('WSCRIPT', 'CSCRIPT') THEN 20\n        WHEN ta.lolbin_type IN ('COM_REGISTRATION', 'INSTALLUTIL') THEN 22\n        WHEN ta.lolbin_type IN ('RUNDLL32', 'FORFILES', 'PCALUA', 'MSXSL') THEN 18\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.path_class = 'TEMP' THEN 25\n        WHEN ta.path_class = 'APPDATA_LOCAL' THEN 20\n        WHEN ta.path_class = 'APPDATA_ROAMING' THEN 18\n        WHEN ta.path_class = 'PUBLIC' THEN 18\n        WHEN ta.path_class = 'CUSTOM' THEN 10\n        WHEN ta.path_class = 'MICROSOFT' THEN 0\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.next_run_time - ta.last_run_time <= 300 THEN 20\n        WHEN ta.next_run_time - ta.last_run_time <= 900 THEN 15\n        WHEN ta.next_run_time - ta.last_run_time <= 3600 THEN 10\n        WHEN ta.last_run_time = 0 THEN 8\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN 10\n        WHEN a.result = 'unsigned' THEN 10\n        WHEN a.result = 'invalid' THEN 8\n        WHEN a.result IS NULL AND ta.extracted_path IS NOT NULL THEN 6\n        ELSE 0\n      END +\n      CASE WHEN ta.hidden = 1 THEN 5 ELSE 0 END\n    ) >= 80 THEN\n      '1. ISOLATE HOST if indicators of compromise confirmed | 2. Decode Base64 if present, analyze payload | 3. Hash executable (' || COALESCE(h.sha256, 'N/A') || ') - VirusTotal, Hybrid Analysis | 4. Review Task Scheduler event logs (Event ID 4698 for creation, 106 for registration) | 5. Check network connections (netstat, Sysmon Event ID 3) if URL present | 6. Analyze parent process that created task (schtasks.exe, Task Scheduler MMC) | 7. Delete task: schtasks /Delete /TN \"' || ta.task_name || '\" /F | 8. Hunt for related IOCs across environment'\n    WHEN (\n      CASE\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 AND ta.has_download_cradle = 1 THEN 40\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 THEN 35\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_download_cradle = 1 THEN 30\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_hidden_window = 1 THEN 25\n        WHEN ta.lolbin_type IN ('REGSVR32', 'MSHTA') THEN 30\n        WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN 25\n        WHEN ta.lolbin_type IN ('POWERSHELL', 'CMD') THEN 15\n        WHEN ta.lolbin_type IN ('WSCRIPT', 'CSCRIPT') THEN 20\n        WHEN ta.lolbin_type IN ('COM_REGISTRATION', 'INSTALLUTIL') THEN 22\n        WHEN ta.lolbin_type IN ('RUNDLL32', 'FORFILES', 'PCALUA', 'MSXSL') THEN 18\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.path_class = 'TEMP' THEN 25\n        WHEN ta.path_class = 'APPDATA_LOCAL' THEN 20\n        WHEN ta.path_class = 'APPDATA_ROAMING' THEN 18\n        WHEN ta.path_class = 'PUBLIC' THEN 18\n        WHEN ta.path_class = 'CUSTOM' THEN 10\n        WHEN ta.path_class = 'MICROSOFT' THEN 0\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.next_run_time - ta.last_run_time <= 300 THEN 20\n        WHEN ta.next_run_time - ta.last_run_time <= 900 THEN 15\n        WHEN ta.next_run_time - ta.last_run_time <= 3600 THEN 10\n        WHEN ta.last_run_time = 0 THEN 8\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN 10\n        WHEN a.result = 'unsigned' THEN 10\n        WHEN a.result = 'invalid' THEN 8\n        WHEN a.result IS NULL AND ta.extracted_path IS NOT NULL THEN 6\n        ELSE 0\n      END +\n      CASE WHEN ta.hidden = 1 THEN 5 ELSE 0 END\n    ) >= 60 THEN\n      '1. Verify task legitimacy with asset owner and approved software list | 2. Hash executable and check threat intel (VirusTotal, AlienVault OTX) | 3. Review Task Scheduler event logs (Event ID 4698) for creation timestamp and user | 4. Check executable digital signature and publisher | 5. Monitor task execution with Sysmon or EDR | 6. If malicious: isolate host, delete task, hunt environment | 7. If legitimate: whitelist in monitoring rules'\n    WHEN (\n      CASE\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 AND ta.has_download_cradle = 1 THEN 40\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_encoded = 1 THEN 35\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_download_cradle = 1 THEN 30\n        WHEN ta.lolbin_type = 'POWERSHELL' AND ta.has_hidden_window = 1 THEN 25\n        WHEN ta.lolbin_type IN ('REGSVR32', 'MSHTA') THEN 30\n        WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN 25\n        WHEN ta.lolbin_type IN ('POWERSHELL', 'CMD') THEN 15\n        WHEN ta.lolbin_type IN ('WSCRIPT', 'CSCRIPT') THEN 20\n        WHEN ta.lolbin_type IN ('COM_REGISTRATION', 'INSTALLUTIL') THEN 22\n        WHEN ta.lolbin_type IN ('RUNDLL32', 'FORFILES', 'PCALUA', 'MSXSL') THEN 18\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.path_class = 'TEMP' THEN 25\n        WHEN ta.path_class = 'APPDATA_LOCAL' THEN 20\n        WHEN ta.path_class = 'APPDATA_ROAMING' THEN 18\n        WHEN ta.path_class = 'PUBLIC' THEN 18\n        WHEN ta.path_class = 'CUSTOM' THEN 10\n        WHEN ta.path_class = 'MICROSOFT' THEN 0\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.next_run_time - ta.last_run_time <= 300 THEN 20\n        WHEN ta.next_run_time - ta.last_run_time <= 900 THEN 15\n        WHEN ta.next_run_time - ta.last_run_time <= 3600 THEN 10\n        WHEN ta.last_run_time = 0 THEN 8\n        ELSE 5\n      END +\n      CASE\n        WHEN ta.extracted_path IS NOT NULL AND f.path IS NULL THEN 10\n        WHEN a.result = 'unsigned' THEN 10\n        WHEN a.result = 'invalid' THEN 8\n        WHEN a.result IS NULL AND ta.extracted_path IS NOT NULL THEN 6\n        ELSE 0\n      END +\n      CASE WHEN ta.hidden = 1 THEN 5 ELSE 0 END\n    ) >= 40 THEN\n      '1. Verify task against approved software baseline | 2. Check executable signature and publisher: ' || COALESCE(a.subject_name, 'N/A') || ' | 3. Review task triggers and execution history | 4. Monitor for unusual execution patterns (frequency, time of day) | 5. If suspicious: escalate to HIGH priority investigation'\n    ELSE\n      '1. Log for baseline and trending | 2. Periodic review (quarterly) for configuration drift | 3. Monitor execution patterns for anomalies'\n  END AS next_steps,\n\n  CASE\n    WHEN ta.has_encoded = 1 OR ta.has_base64_decode = 1 THEN 'T1059.001,T1027'\n    WHEN ta.has_download_cradle = 1 THEN 'T1059.001,T1105'\n    WHEN ta.lolbin_type = 'REGSVR32' THEN 'T1218.010'\n    WHEN ta.lolbin_type = 'MSHTA' THEN 'T1218.005'\n    WHEN ta.lolbin_type = 'RUNDLL32' THEN 'T1218.011'\n    WHEN ta.lolbin_type IN ('CERTUTIL', 'BITSADMIN') THEN 'T1105'\n    ELSE 'T1053.005'\n  END AS mitre_attack_techniques\n\nFROM task_analysis ta\nLEFT JOIN file f ON f.path = ta.extracted_path\nLEFT JOIN hash h ON h.path = ta.extracted_path\nLEFT JOIN authenticode a ON a.path = ta.extracted_path\n\nORDER BY task_risk_score DESC, ta.hidden DESC\nLIMIT 200;",
    "updated_at": "2025-11-06T12:00:00.000Z",
    "updated_by": "elastic"
  },
  "coreMigrationVersion": "9.2.0",
  "id": "osquery_manager-bacf9b50-0f50-4c37-98d3-d6511b591826",
  "references": [],
  "type": "osquery-saved-query",
  "updated_at": "2025-11-05T09:19:01.000Z",
  "version": "Wzg0LDJd"
}