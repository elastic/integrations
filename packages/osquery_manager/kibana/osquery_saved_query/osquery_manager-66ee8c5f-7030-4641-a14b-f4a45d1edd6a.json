{
  "attributes": {
    "created_at": "2025-01-20T10:00:00.000Z",
    "created_by": "elastic",
    "description": "Queries the Windows DNS Client Operational event log for DNS query completion events (Event ID 3008). Provides full DNS query details including query name, record type, resolved answer, and process context with hashes when the originating process is still running. PREREQUISITE: DNS Client Operational logging must be enabled via 'wevtutil sl Microsoft-Windows-DNS-Client/Operational /e:true' or Group Policy.",
    "ecs_mapping": [
      {
        "key": "event.category",
        "value": { "value": ["network"] }
      },
      {
        "key": "event.type",
        "value": { "value": ["info"] }
      },
      {
        "key": "event.action",
        "value": { "value": "osquery.dns_event_log" }
      },
      {
        "key": "event.code",
        "value": { "field": "event_code" }
      },
      {
        "key": "dns.question.name",
        "value": { "field": "query_name" }
      },
      {
        "key": "dns.question.type",
        "value": { "field": "query_type" }
      },
      {
        "key": "dns.answers.data",
        "value": { "field": "answer" }
      },
      {
        "key": "process.pid",
        "value": { "field": "pid" }
      },
      {
        "key": "process.name",
        "value": { "field": "process_name" }
      },
      {
        "key": "process.executable",
        "value": { "field": "process_path" }
      },
      {
        "key": "process.command_line",
        "value": { "field": "process_cmdline" }
      },
      {
        "key": "process.hash.md5",
        "value": { "field": "md5" }
      },
      {
        "key": "process.hash.sha256",
        "value": { "field": "sha256" }
      },
      {
        "key": "tags",
        "value": { "value": ["osquery", "network", "dns", "windows", "event_log", "requires_config"] }
      }
    ],
    "id": "dns_event_log_windows_elastic",
    "interval": "900",
    "platform": "windows",
    "query": "-- Windows DNS Client Event Log with Process Context\n-- Queries DNS query completion events from the DNS Client Operational log\n-- Enriches with process path, cmdline, and hashes when process is still running\n-- PREREQUISITE: DNS Client Operational logging must be enabled:\n--   wevtutil sl Microsoft-Windows-DNS-Client/Operational /e:true\n-- Or via Group Policy: Computer Config > Admin Templates > Network > DNS Client > Turn on logging\n-- Event ID 3008 = DNS query completed\nSELECT\n    w.datetime AS event_time,\n    w.eventid AS event_code,\n    w.pid,\n    JSON_EXTRACT(w.data, '$.EventData.QueryName') AS query_name,\n    JSON_EXTRACT(w.data, '$.EventData.QueryType') AS query_type,\n    JSON_EXTRACT(w.data, '$.EventData.QueryResults') AS answer,\n    p.name AS process_name,\n    p.path AS process_path,\n    p.cmdline AS process_cmdline,\n    h.md5,\n    h.sha256\nFROM windows_eventlog w\nLEFT JOIN processes p ON w.pid = p.pid\nLEFT JOIN hash h ON h.path = p.path\nWHERE w.channel = 'Microsoft-Windows-DNS-Client/Operational'\n    AND w.eventid = 3008",
    "updated_at": "2025-01-20T10:00:00.000Z",
    "updated_by": "elastic"
  },
  "coreMigrationVersion": "9.2.0",
  "id": "osquery_manager-66ee8c5f-7030-4641-a14b-f4a45d1edd6a",
  "references": [],
  "type": "osquery-saved-query",
  "updated_at": "2025-01-20T10:00:00.000Z",
  "version": "WzEsMV0="
}
