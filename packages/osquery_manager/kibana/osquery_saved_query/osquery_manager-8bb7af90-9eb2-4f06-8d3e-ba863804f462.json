{
  "attributes": {
    "created_at": "2025-01-30T12:00:00.000Z",
    "created_by": "elastic",
    "description": "Detect suspicious BITS transfers by filtering out known-good domains (Microsoft, Google, Adobe, etc.) and internal networks",
    "ecs_mapping": [
      {
        "key": "@timestamp",
        "value": {
          "field": "datetime"
        }
      },
      {
        "key": "url.original",
        "value": {
          "field": "url"
        }
      },
      {
        "key": "url.domain",
        "value": {
          "field": "host"
        }
      },
      {
        "key": "event.action",
        "value": {
          "field": "job_name"
        }
      },
      {
        "key": "event.id",
        "value": {
          "field": "transfer_id"
        }
      },
      {
        "key": "file.size",
        "value": {
          "field": "file_size"
        }
      },
      {
        "key": "network.bytes",
        "value": {
          "field": "bytes_transferred"
        }
      },
      {
        "key": "event.code",
        "value": {
          "field": "eventid"
        }
      },
      {
        "key": "event.category",
        "value": {
          "value": [
            "network",
            "file"
          ]
        }
      },
      {
        "key": "event.type",
        "value": {
          "value": [
            "connection",
            "download"
          ]
        }
      },
      {
        "key": "event.action",
        "value": {
          "value": "bits-transfer-suspicious"
        }
      },
      {
        "key": "event.dataset",
        "value": {
          "value": "windows.bits_filtered"
        }
      },
      {
        "key": "event.provider",
        "value": {
          "value": "Microsoft-Windows-Bits-Client"
        }
      },
      {
        "key": "tags",
        "value": {
          "value": [
            "c2_detection",
            "bits",
            "download",
            "network_activity",
            "suspicious",
            "filtered"
          ]
        }
      }
    ],
    "id": "bits_jobs_database_elastic",
    "interval": "86400",
    "platform": "windows",
    "query": "WITH extracted AS (\n  SELECT \n    datetime, \n    eventid, \n    json_extract(data, '$.EventData.url') AS url, \n    split(\n      replace(\n        replace(json_extract(data, '$.EventData.url'), 'https://', ''), \n        'http://', ''\n      ), \n      '/', \n      1\n    ) AS host, \n    json_extract(data, '$.EventData.name') AS job_name, \n    json_extract(data, '$.EventData.Id') AS transfer_id, \n    json_extract(data, '$.EventData.fileLength') AS file_size, \n    json_extract(data, '$.EventData.bytesTransferred') AS bytes_transferred \n  FROM windows_eventlog \n  WHERE channel = 'Microsoft-Windows-Bits-Client/Operational' \n    AND eventid = 59 \n    AND datetime > datetime('now', '-30 days')\n) \nSELECT * \nFROM extracted \nWHERE regex_match(\n    host, \n    '(office365\\\\.com|office\\\\.net|windowsupdate\\\\.com|live\\\\.com|mozilla\\\\.com|adobe\\\\.com|microsoft\\\\.com|google\\\\.com|oracle\\\\.com|hp\\\\.com|aka\\\\.ms|gvt1\\\\.com|oneclient\\\\.sfx\\\\.ms|10\\\\..*|192\\\\.168\\\\..*|172\\\\.(1[6-9]|2[0-9]|3[0-1])\\\\..*)', \n    0\n  ) IS NULL \nORDER BY datetime DESC;",
    "updated_at": "2025-01-30T12:00:00.000Z",
    "updated_by": "elastic"
  },
  "coreMigrationVersion": "8.8.0",
  "id": "osquery_manager-8bb7af90-9eb2-4f06-8d3e-ba863804f462",
  "references": [],
  "type": "osquery-saved-query",
  "updated_at": "2025-01-30T12:00:00.000Z",
  "version": "Wzk0LDJd"
}
