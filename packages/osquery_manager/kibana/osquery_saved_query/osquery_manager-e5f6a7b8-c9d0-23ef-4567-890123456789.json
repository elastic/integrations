{
    "attributes": {
        "created_at": "2025-11-21T00:00:00.000Z",
        "created_by": "elastic",
        "description": "Detects Linux persistence via dual-detection approach: (1) User-created persistence mechanisms (systemd, cron, XDG autostart, startup_items) and (2) Living off the Land (LotL) attack indicators using legitimate Linux tools. Combines startup_items table with fine-grained systemd_units/crontab queries for comprehensive coverage. Identifies both custom persistence AND abuse of bash, curl/wget, base64 decoding, /dev/shm execution, etc. Maintains cross-distro compatibility with location-based filtering and expanded known-good allowlist. Maps to MITRE ATT&CK T1543.002 (Systemd Service), T1053.003 (Cron), T1547.013 (XDG Autostart), T1059.004 (Unix Shell), T1105 (Ingress Tool Transfer).",
        "ecs_mapping": [
            {
                "key": "event.category",
                "value": {
                    "value": ["configuration"]
                }
            },
            {
                "key": "event.type",
                "value": {
                    "value": ["info"]
                }
            },
            {
                "key": "event.action",
                "value": {
                    "value": "osquery.startup_items"
                }
            },
            {
                "key": "process.name",
                "value": {
                    "field": "name"
                }
            },
            {
                "key": "process.executable",
                "value": {
                    "field": "path"
                }
            },
            {
                "key": "process.command_line",
                "value": {
                    "field": "args"
                }
            },
            {
                "key": "file.path",
                "value": {
                    "field": "path"
                }
            },
            {
                "key": "file.hash.sha256",
                "value": {
                    "field": "sha256"
                }
            },
            {
                "key": "file.hash.sha1",
                "value": {
                    "field": "sha1"
                }
            },
            {
                "key": "file.hash.md5",
                "value": {
                    "field": "md5"
                }
            },
            {
                "key": "file.size",
                "value": {
                    "field": "size"
                }
            },
            {
                "key": "file.mtime",
                "value": {
                    "field": "modified_time"
                }
            },
            {
                "key": "file.ctime",
                "value": {
                    "field": "changed_time"
                }
            },
            {
                "key": "file.accessed",
                "value": {
                    "field": "accessed_time"
                }
            },
            {
                "key": "file.created",
                "value": {
                    "field": "created_time"
                }
            },
            {
                "key": "file.uid",
                "value": {
                    "field": "uid"
                }
            },
            {
                "key": "file.gid",
                "value": {
                    "field": "gid"
                }
            },
            {
                "key": "file.mode",
                "value": {
                    "field": "mode"
                }
            },
            {
                "key": "user.name",
                "value": {
                    "field": "username"
                }
            },
            {
                "key": "service.id",
                "value": {
                    "field": "service_id"
                }
            },
            {
                "key": "service.state",
                "value": {
                    "field": "status"
                }
            },
            {
                "key": "rule.category",
                "value": {
                    "field": "type"
                }
            },
            {
                "key": "file.directory",
                "value": {
                    "field": "source"
                }
            },
            {
                "key": "rule.description",
                "value": {
                    "field": "detection_reason"
                }
            },
            {
                "key": "rule.name",
                "value": {
                    "field": "detection_method"
                }
            },
            {
                "key": "tags",
                "value": {
                    "value": ["osquery", "persistence", "startup_items", "linux"]
                }
            }
        ],
        "id": "startup_items_linux_elastic",
        "interval": "3600",
        "platform": "linux",
        "query": "-- Dual-detection Linux persistence query:\n-- 1. NON_WHITELISTED: User-created systemd/cron/XDG autostart/startup_items (location-based filtering)\n-- 2. LOTL_INDICATOR: Living off the Land patterns (bash -c, curl | bash, base64 -d, etc.)\n-- Uses TRIM() on paths for proper matching\n-- MITRE ATT&CK: T1543.002, T1053.003, T1547.013, T1059.004, T1105\n\nWITH non_whitelisted_systemd AS (\n    SELECT\n        su.id AS name,\n        su.id AS service_id,\n        TRIM(su.fragment_path) AS path,\n        TRIM(su.fragment_path) AS source,\n        su.description AS args,\n        su.user AS username,\n        CASE\n            WHEN su.unit_file_state = 'enabled' THEN 'enabled'\n            WHEN su.unit_file_state = 'disabled' THEN 'disabled'\n            ELSE su.unit_file_state\n        END AS status,\n        'Systemd Service (Custom)' AS type,\n        'NON_WHITELISTED' AS detection_method,\n        'User-created systemd service' AS detection_reason\n    FROM systemd_units AS su\n    WHERE TRIM(su.fragment_path) LIKE '/etc/systemd/system/%'\n        AND su.id LIKE '%.service'\n        AND su.unit_file_state IN ('enabled', 'static', 'linked')\n        AND su.id NOT IN (\n            'ssh.service', 'sshd.service', 'cron.service', 'crond.service',\n            'rsyslog.service', 'syslog.service', 'systemd-timesyncd.service',\n            'chronyd.service', 'ntpd.service', 'NetworkManager.service',\n            'systemd-networkd.service', 'networking.service', 'docker.service',\n            'containerd.service', 'podman.service', 'snapd.service',\n            'flatpak-system-helper.service', 'ufw.service', 'firewalld.service',\n            'iptables.service', 'nftables.service', 'auditd.service',\n            'journald.service', 'systemd-journald.service', 'polkit.service',\n            'dbus.service', 'dbus-broker.service', 'gdm.service', 'lightdm.service',\n            'sddm.service', 'cups.service', 'cups-browsed.service',\n            'avahi-daemon.service', 'bluetooth.service', 'ModemManager.service',\n            'accounts-daemon.service', 'udisks2.service', 'upower.service',\n            'thermald.service', 'fwupd.service', 'packagekit.service',\n            'unattended-upgrades.service', 'apt-daily.service',\n            'apt-daily-upgrade.service', 'dnf-makecache.service',\n            'elastic-agent.service', 'filebeat.service', 'metricbeat.service',\n            'auditbeat.service', 'osqueryd.service'\n        )\n        AND su.id NOT LIKE 'getty@%'\n        AND su.id NOT LIKE 'dbus-%'\n        AND su.id NOT LIKE 'systemd-%'\n        AND su.id NOT LIKE 'user@%'\n        AND su.id NOT LIKE 'session-%'\n),\nnon_whitelisted_cron AS (\n    SELECT\n        SUBSTR(c.command, 1, 100) AS name,\n        '' AS service_id,\n        TRIM(c.path) AS path,\n        TRIM(c.path) AS source,\n        c.command AS args,\n        CASE\n            WHEN TRIM(c.path) LIKE '/var/spool/cron/crontabs/%' THEN REPLACE(TRIM(c.path), '/var/spool/cron/crontabs/', '')\n            WHEN TRIM(c.path) LIKE '/var/spool/cron/%' THEN REPLACE(REPLACE(TRIM(c.path), '/var/spool/cron/', ''), 'crontabs/', '')\n            ELSE 'root'\n        END AS username,\n        'enabled' AS status,\n        'Cron @reboot' AS type,\n        'NON_WHITELISTED' AS detection_method,\n        'Cron @reboot job' AS detection_reason\n    FROM crontab AS c\n    WHERE c.event = '@reboot'\n        AND c.command NOT LIKE '%/usr/lib/apt/%'\n        AND c.command NOT LIKE '%unattended-upgrade%'\n        AND c.command NOT LIKE '%/usr/sbin/anacron%'\n        AND c.command NOT LIKE '%run-parts%/etc/cron%'\n),\nnon_whitelisted_xdg AS (\n    SELECT\n        REPLACE(f.filename, '.desktop', '') AS name,\n        '' AS service_id,\n        f.path,\n        f.directory AS source,\n        '' AS args,\n        SUBSTR(SUBSTR(f.path, 7), 1, INSTR(SUBSTR(f.path, 7), '/') - 1) AS username,\n        'enabled' AS status,\n        'XDG Autostart (User)' AS type,\n        'NON_WHITELISTED' AS detection_method,\n        'User-specific XDG autostart entry' AS detection_reason\n    FROM file AS f\n    WHERE f.path LIKE '/home/%/.config/autostart/%.desktop'\n),\nnon_whitelisted_startup AS (\n    SELECT\n        si.name,\n        '' AS service_id,\n        TRIM(si.path) AS path,\n        si.source,\n        si.args,\n        si.username,\n        si.status,\n        'Startup Item (Generic)' AS type,\n        'NON_WHITELISTED' AS detection_method,\n        'Startup item from startup_items table' AS detection_reason\n    FROM startup_items AS si\n    WHERE TRIM(si.path) IS NOT NULL\n        AND TRIM(si.path) != ''\n        AND TRIM(si.path) NOT LIKE '/usr/lib/systemd/%'\n        AND TRIM(si.path) NOT LIKE '/lib/systemd/%'\n        AND TRIM(si.path) NOT LIKE '/usr/share/dbus-1/%'\n        AND TRIM(si.path) NOT LIKE '/etc/init.d/%'\n        AND TRIM(si.path) NOT LIKE '/run/systemd/generator/%'\n        AND TRIM(si.path) NOT LIKE '/run/systemd/generator.late/%'\n        AND TRIM(si.path) NOT LIKE '/run/systemd/transient/%'\n        AND TRIM(si.path) NOT LIKE '/run/systemd/system/%'\n        AND TRIM(si.path) NOT LIKE '/etc/systemd/system/%'\n        AND si.source NOT LIKE '/etc/xdg/autostart/%'\n        AND si.source NOT LIKE '/usr/share/gnome/autostart/%'\n        AND si.source NOT LIKE '/usr/share/autostart/%'\n        AND si.source NOT LIKE '/usr/share/gdm/autostart/%'\n        AND si.source NOT LIKE '/usr/share/applications/%'\n        AND si.name NOT LIKE 'snap-%.mount'\n        AND si.name NOT LIKE 'snap%.mount'\n        AND si.name NOT LIKE 'session-%.scope'\n        AND si.name NOT LIKE 'user-%.slice'\n        AND si.name NOT LIKE 'user@%.service'\n        AND si.name NOT LIKE '%.mount'\n        AND si.name NOT LIKE '%.automount'\n        AND si.name NOT LIKE '%.socket'\n        AND si.name NOT LIKE '%.timer'\n        AND si.name NOT LIKE '%.path'\n        AND si.name NOT LIKE '%.target'\n        AND si.name NOT LIKE '%.slice'\n        AND si.name NOT LIKE '%.swap'\n        AND si.name NOT LIKE '%.device'\n        AND si.name NOT LIKE 'systemd-%'\n        AND si.name NOT LIKE 'dbus-%'\n        AND si.name NOT LIKE 'getty@%'\n        AND si.name NOT LIKE 'GNOME %'\n        AND si.name NOT LIKE 'gsd-%'\n        AND si.name NOT IN (\n            'sshd', 'ssh.service', 'sshd.service', 'cron', 'cron.service',\n            'crond', 'crond.service', 'rsyslogd', 'rsyslog.service',\n            'chronyd', 'chronyd.service', 'ntpd', 'ntpd.service',\n            'NetworkManager', 'NetworkManager.service', 'dockerd', 'docker.service',\n            'containerd', 'containerd.service', 'snapd', 'snapd.service',\n            'polkitd', 'polkit.service', 'gdm', 'gdm.service', 'gdm3',\n            'lightdm', 'lightdm.service', 'sddm', 'sddm.service',\n            'cupsd', 'cups.service', 'cups-browsed', 'cups-browsed.service',\n            'avahi-daemon', 'avahi-daemon.service', 'bluetoothd', 'bluetooth',\n            'bluetooth.service', 'ModemManager', 'ModemManager.service',\n            'udisksd', 'udisks2.service', 'upowerd', 'upower.service',\n            'thermald', 'thermald.service', 'fwupd', 'fwupd.service',\n            'packagekitd', 'packagekit.service', 'elastic-agent', 'elastic-agent.service',\n            'filebeat', 'filebeat.service', 'metricbeat', 'metricbeat.service',\n            'auditbeat', 'auditbeat.service', 'osqueryd', 'osqueryd.service',\n            'dbus', 'dbus.service', 'accounts-daemon.service', 'apport.service',\n            'apparmor.service', 'ufw.service', 'firewalld.service'\n        )\n),\nlotl_systemd AS (\n    SELECT\n        su.id AS name,\n        su.id AS service_id,\n        TRIM(su.fragment_path) AS path,\n        TRIM(su.fragment_path) AS source,\n        su.description AS args,\n        su.user AS username,\n        CASE\n            WHEN su.unit_file_state = 'enabled' THEN 'enabled'\n            WHEN su.unit_file_state = 'disabled' THEN 'disabled'\n            ELSE su.unit_file_state\n        END AS status,\n        'Systemd Service (LotL)' AS type,\n        'LOTL_INDICATOR' AS detection_method,\n        CASE\n            WHEN su.description LIKE '%bash -c%' OR su.description LIKE '%sh -c%' THEN 'Shell command execution via -c flag'\n            WHEN su.description LIKE '%curl%|%bash%' OR su.description LIKE '%wget%|%sh%' THEN 'Download and pipe to shell'\n            WHEN su.description LIKE '%curl%http%' OR su.description LIKE '%wget%http%' THEN 'Download utility abuse'\n            WHEN su.description LIKE '%base64 -d%' OR su.description LIKE '%base64 --decode%' THEN 'Base64 decode for obfuscation'\n            WHEN su.description LIKE '%/dev/shm/%' OR su.description LIKE '%/tmp/%' THEN 'Execution from world-writable directory'\n            WHEN su.description LIKE '%nc %' OR su.description LIKE '%netcat%' OR su.description LIKE '%ncat %' THEN 'Netcat reverse shell'\n            WHEN su.description LIKE '%/dev/tcp/%' THEN 'Bash TCP socket redirection'\n            WHEN su.description LIKE '%nohup%&%' OR su.description LIKE '%disown%' THEN 'Background process persistence'\n            WHEN su.description LIKE '%.sh%' AND TRIM(su.fragment_path) LIKE '/tmp/%' THEN 'Shell script from temp directory'\n            WHEN su.description LIKE '%python% -c%' OR su.description LIKE '%perl% -e%' THEN 'Scripting language one-liner'\n            WHEN su.description LIKE '%chmod +x%' AND su.description LIKE '%http%' THEN 'Download and execute pattern'\n            ELSE 'Unknown LotL pattern in systemd'\n        END AS detection_reason\n    FROM systemd_units AS su\n    WHERE TRIM(su.fragment_path) IS NOT NULL\n        AND su.id LIKE '%.service'\n        AND su.unit_file_state IN ('enabled', 'static', 'linked')\n        AND (\n            su.description LIKE '%bash -c%'\n            OR su.description LIKE '%sh -c%'\n            OR su.description LIKE '%curl%|%bash%'\n            OR su.description LIKE '%wget%|%sh%'\n            OR su.description LIKE '%curl%http%'\n            OR su.description LIKE '%wget%http%'\n            OR su.description LIKE '%base64 -d%'\n            OR su.description LIKE '%base64 --decode%'\n            OR su.description LIKE '%/dev/shm/%'\n            OR su.description LIKE '%/tmp/%'\n            OR su.description LIKE '%nc %'\n            OR su.description LIKE '%netcat%'\n            OR su.description LIKE '%ncat %'\n            OR su.description LIKE '%/dev/tcp/%'\n            OR su.description LIKE '%nohup%&%'\n            OR su.description LIKE '%disown%'\n            OR (su.description LIKE '%.sh%' AND TRIM(su.fragment_path) LIKE '/tmp/%')\n            OR su.description LIKE '%python% -c%'\n            OR su.description LIKE '%perl% -e%'\n            OR (su.description LIKE '%chmod +x%' AND su.description LIKE '%http%')\n        )\n),\nlotl_cron AS (\n    SELECT\n        SUBSTR(c.command, 1, 100) AS name,\n        '' AS service_id,\n        TRIM(c.path) AS path,\n        TRIM(c.path) AS source,\n        c.command AS args,\n        CASE\n            WHEN TRIM(c.path) LIKE '/var/spool/cron/crontabs/%' THEN REPLACE(TRIM(c.path), '/var/spool/cron/crontabs/', '')\n            WHEN TRIM(c.path) LIKE '/var/spool/cron/%' THEN REPLACE(REPLACE(TRIM(c.path), '/var/spool/cron/', ''), 'crontabs/', '')\n            ELSE 'root'\n        END AS username,\n        'enabled' AS status,\n        'Cron (LotL)' AS type,\n        'LOTL_INDICATOR' AS detection_method,\n        CASE\n            WHEN c.command LIKE '%bash -c%' OR c.command LIKE '%sh -c%' THEN 'Shell command execution via -c flag'\n            WHEN c.command LIKE '%curl%|%bash%' OR c.command LIKE '%wget%|%sh%' THEN 'Download and pipe to shell'\n            WHEN c.command LIKE '%curl%http%' OR c.command LIKE '%wget%http%' THEN 'Download utility abuse'\n            WHEN c.command LIKE '%base64 -d%' OR c.command LIKE '%base64 --decode%' THEN 'Base64 decode for obfuscation'\n            WHEN c.command LIKE '%/dev/shm/%' OR c.command LIKE '%/tmp/%' THEN 'Execution from world-writable directory'\n            WHEN c.command LIKE '%nc %' OR c.command LIKE '%netcat%' OR c.command LIKE '%ncat %' THEN 'Netcat reverse shell'\n            WHEN c.command LIKE '%/dev/tcp/%' THEN 'Bash TCP socket redirection'\n            WHEN c.command LIKE '%nohup%&%' OR c.command LIKE '%disown%' THEN 'Background process persistence'\n            WHEN c.command LIKE '%python% -c%' OR c.command LIKE '%perl% -e%' THEN 'Scripting language one-liner'\n            WHEN c.command LIKE '%chmod +x%' AND c.command LIKE '%http%' THEN 'Download and execute pattern'\n            ELSE 'Unknown LotL pattern in cron'\n        END AS detection_reason\n    FROM crontab AS c\n    WHERE c.command IS NOT NULL\n        AND (\n            c.command LIKE '%bash -c%'\n            OR c.command LIKE '%sh -c%'\n            OR c.command LIKE '%curl%|%bash%'\n            OR c.command LIKE '%wget%|%sh%'\n            OR c.command LIKE '%curl%http%'\n            OR c.command LIKE '%wget%http%'\n            OR c.command LIKE '%base64 -d%'\n            OR c.command LIKE '%base64 --decode%'\n            OR c.command LIKE '%/dev/shm/%'\n            OR c.command LIKE '%/tmp/%'\n            OR c.command LIKE '%nc %'\n            OR c.command LIKE '%netcat%'\n            OR c.command LIKE '%ncat %'\n            OR c.command LIKE '%/dev/tcp/%'\n            OR c.command LIKE '%nohup%&%'\n            OR c.command LIKE '%disown%'\n            OR c.command LIKE '%python% -c%'\n            OR c.command LIKE '%perl% -e%'\n            OR (c.command LIKE '%chmod +x%' AND c.command LIKE '%http%')\n        )\n),\nlotl_startup AS (\n    SELECT\n        si.name,\n        '' AS service_id,\n        TRIM(si.path) AS path,\n        si.source,\n        si.args,\n        si.username,\n        si.status,\n        'Startup Item (LotL)' AS type,\n        'LOTL_INDICATOR' AS detection_method,\n        CASE\n            WHEN si.args LIKE '%bash -c%' OR si.args LIKE '%sh -c%' THEN 'Shell command execution via -c flag'\n            WHEN si.args LIKE '%curl%|%bash%' OR si.args LIKE '%wget%|%sh%' THEN 'Download and pipe to shell'\n            WHEN si.args LIKE '%curl%http%' OR si.args LIKE '%wget%http%' THEN 'Download utility abuse'\n            WHEN si.args LIKE '%base64 -d%' OR si.args LIKE '%base64 --decode%' THEN 'Base64 decode for obfuscation'\n            WHEN TRIM(si.path) LIKE '%/dev/shm/%' OR TRIM(si.path) LIKE '%/tmp/%' THEN 'Execution from world-writable directory'\n            WHEN si.args LIKE '%nc %' OR si.args LIKE '%netcat%' OR si.args LIKE '%ncat %' THEN 'Netcat reverse shell'\n            WHEN si.args LIKE '%/dev/tcp/%' THEN 'Bash TCP socket redirection'\n            WHEN si.args LIKE '%nohup%&%' OR si.args LIKE '%disown%' THEN 'Background process persistence'\n            WHEN si.args LIKE '%python% -c%' OR si.args LIKE '%perl% -e%' THEN 'Scripting language one-liner'\n            WHEN si.args LIKE '%chmod +x%' AND si.args LIKE '%http%' THEN 'Download and execute pattern'\n            ELSE 'Unknown LotL pattern in startup_items'\n        END AS detection_reason\n    FROM startup_items AS si\n    WHERE TRIM(si.path) IS NOT NULL\n        AND TRIM(si.path) != ''\n        AND (\n            si.args LIKE '%bash -c%'\n            OR si.args LIKE '%sh -c%'\n            OR si.args LIKE '%curl%|%bash%'\n            OR si.args LIKE '%wget%|%sh%'\n            OR si.args LIKE '%curl%http%'\n            OR si.args LIKE '%wget%http%'\n            OR si.args LIKE '%base64 -d%'\n            OR si.args LIKE '%base64 --decode%'\n            OR TRIM(si.path) LIKE '%/dev/shm/%'\n            OR TRIM(si.path) LIKE '%/tmp/%'\n            OR si.args LIKE '%nc %'\n            OR si.args LIKE '%netcat%'\n            OR si.args LIKE '%ncat %'\n            OR si.args LIKE '%/dev/tcp/%'\n            OR si.args LIKE '%nohup%&%'\n            OR si.args LIKE '%disown%'\n            OR si.args LIKE '%python% -c%'\n            OR si.args LIKE '%perl% -e%'\n            OR (si.args LIKE '%chmod +x%' AND si.args LIKE '%http%')\n        )\n),\ncombined AS (\n    SELECT * FROM non_whitelisted_systemd\n    UNION ALL\n    SELECT * FROM non_whitelisted_cron\n    UNION ALL\n    SELECT * FROM non_whitelisted_xdg\n    UNION ALL\n    SELECT * FROM non_whitelisted_startup\n    UNION ALL\n    SELECT * FROM lotl_systemd\n    UNION ALL\n    SELECT * FROM lotl_cron\n    UNION ALL\n    SELECT * FROM lotl_startup\n)\nSELECT\n    c.name,\n    c.service_id,\n    c.path,\n    c.type,\n    c.status,\n    c.source,\n    c.args,\n    c.username,\n    c.detection_method,\n    c.detection_reason,\n    h.sha256,\n    h.sha1,\n    h.md5,\n    f.size,\n    datetime(f.mtime, 'unixepoch') AS modified_time,\n    datetime(f.ctime, 'unixepoch') AS changed_time,\n    datetime(f.atime, 'unixepoch') AS accessed_time,\n    datetime(f.btime, 'unixepoch') AS created_time,\n    f.uid,\n    f.gid,\n    f.mode\nFROM combined AS c\nLEFT JOIN hash AS h ON h.path = c.path\nLEFT JOIN file AS f ON f.path = c.path\nORDER BY\n    CASE WHEN c.detection_method = 'LOTL_INDICATOR' THEN 0 ELSE 1 END,\n    c.detection_reason,\n    c.type,\n    c.name",
        "updated_at": "2025-11-21T00:00:00.000Z",
        "updated_by": "elastic"
    },
    "coreMigrationVersion": "9.2.0",
    "id": "osquery_manager-e5f6a7b8-c9d0-23ef-4567-890123456789",
    "references": [],
    "type": "osquery-saved-query",
    "updated_at": "2025-11-21T00:00:00.000Z",
    "version": "WzEwNTUzLDJd"
}
