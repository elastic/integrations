{
    "attributes": {
        "created_at": "2026-01-29T00:00:00.000Z",
        "created_by": "elastic",
        "updated_by": "elastic",
        "description": "Detects suspicious process memory patterns indicating potential code injection (MITRE T1055). Flags: (1) Executable from temp directories, (2) Executable from hidden directories, (3) RWX unbacked memory (shellcode), (4) RWX file-backed memory (code patching), (5) Unbacked executable regions. Anomaly indicators: PPID spoofing, process-not-on-disk, protected process abuse, name/path mismatch (masquerading T1036), system binary unusual location. Includes hash enrichment and parent relationship classification. Excludes JIT runtimes. Cross-platform: Windows, macOS, Linux.",
        "ecs_mapping": [
            {
                "key": "event.category",
                "value": {
                    "value": ["process"]
                }
            },
            {
                "key": "event.type",
                "value": {
                    "value": ["info"]
                }
            },
            {
                "key": "event.action",
                "value": {
                    "value": "osquery.process_memory_suspicious"
                }
            },
            {
                "key": "process.pid",
                "value": {
                    "field": "pid"
                }
            },
            {
                "key": "process.name",
                "value": {
                    "field": "process_name"
                }
            },
            {
                "key": "process.executable",
                "value": {
                    "field": "process_path"
                }
            },
            {
                "key": "process.command_line",
                "value": {
                    "field": "cmdline"
                }
            },
            {
                "key": "process.parent.pid",
                "value": {
                    "field": "ppid"
                }
            },
            {
                "key": "process.parent.name",
                "value": {
                    "field": "parent_name"
                }
            },
            {
                "key": "process.parent.executable",
                "value": {
                    "field": "parent_path"
                }
            },
            {
                "key": "process.parent.command_line",
                "value": {
                    "field": "parent_cmdline"
                }
            },
            {
                "key": "process.start",
                "value": {
                    "field": "start_time"
                }
            },
            {
                "key": "user.id",
                "value": {
                    "field": "uid"
                }
            },
            {
                "key": "dll.path",
                "value": {
                    "field": "dll_path"
                }
            },
            {
                "key": "dll.hash.md5",
                "value": {
                    "field": "md5"
                }
            },
            {
                "key": "dll.hash.sha1",
                "value": {
                    "field": "sha1"
                }
            },
            {
                "key": "dll.hash.sha256",
                "value": {
                    "field": "sha256"
                }
            },
            {
                "key": "tags",
                "value": {
                    "value": ["osquery", "process", "memory_forensics", "process_injection", "threat_hunting", "masquerading"]
                }
            }
        ],
        "id": "process_memory_suspicious_elastic",
        "interval": "3600",
        "platform": "darwin,linux,windows",
        "timeout": 300,
        "query": "-- Process Memory Map: Suspicious Memory Analysis\n-- Detects code injection indicators via memory region analysis\n-- 5 detection patterns: temp/hidden executables, RWX regions (unbacked + file-backed)\n-- 5 anomaly indicators: PPID spoofing, not on disk, protected process, name mismatch, unusual location\nSELECT\n    p.pid,\n    p.name AS process_name,\n    p.path AS process_path,\n    p.cmdline,\n    p.on_disk,\n    m.start AS memory_start,\n    m.end AS memory_end,\n    m.permissions,\n    m.path AS dll_path,\n    m.pseudo AS is_pseudo,\n    m.offset,\n    -- Parent/child relationship\n    p.parent AS ppid,\n    pp.name AS parent_name,\n    pp.path AS parent_path,\n    pp.cmdline AS parent_cmdline,\n    -- Timestamps for PPID spoofing analysis\n    p.start_time AS process_start_epoch,\n    pp.start_time AS parent_start_epoch,\n    datetime(p.start_time, 'unixepoch') AS start_time,\n    datetime(pp.start_time, 'unixepoch') AS parent_start_time,\n    p.uid,\n    -- Hash enrichment (NULL for unbacked regions)\n    h.md5,\n    h.sha1,\n    h.sha256,\n    CASE\n        WHEN h.sha256 IS NOT NULL AND h.sha256 != ''\n        THEN 'https://www.virustotal.com/gui/file/' || h.sha256\n        ELSE NULL\n    END AS vt_link,\n    -- Detection reason (5 patterns)\n    CASE\n        -- Executable from temp directories (high fidelity)\n        WHEN (m.permissions LIKE '%x%' OR m.permissions LIKE '%EXECUTE%')\n             AND (m.path LIKE '/tmp/%' OR m.path LIKE '/var/tmp/%' OR m.path LIKE '/dev/shm/%'\n                  OR m.path LIKE '%\\Temp\\%' OR m.path LIKE '%\\AppData\\Local\\Temp\\%')\n            THEN 'executable_from_temp'\n        -- Executable from hidden directories (high fidelity)\n        WHEN (m.permissions LIKE '%x%' OR m.permissions LIKE '%EXECUTE%')\n             AND (m.path LIKE '/home/%/.%' OR m.path LIKE '/root/.%' OR m.path LIKE '%/Users/%/.%'\n                  OR m.path LIKE 'C:\\Users\\%\\.%' OR m.path LIKE '%\\Users\\%\\.%')\n            THEN 'executable_from_hidden'\n        -- RWX memory without file backing (shellcode indicator)\n        WHEN ((m.permissions LIKE '%w%' AND m.permissions LIKE '%x%')\n              OR (m.permissions LIKE '%WRITE%' AND m.permissions LIKE '%EXECUTE%'))\n             AND (m.pseudo = 1 OR m.path = '' OR m.path LIKE '[%')\n            THEN 'rwx_unbacked_memory'\n        -- RWX memory WITH file backing (code patching indicator)\n        WHEN ((m.permissions LIKE '%w%' AND m.permissions LIKE '%x%')\n              OR (m.permissions LIKE '%WRITE%' AND m.permissions LIKE '%EXECUTE%'))\n             AND m.path != '' AND m.path NOT LIKE '[%' AND m.pseudo != 1\n            THEN 'rwx_file_backed'\n        -- Unbacked executable region\n        WHEN (m.permissions LIKE '%x%' OR m.permissions LIKE '%EXECUTE%')\n             AND m.pseudo = 1\n             AND m.path NOT IN ('[vdso]', '[vsyscall]', '[vvar]', '[heap]', '[stack]')\n            THEN 'unbacked_executable'\n        ELSE 'unknown'\n    END AS detection_reason,\n    -- Anomaly indicators (5 checks, prioritized)\n    CASE\n        -- PPID spoofing: child started before parent (impossible normally)\n        WHEN pp.start_time IS NOT NULL AND p.start_time < pp.start_time\n            THEN 'PPID_SPOOFING'\n        -- Process binary deleted while running (fileless)\n        WHEN p.on_disk = 0\n            THEN 'PROCESS_NOT_ON_DISK'\n        -- Protected process with unusual parent (Windows)\n        WHEN p.name IN ('svchost.exe', 'lsass.exe', 'csrss.exe', 'smss.exe', 'wininit.exe', 'services.exe')\n             AND pp.name NOT IN ('services.exe', 'wininit.exe', 'smss.exe', 'System', 'winlogon.exe')\n             AND pp.name IS NOT NULL\n            THEN 'PROTECTED_PROCESS_ABUSE'\n        -- Process name doesn't match executable filename (masquerading T1036)\n        WHEN p.name != REPLACE(REPLACE(p.path, RTRIM(p.path, REPLACE(p.path, '/', '')), ''), RTRIM(p.path, REPLACE(p.path, '\\', '')), '')\n             AND p.path != ''\n             AND p.name NOT LIKE '%.exe'\n             AND p.path LIKE '%.exe'\n            THEN 'NAME_PATH_MISMATCH'\n        -- System binary running from unusual location (copied/renamed)\n        WHEN (p.name IN ('cmd.exe', 'powershell.exe', 'pwsh.exe', 'certutil.exe', 'mshta.exe', 'regsvr32.exe', 'rundll32.exe')\n              AND p.path NOT LIKE 'C:\\Windows\\System32\\%'\n              AND p.path NOT LIKE 'C:\\Windows\\SysWOW64\\%'\n              AND p.path NOT LIKE '%\\WindowsApps\\%')\n             OR (p.name IN ('bash', 'sh', 'curl', 'wget', 'python', 'perl')\n                 AND p.path NOT LIKE '/bin/%'\n                 AND p.path NOT LIKE '/usr/bin/%'\n                 AND p.path NOT LIKE '/usr/local/bin/%')\n            THEN 'SYSTEM_BINARY_UNUSUAL_LOCATION'\n        ELSE NULL\n    END AS anomaly_indicator,\n    -- Parent relationship classification\n    CASE\n        WHEN pp.path IS NULL THEN 'orphan_process'\n        WHEN pp.start_time IS NOT NULL AND p.start_time < pp.start_time THEN 'ppid_spoofed'\n        WHEN pp.name = 'init' OR pp.name = 'systemd' OR pp.name = 'launchd' THEN 'system_spawned'\n        WHEN pp.name IN ('explorer.exe', 'userinit.exe') THEN 'user_session_spawned'\n        WHEN pp.name IN ('services.exe', 'svchost.exe', 'System') THEN 'service_spawned'\n        WHEN pp.name IN ('cmd.exe', 'powershell.exe', 'pwsh.exe', 'bash', 'sh', 'zsh') THEN 'shell_spawned'\n        WHEN pp.name IN ('wscript.exe', 'cscript.exe', 'mshta.exe') THEN 'script_engine_spawned'\n        ELSE 'other_parent'\n    END AS parent_relationship\nFROM process_memory_map m\nJOIN processes p ON m.pid = p.pid\nLEFT JOIN processes pp ON p.parent = pp.pid\nLEFT JOIN hash h ON TRIM(m.path) = h.path AND m.path != '' AND m.path NOT LIKE '[%'\nWHERE (\n    -- Pattern 1: Executable from temp directories\n    ((m.permissions LIKE '%x%' OR m.permissions LIKE '%EXECUTE%')\n     AND (m.path LIKE '/tmp/%' OR m.path LIKE '/var/tmp/%' OR m.path LIKE '/dev/shm/%'\n          OR m.path LIKE '%\\Temp\\%' OR m.path LIKE '%\\AppData\\Local\\Temp\\%'))\n    -- Pattern 2: Executable from hidden directories\n    OR ((m.permissions LIKE '%x%' OR m.permissions LIKE '%EXECUTE%')\n        AND (m.path LIKE '/home/%/.%' OR m.path LIKE '/root/.%' OR m.path LIKE '%/Users/%/.%'\n             OR m.path LIKE 'C:\\Users\\%\\.%' OR m.path LIKE '%\\Users\\%\\.%'))\n    -- Pattern 3: RWX memory without file backing (shellcode)\n    OR (((m.permissions LIKE '%w%' AND m.permissions LIKE '%x%')\n         OR (m.permissions LIKE '%WRITE%' AND m.permissions LIKE '%EXECUTE%'))\n        AND (m.pseudo = 1 OR m.path = '' OR m.path LIKE '[%'))\n    -- Pattern 4: RWX memory WITH file backing (code patching)\n    OR (((m.permissions LIKE '%w%' AND m.permissions LIKE '%x%')\n         OR (m.permissions LIKE '%WRITE%' AND m.permissions LIKE '%EXECUTE%'))\n        AND m.path != '' AND m.path NOT LIKE '[%' AND m.pseudo != 1)\n    -- Pattern 5: Unbacked executable\n    OR ((m.permissions LIKE '%x%' OR m.permissions LIKE '%EXECUTE%')\n        AND m.pseudo = 1\n        AND m.path NOT IN ('[vdso]', '[vsyscall]', '[vvar]', '[heap]', '[stack]'))\n)\n-- Exclude JIT runtimes (legitimate RWX usage)\nAND p.name NOT IN (\n    'java', 'javaw', 'java.exe', 'javaw.exe',\n    'node', 'node.exe',\n    'chrome', 'chrome.exe', 'chromium', 'chromium-browser',\n    'firefox', 'firefox.exe', 'safari',\n    'msedge.exe', 'MicrosoftEdge.exe',\n    'dotnet', 'dotnet.exe', 'mono',\n    'pwsh', 'pwsh.exe', 'powershell', 'powershell.exe',\n    'gnome-shell', 'gnome-terminal-', 'gjs', 'gjs-console'\n)\nAND p.path NOT LIKE '/usr/lib/jvm/%'\nAND p.path NOT LIKE '%/node_modules/%'\nAND p.path NOT LIKE '/usr/bin/python%'\nAND p.path NOT LIKE '/usr/libexec/gnome-%'\nAND p.pid != 1\nORDER BY\n    -- Prioritize by anomaly (most critical first)\n    CASE anomaly_indicator\n        WHEN 'PPID_SPOOFING' THEN 1\n        WHEN 'PROCESS_NOT_ON_DISK' THEN 2\n        WHEN 'PROTECTED_PROCESS_ABUSE' THEN 3\n        WHEN 'NAME_PATH_MISMATCH' THEN 4\n        WHEN 'SYSTEM_BINARY_UNUSUAL_LOCATION' THEN 5\n        ELSE 6\n    END,\n    -- Then by detection reason\n    CASE detection_reason\n        WHEN 'executable_from_temp' THEN 1\n        WHEN 'executable_from_hidden' THEN 2\n        WHEN 'rwx_unbacked_memory' THEN 3\n        WHEN 'rwx_file_backed' THEN 4\n        WHEN 'unbacked_executable' THEN 5\n        ELSE 6\n    END,\n    p.pid;"
    },
    "coreMigrationVersion": "9.3.0",
    "id": "osquery_manager-a1b2c3d4-mem1-11f0-8f39-bf9c07530bbb",
    "references": [],
    "type": "osquery-saved-query",
    "updated_at": "2026-01-30T12:00:00.000Z",
    "version": "WzEsMV0="
}
