# Cilium Tetragon Integration for Elastic

## Overview

The Cilium Tetragon integration enables you to monitor and analyze events from [Tetragon](https://tetragon.io/), a Kubernetes-aware security observability and runtime enforcement tool supported by the CNCF. This integration provides insight into Tetragon's security event logs, allowing you to visualize data in Kibana, set up alerts, and quickly respond to security events within your Kubernetes environment. This integration facilitates the collection of Cilium Tetragon logs from Kubernetes environments.

### How it works

This integration works by collecting log files generated by Cilium Tetragon. It uses a Filebeat sidecar container to read the JSON-formatted logs from a shared volume and forwards them to your Elastic deployment. The logs are then processed and indexed, making them available for analysis in Kibana.

## What data does this integration collect?

This integration collects security event logs from Cilium Tetragon. These logs provide detailed information about runtime security events within your Kubernetes cluster, such as process execution, file access, and network activity.

### Supported use cases

By ingesting Cilium Tetragon logs into Elastic, you can:
-   Gain real-time visibility into security-relevant activities in your Kubernetes clusters.
-   Create dashboards to monitor key security metrics and trends.
-   Set up alerts to be notified of suspicious or malicious behavior.
-   Correlate Tetragon events with other data sources for comprehensive threat hunting and incident response.

## What do I need to use this integration?

-   An active Elastic deployment.
-   A Kubernetes cluster with Cilium Tetragon installed.
-   `kubectl` and `helm` installed and configured to interact with your cluster.

## How do I deploy this integration?

### Onboard / configure

#### Step 1: Install Integration Assets in Kibana

Before you can start collecting data, you need to install the integration assets, such as dashboards and ingest pipelines, into your Elastic deployment.

1.  Open Kibana and navigate to **Management > Integrations**.
2.  Search for "Cilium Tetragon" and click on the integration.
3.  Click **Add Cilium Tetragon**.
4.  On the next screen, click **Add integration only** to install the assets. You can skip the Elastic Agent installation steps as this integration uses a different collection method.

#### Step 2: Configure Tetragon for JSON Export

Tetragon must be configured to export its event data as JSON logs. This is done by deploying a Filebeat sidecar container alongside the Tetragon agent pods. The following steps guide you through setting up the necessary Kubernetes resources.

**1. Create a Filebeat ConfigMap**

This ConfigMap will hold the Filebeat configuration, which tells Filebeat how to find and parse the Tetragon logs and where to send them.

Create a file named `filebeat-cfgmap.yaml` with the following content. **Remember to replace the placeholder values for your Elasticsearch endpoint, username, and password.**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-configmap
  namespace: kube-system
data:
  filebeat.yml: |
    filebeat.inputs:
      - type: filestream
        id: tetragon-log
        enabled: true
        paths:
          - /var/run/cilium/tetragon/*.log
    path.data: /usr/share/filebeat/data
    processors:
      - timestamp:
          field: "time"
          layouts:
            - '2006-01-02T15:04:05Z'
            - '2006-01-02T15:04:05.999Z'
            - '2006-01-02T15:04:05.999-07:00'
          test:
            - '2019-06-22T16:33:51Z'
            - '2019-11-18T04:59:51.123Z'
            - '2020-08-03T07:10:20.123456+02:00'
    setup.template.name: logs
    setup.template.pattern: "logs-cilium_tetragon.*"
    output.elasticsearch:
      hosts: ["https://<your-elasticsearch-host>"]
      username: "<your-username>"
      password: "<your-password>"
      index: logs-cilium_tetragon.log-default
```

Apply the ConfigMap to your cluster:
```shell
kubectl create -f filebeat-cfgmap.yaml
```

**2. Install Tetragon with the Filebeat Sidecar**

Now, use Helm to install or upgrade Tetragon. You'll provide a values file to configure Tetragon to use the Filebeat sidecar for log export.

Create a file named `filebeat-helm-values.yaml` with the following content:

```yaml
export:
  securityContext:
    runAsUser: 0
    runAsGroup: 0
  stdout:
    enabledCommand: false
    enabledArgs: false
    image:
      override: "docker.elastic.co/beats/filebeat:8.15.3"
    extraVolumeMounts:
      - name: filebeat-config
        mountPath: /usr/share/filebeat/filebeat.yml
        subPath: filebeat.yml
      - name: filebeat-data
        mountPath: /usr/share/filebeat/data
extraVolumes:
  - name: filebeat-data
    hostPath:
      path: /var/run/cilium/tetragon/filebeat
      type: DirectoryOrCreate
  - name: filebeat-config
    configMap:
      name: filebeat-configmap
      items:
        - key: filebeat.yml
          path: filebeat.yml
```

Now, add the Cilium Helm repository and install Tetragon using the values file:

```shell
helm repo add cilium https://helm.cilium.io
helm repo update
helm install tetragon -f filebeat-helm-values.yaml cilium/tetragon -n kube-system
```

If you have an existing Tetragon installation, use `helm upgrade` instead of `helm install`.

### Validation

After a few minutes, you can validate that data is being collected by navigating to the **Discover** tab in Kibana and searching for documents in the `logs-cilium_tetragon.log-default` index. You can also check the pre-built dashboards provided by the integration.

1. In Kibana, navigate to **Dashboards**.
2. Search for "Cilium Tetragon" to find the relevant dashboards.
3. Open a dashboard and verify that it is populated with data from your cluster.

## Troubleshooting

If you are not seeing logs in Elasticsearch, check the following:
-   **Filebeat Sidecar Logs:** Check the logs of the Filebeat container within the Tetragon pods for any connection errors or configuration issues.
    ```shell
    kubectl logs -n kube-system <tetragon-pod-name> -c stdout
    ```
-   **Tetragon Export Configuration:** Ensure that your Tetragon Helm chart values correctly configure the log exporter. You may need to adjust the `tetragon.exportAllowList` or `tetragon.exportDenyList` to control which events are exported.
-   **Elasticsearch Credentials:** Double-check that the Elasticsearch host, username, and password in your `filebeat-configmap` are correct.

For more information, refer to the official [Tetragon documentation](https://tetragon.io/docs/).

## Reference

### log

The `log` data stream captures event logs from Tetragon. These events are indexed as `logs-cilium_tetragon.log-default` in Elasticsearch.

#### log fields

**Exported fields**

| Field | Description | Type |
|---|---|---|
| @timestamp | Event timestamp. | date |
| cilium_tetragon.log.cluster_name |  | keyword |
| cilium_tetragon.log.node_name |  | keyword |
| cilium_tetragon.log.process_exec.parent.auid |  | long |
| cilium_tetragon.log.process_exec.parent.docker |  | keyword |
| cilium_tetragon.log.process_exec.parent.exec_id |  | keyword |
| cilium_tetragon.log.process_exec.parent.flags |  | keyword |
| cilium_tetragon.log.process_exec.parent.parent_exec_id |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.container.id |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.container.image.id |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.container.image.name |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.container.name |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.container.pid |  | long |
| cilium_tetragon.log.process_exec.parent.pod.container.start_time |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.name |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.namespace |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.pod_labels.app.kubernetes.io/name |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.pod_labels.class |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.pod_labels.org |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.pod_labels.pod-template-hash |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.workload |  | keyword |
| cilium_tetragon.log.process_exec.parent.pod.workload_kind |  | keyword |
| cilium_tetragon.log.process_exec.parent.refcnt |  | long |
| cilium_tetragon.log.process_exec.parent.start_time |  | keyword |
| cilium_tetragon.log.process_exec.parent.tid |  | long |
| cilium_tetragon.log.process_exec.process.auid |  | long |
| cilium_tetragon.log.process_exec.process.docker |  | keyword |
| cilium_tetragon.log.process_exec.process.exec_id |  | keyword |
| cilium_tetragon.log.process_exec.process.flags |  | keyword |
| cilium_tetragon.log.process_exec.process.parent_exec_id |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.container.image.id |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.container.pid |  | long |
| cilium_tetragon.log.process_exec.process.pod.container.start_time |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.name |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.namespace |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.pod_labels.app |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.pod_labels.app.kubernetes.io/name |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.pod_labels.class |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.pod_labels.org |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.pod_labels.pod-template-hash |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.workload |  | keyword |
| cilium_tetragon.log.process_exec.process.pod.workload_kind |  | keyword |
| cilium_tetragon.log.process_exec.process.start_time |  | keyword |
| cilium_tetragon.log.process_exec.process.uid |  | long |
| cilium_tetragon.log.process_exit.parent.auid |  | long |
| cilium_tetragon.log.process_exit.parent.docker |  | keyword |
| cilium_tetragon.log.process_exit.parent.exec_id |  | keyword |
| cilium_tetragon.log.process_exit.parent.flags |  | keyword |
| cilium_tetragon.log.process_exit.parent.parent_exec_id |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.container.id |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.container.image.id |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.container.image.name |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.container.name |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.container.pid |  | long |
| cilium_tetragon.log.process_exit.parent.pod.container.start_time |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.name |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.namespace |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.pod_labels.app.kubernetes.io/name |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.pod_labels.class |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.pod_labels.org |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.pod_labels.pod-template-hash |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.workload |  | keyword |
| cilium_tetragon.log.process_exit.parent.pod.workload_kind |  | keyword |
| cilium_tetragon.log.process_exit.parent.refcnt |  | long |
| cilium_tetragon.log.process_exit.parent.start_time |  | keyword |
| cilium_tetragon.log.process_exit.parent.tid |  | long |
| cilium_tetragon.log.process_exit.process.auid |  | long |
| cilium_tetragon.log.process_exit.process.docker |  | keyword |
| cilium_tetragon.log.process_exit.process.exec_id |  | keyword |
| cilium_tetragon.log.process_exit.process.flags |  | keyword |
| cilium_tetragon.log.process_exit.process.parent_exec_id |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.container.image.id |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.container.pid |  | long |
| cilium_tetragon.log.process_exit.process.pod.container.start_time |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.name |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.namespace |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.pod_labels.app.kubernetes.io/name |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.pod_labels.class |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.pod_labels.org |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.pod_labels.pod-template-hash |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.workload |  | keyword |
| cilium_tetragon.log.process_exit.process.pod.workload_kind |  | keyword |
| cilium_tetragon.log.process_exit.process.refcnt |  | long |
| cilium_tetragon.log.process_exit.process.start_time |  | keyword |
| cilium_tetragon.log.process_exit.process.uid |  | long |
| cilium_tetragon.log.process_exit.signal |  | keyword |
| cilium_tetragon.log.process_exit.status |  | float |
| cilium_tetragon.log.process_exit.time |  | keyword |
| cilium_tetragon.log.process_kprobe.action |  | keyword |
| cilium_tetragon.log.process_kprobe.args.capability_arg.name |  | keyword |
| cilium_tetragon.log.process_kprobe.args.capability_arg.value |  | long |
| cilium_tetragon.log.process_kprobe.args.file_arg.path |  | keyword |
| cilium_tetragon.log.process_kprobe.args.file_arg.permission |  | keyword |
| cilium_tetragon.log.process_kprobe.args.int_arg |  | long |
| cilium_tetragon.log.process_kprobe.args.user_ns_arg.gid |  | long |
| cilium_tetragon.log.process_kprobe.args.user_ns_arg.level |  | long |
| cilium_tetragon.log.process_kprobe.args.user_ns_arg.ns.inum |  | long |
| cilium_tetragon.log.process_kprobe.args.user_ns_arg.ns.is_host |  | boolean |
| cilium_tetragon.log.process_kprobe.args.user_ns_arg.uid |  | long |
| cilium_tetragon.log.process_kprobe.function_name |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.auid |  | long |
| cilium_tetragon.log.process_kprobe.parent.docker |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.flags |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.parent_exec_id |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.container.id |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.container.image.id |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.container.image.name |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.container.name |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.container.pid |  | long |
| cilium_tetragon.log.process_kprobe.parent.pod.container.start_time |  | date |
| cilium_tetragon.log.process_kprobe.parent.pod.name |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.namespace |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.pod_labels.app.kubernetes.io/name |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.pod_labels.class |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.pod_labels.org |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.workload |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.pod.workload_kind |  | keyword |
| cilium_tetragon.log.process_kprobe.parent.refcnt |  | long |
| cilium_tetragon.log.process_kprobe.policy_name |  | keyword |
| cilium_tetragon.log.process_kprobe.process.auid |  | long |
| cilium_tetragon.log.process_kprobe.process.docker |  | keyword |
| cilium_tetragon.log.process_kprobe.process.flags |  | keyword |
| cilium_tetragon.log.process_kprobe.process.ns.cgroup.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.ipc.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.mnt.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.net.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.pid.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.pid.pid_for_children.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.pid_for_children.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.time.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.time.is_host |  | boolean |
| cilium_tetragon.log.process_kprobe.process.ns.time.time_for_children.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.time.time_for_children.is_host |  | boolean |
| cilium_tetragon.log.process_kprobe.process.ns.time_for_children.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.time_for_children.is_host |  | boolean |
| cilium_tetragon.log.process_kprobe.process.ns.user.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.ns.user.is_host |  | boolean |
| cilium_tetragon.log.process_kprobe.process.ns.uts.inum |  | long |
| cilium_tetragon.log.process_kprobe.process.parent_exec_id |  | keyword |
| cilium_tetragon.log.process_kprobe.process.pod.container.image.id |  | keyword |
| cilium_tetragon.log.process_kprobe.process.pod.container.pid |  | long |
| cilium_tetragon.log.process_kprobe.process.pod.container.start_time |  | date |
| cilium_tetragon.log.process_kprobe.process.pod.pod_labels.app.kubernetes.io/name |  | keyword |
| cilium_tetragon.log.process_kprobe.process.pod.pod_labels.class |  | keyword |
| cilium_tetragon.log.process_kprobe.process.pod.pod_labels.org |  | keyword |
| cilium_tetragon.log.process_kprobe.process.pod.workload |  | keyword |
| cilium_tetragon.log.process_kprobe.process.refcnt |  | long |
| cilium_tetragon.log.process_kprobe.return.int_arg |  | long |
| cilium_tetragon.log.process_kprobe.return_action |  | keyword |
| cilium_tetragon.log.time |  | keyword |
| cloud.image.id | Image ID for the cloud instance. | keyword |
| container.labels | Image labels. | object |
| data_stream.dataset | Data stream dataset name. | constant_keyword |
| data_stream.namespace | Data stream namespace. | constant_keyword |
| data_stream.type | Data stream type. | constant_keyword |
| event.dataset | Event dataset | constant_keyword |
| event.module | Event module | constant_keyword |
| host.containerized | If the host is a container. | boolean |
| host.os.build | OS build information. | keyword |
| host.os.codename | OS codename, if any. | keyword |
| input.type | Type of Filebeat input. | keyword |
| log.file.device_id | ID of the device containing the filesystem where the file resides. | keyword |
| log.file.fingerprint | The sha256 fingerprint identity of the file when fingerprinting is enabled. | keyword |
| log.file.idxhi | The high-order part of a unique identifier that is associated with a file. (Windows-only) | keyword |
| log.file.idxlo | The low-order part of a unique identifier that is associated with a file. (Windows-only) | keyword |
| log.file.inode | Inode number of the log file. | keyword |
| log.file.vol | The serial number of the volume that contains a file. (Windows-only) | keyword |
| log.flags | Flags for the log file. | keyword |
| log.offset | Offset of the entry in the log file. | long |

