ARG SERVICE_VERSION=${SERVICE_VERSION:-3.2.0}
FROM docker.io/bitnami/spark:${SERVICE_VERSION}

USER root
RUN \
  apt-get update && apt-get install -y \
  wget

ENV JOLOKIA_VERSION=1.6.0
RUN mkdir /usr/share/java && \
    wget "http://search.maven.org/remotecontent?filepath=org/jolokia/jolokia-jvm/${JOLOKIA_VERSION}/jolokia-jvm-${JOLOKIA_VERSION}-agent.jar" -O "/usr/share/java/jolokia-agent.jar" && \
    echo 'export SPARK_MASTER_OPTS="$SPARK_MASTER_OPTS -javaagent:/usr/share/java/jolokia-agent.jar=config=/spark/conf/jolokia-master.properties"' >> "/opt/bitnami/spark/conf/spark-env.sh"

RUN echo '*.sink.jmx.class=org.apache.spark.metrics.sink.JmxSink' >> "/opt/bitnami/spark/conf/metrics.properties" && \
    echo '*.source.jvm.class=org.apache.spark.metrics.source.JvmSource' >> "/opt/bitnami/spark/conf/metrics.properties"
HEALTHCHECK --interval=1s --retries=90 CMD curl -f http://localhost:7777/jolokia/version
