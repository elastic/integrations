---
processors:
  - set:
      field: event.kind
      value: event
  - grok:
      field: message
      if: ctx?.cisco_ise?.log?.segment?.number == 0
      patterns: 
        - "^%{TIMESTAMP_ISO8601:_tmp.timestamp} %{ISO8601_TIMEZONE:event.timezone} %{DATA:event.sequence:long} %{DATA:cisco_ise.log.message.code} %{DATA:log.syslog.severity.name} %{DATA:cisco_ise.log.message.description}, %{GREEDYDATA:cisco_ise.log.log_details},"  
  - grok:
      field: message
      if: ctx?.cisco_ise?.log?.segment?.number > 0
      patterns: 
        - "^%{GREEDYDATA:cisco_ise.log.log_details},"
  - grok:
      field: cisco_ise.log.log_details
      if: ctx?.cisco_ise?.log?.message?.code == "60067"
      ignore_failure: true
      patterns: 
        - "ConfigVersionId=%{DATA:cisco_ise.log.log_details_object.ConfigVersionId}, OperationMessageText={%{DATA:cisco_ise.log.log_details_object.OperationMessageText}}"
  - grok:
      field: cisco_ise.log.log_details
      if: '["61025", "61026"].contains(ctx?.cisco_ise?.log?.message?.code)'
      patterns: 
        - "ConfigVersionId=%{DATA:cisco_ise.log.log_details_object.ConfigVersionId}, AdminInterface=%{DATA:cisco_ise.log.log_details_object.AdminInterface}, AdminIPAddress=%{DATA:cisco_ise.log.log_details_object.AdminIPAddress}, , OperationMessageText=%{DATA:cisco_ise.log.log_details_object.OperationMessageText}, AcsInstance=%{GREEDYDATA:cisco_ise.log.log_details_object.AcsInstance}"
      on_failure:
        - kv:
            field: cisco_ise.log.log_details
            target_field: cisco_ise.log.log_details_object
            field_split: ', '
            value_split: =
  - grok:
      field: cisco_ise.log.log_details
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
      ignore_failure: true
      patterns: 
        - "ConfigVersionId=%{DATA:cisco_ise.log.log_details_object.ConfigVersionId}, FailureFlag=%{DATA:cisco_ise.log.log_details_object.FailureFlag}, RequestResponseType=%{DATA:cisco_ise.log.log_details_object.RequestResponseType}, AdminInterface=%{DATA:cisco_ise.log.log_details_object.AdminInterface}, AdminIPAddress=%{DATA:cisco_ise.log.log_details_object.AdminIPAddress}, AdminName=%{DATA:cisco_ise.log.log_details_object.AdminName}, %{GREEDYDATA:cisco_ise.log.log_details_object.log_detail}"
  - grok:
      field: cisco_ise.log.log_details_object.log_detail
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
      ignore_failure: true
      patterns: 
        - "ConfigChangeData=%{DATA:cisco_ise.log.log_details_object.ConfigChangeData}, ObjectType=%{DATA:cisco_ise.log.log_details_object.ObjectType}, ObjectName=%{DATA:cisco_ise.log.log_details_object.ObjectName}, Component=%{DATA:cisco_ise.log.log_details_object.Component}, ObjectInternalID=%{GREEDYDATA:cisco_ise.log.log_details_object.ObjectInternalID}"
        - "ConfigChangeData=%{DATA:cisco_ise.log.log_details_object.ConfigChangeData}, ObjectType=%{DATA:cisco_ise.log.log_details_object.ObjectType}, ObjectName=%{DATA:cisco_ise.log.log_details_object.ObjectName}, OperationMessageText=%{GREEDYDATA:cisco_ise.log.log_details_object.OperationMessageText}"
        - "ObjectType=%{DATA:cisco_ise.log.log_details_object.ObjectType}, ObjectName=%{DATA:cisco_ise.log.log_details_object.ObjectName}, Component=%{DATA:cisco_ise.log.log_details_object.Component}, ObjectInternalID=%{GREEDYDATA:cisco_ise.log.log_details_object.ObjectInternalID}"
        - "ConfigChangeData=%{DATA:cisco_ise.log.log_details_object.ConfigChangeData}, ObjectType=%{DATA:cisco_ise.log.log_details_object.ObjectType}, ObjectName=%{GREEDYDATA:cisco_ise.log.log_details_object.ObjectName}"
  - remove:
      field: cisco_ise.log.log_details_object.log_detail
      ignore_missing: true
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
  - grok:
      field: cisco_ise.log.log_details_object.ConfigChangeData
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
      ignore_failure: true
      patterns: 
        - "^%{DATA:_tmp.temp}, Log Severity Level = %{DATA:cisco_ise.log.log_details_object.LogSeverityLevel}\\\\,Local Logging = %{DATA:cisco_ise.log.log_details_object.LocalLogging}\\\\,Assigned Targets = {%{DATA:cisco_ise.log.log_details_object.AssignedTargets}}"
  - grok:
      field: cisco_ise.log.log_details
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
      ignore_failure: true
      patterns: 
        - "ConfigVersionId=%{DATA:cisco_ise.log.log_details_object.ConfigVersionId}, AdminInterface=%{DATA:cisco_ise.log.log_details_object.AdminInterface}, AdminIPAddress=%{DATA:cisco_ise.log.log_details_object.AdminIPAddress}, %{GREEDYDATA:cisco_ise.log.log_details_object.log_detail}"
  - grok:
      field: cisco_ise.log.log_details_object.log_detail
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
      ignore_failure: true
      patterns: 
        - "AdminSession=%{DATA:cisco_ise.log.log_details_object.AdminSession}, AdminName=%{DATA:cisco_ise.log.log_details_object.AdminName}, ConfigChangeData=%{GREEDYDATA:cisco_ise.log.log_details_object.ConfigChangeData}"
        - "AdminName=%{DATA:cisco_ise.log.log_details_object.AdminName}, ConfigChangeData=%{GREEDYDATA:cisco_ise.log.log_details_object.ConfigChangeData}"
        - "AdminName=%{DATA:cisco_ise.log.log_details_object.AdminName}, %{GREEDYDATA:cisco_ise.log.log_details_object.log_description}"
      on_failure:
        - kv:
            field: cisco_ise.log.log_details
            field_split: ', '
            value_split: =
  - remove:
      field: cisco_ise.log.log_details_object.log_detail
      ignore_missing: true
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
  - kv:
      field: cisco_ise.log.log_details_object.log_description
      target_field: cisco_ise.log.log_details_object
      field_split: ', '
      trim_key: " "
      value_split: =
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - remove:
      field: cisco_ise.log.log_details_object.log_description
      ignore_missing: true
  - grok:
      field: cisco_ise.log.log_details_object.ConfigChangeData
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
      ignore_failure: true
      patterns: 
        - "^%{DATA:_tmp.temp}, %{GREEDYDATA:_tmp.ConfigChangeData}"
  - kv:
      field: _tmp.ConfigChangeData
      target_field: cisco_ise.log.log_details_object
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
      field_split: ', '
      value_split: =
      trim_key: " "
      ignore_failure: true
  - kv: 
      if: '!["60067", "61025", "61026", "52001", "52002"].contains(ctx.cisco_ise.log.message.code)'
      field: cisco_ise.log.log_details
      target_field: cisco_ise.log.log_details_object
      field_split: ', '
      value_split: =
      trim_key: " "
      ignore_failure: true
  - kv: 
      if: ctx?.cisco_ise?.log?.message?.code == "60067"
      field: cisco_ise.log.log_details_object.OperationMessageText
      target_field: cisco_ise.log.log_details_object
      field_split: ', '
      value_split: =
      trim_key: " "
      ignore_failure: true
  - split: 
      field: cisco_ise.log.log_details_object.AssignedTargets
      target_field: cisco_ise.log.assigned_targets
      separator: ','
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
      ignore_failure: true
  - remove:
      field: cisco_ise.log.log_details_object.AssignedTargets
      ignore_missing: true
  - date:
      field: _tmp.timestamp
      target_field: '@timestamp'
      formats: 
        - yyyy-MM-dd HH:mm:ss.SSS
        - yyyy-MM-dd HH:mm:ss.SSSSSS
      timezone: '{{{event.timezone}}}'
      ignore_failure: true
  - script:
      lang: painless
      if: ctx?.cisco_ise?.log?.message?.code != null
      source: |
        def eventCategory = new ArrayList();
        def eventType = new ArrayList();
        def categoryReferenceTable = [
          ["messageCodeArray": ["51001","51002","51020","51021","52000","52001","52002","60077","60078","60461","61077","60077","58005","60094","60093","60134","60188","60116","60080","60115","60081"], "name": "iam"],
          ["messageCodeArray": ["51001","51002","51020","51021","60077","60078","61077", "60077","60188","60116","60080","60115","60081"], "name": "authentication"],
          ["messageCodeArray": ["61025","61026","60134"], "name": "network"],
          ["messageCodeArray": ["60067","60070","60456","58005"], "name": "process"],
          ["messageCodeArray": ["52000","52001","52002"], "name": "configuration"]
        ];
        def typeReferenceTable = [
          ["messageCodeArray": ["51001","51002","51020","51021"], "name": "admin"],
          ["messageCodeArray": ["52001"], "name": "change"],
          ["messageCodeArray": ["61025", "61026"], "name": "connection"],
          ["messageCodeArray": ["52000"], "name": "creation"],
          ["messageCodeArray": ["52002"], "name": "deletion"],
          ["messageCodeArray": ["61026"], "name": "end"],
          ["messageCodeArray": ["60116","60080","60115","60081"], "name": "user"],
          ["messageCodeArray": ["51001","51002","51020","51021","52000","52001","52002","60067","60070","60077","60078","60456","60461","61025","61026","61077","60077","58005","60094","60093","60134","60188","60116","60080","60115","60081"], "name": "info"],
          ["messageCodeArray": ["60067","60456","61025"], "name": "start"]
        ];

        for (entry in categoryReferenceTable) {
          if (entry.messageCodeArray.contains(ctx.cisco_ise.log.message.code)) {
            eventCategory.add(entry.name);
          }
        }
        for (entry in typeReferenceTable) {
          if (entry.messageCodeArray.contains(ctx.cisco_ise.log.message.code)) {
            eventType.add(entry.name);
          }
        }

        ctx.event.action = ctx?.cisco_ise?.log?.message?.description?.splitOnToken(":")[0]?.toLowerCase();
        ctx.event.category = eventCategory;
        ctx.event.type = eventType;
      ignore_failure: true
  - rename:
      field: cisco_ise.log.log_details_object.AcsInstance
      target_field: cisco_ise.log.acs.instance
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.AdminInterface
      target_field: cisco_ise.log.admin.interface
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.AdminIPAddress
      target_field: client.ip
      ignore_failure: true
      ignore_missing: true
  - append:
      field: related.ip
      value: '{{{client.ip}}}'
      if: ctx?.client?.ip != null
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: cisco_ise.log.log_details_object.AdminName
      target_field: client.user.name
      ignore_failure: true
      ignore_missing: true
  - append:
      field: related.user
      value: '{{{client.user.name}}}'
      if: ctx?.client?.user?.name != null
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: cisco_ise.log.log_details_object.AdminSession
      target_field: cisco_ise.log.admin.session
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.AuthenticationIdentityStore
      target_field: cisco_ise.log.authentication.identity_store
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.ConfigChangeData
      target_field: cisco_ise.log.config_change.data
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.Component
      target_field: cisco_ise.log.component
      ignore_failure: true
      ignore_missing: true
  - convert:
      field: cisco_ise.log.log_details_object.DestinationPort
      target_field: destination.port
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: "{{ _ingest.on_failure_message }}"
  - remove:
      field: cisco_ise.log.log_details_object.DestinationPort
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.FailureReason
      target_field: cisco_ise.log.failure.reason
      ignore_failure: true
      ignore_missing: true
  - convert:
      field: cisco_ise.log.log_details_object.FailureFlag
      target_field: cisco_ise.log.failure.flag
      type: boolean
      ignore_missing: true
      ignore_failure: true
      on_failure:
        - append:
            field: error.message
            value: "{{ _ingest.on_failure_message }}"
  - remove:
      field: cisco_ise.log.log_details_object.FailureFlag
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.LocalLogging
      target_field: cisco_ise.log.local_logging
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.LogSeverityLevel
      target_field: log.syslog.severity.name
      if: ctx?.log?.syslog?.severity?.name == null
      ignore_failure: true
      ignore_missing: true
  - remove:
      field: cisco_ise.log.log_details_object.LogSeverityLevel
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.LogErrorMessage
      target_field: cisco_ise.log.log_error.message
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.LoggerName
      target_field: log.logger
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.MessageCode
      target_field: cisco_ise.log.message.code
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.FeedServiceFeed
      target_field: cisco_ise.log.feed_service.feed.name
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.FeedServiceFeedVersion
      target_field: cisco_ise.log.feed_service.feed.version
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.FeedServiceHost
      target_field: cisco_ise.log.feed_service.host
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.FeedServicePort
      target_field: cisco_ise.log.feed_service.port
      ignore_failure: true
      ignore_missing: true
  - date:
      field: cisco_ise.log.log_details_object.FeedServiceQueryToTime
      target_field: cisco_ise.log.feed_service.query.to_time
      formats: 
        - ISO8601
      if: ctx?.cisco_ise?.log?.log_details_object?.FeedServiceQueryToTime != null && ctx?.cisco_ise?.log?.log_details_object?.FeedServiceQueryToTime != ""
      on_failure:
        - append:
            field: error.message
            value: "{{ _ingest.on_failure_message }}"
  - remove:
      field: cisco_ise.log.log_details_object.FeedServiceQueryToTime
      ignore_missing: true
  - date:
      field: cisco_ise.log.log_details_object.FeedServiceQueryFromTime
      target_field: cisco_ise.log.feed_service.query.from_time
      formats: 
        - ISO8601
      if: ctx?.cisco_ise?.log?.log_details_object?.FeedServiceQueryFromTime != null && ctx?.cisco_ise?.log?.log_details_object?.FeedServiceQueryFromTime != ""
      on_failure:
        - append:
            field: error.message
            value: "{{ _ingest.on_failure_message }}"
  - remove:
      field: cisco_ise.log.log_details_object.FeedServiceQueryFromTime
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.IdentityGroup
      target_field: cisco_ise.log.identity.group
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.IpAddress
      target_field: host.ip
      ignore_failure: true
      ignore_missing: true
  - append:
      field: related.ip
      value: '{{{host.ip}}}'
      if: ctx?.host?.ip != null
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: cisco_ise.log.log_details_object.ObjectName
      target_field: cisco_ise.log.object.name
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.ObjectInternalID
      target_field: cisco_ise.log.object.internal.id
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.ObjectType
      target_field: cisco_ise.log.object.type
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.OperationMessageText
      target_field: cisco_ise.log.operation_message.text
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.PortalName
      target_field: cisco_ise.log.portal.name
      ignore_failure: true
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.PsnHostName
      target_field: cisco_ise.log.psn.hostname
      ignore_failure: true
      ignore_missing: true
  - append:
      field: related.hosts
      value: '{{{cisco_ise.log.psn.hostname}}}'
      if: ctx?.cisco_ise?.log?.psn?.hostname != null && ctx?.cisco_ise?.log?.psn?.hostname != ''
      allow_duplicates: false
      ignore_failure: true
  - rename:
      field: cisco_ise.log.log_details_object.RequestResponseType
      target_field: cisco_ise.log.request_response.type
      ignore_failure: true
      ignore_missing: true
  - convert:
      field: cisco_ise.log.log_details_object.ResponseTime
      target_field: cisco_ise.log.response.time
      type: long
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: "{{ _ingest.on_failure_message }}"
  - remove:
      field: cisco_ise.log.log_details_object.ResponseTime
      ignore_missing: true
  - rename:
      field: cisco_ise.log.log_details_object.UserName
      target_field: user.name
      ignore_failure: true
      ignore_missing: true
  - append:
      field: related.user
      value: '{{{user.name}}}'
      if: ctx?.user?.name != null
      allow_duplicates: false
      ignore_failure: true
