---
description: Pipeline for processing envoyproxy metrics
processors:
  - set:
      field: ecs.version
      value: "8.11.0"
  - rename:
      field: statsd
      target_field: envoyproxy
      ignore_missing: true
  - script:
      lang: painless
      description: This script processor iterates over the whole document to remove few fields.
      source: |
        for (entry in ctx.envoyproxy.entrySet()) {
            def k = entry.getKey();
            def v = entry.getValue();

            if (!(v instanceof String)) {
                v.keySet().stream().filter(s -> s.startsWith('1m_rate') || s.startsWith('5m_rate') ||s.startsWith('15m_rate') ||
                s.startsWith('p99_9') || s.startsWith('p75') || s.startsWith('p99') || s.startsWith('p95'))
                .collect(Collectors.toList()).forEach(m -> v.remove(m))
            }
        }
  - dot_expander:
      field: "*"
      path: labels
  - rename:
      field: labels.envoy.cluster_name
      target_field: envoyproxy.cluster_name
      ignore_missing: true
  - rename:
      field: labels.envoy.listener_address
      target_field: envoyproxy.listener_address
      ignore_missing: true
  - rename:
      field: labels.envoy.http_conn_manager_prefix
      target_field: envoyproxy.http_conn_manager_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.http_user_agent
      target_field: envoyproxy.http_user_agent
      ignore_missing: true
  - rename:
      field: labels.envoy.ssl_cipher
      target_field: envoyproxy.ssl_cipher
      ignore_missing: true
  - rename:
      field: labels.envoy.ssl_curve
      target_field: envoyproxy.ssl_curve
      ignore_missing: true
  - rename:
      field: labels.envoy.ssl_sigalg
      target_field: envoyproxy.ssl_sigalg
      ignore_missing: true
  - rename:
      field: labels.envoy.ssl_version
      target_field: envoyproxy.ssl_version
      ignore_missing: true
  - rename:
      field: labels.envoy.cipher_suite
      target_field: envoyproxy.cipher_suite
      ignore_missing: true
  - rename:
      field: labels.envoy.clientssl_prefix
      target_field: envoyproxy.clientssl_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.mongo_prefix
      target_field: envoyproxy.mongo_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.mongo_cmd
      target_field: envoyproxy.mongo_cmd
      ignore_missing: true
  - rename:
      field: labels.envoy.mongo_collection
      target_field: envoyproxy.mongo_collection
      ignore_missing: true
  - rename:
      field: labels.envoy.mongo_callsite
      target_field: envoyproxy.mongo_callsite
      ignore_missing: true
  - rename:
      field: labels.envoy.ratelimit_prefix
      target_field: envoyproxy.ratelimit_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.local_http_ratelimit_prefix
      target_field: envoyproxy.local_http_ratelimit_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.local_network_ratelimit_prefix
      target_field: envoyproxy.local_network_ratelimit_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.local_listener_ratelimit_prefix
      target_field: envoyproxy.local_listener_ratelimit_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.dns_filter_prefix
      target_field: envoyproxy.dns_filter_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.connection_limit_prefix
      target_field: envoyproxy.connection_limit_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.rbac_prefix
      target_field: envoyproxy.rbac_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.rbac_http_prefix
      target_field: envoyproxy.rbac_http_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.rbac_policy_name
      target_field: envoyproxy.rbac_policy_name
      ignore_missing: true
  - rename:
      field: labels.envoy.tcp_prefix
      target_field: envoyproxy.tcp_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.udp_prefix
      target_field: envoyproxy.udp_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.fault_downstream_cluster
      target_field: envoyproxy.fault_downstream_cluster
      ignore_missing: true
  - rename:
      field: labels.envoy.dynamo_operation
      target_field: envoyproxy.dynamo_operation
      ignore_missing: true
  - rename:
      field: labels.envoy.dynamo_table
      target_field: envoyproxy.dynamo_table
      ignore_missing: true
  - rename:
      field: labels.envoy.dynamo_partition_id
      target_field: envoyproxy.dynamo_partition_id
      ignore_missing: true
  - rename:
      field: labels.envoy.grpc_bridge_service
      target_field: envoyproxy.grpc_bridge_service
      ignore_missing: true
  - rename:
      field: labels.envoy.grpc_bridge_method
      target_field: envoyproxy.grpc_bridge_method
      ignore_missing: true
  - rename:
      field: labels.envoy.virtual_host
      target_field: envoyproxy.virtual_host
      ignore_missing: true
  - rename:
      field: labels.envoy.virtual_cluster
      target_field: envoyproxy.virtual_cluster
      ignore_missing: true
  - rename:
      field: labels.envoy.response_code
      target_field: envoyproxy.response_code
      ignore_missing: true
  - rename:
      field: labels.envoy.response_code_class
      target_field: envoyproxy.response_code_class
      ignore_missing: true
  - rename:
      field: labels.envoy.rds_route_config
      target_field: envoyproxy.rds_route_config
      ignore_missing: true
  - rename:
      field: labels.envoy.scoped_rds_config
      target_field: envoyproxy.scoped_rds_config
      ignore_missing: true
  - rename:
      field: labels.envoy.route
      target_field: envoyproxy.route
      ignore_missing: true
  - rename:
      field: labels.envoy.ext_authz_prefix
      target_field: envoyproxy.ext_authz_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.worker_id
      target_field: envoyproxy.worker_id
      ignore_missing: true
  - rename:
      field: labels.envoy.thrift_prefix
      target_field: envoyproxy.thrift_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.redis_prefix
      target_field: envoyproxy.redis_prefix
      ignore_missing: true
  - rename:
      field: labels.envoy.proxy_protocol_version
      target_field: envoyproxy.proxy_protocol_version
      ignore_missing: true
  - rename:
      field: labels.envoy.proxy_protocol_prefix
      target_field: envoyproxy.proxy_protocol_prefix
      ignore_missing: true
  - remove:
      field: metricset.name
      ignore_missing: true
  - script:
      tag: script_to_drop_null_values
      lang: painless
      description: Drops null/empty values recursively.
      source: |-
        boolean drop(Object o) {
          if (o == null || o == '') {
            return true;
          } else if (o instanceof Map) {
            ((Map) o).values().removeIf(v -> drop(v));
            return (((Map) o).size() == 0);
          } else if (o instanceof List) {
            ((List) o).removeIf(v -> drop(v));
            return (((List) o).length == 0);
          }
          return false;
        }
        drop(ctx);
on_failure:
  - set:
      field: error.message
      value: '{{ _ingest.on_failure_message }}'
