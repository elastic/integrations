# Service Info

The WatchGuard Firebox integration allows for the seamless ingestion and analysis of log data generated by WatchGuard Firebox appliances running Fireware OS. This integration is essential for security administrators to monitor network traffic, detect potential security threats, and maintain compliance through centralized logging. By leveraging the Elastic Agent, users can collect syslog messages over UDP, providing real-time visibility into the security posture of their network environment.

## Common use cases

- **Network Traffic Monitoring:** Analyze flow logs to identify high-bandwidth users, unusual traffic patterns, and connection trends across trusted, optional, and external interfaces.
- **Security Incident Detection:** Monitor blocked connection attempts, intrusion prevention system (IPS) alerts, and malware detection events to identify and mitigate cyber threats.
- **Compliance and Auditing:** Maintain long-term records of administrative logins, configuration changes, and system events to meet regulatory requirements and internal audit standards.
- **Operational Troubleshooting:** Use detailed system logs to diagnose connectivity issues, VPN tunnel failures, and hardware performance bottlenecks within the Firebox environment.

## Data types collected

This integration collects the following data streams from WatchGuard Firebox appliances:

- **WatchGuard Firebox logs (`watchguard_firebox.log`):** This stream collects logs using syslog over UDP (default port `9528`). It captures a wide range of Fireware OS log messages, including:
    - **Firewall Traffic Logs:** Detailed information about permitted and denied connections, including source/destination IP addresses, ports, and protocols.
    - **Security Service Events:** Logs from security modules such as Gateway AntiVirus, Intrusion Prevention Service (IPS), WebBlocker, and Application Control.
    - **Authentication Logs:** Records of user login attempts to the firewall UI, VPN connections, and proxy authentication events.
    - **System Event Logs:** Internal Firebox messages regarding hardware status, service restarts, configuration updates, and High Availability (HA) failovers.

## Compatibility

- **Vendor Version:** This integration is tested and verified against **WatchGuard Fireware OS v12.10.3**. It is generally compatible with **Fireware v12.x** versions that support standard syslog output.

## Scaling and Performance

To ensure optimal performance in high-volume environments, consider the following:
- **Transport/Collection Considerations:** This integration utilizes UDP for log transport. While UDP offers higher throughput and lower overhead compared to TCP, it is a connectionless protocol that does not guarantee delivery. In environments where log loss is unacceptable, ensure the network path between the Firebox and the Elastic Agent is stable and high-speed.
- **Data Volume Management:** WatchGuard Fireboxes can generate significant log volumes, particularly in high-traffic environments with "Log this action" enabled on many policies. Users should consider filtering logs at the source by selecting only necessary log categories (e.g., Alarms and Events) or disabling logging for high-volume, low-risk internal traffic policies to reduce the load on the Elastic Agent.
- **Elastic Agent Scaling:** For high-throughput environments (multi-gigabit firewalls), deploy multiple Elastic Agents behind a network load balancer to distribute the incoming UDP syslog traffic evenly. Ensure the host running the Elastic Agent has sufficient CPU and memory resources to handle the parsing overhead associated with the incoming log stream.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** You must have administrative credentials for the Fireware Web UI or Policy Manager.
- **Network Connectivity:** The Firebox must be able to reach the Elastic Agent host over the network. Ensure that any intermediate firewalls allow traffic on the configured UDP port (Elastic Agent default is `9528`, Firebox default is `514`).
- **Standard Logging Enabled:** The Firebox must have logging enabled on individual firewall policies (the **Send a log message** checkbox must be selected in the policy's Logging settings). For details, refer to [Set Logging and Notification Preferences](https://www.watchguard.com/help/docs/help-center/en-US/Content/en-US/Fireware/logging/set_logging_notif_pref_pm_c.html) in the WatchGuard documentation.
- **Static IP/DNS:** It is recommended that the Elastic Agent host has a static IP address to prevent configuration breakage if the IP changes.

## Elastic prerequisites

- **Elastic Agent:** Must be installed on a host and managed through Fleet.
- **Kibana Version:** Requires version **8.13.0** or higher.
- **Agent Enrollment:** The Elastic Agent must be successfully enrolled in a Fleet policy.
- **Port Availability:** The UDP port specified in the integration (default `9528`) must be open on the host's firewall to allow incoming traffic from the Firebox.

## Vendor set up steps

### For Configuration using Fireware Web UI:
1. Log in to the **Fireware Web UI** using your administrative credentials.
2. From the left navigation menu, navigate to **System > Logging**.
3. Select the **Syslog Server** tab.
4. Select the check box for **Send log messages to these syslog servers**.
5. Click **Add** to define a new destination.
6. In the **IP Address** field, enter the IP address of the host where your Elastic Agent is running.
7. In the **Port** field, enter the port number configured in your Elastic integration (Elastic Agent default is `9528`, Firebox default is `514`).
8. For **Log Format**, ensure you select **Syslog**.
9. (Optional) Provide a **Description** such as `Elastic Agent Syslog`.
10. To ensure complete data, select the check boxes for **The time stamp** and **The serial number of the device**.
11. Under **Syslog Settings**, confirm the facility codes for different log types (Alarm, Traffic, Event, etc.). It is recommended to keep the defaults (Local0 - Local4).
12. Click **OK**, and then click **Save** on the Logging page to apply the changes to the Firebox.

### For Configuration using Policy Manager:
1. Open the **WatchGuard Policy Manager** and connect to your Firebox.
2. Navigate to **Setup > Logging**.
3. Select the **Send log messages to these syslog servers** check box.
4. Click **Add**.
5. In the configuration dialog, enter the **IP Address** of the Elastic Agent host.
6. Enter the **Port** number (Elastic Agent default is `9528`, Firebox default is `514`).
7. Select **Syslog** as the **Log Format**.
8. Enable the check boxes for **The time stamp** and **The serial number of the device** to include these in the payload.
9. Verify that the **Syslog Settings** for facilities are correctly assigned (typically Local0 through Local4).
10. Click **OK** to close the Syslog dialog, and click **OK** again to close the Logging Setup window.
11. Save the configuration to your device by selecting **File > Save > To Firebox**.

### Vendor Set up Resources

- [Configure Syslog Server Settings - WatchGuard Help](https://www.watchguard.com/help/docs/help-center/en-US/Content/en-US/Fireware/logging/send_logs_to_syslog_c.html) - Official guide on configuring Fireware to send logs to external syslog servers.

## Kibana set up steps

1. In Kibana, navigate to **Management > Integrations**.
2. Search for and select **WatchGuard Firebox**.
3. Click **Add WatchGuard Firebox**.
4. Configure the integration with the following settings for the **Collect WatchGuard Firebox logs using UDP input** section:
    * **Listen Address** (`listen_address`): The bind address to listen for UDP connections. Set to `0.0.0.0` to bind to all available interfaces. Default: `localhost`.
    * **Listen Port** (`listen_port`): The UDP port number to listen on. Default: `9528`.
    * **Timezone Offset** (`tz_offset`): Use this to adjust the timezone offset when importing logs from a host in a different timezone (e.g., `Europe/Amsterdam` or `-05:00`). Default: `UTC`.
    * **Preserve original event** (`preserve_original_event`): If checked, a raw copy of the original event is added to the field `event.original`. Default: `False`.
    * **Custom UDP Options** (`udp_options`): Specify custom configuration options such as `max_message_size` or `timeout`. Default: `#max_message_size: 50KiB\n#timeout: 300s`.
    * **Tags** (`tags`): Custom tags to append to the logs (e.g., `forwarded`, `watchguard_firebox-log`).
    * **Preserve duplicate custom fields** (`preserve_duplicate_custom_fields`): If enabled, preserves WatchGuard fields that were also copied to ECS fields. Default: `False`.
    * **Processors** (`processors`): Add custom processors to reduce fields or enhance metadata before parsing.
5. Choose the **Agent Policy** where you want to add the integration.
6. Click **Save and continue**.

# Validation Steps

After configuration is complete, verify that data is flowing correctly.

### 1. Trigger Data Flow on WatchGuard Firebox:
- **Authentication event:** Log out of the Fireware Web UI and log back in to generate an authentication event log.
- **Configuration change:** Modify a description field in a firewall policy and save the change to the device to generate a configuration event.
- **Traffic event:** From a network client behind the Firebox, browse several external websites to trigger traffic logs (ensure "Log this action" is enabled on the policy).
- **Diagnostic event:** Use the **Diagnostic Task** tool in the Web UI to run a `ping` to an external host (e.g., `8.8.8.8`).

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the KQL filter: `data_stream.dataset : "watchguard_firebox.log"`
4. Verify logs appear. Expand a log entry and confirm these fields:
   - `event.dataset` (should be `watchguard_firebox.log`)
   - `source.ip` or `destination.ip`
   - `event.action` or `event.outcome`
   - `message` (the raw log payload)
5. Navigate to **Analytics > Dashboards** and search for "WatchGuard Firebox".

# Troubleshooting

## Common Configuration Issues

- **UDP Port Mismatch**: If logs are not appearing, ensure the **Listen Port** in the Kibana integration policy (default `9528`) exactly matches the port configured in the **Syslog Server** settings on the Firebox.
- **Binding to Localhost**: If the Elastic Agent is set to listen on `localhost` or `127.0.0.1`, it will reject packets from the Firebox. Ensure **Listen Address** is set to `0.0.0.0` or the specific LAN IP of the Agent host.
- **Firewall Blocking**: Check the local firewall on the Elastic Agent host (e.g., `iptables`, `ufw`, or Windows Firewall) to ensure that incoming UDP traffic on the configured port is allowed.
- **Policy Logging Disabled**: If only system logs appear but no traffic logs, verify that the individual **Firewall Policies** on the Firebox have the **Send a log message** checkbox selected in the policy's Logging settings.

## Ingestion Errors

- **Parsing Failures**: If logs appear in Kibana but contain a `tags: ["_grokparsefailure"]` or similar error, verify that the Firebox is using the standard "Syslog" format and not a legacy or proprietary format.
- **Timezone Mismatch**: If logs appear with the wrong timestamp, adjust the **Timezone Offset** in the Kibana integration settings to match the timezone configured on the Firebox appliance.
- **Field Mapping Issues**: If custom fields are missing, ensure that **Preserve duplicate custom fields** is enabled if you need the non-ECS raw fields for specific reporting requirements.
- **Identify using Error Field**: In Discover, filter for `error.message : *` to find specific parsing or ingestion errors that occurred during processing.

## Vendor Resources

- [Fireware v12.10 Log Catalog](https://www.watchguard.com/help/docs/fireware/12/en-US/log_catalog/12_10_Log-Catalog.pdf) - Comprehensive list of all log messages generated by Fireware OS.
- Refer to the official vendor website for additional resources.

## Documentation sites

- [WatchGuard Fireware v12.10 Log Catalog (PDF)](https://www.watchguard.com/help/docs/fireware/12/en-US/log_catalog/12_10_Log-Catalog.pdf)
- [WatchGuard Syslog Setup Guide](https://www.watchguard.com/help/docs/help-center/en-US/Content/en-US/Fireware/logging/send_logs_to_syslog_c.html)
- [WatchGuard Set Logging and Notification Preferences](https://www.watchguard.com/help/docs/help-center/en-US/Content/en-US/Fireware/logging/set_logging_notif_pref_pm_c.html)
- [Elastic UDP Input Documentation](https://www.elastic.co/docs/reference/beats/filebeat/filebeat-input-udp)
