---
description: Pipeline for processing vulnerability logs.
processors:
  - remove:
      field:
        - organization
        - division
        - team
      ignore_missing: true
      if: ctx.organization instanceof String && ctx.division instanceof String && ctx.team instanceof String
      tag: remove_agentless_tags
      description: >-
        Removes the fields added by Agentless as metadata,
        as they can collide with ECS fields.
  - set:
      field: ecs.version
      tag: set_ecs_version
      value: 8.11.0
  - rename:
      field: message
      tag: rename_message
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - remove:
      field: message
      ignore_missing: true
      if: ctx.event?.original != null
      description: 'The `message` field is no longer required if the document has an `event.original` field.'
  - json:
      field: event.original
      tag: json_message
      target_field: json
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - script:
      description: Drops fields with empty or N/A values recursively
      tag: script_to_drop_invalid_values
      lang: painless
      source: |
        void handleMap(Map map) {
          map.values().removeIf(v -> {
            if (v instanceof Map) {
                handleMap(v);
            } else if (v instanceof List) {
                handleList(v);
            }
            return v == null || v == '' || v == 'N/A' || v == '[N/A]' || (v instanceof Map && v.size() == 0) || (v instanceof List && v.size() == 0)
          });
        }
        void handleList(List list) {
          list.removeIf(v -> {
            if (v instanceof Map) {
                handleMap(v);
            } else if (v instanceof List) {
                handleList(v);
            }
            return v == null || v == '' || v == 'N/A' || v == '[N/A]' || (v instanceof Map && v.size() == 0) || (v instanceof List && v.size() == 0)
          });
        }
        handleMap(ctx);
  - append:
      field: event.category
      tag: append_configuration_into_event_category
      value: vulnerability
  - append:
      field: event.kind
      tag: append_state_to_event_kind
      value: event
  - append:
      field: event.type
      tag: append_info_into_event_type
      value: info
  - set:
      field: observer.vendor
      tag: set_observer_vendor
      value: 'Palo Alto Networks'
  - set:
      field: observer.product
      tag: set_observer_product
      value: 'Prisma Cloud'
  - set:
      field: vulnerability.scanner.vendor
      tag: set_vulnerability_scanner_vendor_to_palo_alto_networks
      value: Palo Alto Networks
  # Remove cloud.* fields populated by beat.
  # These fields correspond to Prisma Cloud hosts and could be misleading.
  - remove:
      field: cloud
      tag: remove_cloud_fields
      ignore_missing: true
      description: Remove ECS cloud fields that are populated from Elastic Agent metadata.
  - rename:
      field: json.3RD_PARTY_EXPLOIT_SOURCE
      tag: rename_3RD_PARTY_EXPLOIT_SOURCE_to_prisma_cloud_vulnerability_3rd_party_exploit_source
      target_field: prisma_cloud.vulnerability.3rd_party_exploit_source
      ignore_missing: true
  - rename:
      field: json.ASSET_ID
      tag: rename_ASSET_ID_to_prisma_cloud_vulnerability_asset_id
      target_field: prisma_cloud.vulnerability.asset_id
      ignore_missing: true
  - set:
      field: resource.id
      tag: set_resource_id_from_prisma_cloud_vulnerability_asset_id
      copy_from: prisma_cloud.vulnerability.asset_id
      ignore_empty_value: true
  - set:
      field: host.id
      tag: set_host_id_from_prisma_cloud_vulnerability_asset_id
      copy_from: prisma_cloud.vulnerability.asset_id
      ignore_empty_value: true
  - append:
      field: related.hosts
      tag: append_host_id_into_related_hosts
      value: '{{{host.id}}}'
      allow_duplicates: false
      if: ctx.host?.id != null && ctx.host.id != ''
  - rename:
      field: json.ASSET_TYPE
      tag: rename_ASSET_TYPE_to_prisma_cloud_vulnerability_asset_type
      target_field: prisma_cloud.vulnerability.asset_type
      ignore_missing: true
  - rename:
      field: json.AT_RISK
      tag: rename_AT_RISK_to_prisma_cloud_vulnerability_at_risk
      target_field: prisma_cloud.vulnerability.at_risk
      ignore_missing: true
  - rename:
      field: json.ATTACK_COMPLEXITY
      tag: rename_ATTACK_COMPLEXITY_to_prisma_cloud_vulnerability_attack_complexity
      target_field: prisma_cloud.vulnerability.attack_complexity
      ignore_missing: true
  - rename:
      field: json.ATTACK_VECTOR
      tag: rename_ATTACK_VECTOR_to_prisma_cloud_vulnerability_attack_vector
      target_field: prisma_cloud.vulnerability.attack_vector
      ignore_missing: true
  - rename:
      field: json.CISA_KEV
      tag: rename_CISA_KEV_to_prisma_cloud_vulnerability_cisa_kev
      target_field: prisma_cloud.vulnerability.cisa_kev
      ignore_missing: true
  - rename:
      field: json.CLOUD_ACCOUNT_ID
      tag: rename_CLOUD_ACCOUNT_ID_to_prisma_cloud_vulnerability_cloud_account_id
      target_field: prisma_cloud.vulnerability.cloud_account_id
      ignore_missing: true
  - set:
      field: cloud.account.id
      tag: set_cloud_account_id_from_prisma_cloud_vulnerability_cloud_account_id
      copy_from: prisma_cloud.vulnerability.cloud_account_id
      ignore_empty_value: true
  - rename:
      field: json.CVE_ID
      tag: rename_CVE_ID_to_prisma_cloud_vulnerability_cve_id
      target_field: prisma_cloud.vulnerability.cve_id
      ignore_missing: true
  - set:
      field: vulnerability.id
      tag: set_vulnerability_id_from_prisma_cloud_vulnerability_cve_id
      copy_from: prisma_cloud.vulnerability.cve_id
      ignore_empty_value: true
  - set:
      field: event.id
      tag: set_event_id_from_prisma_cloud_vulnerability_asset_id_and_cve_id
      value: "{{{prisma_cloud.vulnerability.asset_id}}}|{{{prisma_cloud.vulnerability.cve_id}}}"
      ignore_empty_value: true
  - set:
      field: vulnerability.enumeration
      value: CVE
      tag: set_vulnerability_enumeration_to_CVE
      if: ctx.prisma_cloud?.vulnerability?.cve_id?.startsWith('CVE') == true
  - rename:
      field: json.CVE_LINK
      tag: rename_CVE_LINK_to_prisma_cloud_vulnerability_cve_link
      target_field: prisma_cloud.vulnerability.cve_link
      ignore_missing: true
  - set:
      field: vulnerability.reference
      tag: set_vulnerability_reference_from_prisma_cloud_vulnerability_cve_link
      copy_from: prisma_cloud.vulnerability.cve_link
      ignore_empty_value: true

  - convert:
      field: json.CVSS_BASE_SCORE
      tag: convert_CVSS_BASE_SCORE_to_prisma_cloud_vulnerability_cvss_base_score
      target_field: prisma_cloud.vulnerability.cvss_base_score
      type: double
      if: ctx.json?.CVSS_BASE_SCORE != null && ctx.json.CVSS_BASE_SCORE != ''
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: vulnerability.score.base
      tag: set_vulnerability_score_base_from_prisma_cloud_vulnerability_cvss_base_score
      copy_from: prisma_cloud.vulnerability.cvss_base_score
      ignore_empty_value: true
  - set:
      field: vulnerability.classification
      tag: set_vulnerability_classification_to_cvss
      value: CVSS
      if: ctx.prisma_cloud?.vulnerability?.cvss_base_score != null
      ignore_empty_value: true
  - date:
      field: json.DISCOVERED_DATE
      tag: date_DISCOVERED_DATE
      target_field: prisma_cloud.vulnerability.discovered_date
      formats:
        - MMM dd yyyy
        - ISO8601
      if: ctx.json?.DISCOVERED_DATE != null && ctx.json.DISCOVERED_DATE != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.DISTRIBUTION
      tag: rename_DISTRIBUTION_to_prisma_cloud_vulnerability_distribution
      target_field: prisma_cloud.vulnerability.distribution
      ignore_missing: true
  - set:
      field: host.os.platform
      tag: set_host_os_platform_from_prisma_cloud_vulnerability_distribution
      copy_from: prisma_cloud.vulnerability.distribution
      ignore_empty_value: true
  - rename:
      field: json.DOS
      tag: rename_DOS_to_prisma_cloud_vulnerability_dos
      target_field: prisma_cloud.vulnerability.dos
      ignore_missing: true
  - convert:
      field: json.EPSS_SCORE
      tag: convert_EPSS_SCORE_to_double
      target_field: prisma_cloud.vulnerability.epss_score
      type: double
      if: ctx.json?.EPSS_SCORE != null && ctx.json.EPSS_SCORE != ''
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.EXPLOITABLE
      tag: rename_EXPLOITABLE_to_prisma_cloud_vulnerability_exploitable
      target_field: prisma_cloud.vulnerability.exploitable
      ignore_missing: true
  - date:
      field: json.FIX_DATE
      tag: date_FIX_DATE
      target_field: prisma_cloud.vulnerability.fix_date
      formats:
        - MMM dd yyyy
        - ISO8601
      if: ctx.json?.FIX_DATE != null && ctx.json.FIX_DATE != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: _temp.fixVersionIsArray
      value: true
      if: ctx.json?.FIX_VERSION != null && ctx.json.FIX_VERSION.startsWith('[') && ctx.json.FIX_VERSION.endsWith(']')
  - gsub:
      field: json.FIX_VERSION
      pattern: '[\[\]]'
      replacement: ''
      target_field: prisma_cloud.vulnerability.fix_version
      if: ctx._temp?.fixVersionIsArray == true
  - split:
      field: prisma_cloud.vulnerability.fix_version
      separator: ',\s*'
      target_field: prisma_cloud.vulnerability.fix_version
      if: ctx._temp?.fixVersionIsArray == true && ctx.prisma_cloud?.vulnerability?.fix_version != null
  - rename:
      field: json.FIX_VERSION
      tag: rename_FIX_VERSION_to_prisma_cloud_vulnerability_fix_version
      target_field: prisma_cloud.vulnerability.fix_version
      if: ctx._temp?.fixVersionIsArray == null
      ignore_missing: true
  - set:
      field: package.fixed_version
      tag: set_package_fixed_version_from_prisma_cloud_vulnerability_fix_version
      copy_from: prisma_cloud.vulnerability.fix_version
      ignore_empty_value: true
  - set:
      field: _temp.installedVersionsIsArray
      value: true
      if: ctx.json?.INSTALLED_VERSIONS != null && ctx.json.INSTALLED_VERSIONS.startsWith('[') && ctx.json.INSTALLED_VERSIONS.endsWith(']')
  - gsub:
      field: json.INSTALLED_VERSIONS
      pattern: '[\[\]]'
      replacement: ''
      target_field: prisma_cloud.vulnerability.installed_versions
      if: ctx._temp?.installedVersionsIsArray == true
  - split:
      field: prisma_cloud.vulnerability.installed_versions
      separator: ',\s*'
      target_field: prisma_cloud.vulnerability.installed_versions
      if: ctx._temp?.installedVersionsIsArray == true && ctx.prisma_cloud?.vulnerability?.installed_versions != null
  - rename:
      field: json.INSTALLED_VERSIONS
      tag: rename_INSTALLED_VERSIONS_to_prisma_cloud_vulnerability_installed_versions
      target_field: prisma_cloud.vulnerability.installed_versions
      if: ctx._temp?.installedVersionsIsArray == null
      ignore_missing: true
  - set:
      field: package.version
      tag: set_package_version_from_prisma_cloud_vulnerability_installed_versions
      copy_from: prisma_cloud.vulnerability.installed_versions
      ignore_empty_value: true
  - rename:
      field: json.INTERNET_EXPOSED
      tag: rename_INTERNET_EXPOSED_to_prisma_cloud_vulnerability_internet_exposed
      target_field: prisma_cloud.vulnerability.internet_exposed
      ignore_missing: true
  - rename:
      field: json.OS_RELEASE
      tag: rename_OS_RELEASE_to_prisma_cloud_vulnerability_os_release
      target_field: prisma_cloud.vulnerability.os_release
      ignore_missing: true
  - convert:
      field: json.PACKAGE_IN_USE
      tag: convert_PACKAGE_IN_USE_to_prisma_cloud_vulnerability_package_in_use
      target_field: prisma_cloud.vulnerability.package_in_use
      type: boolean
      if: ctx.json?.PACKAGE_IN_USE != null && ctx.json.PACKAGE_IN_USE != ''
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.PACKAGE_NAME
      tag: rename_PACKAGE_NAME_to_prisma_cloud_vulnerability_package_name
      target_field: prisma_cloud.vulnerability.package_name
      ignore_missing: true
  - set:
      field: package.name
      tag: set_package_name_from_prisma_cloud_vulnerability_package_name
      copy_from: prisma_cloud.vulnerability.package_name
      ignore_empty_value: true
  - rename:
      field: json.PATCHABLE
      tag: rename_PATCHABLE_to_prisma_cloud_vulnerability_patchable
      target_field: prisma_cloud.vulnerability.patchable
      ignore_missing: true
  - rename:
      field: json.PRIVILEGES_REQUIRED
      tag: rename_PRIVILEGES_REQUIRED_to_prisma_cloud_vulnerability_privileges_required
      target_field: prisma_cloud.vulnerability.privileges_required
      ignore_missing: true
  - date:
      field: json.PUBLISHED_DATE
      tag: date_PUBLISHED_DATE
      target_field: prisma_cloud.vulnerability.published_date
      formats:
        - MMM dd yyyy
        - ISO8601
      if: ctx.json?.PUBLISHED_DATE != null && ctx.json.PUBLISHED_DATE != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: vulnerability.published_date
      tag: set_vulnerability_published_date_from_prisma_cloud_vulnerability_published_date
      copy_from: prisma_cloud.vulnerability.published_date
      ignore_empty_value: true
  - rename:
      field: json.REGISTRY
      tag: rename_REGISTRY_to_prisma_cloud_vulnerability_registry
      target_field: prisma_cloud.vulnerability.registry
      ignore_missing: true
  - rename:
      field: json.SERVICE_PROVIDER
      tag: rename_SERVICE_PROVIDER_to_prisma_cloud_vulnerability_service_provider
      target_field: prisma_cloud.vulnerability.service_provider
      ignore_missing: true
  - set:
      field: cloud.provider
      tag: set_cloud_provider_from_prisma_cloud_vulnerability_service_provider
      copy_from: prisma_cloud.vulnerability.service_provider
      if: ctx.prisma_cloud?.vulnerability?.service_provider != null && ['azure', 'aws', 'amazon', 'gcp', 'google', 'alibaba', 'oracle'].contains(ctx.prisma_cloud.vulnerability.service_provider.toLowerCase())
      ignore_empty_value: true
  - rename:
      field: json.SEVERITY
      tag: rename_SEVERITY_to_prisma_cloud_vulnerability_severity
      target_field: prisma_cloud.vulnerability.severity
      ignore_missing: true
  - script:
      description: Map vulnerability.severity to CVSS standard
      tag: script_to_map_severity_to_CVSS
      lang: painless
      if: ctx.prisma_cloud?.vulnerability?.severity != null
      source: >
        String severity = ctx.prisma_cloud.vulnerability.severity;
        if (severity == 'low') {
          ctx.vulnerability.put('severity', 'Low');
        } else if (severity == 'medium') {
          ctx.vulnerability.put('severity', 'Medium');
        } else if (severity == 'high') {
          ctx.vulnerability.put('severity', 'High');
        } else if (severity == 'critical') {
          ctx.vulnerability.put('severity', 'Critical');
        } else if (severity == '' || severity == 'N/A') {
          ctx.vulnerability.put('severity', 'None');
        }
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.USER_INTERACTION
      tag: rename_USER_INTERACTION_to_prisma_cloud_vulnerability_user_interaction
      target_field: prisma_cloud.vulnerability.user_interaction
      ignore_missing: true
  - set:
      field: vulnerability.title
      tag: set_vulnerability_title_from_package_name_package_version_vulnerability_id
      value: 'Vulnerability found in {{{package.name}}} versions {{{json.INSTALLED_VERSIONS}}} - {{{vulnerability.id}}}'
      if: ctx.package?.name != null && ctx.package?.version != null && ctx.vulnerability?.id != null
  - set:
      field: vulnerability.title
      tag: set_vulnerability_title_from_package_name_package_version
      value: 'Vulnerability found in {{{package.name}}} versions {{{json.INSTALLED_VERSIONS}}}'
      if: ctx.package?.name != null && ctx.package?.version != null && ctx.vulnerability?.title == null
  - set:
      field: vulnerability.title
      tag: set_vulnerability_title_from_vulnerability_id
      value: 'Vulnerability found - {{{vulnerability.id}}}'
      if: ctx.vulnerability?.id != null && ctx.vulnerability?.title == null
  - set:
      field: vulnerability.cve
      tag: set_vulnerability_cve_from_vulnerability_cve_id
      copy_from: vulnerability.id
      ignore_empty_value: true
      if: ctx.vulnerability?.id?.startsWith('CVE') == true
  - remove:
      field:
        - json
        - _temp
      ignore_missing: true
  - remove:
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      ignore_missing: true
      tag: remove_preserve_duplicate_custom_fields
      field:
        - prisma_cloud.vulnerability.asset_id
        - prisma_cloud.vulnerability.cloud_account_id
        - prisma_cloud.vulnerability.cve_id
        - prisma_cloud.vulnerability.cve_link
        - prisma_cloud.vulnerability.cvss_base_score
        - prisma_cloud.vulnerability.distribution
        - prisma_cloud.vulnerability.fix_version
        - prisma_cloud.vulnerability.installed_versions
        - prisma_cloud.vulnerability.package_name
        - prisma_cloud.vulnerability.published_date
        - prisma_cloud.vulnerability.severity
  - script:
      lang: painless
      description: Drops null/empty values recursively.
      source: |-
        boolean drop(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(v -> drop(v));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(v -> drop(v));
            return (((List) object).length == 0);
          }
          return false;
        }
        drop(ctx);
  - set:
      field: event.kind
      value: pipeline_error
      if: ctx.error?.message != null
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
      if: ctx.error?.message != null
on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false