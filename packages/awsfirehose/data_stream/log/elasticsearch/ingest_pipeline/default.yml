---
description: Pipeline for rerouting logs streams from Amazon Kinesis Data Firehose.
processors:
  - set:
      field: ecs.version
      value: 8.0.0
  - set:
      field: cloud.provider
      value: aws
  - reroute:
      dataset: aws.cloudtrail
      namespace: default
#      ignore_failure: true
      if: ctx['aws.cloudwatch.log_stream'].contains('CloudTrail')
  - reroute:
      dataset: aws.route53_public_logs
      namespace: default
#      ignore_failure: true
      if: >-
            def split_log_stream_name=ctx['aws.cloudwatch.log_stream'].splitOnToken('/');
            if (split_log_stream_name.length!=2) {
              return false;
            }
            def hosted_zone_id=split_log_stream_name[0];
            def edge_location_id=split_log_stream_name[1];
            if (ctx.message.contains(hosted_zone_id) && ctx.message.contains(edge_location_id)){
                return true;
            }
            return false;
  - reroute:
      dataset: aws.firewall_logs
      namespace: default
#      ignore_failure: true
      if: ctx.message.contains('firewall_name') && ctx.message.contains('availability_zone') && ctx.message.contains('event_timestamp') && ctx.message.contains('event')
on_failure:
  - set:
      field: error.message
      value: '{{ _ingest.on_failure_message }}'