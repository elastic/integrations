---
description: Pipeline for normalizing Zeek ssl.log
processors:
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - json:
      field: event.original
      target_field: _temp_
  - pipeline:
      if: ctx?._temp_?.result != null
      name: '{{ IngestPipeline "third-party" }}'
  - drop:
      description: Drop if no timestamp (invalid json)
      if: 'ctx?._temp_?.ts == null'
  - rename:
      field: _temp_
      target_field: zeek.ssl
      # Sets event.created from the @timestamp field generated by filebeat before being overwritten further down
  - set:
      field: event.created
      copy_from: "@timestamp"
  - set:
      field: event.kind
      value: event
  - set:
      field: ecs.version
      value: '8.11.0'
  - append:
      field: event.category
      value: network
  - append:
      field: event.type
      value: connection
  - append:
      field: event.type
      value: protocol
  - set:
      field: network.transport
      value: tcp
  - dot_expander:
      path: zeek.ssl
      field: id.orig_p
      ignore_failure: true
  - dot_expander:
      path: zeek.ssl
      field: id.orig_h
      ignore_failure: true
  - dot_expander:
      path: zeek.ssl
      field: id.resp_h
      ignore_failure: true
  - dot_expander:
      path: zeek.ssl
      field: id.resp_p
      ignore_failure: true
  - rename:
      field: zeek.ssl.id.orig_h
      target_field: source.address
      ignore_missing: true
  - rename:
      field: zeek.ssl.id.orig_p
      target_field: source.port
      ignore_missing: true
  - rename:
      field: zeek.ssl.id.resp_h
      target_field: destination.address
      ignore_missing: true
  - rename:
      field: zeek.ssl.id.resp_p
      target_field: destination.port
      ignore_missing: true
  - rename:
      field: zeek.ssl.uid
      target_field: zeek.session_id
      ignore_missing: true
  - set:
      field: event.id
      copy_from: zeek.session_id
      if: ctx.zeek?.session_id != null
  - set:
      field: source.ip
      copy_from: source.address
      if: ctx.source?.address != null
  - set:
      field: client.address
      copy_from: source.address
      if: ctx.source?.address != null
  - set:
      field: destination.ip
      copy_from: destination.address
      if: ctx.destination?.address != null
  - set:
      field: server.address
      copy_from: destination.address
      if: ctx.destination?.address != null
  - rename:
      field: zeek.ssl.server_name
      target_field: zeek.ssl.server.name
      ignore_missing: true
  - rename:
      field: zeek.ssl.cert_chain
      target_field: zeek.ssl.server.cert_chain
      ignore_missing: true
  - rename:
      field: zeek.ssl.cert_chain_fuids
      target_field: zeek.ssl.server.cert_chain_fuids
      ignore_missing: true
  - rename:
      field: zeek.ssl.client_cert_chain
      target_field: zeek.ssl.client.cert_chain
      ignore_missing: true
  - rename:
      field: zeek.ssl.client_cert_chain_fuids
      target_field: zeek.ssl.client.cert_chain_fuids
      ignore_missing: true
  - rename:
      field: zeek.ssl.validation_status
      target_field: zeek.ssl.validation.status
      ignore_missing: true
  - rename:
      field: zeek.ssl.validation_code
      target_field: zeek.ssl.validation.code
      ignore_missing: true
  - date:
      field: zeek.ssl.ts
      formats:
        - UNIX
        - ISO8601
  - remove:
      field: zeek.ssl.ts
  - rename:
      field: zeek.ssl.not_valid_after
      target_field: tls.server.not_after
      ignore_missing: true
  - rename:
      field: zeek.ssl.not_valid_before
      target_field: tls.server.not_before
      ignore_missing: true
  - date:
      if: ctx.tls?.server?.not_before != null
      field: tls.server.not_before
      target_field: tls.server.not_before
      formats:
        - UNIX
        - ISO8601
  - date:
      if: ctx.tls?.server?.not_after != null
      field: tls.server.not_after
      target_field: tls.server.not_after
      formats:
        - UNIX
        - ISO8601
  - geoip:
      field: destination.ip
      target_field: destination.geo
      ignore_missing: true
  - geoip:
      field: source.ip
      target_field: source.geo
      ignore_missing: true
  - geoip:
      database_file: GeoLite2-ASN.mmdb
      field: source.ip
      target_field: source.as
      properties:
        - asn
        - organization_name
      ignore_missing: true
  - geoip:
      database_file: GeoLite2-ASN.mmdb
      field: destination.ip
      target_field: destination.as
      properties:
        - asn
        - organization_name
      ignore_missing: true
  - rename:
      field: source.as.asn
      target_field: source.as.number
      ignore_missing: true
  - rename:
      field: source.as.organization_name
      target_field: source.as.organization.name
      ignore_missing: true
  - rename:
      field: destination.as.asn
      target_field: destination.as.number
      ignore_missing: true
  - rename:
      field: destination.as.organization_name
      target_field: destination.as.organization.name
      ignore_missing: true
  - remove:
      field: zeek.ssl.client.cert_chain_fuids
      if: ctx.zeek.ssl.client?.cert_chain_fuids?.length == 0
      ignore_missing: true
  - gsub:
      field: zeek.ssl.issuer
      pattern: \\,
      replacement: ""
      ignore_missing: true
  - kv:
      field: zeek.ssl.issuer
      field_split: ","
      value_split: "="
      target_field: zeek.ssl.server.issuer
      ignore_missing: true
  - rename:
      field: zeek.ssl.issuer
      target_field: tls.server.issuer
      ignore_missing: true
  - rename:
      field: zeek.ssl.resp_certificate_sha1
      target_field: tls.server.hash.sha1
      ignore_missing: true
  - uppercase:
      field: tls.server.hash.sha1
      ignore_missing: true
  - set:
      field: tls.server.x509.issuer.country
      value: ["{{{zeek.ssl.server.issuer.C}}}"]
      if: ctx.zeek?.ssl?.server?.issuer?.C instanceof String
  - rename:
      field: zeek.ssl.server.issuer.C
      target_field: zeek.ssl.server.issuer.country
      ignore_missing: true
  - set:
      field: tls.server.x509.issuer.common_name
      value: ["{{{zeek.ssl.server.issuer.CN}}}"]
      if: ctx.zeek?.ssl?.server?.issuer?.CN instanceof String
  - rename:
      field: zeek.ssl.server.issuer.CN
      target_field: zeek.ssl.server.issuer.common_name
      ignore_missing: true
  - set:
      field: tls.server.x509.issuer.locality
      value: ["{{{zeek.ssl.server.issuer.L}}}"]
      if: ctx.zeek?.ssl?.server?.issuer?.L instanceof String
  - rename:
      field: zeek.ssl.server.issuer.L
      target_field: zeek.ssl.server.issuer.locality
      ignore_missing: true
  - set:
      field: tls.server.x509.issuer.organization
      value: ["{{{zeek.ssl.server.issuer.O}}}"]
      if: ctx.zeek?.ssl?.server?.issuer?.O instanceof String
  - rename:
      field: zeek.ssl.server.issuer.O
      target_field: zeek.ssl.server.issuer.organization
      ignore_missing: true
  - set:
      field: tls.server.x509.issuer.organizational_unit
      value: ["{{{zeek.ssl.server.issuer.OU}}}"]
      if: ctx.zeek?.ssl?.server?.issuer?.OU instanceof String
  - rename:
      field: zeek.ssl.server.issuer.OU
      target_field: zeek.ssl.server.issuer.organizational_unit
      ignore_missing: true
  - set:
      field: tls.server.x509.issuer.state_or_province
      value: ["{{{zeek.ssl.server.issuer.ST}}}"]
      if: ctx.zeek?.ssl?.server?.issuer?.ST instanceof String
  - rename:
      field: zeek.ssl.server.issuer.ST
      target_field: zeek.ssl.server.issuer.state
      ignore_missing: true
  - gsub:
      field: zeek.ssl.subject
      pattern: \\,
      replacement: ""
      ignore_missing: true
  - kv:
      field: zeek.ssl.subject
      field_split: ","
      value_split: "="
      target_field: zeek.ssl.server.subject
      ignore_missing: true
  - rename:
      field: zeek.ssl.subject
      target_field: tls.server.subject
      ignore_missing: true
  - set:
      field: tls.server.x509.subject.country
      value: ["{{{zeek.ssl.server.subject.C}}}"]
      if: ctx.zeek?.ssl?.server?.subject?.C instanceof String
  - rename:
      field: zeek.ssl.server.subject.C
      target_field: zeek.ssl.server.subject.country
      ignore_missing: true
  - set:
      field: tls.server.x509.subject.common_name
      value: ["{{{zeek.ssl.server.subject.CN}}}"]
      if: ctx.zeek?.ssl?.server?.subject?.CN instanceof String
  - rename:
      field: zeek.ssl.server.subject.CN
      target_field: zeek.ssl.server.subject.common_name
      ignore_missing: true
  - set:
      field: tls.server.x509.subject.locality
      value: ["{{{zeek.ssl.server.subject.L}}}"]
      if: ctx.zeek?.ssl?.server?.subject?.L instanceof String
  - rename:
      field: zeek.ssl.server.subject.L
      target_field: zeek.ssl.server.subject.locality
      ignore_missing: true
  - set:
      field: tls.server.x509.subject.organization
      value: ["{{{zeek.ssl.server.subject.O}}}"]
      if: ctx.zeek?.ssl?.server?.subject?.O instanceof String
  - rename:
      field: zeek.ssl.server.subject.O
      target_field: zeek.ssl.server.subject.organization
      ignore_missing: true
  - set:
      field: tls.server.x509.subject.organizational_unit
      value: ["{{{zeek.ssl.server.subject.OU}}}"]
      if: ctx.zeek?.ssl?.server?.subject?.OU instanceof String
  - rename:
      field: zeek.ssl.server.subject.OU
      target_field: zeek.ssl.server.subject.organizational_unit
      ignore_missing: true
  - set:
      field: tls.server.x509.subject.state_or_province
      value: ["{{{zeek.ssl.server.subject.ST}}}"]
      if: ctx.zeek?.ssl?.server?.subject?.ST instanceof String
  - rename:
      field: zeek.ssl.server.subject.ST
      target_field: zeek.ssl.server.subject.state
      ignore_missing: true
  - gsub:
      field: zeek.ssl.client_issuer
      pattern: \\,
      replacement: ""
      ignore_missing: true
  - kv:
      field: zeek.ssl.client_issuer
      field_split: ","
      value_split: "="
      target_field: zeek.ssl.client.issuer
      ignore_missing: true
  - rename:
      field: zeek.ssl.client_issuer
      target_field: tls.client.issuer
      ignore_missing: true
  - set:
      field: tls.client.x509.issuer.country
      value: ["{{{zeek.ssl.client.issuer.C}}}"]
      if: ctx.zeek?.ssl?.client?.issuer?.C instanceof String
  - rename:
      field: zeek.ssl.client.issuer.C
      target_field: zeek.ssl.client.issuer.country
      ignore_missing: true
  - set:
      field: tls.client.x509.issuer.common_name
      value: ["{{{zeek.ssl.client.issuer.CN}}}"]
      if: ctx.zeek?.ssl?.client?.issuer?.CN instanceof String
  - rename:
      field: zeek.ssl.client.issuer.CN
      target_field: zeek.ssl.client.issuer.common_name
      ignore_missing: true
  - set:
      field: tls.client.x509.issuer.locality
      value: ["{{{zeek.ssl.client.issuer.L}}}"]
      if: ctx.zeek?.ssl?.client?.issuer?.L instanceof String
  - rename:
      field: zeek.ssl.client.issuer.L
      target_field: zeek.ssl.client.issuer.locality
      ignore_missing: true
  - set:
      field: tls.client.x509.issuer.organization
      value: ["{{{zeek.ssl.client.issuer.O}}}"]
      if: ctx.zeek?.ssl?.client?.issuer?.O instanceof String
  - rename:
      field: zeek.ssl.client.issuer.O
      target_field: zeek.ssl.client.issuer.organization
      ignore_missing: true
  - set:
      field: tls.client.x509.issuer.organizational_unit
      value: ["{{{zeek.ssl.client.issuer.OU}}}"]
      if: ctx.zeek?.ssl?.client?.issuer?.OU instanceof String
  - rename:
      field: zeek.ssl.client.subject.OU
      target_field: zeek.ssl.client.subject.organizational_unit
      ignore_missing: true
  - set:
      field: tls.client.x509.issuer.state_or_province
      value: ["{{{zeek.ssl.client.issuer.ST}}}"]
      if: ctx.zeek?.ssl?.client?.issuer?.ST instanceof String
  - rename:
      field: zeek.ssl.client.issuer.ST
      target_field: zeek.ssl.client.issuer.state
      ignore_missing: true
  - gsub:
      field: zeek.ssl.client_subject
      pattern: \\,
      replacement: ""
      ignore_missing: true
  - kv:
      field: zeek.ssl.client_subject
      field_split: ","
      value_split: "="
      target_field: zeek.ssl.client.subject
      ignore_missing: true
  - remove:
      field: zeek.ssl.client_subject
      ignore_missing: true
  - set:
      field: tls.client.x509.subject.country
      value: ["{{{zeek.ssl.client.subject.C}}}"]
      if: ctx.zeek?.ssl?.client?.subject?.C instanceof String
  - rename:
      field: zeek.ssl.client.subject.C
      target_field: zeek.ssl.client.subject.country
      ignore_missing: true
  - set:
      field: tls.client.x509.subject.common_name
      value: ["{{{zeek.ssl.client.subject.CN}}}"]
      if: ctx.zeek?.ssl?.client?.subject?.CN instanceof String
  - rename:
      field: zeek.ssl.client.subject.CN
      target_field: zeek.ssl.client.subject.common_name
      ignore_missing: true
  - set:
      field: tls.client.x509.subject.locality
      value: ["{{{zeek.ssl.client.subject.L}}}"]
      if: ctx.zeek?.ssl?.client?.subject?.L instanceof String
  - rename:
      field: zeek.ssl.client.subject.L
      target_field: zeek.ssl.client.subject.locality
      ignore_missing: true
  - set:
      field: tls.client.x509.subject.organization
      value: ["{{{zeek.ssl.client.subject.O}}}"]
      if: ctx.zeek?.ssl?.client?.subject?.O instanceof String
  - rename:
      field: zeek.ssl.client.subject.O
      target_field: zeek.ssl.client.subject.organization
      ignore_missing: true
  - set:
      field: tls.client.x509.subject.organizational_unit
      value: ["{{{zeek.ssl.client.subject.OU}}}"]
      if: ctx.zeek?.ssl?.client?.subject?.OU instanceof String
  - rename:
      field: zeek.ssl.client.subject.OU
      target_field: zeek.ssl.client.subject.organizational_unit
      ignore_missing: true
  - set:
      field: tls.client.x509.subject.state_or_province
      value: ["{{{zeek.ssl.client.subject.ST}}}"]
      if: ctx.zeek?.ssl?.client?.subject?.ST instanceof String
  - rename:
      field: zeek.ssl.client.subject.ST
      target_field: zeek.ssl.client.subject.state
      ignore_missing: true
  - set:
      field: tls.cipher
      value: "{{{zeek.ssl.cipher}}}"
      if: ctx.zeek?.ssl?.cipher != null
  - set:
      field: tls.curve
      value: "{{{zeek.ssl.curve}}}"
      if: ctx.zeek?.ssl?.curve != null
  - convert:
      target_field: tls.established
      field: zeek.ssl.established
      type: boolean
      ignore_missing: true
  - convert:
      target_field: tls.resumed
      field: zeek.ssl.resumed
      type: boolean
      ignore_missing: true
  - script:
      lang: painless
      if: ctx.zeek?.ssl?.version != null
      source: >-
        def parts = ctx.zeek.ssl.version.splitOnToken("v");
        if (parts.length != 2) {
          return;
        }
        if (parts[0] == "SSL") {
          ctx.tls.version = parts[1] + ".0";
        } else {
          ctx.tls.version = parts[1].substring(0,1) + "." + parts[1].substring(1);
        }
        ctx.tls.version_protocol = parts[0].toLowerCase();
  - rename:
      field: zeek.ssl.ja3
      target_field: tls.client.ja3
      ignore_missing: true
  - rename:
      field: zeek.ssl.ja3s
      target_field: tls.server.ja3s
      ignore_missing: true
  - append:
      field: related.ip
      value: "{{{source.ip}}}"
      if: "ctx.source?.ip != null"
      allow_duplicates: false
  - append:
      field: related.ip
      value: "{{{destination.ip}}}"
      if: "ctx.destination?.ip != null"
      allow_duplicates: false
  - append:
      field: related.hash
      value: "{{{tls.server.ja3s}}}"
      if: "ctx.tls?.server?.ja3s != null"
  - append:
      field: related.hash
      value: "{{{tls.client.ja3}}}"
      if: "ctx.tls?.client?.ja3 != null"
      allow_duplicates: false
  - community_id:
      target_field: network.community_id
  - remove:
      field:
        - zeek.ssl.client
      ignore_missing: true
      if: 'ctx.zeek?.ssl?.client == null || ctx.zeek?.ssl?.client.isEmpty()'
  - remove:
      field:
        - zeek.ssl.id
      ignore_missing: true
  - remove:
      field: event.original
      if: "ctx.tags == null || !(ctx.tags.contains('preserve_original_event'))"
      ignore_failure: true
      ignore_missing: true
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - set:
      field: error.message
      value: '{{{ _ingest.on_failure_message }}}'
