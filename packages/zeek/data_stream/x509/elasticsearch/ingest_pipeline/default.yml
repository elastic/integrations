---
description: Pipeline for normalizing Zeek x509.log
processors:
  - rename:
      tag: rename_message_to_event_original_56a77271
      field: message
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - json:
      tag: json_event_original_to__temp__7408cf8c
      field: event.original
      target_field: _temp_
  - pipeline:
      tag: pipeline_c69a6660
      if: ctx?._temp_?.result != null
      name: '{{ IngestPipeline "third-party" }}'
  - drop:
      tag: drop_c70c3de1
      description: Drop if no timestamp (invalid json)
      if: 'ctx?._temp_?.ts == null'
  - rename:
      tag: rename__temp__to_zeek_x509_598fdc86
      field: _temp_
      target_field: zeek.x509
      # Sets event.created from the @timestamp field generated by filebeat before being overwritten further down
  - set:
      tag: set_event_created_e3f09e3b
      field: event.created
      copy_from: "@timestamp"
  - set:
      tag: set_event_kind_de80643c
      field: event.kind
      value: event
  - set:
      tag: set_ecs_version_f5923549
      field: ecs.version
      value: '8.17.0'
  - append:
      tag: append_event_type_8a66ccaa
      field: event.type
      value: info
  - dot_expander:
      tag: dot_expander_certificate_version_5083ac0e
      path: zeek.x509
      field: certificate.version
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_serial_01dc8028
      path: zeek.x509
      field: certificate.serial
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_subject_6e404b6a
      path: zeek.x509
      field: certificate.subject
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_issuer_2d8e56ab
      path: zeek.x509
      field: certificate.issuer
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_not_valid_before_2aa647ca
      path: zeek.x509
      field: certificate.not_valid_before
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_not_valid_after_85dc08f7
      path: zeek.x509
      field: certificate.not_valid_after
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_key_alg_fde685f0
      path: zeek.x509
      field: certificate.key_alg
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_sig_alg_b1726db2
      path: zeek.x509
      field: certificate.sig_alg
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_key_type_d7adb3a8
      path: zeek.x509
      field: certificate.key_type
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_key_length_f246e250
      path: zeek.x509
      field: certificate.key_length
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_exponent_68e8e903
      path: zeek.x509
      field: certificate.exponent
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_certificate_cn_5485b055
      path: zeek.x509
      field: certificate.cn
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_zeek_x509_basic_constraints_ca_525a9213
      path: zeek.x509
      field: zeek.x509.basic_constraints.ca
      ignore_failure: true
  - dot_expander:
      tag: dot_expander_basic_constraints_path_len_050dd025
      path: zeek.x509
      field: basic_constraints.path_len
      ignore_failure: true
  - rename:
      tag: rename_zeek_x509_id_to_zeek_session_id_fb9653af
      field: zeek.x509.id
      target_field: zeek.session_id
      ignore_missing: true
  - set:
      tag: set_event_id_3119a372
      field: event.id
      copy_from: zeek.session_id
      if: ctx.zeek?.session_id != null
  - rename:
      tag: rename_zeek_x509_certificate_not_valid_before_to_zeek_x509_certificate_valid_from_09d379aa
      field: zeek.x509.certificate.not_valid_before
      target_field: zeek.x509.certificate.valid.from
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_certificate_not_valid_after_to_zeek_x509_certificate_valid_until_4c244863
      field: zeek.x509.certificate.not_valid_after
      target_field: zeek.x509.certificate.valid.until
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_basic_constraints_ca_to_zeek_x509_basic_constraints_certificate_authority_fbeb87ff
      field: zeek.x509.basic_constraints.ca
      target_field: zeek.x509.basic_constraints.certificate_authority
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_basic_constraints_path_len_to_zeek_x509_basic_constraints_path_length_9da5e6d7
      field: zeek.x509.basic_constraints.path_len
      target_field: zeek.x509.basic_constraints.path_length
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_certificate_cn_to_zeek_x509_certificate_common_name_5866d37a
      field: zeek.x509.certificate.cn
      target_field: zeek.x509.certificate.common_name
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_certificate_issuer_to_zeek_x509_certificate_iss_15ddb1d0
      field: zeek.x509.certificate.issuer
      target_field: zeek.x509.certificate.iss
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_certificate_subject_to_zeek_x509_certificate_sub_d3411c30
      field: zeek.x509.certificate.subject
      target_field: zeek.x509.certificate.sub
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_certificate_key_alg_to_zeek_x509_certificate_key_algorithm_7997e97c
      field: zeek.x509.certificate.key_alg
      target_field: zeek.x509.certificate.key.algorithm
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_certificate_key_length_to_zeek_x509_certificate_key_length_a50ab535
      field: zeek.x509.certificate.key_length
      target_field: zeek.x509.certificate.key.length
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_certificate_key_type_to_zeek_x509_certificate_key_type_6215876d
      field: zeek.x509.certificate.key_type
      target_field: zeek.x509.certificate.key.type
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_certificate_sig_alg_to_zeek_x509_certificate_signature_algorithm_9817da8a
      field: zeek.x509.certificate.sig_alg
      target_field: zeek.x509.certificate.signature_algorithm
      ignore_missing: true
  - rename:
      tag: rename_zeek_x509_logcert_to_zeek_x509_log_cert_b5804d43
      field: zeek.x509.logcert
      target_field: zeek.x509.log_cert
      ignore_missing: true
  - date:
      tag: date_zeek_x509_ts_34d12623
      field: zeek.x509.ts
      formats:
        - UNIX
        - ISO8601
  - remove:
      tag: remove_zeek_x509_ts_c7501221
      field: zeek.x509.ts
  - set:
      tag: set_event_id_80b01e72
      field: event.id
      value: "{{{zeek.session_id}}}"
      if: ctx.zeek.session_id != null
  - set:
      tag: set_file_x509_signature_algorithm_2f464450
      field: file.x509.signature_algorithm
      value: "{{{zeek.x509.certificate.signature_algorithm}}}"
      ignore_empty_value: true
  - script:
      tag: script_1aff3302
      lang: painless
      params:
        "md2WithRSAEncryption": MD2-RSA
        "md5WithRSAEncryption": MD5-RSA
        "sha-1WithRSAEncryption": SHA1-RSA
        "sha256WithRSAEncryption": SHA256-RSA
        "sha384WithRSAEncryption": SHA384-RSA
        "sha512WithRSAEncryption": SHA512-RSA
        "dsaWithSha1": DSA-SHA1
        "dsaWithSha256": DSA-SHA256
        "ecdsa-with-SHA1": ECDSA-SHA1
        "ecdsa-with-SHA256": ECDSA-SHA256
        "ecdsa-with-SHA384": ECDSA-SHA384
        "ecdsa-with-SHA512": ECDSA-SHA512
        "id-Ed25519": Ed25519
      source: |
        String algo = params.get(ctx.file.x509.signature_algorithm);
        if (algo != null) {
          ctx.file.x509.signature_algorithm = algo;
        }
      if: ctx.file?.x509?.signature_algorithm != null
  - set:
      tag: set_file_x509_public_key_algorithm_62b55ca7
      field: file.x509.public_key_algorithm
      value: "{{{zeek.x509.certificate.key.algorithm}}}"
      ignore_empty_value: true
  - convert:
      tag: convert_zeek_x509_certificate_key_length_to_file_x509_public_key_size_cf406a93
      field: zeek.x509.certificate.key.length
      target_field: file.x509.public_key_size
      type: long
      ignore_missing: true
  - dot_expander:
      tag: dot_expander_certificate_exponent_ba4f3304
      field: certificate.exponent
      path: zeek.x509
  - convert:
      tag: convert_zeek_x509_certificate_exponent_to_file_x509_public_key_exponent_1035b6d1
      field: zeek.x509.certificate.exponent
      target_field: file.x509.public_key_exponent
      type: long
      ignore_missing: true
  - dot_expander:
      tag: dot_expander_certificate_serial_9326a2f3
      field: certificate.serial
      path: zeek.x509
  - set:
      tag: set_file_x509_serial_number_4877ce26
      field: file.x509.serial_number
      value: "{{{zeek.x509.certificate.serial}}}"
      ignore_empty_value: true
  - dot_expander:
      tag: dot_expander_certificate_version_ebec668d
      field: certificate.version
      path: zeek.x509
  - set:
      tag: set_file_x509_version_number_c2e37dd2
      field: file.x509.version_number
      value: "{{{zeek.x509.certificate.version}}}"
      ignore_empty_value: true
  - dot_expander:
      tag: dot_expander_san_dns_e327ed4f
      field: san.dns
      path: zeek.x509
  - foreach:
      tag: foreach_zeek_x509_san_dns_5312a024
      field: zeek.x509.san.dns
      ignore_missing: true
      processor:
        append:
          field: file.x509.alternative_names
          value: "{{{_ingest._value}}}"
  - dot_expander:
      tag: dot_expander_san_uri_7a553e36
      field: san.uri
      path: zeek.x509
  - foreach:
      tag: foreach_zeek_x509_san_uri_788c08d7
      field: zeek.x509.san.uri
      ignore_missing: true
      processor:
        append:
          field: file.x509.alternative_names
          value: "{{{_ingest._value}}}"
  - dot_expander:
      tag: dot_expander_san_email_40317b68
      field: san.email
      path: zeek.x509
  - foreach:
      tag: foreach_zeek_x509_san_email_bcb9759d
      field: zeek.x509.san.email
      ignore_missing: true
      processor:
        append:
          field: file.x509.alternative_names
          value: "{{{_ingest._value}}}"
  - dot_expander:
      tag: dot_expander_san_ip_f895e3bd
      field: san.ip
      path: zeek.x509
  - foreach:
      tag: foreach_zeek_x509_san_ip_63f6cf26
      field: zeek.x509.san.ip
      ignore_missing: true
      processor:
        append:
          field: file.x509.alternative_names
          value: "{{{_ingest._value}}}"
  - dot_expander:
      tag: dot_expander_san_other_fields_604c920a
      field: san.other_fields
      path: zeek.x509
  - foreach:
      tag: foreach_zeek_x509_san_other_fields_8f24523b
      field: zeek.x509.san.other_fields
      ignore_missing: true
      processor:
        append:
          field: file.x509.alternative_names
          value: "{{{_ingest._value}}}"
  - date:
      tag: date_zeek_x509_certificate_valid_from_to_zeek_x509_certificate_valid_from_d81d6a64
      field: zeek.x509.certificate.valid.from
      target_field: zeek.x509.certificate.valid.from
      formats:
        - UNIX
        - ISO8601
      if: ctx.zeek.x509.certificate?.valid?.from != null
  - set:
      tag: set_file_x509_not_before_ea4f1c11
      field: file.x509.not_before
      value: "{{{zeek.x509.certificate.valid.from}}}"
      ignore_empty_value: true
  - date:
      tag: date_zeek_x509_certificate_valid_until_to_zeek_x509_certificate_valid_until_c2ad96d8
      field: zeek.x509.certificate.valid.until
      target_field: zeek.x509.certificate.valid.until
      formats:
        - UNIX
        - ISO8601
      if: ctx.zeek.x509.certificate?.valid?.until != null
  - set:
      tag: set_file_x509_not_after_797c0380
      field: file.x509.not_after
      value: "{{{zeek.x509.certificate.valid.until}}}"
      ignore_empty_value: true
  - gsub:
      tag: gsub_zeek_x509_certificate_iss_349885d6
      field: zeek.x509.certificate.iss
      pattern: \\,
      replacement: ""
      ignore_missing: true
  - kv:
      tag: kv_zeek_x509_certificate_iss_to_zeek_x509_certificate_issuer_fa72cbc1
      field: zeek.x509.certificate.iss
      field_split: ","
      value_split: "="
      target_field: zeek.x509.certificate.issuer
      ignore_missing: true
  - remove:
      tag: remove_zeek_x509_certificate_iss_aa25f739
      field: zeek.x509.certificate.iss
      ignore_missing: true
  - set:
      tag: set_file_x509_issuer_country_0e7fc00a
      field: file.x509.issuer.country
      value: ["{{{zeek.x509.certificate.issuer.C}}}"]
      if: ctx.zeek?.x509?.certificate?.issuer?.C instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_issuer_C_to_zeek_x509_certificate_issuer_country_de6f4b7d
      field: zeek.x509.certificate.issuer.C
      target_field: zeek.x509.certificate.issuer.country
      ignore_missing: true
  - set:
      tag: set_file_x509_issuer_common_name_c1b64639
      field: file.x509.issuer.common_name
      value: ["{{{zeek.x509.certificate.issuer.CN}}}"]
      if: ctx.zeek?.x509?.certificate?.issuer?.CN instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_issuer_CN_to_zeek_x509_certificate_issuer_common_name_f26fece4
      field: zeek.x509.certificate.issuer.CN
      target_field: zeek.x509.certificate.issuer.common_name
      ignore_missing: true
  - set:
      tag: set_file_x509_issuer_locality_4489d94b
      field: file.x509.issuer.locality
      value: ["{{{zeek.x509.certificate.issuer.L}}}"]
      if: ctx.zeek?.x509?.certificate?.issuer?.L instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_issuer_L_to_zeek_x509_certificate_issuer_locality_e2096533
      field: zeek.x509.certificate.issuer.L
      target_field: zeek.x509.certificate.issuer.locality
      ignore_missing: true
  - set:
      tag: set_file_x509_issuer_organization_4520f5db
      field: file.x509.issuer.organization
      value: ["{{{zeek.x509.certificate.issuer.O}}}"]
      if: ctx.zeek?.x509?.certificate?.issuer?.O instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_issuer_O_to_zeek_x509_certificate_issuer_organization_278d0d74
      field: zeek.x509.certificate.issuer.O
      target_field: zeek.x509.certificate.issuer.organization
      ignore_missing: true
  - set:
      tag: set_file_x509_issuer_organizational_unit_78e08f85
      field: file.x509.issuer.organizational_unit
      value: ["{{{zeek.x509.certificate.issuer.OU}}}"]
      if: ctx.zeek?.x509?.certificate?.issuer?.OU instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_issuer_OU_to_zeek_x509_certificate_issuer_organizational_unit_a605e237
      field: zeek.x509.certificate.issuer.OU
      target_field: zeek.x509.certificate.issuer.organizational_unit
      ignore_missing: true
  - set:
      tag: set_file_x509_issuer_state_or_province_c6af40f8
      field: file.x509.issuer.state_or_province
      value: ["{{{zeek.x509.certificate.issuer.ST}}}"]
      if: ctx.zeek?.x509?.certificate?.issuer?.ST instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_issuer_ST_to_zeek_x509_certificate_issuer_state_c22aa4fa
      field: zeek.x509.certificate.issuer.ST
      target_field: zeek.x509.certificate.issuer.state
      ignore_missing: true
  - gsub:
      tag: gsub_zeek_x509_certificate_sub_446b0941
      field: zeek.x509.certificate.sub
      pattern: \\,
      replacement: ""
      ignore_missing: true
  - kv:
      tag: kv_zeek_x509_certificate_sub_to_zeek_x509_certificate_subject_d5b2dfe9
      field: zeek.x509.certificate.sub
      field_split: ","
      value_split: "="
      target_field: zeek.x509.certificate.subject
      ignore_missing: true
  - remove:
      tag: remove_zeek_x509_certificate_sub_52c2a7d4
      field: zeek.x509.certificate.sub
      ignore_missing: true
  - set:
      tag: set_file_x509_subject_country_07786ab3
      field: file.x509.subject.country
      value: ["{{{zeek.x509.certificate.subject.C}}}"]
      if: ctx.zeek?.x509?.certificate?.subject?.C instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_subject_C_to_zeek_x509_certificate_subject_country_992b66c9
      field: zeek.x509.certificate.subject.C
      target_field: zeek.x509.certificate.subject.country
      ignore_missing: true
  - set:
      tag: set_file_x509_subject_common_name_abff9222
      field: file.x509.subject.common_name
      value: ["{{{zeek.x509.certificate.subject.CN}}}"]
      if: ctx.zeek?.x509?.certificate?.subject?.CN instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_subject_CN_to_zeek_x509_certificate_subject_common_name_746cfd1a
      field: zeek.x509.certificate.subject.CN
      target_field: zeek.x509.certificate.subject.common_name
      ignore_missing: true
  - set:
      tag: set_file_x509_subject_locality_127aece6
      field: file.x509.subject.locality
      value: ["{{{zeek.x509.certificate.subject.L}}}"]
      if: ctx.zeek?.x509?.certificate?.subject?.L instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_subject_L_to_zeek_x509_certificate_subject_locality_62cbedd5
      field: zeek.x509.certificate.subject.L
      target_field: zeek.x509.certificate.subject.locality
      ignore_missing: true
  - set:
      tag: set_file_x509_subject_organization_f52f7b8c
      field: file.x509.subject.organization
      value: ["{{{zeek.x509.certificate.subject.O}}}"]
      if: ctx.zeek?.x509?.certificate?.subject?.O instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_subject_O_to_zeek_x509_certificate_subject_organization_d18ac700
      field: zeek.x509.certificate.subject.O
      target_field: zeek.x509.certificate.subject.organization
      ignore_missing: true
  - set:
      tag: set_file_x509_subject_organizational_unit_fe4eb674
      field: file.x509.subject.organizational_unit
      value: ["{{{zeek.x509.certificate.subject.OU}}}"]
      if: ctx.zeek?.x509?.certificate?.subject?.OU instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_subject_OU_to_zeek_x509_certificate_subject_organizational_unit_fa4a788b
      field: zeek.x509.certificate.subject.OU
      target_field: zeek.x509.certificate.subject.organizational_unit
      ignore_missing: true
  - set:
      tag: set_file_x509_subject_state_or_province_2b505aff
      field: file.x509.subject.state_or_province
      value: ["{{{zeek.x509.certificate.subject.ST}}}"]
      if: ctx.zeek?.x509?.certificate?.subject?.ST instanceof String
  - rename:
      tag: rename_zeek_x509_certificate_subject_ST_to_zeek_x509_certificate_subject_state_4aa73304
      field: zeek.x509.certificate.subject.ST
      target_field: zeek.x509.certificate.subject.state
      ignore_missing: true
  - append:
      tag: append_preserve_original_event_on_error
      field: tags
      value: preserve_original_event
      allow_duplicates: false
      if: ctx.error?.message != null
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{#_ingest.on_failure_processor_tag}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{/_ingest.on_failure_processor_tag}}in pipeline '{{{ _ingest.pipeline }}}'
        failed with message '{{{ _ingest.on_failure_message }}}'
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
