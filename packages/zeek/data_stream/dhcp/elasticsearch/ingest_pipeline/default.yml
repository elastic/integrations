---
description: Pipeline for normalizing Zeek dhcp.log
processors:
  - rename:
      tag: rename_message_to_event_original_56a77271
      field: message
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - json:
      tag: json_event_original_to__temp__7408cf8c
      field: event.original
      target_field: _temp_
  - pipeline:
      tag: pipeline_c69a6660
      if: ctx?._temp_?.result != null
      name: '{{ IngestPipeline "third-party" }}'
  - drop:
      tag: drop_c70c3de1
      description: Drop if no timestamp (invalid json)
      if: 'ctx?._temp_?.ts == null'
  - rename:
      tag: rename__temp__to_zeek_dhcp_1a6c1843
      field: _temp_
      target_field: zeek.dhcp
      # Sets event.created from the @timestamp field generated by filebeat before being overwritten further down
  - set:
      tag: set_event_created_e3f09e3b
      field: event.created
      copy_from: "@timestamp"
  - set:
      tag: set_ecs_version_f5923549
      field: ecs.version
      value: '8.17.0'
  - append:
      tag: append_event_category_7afdca3c
      field: event.category
      value: network
  - append:
      tag: append_event_type_ab8d9d0e
      field: event.type
      value: connection
  - append:
      tag: append_event_type_7ca1b382
      field: event.type
      value: protocol
  - append:
      tag: append_event_type_8a66ccaa
      field: event.type
      value: info
  - set:
      tag: set_event_kind_de80643c
      field: event.kind
      value: event
  - set:
      tag: set_network_transport_a6cfd568
      field: network.transport
      value: udp
  - set:
      tag: set_network_protocol_ea539779
      field: network.protocol
      value: dhcp
  - rename:
      tag: rename_zeek_dhcp_uids_to_zeek_session_id_fac1f710
      field: zeek.dhcp.uids
      target_field: zeek.session_id
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_assigned_addr_to_zeek_dhcp_address_assigned_453773ce
      field: zeek.dhcp.assigned_addr
      target_field: zeek.dhcp.address.assigned
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_client_addr_to_zeek_dhcp_address_client_026c4398
      field: zeek.dhcp.client_addr
      target_field: zeek.dhcp.address.client
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_mac_to_zeek_dhcp_address_mac_287b8e3e
      field: zeek.dhcp.mac
      target_field: zeek.dhcp.address.mac
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_requested_addr_to_zeek_dhcp_address_requested_afb9107c
      field: zeek.dhcp.requested_addr
      target_field: zeek.dhcp.address.requested
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_server_addr_to_zeek_dhcp_address_server_fce0bc00
      field: zeek.dhcp.server_addr
      target_field: zeek.dhcp.address.server
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_host_name_to_zeek_dhcp_hostname_c81f3f49
      field: zeek.dhcp.host_name
      target_field: zeek.dhcp.hostname
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_client_message_to_zeek_dhcp_msg_client_b561f5cf
      field: zeek.dhcp.client_message
      target_field: zeek.dhcp.msg.client
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_server_message_to_zeek_dhcp_msg_server_4520d757
      field: zeek.dhcp.server_message
      target_field: zeek.dhcp.msg.server
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_msg_types_to_zeek_dhcp_msg_types_9314049b
      field: zeek.dhcp.msg_types
      target_field: zeek.dhcp.msg.types
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_msg_orig_to_zeek_dhcp_msg_origin_818e97d0
      field: zeek.dhcp.msg_orig
      target_field: zeek.dhcp.msg.origin
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_client_software_to_zeek_dhcp_software_client_fa809645
      field: zeek.dhcp.client_software
      target_field: zeek.dhcp.software.client
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_server_software_to_zeek_dhcp_software_server_504efd65
      field: zeek.dhcp.server_software
      target_field: zeek.dhcp.software.server
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_circuit_id_to_zeek_dhcp_id_circuit_03003383
      field: zeek.dhcp.circuit_id
      target_field: zeek.dhcp.id.circuit
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_agent_remote_id_to_zeek_dhcp_id_remote_agent_f8086215
      field: zeek.dhcp.agent_remote_id
      target_field: zeek.dhcp.id.remote_agent
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_subscriber_id_to_zeek_dhcp_id_subscriber_6c4c2115
      field: zeek.dhcp.subscriber_id
      target_field: zeek.dhcp.id.subscriber
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_client_port_to_source_port_c7362953
      field: zeek.dhcp.client_port
      target_field: source.port
      ignore_missing: true
  - rename:
      tag: rename_zeek_dhcp_server_port_to_destination_port_e87a6270
      field: zeek.dhcp.server_port
      target_field: destination.port
      ignore_missing: true
  - set:
      tag: set_network_name_e9b2c463
      field: network.name
      copy_from: zeek.dhcp.domain
      if: ctx.zeek?.dhcp?.domain != null
  - set:
      tag: set_source_port_76b2113c
      field: source.port
      value: 68
      if: ctx.source?.port == null
  - set:
      tag: set_destination_port_605ef611
      field: destination.port
      value: 67
      if: ctx.destination?.port == null
  - set:
      tag: set_source_address_0f28001b
      field: source.address
      copy_from: zeek.dhcp.address.client
      ignore_empty_value: true
  - set:
      tag: set_client_address_7d576639
      field: client.address
      copy_from: zeek.dhcp.address.client
      ignore_empty_value: true
  - set:
      tag: set_source_ip_eb9e3caa
      field: source.ip
      copy_from: zeek.dhcp.address.client
      ignore_empty_value: true
  - set:
      tag: set_destination_address_f04decb8
      field: destination.address
      copy_from: zeek.dhcp.address.server
      ignore_empty_value: true
  - set:
      tag: set_destination_ip_e3283d57
      field: destination.ip
      copy_from: zeek.dhcp.address.server
      ignore_empty_value: true
  - set:
      tag: set_server_address_e00746b9
      field: server.address
      copy_from: zeek.dhcp.address.server
      ignore_empty_value: true
  - date:
      tag: date_zeek_dhcp_ts_4ed7aefa
      field: zeek.dhcp.ts
      formats:
        - UNIX
        - ISO8601
  - remove:
      tag: remove_zeek_dhcp_ts_b8519076
      field: zeek.dhcp.ts
  - set:
      tag: set_event_id_fa496343
      field: event.id
      copy_from: zeek.session_id
      if: ctx.zeek.session_id != null
  - append:
      tag: append_related_ip_8121c591
      field: related.ip
      value: "{{{source.ip}}}"
      if: "ctx.source?.ip != null"
      allow_duplicates: false
  - append:
      tag: append_related_ip_c1a6356b
      field: related.ip
      value: "{{{destination.ip}}}"
      if: "ctx.destination?.ip != null"
      allow_duplicates: false
  - community_id:
      tag: community_id_612651e3
      target_field: network.community_id
  - append:
      tag: append_preserve_original_event_on_error
      field: tags
      value: preserve_original_event
      allow_duplicates: false
      if: ctx.error?.message != null
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{#_ingest.on_failure_processor_tag}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{/_ingest.on_failure_processor_tag}}in pipeline '{{{ _ingest.pipeline }}}'
        failed with message '{{{ _ingest.on_failure_message }}}'
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
