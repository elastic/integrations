# Service Info

The Zeek integration allows users to ingest and analyze network traffic logs produced by the Zeek passive network security monitor. By transforming raw network traffic into structured, high-level logs, Zeek provides a comprehensive view of network activity, which this integration further enriches for use within the Elastic Stack.

## How it works

This integration works by collecting logs directly from files generated by Zeek. Elastic Agent monitors specified log file paths, collects the log entries as they are written, and forwards them to your Elastic deployment for parsing, indexing, and analysis.

## Common use cases

The Zeek integration is designed to ingest and normalize the high-fidelity network security monitoring logs generated by Zeek's passive traffic analysis. This integration enables security analysts to transform raw network data into actionable insights within the Elastic Stack.

-   **Threat Hunting:** Search and analyze detailed connection logs, file hashes, and protocol-specific data to proactively hunt for threats.
-   **Incident Response:** Accelerate incident investigation with rich, contextual network data to understand the scope and impact of a security event.
-   **Security Monitoring:** Use pre-built Kibana dashboards to monitor network traffic for anomalies, policy violations, and known attack patterns.
-   **Network Visibility:** Gain deep insights into all network activity, including encrypted traffic (via SSL/TLS metadata), DNS requests, and file transfers across the network.

## Data types collected

This integration collects a comprehensive range of network metadata. Each data stream corresponds to a specific Zeek log file, typically located in the Zeek log directory.

-   **capture_loss:** Collect Zeek capture_loss logs to monitor packet loss at the sensor level.
-   **connection:** Collect Zeek connection logs (conn.log) containing TCP/UDP/ICMP metadata.
-   **dce_rpc:** Collect Zeek dce_rpc logs for Distributed Computing Environment / Remote Procedure Calls.
-   **dhcp:** Collect Zeek dhcp logs documenting lease activity and client metadata.
-   **dnp3:** Collect Zeek dnp3 logs for SCADA/ICS protocol monitoring.
-   **dns:** Collect Zeek dns logs for all queries and responses observed.
-   **dpd:** Collect Zeek dpd logs for Dynamic Protocol Detection failures.
-   **files:** Collect Zeek files logs containing metadata for files transferred over the network.
-   **ftp:** Collect Zeek ftp logs for file transfer protocol sessions and commands.
-   **http:** Collect Zeek http logs for requests, responses, and headers.
-   **intel:** Collect Zeek intel logs when traffic matches intelligence framework indicators.
-   **irc:** Collect Zeek irc logs for Internet Relay Chat activity.
-   **kerberos:** Collect Zeek kerberos logs for authentication and ticket requests.
-   **modbus:** Collect Zeek modbus logs for industrial control system communications.
-   **mysql:** Collect Zeek mysql logs for database query metadata.
-   **notice:** Collect Zeek notice logs for significant network events identified by Zeek.
-   **ntlm:** Collect Zeek ntlm logs for Windows authentication activity.
-   **ntp:** Collect Zeek ntp logs for Network Time Protocol synchronization.
-   **ocsp:** Collect Zeek ocsp logs for Online Certificate Status Protocol traffic.
-   **pe:** Collect Zeek pe logs for Portable Executable file metadata.
-   **radius:** Collect Zeek radius logs for authentication, authorization, and accounting.
-   **rdp:** Collect Zeek rdp logs for Remote Desktop Protocol sessions.
-   **rfb:** Collect Zeek rfb logs for Remote Frame Buffer (VNC) activity.
-   **signature:** Collect Zeek signature logs for traffic matching defined signatures.
-   **sip:** Collect Zeek sip logs for Session Initiation Protocol (VoIP) traffic.
-   **smb_cmd:** Collect Zeek smb_cmd logs for SMB commands.
-   **smb_files:** Collect Zeek smb_files logs for files accessed via SMB.
-   **smb_mapping:** Collect Zeek smb_mapping logs for SMB share mappings.
-   **smtp:** Collect Zeek smtp logs for email transaction metadata.
-   **snmp:** Collect Zeek snmp logs for Simple Network Management Protocol traffic.
-   **socks:** Collect Zeek socks logs for proxy relay activity.
-   **ssh:** Collect Zeek ssh logs for encrypted session metadata.
-   **ssl:** Collect Zeek ssl logs for TLS handshake and certificate information.
-   **stats:** Collect Zeek stats logs for system performance metrics.
-   **syslog:** Collect Zeek syslog logs for system log messages observed on the wire.
-   **traceroute:** Collect Zeek traceroute logs for network path detection.
-   **tunnel:** Collect Zeek tunnel logs for encapsulated traffic metadata.
-   **weird:** Collect Zeek weird logs for unexpected or malformed protocol behavior.
-   **x509:** Collect Zeek x509 logs for detailed certificate metadata.
-   **software:** Collect Zeek software logs for software versions identified on the network.
-   **Known Certs:** Collect Zeek Known Certs logs for certificates observed on the network.
-   **Known Hosts:** Collect Zeek Known Hosts logs for hosts observed on the network.
-   **Known Services:** Collect Zeek Known Services logs for services observed on the network.

## Compatibility

The Zeek integration is compatible with the following versions and platforms:

-   **Zeek** version **2.6.1** was the primary version used during development, but the integration is expected to work with all newer versions including the latest LTS releases.
-   **Log Format Requirement**: Zeek must be configured with the `json-logs` policy.

## Scaling and Performance

For more information on architectures that can be used for scaling this integration, check the [Ingest Architectures](https://www.elastic.co/docs/manage-data/ingest/ingest-reference-architectures) documentation.

In a high-volume environment, you may need to scale your Zeek deployment into a cluster. In this scenario, logs can be aggregated on a dedicated log collector host where the Elastic Agent is installed. This centralizes log collection and reduces the load on individual Zeek workers.

# Set Up Instructions

## Vendor prerequisites

-   **File System Permissions:** The Elastic Agent must have read access to the directory where Zeek writes its logs (e.g., `/opt/zeek/logs/current`).

## Elastic prerequisites

- **Elastic Agent Enrollment:** The Elastic Agent must be installed on the host with the Zeek logs and enrolled in Fleet.
- **Read Permissions:** The user account running the Elastic Agent must have read permissions for the Zeek log directory (e.g., `/opt/zeek/logs/current`).
- **Network Connectivity:** The Elastic Agent must have network connectivity to the Elastic Stack (Elasticsearch/Kibana) to ship data and receive policy updates.

## Vendor set up steps

### Configure Zeek for JSON Output:
1.  **Locate the configuration file:** Identify the `local.zeek` file for your site-specific configuration. Common paths include:
    - `/opt/zeek/share/zeek/site/local.zeek` (standard package install)
    - `/usr/local/zeek/share/zeek/site/local.zeek` (source install)
2.  **Edit the configuration:** Open `local.zeek` with root privileges using a text editor like `nano` or `vi`.
3.  **Enable JSON logging:** Append the following line to the end of the file to force all log streams into JSON format:
    ```zeek
    @load policy/tuning/json-logs.zeek
    ```
4.  **Save and exit:** Save the changes to the file.
5.  **Check the configuration:** Use the Zeek control utility to verify the script loads correctly:
    ```bash
    sudo zeekctl check
    ```
6.  **Apply and Restart:** Deploy the new configuration and restart the Zeek processes:
    ```bash
    sudo zeekctl deploy
    ```
7.  **Verify JSON format:** Check one of the current logs to ensure it is now formatted as JSON:
    ```bash
    head -n 1 /opt/zeek/logs/current/conn.log
    ```
    *(The output should start with a `{` character)*.

### Vendor Set up Resources

- [Zeek Quick Start Guide](https://docs.zeek.org/en/current/quickstart.html) - Official guide for initial Zeek installation and basic setup.
- [Zeek JSON Logs Policy Documentation](https://docs.zeek.org/en/master/scripts/policy/tuning/json-logs.zeek.html) - Documentation for the script that enables JSON log output.
- [Zeek Control (zeekctl) Documentation](https://github.com/zeek/zeekctl) - Reference for managing Zeek nodes and deploying configurations.

## Kibana set up steps

### Collects logs from Zeek instances. Supported logs include: capture_loss, connection, dce_rpc, dhcp, dnp3, dns, dpd, files, ftp, http, intel, irc, kerberos, modbus, mysql, notice, ntlm, ntp, ocsp, pe, radius, rdp, rfb, signature, sip, smb_cmd, smb_files, smb_mapping, smtp, snmp, socks, ssh, ssl, stats, syslog, traceroute, tunnel, weird and x509
1. In Kibana, navigate to **Management > Integrations** and search for **Zeek**.
2. Click **Add Zeek** and select an Agent policy.
3. Configure the **Base Path** where Zeek logs are stored. The default paths are:
   - `/var/log/bro/current`
   - `/opt/zeek/logs/current`
   - `/usr/local/var/spool/zeek`
4. Configure the following variables for each applicable data stream:
   - **Filename of capture loss log file** - Default: `['capture_loss.log']`
   - **Filename of connection log** - Default: `['conn.log']`
   - **Filename of dce_rpc log file** - Default: `['dce_rpc.log']`
   - **Filename of dhcp log file** - Default: `['dhcp.log']`
   - **Filename of dnp3 log file** - Default: `['dnp3.log']`
   - **Filename of dns log file** - Default: `['dns.log']`
   - **Filename of the dpd log file** - Default: `['dpd.log']`
   - **Filename of the files log file** - Default: `['files.log']`
   - **Filename of ftp log file** - Default: `['ftp.log']`
   - **Filename of http log file** - Default: `['http.log']`
   - **Filename of intel log file** - Default: `['intel.log']`
   - **Filename of irc log file** - Default: `['irc.log']`
   - **Filename of kerberos log file** - Default: `['kerberos.log']`
   - **Filename of modbus log file** - Default: `['modbus.log']`
   - **Filename of mysql log file** - Default: `['mysql.log']`
   - **Filename of notice log file** - Default: `['notice.log']`
   - **Filename of ntlm log file** - Default: `['ntlm.log']`
   - **Filename of ntp log** - Default: `['ntp.log']`
   - **Filename of ocsp log file** - Default: `['ocsp.log']`
   - **Filename of pe log file** - Default: `['pe.log']`
   - **Filename of radius log file** - Default: `['radius.log']`
   - **Filename of rdp log file** - Default: `['rdp.log']`
   - **Filename of rfb log file** - Default: `['rfb.log']`
   - **Filename of signature log** - Default: `['signature.log']`
   - **Filename of sip log file** - Default: `['sip.log']`
   - **Filename of smb_cmd log file** - Default: `['smb_cmd.log']`
   - **Filename of smb_files log file** - Default: `['smb_files.log']`
   - **Filename of smb_mapping log file** - Default: `['smb_mapping.log']`
   - **Filename of smtp log file** - Default: `['smtp.log']`
   - **Filename of snmp log file** - Default: `['snmp.log']`
   - **Filename of socks log file** - Default: `['socks.log']`
   - **Filename of software log** - Default: `['software.log']`
   - **Filename of ssh log file** - Default: `['ssh.log']`
   - **Filename of ssl log file** - Default: `['ssl.log']`
   - **Filename of stats log file** - Default: `['stats.log']`
   - **Filename of syslog log file** - Default: `['syslog.log']`
   - **Filename of traceroute log file** - Default: `['traceroute.log']`
   - **Filename of tunnel log file** - Default: `['tunnel.log']`
   - **Filename of weird log file** - Default: `['weird.log']`
   - **Filename of x509 log file** - Default: `['x509.log']`
   - **Filename of Known Certs log** - Default: `['known_certs.log']`
   - **Filename of Known Services log** - Default: `['known_services.log']`
   - **Filename of Known Hosts log** - Default: `['known_hosts.log']`
   - **Preserve original event** - Preserves a raw copy of the original event in `event.original`. Default: `False`.
   - **Tags** - List of tags to add to each event (e.g., `['forwarded', 'zeek-connection']`).
   - **Processors** - Configuration for Elastic Agent processors to filter or enhance data before ingestion.
5. Click **Save and continue** to deploy the configuration.

# Validation Steps

After configuration is complete, follow these steps to verify data is flowing correctly from Zeek to the Elastic Stack.

### 1. Trigger Data Flow on Zeek:
Trigger network traffic or activity which will be captured by the configured Zeek logging.

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the KQL filter: `data_stream.dataset : "zeek.connection"`
4. Verify logs appear. Expand a log entry and confirm these fields:
   - `event.dataset` (should be `zeek.connection`)
   - `source.ip` and `destination.ip`
   - `event.action` or `event.outcome`
   - `zeek.connection.id`
   - `message` (confirming the raw JSON payload)
5. Navigate to **Analytics > Dashboards** and search for "Zeek" to view the pre-built dashboards for Network Traffic and Protocol Overview.

# Troubleshooting

For help with Elastic ingest tools, check [Common problems](https://www.elastic.co/docs/troubleshoot/ingest/fleet/common-problems).

The most common issue with this integration is Zeek not being configured to output logs in JSON format. Please ensure you have followed the configuration steps correctly.

## Vendor Resources

-   [Official Zeek Website](https://zeek.org/)
-   [Zeek JSON Logs Policy Documentation](https://docs.zeek.org/en/lts/scripts/policy/tuning/json-logs.zeek.html)

# Documentation sites

- [Official Zeek Website](https://zeek.org/)
- [Zeek JSON Logs Policy Documentation](https://docs.zeek.org/en/lts/scripts/policy/tuning/json-logs.zeek.html)
- [Zeek Known Certs and Software Documentation](https://docs.zeek.org/en/master/logs/known-and-software.html#known-certs-log)
