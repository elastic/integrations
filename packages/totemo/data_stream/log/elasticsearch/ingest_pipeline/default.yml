---
description: Pipeline for processing Pleasant Password Server logs.
processors:
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - set:
      field: ecs.version
      value: "8.17.0"
  - set:
      field: event.kind
      value: event
  - grok:
      field: event.original
      patterns:
        - '^%{DATA:log.level}\s+<%{TIMESTAMP_ISO8601:event.created}>\s\[.*?\]\s+\[%{DATA:log.origin.function}\]\s+%{GREEDYDATA:message}'
        - '^%{GREEDYDATA:message}$'
  - lowercase:
      field: log.level
      if: ctx.log?.level != null
  - trim:
      field: log.origin.function
  #  # Set the Event Outcome to failure if the event.outcome is error
  #  - set:
  #      field: event.outcome
  #      value: "failure"
  #      if: ctx.event?.outcome == 'error'
  #  # Set the Event Outcome to unknown if neither error nor success is present
  #  - set:
  #      field: event.outcome
  #      value: "unknown"
  #      if: ctx.event?.outcome != 'success' && ctx.event?.outcome != 'failure'
  - rename:
      field: _conf.tz_offset
      target_field: event.timezone
      if: ctx._conf?.tz_offset != null && ctx._conf.tz_offset != 'local'
      ignore_missing: true
      ignore_failure: true
  - date:
      field: event.created
      target_field: "event.created"
      formats:
        - ISO8601
      timezone: "{{{event.timezone}}}"
      if: ctx.event?.timezone != null && ctx.event?.created != null
      on_failure:
        - remove:
            field: event.created
            ignore_missing: true
        - append:
            field: error.message
            value: "{{{_ingest.on_failure_message}}}"
  - date:
      field: event.created
      target_field: "event.created"
      formats:
        - ISO8601
      if: ctx.event?.timezone == null && ctx.event?.created != null
      on_failure:
        - remove:
            field: event.created
            ignore_missing: true
        - append:
            field: error.message
            value: "{{{_ingest.on_failure_message}}}"
  # Since logstash sets the @timestamp if not present, `override: true` is required to overwrite the value with event timestamp.
  - set:
      field: "@timestamp"
      value: "{{{event.created}}}"
      if: "ctx.event?.created != null"
      override: true

  - grok:
      field: message
      ignore_missing: true
      ignore_failure: true
      patterns:
        - '^Connection\sfrom\s%{HOSTNAME:client.domain}\s+\(%{IP:client.ip}\)'
        - 'Ending\s+connection\s+on\s+%{IP:server.ip}:%{INT:server.port}\s+from\s+%{IP:client.ip}:%{INT:client.port}'
        - '%{DATA:event.type}:\s+%{INT:event.code}\s+%{HOSTNAME:server.domain}%{DATA}\(%{HOSTNAME:client.domain}\s+\[%{IP:client_ip}\]\)'
  - set:
      field: "client.address"
      copy_from: client.domain
      if: ctx.client?.domain != null
  - set:
      field: "client.address"
      copy_from: client.ip
      if: ctx.client?.ip != null && ctx.client?.domain == null
  #  - set:
  #      field: "user.email"
  #      value: "{{{user.name}}}@{{{user.domain}}}"
  #      if: ctx.user?.name != null && ctx.user?.domain != null
  - script:
      description: Drops null/empty values recursively.
      lang: painless
      source: |
        boolean drop(Object o) {
          if (o == null || o == '') {
            return true;
          } else if (o instanceof Map) {
            ((Map) o).values().removeIf(v -> drop(v));
            return (((Map) o).size() == 0);
          } else if (o instanceof List) {
            ((List) o).removeIf(v -> drop(v));
            return (((List) o).length == 0);
          }
          return false;
        }
        drop(ctx);
  - remove:
      field:
        - _conf
        - _tmp
      ignore_failure: true
      ignore_missing: true
on_failure:
  - append:
      field: error.message
      value: "Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}"
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
