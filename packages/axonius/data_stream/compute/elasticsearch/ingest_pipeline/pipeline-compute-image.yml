---
description: Pipeline for processing compute image logs.
processors:
  - rename:
      field: json.event.data.architecture
      tag: rename_event_data_architecture
      target_field: axonius.compute.event.data.architecture
      ignore_missing: true
  - set:
      field: host.architecture
      tag: set_host_architecture_from_compute_event_data_architecture
      copy_from: axonius.compute.event.data.architecture
      ignore_empty_value: true
  - rename:
      field: json.event.data.aws_organization.arn
      tag: rename_event_data_aws_organization_arn
      target_field: axonius.compute.event.data.aws_organization.arn
      ignore_missing: true
  - rename:
      field: json.event.data.aws_organization.available_policy_types
      tag: rename_event_data_aws_organization_available_policy_types
      target_field: axonius.compute.event.data.aws_organization.available_policy_types
      ignore_missing: true
  - rename:
      field: json.event.data.aws_organization.feature_set
      tag: rename_event_data_aws_organization_feature_set
      target_field: axonius.compute.event.data.aws_organization.feature_set
      ignore_missing: true
  - rename:
      field: json.event.data.aws_organization.id
      tag: rename_event_data_aws_organization_id
      target_field: axonius.compute.event.data.aws_organization.id
      ignore_missing: true
  - set:
      field: cloud.account.id
      tag: set_cloud_account_id_from_compute_event_data_aws_organization_id
      copy_from: axonius.compute.event.data.aws_organization.id
      ignore_empty_value: true
  - rename:
      field: json.event.data.aws_organization.master_account_arn
      tag: rename_event_data_aws_organization_master_account_arn
      target_field: axonius.compute.event.data.aws_organization.master_account_arn
      ignore_missing: true
  - rename:
      field: json.event.data.aws_organization.master_account_email
      tag: rename_event_data_aws_organization_master_account_email
      target_field: axonius.compute.event.data.aws_organization.master_account_email
      ignore_missing: true
  - append:
      field: related.user
      tag: append_compute_event_data_aws_organization_master_account_email_into_related_user
      value: '{{{axonius.compute.event.data.aws_organization.master_account_email}}}'
      allow_duplicates: false
      if: ctx.axonius?.compute?.event?.data?.aws_organization?.master_account_email != null
  - rename:
      field: json.event.data.aws_organization.master_account_id
      tag: rename_event_data_aws_organization_master_account_id
      target_field: axonius.compute.event.data.aws_organization.master_account_id
      ignore_missing: true
  - rename:
      field: json.event.data.aws_region
      tag: rename_event_data_aws_region
      target_field: axonius.compute.event.data.aws_region
      ignore_missing: true
  - date:
      field: json.event.data.create_time
      tag: date_event_data_create_time
      target_field: axonius.compute.event.data.create_time
      formats:
        - EEE, dd MMM yyyy HH:mm:ss 'GMT'
        - yyyy-MM-dd
        - EEE,dd MMM yyyy HH:mm:ss 'GMT'
      if: ctx.json?.event?.data?.create_time != null && ctx.json.event.data.create_time != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.created
      tag: set_event_created_from_compute_event_data_create_time
      copy_from: axonius.compute.event.data.create_time
      ignore_empty_value: true
  - rename:
      field: json.event.data.description
      tag: rename_event_data_description
      target_field: axonius.compute.event.data.description
      ignore_missing: true
  - set:
      field: message
      tag: set_message_from_compute_event_data_description
      copy_from: axonius.compute.event.data.description
      ignore_empty_value: true
  - foreach:
      field: json.event.data.ebs_volumes
      tag: foreach_event_data_ebs_volumes_create_time
      if: ctx.json?.event?.data?.ebs_volumes instanceof List
      processor:
        date:
          field: _ingest._value.create_time
          tag: date_event_data_ebs_volumes_create_time
          target_field: _ingest._value.create_time
          formats:
            - EEE, dd MMM yyyy HH:mm:ss 'GMT'
            - yyyy-MM-dd
            - EEE,dd MMM yyyy HH:mm:ss 'GMT'
          on_failure:
            - remove:
                field: _ingest._value.create_time
                ignore_missing: true
  - foreach:
      field: json.event.data.ebs_volumes
      tag: foreach_event_data_ebs_volumes_size
      if: ctx.json?.event?.data?.ebs_volumes instanceof List
      processor:
        convert:
          field: _ingest._value.size
          tag: convert_event_data_ebs_volumes_size_to_double
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.size
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.event.data.ebs_volumes
      tag: rename_event_data_ebs_volumes
      target_field: axonius.compute.event.data.ebs_volumes
      ignore_missing: true
  - convert:
      field: json.event.data.encrypted
      tag: convert_event_data_encrypted_to_boolean
      target_field: axonius.compute.event.data.encrypted
      type: boolean
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: json.event.data.size
      tag: convert_event_data_size_to_double
      target_field: axonius.compute.event.data.size
      type: double
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: json.event.data.state
      tag: rename_event_data_state
      target_field: axonius.compute.event.data.state
      ignore_missing: true
  - rename:
      field: json.event.data.tags.tag_source
      tag: rename_event_data_tags_tag_source
      target_field: axonius.compute.event.data.tags.tag_source
      ignore_missing: true
on_failure:
  - append:
      field: error.message
      value: |-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}}failed with message '{{{ _ingest.on_failure_message }}}'
  - set:
      field: event.kind
      tag: set_pipeline_error_to_event_kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
