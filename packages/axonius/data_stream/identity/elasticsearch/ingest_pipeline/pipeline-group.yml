---
description: Pipeline for processing group logs.
processors:
  - date:
      field: json.event.data.first_seen
      tag: date_event_data_first_seen
      target_field: axonius.identity.event.data.first_seen
      formats:
        - EEE, dd MMM yyyy HH:mm:ss 'GMT'
        - yyyy-MM-dd
        - EEE,dd MMM yyyy HH:mm:ss 'GMT'
      if: ctx.json?.event?.data?.first_seen != null && ctx.json.event.data.first_seen != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: json.event.data.roles
      tag: foreach_event_data_roles_display_name
      if: ctx.json?.event?.data?.roles instanceof List
      processor:
        append:
          field: user.roles
          tag: append_event_data_roles_display_name_into_user_roles
          value: '{{{_ingest._value.display_name}}}'
          allow_duplicates: false
  - rename:
      field: json.event.data.roles
      tag: rename_event_data_roles
      target_field: axonius.identity.event.data.roles
      ignore_missing: true
  - foreach:
      field: json.event.data.user_count_link
      tag: foreach_event_data_user_count_link_bracketWeight
      if: ctx.json?.event?.data?.user_count_link instanceof List
      processor:
        convert:
          field: _ingest._value.bracketWeight
          tag: convert_event_data_user_count_link_bracketWeight_to_double
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.bracketWeight
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: json.event.data.user_count_link
      tag: foreach_event_data_user_count_link_leftBracket
      if: ctx.json?.event?.data?.user_count_link instanceof List
      processor:
        convert:
          field: _ingest._value.leftBracket
          tag: convert_event_data_user_count_link_leftBracket_to_double
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.leftBracket
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: json.event.data.user_count_link
      tag: foreach_event_data_user_count_link_not
      if: ctx.json?.event?.data?.user_count_link instanceof List
      processor:
        convert:
          field: _ingest._value.not
          tag: convert_event_data_user_count_link_not_to_boolean
          type: boolean
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.not
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: json.event.data.user_count_link
      tag: foreach_event_data_user_count_link_rightBracket
      if: ctx.json?.event?.data?.user_count_link instanceof List
      processor:
        convert:
          field: _ingest._value.rightBracket
          tag: convert_event_data_user_count_link_rightBracket_to_double
          type: double
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.rightBracket
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: json.event.data.user_count_link
      tag: foreach_event_data_user_count_link_value
      if: ctx.json?.event?.data?.user_count_link instanceof List
      processor:
        append:
          field: related.user
          tag: append_event_data_user_count_link_value_into_related_user
          value: '{{{_ingest._value.value}}}'
          allow_duplicates: false
  - rename:
      field: json.event.data.user_count_link
      tag: rename_event_data_user_count_link
      target_field: axonius.identity.event.data.user_count_link
      ignore_missing: true
  - foreach:
      field: axonius.identity.event.data.roles
      tag: foreach_axonius_identity_event_data_roles
      if: ctx.axonius?.identity?.event?.data?.roles instanceof List
      processor:
        remove:
          field: _ingest._value.display_name
          tag: remove_custom_duplicate_fields_from_axonius_identity_event_data_roles
          ignore_missing: true
          if: ctx.tags == null || !ctx.tags.contains('preserve_duplicate_custom_fields')
on_failure:
  - append:
      field: error.message
      value: |-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}}failed with message '{{{ _ingest.on_failure_message }}}'
  - set:
      field: event.kind
      tag: set_pipeline_error_to_event_kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
