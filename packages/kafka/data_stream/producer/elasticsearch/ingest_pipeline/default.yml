---
description: Pipeline for processing Kafka producer metrics
processors:
  - set:
      field: ecs.version
      value: '8.11.0'
  - rename:
      field: jolokia.metrics
      target_field: kafka.producer
      ignore_missing: true
      ignore_failure: true
  - set:
      field: event.kind
      value: metric
  - set:
      field: event.type
      value: [info]
  - set:
      field: service.type
      value: kafka
      
  - grok:
      field: "kafka.producer.mbean"
      patterns:
        - "client-id=(?<kafka_producer_client_id>[^,]+)"
      if: "ctx.kafka?.producer?.mbean != null"
      ignore_failure: true

  - grok:
      field: "kafka.producer.mbean"
      patterns:
        - "node-id=(?<kafka_producer_node_id>[^,]+)"
      if: "ctx.kafka?.producer?.mbean != null"
      ignore_failure: true

  - set:
      field: "kafka.producer.client_id"
      copy_from: "kafka_producer_client_id"
      if: "ctx.kafka_producer_client_id != null"
      ignore_failure: true

  - set:
      field: "kafka.producer.node_id"
      copy_from: "kafka_producer_node_id"
      if: "ctx.kafka_producer_node_id != null"
      ignore_failure: true

  # Add metric fingerprint list
  - script:
      lang: painless
      source: |
        def queue = new ArrayList();
        def fingerprint = new ArrayList();

        if (ctx.containsKey('kafka') && ctx.kafka.containsKey('producer')) {
            queue.add(['p': 'kafka.producer', 'v': ctx.kafka.producer]);

            while (!queue.isEmpty()) {
                def item = queue.remove(0);
                def path = item.p;
                def val = item.v;

                if (val instanceof Map) {
                    for (entry in val.entrySet()) {
                        def key = entry.getKey();
                        def child = entry.getValue();
                        def childPath = path + '.' + key;
                        queue.add(['p': childPath, 'v': child]);
                    }
                } else {
                    fingerprint.add(path);
                }
            }

            ctx.kafka_producer_metric_fingerprint = fingerprint;
        }

  - fingerprint:
      fields: [kafka_producer_metric_fingerprint]
      target_field: kafka.producer.metric_fingerprint
      ignore_failure: true

  # Cleanup
  - remove:
      field: kafka_producer_node_id
      ignore_missing: true
      
  - remove:
      field: kafka_producer_client_id
      ignore_missing: true
      
  - remove:
      field: kafka.producer.kafka_producer.last_applied_record_timestamp_epoch
      ignore_missing: true
  
  - remove:
      field: kafka_producer_metric_fingerprint
      ignore_missing: true

on_failure:
  - set:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}} with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}} failed with message '{{{ _ingest.on_failure_message }}}'
