---
description: Pipeline for processing Pi-hole summary statistics
processors:
  # Set event fields
  - set:
      field: event.kind
      value: metric
  - set:
      field: event.category
      value: ["network"]
  - set:
      field: event.type
      value: ["info"]
  - set:
      field: event.module
      value: pihole
  - set:
      field: event.dataset
      value: pihole.pihole_summary

  # Set observer fields
  - set:
      field: observer.vendor
      value: Pi-hole
  - set:
      field: observer.product
      value: Pi-hole
  - set:
      field: observer.type
      value: dns

  # Rename metric fields to pihole.summary namespace
  - rename:
      field: dns_queries_today
      target_field: pihole.summary.dns_queries_today
      ignore_missing: true
  - rename:
      field: ads_blocked_today
      target_field: pihole.summary.ads_blocked_today
      ignore_missing: true
  - rename:
      field: ads_percentage_today
      target_field: pihole.summary.ads_percentage_today
      ignore_missing: true
  - rename:
      field: domains_being_blocked
      target_field: pihole.summary.domains_being_blocked
      ignore_missing: true
  - rename:
      field: queries_forwarded
      target_field: pihole.summary.queries_forwarded
      ignore_missing: true
  - rename:
      field: queries_cached
      target_field: pihole.summary.queries_cached
      ignore_missing: true
  - rename:
      field: clients_ever_seen
      target_field: pihole.summary.clients_ever_seen
      ignore_missing: true
  - rename:
      field: unique_clients
      target_field: pihole.summary.unique_clients
      ignore_missing: true
  - rename:
      field: unique_domains
      target_field: pihole.summary.unique_domains
      ignore_missing: true
  - rename:
      field: status
      target_field: pihole.summary.status
      ignore_missing: true
  - rename:
      field: query_frequency
      target_field: pihole.summary.query_frequency
      ignore_missing: true
  - rename:
      field: gravity_last_update
      target_field: pihole.summary.gravity_last_update
      ignore_missing: true
  - rename:
      field: query_types_a
      target_field: pihole.summary.query_types.a
      ignore_missing: true
  - rename:
      field: query_types_aaaa
      target_field: pihole.summary.query_types.aaaa
      ignore_missing: true
  - rename:
      field: query_types_any
      target_field: pihole.summary.query_types.any
      ignore_missing: true
  - rename:
      field: query_types_srv
      target_field: pihole.summary.query_types.srv
      ignore_missing: true
  - rename:
      field: query_types_soa
      target_field: pihole.summary.query_types.soa
      ignore_missing: true
  - rename:
      field: query_types_ptr
      target_field: pihole.summary.query_types.ptr
      ignore_missing: true
  - rename:
      field: query_types_txt
      target_field: pihole.summary.query_types.txt
      ignore_missing: true
  - rename:
      field: query_types_naptr
      target_field: pihole.summary.query_types.naptr
      ignore_missing: true
  - rename:
      field: query_types_mx
      target_field: pihole.summary.query_types.mx
      ignore_missing: true
  - rename:
      field: query_types_ds
      target_field: pihole.summary.query_types.ds
      ignore_missing: true
  - rename:
      field: query_types_rrsig
      target_field: pihole.summary.query_types.rrsig
      ignore_missing: true
  - rename:
      field: query_types_dnskey
      target_field: pihole.summary.query_types.dnskey
      ignore_missing: true
  - rename:
      field: query_types_ns
      target_field: pihole.summary.query_types.ns
      ignore_missing: true
  - rename:
      field: query_types_svcb
      target_field: pihole.summary.query_types.svcb
      ignore_missing: true
  - rename:
      field: query_types_https
      target_field: pihole.summary.query_types.https
      ignore_missing: true
  - rename:
      field: query_types_other
      target_field: pihole.summary.query_types.other
      ignore_missing: true
  - rename:
      field: query_status_unknown
      target_field: pihole.summary.query_status.unknown
      ignore_missing: true
  - rename:
      field: query_status_gravity
      target_field: pihole.summary.query_status.gravity
      ignore_missing: true
  - rename:
      field: query_status_forwarded
      target_field: pihole.summary.query_status.forwarded
      ignore_missing: true
  - rename:
      field: query_status_cache
      target_field: pihole.summary.query_status.cache
      ignore_missing: true
  - rename:
      field: query_status_regex
      target_field: pihole.summary.query_status.regex
      ignore_missing: true
  - rename:
      field: query_status_denylist
      target_field: pihole.summary.query_status.denylist
      ignore_missing: true
  - rename:
      field: query_status_external_blocked_ip
      target_field: pihole.summary.query_status.external_blocked_ip
      ignore_missing: true
  - rename:
      field: query_status_external_blocked_null
      target_field: pihole.summary.query_status.external_blocked_null
      ignore_missing: true
  - rename:
      field: query_status_external_blocked_nxra
      target_field: pihole.summary.query_status.external_blocked_nxra
      ignore_missing: true
  - rename:
      field: query_status_gravity_cname
      target_field: pihole.summary.query_status.gravity_cname
      ignore_missing: true
  - rename:
      field: query_status_regex_cname
      target_field: pihole.summary.query_status.regex_cname
      ignore_missing: true
  - rename:
      field: query_status_denylist_cname
      target_field: pihole.summary.query_status.denylist_cname
      ignore_missing: true
  - rename:
      field: query_status_retried
      target_field: pihole.summary.query_status.retried
      ignore_missing: true
  - rename:
      field: query_status_retried_dnssec
      target_field: pihole.summary.query_status.retried_dnssec
      ignore_missing: true
  - rename:
      field: query_status_in_progress
      target_field: pihole.summary.query_status.in_progress
      ignore_missing: true
  - rename:
      field: query_status_dbbusy
      target_field: pihole.summary.query_status.dbbusy
      ignore_missing: true
  - rename:
      field: query_status_special_domain
      target_field: pihole.summary.query_status.special_domain
      ignore_missing: true
  - rename:
      field: query_status_cache_stale
      target_field: pihole.summary.query_status.cache_stale
      ignore_missing: true
  - rename:
      field: query_status_external_blocked_ede15
      target_field: pihole.summary.query_status.external_blocked_ede15
      ignore_missing: true
  - rename:
      field: query_replies_unknown
      target_field: pihole.summary.query_replies.unknown
      ignore_missing: true
  - rename:
      field: query_replies_nodata
      target_field: pihole.summary.query_replies.nodata
      ignore_missing: true
  - rename:
      field: query_replies_nxdomain
      target_field: pihole.summary.query_replies.nxdomain
      ignore_missing: true
  - rename:
      field: query_replies_cname
      target_field: pihole.summary.query_replies.cname
      ignore_missing: true
  - rename:
      field: query_replies_ip
      target_field: pihole.summary.query_replies.ip
      ignore_missing: true
  - rename:
      field: query_replies_domain
      target_field: pihole.summary.query_replies.domain
      ignore_missing: true
  - rename:
      field: query_replies_rrname
      target_field: pihole.summary.query_replies.rrname
      ignore_missing: true
  - rename:
      field: query_replies_servfail
      target_field: pihole.summary.query_replies.servfail
      ignore_missing: true
  - rename:
      field: query_replies_refused
      target_field: pihole.summary.query_replies.refused
      ignore_missing: true
  - rename:
      field: query_replies_notimp
      target_field: pihole.summary.query_replies.notimp
      ignore_missing: true
  - rename:
      field: query_replies_other
      target_field: pihole.summary.query_replies.other
      ignore_missing: true
  - rename:
      field: query_replies_dnssec
      target_field: pihole.summary.query_replies.dnssec
      ignore_missing: true
  - rename:
      field: query_replies_none
      target_field: pihole.summary.query_replies.none
      ignore_missing: true
  - rename:
      field: query_replies_blob
      target_field: pihole.summary.query_replies.blob
      ignore_missing: true

  # Remove any error fields if present (from successful requests)
  - remove:
      field: error
      ignore_missing: true

on_failure:
  - set:
      field: error.message
      value: "{{ _ingest.on_failure_message }}"
