---
description: Pipeline for processing Anti-Malware event logs
processors:
  - set:
      field: trendmicro.event.category
      value: "anti-malware"
  - set:
      field: event.category
      value: ["malware"]
  - set:
      field: event.type
      value: ["info"]
  - script:
      lang: painless
      params:
        extensions:
          # Rename field
          - name: deviceCustomNumber2
            to: file.size
          - name: deviceCustomNumber1
            to: host.id
          - name: deviceHostName
            to: host.hostname
          - name: deviceAddress
            to: host.ip
          - name: TrendMicroDsFileMD5
            to: file.hash.md5
          - name: TrendMicroDsFileSHA1
            to: file.hash.sha1
          - name: TrendMicroDsFileSHA256
            to: file.hash.sha256
          - name: TrendMicroDsRelevantDetectionNames
            to: trendmicro.event.probable_threat_type
          - name: TrendMicroDsMalwareTarget
            to: trendmicro.event.malware_target
          - name: TrendMicroDsMalwareTargetType
            to: trendmicro.event.malware_target_type
          - name: deviceCustomString6
            to: container.image.name
          - name: TrendMicroDsDetectionConfidence
            to: trendmicro.event.threat_probability
          - name: TrendMicroDsTags
            to: trendmicro.event.tags
          - name: TrendMicroDsTenantId
            to: trendmicro.event.tenant_id
          - name: TrendMicroDsTenant
            to: trendmicro.event.tenant_name
          - name: deviceCustomString5
            to: trendmicro.event.spyware_risklevel
            convert:
              "0": Very Low
              "25": Low
              "50": Medium
              "75": High
              "100": Very High
          - name: deviceCustomString4
            to: trendmicro.event.spyware_resourcetype
            convert:
              "10": Files and Directories
              "11": System Registry
              "12": Internet Cookies
              "13": Internet URL Shortcut
              "14": Programs in Memory
              "15": Program Startup Areas
              "16": Browser Helper Object
              "17": Layered Service Provider
              "18": Hosts File
              "19": Windows Policy Settings
              "20": Browser
              "23": Windows Shell Setting
              "24": IE Downloaded Program Files
              "25": Add/Remove Programs
              "26": Services
              "other": Other

      source: |
        def actions = new ArrayList();
        def exts = ctx.cef?.extensions;
        if (exts == null) return;
        for (entry in params.extensions) {
          def value = exts[entry.name];
          if (value == null ||
            (entry.convert != null &&
              (value=entry.convert[value.toLowerCase()]) == null))
            continue;
          if (entry.to != null) {
            actions.add([
              "value": value,
              "to": entry.to
            ]);
            continue;
          }
          def label = exts[entry.name + "Label"];
          if (label == null) continue;
          def dest = entry.labels[label.toLowerCase()];
          if (dest == null) continue;
          actions.add([
            "value": value,
            "to": dest
          ]);
        }
        ctx["_tmp_copy"] = actions;
  - foreach:
      field: _tmp_copy
      processor:
        set:
          field: "{{_ingest._value.to}}"
          value: "{{_ingest._value.value}}"

  - remove:
      field:
        - _tmp_copy

on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: '{{{ _ingest.on_failure_message }}}'
