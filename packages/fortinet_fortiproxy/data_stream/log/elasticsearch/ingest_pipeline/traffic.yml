---
description: Pipeline for processing traffic logs from Fortinet Fortiproxy.
processors:
# ------------------------------------------------------------------------------
# Convert fields.
  - convert:
      tag: convert_clientip
      field: _fields_.clientip
      type: ip
      ignore_missing: true
  - convert:
      tag: convert_countapp
      field: _fields_.countapp
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countav
      field: _fields_.countav
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countcasb
      field: _fields_.countcasb
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countcifs
      field: _fields_.countcifs
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countdlp
      field: _fields_.countdlp
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countdns
      field: _fields_.countdns
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countemail
      field: _fields_.countemail
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countff
      field: _fields_.countff
      type: long
      ignore_missing: true
  - convert:
      tag: convert_counticap
      field: _fields_.counticap
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countips
      field: _fields_.countips
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countsctpf
      field: _fields_.countsctpf
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countssh
      field: _fields_.countssh
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countssl
      field: _fields_.countssl
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countwaf
      field: _fields_.countwaf
      type: long
      ignore_missing: true
  - convert:
      tag: convert_countweb
      field: _fields_.countweb
      type: long
      ignore_missing: true
  - convert:
      tag: convert_dstreputation
      field: _fields_.dstreputation
      type: long
      ignore_missing: true
  - convert:
      tag: convert_dstserver
      field: _fields_.dstserver
      type: long
      ignore_missing: true
  - convert:
      tag: convert_lanin
      field: _fields_.lanin
      type: long
      ignore_missing: true
  - convert:
      tag: convert_lanout
      field: _fields_.lanout
      type: long
      ignore_missing: true
  - convert:
      tag: convert_prefetch
      field: _fields_.prefetch
      type: long
      ignore_missing: true
  - convert:
      tag: convert_rcvddelta
      field: _fields_.rcvddelta
      type: long
      ignore_missing: true
  - convert:
      tag: convert_reqlength
      field: _fields_.reqlength
      type: long
      ignore_missing: true
  - convert:
      tag: convert_reqtime
      field: _fields_.reqtime
      type: long
      ignore_missing: true
  - convert:
      tag: convert_respfinishtime
      field: _fields_.respfinishtime
      type: long
      ignore_missing: true
  - convert:
      tag: convert_resplength
      field: _fields_.resplength
      type: long
      ignore_missing: true
  - convert:
      tag: convert_resptime
      field: _fields_.resptime
      type: long
      ignore_missing: true
  - convert:
      tag: convert_sentdelta
      field: _fields_.sentdelta
      type: long
      ignore_missing: true
  - convert:
      tag: convert_sentpkt
      field: _fields_.sentpkt
      type: long
      ignore_missing: true
  - convert:
      tag: convert_srcreputation
      field: _fields_.srcreputation
      type: long
      ignore_missing: true
  - convert:
      tag: convert_srcserver
      field: _fields_.srcserver
      type: long
      ignore_missing: true
  - convert:
      tag: convert_statuscode
      field: _fields_.statuscode
      type: long
      ignore_missing: true
  - convert:
      tag: convert_tranip
      field: _fields_.tranip
      type: ip
      ignore_missing: true
  - convert:
      tag: convert_tranport
      field: _fields_.tranport
      type: long
      ignore_missing: true
  - convert:
      tag: convert_transip
      field: _fields_.transip
      type: ip
      ignore_missing: true
  - convert:
      tag: convert_transport
      field: _fields_.transport
      type: long
      ignore_missing: true

# ------------------------------------------------------------------------------
# Format fields.

  - gsub:
      tag: convert_dstmac
      field: _fields_.dstmac
      pattern: ':'
      replacement: '-'
      ignore_missing: true
  - uppercase:
      tag: uppercase_dstmac
      field: _fields_.dstmac
      ignore_missing: true
  - gsub:
      tag: convert_srcmac
      field: _fields_.srcmac
      pattern: ':'
      replacement: '-'
      ignore_missing: true
  - uppercase:
      tag: uppercase_srcmac
      field: _fields_.srcmac
      ignore_missing: true

# ------------------------------------------------------------------------------
# Move fields to ECS.
  - rename:
      tag: rename_dstmac
      field: _fields_.dstmac
      target_field: destination.mac
      ignore_missing: true
  - rename:
      tag: rename_dstname
      field: _fields_.dstname
      target_field: destination.address
      ignore_missing: true
  - rename:
      tag: rename_policyname
      field: _fields_.policyname
      target_field: rule.name
      ignore_missing: true
  - rename:
      tag: rename_reqlength
      field: _fields_.reqlength
      target_field: http.request.bytes
      ignore_missing: true
  - rename:
      tag: rename_resplength
      field: _fields_.resplength
      target_field: http.response.bytes
      ignore_missing: true
  - rename:
      tag: rename_scheme
      field: _fields_.scheme
      target_field: url.scheme
      ignore_missing: true
  - rename:
      tag: rename_sentpkt
      field: _fields_.sentpkt
      target_field: source.packets
      ignore_missing: true
  - rename:
      tag: rename_srcthreatfeed
      field: _fields_.srcthreatfeed
      target_field: threat.feed.name
      ignore_missing: true
  - rename:
      tag: rename_statuscode
      field: _fields_.statuscode
      target_field: http.response.status_code
      ignore_missing: true
  - rename:
      tag: rename_tranip
      field: _fields_.tranip
      target_field: destination.nat.ip
      ignore_missing: true
  - rename:
      tag: rename_tranport
      field: _fields_.tranport
      target_field: destination.nat.port
      ignore_missing: true
  - rename:
      tag: rename_transip
      field: _fields_.transip
      target_field: source.nat.ip
      ignore_missing: true
  - rename:
      tag: rename_transport
      field: _fields_.transport
      target_field: source.nat.port
      ignore_missing: true

on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      value: pipeline_error
