# Service Info

The Fortinet FortiProxy integration allows for the seamless ingestion of logs from FortiProxy secure web gateway devices into the Elastic Stack for real-time monitoring, security analysis, and traffic visibility.

## Common use cases

The Fortinet FortiProxy integration allows organizations to centralize and analyze high-performance secure web gateway data within the Elastic Stack for enhanced visibility and threat detection.
- **Secure Web Gateway Monitoring:** Gain deep visibility into how the proxy protects users from online threats through advanced URL filtering and SSL inspection.
- **Web Traffic Analysis:** Monitor user behavior, application usage, and bandwidth consumption across the network to identify anomalies or policy violations.
- **Data Loss Prevention (DLP):** Track and alert on sensitive data leakage prevention events to maintain regulatory compliance and protect intellectual property.
- **Security Event Detection:** Investigate intrusion attempts, malware activity, and enforced web application policies using pre-built dashboards and security analytics.

## Data types collected

This integration can collect the following types of data from Fortinet FortiProxy devices:

*   **Traffic logs:** Network traffic information including source/destination IP addresses, ports, protocols, bytes transferred, and session duration.
*   **HTTP transaction logs:** Detailed HTTP/HTTPS request and response data including full URLs, methods, status codes, browser user agents, and timing details.
*   **UTM (Unified Threat Management) logs:** Security-related logs generated by antivirus, web filtering, application control, DLP, and SSL/SSH inspection modules.
*   **Event logs:** System-level data including administrative logins, configuration changes, user authentication events, and system performance metrics.
*   **Security Rating logs:** Security posture assessment results, including audit scores and compliance metrics generated by the FortiProxy security fabric.
*   **Fortinet FortiProxy logs (tcp):** Collect Fortinet FortiProxy logs using the tcp input for reliable, connection-oriented log delivery.
*   **Fortinet FortiProxy logs (udp):** Collect Fortinet FortiProxy logs using the udp input for high-performance, low-overhead transmission.
*   **Fortinet FortiProxy logs (filestream):** Collect Fortinet FortiProxy logs using filestream input to read local log files from a specific path.

## Compatibility

The **Fortinet FortiProxy** integration has been specifically tested and validated against the following versions:

*   **FortiProxy versions 7.x up to 7.4.3**
*   Newer versions of FortiProxy are expected to function correctly as they typically maintain backward compatibility with the default syslog format.

## Scaling and Performance

To ensure optimal performance in high-volume environments, consider the following:
- **Transport/Collection Considerations:** For high-reliability requirements, use TCP transport (mode `reliable`) to ensure no log loss during network congestion. When using TCP, ensure the `rfc6587` framing is enabled in the configuration to handle message boundaries correctly. For high-performance environments where low overhead is prioritized, UDP transport is recommended, though it does not guarantee delivery.
- **Data Volume Management:** Configure the FortiProxy appliance to forward only necessary events to reduce the load on the ingest pipeline. Use the FortiProxy CLI command `config log syslogd filter` to exclude low-priority traffic logs or limit logging to specific severity levels (e.g., `warning` and above). This minimizes the processing overhead on both the FortiProxy device and the Elastic Agent.
- **Elastic Agent Scaling:** For high-throughput environments with thousands of concurrent web sessions, deploy multiple Elastic Agents behind a network load balancer to distribute traffic evenly. Place Agents geographically close to the data source to minimize latency. Ensure the host machine has sufficient CPU and memory resources to handle the parsing of complex UTM logs.

# Set Up Instructions

## Vendor prerequisites

*   **Administrative Access:** Root or super-admin level access to the FortiProxy CLI or web-based GUI is required to modify logging configurations.
*   **Network Connectivity:** The FortiProxy device must have an unobstructed network path to the Elastic Agent host. Ensure that intermediate firewalls allow traffic on the configured port (default is `514`).
*   **Log Format Requirement:** The FortiProxy must be configured to use the `default` log format. Custom formats or CSV formats are not supported by this integration's parsing logic.
*   **Feature Licensing:** Ensure that logging features and the Security Fabric (if using Security Rating logs) are enabled within the FortiProxy license.

## Elastic prerequisites

*   **Elastic Agent Installation:** The Elastic Agent must be installed and enrolled in Fleet on a host that is network-accessible to the FortiProxy.
*   **Elastic Stack Version:** Use Kibana and Elasticsearch version 8.0 or higher for full compatibility with integration data streams.
*   **Agent Policy:** The Agent must be assigned to a policy that includes the Fortinet FortiProxy integration.
*   **Connectivity:** The host running the Elastic Agent must be listening on the specified port (e.g., `514`) and must not have local firewall rules (like iptables or Windows Firewall) blocking incoming syslog traffic.

## Vendor set up steps

### For Syslog Collection (CLI Method - Recommended):

1.  Log in to the FortiProxy CLI via SSH or a console connection.
2.  Enter the syslog configuration context by typing: `config log syslogd setting`.
3.  Enable the syslog status and point it to your Elastic Agent's IP address:
    ```bash
    set status enable
    set server <Elastic_Agent_IP>
    set port 514
    ```
4.  Define the transport mode. Use `set mode udp` for standard delivery or `set mode reliable` for TCP delivery.
5.  Ensure the format is compatible with the integration by typing: `set format default`.
6.  Save the configuration and exit the context by typing `end`.
7.  (Optional) Configure which logs are sent by navigating to `config log syslogd filter` to set specific severity levels or event types.

### For Syslog Collection (GUI Method):

1.  Log in to the FortiProxy web administration interface.
2.  Navigate to **Log & Report** > **Log Settings**.
3.  Locate the **Remote Logging and Archiving** section and toggle **Send Logs to Syslog** to the enabled position.
4.  Enter the **IP Address/FQDN** of the host where the Elastic Agent is running.
5.  Set the **Port** to `514` (or your chosen custom port).
6.  Verify that **CSV Format** is **disabled** to ensure logs are sent in the required key-value format.
7.  Click **Apply** at the bottom of the page to commit the changes.
8.  Navigate to the different log type sections (Traffic, UTM, Event) in the GUI to ensure "Local Log" or "Syslog" is enabled for the specific events you wish to monitor.

### Vendor Set up Resources

*   [FortiProxy Administration Guide (Product Library)](https://docs.fortinet.com/product/fortiproxy/7.6) - Comprehensive documentation for FortiProxy management and logging.
*   [FortiProxy Administration Guide | Log settings](https://docs.fortinet.com/document/fortiproxy/7.6.4/administration-guide/250999/log-settings)

## Kibana set up steps

### Collecting logs from Fortinet FortiProxy instances via tcp input.
1. In Kibana, navigate to **Integrations** > **Fortinet FortiProxy**.
2. Click **Add Fortinet FortiProxy**.
3. Select the **Collect Fortinet FortiProxy logs via TCP input** input type.
4. Configure the following variables:
   - **Listen Address** (`syslog_host`): The bind address to listen for TCP connections. Set to `0.0.0.0` to bind to all available interfaces. Default: `localhost`.
   - **Listen Port** (`syslog_port`): The TCP port number to listen on. Default: `514`.
   - **Preserve original event** (`preserve_original_event`): If enabled, preserves a raw copy of the original event in the `event.original` field. Default: `False`.
   - **Tags** (`tags`): Custom tags to append to the events (e.g., `['fortinet-fortiproxy', 'forwarded']`).
   - **Processors** (`processors`): Add any custom processors to reduce fields or enhance metadata before the logs reach the ingest pipeline.
   - **SSL Configuration** (`ssl`): Configure SSL options such as `certificate` and `key` if using encrypted transport.
   - **Custom TCP Options** (`tcp_options`): Specify custom options such as `framing: rfc6587`. **Note:** This is required if using `mode reliable` on the FortiProxy device.
5. Save and deploy the integration to an Elastic Agent policy.

### Collecting logs from Fortinet FortiProxy instances via udp input.
1. In Kibana, navigate to **Integrations** > **Fortinet FortiProxy**.
2. Click **Add Fortinet FortiProxy**.
3. Select the **Collect Fortinet FortiProxy logs via UDP input** input type.
4. Configure the following variables:
   - **Listen Address** (`syslog_host`): The bind address to listen for UDP connections. Set to `0.0.0.0` to bind to all available interfaces. Default: `localhost`.
   - **Listen Port** (`syslog_port`): The UDP port number to listen on. Default: `514`.
   - **Preserve original event** (`preserve_original_event`): Preserves a raw copy of the original event in the `event.original` field. Default: `False`.
   - **Tags** (`tags`): Custom tags to append to the events. Default: `['fortinet-fortiproxy', 'forwarded']`.
   - **Custom UDP Options** (`udp_options`): Configure options such as `read_buffer` (e.g., `100MiB`), `max_message_size` (e.g., `50KiB`), and `timeout` (e.g., `300s`).
   - **Processors** (`processors`): Add processors to filter or enhance data at the agent level.
5. Save and deploy the integration.

### Collecting logs from Fortinet FortiProxy instances via filestream input.
1. In Kibana, navigate to **Integrations** > **Fortinet FortiProxy**.
2. Click **Add Fortinet FortiProxy**.
3. Select the **Collect Fortinet FortiProxy logs via Filestream input** input type.
4. Configure the following variables:
   - **Paths** (`paths`): List of absolute paths to the log files. Default: `['/var/log/fortinet-fortiproxy.log']`.
   - **Preserve original event** (`preserve_original_event`): Preserves a raw copy of the original event in the `event.original` field. Default: `False`.
   - **Tags** (`tags`): Custom tags to append to the events. Default: `['fortinet-fortiproxy', 'forwarded']`.
   - **Processors** (`processors`): Add processors for pre-parsing logic.
5. Save and deploy the integration.

# Validation Steps

After configuration is complete, verify that data is flowing correctly.

### 1. Trigger Data Flow on Fortinet FortiProxy:

*   **Generate web traffic:** From a client computer protected by the FortiProxy, browse to several different websites to generate traffic and HTTP transaction logs.
*   **Trigger security event:** Attempt to access a known blocked URL category or test a non-malicious "EICAR" test file to trigger UTM antivirus or web filtering logs.
*   **Generate administrative event:** Log out and log back into the FortiProxy management GUI or CLI to create an audit/system event log.

### 2. Check Data in Kibana:

1.  Navigate to **Analytics > Discover**.
2.  Select the `logs-*` data view.
3.  Enter the KQL filter: `data_stream.dataset : "fortinet_fortiproxy.log"`
4.  Verify logs appear. Expand a log entry and confirm these fields:
    *   `event.dataset` (should match `fortinet_fortiproxy.log`)
    *   `source.ip` and/or `destination.ip`
    *   `event.action` or `event.outcome`
    *   `message` (the raw log payload)
5.  Navigate to **Analytics > Dashboards** and search for "Fortinet FortiProxy" to view pre-built visualizations.

# Troubleshooting

## Common Configuration Issues

*   **TCP Framing Mismatch**: If you are using TCP transport and seeing parsing errors or merged log entries, verify that `mode reliable` is set on the FortiProxy and `framing: rfc6587` is explicitly set in the Elastic Agent's **Custom TCP Options**.
*   **Network Port Conflicts**: If the Agent fails to start the input, check if another service (like a local rsyslog daemon) is already bound to port `514`. Use `netstat -tulpn` on Linux to identify port conflicts.
*   **Firewall Obstruction**: If no logs arrive, ensure the FortiProxy device can reach the Elastic Agent host. Perform a packet capture (e.g., `tcpdump port 514`) on the Agent host to see if packets are arriving at the network interface.
*   **Log Format Incorrect**: If logs arrive but do not parse, ensure the FortiProxy is using `set format default`. If it is set to CSV or a custom format, the ingest pipeline will fail to extract fields.

## Ingestion Errors

- **Parsing Failures**: Check the `error.message` field in Kibana. If present, compare the `event.original` raw log against the expected key-value syslog format. Updates to FortiProxy firmware may occasionally introduce new fields.
- **Log Truncation**: If very large log messages (like detailed SSL inspection logs) are appearing cut off, increase the `max_message_size` in the **Custom TCP Options** or **Custom UDP Options** in the Kibana integration settings.
- **Missing Original Event**: If you cannot see the raw log for troubleshooting, ensure the **Preserve original event** checkbox is enabled in the integration configuration.


# Documentation sites

*   [Fortinet FortiProxy Documentation Library](https://docs.fortinet.com/product/fortiproxy/7.6)
*   [FortiProxy Log Message Reference](https://docs.fortinet.com/document/fortiproxy/7.6.0/log-message-reference/524940/introduction)