---
description: Pipeline for Office 365 Audit logs
processors:
  - remove:
      field:
        - organization
        - division
        - team
      ignore_missing: true
      if: ctx.organization instanceof String && ctx.division instanceof String && ctx.team instanceof String
      tag: remove_agentless_tags
      description: >-
        Removes the fields added by Agentless as metadata,
        as they can collide with ECS fields.
  - rename:
      field: message
      target_field: event.original
      if: ctx.event?.original == null
      ignore_missing: true
  - remove:
      field: message
      ignore_missing: true
      if: 'ctx.event?.original != null'
      description: 'The `message` field is no longer required if the document has an `event.original` field.'
  - script:
      tag: set_event_original
      if: ctx.event?.original == null
      source: |-
        ctx.event = ctx.event ?: [:];
        ctx.event.original = Json.dump(ctx.o365audit)
  - set:
      field: ecs.version
      value: '8.11.0'
  - set:
      field: event.kind
      value: event
  - append:
      field: event.type
      value: info
  - append:
      field: event.category
      value: web
  - fingerprint:
      fields:
        - o365audit.Id
      target_field: "_id"
      ignore_missing: true

  # Miscellaneous

  - set:
      field: file.extension
      copy_from: o365audit.FileExtension
      ignore_empty_value: true

  - set:
      field: file.hash.sha1
      copy_from: o365audit.Sha1
      ignore_empty_value: true
  - set:
      field: file.hash.sha256
      copy_from: o365audit.Sha256
      ignore_empty_value: true

  - set:
      field: file.path
      copy_from: o365audit.FilePath
      ignore_empty_value: true
  - set:
      field: file.path
      copy_from: o365audit.TargetFilePath
      ignore_empty_value: true
      override: false

  - set:
      field: file.size
      copy_from: o365audit.FileSizeBytes
      ignore_empty_value: true
  - set:
      field: file.size
      copy_from: o365audit.FileSize
      ignore_empty_value: true
      override: false
  - script:
      tag: convert_file_size_to_long
      if: ctx.file?.size != null
      source: |-
        if (ctx.file.size instanceof long || ctx.file.size instanceof int) {
          return;
        }
        if (ctx.file.size instanceof double) {
          ctx.file.size = (long) ctx.file.size;
          return;
        }
        try {
          // Attempt to parse as long to prevent inexact integer conversion.
          ctx.file.size = Long.parseLong(ctx.file.size);
        }
        catch (NumberFormatException e) {
          // But fall back to float parsing for cases where we failed.
          ctx.file.size = (long) Double.parseDouble(ctx.file.size);
        }
      on_failure:
        - remove:
            field: file.size
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  - set:
      field: process.name
      copy_from: o365audit.Application
      ignore_empty_value: true

  - set:
      field: url.domain
      copy_from: o365audit.OriginatingDomain
      ignore_empty_value: true

  # General Schema
  - date:
      field: o365audit.CreationTime
      formats:
        - ISO8601
      if: ctx.o365audit?.CreationTime != null
  - rename:
      field: o365audit.Id
      target_field: event.id
      ignore_missing: true
  - convert:
      field: o365audit.ListBaseType
      type: string
      tag: convert-listbasetype-to-string
      if: ctx.o365audit?.ListBaseType != null
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  - rename:
      field: o365audit.ClientIPAddress
      target_field: client._temp
      ignore_missing: true
  - rename:
      field: o365audit.ClientIP
      target_field: client._temp
      ignore_missing: true
      if: ctx.client?._temp == null
  - rename:
      field: o365audit.ActorIpAddress
      target_field: client._temp
      ignore_missing: true
      if: ctx.client?._temp == null
  - convert:
      field: o365audit.UserId
      target_field: user.id
      type: string
      ignore_missing: true
  - rename:
      field: o365audit.Workload
      target_field: event.provider
      ignore_missing: true
  - rename:
      field: o365audit.Operation
      target_field: event.action
      ignore_missing: true
  - rename:
      field: o365audit.OrganizationId
      target_field: organization.id
      ignore_missing: true
      tag: rename_organization_id
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  - json:
      tag: json-extract-stringly-AdditionalInfo
      field: o365audit.AdditionalInfo
      if: ctx.o365audit?.AdditionalInfo instanceof String
      on_failure:
        - remove:
            field: o365audit.AdditionalInfo
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - json:
      tag: json-extract-stringly-OperationProperties
      field: o365audit.OperationProperties
      if: ctx.o365audit?.OperationProperties instanceof String
      on_failure:
        - remove:
            field: o365audit.OperationProperties
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  - rename:
      field: o365audit.UserAgent
      target_field: user_agent.original
      ignore_missing: true
  - script:
      if: ctx.o365audit?.RecordType != null
      lang: painless
      params:
        "1": "ExchangeAdmin"
        "2": "ExchangeItem"
        "3": "ExchangeItemGroup"
        "4": "SharePoint"
        "6": "SharePointFileOperation"
        "7": "OneDrive"
        "8": "AzureActiveDirectory"
        "9": "AzureActiveDirectoryAccountLogon"
        "10": "DataCenterSecurityCmdlet"
        "11": "ComplianceDLPSharePoint"
        "12": "Sway"
        "13": "ComplianceDLPExchange"
        "14": "SharePointSharingOperation"
        "15": "AzureActiveDirectoryStsLogon"
        "16": "SkypeForBusinessPSTNUsage"
        "17": "SkypeForBusinessUsersBlocked"
        "18": "SecurityComplianceCenterEOPCmdlet"
        "19": "ExchangeAggregatedOperation"
        "20": "PowerBIAudit"
        "21": "CRM"
        "22": "Yammer"
        "23": "SkypeForBusinessCmdlets"
        "24": "Discovery"
        "25": "MicrosoftTeams"
        "28": "ThreatIntelligence"
        "29": "MailSubmission"
        "30": "MicrosoftFlow"
        "31": "AeD"
        "32": "MicrosoftStream"
        "33": "ComplianceDLPSharePointClassification"
        "34": "ThreatFinder"
        "35": "Project"
        "36": "SharePointListOperation"
        "37": "SharePointCommentOperation"
        "38": "DataGovernance"
        "39": "Kaizala"
        "40": "SecurityComplianceAlerts"
        "41": "ThreatIntelligenceUrl"
        "42": "SecurityComplianceInsights"
        "43": "MIPLabel"
        "44": "WorkplaceAnalytics"
        "45": "PowerAppsApp"
        "46": "PowerAppsPlan"
        "47": "ThreatIntelligenceAtpContent"
        "48": "LabelContentExplorer"
        "49": "TeamsHealthcare"
        "50": "ExchangeItemAggregated"
        "51": "HygieneEvent"
        "52": "DataInsightsRestApiAudit"
        "53": "InformationBarrierPolicyApplication"
        "54": "SharePointListItemOperation"
        "55": "SharePointContentTypeOperation"
        "56": "SharePointFieldOperation"
        "57": "MicrosoftTeamsAdmin"
        "58": "HRSignal"
        "59": "MicrosoftTeamsDevice"
        "60": "MicrosoftTeamsAnalytics"
        "61": "InformationWorkerProtection"
        "62": "Campaign"
        "63": "DLPEndpoint"
        "64": "AirInvestigation"
        "65": "Quarantine"
        "66": "MicrosoftForms"
        "67": "ApplicationAudit"
        "68": "ComplianceSupervisionExchange"
        "69": "CustomerKeyServiceEncryption"
        "70": "OfficeNative"
        "71": "MipAutoLabelSharePointItem"
        "72": "MipAutoLabelSharePointPolicyLocation"
        "73": "MicrosoftTeamsShifts"
        "75": "MipAutoLabelExchangeItem"
        "76": "CortanaBriefing"
        "78": "WDATPAlerts"
        "82": "SensitivityLabelPolicyMatch"
        "83": "SensitivityLabelAction"
        "84": "SensitivityLabeledFileAction"
        "85": "AttackSim"
        "86": "AirManualInvestigation"
        "87": "SecurityComplianceRBAC"
        "88": "UserTraining"
        "89": "AirAdminActionInvestigation"
        "90": "MSTIC"
        "91": "PhysicalBadgingSignal"
        "93": "AipDiscover"
        "94": "AipSensitivityLabelAction"
        "95": "AipProtectionAction"
        "96": "AipFileDeleted"
        "97": "AipHeartBeat"
        "98": "MCASAlerts"
        "99": "OnPremisesFileShareScannerDlp"
        "100": "OnPremisesSharePointScannerDlp"
        "101": "ExchangeSearch"
        "102": "SharePointSearch"
        "103": "PrivacyInsights"
        "105": "MyAnalyticsSettings"
        "106": "SecurityComplianceUserChange"
        "107": "ComplianceDLPExchangeClassification"
        "109": "MipExactDataMatch"
        "113": "MS365DCustomDetection"
        "147": "CoreReportingSettings"
        "148": "ComplianceConnector"
        "174": "DataShareOperation"
        "181": "EduDataLakeDownloadOperation"
      source: >
        def schemaId = ctx.o365audit.RecordType.toString();
        def schema = params[schemaId];
        if (schema != null) {
          if (ctx.event == null) {
            ctx.event = new HashMap();
          }
          ctx.event.code = schema;
        }
  - set: 
      field: event.outcome
      value: success
      if: 'ctx.o365audit?.ResultStatus != null && ["succeeded", "success", "partiallysucceeded", "true"].contains(ctx.o365audit?.ResultStatus.toLowerCase())'
  - set: 
      field: event.outcome
      value: failure
      if: 'ctx.o365audit?.ResultStatus != null && ["failed", "false"].contains(ctx.o365audit?.ResultStatus.toLowerCase())'
  - set: 
      field: event.outcome
      value: success
      if: ctx.event?.outcome == null
  - script:
      lang: painless
      if: 'ctx.o365audit?.Parameters != null && ctx.o365audit?.Parameters instanceof List'
      source: >
        def newparams = new HashMap(); 
        def oldparams = ctx.o365audit.Parameters;
        for (int i = 0; i < oldparams.length; ++i) {
          if (oldparams[i]["Value"] != null) {
            newparams[oldparams[i]["Name"]] = oldparams[i]["Value"];
          }
        }
        ctx.o365audit.Parameters = newparams;
  - rename:
      field: o365audit.Parameters
      target_field: o365audit.Parameters._raw
      if: 'ctx.o365audit?.Parameters != null && ctx.o365audit?.Parameters instanceof String'
  - grok:
      field: o365audit.Parameters._raw
      if: ctx.o365audit?.NetworkMessageId == null || ctx.o365audit.NetworkMessageId == ''
      patterns: 
        - '^-?Identity\s"?%{DATA:o365audit.NetworkMessageId}"?$'
      ignore_missing: true
      ignore_failure: true

  - script:
      lang: painless
      tag: collect_email_to_addresses_from_parameters
      source: >
        void splitTrimAdd(Set acc, String str) {
            if (str != null && str != '') {
                String[] parts = str.splitOnToken(';');
                for (int i = 0; i < parts.length; i++) {
                    acc.add(parts[i].trim());
                }
            }
        }

        def addressSet = new HashSet(ctx.email?.to?.address ?: []);

        splitTrimAdd(addressSet, ctx.o365audit?.Parameters?.ForwardAsAttachmentTo);
        splitTrimAdd(addressSet, ctx.o365audit?.Parameters?.ForwardTo);
        splitTrimAdd(addressSet, ctx.o365audit?.Parameters?.RedirectTo);

        if (!addressSet.isEmpty()) {
          ctx.email = ctx.email ?: [:];
          ctx.email.to = ctx.email.to ?: [:];
          ctx.email.to.address = addressSet.asList();
        }

  - set:
      field: email.from.address
      copy_from: o365audit.Parameters.From
      ignore_empty_value: true

  - script:
      if: ctx.o365audit?.Platform != null
      lang: painless
      params:
        # Based on `Aip*.md` files in
        # https://github.com/MicrosoftDocs/office-365-management-api/tree/20763d/office-365-management-api
        "0": "Unknown"
        "1": "Windows"
        "2": "MacOS"
        "3": "iOS"
        "4": "Android"
        "5": "Web Browser"
      source: >
        def value = ctx.o365audit.Platform.toString();
        def name = params[value];
        if (name != null) {
          ctx.o365audit.Platform = name;
        }
  - script:
      lang: painless
      if: 'ctx.o365audit?.ExtendedProperties != null && ctx.o365audit?.ExtendedProperties instanceof List'
      source: >
        def newparams = new HashMap(); 
        def oldparams = ctx.o365audit.ExtendedProperties;
        for (int i = 0; i < oldparams.length; ++i) {
          if (oldparams[i]["Value"] != null) {
            newparams[oldparams[i]["Name"]] = oldparams[i]["Value"];
          }
        }
        ctx.o365audit.ExtendedProperties = newparams;
  - rename:
      field: o365audit.ExtendedProperties
      target_field: o365audit.ExtendedProperties._raw
      if: 'ctx.o365audit?.ExtendedProperties != null && ctx.o365audit?.ExtendedProperties instanceof String'
  - script:
      lang: painless
      if: 'ctx.o365audit?.ModifiedProperties != null && ctx.o365audit?.ModifiedProperties instanceof List'
      source: >
        def newparams = new HashMap(); 
        def oldparams = ctx.o365audit.ModifiedProperties;
        for (int i = 0; i < oldparams.length; ++i) {
          if (oldparams[i] instanceof Map && oldparams[i]["OldValue"] != null && oldparams[i]["NewValue"] != null) {
            def validname = oldparams[i]["Name"].replace(" ","_").replace(".","_");
            newparams[validname] = new HashMap();
            newparams[validname]["NewValue"] = oldparams[i]["NewValue"];
            newparams[validname]["OldValue"] = oldparams[i]["OldValue"];
          }
          if (oldparams[i] instanceof String) {
            def validname = oldparams[i].replace(" ","_").replace(".","_");
            newparams[validname] = new HashMap();
          }
        }
        if (newparams.isEmpty()) {
          ctx.o365audit.remove("ModifiedProperties");
          return;
        }
        ctx.o365audit.ModifiedProperties = newparams;

  - rename:
      field: o365audit.ModifiedProperties
      target_field: o365audit.ModifiedProperties._raw
      if: 'ctx.o365audit?.ModifiedProperties != null && ctx.o365audit?.ModifiedProperties instanceof String'
  - script:
      lang: painless
      if: 'ctx.o365audit?.AlertLinks != null && ctx.o365audit?.AlertLinks instanceof List'
      source: >
        def list = ctx.o365audit.AlertLinks;
        def links = new ArrayList();
        for (int i = 0; i < list.length; ++i) {
          if (list[i] instanceof Map && list[i].containsKey("AlertLinkHref") && list[i]["AlertLinkHref"] != null && list[i]["AlertLinkHref"] instanceof String) {
            links.add(list[i]["AlertLinkHref"]);
          }
        }
        if (links.length == 0) {
          ctx.o365audit.remove("AlertLinks");
          return;
        }
        ctx.o365audit.AlertLinks = links;
  - set: 
      field: event.severity
      value: 1
      if: ctx.o365audit?.Severity == "informational"
  - set: 
      field: event.severity
      value: 2
      if: ctx.o365audit?.Severity == "low"
  - set: 
      field: event.severity
      value: 3
      if: ctx.o365audit?.Severity == "medium"
  - set: 
      field: event.severity
      value: 4
      if: ctx.o365audit?.Severity == "high"
  # ExchangeAdmin Schema
  - rename:
      field: o365audit.OrganizationName
      target_field: organization.name
      ignore_missing: true
      if: ctx.event?.code == "ExchangeAdmin"
      tag: rename_organization_name
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: o365audit.OriginatingServer
      target_field: server._temp
      ignore_missing: true
      if: ctx.event?.code == "ExchangeAdmin"
  # ExchangeItem Schema
  - rename:
      field: o365audit.MailboxOwnerUPN
      target_field: user.email
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  - convert:
      field: o365audit.LogonUserSid
      target_field: user.id
      type: string
      ignore_missing: true
      if: 'ctx.user?.id == null && ctx.o365audit?.LogonUserSid != null && ctx.event?.code == "ExchangeItem"'
  - rename:
      field: o365audit.LogonUserDisplayName
      target_field: user.full_name
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  - rename:
      field: o365audit.OrganizationName
      target_field: organization.name
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
      tag: rename_organization_name_exchange_item
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      field: o365audit.OriginatingServer
      target_field: server._temp
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  - rename:
      field: o365audit.ClientIPAddress
      target_field: client._temp
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  - rename:
      field: o365audit.ClientProcessName
      target_field: process.name
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  # AzureActiveDirectory Schema
  - set: 
      field: user.target.id
      copy_from: o365audit.ObjectId
      if: ctx.event?.code == "AzureActiveDirectory"
  ## AzureActiveDirectory Schema new user
  - set: 
      field: event.action
      value: added-user-account
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "Add user."'
  - append: 
      field: event.category
      value: iam
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "added-user-account"'
  - append: 
      field: event.type
      value: user
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "added-user-account"'
  - append: 
      field: event.type
      value: creation
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "added-user-account"'
  ## AzureActiveDirectory Schema update user
  - set: 
      field: event.action
      value: modified-user-account
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "Update user."'
  - append: 
      field: event.category
      value: iam
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "modified-user-account"'
  - append: 
      field: event.type
      value: user
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "modified-user-account"'
  - append: 
      field: event.type
      value: change
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "modified-user-account"'
  ## AzureActiveDirectory Schema delete user
  - set: 
      field: event.action
      value: deleted-user-account
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "Delete user."'
  - append: 
      field: event.category
      value: iam
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "deleted-user-account"'
  - append: 
      field: event.type
      value: user
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "deleted-user-account"'
  - append: 
      field: event.type
      value: deletion
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "deleted-user-account"'
  # AzureActiveDirectoryStsLogon Schema
  - append: 
      field: event.category
      value: authentication
      if: ctx.event?.code == "AzureActiveDirectoryStsLogon"
  - append: 
      field: event.type
      value: start
      if: ctx.event?.code == "AzureActiveDirectoryStsLogon"
  - append: 
      field: event.type
      value: access
      if: 'ctx.event?.code == "AzureActiveDirectoryStsLogon"'
  # SharePointFileOperation and SharePointSharingOperation Schemas
  - rename:
      field: o365audit.ObjectId
      target_field: url.original
      ignore_missing: true
      if: ctx.event?.code != null && ["SharePointFileOperation", "SharePointSharingOperation"].contains(ctx.event.code)
  - rename:
      field: o365audit.SourceRelativeUrl
      target_field: file.directory
      ignore_missing: true
      if: ctx.event?.code != null && ["SharePointFileOperation", "SharePointSharingOperation"].contains(ctx.event.code)
  - rename:
      field: o365audit.SourceFileName
      target_field: file.name
      ignore_missing: true
      if: ctx.event?.code != null && ["SharePointFileOperation", "SharePointSharingOperation"].contains(ctx.event.code)
  - rename:
      field: o365audit.SourceFileExtension
      target_field: file.extension
      ignore_missing: true
      if: ctx.event?.code != null && ["SharePointFileOperation", "SharePointSharingOperation"].contains(ctx.event.code)
  - append: 
      field: event.category
      value: file
      if: 'ctx.event?.action != null && ["FileAccessed", "FileDeleted", "FileDownloaded", "FileModified", "FileMoved", "FileRenamed", "FileRestored", "FileUploaded", "FolderCopied", "FolderCreated", "FolderDeleted", "FolderModified", "FolderMoved", "FolderRenamed", "FolderRestored"].contains(ctx.event?.action)'
  - append: 
      field: event.category
      value: configuration
      if: ctx.event?.action == "ComplianceSettingChanged"
  - append: 
      field: event.type
      value: access
      if: 'ctx.event?.action != null && ["FileAccessed", "FileDownloaded"].contains(ctx.event?.action)'
  - append: 
      field: event.type
      value: change
      if: 'ctx.event?.action != null && ["ComplianceSettingChanged", "FileModified", "FileMoved", "FileRenamed", "FileRestored", "FolderModified", "FolderMoved", "FolderRenamed", "FolderRestored"].contains(ctx.event?.action)'
  - append: 
      field: event.type
      value: deletion
      if: 'ctx.event?.action != null && ["FileDeleted", "FolderDeleted"].contains(ctx.event?.action)'
  - append: 
      field: event.type
      value: creation
      if: 'ctx.event?.action != null && ["FileUploaded", "FolderCopied", "FolderCreated"].contains(ctx.event?.action)'
  # SecurityComplianceAlerts Schema
  - set:
      field: message
      copy_from: o365audit.Name
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      field: o365audit.Name
      target_field: rule.name
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      field: o365audit.PolicyId
      target_field: rule.id
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      field: o365audit.Category
      target_field: rule.category
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      field: o365audit.EntityType
      target_field: rule.ruleset
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      field: o365audit.AlertEntityId
      target_field: rule.description
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      field: o365audit.AlertLinks
      target_field: rule.reference
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - set: 
      field: event.kind
      value: alert
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - append: 
      field: event.category
      value: authentication
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.o365audit?.Category == "AccessGovernance"'
  - append: 
      field: event.category
      value: file
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.o365audit?.Category != null && ["DataGovernance", "DataLossPrevention"].contains(ctx.o365audit?.Category)'
  - append: 
      field: event.category
      value: malware
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.o365audit?.Category == "ThreatManagement"'
  - append: 
      field: event.category
      value: authentication
      allow_duplicates: false
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.o365audit?.Category != null && !["DataGovernance", "DataLossPrevention", "ThreatManagement", "AccessGovernance"].contains(ctx.o365audit?.Category)'
  - append: 
      field: event.category
      value: web
      allow_duplicates: false
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - append: 
      field: event.type
      value: info
      allow_duplicates: false
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - convert:
      field: o365audit.AlertEntityId
      target_field: user.id
      type: string
      ignore_missing: true
      if: 'ctx.user?.id == null && ctx.event?.code == "SecurityComplianceAlerts" && ctx.rule?.ruleset == "User"'
  - rename:
      field: o365audit.AlertEntityId
      target_field: user.email
      ignore_missing: true
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.rule?.ruleset != null && ["Recipients", "Sender"].contains(ctx.rule?.ruleset)'
  - rename:
      field: o365audit.AlertEntityId
      target_field: threat.technique.id
      ignore_missing: true
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.rule?.ruleset == "MalwareFamily"'
  # DLP Schema
  - set: 
      field: event.kind
      value: alert
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - append: 
      field: event.category
      value: file
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - append: 
      field: event.type
      value: access
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.SharePointMetaData.From
      target_field: user.id
      ignore_missing: true
      if: 'ctx.user?.id == null && ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.SharePointMetaData.FileName
      target_field: file.name
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.SharePointMetaData.FilePathUrl
      target_field: url.original
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.SharePointMetaData.UniqueId
      target_field: file.inode
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.SharePointMetaData.UniqueID
      target_field: file.inode
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.SharePointMetaData.FileOwner
      target_field: file.owner
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.ExchangeMetaData.From
      target_field: source.user.email
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.ExchangeMetaData.Subject
      target_field: message
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.PolicyId
      target_field: rule.id
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      field: o365audit.PolicyName
      target_field: rule.name
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - date:
      field: o365audit.SharePointMetaData.LastModifiedTime
      target_field: file.mtime
      formats:
        - ISO8601
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code) && ctx.o365audit?.SharePointMetaData?.LastModifiedTime != null'
  - script:
      lang: painless
      if: 'ctx.event?.code != null && ctx.o365audit?.ExchangeMetaData!= null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
      source: >
        def fields = new def[] {"To", "CC", "BCC"};
        if (ctx.destination == null) {
          ctx.destination = new HashMap();
        }
        if (ctx.destination.user == null) {
          ctx.destination.user = new HashMap();
        }
        ctx.destination.user.email = new ArrayList();
        for (int i = 0; i < fields.length; ++i) {
          if (ctx.o365audit.ExchangeMetaData instanceof Map && ctx.o365audit.ExchangeMetaData.containsKey(fields[i])) {
            def emails = ctx.o365audit.ExchangeMetaData[fields[i]];
            if (emails instanceof List){
              for (int e = 0; e < emails.length; ++e) {
                ctx.destination.user.email.add(emails[e]);
              }
            }
            if (emails instanceof String){
              ctx.destination.user.email.add(emails);
            }
          }
        }
  - rename:
      field: o365audit.ExceptionInfo
      target_field: o365audit.ExceptionInfo.Reason
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code) && ctx.o365audit?.ExceptionInfo != null && ctx.o365audit?.ExceptionInfo instanceof String'
  - script:
      lang: painless
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code) && ctx.o365audit?.PolicyDetails != null'
      source: >
        int severityToCode(def x) { 
          if (x.toLowerCase() == "informational") {
            return 1;
          }
          if (x.toLowerCase() == "low") {
            return 2;
          }
          if (x.toLowerCase() == "medium") {
            return 3;
          }
          if (x.toLowerCase() == "high") {
            return 4;
          }
          return 0;
        }
        def policies = ctx.o365audit.PolicyDetails;
        if (policies == null) {
          return;
        }
        if (ctx.rule == null) {
          ctx.rule = new HashMap();
        }
        if (ctx.rule.id == null) {
          ctx.rule.id = new ArrayList();
        }
        if (ctx.rule.name == null) {
          ctx.rule.name = new ArrayList();
        }
        def maxSeverity = 0;
        def allowed = true;
        for (int i = 0; i < policies.length && policies instanceof List; ++i) {
          def rules = policies[i].Rules;
          if (rules == null) {
            continue;
          }
          for (int j = 0; j < rules.length; ++j) {
            def rule = rules[j];
            def id = rule.RuleId;
            def name = rule.RuleName;
            def sev = severityToCode(rule.Severity);
            if (id != null && name != null) {
              ctx.rule.id.add(id);
              ctx.rule.name.add(name);
            }
            if (sev > maxSeverity) {
              maxSeverity = sev;
            }
            if (allowed) {
              if (rule.Actions != null && rule.Actions.contains("BlockAccess")) {
                allowed = false;
              }
            }
          }
        }
        if (maxSeverity > -1) {
          ctx.event.severity = maxSeverity;
        }
        if (allowed) {
          ctx.event.outcome = "success";
          return;
        }
        if (ctx.event?.action == "DlpRuleUndo") {
          ctx.event.outcome = "success";
          return;
        }
        if (ctx.event?.action == "DlpInfo") {
          ctx.event.outcome = "failure";
          return;
        }
        if (ctx.o365audit?.ExceptionInfo != null && !ctx.o365audit?.ExceptionInfo.isEmpty()) {
          ctx.event.outcome = "success";
          return;
        }
        ctx.event.outcome = "failure";
  # Yammer Schema
  - rename:
      field: o365audit.ActorUserId
      target_field: user.email
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - convert:
      field: o365audit.ActorYammerUserId
      target_field: user.id
      type: string
      ignore_missing: true
      if: 'ctx.user?.id == null && ctx.event?.code == "Yammer"'
  - rename:
      field: o365audit.FileId
      target_field: file.inode
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - rename:
      field: o365audit.FileName
      target_field: file.name
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - rename:
      field: o365audit.GroupName
      target_field: group.name
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - rename:
      field: o365audit.TargetUserId
      target_field: destination.user.email
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - rename:
      field: o365audit.TargetYammerUserId
      target_field: destination.user.id
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - append: 
      field: event.category
      value: configuration
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["NetworkConfigurationUpdated", "NetworkSecurityConfigurationUpdated", "SoftDeleteSettingsUpdated", "ProcessProfileFields", "SupervisorAdminToggled"].contains(ctx.event?.action)'
  - append: 
      field: event.category
      value: iam
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["NetworkSecurityConfigurationUpdated", "GroupCreation", "GroupDeletion", "NetworkUserSuspended", "UserSuspension"].contains(ctx.event?.action)'
  - append: 
      field: event.category
      value: file
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["FileCreated", "FileDownloaded", "FileShared", "FileUpdateDescription", "FileUpdateName", "FileVisited"].contains(ctx.event?.action)'
  - append: 
      field: event.type
      value: change
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["NetworkConfigurationUpdated", "NetworkSecurityConfigurationUpdated", "SoftDeleteSettingsUpdated", "ProcessProfileFields", "SupervisorAdminToggled"].contains(ctx.event?.action)'
  - append: 
      field: event.type
      value: admin
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action == "NetworkSecurityConfigurationUpdated"'
  - append: 
      field: event.type
      value: creation
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["FileCreated", "GroupCreation", "FileUpdateName"].contains(ctx.event?.action)'
  - append: 
      field: event.type
      value: deletion
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action == "GroupDeletion"'
  - append: 
      field: event.type
      value: access
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["FileDownloaded", "FileShared", "FileUpdateDescription", "FileVisited"].contains(ctx.event?.action)'
  - append: 
      field: event.type
      value: group
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["GroupCreation", "GroupDeletion"].contains(ctx.event?.action)'
  # Teams Schema
  - set: 
      field: event.action
      value: added-group-account-to
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "TeamCreated"'
  - append: 
      field: event.category
      value: iam
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-group-account-to"'
  - append: 
      field: event.type
      value: group
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-group-account-to"'
  - append: 
      field: event.type
      value: creation
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-group-account-to"'
  - rename:
      field: o365audit.TeamName
      target_field: group.name
      ignore_missing: true
      if: ctx.event?.code == "MicrosoftTeams"
  - set: 
      field: event.action
      value: added-users-to-group
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "MemberAdded"'
  - append: 
      field: event.category
      value: iam
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-users-to-group"'
  - append: 
      field: event.type
      value: group
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-users-to-group"'
  - append: 
      field: event.type
      value: change
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-users-to-group"'
  - set: 
      field: event.action
      value: deleted-user-account
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "Delete user."'
  - append: 
      field: event.category
      value: iam
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "deleted-user-account"'
  - append: 
      field: event.type
      value: user
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "deleted-user-account"'
  - append: 
      field: event.type
      value: deletion
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "deleted-user-account"'
  - rename:
      field: o365audit.ObjectId
      target_field: user.target.id
      ignore_missing: true
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "deleted-user-account"'
  - script:
      lang: painless
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.o365audit?.Members != null && ctx.o365audit.Members instanceof List'
      source: >
        def members = ctx.o365audit?.Members;
        if (ctx.related == null) {
          ctx.related = new HashMap();
        }
        if (ctx.related.user == null) {
          ctx.related.user = new ArrayList();
        }
        for (int i = 0; i < members.length; ++i) {
          if (members[i] instanceof Map && members[i].containsKey("UPN") && !members[i]["UPN"].isEmpty()) {
            ctx.related.user.add(members[i]["UPN"]);
          }
        }
  - gsub:
      tag: extract_ipv4_and_port
      field: client._temp
      pattern: '^\[?::ffff:([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)(?:\](:[0-9]+)?)?$'
      replacement: '$1$2'
      ignore_missing: true
  - grok:
      field: client._temp
      patterns: 
        - '%{IPANDPORTBRACKETS}'
        - '^%{IP:client.address}$'
        - '^\[%{IP:client.address}\]$'
        - '%{IPANDPORT}'
        - '^%{NOTSPACE:client.domain}$'
        - '%{HOSTNAMEANDPORTBRACKETS}'
        - '%{HOSTNAMEANDPORT}'
        - '^\[%{HOSTNAMEANDIP}\]$'
        - '^%{HOSTNAMEANDIP}$'
        - '%{GREEDYDATA:client.address}'
      pattern_definitions:
        IPANDPORTBRACKETS: '^\[%{IP:client.address}\]:%{POSINT:client._port}'
        IPANDPORT: '^%{IP:client.address}:%{POSINT:client._port}'
        HOSTNAMEANDPORTBRACKETS: '^\[%{NOTSPACE:client.domain}\]:%{POSINT:client._port}'
        HOSTNAMEANDPORT: '^%{NOTSPACE:client.domain}:%{POSINT:client._port}'
        NOTCLOSINGPARENS: '[^)]*'
        HOSTNAMEANDIP: '%{NOTSPACE:client.domain} \(%{NOTCLOSINGPARENS:client.address}\)'
      if: 'ctx.client?._temp != null && !ctx.client?._temp.isEmpty()'
  - gsub:
      field: server._temp
      pattern: "[\n\r]"
      replacement: ""
      ignore_missing: true
  - grok:
      field: server._temp
      patterns:
        - '^\[%{HOSTNAMEANDIP}\]$'
        - '%{HOSTNAMEANDIP}'
        - '%{GREEDYDATA:server.address}'
      pattern_definitions:
        NOTCLOSINGPARENS: '[^)]*'
        HOSTNAMEANDIP: '%{NOTSPACE:server.domain} \(%{NOTCLOSINGPARENS:server.address}\)'
      if: 'ctx.server?._temp != null && !ctx.server?._temp.isEmpty()'
      ignore_failure: true
  - convert:
      field: client.address
      target_field: client.ip
      type: ip
      ignore_failure: true
  - convert:
      field: client._port
      target_field: client.port
      type: long
      ignore_missing: true
  - convert:
      field: server.address
      target_field: server.ip
      type: ip
      ignore_failure: true
  - remove: 
      field:
        - client._port
        - client._temp
        - server._temp
      ignore_missing: true
  - set:
      field: source.ip
      copy_from: client.ip
      if: ctx.client?.ip != null
  - set:
      field: source.port
      copy_from: client.port
      if: ctx.client?.port != null
  - set:
      field: destination.ip
      copy_from: server.ip
      if: ctx.server?.ip != null
  - script:
      lang: painless
      if: 'ctx.user?.id instanceof String && ctx.user?.id.contains("@")'
      source: >
        String[] splitmail = ctx.user.id.splitOnToken("@");
        if (splitmail.length != 2) {
          return;
        }
        ctx.user.email = ctx.user.id;
        ctx.user.domain = splitmail[1];
        ctx.user.name = splitmail[0];
  - script:
      lang: painless
      if: 'ctx.user?.target?.id instanceof String && ctx.user?.target?.id.contains("@")'
      source: >
        String[] splitmail = ctx.user.target.id.splitOnToken("@");
        if (splitmail.length != 2) {
          return;
        }
        ctx.user.target.email = ctx.user.target.id;
        ctx.user.target.domain = splitmail[1];
        ctx.user.target.name = splitmail[0];
  - script:
      lang: painless
      if: 'ctx.source?.user?.id instanceof String && ctx.source?.user?.id.contains("@")'
      source: >
        String[] splitmail = ctx.source.user.id.splitOnToken("@");
        if (splitmail.length != 2) {
          return;
        }
        ctx.source.user.email = ctx.source.user.id;
        ctx.source.user.domain = splitmail[1];
        ctx.source.user.name = splitmail[0];
  - script:
      lang: painless
      if: 'ctx.destination?.user?.id instanceof String && ctx.destination?.user?.id.contains("@")'
      source: >
        String[] splitmail = ctx.destination.user.id.splitOnToken("@");
        if (splitmail.length != 2) {
          return;
        }
        ctx.destination.user.email = ctx.destination.user.id;
        ctx.destination.user.domain = splitmail[1];
        ctx.destination.user.name = splitmail[0];
  - set:
      field: network.type
      value: ipv6
      if: 'ctx.client?.ip instanceof String && ctx.client?.ip.contains(":")'
  - set:
      field: network.type
      value: ipv4
      if: 'ctx.network?.type == null && ctx.client?.ip != null'
  - append:
      field: related.ip
      value: "{{{client.ip}}}"
      allow_duplicates: false
      if: ctx.client?.ip != null
  - append:
      field: related.ip
      value: "{{{server.ip}}}"
      allow_duplicates: false
      if: ctx.server?.ip != null
  - append:
      field: related.user
      value: "{{{user.name}}}"
      allow_duplicates: false
      if: ctx.user?.name != null
  - append:
      field: related.user
      value: "{{{user.target.name}}}"
      allow_duplicates: false
      if: ctx.user?.target?.name != null
  - append:
      field: related.user
      value: "{{{file.owner}}}"
      allow_duplicates: false
      if: ctx.file?.owner != null
  - append:
      field: related.user
      value: "{{{o365audit.Parameters.User}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Parameters?.User != null
  - rename:
      field: o365audit.ExtendedProperties.UserAgent
      target_field: user_agent.original
      ignore_missing: true
      if: ctx.o365audit?.ExtendedProperties?.UserAgent != null
  # Add Host and Organization fields
  - lowercase:
      field: organization.id
      ignore_missing: true
      ignore_failure: true
  - set:
      field: host.id
      copy_from: organization.id
      if: ctx.organization instanceof Map && ctx.organization?.id != null
  - script:
      lang: painless
      if: ctx.organization instanceof Map && ctx.organization?.id != null && ctx._conf?.tenants != null
      source: >
        def conftenants = ctx._conf.tenants;
        def orgid = ctx.organization.id;
        if (conftenants instanceof Map && conftenants.containsKey(orgid)) {
          ctx.organization.name = conftenants[orgid];
        }
  - set:
      field: host.name
      copy_from: o365audit.DeviceName
      if: ctx.o365audit?.DeviceName != null && ctx.host?.name == null
  - set:
      field: host.name
      copy_from: organization.name
      if: ctx.organization instanceof Map && ctx.organization?.name != null && ctx.host?.name == null
  - set:
      field: host.name
      copy_from: user.domain
      if: ctx.user?.domain != null && ctx.host?.name == null
  # Convert field values
  - convert:
      field: o365audit.AzureActiveDirectoryEventType
      type: string
      ignore_missing: true
  - convert:
      field: o365audit.RecordType
      type: string
      ignore_missing: true
  - convert:
      field: o365audit.UserType
      type: string
      ignore_missing: true
  - set:
      field: event.provider
      description: UserType contains info about event.provider and not user. Populate event.provider if not already present.
      value: "{{{o365audit.UserType}}}"
      if: ctx.event?.provider == null && ctx.o365audit?.UserType != null && ctx.o365audit.UserType != ''
      tag: set_event_provider
      ignore_empty_value: true
  - foreach:
      field: o365audit.Actor
      if: ctx.o365audit?.Actor instanceof List
      processor:
        convert:
          field: _ingest._value.Type
          tag: convert_actor_type_to_string
          type: string
          ignore_missing: true
  - foreach:
      field: o365audit.Target
      if: ctx.o365audit?.Target instanceof List
      processor:
        convert:
          field: _ingest._value.Type
          tag: convert_target_type_to_string
          type: string
          ignore_missing: true
  - convert:
      field: o365audit.Version
      type: string
      ignore_missing: true
  - convert:
      field: o365audit.InternalLogonType
      type: string
      ignore_missing: true
  - convert:
      field: o365audit.LogonType
      type: string
      ignore_missing: true
  - convert:
      field: o365audit.ActorYammerUserId
      type: string
      ignore_missing: true
  - convert:
      field: o365audit.YammerNetworkId
      type: string
      ignore_missing: true
  - append:
      field: email.message_id
      value: "{{{o365audit.InternetMessageId}}}"
      if: ctx.o365audit?.InternetMessageId != null && ctx.o365audit.InternetMessageId != ''
      tag: append_email_message_id_1
      allow_duplicates: false
  - append:
      field: email.local_id
      value: "{{{o365audit.NetworkMessageId}}}"
      if: ctx.o365audit?.NetworkMessageId != null && ctx.o365audit.NetworkMessageId != ''
      tag: append_email_local_id_1
      allow_duplicates: false
  - append:
      field: email.sender.address
      value: "{{{o365audit.P1Sender}}}"
      if: ctx.o365audit?.P1Sender != null && ctx.o365audit.P1Sender != ''
      tag: append_email_sender_address_1
      allow_duplicates: false
  - foreach:
      field: o365audit.Recipients
      if: ctx.o365audit?.Recipients instanceof List && ctx.o365audit.Recipients.length > 0
      tag: foreach_recipient
      processor:
        append:
          field: email.to.address
          value: "{{{_ingest._value}}}"
          tag: append_recipient_to_email_to_address
          allow_duplicates: false
  - append:
      field: related.ip
      value: "{{{o365audit.SenderIp}}}"
      allow_duplicates: false
      if: ctx.o365audit?.SenderIp != null && ctx.o365audit.SenderIp != ''
  - append:
      field: related.ip
      value: "{{{o365audit.SenderIP}}}"
      allow_duplicates: false
      if: ctx.o365audit?.SenderIP != null && ctx.o365audit.SenderIP != ''
  - append:
      field: email.subject
      value: "{{{o365audit.Subject}}}"
      if: ctx.o365audit?.Subject != null && ctx.o365audit.Subject != ''
      tag: append_email_subject_1
      allow_duplicates: false
  - date:
      field: o365audit.EndTimeUtc
      target_field: o365audit.EndTimeUtc
      tag: date_EndTimeUtc
      formats:
        - ISO8601
      if: ctx.o365audit?.EndTimeUtc != null
  - date:
      field: o365audit.LastUpdateTimeUtc
      target_field: o365audit.LastUpdateTimeUtc
      tag: date_LastUpdateTimeUtc
      formats:
        - ISO8601
      if: ctx.o365audit?.LastUpdateTimeUtc != null
  - date:
      field: o365audit.StartTimeUtc
      target_field: o365audit.StartTimeUtc
      tag: date_StartTimeUtc
      formats:
        - ISO8601
      if: ctx.o365audit?.StartTimeUtc != null
  - date:
      field: o365audit.StartTime
      target_field: o365audit.StartTime
      tag: date_StartTime
      formats:
        - ISO8601
      if: ctx.o365audit?.StartTime != null
  - date:
      field: o365audit.FilteringDate
      target_field: o365audit.FilteringDate
      tag: date_FilteringDate
      formats:
        - ISO8601
      if: ctx.o365audit?.FilteringDate != null
  - date:
      field: o365audit.RescanResult.Timestamp
      target_field: o365audit.RescanResult.Timestamp
      tag: date_RescanResult.Timestamp
      formats:
        - ISO8601
      if: ctx.o365audit?.RescanResult?.Timestamp != null
  - gsub:
      field: o365audit.Data
      pattern: ',\"QueryTime\":\"[0-9\/]+\s[0-9]+:[0-9]+:[0-9]+\s[AP]M\"|\"QueryTime\":\"[0-9\/]+\s[0-9]+:[0-9]+:[0-9]+\s[AP]M\",'
      replacement: ""
      if: ctx.o365audit?.containsKey('Data') == true && ctx.o365audit?.RecordType == '64'
      tag: gsub_remove_duplicated_querytime
  - json:
      field: o365audit.Data
      if: ctx.o365audit?.containsKey('Data') == true
      on_failure:
        - remove:
            field: o365audit.Data
            ignore_missing: true
            description: remove_malformed_data
  - rename:
      field: o365audit.Data
      target_field: o365audit.Data.flattened
      ignore_missing: true
  - script:
      description: Copy known Data fields to their explicity mapped locations
      lang: painless
      tag: script_known_Data
      if: 'ctx.o365audit?.Data?.flattened instanceof Map'
      params:
        knownKeys: [
          'ad', 'af', 'aii', 'ail', 'alk', 'als', 'an', 'at',
          'cid', 'cpid', 'dm', 'dpn', 'eid', 'etps', 'etype', 'f3u', 'fvs',
          'imsgid', 'lon', 'mat', 'md', 'ms', 'od', 'op', 'ot', 'plk', 'pud',
          'reid', 'rid', 'sev', 'sict', 'sid', 'sip', 'sitmi', 'srt', 'ssic',
          'suid', 'tdc', 'te', 'thn', 'tht', 'tid', 'tpid', 'tpt', 'trc', 'ts',
          'tsd', 'ttdt', 'ttr', 'upfc', 'upfv', 'ut', 'von', 'wl', 'zfh', 'zfn',
          'zmfh', 'zmfn', 'zu'
        ]
      source: >
        for (def key : params.knownKeys) {
          if (ctx.o365audit.Data.flattened.containsKey(key)) {
            ctx.o365audit.Data[key] = ctx.o365audit.Data.flattened[key];
          }
        }
  - convert:
      field: o365audit.Data.sip
      type: ip
      ignore_missing: true
      if: ctx.o365audit?.Data?.sip != ''
      on_failure:
        - remove:
            field: o365audit.Data.sip
            ignore_missing: true
  - date:
      field: o365audit.Data.at
      target_field: o365audit.Data.at
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.at != null
  - date:
      field: o365audit.Data.md
      target_field: o365audit.Data.md
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.md != null
  - date:
      field: o365audit.Data.te
      target_field: o365audit.Data.te
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.te != null
  - date:
      field: o365audit.Data.ts
      target_field: o365audit.Data.ts
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.ts != null
  - date:
      field: o365audit.Data.ttdt
      target_field: o365audit.Data.ttdt
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.ttdt != null
  - append:
      field: related.user
      value: "{{{o365audit.Data.f3u}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Data?.f3u?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.f3u.length() >= 3;
  - set:
      field: user.email
      value: "{{{o365audit.Data.f3u}}}"
      if: ctx.user?.email == null && ctx.o365audit?.Data?.f3u?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.f3u.length() >= 3;
      tag: set_user_email
      ignore_empty_value: true
  - append:
      field: related.user
      value: "{{{o365audit.Data.suid}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Data?.suid?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.suid.length() >= 3;
  - append:
      field: email.sender.address
      value: "{{{o365audit.Data.tsd}}}"
      if: ctx.o365audit?.Data?.tsd != null && ctx.o365audit.Data.tsd != ''
      tag: append_email_sender_address_2
      allow_duplicates: false
  - append:
      field: related.user
      value: "{{{o365audit.Data.tsd}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Data?.tsd?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.tsd.length() >= 3;
  - append:
      field: email.to.address
      value: "{{{o365audit.Data.trc}}}"
      if: ctx.o365audit?.Data?.trc != null && ctx.o365audit.Data.trc != ''
      tag: append_email_to_address
      allow_duplicates: false
  - append:
      field: related.user
      value: "{{{o365audit.Data.trc}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Data?.trc?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.trc.length() >= 3;
  - append:
      field: email.local_id
      value: "{{{o365audit.Data.aii}}}"
      if: ctx.o365audit?.Data?.aii != null && ctx.o365audit.Data.aii != ''
      tag: append_email_local_id_2
      allow_duplicates: false
  - append:
      field: email.message_id
      value: "{{{o365audit.Data.imsgid}}}"
      if: ctx.o365audit?.Data?.imsgid != null && ctx.o365audit.Data.imsgid != ''
      tag: append_email_message_id_2
      allow_duplicates: false
  - append:
      field: email.subject
      value: "{{{o365audit.Data.ms}}}"
      if: ctx.o365audit?.Data?.ms != null && ctx.o365audit.Data.ms != ''
      tag: append_email_subject_2
      allow_duplicates: false
  - script:
      description: Parse known fields from Data.Entities into _tmp.entities to later extract into ECS.
      lang: painless
      tag: script_known_Data.Entities
      if: ctx.o365audit?.Data?.flattened?.Entities instanceof List
      params:
        knownEntityKeys: [
          'InternetMessageId', 'NetworkMessageId', 'OriginalDeliveryLocation',
          'P1Sender', 'P2Sender', 'PhishConfidenceLevel', 'Recipient', 'SenderIP', 'Subject',
          'ThreatDetectionMethods', 'Upn'
        ]
      source: >
        ctx._tmp = [:];
        ctx._tmp.entities = [:];
        for (def entity: ctx.o365audit.Data.flattened.Entities) {
          if (entity instanceof Map) {
            for (def key : params.knownEntityKeys) {
              if (! ctx._tmp.entities.containsKey(key)) {
                ctx._tmp.entities[key] = [];
              }
              if (entity.containsKey(key)) {
                ctx._tmp.entities[key].add(entity[key]);
              }
            }
          }
        }
  # Extract _tmp.entities into ECS fields
  - foreach:
      field: _tmp.entities.InternetMessageId
      if: ctx._tmp?.entities?.InternetMessageId instanceof List
      processor:
        append:
          field: email.message_id
          value: "{{{_ingest._value}}}"
          tag: append_entities.InternetMessageId_email.message_id
          allow_duplicates: false
  - foreach:
      field: _tmp.entities.NetworkMessageId
      if: ctx._tmp?.entities?.NetworkMessageId instanceof List
      processor:
        append:
          field: email.local_id
          value: "{{{_ingest._value}}}"
          tag: append_entities.NetworkMessageId_email.local_id
          allow_duplicates: false
  - foreach:
      field: _tmp.entities.P1Sender
      if: ctx._tmp?.entities?.P1Sender instanceof List
      processor:
        append:
          field: email.sender.address
          value: "{{{_ingest._value}}}"
          tag: append_entities.P1Sender_email.sender.address
          allow_duplicates: false
  - foreach:
      field: _tmp.entities.P2Sender
      if: ctx._tmp?.entities?.P2Sender instanceof List
      processor:
        append:
          field: email.from.address
          value: "{{{_ingest._value}}}"
          tag: append_entities.P2Sender_email.from.address
          allow_duplicates: false
  - foreach:
      field: _tmp.entities.Recipient
      if: ctx._tmp?.entities?.Recipient instanceof List
      processor:
        append:
          field: email.to.address
          value: "{{{_ingest._value}}}"
          tag: append_entities.Recipient_email.to.address
          allow_duplicates: false
  - set:
      field: user.email
      copy_from: _tmp.entities.Recipient
      if: ctx.user?.email == null && ctx._tmp?.entities?.Recipient instanceof List && ctx._tmp.entities.Recipient.length > 0
      ignore_empty_value: true
  - foreach:
      field: _tmp.entities.SenderIP
      if: ctx._tmp?.entities?.SenderIP instanceof List
      processor:
        append:
          field: related.ip
          value: "{{{_ingest._value}}}"
          tag: append_entities.SenderIP_related.ip
          allow_duplicates: false
  - foreach:
      field: _tmp.entities.Subject
      if: ctx._tmp?.entities?.Subject instanceof List
      processor:
        append:
          field: email.subject
          value: "{{{_ingest._value}}}"
          tag: append_entities.Subject_email.subject
          allow_duplicates: false
  - foreach:
      field: _tmp.entities.Upn
      if: ctx._tmp?.entities?.Upn instanceof List
      processor:
        append:
          field: related.user
          value: "{{{_ingest._value}}}"
          tag: append_entities.Upn_related.user
          allow_duplicates: false
  - rename:
      field: _tmp.entities.OriginalDeliveryLocation
      target_field: o365audit.OriginalDeliveryLocation
      tag: rename_entities.OriginalDeliveryLocation
      ignore_missing: true
  - rename:
      field: _tmp.entities.PhishConfidenceLevel
      target_field: o365audit.PhishConfidenceLevel
      tag: rename_entities.PhishConfidenceLevel
      ignore_missing: true
  - set:
      field: device.id
      copy_from: o365audit.AppAccessContext.DeviceId
      tag: set_device_id_from_AppAccessContext_DeviceID
      ignore_empty_value: true
  - set:
      field: session.id
      copy_from: o365audit.AppAccessContext.AADSessionId
      tag: set_session_id_from_AppAccessContext_AADSessionId
      ignore_empty_value: true
  - set:
      field: token.id
      copy_from: o365audit.AppAccessContext.UniqueTokenId
      tag: set_token_id_from_AppAccessContext_UniqueTokenId
      ignore_empty_value: true
  - set:
      field: application.name
      copy_from: o365audit.ApplicationDisplayName
      tag: set_application_name
      ignore_empty_value: true
  - script:
      description: Handle _tmp.entities.ThreatDetectionMethods containing list of lists.
      lang: painless
      tag: script_tmp.entities.ThreatDetectionMethods
      if: ctx._tmp?.entities?.ThreatDetectionMethods instanceof List
      source: >
        def methods = ctx._tmp.entities.ThreatDetectionMethods;
        def result = [];
        for (def method: methods){
          if (method instanceof List) {
            for (def m: method) {
              result.add(m);
            }
          } else if (method instanceof String) {
            result.add(method);
          }
        }
        ctx.o365audit.ThreatDetectionMethods = result;
  - rename:
      field: o365audit
      target_field: o365.audit
      ignore_missing: true
  - user_agent:
      field: user_agent.original
      ignore_missing: true
  # IP Geolocation Lookup
  - geoip:
      field: source.ip
      target_field: source.geo
      ignore_missing: true
  # IP Autonomous System (AS) Lookup
  - geoip:
      database_file: GeoLite2-ASN.mmdb
      field: source.ip
      target_field: source.as
      properties:
        - asn
        - organization_name
      ignore_missing: true
  - rename:
      field: source.as.asn
      target_field: source.as.number
      ignore_missing: true
  - rename:
      field: source.as.organization_name
      target_field: source.as.organization.name
      ignore_missing: true
  - remove:
      field:
        - _conf
        - _tmp
      ignore_missing: true
  - script:
      description: Drops null/empty values recursively.
      lang: painless
      source: |
        boolean dropEmptyFields(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(value -> dropEmptyFields(value));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(value -> dropEmptyFields(value));
            return (((List) object).length == 0);
          }
          return false;
        }
        dropEmptyFields(ctx);
  - set:
      field: event.kind
      value: pipeline_error
      if: ctx.error?.message != null
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
      if: ctx.error?.message != null
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}}failed with message '{{{ _ingest.on_failure_message }}}'
