---
description: Pipeline for Office 365 Audit logs
processors:
  - remove:
      field:
        - organization
        - division
        - team
      ignore_missing: true
      if: ctx.organization instanceof String && ctx.division instanceof String && ctx.team instanceof String
      tag: remove_agentless_tags
      description: >-
        Removes the fields added by Agentless as metadata,
        as they can collide with ECS fields.
  - rename:
      tag: rename_message_to_event_original_56a77271
      field: message
      target_field: event.original
      if: ctx.event?.original == null
      ignore_missing: true
  - remove:
      tag: remove_message_2ee3a7d4
      field: message
      ignore_missing: true
      if: 'ctx.event?.original != null'
      description: 'The `message` field is no longer required if the document has an `event.original` field.'
  - script:
      tag: set_event_original
      if: ctx.event?.original == null
      source: |-
        ctx.event = ctx.event ?: [:];
        ctx.event.original = Json.dump(ctx.o365audit)
  - set:
      tag: set_ecs_version_0f7334bb
      field: ecs.version
      value: '8.11.0'
  - set:
      tag: set_event_kind_de80643c
      field: event.kind
      value: event
  - append:
      tag: append_event_type_8a66ccaa
      field: event.type
      value: info
  - append:
      tag: append_event_category_4595ee28
      field: event.category
      value: web
  - fingerprint:
      tag: fingerprint_443be558
      fields:
        - o365audit.Id
      target_field: "_id"
      ignore_missing: true

  # Miscellaneous
  - set:
      tag: set_file_extension_9dc66335
      field: file.extension
      copy_from: o365audit.FileExtension
      ignore_empty_value: true

  - set:
      tag: set_file_hash_sha1_97939b23
      field: file.hash.sha1
      copy_from: o365audit.Sha1
      ignore_empty_value: true
  - set:
      tag: set_file_hash_sha256_c70524eb
      field: file.hash.sha256
      copy_from: o365audit.Sha256
      ignore_empty_value: true

  - set:
      tag: set_file_path_83694d77
      field: file.path
      copy_from: o365audit.FilePath
      ignore_empty_value: true
  - set:
      tag: set_file_path_53cd1ef1
      field: file.path
      copy_from: o365audit.TargetFilePath
      ignore_empty_value: true
      override: false

  - set:
      tag: set_file_size_723563fe
      field: file.size
      copy_from: o365audit.FileSizeBytes
      ignore_empty_value: true
  - set:
      tag: set_file_size_c6196fe8
      field: file.size
      copy_from: o365audit.FileSize
      ignore_empty_value: true
      override: false
  - script:
      tag: convert_file_size_to_long
      if: ctx.file?.size != null
      source: |-
        if (ctx.file.size instanceof long || ctx.file.size instanceof int) {
          return;
        }
        if (ctx.file.size instanceof double) {
          ctx.file.size = (long) ctx.file.size;
          return;
        }
        try {
          // Attempt to parse as long to prevent inexact integer conversion.
          ctx.file.size = Long.parseLong(ctx.file.size);
        }
        catch (NumberFormatException e) {
          // But fall back to float parsing for cases where we failed.
          ctx.file.size = (long) Double.parseDouble(ctx.file.size);
        }
      on_failure:
        - remove:
            tag: remove_file_size_d74cf399
            field: file.size
        - append:
            tag: append_error_message_974b7657
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  - set:
      tag: set_process_name_fa24cee1
      field: process.name
      copy_from: o365audit.Application
      ignore_empty_value: true

  - set:
      tag: set_url_domain_5891eb27
      field: url.domain
      copy_from: o365audit.OriginatingDomain
      ignore_empty_value: true

  # Ensure that o365.audit.Actions is an array of Map.
  - script:
      description: 'This is the first half of an implementation of `if: _ingest._value instanceof String` for the foreach below.'
      if: ctx.o365audit?.Actions != null
      tag: script_select_string_actions
      source: |-
        ctx._tmp = [:];
        def actions = [];
        ctx._tmp.action_strings = [];
        if (!(ctx.o365audit.Actions instanceof List)) {
          ctx.o365audit.Actions = [ctx.o365audit.Actions];
        }
      
        // Actions contains both a human readable `QueryTime` using AM/PM and an ISO8601 format `QueryTime`
        // We remove the AM/PM containing `QueryTime` to avoid duplicate field errors on flattening.
        def queryTimePattern = /,"QueryTime":"[0-9\/]+\s[0-9]+:[0-9]+:[0-9]+\s[AP]M"|"QueryTime":"[0-9\/]+\s[0-9]+:[0-9]+:[0-9]+\s[AP]M",/;
        for (def e: ctx.o365audit.Actions) {
          if (e instanceof Map) {
            actions.add(e);
          } else if (e instanceof String) {
            ctx._tmp.action_strings.add(queryTimePattern.matcher(e).replaceAll(''));
          }
        }
        if (actions.length == ctx.o365audit.Actions.length) {
          ctx._tmp.remove("action_strings");
          return
        }
        ctx.o365audit.Actions = actions;
  - foreach:
      tag: parse_string_actions_to_json
      field: _tmp.action_strings
      if: ctx._tmp?.action_strings != null
      processor:
        json:
          field: _ingest._value
          on_failure:
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - script:
      description: 'This is the second half of an implementation of `if: _ingest._value instanceof String` for the foreach above.'
      if: ctx._tmp?.action_strings != null
      tag: script_01a1e9ce
      source: |-
        // To reach here, ctx._tmp.action_strings must be non-null
        // and for this to be true, script_select_string_actions
        // must have run, requiring that ctx.o365audit.Actions is
        // non-null, so we do not need to check again.
        ctx.o365audit.Actions.addAll(ctx._tmp.action_strings);

  # General Schema
  - date:
      tag: date_o365audit_CreationTime_6311f871
      field: o365audit.CreationTime
      formats:
        - ISO8601
      if: ctx.o365audit?.CreationTime != null
  - rename:
      tag: rename_o365audit_Id_to_event_id_6e947a76
      field: o365audit.Id
      target_field: event.id
      ignore_missing: true
  - convert:
      field: o365audit.ListBaseType
      type: string
      tag: convert-listbasetype-to-string
      if: ctx.o365audit?.ListBaseType != null
      on_failure:
        - append:
            tag: append_error_message_8375c352
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  - rename:
      tag: rename_o365audit_ClientIPAddress_to_client__temp_bda6b6c2
      field: o365audit.ClientIPAddress
      target_field: client._temp
      ignore_missing: true
  - rename:
      tag: rename_o365audit_ClientIP_to_client__temp_c46a88f2
      field: o365audit.ClientIP
      target_field: client._temp
      ignore_missing: true
      if: ctx.client?._temp == null
  - rename:
      tag: rename_o365audit_ActorIpAddress_to_client__temp_0ce83358
      field: o365audit.ActorIpAddress
      target_field: client._temp
      ignore_missing: true
      if: ctx.client?._temp == null
  - convert:
      tag: convert_o365audit_UserId_to_user_id_ecdabea0
      field: o365audit.UserId
      target_field: user.id
      type: string
      ignore_missing: true
  - rename:
      tag: rename_o365audit_Workload_to_event_provider_360cf1ce
      field: o365audit.Workload
      target_field: event.provider
      ignore_missing: true
  - rename:
      tag: rename_o365audit_Operation_to_event_action_12df59f5
      field: o365audit.Operation
      target_field: event.action
      ignore_missing: true
  - rename:
      field: o365audit.OrganizationId
      target_field: organization.id
      ignore_missing: true
      tag: rename_organization_id
      on_failure:
        - append:
            tag: append_error_message_904f4924
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  - json:
      tag: json-extract-stringly-AdditionalInfo
      field: o365audit.AdditionalInfo
      if: ctx.o365audit?.AdditionalInfo instanceof String
      on_failure:
        - remove:
            tag: remove_o365audit_AdditionalInfo_0b134349
            field: o365audit.AdditionalInfo
        - append:
            tag: append_error_message_03690b95
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - json:
      tag: json-extract-stringly-OperationProperties
      field: o365audit.OperationProperties
      if: ctx.o365audit?.OperationProperties instanceof String
      on_failure:
        - remove:
            tag: remove_o365audit_OperationProperties_da3a1cbc
            field: o365audit.OperationProperties
        - append:
            tag: append_error_message_2d0560ed
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  - rename:
      tag: rename_o365audit_UserAgent_to_user_agent_original_dd35f20c
      field: o365audit.UserAgent
      target_field: user_agent.original
      ignore_missing: true
  - script:
      tag: script_3e1f1446
      if: ctx.o365audit?.RecordType != null
      lang: painless
      params:
        "1": "ExchangeAdmin"
        "2": "ExchangeItem"
        "3": "ExchangeItemGroup"
        "4": "SharePoint"
        "6": "SharePointFileOperation"
        "7": "OneDrive"
        "8": "AzureActiveDirectory"
        "9": "AzureActiveDirectoryAccountLogon"
        "10": "DataCenterSecurityCmdlet"
        "11": "ComplianceDLPSharePoint"
        "12": "Sway"
        "13": "ComplianceDLPExchange"
        "14": "SharePointSharingOperation"
        "15": "AzureActiveDirectoryStsLogon"
        "16": "SkypeForBusinessPSTNUsage"
        "17": "SkypeForBusinessUsersBlocked"
        "18": "SecurityComplianceCenterEOPCmdlet"
        "19": "ExchangeAggregatedOperation"
        "20": "PowerBIAudit"
        "21": "CRM"
        "22": "Yammer"
        "23": "SkypeForBusinessCmdlets"
        "24": "Discovery"
        "25": "MicrosoftTeams"
        "28": "ThreatIntelligence"
        "29": "MailSubmission"
        "30": "MicrosoftFlow"
        "31": "AeD"
        "32": "MicrosoftStream"
        "33": "ComplianceDLPSharePointClassification"
        "34": "ThreatFinder"
        "35": "Project"
        "36": "SharePointListOperation"
        "37": "SharePointCommentOperation"
        "38": "DataGovernance"
        "39": "Kaizala"
        "40": "SecurityComplianceAlerts"
        "41": "ThreatIntelligenceUrl"
        "42": "SecurityComplianceInsights"
        "43": "MIPLabel"
        "44": "WorkplaceAnalytics"
        "45": "PowerAppsApp"
        "46": "PowerAppsPlan"
        "47": "ThreatIntelligenceAtpContent"
        "48": "LabelContentExplorer"
        "49": "TeamsHealthcare"
        "50": "ExchangeItemAggregated"
        "51": "HygieneEvent"
        "52": "DataInsightsRestApiAudit"
        "53": "InformationBarrierPolicyApplication"
        "54": "SharePointListItemOperation"
        "55": "SharePointContentTypeOperation"
        "56": "SharePointFieldOperation"
        "57": "MicrosoftTeamsAdmin"
        "58": "HRSignal"
        "59": "MicrosoftTeamsDevice"
        "60": "MicrosoftTeamsAnalytics"
        "61": "InformationWorkerProtection"
        "62": "Campaign"
        "63": "DLPEndpoint"
        "64": "AirInvestigation"
        "65": "Quarantine"
        "66": "MicrosoftForms"
        "67": "ApplicationAudit"
        "68": "ComplianceSupervisionExchange"
        "69": "CustomerKeyServiceEncryption"
        "70": "OfficeNative"
        "71": "MipAutoLabelSharePointItem"
        "72": "MipAutoLabelSharePointPolicyLocation"
        "73": "MicrosoftTeamsShifts"
        "75": "MipAutoLabelExchangeItem"
        "76": "CortanaBriefing"
        "78": "WDATPAlerts"
        "82": "SensitivityLabelPolicyMatch"
        "83": "SensitivityLabelAction"
        "84": "SensitivityLabeledFileAction"
        "85": "AttackSim"
        "86": "AirManualInvestigation"
        "87": "SecurityComplianceRBAC"
        "88": "UserTraining"
        "89": "AirAdminActionInvestigation"
        "90": "MSTIC"
        "91": "PhysicalBadgingSignal"
        "93": "AipDiscover"
        "94": "AipSensitivityLabelAction"
        "95": "AipProtectionAction"
        "96": "AipFileDeleted"
        "97": "AipHeartBeat"
        "98": "MCASAlerts"
        "99": "OnPremisesFileShareScannerDlp"
        "100": "OnPremisesSharePointScannerDlp"
        "101": "ExchangeSearch"
        "102": "SharePointSearch"
        "103": "PrivacyInsights"
        "105": "MyAnalyticsSettings"
        "106": "SecurityComplianceUserChange"
        "107": "ComplianceDLPExchangeClassification"
        "109": "MipExactDataMatch"
        "113": "MS365DCustomDetection"
        "147": "CoreReportingSettings"
        "148": "ComplianceConnector"
        "174": "DataShareOperation"
        "181": "EduDataLakeDownloadOperation"
      source: >
        def schemaId = ctx.o365audit.RecordType.toString();
        def schema = params[schemaId];
        if (schema != null) {
          if (ctx.event == null) {
            ctx.event = new HashMap();
          }
          ctx.event.code = schema;
        }
  - set:
      tag: set_event_outcome_8d2e3d55
      field: event.outcome
      value: success
      if: 'ctx.o365audit?.ResultStatus != null && ["succeeded", "success", "partiallysucceeded", "true"].contains(ctx.o365audit?.ResultStatus.toLowerCase())'
  - set:
      tag: set_event_outcome_17b036a7
      field: event.outcome
      value: failure
      if: 'ctx.o365audit?.ResultStatus != null && ["failed", "false"].contains(ctx.o365audit?.ResultStatus.toLowerCase())'
  - set:
      tag: set_event_outcome_d8aaefc7
      field: event.outcome
      value: success
      if: ctx.event?.outcome == null
  - script:
      tag: script_9062a98b
      lang: painless
      if: 'ctx.o365audit?.Parameters != null && ctx.o365audit?.Parameters instanceof List'
      source: >
        def newparams = new HashMap(); 
        def oldparams = ctx.o365audit.Parameters;
        for (int i = 0; i < oldparams.length; ++i) {
          if (oldparams[i]["Value"] != null) {
            newparams[oldparams[i]["Name"]] = oldparams[i]["Value"];
          }
        }
        ctx.o365audit.Parameters = newparams;
  - rename:
      tag: rename_o365audit_Parameters_to_o365audit_Parameters__raw_295c4311
      field: o365audit.Parameters
      target_field: o365audit.Parameters._raw
      if: 'ctx.o365audit?.Parameters != null && ctx.o365audit?.Parameters instanceof String'
  - grok:
      tag: grok_o365audit_Parameters__raw_12faafdd
      field: o365audit.Parameters._raw
      if: ctx.o365audit?.NetworkMessageId == null || ctx.o365audit.NetworkMessageId == ''
      patterns:
        - '^-?Identity\s"?%{DATA:o365audit.NetworkMessageId}"?$'
      ignore_missing: true
      ignore_failure: true

  - script:
      lang: painless
      tag: collect_email_to_addresses_from_parameters
      source: >
        void splitTrimAdd(Set acc, String str) {
            if (str != null && str != '') {
                String[] parts = str.splitOnToken(';');
                for (int i = 0; i < parts.length; i++) {
                    acc.add(parts[i].trim());
                }
            }
        }

        def addressSet = new HashSet(ctx.email?.to?.address ?: []);

        splitTrimAdd(addressSet, ctx.o365audit?.Parameters?.ForwardAsAttachmentTo);
        splitTrimAdd(addressSet, ctx.o365audit?.Parameters?.ForwardTo);
        splitTrimAdd(addressSet, ctx.o365audit?.Parameters?.RedirectTo);

        if (!addressSet.isEmpty()) {
          ctx.email = ctx.email ?: [:];
          ctx.email.to = ctx.email.to ?: [:];
          ctx.email.to.address = addressSet.asList();
        }
  - set:
      tag: set_email_from_address_224df4c7
      field: email.from.address
      copy_from: o365audit.Parameters.From
      ignore_empty_value: true

  - script:
      tag: script_fb390089
      if: ctx.o365audit?.Platform != null
      lang: painless
      params:
        # Based on `Aip*.md` files in
        # https://github.com/MicrosoftDocs/office-365-management-api/tree/20763d/office-365-management-api
        "0": "Unknown"
        "1": "Windows"
        "2": "MacOS"
        "3": "iOS"
        "4": "Android"
        "5": "Web Browser"
      source: >
        def value = ctx.o365audit.Platform.toString();
        def name = params[value];
        if (name != null) {
          ctx.o365audit.Platform = name;
        }
  - script:
      lang: painless
      tag: script_to_set_host_os_type
      description: Script to set host_os_type.
      if: ctx.o365audit?.Platform != null
      source: |
        ctx.host = ctx.host ?: [:];
        ctx.host.os = ctx.host.os ?: [:];
        String lcPlatform = ctx.o365audit.Platform.toLowerCase();
        if (lcPlatform.contains('windows')) {
            ctx.host.os.type = 'windows';
        } else if (lcPlatform.contains('linux')) {
            ctx.host.os.type = 'linux';
        } else if (lcPlatform.contains('mac')) {
            ctx.host.os.type = 'macos';
        } else if (lcPlatform.contains('unix')) {
            ctx.host.os.type = 'unix';
        } else if (lcPlatform.contains('ios')) {
            ctx.host.os.type = 'ios';
        } else if (lcPlatform.contains('android')) {
            ctx.host.os.type = 'android';
        }
  - lowercase:
      field: host.os.type
      tag: lowercase_host_os_type
      ignore_missing: true
  - set:
      field: host.os.platform
      tag: set_host_os_platform_frin_platform
      copy_from: o365audit.Platform
      ignore_empty_value: true
  - script:
      tag: script_3607a99b
      lang: painless
      if: 'ctx.o365audit?.ExtendedProperties != null && ctx.o365audit?.ExtendedProperties instanceof List'
      source: >
        def newparams = new HashMap(); 
        def oldparams = ctx.o365audit.ExtendedProperties;
        for (int i = 0; i < oldparams.length; ++i) {
          if (oldparams[i]["Value"] != null) {
            newparams[oldparams[i]["Name"]] = oldparams[i]["Value"];
          }
        }
        ctx.o365audit.ExtendedProperties = newparams;
  - rename:
      tag: rename_o365audit_ExtendedProperties_to_o365audit_ExtendedProperties__raw_7bf8bce9
      field: o365audit.ExtendedProperties
      target_field: o365audit.ExtendedProperties._raw
      if: 'ctx.o365audit?.ExtendedProperties != null && ctx.o365audit?.ExtendedProperties instanceof String'
  - script:
      tag: script_fc4d1742
      lang: painless
      if: 'ctx.o365audit?.ModifiedProperties != null && ctx.o365audit?.ModifiedProperties instanceof List'
      source: >
        def newparams = new HashMap(); 
        def oldparams = ctx.o365audit.ModifiedProperties;
        for (int i = 0; i < oldparams.length; ++i) {
          if (oldparams[i] instanceof Map && oldparams[i]["OldValue"] != null && oldparams[i]["NewValue"] != null) {
            def validname = oldparams[i]["Name"].replace(" ","_").replace(".","_");
            newparams[validname] = new HashMap();
            newparams[validname]["NewValue"] = oldparams[i]["NewValue"];
            newparams[validname]["OldValue"] = oldparams[i]["OldValue"];
          }
          if (oldparams[i] instanceof String) {
            def validname = oldparams[i].replace(" ","_").replace(".","_");
            newparams[validname] = new HashMap();
          }
        }
        if (newparams.isEmpty()) {
          ctx.o365audit.remove("ModifiedProperties");
          return;
        }
        ctx.o365audit.ModifiedProperties = newparams;
  - rename:
      tag: rename_o365audit_ModifiedProperties_to_o365audit_ModifiedProperties__raw_c4286e95
      field: o365audit.ModifiedProperties
      target_field: o365audit.ModifiedProperties._raw
      if: 'ctx.o365audit?.ModifiedProperties != null && ctx.o365audit?.ModifiedProperties instanceof String'
  - script:
      tag: script_39009c18
      lang: painless
      if: 'ctx.o365audit?.AlertLinks != null && ctx.o365audit?.AlertLinks instanceof List'
      source: >
        def list = ctx.o365audit.AlertLinks;
        def links = new ArrayList();
        for (int i = 0; i < list.length; ++i) {
          if (list[i] instanceof Map && list[i].containsKey("AlertLinkHref") && list[i]["AlertLinkHref"] != null && list[i]["AlertLinkHref"] instanceof String) {
            links.add(list[i]["AlertLinkHref"]);
          }
        }
        if (links.length == 0) {
          ctx.o365audit.remove("AlertLinks");
          return;
        }
        ctx.o365audit.AlertLinks = links;
  - set:
      tag: set_event_severity_2835f311
      field: event.severity
      value: 1
      if: ctx.o365audit?.Severity == "informational"
  - set:
      tag: set_event_severity_c5e2dc47
      field: event.severity
      value: 2
      if: ctx.o365audit?.Severity == "low"
  - set:
      tag: set_event_severity_1aacabd3
      field: event.severity
      value: 3
      if: ctx.o365audit?.Severity == "medium"
  - set:
      tag: set_event_severity_bebbae7b
      field: event.severity
      value: 4
      if: ctx.o365audit?.Severity == "high"
  # ExchangeAdmin Schema
  - rename:
      field: o365audit.OrganizationName
      target_field: organization.name
      ignore_missing: true
      if: ctx.event?.code == "ExchangeAdmin"
      tag: rename_organization_name
      on_failure:
        - append:
            tag: append_error_message_6ea83e06
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      tag: rename_o365audit_OriginatingServer_to_server__temp_f1e22f12
      field: o365audit.OriginatingServer
      target_field: server._temp
      ignore_missing: true
      if: ctx.event?.code == "ExchangeAdmin"
  # ExchangeItem Schema
  - append:
      tag: append_event_category_61a49432
      field: event.category
      value: email
      if: ctx.event?.code == "ExchangeItem"
  - rename:
      tag: rename_o365audit_MailboxOwnerUPN_to_user_email_62fc4d51
      field: o365audit.MailboxOwnerUPN
      target_field: user.email
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  - convert:
      tag: convert_o365audit_LogonUserSid_to_user_id_0c48c9b2
      field: o365audit.LogonUserSid
      target_field: user.id
      type: string
      ignore_missing: true
      if: 'ctx.user?.id == null && ctx.o365audit?.LogonUserSid != null && ctx.event?.code == "ExchangeItem"'
  - rename:
      tag: rename_o365audit_LogonUserDisplayName_to_user_full_name_3b466445
      field: o365audit.LogonUserDisplayName
      target_field: user.full_name
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  - rename:
      field: o365audit.OrganizationName
      target_field: organization.name
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
      tag: rename_organization_name_exchange_item
      on_failure:
        - append:
            tag: append_error_message_eb6e85b4
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - rename:
      tag: rename_o365audit_OriginatingServer_to_server__temp_5e826fba
      field: o365audit.OriginatingServer
      target_field: server._temp
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  - rename:
      tag: rename_o365audit_ClientIPAddress_to_client__temp_d1adf9ea
      field: o365audit.ClientIPAddress
      target_field: client._temp
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  - rename:
      tag: rename_o365audit_ClientProcessName_to_process_name_e56e4e0b
      field: o365audit.ClientProcessName
      target_field: process.name
      ignore_missing: true
      if: ctx.event?.code == "ExchangeItem"
  # AzureActiveDirectory Schema
  - set:
      tag: set_user_target_id_d467d782
      field: user.target.id
      copy_from: o365audit.ObjectId
      if: ctx.event?.code == "AzureActiveDirectory"
  ## AzureActiveDirectory Schema new user
  - set:
      tag: set_event_action_8f668a10
      field: event.action
      value: added-user-account
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "Add user."'
  - append:
      tag: append_event_category_82505a27
      field: event.category
      value: iam
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "added-user-account"'
  - append:
      tag: append_event_type_03ac408d
      field: event.type
      value: user
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "added-user-account"'
  - append:
      tag: append_event_type_8b4ec7c3
      field: event.type
      value: creation
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "added-user-account"'
  ## AzureActiveDirectory Schema update user
  - set:
      tag: set_event_action_30d51a99
      field: event.action
      value: modified-user-account
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "Update user."'
  - append:
      tag: append_event_category_9c8dae40
      field: event.category
      value: iam
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "modified-user-account"'
  - append:
      tag: append_event_type_34e560a4
      field: event.type
      value: user
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "modified-user-account"'
  - append:
      tag: append_event_type_93a119d1
      field: event.type
      value: change
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "modified-user-account"'
  ## AzureActiveDirectory Schema delete user
  - set:
      tag: set_event_action_3aeaab35
      field: event.action
      value: deleted-user-account
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "Delete user."'
  - append:
      tag: append_event_category_f1ea27d8
      field: event.category
      value: iam
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "deleted-user-account"'
  - append:
      tag: append_event_type_fecba03c
      field: event.type
      value: user
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "deleted-user-account"'
  - append:
      tag: append_event_type_02cc398f
      field: event.type
      value: deletion
      if: 'ctx.event?.code == "AzureActiveDirectory" && ctx.event?.action == "deleted-user-account"'
  # AzureActiveDirectoryStsLogon Schema
  - append:
      tag: append_event_category_5f1fd4bf
      field: event.category
      value: authentication
      if: ctx.event?.code == "AzureActiveDirectoryStsLogon"
  - append:
      tag: append_event_type_c71e78a9
      field: event.type
      value: start
      if: ctx.event?.code == "AzureActiveDirectoryStsLogon"
  - append:
      tag: append_event_type_72cb1b6d
      field: event.type
      value: access
      if: 'ctx.event?.code == "AzureActiveDirectoryStsLogon"'
  # SharePointFileOperation and SharePointSharingOperation Schemas
  - rename:
      tag: rename_o365audit_ObjectId_to_url_original_3692071d
      field: o365audit.ObjectId
      target_field: url.original
      ignore_missing: true
      if: ctx.event?.code != null && ["SharePointFileOperation", "SharePointSharingOperation"].contains(ctx.event.code)
  - rename:
      tag: rename_o365audit_SourceRelativeUrl_to_file_directory_b37fb5b4
      field: o365audit.SourceRelativeUrl
      target_field: file.directory
      ignore_missing: true
      if: ctx.event?.code != null && ["SharePointFileOperation", "SharePointSharingOperation"].contains(ctx.event.code)
  - rename:
      tag: rename_o365audit_SourceFileName_to_file_name_af0359ee
      field: o365audit.SourceFileName
      target_field: file.name
      ignore_missing: true
      if: ctx.event?.code != null && ["SharePointFileOperation", "SharePointSharingOperation"].contains(ctx.event.code)
  - rename:
      tag: rename_o365audit_SourceFileExtension_to_file_extension_f3b7d0c0
      field: o365audit.SourceFileExtension
      target_field: file.extension
      ignore_missing: true
      if: ctx.event?.code != null && ["SharePointFileOperation", "SharePointSharingOperation"].contains(ctx.event.code)
  - append:
      tag: append_event_category_13dd4fae
      field: event.category
      value: file
      if: 'ctx.event?.action != null && ["FileAccessed", "FileDeleted", "FileDownloaded", "FileModified", "FileMoved", "FileRenamed", "FileRestored", "FileUploaded", "FolderCopied", "FolderCreated", "FolderDeleted", "FolderModified", "FolderMoved", "FolderRenamed", "FolderRestored"].contains(ctx.event?.action)'
  - append:
      tag: append_event_category_377511c6
      field: event.category
      value: configuration
      if: ctx.event?.action == "ComplianceSettingChanged"
  - append:
      tag: append_event_type_ba7ade54
      field: event.type
      value: access
      if: 'ctx.event?.action != null && ["FileAccessed", "FileDownloaded"].contains(ctx.event?.action)'
  - append:
      tag: append_event_type_0f9f6fa9
      field: event.type
      value: change
      if: 'ctx.event?.action != null && ["ComplianceSettingChanged", "FileModified", "FileMoved", "FileRenamed", "FileRestored", "FolderModified", "FolderMoved", "FolderRenamed", "FolderRestored"].contains(ctx.event?.action)'
  - append:
      tag: append_event_type_8003d15e
      field: event.type
      value: deletion
      if: 'ctx.event?.action != null && ["FileDeleted", "FolderDeleted"].contains(ctx.event?.action)'
  - append:
      tag: append_event_type_724ad465
      field: event.type
      value: creation
      if: 'ctx.event?.action != null && ["FileUploaded", "FolderCopied", "FolderCreated"].contains(ctx.event?.action)'
  # SecurityComplianceAlerts Schema
  - set:
      tag: set_message_186a70fd
      field: message
      copy_from: o365audit.Name
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      tag: rename_o365audit_Name_to_rule_name_b2f6f228
      field: o365audit.Name
      target_field: rule.name
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      tag: rename_o365audit_PolicyId_to_rule_id_07f34602
      field: o365audit.PolicyId
      target_field: rule.id
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      tag: rename_o365audit_Category_to_rule_category_00c3c3bc
      field: o365audit.Category
      target_field: rule.category
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      tag: rename_o365audit_EntityType_to_rule_ruleset_2a437e65
      field: o365audit.EntityType
      target_field: rule.ruleset
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      tag: rename_o365audit_AlertEntityId_to_rule_description_b2d408c4
      field: o365audit.AlertEntityId
      target_field: rule.description
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - rename:
      tag: rename_o365audit_AlertLinks_to_rule_reference_26448414
      field: o365audit.AlertLinks
      target_field: rule.reference
      ignore_missing: true
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - set:
      tag: set_event_kind_167186ea
      field: event.kind
      value: alert
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - append:
      tag: append_event_category_5cd75b68
      field: event.category
      value: authentication
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.o365audit?.Category == "AccessGovernance"'
  - append:
      tag: append_event_category_acfdbc8e
      field: event.category
      value: file
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.o365audit?.Category != null && ["DataGovernance", "DataLossPrevention"].contains(ctx.o365audit?.Category)'
  - append:
      tag: append_event_category_da0f4aa2
      field: event.category
      value: malware
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.o365audit?.Category == "ThreatManagement"'
  - append:
      tag: append_event_category_61810389
      field: event.category
      value: authentication
      allow_duplicates: false
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.o365audit?.Category != null && !["DataGovernance", "DataLossPrevention", "ThreatManagement", "AccessGovernance"].contains(ctx.o365audit?.Category)'
  - append:
      tag: append_event_category_477f0e67
      field: event.category
      value: web
      allow_duplicates: false
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - append:
      tag: append_event_type_fe5e902b
      field: event.type
      value: info
      allow_duplicates: false
      if: ctx.event?.code == "SecurityComplianceAlerts"
  - convert:
      tag: convert_o365audit_AlertEntityId_to_user_id_83931794
      field: o365audit.AlertEntityId
      target_field: user.id
      type: string
      ignore_missing: true
      if: 'ctx.user?.id == null && ctx.event?.code == "SecurityComplianceAlerts" && ctx.rule?.ruleset == "User"'
  - rename:
      tag: rename_o365audit_AlertEntityId_to_user_email_a7322129
      field: o365audit.AlertEntityId
      target_field: user.email
      ignore_missing: true
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.rule?.ruleset != null && ["Recipients", "Sender"].contains(ctx.rule?.ruleset)'
  - rename:
      tag: rename_o365audit_AlertEntityId_to_threat_technique_id_11e017e6
      field: o365audit.AlertEntityId
      target_field: threat.technique.id
      ignore_missing: true
      if: 'ctx.event?.code == "SecurityComplianceAlerts" && ctx.rule?.ruleset == "MalwareFamily"'
  # DLP Schema
  - script:
      lang: painless
      description: Construct a message from operation, user and subject fields for 'ComplianceDLPExchange' events
      tag: construct_message_for_compliance_dlp_exchange_events
      if: ctx.event?.code == "ComplianceDLPExchange"
      source: >
        def operation = ctx.event?.action ?: '';
        def user = ctx.user?.id ?: '';
        def subject = ctx.o365audit?.ExchangeMetaData?.Subject ?: ctx.email?.subject ?: '';

        if (operation.isEmpty() && user.isEmpty() && subject.isEmpty()) {
          ctx.message = "Office365 Alert";
        } else {
          ctx.message = "Office365 Alert: " + operation + " detected in email sent by " + user + " with subject '" + subject + "'";
        }
  - set:
      tag: set_event_kind_0865c760
      field: event.kind
      value: alert
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - append:
      tag: append_event_category_91227162
      field: event.category
      value: file
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - append:
      tag: append_event_type_a59a610a
      field: event.type
      value: access
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_SharePointMetaData_From_to_user_id_e7728609
      field: o365audit.SharePointMetaData.From
      target_field: user.id
      ignore_missing: true
      if: 'ctx.user?.id == null && ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_SharePointMetaData_FileName_to_file_name_4c06a6ee
      field: o365audit.SharePointMetaData.FileName
      target_field: file.name
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_SharePointMetaData_FilePathUrl_to_url_original_9628c8ba
      field: o365audit.SharePointMetaData.FilePathUrl
      target_field: url.original
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_SharePointMetaData_UniqueId_to_file_inode_f95b5147
      field: o365audit.SharePointMetaData.UniqueId
      target_field: file.inode
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_SharePointMetaData_UniqueID_to_file_inode_4ad77667
      field: o365audit.SharePointMetaData.UniqueID
      target_field: file.inode
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_SharePointMetaData_FileOwner_to_file_owner_c6d08a02
      field: o365audit.SharePointMetaData.FileOwner
      target_field: file.owner
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_ExchangeMetaData_From_to_source_user_email_400b8d42
      field: o365audit.ExchangeMetaData.From
      target_field: source.user.email
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_PolicyId_to_rule_id_68b29bc0
      field: o365audit.PolicyId
      target_field: rule.id
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - rename:
      tag: rename_o365audit_PolicyName_to_rule_name_894b1338
      field: o365audit.PolicyName
      target_field: rule.name
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
  - date:
      tag: date_o365audit_SharePointMetaData_LastModifiedTime_to_file_mtime_031dee9d
      field: o365audit.SharePointMetaData.LastModifiedTime
      target_field: file.mtime
      formats:
        - ISO8601
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code) && ctx.o365audit?.SharePointMetaData?.LastModifiedTime != null'
  - script:
      tag: script_85fa2c9b
      lang: painless
      if: 'ctx.event?.code != null && ctx.o365audit?.ExchangeMetaData!= null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code)'
      source: >
        def fields = new def[] {"To", "CC", "BCC"};
        if (ctx.destination == null) {
          ctx.destination = new HashMap();
        }
        if (ctx.destination.user == null) {
          ctx.destination.user = new HashMap();
        }
        ctx.destination.user.email = new ArrayList();
        for (int i = 0; i < fields.length; ++i) {
          if (ctx.o365audit.ExchangeMetaData instanceof Map && ctx.o365audit.ExchangeMetaData.containsKey(fields[i])) {
            def emails = ctx.o365audit.ExchangeMetaData[fields[i]];
            if (emails instanceof List){
              for (int e = 0; e < emails.length; ++e) {
                ctx.destination.user.email.add(emails[e]);
              }
            }
            if (emails instanceof String){
              ctx.destination.user.email.add(emails);
            }
          }
        }
  - rename:
      tag: rename_o365audit_ExceptionInfo_to_o365audit_ExceptionInfo_Reason_4631306e
      field: o365audit.ExceptionInfo
      target_field: o365audit.ExceptionInfo.Reason
      ignore_missing: true
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code) && ctx.o365audit?.ExceptionInfo != null && ctx.o365audit?.ExceptionInfo instanceof String'
  - script:
      tag: script_3a5b43dc
      lang: painless
      if: 'ctx.event?.code != null && ["ComplianceDLPSharePoint", "ComplianceDLPExchange"].contains(ctx.event?.code) && ctx.o365audit?.PolicyDetails != null'
      source: >
        int severityToCode(def x) { 
          if (x.toLowerCase() == "informational") {
            return 1;
          }
          if (x.toLowerCase() == "low") {
            return 2;
          }
          if (x.toLowerCase() == "medium") {
            return 3;
          }
          if (x.toLowerCase() == "high") {
            return 4;
          }
          return 0;
        }
        def policies = ctx.o365audit.PolicyDetails;
        if (policies == null) {
          return;
        }
        if (ctx.rule == null) {
          ctx.rule = new HashMap();
        }
        if (ctx.rule.id == null) {
          ctx.rule.id = new ArrayList();
        }
        if (ctx.rule.name == null) {
          ctx.rule.name = new ArrayList();
        }
        def maxSeverity = 0;
        def allowed = true;
        for (int i = 0; i < policies.length && policies instanceof List; ++i) {
          def rules = policies[i].Rules;
          if (rules == null) {
            continue;
          }
          for (int j = 0; j < rules.length; ++j) {
            def rule = rules[j];
            def id = rule.RuleId;
            def name = rule.RuleName;
            def sev = severityToCode(rule.Severity);
            if (id != null && name != null) {
              ctx.rule.id.add(id);
              ctx.rule.name.add(name);
            }
            if (sev > maxSeverity) {
              maxSeverity = sev;
            }
            if (allowed) {
              if (rule.Actions != null && rule.Actions.contains("BlockAccess")) {
                allowed = false;
              }
            }
          }
        }
        if (maxSeverity > -1) {
          ctx.event.severity = maxSeverity;
        }
        if (allowed) {
          ctx.event.outcome = "success";
          return;
        }
        if (ctx.event?.action == "DlpRuleUndo") {
          ctx.event.outcome = "success";
          return;
        }
        if (ctx.event?.action == "DlpInfo") {
          ctx.event.outcome = "failure";
          return;
        }
        if (ctx.o365audit?.ExceptionInfo != null && !ctx.o365audit?.ExceptionInfo.isEmpty()) {
          ctx.event.outcome = "success";
          return;
        }
        ctx.event.outcome = "failure";
  # Yammer Schema
  - rename:
      tag: rename_o365audit_ActorUserId_to_user_email_5bb083f5
      field: o365audit.ActorUserId
      target_field: user.email
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - convert:
      tag: convert_o365audit_ActorYammerUserId_to_user_id_a114ca12
      field: o365audit.ActorYammerUserId
      target_field: user.id
      type: string
      ignore_missing: true
      if: 'ctx.user?.id == null && ctx.event?.code == "Yammer"'
  - rename:
      tag: rename_o365audit_FileId_to_file_inode_c45b06ed
      field: o365audit.FileId
      target_field: file.inode
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - rename:
      tag: rename_o365audit_FileName_to_file_name_c8840547
      field: o365audit.FileName
      target_field: file.name
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - rename:
      tag: rename_o365audit_GroupName_to_group_name_e1775675
      field: o365audit.GroupName
      target_field: group.name
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - rename:
      tag: rename_o365audit_TargetUserId_to_destination_user_email_598cdaed
      field: o365audit.TargetUserId
      target_field: destination.user.email
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - script:
      tag: script_d6527ed5
      description: Ensure that user IDs are not rendered with e-notation, general fallback for all other cases.
      if: ctx.o365audit?.TargetYammerUserId != null
      source: |-
        if (ctx.o365audit.TargetYammerUserId instanceof double) {
          ctx.o365audit.TargetYammerUserId = ((long)ctx.o365audit.TargetYammerUserId).toString();
        } else {
          ctx.o365audit.TargetYammerUserId = ctx.o365audit.TargetYammerUserId.toString();
        }
  - rename:
      tag: rename_o365audit_TargetYammerUserId_to_destination_user_id_98d0b8d9
      field: o365audit.TargetYammerUserId
      target_field: destination.user.id
      ignore_missing: true
      if: ctx.event?.code == "Yammer"
  - append:
      tag: append_event_category_366e32c5
      field: event.category
      value: configuration
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["NetworkConfigurationUpdated", "NetworkSecurityConfigurationUpdated", "SoftDeleteSettingsUpdated", "ProcessProfileFields", "SupervisorAdminToggled"].contains(ctx.event?.action)'
  - append:
      tag: append_event_category_c033009f
      field: event.category
      value: iam
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["NetworkSecurityConfigurationUpdated", "GroupCreation", "GroupDeletion", "NetworkUserSuspended", "UserSuspension"].contains(ctx.event?.action)'
  - append:
      tag: append_event_category_27bfceb1
      field: event.category
      value: file
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["FileCreated", "FileDownloaded", "FileShared", "FileUpdateDescription", "FileUpdateName", "FileVisited"].contains(ctx.event?.action)'
  - append:
      tag: append_event_type_2b41531d
      field: event.type
      value: change
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["NetworkConfigurationUpdated", "NetworkSecurityConfigurationUpdated", "SoftDeleteSettingsUpdated", "ProcessProfileFields", "SupervisorAdminToggled"].contains(ctx.event?.action)'
  - append:
      tag: append_event_type_d8ce5e45
      field: event.type
      value: admin
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action == "NetworkSecurityConfigurationUpdated"'
  - append:
      tag: append_event_type_ead8ad31
      field: event.type
      value: creation
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["FileCreated", "GroupCreation", "FileUpdateName"].contains(ctx.event?.action)'
  - append:
      tag: append_event_type_6f0a866a
      field: event.type
      value: deletion
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action == "GroupDeletion"'
  - append:
      tag: append_event_type_ec95401b
      field: event.type
      value: access
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["FileDownloaded", "FileShared", "FileUpdateDescription", "FileVisited"].contains(ctx.event?.action)'
  - append:
      tag: append_event_type_143833ec
      field: event.type
      value: group
      if: 'ctx.event?.code == "Yammer" && ctx.event?.action != null && ["GroupCreation", "GroupDeletion"].contains(ctx.event?.action)'
  # Teams Schema
  - set:
      tag: set_event_action_5d374665
      field: event.action
      value: added-group-account-to
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "TeamCreated"'
  - append:
      tag: append_event_category_fa455d05
      field: event.category
      value: iam
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-group-account-to"'
  - append:
      tag: append_event_type_7affef37
      field: event.type
      value: group
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-group-account-to"'
  - append:
      tag: append_event_type_d89ac66d
      field: event.type
      value: creation
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-group-account-to"'
  - rename:
      tag: rename_o365audit_TeamName_to_group_name_378e2c8a
      field: o365audit.TeamName
      target_field: group.name
      ignore_missing: true
      if: ctx.event?.code == "MicrosoftTeams"
  - set:
      tag: set_event_action_8f33bc25
      field: event.action
      value: added-users-to-group
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "MemberAdded"'
  - append:
      tag: append_event_category_941fbbae
      field: event.category
      value: iam
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-users-to-group"'
  - append:
      tag: append_event_type_53947cc0
      field: event.type
      value: group
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-users-to-group"'
  - append:
      tag: append_event_type_09482fdf
      field: event.type
      value: change
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "added-users-to-group"'
  - set:
      tag: set_event_action_e7ba1ac3
      field: event.action
      value: deleted-user-account
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "Delete user."'
  - append:
      tag: append_event_category_304faba2
      field: event.category
      value: iam
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "deleted-user-account"'
  - append:
      tag: append_event_type_3ae43002
      field: event.type
      value: user
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "deleted-user-account"'
  - append:
      tag: append_event_type_59798eb5
      field: event.type
      value: deletion
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "deleted-user-account"'
  - rename:
      tag: rename_o365audit_ObjectId_to_user_target_id_05fee056
      field: o365audit.ObjectId
      target_field: user.target.id
      ignore_missing: true
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.event?.action == "deleted-user-account"'
  - script:
      tag: script_ee9fc2d4
      lang: painless
      if: 'ctx.event?.code == "MicrosoftTeams" && ctx.o365audit?.Members != null && ctx.o365audit.Members instanceof List'
      source: >
        def members = ctx.o365audit?.Members;
        if (ctx.related == null) {
          ctx.related = new HashMap();
        }
        if (ctx.related.user == null) {
          ctx.related.user = new ArrayList();
        }
        for (int i = 0; i < members.length; ++i) {
          if (members[i] instanceof Map && members[i].containsKey("UPN") && !members[i]["UPN"].isEmpty()) {
            ctx.related.user.add(members[i]["UPN"]);
          }
        }
  - gsub:
      tag: extract_ipv4_and_port
      field: client._temp
      pattern: '^\[?::ffff:([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)(?:\](:[0-9]+)?)?$'
      replacement: '$1$2'
      ignore_missing: true
  - grok:
      tag: grok_client__temp_18e2100e
      field: client._temp
      patterns:
        - '%{IPANDPORTBRACKETS}'
        - '^%{IP:client.address}$'
        - '^\[%{IP:client.address}\]$'
        - '%{IPANDPORT}'
        - '^%{NOTSPACE:client.domain}$'
        - '%{HOSTNAMEANDPORTBRACKETS}'
        - '%{HOSTNAMEANDPORT}'
        - '^\[%{HOSTNAMEANDIP}\]$'
        - '^%{HOSTNAMEANDIP}$'
        - '%{GREEDYDATA:client.address}'
      pattern_definitions:
        IPANDPORTBRACKETS: '^\[%{IP:client.address}\]:%{POSINT:client._port}'
        IPANDPORT: '^%{IP:client.address}:%{POSINT:client._port}'
        HOSTNAMEANDPORTBRACKETS: '^\[%{NOTSPACE:client.domain}\]:%{POSINT:client._port}'
        HOSTNAMEANDPORT: '^%{NOTSPACE:client.domain}:%{POSINT:client._port}'
        NOTCLOSINGPARENS: '[^)]*'
        HOSTNAMEANDIP: '%{NOTSPACE:client.domain} \(%{NOTCLOSINGPARENS:client.address}\)'
      if: 'ctx.client?._temp != null && !ctx.client?._temp.isEmpty()'
  - gsub:
      tag: gsub_server__temp_e8014e71
      field: server._temp
      pattern: "[\n\r]"
      replacement: ""
      ignore_missing: true
  - grok:
      tag: grok_server__temp_1e56357a
      field: server._temp
      patterns:
        - '^\[%{HOSTNAMEANDIP}\]$'
        - '%{HOSTNAMEANDIP}'
        - '%{GREEDYDATA:server.address}'
      pattern_definitions:
        NOTCLOSINGPARENS: '[^)]*'
        HOSTNAMEANDIP: '%{NOTSPACE:server.domain} \(%{NOTCLOSINGPARENS:server.address}\)'
      if: 'ctx.server?._temp != null && !ctx.server?._temp.isEmpty()'
      ignore_failure: true
  - convert:
      tag: convert_client_address_to_client_ip_c25a437d
      field: client.address
      target_field: client.ip
      type: ip
      ignore_failure: true
  - convert:
      tag: convert_client__port_to_client_port_6d29f17e
      field: client._port
      target_field: client.port
      type: long
      ignore_missing: true
  - convert:
      tag: convert_server_address_to_server_ip_cd8f255d
      field: server.address
      target_field: server.ip
      type: ip
      ignore_failure: true
  - remove:
      tag: remove_41349f89
      field:
        - client._port
        - client._temp
        - server._temp
      ignore_missing: true
  - set:
      tag: set_source_ip_fb72ffcf
      field: source.ip
      copy_from: client.ip
      if: ctx.client?.ip != null
  - set:
      tag: set_source_port_5d1dfb1d
      field: source.port
      copy_from: client.port
      if: ctx.client?.port != null
  - set:
      tag: set_destination_ip_c1908e48
      field: destination.ip
      copy_from: server.ip
      if: ctx.server?.ip != null
  - script:
      tag: script_c0e5055d
      lang: painless
      if: 'ctx.user?.id instanceof String && ctx.user?.id.contains("@")'
      source: >
        String[] splitmail = ctx.user.id.splitOnToken("@");
        if (splitmail.length != 2) {
          return;
        }
        ctx.user.email = ctx.user.id;
        ctx.user.domain = splitmail[1];
        ctx.user.name = splitmail[0];
  - script:
      tag: script_5cc6a2b4
      lang: painless
      if: 'ctx.user?.target?.id instanceof String && ctx.user?.target?.id.contains("@")'
      source: >
        String[] splitmail = ctx.user.target.id.splitOnToken("@");
        if (splitmail.length != 2) {
          return;
        }
        ctx.user.target.email = ctx.user.target.id;
        ctx.user.target.domain = splitmail[1];
        ctx.user.target.name = splitmail[0];
  - script:
      tag: script_afa68d08
      lang: painless
      if: 'ctx.source?.user?.id instanceof String && ctx.source?.user?.id.contains("@")'
      source: >
        String[] splitmail = ctx.source.user.id.splitOnToken("@");
        if (splitmail.length != 2) {
          return;
        }
        ctx.source.user.email = ctx.source.user.id;
        ctx.source.user.domain = splitmail[1];
        ctx.source.user.name = splitmail[0];
  - script:
      tag: script_64d610c3
      lang: painless
      if: 'ctx.destination?.user?.id instanceof String && ctx.destination?.user?.id.contains("@")'
      source: >
        String[] splitmail = ctx.destination.user.id.splitOnToken("@");
        if (splitmail.length != 2) {
          return;
        }
        ctx.destination.user.email = ctx.destination.user.id;
        ctx.destination.user.domain = splitmail[1];
        ctx.destination.user.name = splitmail[0];
  - set:
      tag: set_network_type_165f3eef
      field: network.type
      value: ipv6
      if: 'ctx.client?.ip instanceof String && ctx.client?.ip.contains(":")'
  - set:
      tag: set_network_type_8c345870
      field: network.type
      value: ipv4
      if: 'ctx.network?.type == null && ctx.client?.ip != null'
  - append:
      tag: append_related_ip_3726c45d
      field: related.ip
      value: "{{{client.ip}}}"
      allow_duplicates: false
      if: ctx.client?.ip != null
  - append:
      tag: append_related_ip_c3acf835
      field: related.ip
      value: "{{{server.ip}}}"
      allow_duplicates: false
      if: ctx.server?.ip != null
  - append:
      tag: append_related_user_837e080f
      field: related.user
      value: "{{{user.name}}}"
      allow_duplicates: false
      if: ctx.user?.name != null
  - append:
      tag: append_related_user_be5e9d5c
      field: related.user
      value: "{{{user.target.name}}}"
      allow_duplicates: false
      if: ctx.user?.target?.name != null
  - append:
      tag: append_related_user_306b5d7f
      field: related.user
      value: "{{{file.owner}}}"
      allow_duplicates: false
      if: ctx.file?.owner != null
  - append:
      tag: append_related_user_019a4c76
      field: related.user
      value: "{{{o365audit.Parameters.User}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Parameters?.User != null
  - rename:
      tag: rename_o365audit_ExtendedProperties_UserAgent_to_user_agent_original_f69176bb
      field: o365audit.ExtendedProperties.UserAgent
      target_field: user_agent.original
      ignore_missing: true
      if: ctx.o365audit?.ExtendedProperties?.UserAgent != null
  # Add Host and Organization fields
  - lowercase:
      tag: lowercase_organization_id_166f7d8e
      field: organization.id
      ignore_missing: true
      ignore_failure: true
  - set:
      tag: set_host_id_821997c4
      field: host.id
      copy_from: organization.id
      if: ctx.organization instanceof Map && ctx.organization?.id != null
  - script:
      tag: script_9a7a1e0a
      lang: painless
      if: ctx.organization instanceof Map && ctx.organization?.id != null && ctx._conf?.tenants != null
      source: >
        def conftenants = ctx._conf.tenants;
        def orgid = ctx.organization.id;
        if (conftenants instanceof Map && conftenants.containsKey(orgid)) {
          ctx.organization.name = conftenants[orgid];
        }
  - set:
      tag: set_host_name_e036e1a2
      field: host.name
      copy_from: o365audit.DeviceName
      if: ctx.o365audit?.DeviceName != null && ctx.host?.name == null
  - set:
      tag: set_host_name_593179ac
      field: host.name
      copy_from: organization.name
      if: ctx.organization instanceof Map && ctx.organization?.name != null && ctx.host?.name == null
  - set:
      tag: set_host_name_492f492c
      field: host.name
      copy_from: user.domain
      if: ctx.user?.domain != null && ctx.host?.name == null
  # Convert field values
  - convert:
      tag: convert_o365audit_AzureActiveDirectoryEventType_82b67126
      field: o365audit.AzureActiveDirectoryEventType
      type: string
      ignore_missing: true
  - convert:
      tag: convert_o365audit_RecordType_2ef06f8d
      field: o365audit.RecordType
      type: string
      ignore_missing: true
  - convert:
      tag: convert_o365audit_UserType_3067be7b
      field: o365audit.UserType
      type: string
      ignore_missing: true
  - set:
      field: event.provider
      description: UserType contains info about event.provider and not user. Populate event.provider if not already present.
      value: "{{{o365audit.UserType}}}"
      if: ctx.event?.provider == null && ctx.o365audit?.UserType != null && ctx.o365audit.UserType != ''
      tag: set_event_provider
      ignore_empty_value: true
  - foreach:
      tag: foreach_o365audit_Actor_cea9f90a
      field: o365audit.Actor
      if: ctx.o365audit?.Actor instanceof List
      processor:
        convert:
          field: _ingest._value.Type
          tag: convert_actor_type_to_string
          type: string
          ignore_missing: true
  - foreach:
      tag: foreach_o365audit_Target_0a80e51c
      field: o365audit.Target
      if: ctx.o365audit?.Target instanceof List
      processor:
        convert:
          field: _ingest._value.Type
          tag: convert_target_type_to_string
          type: string
          ignore_missing: true
  - script:
      tag: script_cadf6d43
      description: Ensure that versions are not rendered with e-notation, general fallback for all other cases.
      if: ctx.o365audit?.Version != null
      source: |-
        if (ctx.o365audit.Version instanceof double) {
          ctx.o365audit.Version = ((long)ctx.o365audit.Version).toString();
        } else {
          ctx.o365audit.Version = ctx.o365audit.Version.toString();
        }
  - script:
      tag: script_631a7dd5
      description: Ensure that internal logon types are not rendered with e-notation, general fallback for all other cases.
      if: ctx.o365audit?.InternalLogonType != null
      source: |-
        if (ctx.o365audit.InternalLogonType instanceof double) {
          ctx.o365audit.InternalLogonType = ((long)ctx.o365audit.InternalLogonType).toString();
        } else {
          ctx.o365audit.InternalLogonType = ctx.o365audit.InternalLogonType.toString();
        }
  - script:
      tag: script_eab6f972
      description: Ensure that logon types are not rendered with e-notation, general fallback for all other cases.
      if: ctx.o365audit?.LogonType != null
      source: |-
        if (ctx.o365audit.LogonType instanceof double) {
          ctx.o365audit.LogonType = ((long)ctx.o365audit.LogonType).toString();
        } else {
          ctx.o365audit.LogonType = ctx.o365audit.LogonType.toString();
        }
  - script:
      tag: script_2a18231b
      description: Ensure that user IDs are not rendered with e-notation, general fallback for all other cases.
      if: ctx.o365audit?.ActorYammerUserId != null
      source: |-
        if (ctx.o365audit.ActorYammerUserId instanceof double) {
          ctx.o365audit.ActorYammerUserId = ((long)ctx.o365audit.ActorYammerUserId).toString();
        } else {
          ctx.o365audit.ActorYammerUserId = ctx.o365audit.ActorYammerUserId.toString();
        }
  - script:
      tag: script_61d54c44
      description: Ensure that network IDs are not rendered with e-notation, general fallback for all other cases.
      if: ctx.o365audit?.YammerNetworkId != null
      source: |-
        if (ctx.o365audit.YammerNetworkId instanceof double) {
          ctx.o365audit.YammerNetworkId = ((long)ctx.o365audit.YammerNetworkId).toString();
        } else {
          ctx.o365audit.YammerNetworkId = ctx.o365audit.YammerNetworkId.toString();
        }
  - script:
      tag: convert_runningtime
      description: Ensure that RunningTime is not rendered with e-notation or other numeric
      if: ctx.o365audit?.RunningTime != null
      source: |-
        if (ctx.o365audit.RunningTime instanceof double) {
          ctx.o365audit.RunningTime = ((long)ctx.o365audit.RunningTime).toString();
        } else {
          ctx.o365audit.RunningTime = ctx.o365audit.RunningTime.toString();
        }
  - script:
      tag: convert_operationcount
      description: Ensure that OperationCount is rendered as a long
      if: ctx.o365audit?.OperationCount != null
      source: |-
        if (ctx.o365audit.OperationCount instanceof Number) {
          ctx.o365audit.OperationCount = ((Number)ctx.o365audit.OperationCount).longValue();
        }
  - append:
      field: email.message_id
      value: "{{{o365audit.InternetMessageId}}}"
      if: ctx.o365audit?.InternetMessageId != null && ctx.o365audit.InternetMessageId != ''
      tag: append_email_message_id_1
      allow_duplicates: false
  - append:
      field: email.message_id
      value: "{{{o365audit.Item.InternetMessageId}}}"
      if: ctx.o365audit?.Item?.InternetMessageId != null && ctx.o365audit.Item.InternetMessageId != ''
      tag: append_item_internet_message_id_into_email_message_id
      allow_duplicates: false
  - append:
      field: email.local_id
      value: "{{{o365audit.NetworkMessageId}}}"
      if: ctx.o365audit?.NetworkMessageId != null && ctx.o365audit.NetworkMessageId != ''
      tag: append_email_local_id_1
      allow_duplicates: false
  - append:
      field: email.sender.address
      value: "{{{o365audit.P1Sender}}}"
      if: ctx.o365audit?.P1Sender != null && ctx.o365audit.P1Sender != ''
      tag: append_email_sender_address_1
      allow_duplicates: false
  - append:
      field: email.sender.address
      value: "{{{source.user.email}}}"
      if: ctx.source?.user?.email != null && ctx.source.user.email != ''
      tag: append_email_sender_address_from_source
      allow_duplicates: false
  - foreach:
      field: o365audit.Recipients
      if: ctx.o365audit?.Recipients instanceof List && ctx.o365audit.Recipients.length > 0
      tag: foreach_recipient
      processor:
        append:
          field: email.to.address
          value: "{{{_ingest._value}}}"
          tag: append_recipient_to_email_to_address
          allow_duplicates: false
  - foreach:
      field: destination.user.email
      if: ctx.destination?.user?.email instanceof List
      tag: foreach_destination_user_email
      processor:
        append:
          field: email.to.address
          value: "{{{_ingest._value}}}"
          tag: append_destination_user_email_to_to_address
          allow_duplicates: false
  - append:
      tag: append_related_ip_98e499e6
      field: related.ip
      value: "{{{o365audit.SenderIp}}}"
      allow_duplicates: false
      if: ctx.o365audit?.SenderIp != null && ctx.o365audit.SenderIp != ''
  - append:
      tag: append_related_ip_6d425c06
      field: related.ip
      value: "{{{o365audit.SenderIP}}}"
      allow_duplicates: false
      if: ctx.o365audit?.SenderIP != null && ctx.o365audit.SenderIP != ''
  - append:
      field: email.subject
      value: "{{{o365audit.Subject}}}"
      if: ctx.o365audit?.Subject != null && ctx.o365audit.Subject != ''
      tag: append_email_subject_1
      allow_duplicates: false
  - append:
      field: email.subject
      value: "{{{o365audit.Item.Subject}}}"
      if: ctx.o365audit?.Item?.Subject != null && ctx.o365audit.Item.Subject != ''
      tag: append_item_subject_into_email_subject
      allow_duplicates: false
  - script:
      tag: script_item_attachments
      if: ctx.o365audit?.Item?.Attachments != null && ctx.o365audit.Item.Attachments != ''
      description: Parse attachments from Item.Attachments.
      source: |-
        ctx.email = ctx.email ?: [:];
        ctx.email.attachments = [];
        
        // Split semicolon-delimited attachment string into individual attachment entries
        def attachmentList = ctx.o365audit.Item.Attachments.splitOnToken(';');
        
        for (def attachment : attachmentList) {
          def attachmentObj = [:];
          
          // Parse pattern: "filename.extension (sizeb)"
          def matcher = /^(.+?)\.([^.]+)\s*\((\d+)b\)$/.matcher(attachment);
          if (matcher.matches()) {
            attachmentObj.file = [:];
            attachmentObj.file.extension = matcher.group(2);
            attachmentObj.file.name = matcher.group(1) + '.' + matcher.group(2);
            attachmentObj.file.size = Long.parseLong(matcher.group(3));
            ctx.email.attachments.add(attachmentObj);
          } 
        }
      on_failure:
        - append:
            tag: append_error_message_dd78c9ec
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: o365audit.EndTimeUtc
      target_field: o365audit.EndTimeUtc
      tag: date_EndTimeUtc
      timezone: "UTC"
      formats:
        - ISO8601
      if: ctx.o365audit?.EndTimeUtc != null
  - date:
      field: o365audit.LastUpdateTimeUtc
      target_field: o365audit.LastUpdateTimeUtc
      tag: date_LastUpdateTimeUtc
      formats:
        - ISO8601
      if: ctx.o365audit?.LastUpdateTimeUtc != null
  - date:
      field: o365audit.StartTimeUtc
      target_field: o365audit.StartTimeUtc
      tag: date_StartTimeUtc
      formats:
        - ISO8601
      if: ctx.o365audit?.StartTimeUtc != null
  - date:
      field: o365audit.StartTime
      target_field: o365audit.StartTime
      tag: date_StartTime
      formats:
        - ISO8601
      if: ctx.o365audit?.StartTime != null
  - date:
      field: o365audit.FilteringDate
      target_field: o365audit.FilteringDate
      tag: date_FilteringDate
      formats:
        - ISO8601
      if: ctx.o365audit?.FilteringDate != null
  - date:
      field: o365audit.RescanResult.Timestamp
      target_field: o365audit.RescanResult.Timestamp
      tag: date_RescanResult.Timestamp
      formats:
        - ISO8601
      if: ctx.o365audit?.RescanResult?.Timestamp != null
  - gsub:
      field: o365audit.Data
      pattern: ',\"QueryTime\":\"[0-9\/]+\s[0-9]+:[0-9]+:[0-9]+\s[AP]M\"|\"QueryTime\":\"[0-9\/]+\s[0-9]+:[0-9]+:[0-9]+\s[AP]M\",'
      replacement: ""
      if: ctx.o365audit?.containsKey('Data') == true && ctx.o365audit?.RecordType == '64'
      tag: gsub_remove_duplicated_querytime
  - json:
      tag: json_o365audit_Data_73eae5fb
      field: o365audit.Data
      if: ctx.o365audit?.containsKey('Data') == true
      on_failure:
        - remove:
            tag: remove_o365audit_Data_e0fb21bb
            field: o365audit.Data
            ignore_missing: true
            description: remove_malformed_data
  - rename:
      tag: rename_o365audit_Data_to_o365audit_Data_flattened_924e239f
      field: o365audit.Data
      target_field: o365audit.Data.flattened
      ignore_missing: true
  - script:
      description: Copy known Data fields to their explicity mapped locations
      lang: painless
      tag: script_known_Data
      if: 'ctx.o365audit?.Data?.flattened instanceof Map'
      params:
        knownKeys: ['ad', 'af', 'aii', 'ail', 'alk', 'als', 'an', 'at', 'cid', 'cpid', 'dm', 'dpn', 'eid', 'etps', 'etype', 'f3u', 'fvs', 'imsgid', 'lon', 'mat', 'md', 'ms', 'od', 'op', 'ot', 'plk', 'pud', 'reid', 'rid', 'sev', 'sict', 'sid', 'sip', 'sitmi', 'srt', 'ssic', 'suid', 'tdc', 'te', 'thn', 'tht', 'tid', 'tpid', 'tpt', 'trc', 'ts', 'tsd', 'ttdt', 'ttr', 'upfc', 'upfv', 'ut', 'von', 'wl', 'zfh', 'zfn', 'zmfh', 'zmfn', 'zu']
      source: >
        for (def key : params.knownKeys) {
          if (ctx.o365audit.Data.flattened.containsKey(key)) {
            ctx.o365audit.Data[key] = ctx.o365audit.Data.flattened[key];
          }
        }
  - convert:
      tag: convert_o365audit_Data_sip_1df0ff2b
      field: o365audit.Data.sip
      type: ip
      ignore_missing: true
      if: ctx.o365audit?.Data?.sip != ''
      on_failure:
        - remove:
            tag: remove_o365audit_Data_sip_95693a2c
            field: o365audit.Data.sip
            ignore_missing: true
  - convert:
      tag: convert_o365_audit_SensitivityLabelEventData_ActionSourceDetail_d6510954
      field: o365.audit.SensitivityLabelEventData.ActionSourceDetail
      type: long
      ignore_missing: true
      if: ctx.o365?.audit?.SensitivityLabelEventData?.ActionSourceDetail != ''
      on_failure:
        - remove:
            tag: remove_o365_audit_SensitivityLabelEventData_ActionSourceDetail_ac8ae560
            field: o365.audit.SensitivityLabelEventData.ActionSourceDetail
            ignore_missing: true
  - convert:
      tag: convert_o365_audit_SensitivityLabelEventData_LabelEventType_d04ddf88
      field: o365.audit.SensitivityLabelEventData.LabelEventType
      type: long
      ignore_missing: true
      if: ctx.o365?.audit?.SensitivityLabelEventData?.LabelEventType != ''
      on_failure:
        - remove:
            tag: remove_o365_audit_SensitivityLabelEventData_LabelEventType_468846e8
            field: o365.audit.SensitivityLabelEventData.LabelEventType
            ignore_missing: true
  - date:
      tag: date_o365audit_Data_at_to_o365audit_Data_at_650b1b31
      field: o365audit.Data.at
      target_field: o365audit.Data.at
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.at != null
  - date:
      tag: date_o365audit_Data_md_to_o365audit_Data_md_d8b1d89d
      field: o365audit.Data.md
      target_field: o365audit.Data.md
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.md != null
  - date:
      tag: date_o365audit_Data_te_to_o365audit_Data_te_3753208b
      field: o365audit.Data.te
      target_field: o365audit.Data.te
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.te != null
  - date:
      tag: date_o365audit_Data_ts_to_o365audit_Data_ts_60cc586d
      field: o365audit.Data.ts
      target_field: o365audit.Data.ts
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.ts != null
  - date:
      tag: date_o365audit_Data_ttdt_to_o365audit_Data_ttdt_9ead56cc
      field: o365audit.Data.ttdt
      target_field: o365audit.Data.ttdt
      formats:
        - ISO8601
      if: ctx.o365audit?.Data?.ttdt != null
  - append:
      tag: append_related_user_72ce7bf6
      field: related.user
      value: "{{{o365audit.Data.f3u}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Data?.f3u?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.f3u.length() >= 3;
  - set:
      field: user.email
      value: "{{{o365audit.Data.f3u}}}"
      if: ctx.user?.email == null && ctx.o365audit?.Data?.f3u?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.f3u.length() >= 3;
      tag: set_user_email
      ignore_empty_value: true
  - append:
      tag: append_related_user_74080691
      field: related.user
      value: "{{{o365audit.Data.suid}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Data?.suid?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.suid.length() >= 3;
  - append:
      field: email.sender.address
      value: "{{{o365audit.Data.tsd}}}"
      if: ctx.o365audit?.Data?.tsd != null && ctx.o365audit.Data.tsd != ''
      tag: append_email_sender_address_2
      allow_duplicates: false
  - append:
      tag: append_related_user_5439ef83
      field: related.user
      value: "{{{o365audit.Data.tsd}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Data?.tsd?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.tsd.length() >= 3;
  - append:
      field: email.to.address
      value: "{{{o365audit.Data.trc}}}"
      if: ctx.o365audit?.Data?.trc != null && ctx.o365audit.Data.trc != ''
      tag: append_email_to_address
      allow_duplicates: false
  - append:
      tag: append_related_user_0bcc5687
      field: related.user
      value: "{{{o365audit.Data.trc}}}"
      allow_duplicates: false
      if: ctx.o365audit?.Data?.trc?.splitOnToken('@')?.length == 2 && ctx.o365audit.Data.trc.length() >= 3;
  - append:
      field: email.local_id
      value: "{{{o365audit.Data.aii}}}"
      if: ctx.o365audit?.Data?.aii != null && ctx.o365audit.Data.aii != ''
      tag: append_email_local_id_2
      allow_duplicates: false
  - append:
      field: email.message_id
      value: "{{{o365audit.Data.imsgid}}}"
      if: ctx.o365audit?.Data?.imsgid != null && ctx.o365audit.Data.imsgid != ''
      tag: append_email_message_id_2
      allow_duplicates: false
  - append:
      field: email.subject
      value: "{{{o365audit.Data.ms}}}"
      if: ctx.o365audit?.Data?.ms != null && ctx.o365audit.Data.ms != ''
      tag: append_email_subject_2
      allow_duplicates: false
  - script:
      description: Parse known fields from Data.Entities into _tmp.entities to later extract into ECS.
      lang: painless
      tag: script_known_Data.Entities
      if: ctx.o365audit?.Data?.flattened?.Entities instanceof List
      params:
        knownEntityKeys: ['InternetMessageId', 'NetworkMessageId', 'OriginalDeliveryLocation', 'P1Sender', 'P2Sender', 'PhishConfidenceLevel', 'Recipient', 'SenderIP', 'Subject', 'ThreatDetectionMethods', 'Upn']
      source: >
        ctx._tmp = ctx._tmp ?: [:];
        ctx._tmp.entities = [:];
        for (def entity: ctx.o365audit.Data.flattened.Entities) {
          if (entity instanceof Map) {
            for (def key : params.knownEntityKeys) {
              if (! ctx._tmp.entities.containsKey(key)) {
                ctx._tmp.entities[key] = [];
              }
              if (entity.containsKey(key)) {
                ctx._tmp.entities[key].add(entity[key]);
              }
            }
          }
        }
  # Extract _tmp.entities into ECS fields
  - foreach:
      tag: foreach__tmp_entities_InternetMessageId_21b75422
      field: _tmp.entities.InternetMessageId
      if: ctx._tmp?.entities?.InternetMessageId instanceof List
      processor:
        append:
          field: email.message_id
          value: "{{{_ingest._value}}}"
          tag: append_entities.InternetMessageId_email.message_id
          allow_duplicates: false
  - foreach:
      tag: foreach__tmp_entities_NetworkMessageId_82c85e73
      field: _tmp.entities.NetworkMessageId
      if: ctx._tmp?.entities?.NetworkMessageId instanceof List
      processor:
        append:
          field: email.local_id
          value: "{{{_ingest._value}}}"
          tag: append_entities.NetworkMessageId_email.local_id
          allow_duplicates: false
  - foreach:
      tag: foreach__tmp_entities_P1Sender_4e9613ad
      field: _tmp.entities.P1Sender
      if: ctx._tmp?.entities?.P1Sender instanceof List
      processor:
        append:
          field: email.sender.address
          value: "{{{_ingest._value}}}"
          tag: append_entities.P1Sender_email.sender.address
          allow_duplicates: false
  - foreach:
      tag: foreach__tmp_entities_P2Sender_f89724e6
      field: _tmp.entities.P2Sender
      if: ctx._tmp?.entities?.P2Sender instanceof List
      processor:
        append:
          field: email.from.address
          value: "{{{_ingest._value}}}"
          tag: append_entities.P2Sender_email.from.address
          allow_duplicates: false
  - foreach:
      tag: foreach__tmp_entities_Recipient_ca33b0ac
      field: _tmp.entities.Recipient
      if: ctx._tmp?.entities?.Recipient instanceof List
      processor:
        append:
          field: email.to.address
          value: "{{{_ingest._value}}}"
          tag: append_entities.Recipient_email.to.address
          allow_duplicates: false
  - set:
      tag: set_user_email_87a39bd8
      field: user.email
      copy_from: _tmp.entities.Recipient
      if: ctx.user?.email == null && ctx._tmp?.entities?.Recipient instanceof List && ctx._tmp.entities.Recipient.length > 0
      ignore_empty_value: true
  - foreach:
      tag: foreach__tmp_entities_SenderIP_4a5b81c3
      field: _tmp.entities.SenderIP
      if: ctx._tmp?.entities?.SenderIP instanceof List
      processor:
        append:
          field: related.ip
          value: "{{{_ingest._value}}}"
          tag: append_entities.SenderIP_related.ip
          allow_duplicates: false
  - foreach:
      tag: foreach__tmp_entities_Subject_771241ef
      field: _tmp.entities.Subject
      if: ctx._tmp?.entities?.Subject instanceof List
      processor:
        append:
          field: email.subject
          value: "{{{_ingest._value}}}"
          tag: append_entities.Subject_email.subject
          allow_duplicates: false
  - foreach:
      tag: foreach__tmp_entities_Upn_ca5fa308
      field: _tmp.entities.Upn
      if: ctx._tmp?.entities?.Upn instanceof List
      processor:
        append:
          field: related.user
          value: "{{{_ingest._value}}}"
          tag: append_entities.Upn_related.user
          allow_duplicates: false
  - rename:
      field: _tmp.entities.OriginalDeliveryLocation
      target_field: o365audit.OriginalDeliveryLocation
      tag: rename_entities.OriginalDeliveryLocation
      ignore_missing: true
  - rename:
      field: _tmp.entities.PhishConfidenceLevel
      target_field: o365audit.PhishConfidenceLevel
      tag: rename_entities.PhishConfidenceLevel
      ignore_missing: true
  - set:
      field: device.id
      copy_from: o365audit.AppAccessContext.DeviceId
      tag: set_device_id_from_AppAccessContext_DeviceID
      ignore_empty_value: true
  - json:
      tag: json-extract-stringly-ExtendedProperties-additionalDetails
      field: o365audit.ExtendedProperties.additionalDetails
      if: ctx.o365audit?.ExtendedProperties?.additionalDetails instanceof String
      on_failure:
        - remove:
            tag: remove_o365audit_ExtendedProperties_additionalDetails_316a9f1b
            field: o365audit.ExtendedProperties.additionalDetails
            ignore_missing: true
        - append:
            tag: append_error_message_7ee67ff4
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: device.id
      copy_from: o365audit.ExtendedProperties.additionalDetails.DeviceId
      tag: set_device_id_from_additionalDetails_DeviceID
      ignore_empty_value: true
      override: false
  - user_agent:
      tag: user_agent_o365audit_ExtendedProperties_additionalDetails_User-Agent_3413845d
      field: o365audit.ExtendedProperties.additionalDetails.User-Agent
      if: ctx.user_agent == null
      ignore_missing: true
  - set:
      field: session.id
      copy_from: o365audit.AppAccessContext.AADSessionId
      tag: set_session_id_from_AppAccessContext_AADSessionId
      ignore_empty_value: true
  - set:
      field: token.id
      copy_from: o365audit.AppAccessContext.UniqueTokenId
      tag: set_token_id_from_AppAccessContext_UniqueTokenId
      ignore_empty_value: true
  - set:
      field: application.name
      copy_from: o365audit.ApplicationDisplayName
      tag: set_application_name
      ignore_empty_value: true

  # ExchangeItemAggregated Schema
  - append:
      tag: append_event_type_306ea761
      field: event.type
      value: access
      if: ctx.o365audit?.RecordType == "50"
  - append:
      tag: append_event_category_44167de1
      field: event.category
      value: email
      if: ctx.o365audit?.RecordType == "50"
  - rename:
      field: o365audit.Messages
      target_field: o365audit.ExchangeAggregatedMessages
      tag: rename_messages_exchange
      description: 'move generic Messages field to the ExchangeAggregatedMessages field type'
      if: ctx.o365audit?.Messages != null && ctx.o365audit.RecordType == "50"
  - script:
      tag: convert_exchange_message_size_to_long
      if: ctx.o365audit?.ExchangeAggregatedMessages != null
      lang: painless
      source: |
        for (def i = 0; i < ctx.o365audit.ExchangeAggregatedMessages.length; i++) {
          if (ctx.o365audit.ExchangeAggregatedMessages[i].MessageItems == null) {
             continue;
          }
          for (def j = 0; j < ctx.o365audit.ExchangeAggregatedMessages[i].MessageItems.length; j++) {
            def size = ctx.o365audit.ExchangeAggregatedMessages[i].MessageItems[j].SizeInBytes;
            if (size instanceof String) {
              ctx.o365audit.ExchangeAggregatedMessages[i].MessageItems[j].SizeInBytes = Long.parseLong(size);
            } else {
              ctx.o365audit.ExchangeAggregatedMessages[i].MessageItems[j].SizeInBytes = (long)size;
            }
          }
        }

  - rename:
      field: o365audit.Folders
      target_field: o365audit.ExchangeAggregatedFolders
      tag: rename_folders_exchange
      description: 'move generic Folders field to the O365 ExchangeAggregatedFolders field type'
      if: ctx.o365audit?.Folders != null && ctx.o365audit.RecordType == "50"
  - script:
      tag: convert_exchange_folder_size_to_long
      if: ctx.o365audit?.ExchangeAggregatedFolders != null
      lang: painless
      source: |
        for (def i = 0; i < ctx.o365audit.ExchangeAggregatedFolders.length; i++) {
          if (ctx.o365audit.ExchangeAggregatedFolders[i].FolderItems == null) {
              continue;
          }
          for (def j = 0; j < ctx.o365audit.ExchangeAggregatedFolders[i].FolderItems.length; j++) {
            def size = ctx.o365audit.ExchangeAggregatedFolders[i].FolderItems[j].SizeInBytes;
            if (size instanceof String) {
              ctx.o365audit.ExchangeAggregatedFolders[i].FolderItems[j].SizeInBytes = Long.parseLong(size);
            } else {
              ctx.o365audit.ExchangeAggregatedFolders[i].FolderItems[j].SizeInBytes = (long)size;
            }
          }
        }

  - script:
      description: Handle _tmp.entities.ThreatDetectionMethods containing list of lists.
      lang: painless
      tag: script_tmp.entities.ThreatDetectionMethods
      if: ctx._tmp?.entities?.ThreatDetectionMethods instanceof List
      source: >
        def methods = ctx._tmp.entities.ThreatDetectionMethods;
        def result = [];
        for (def method: methods){
          if (method instanceof List) {
            for (def m: method) {
              result.add(m);
            }
          } else if (method instanceof String) {
            result.add(method);
          }
        }
        ctx.o365audit.ThreatDetectionMethods = result;
  - rename:
      tag: rename_o365audit_to_o365_audit_77e76ef2
      field: o365audit
      target_field: o365.audit
      ignore_missing: true
  - user_agent:
      tag: user_agent_user_agent_original_b5325863
      field: user_agent.original
      ignore_missing: true
  # IP Geolocation Lookup
  - geoip:
      tag: geoip_source_ip_to_source_geo_da2e41b2
      field: source.ip
      target_field: source.geo
      ignore_missing: true
  # IP Autonomous System (AS) Lookup
  - geoip:
      tag: geoip_source_ip_to_source_as_28d69883
      database_file: GeoLite2-ASN.mmdb
      field: source.ip
      target_field: source.as
      properties:
        - asn
        - organization_name
      ignore_missing: true
  - rename:
      tag: rename_source_as_asn_to_source_as_number_a917047d
      field: source.as.asn
      target_field: source.as.number
      ignore_missing: true
  - rename:
      tag: rename_source_as_organization_name_to_source_as_organization_name_f1362d0b
      field: source.as.organization_name
      target_field: source.as.organization.name
      ignore_missing: true

  # Populate related.user
  - append:
      tag: append_related_user_7f407fef
      field: related.user
      value: "{{{user.id}}}"
      allow_duplicates: false
      if: ctx.user?.id != null
  - append:
      tag: append_related_user_49283340
      field: related.user
      value: "{{{user.target.id}}}"
      allow_duplicates: false
      if: ctx.user?.target?.id != null
  - append:
      tag: append_related_user_15e46c96
      field: related.user
      value: "{{{user.target.email}}}"
      allow_duplicates: false
      if: ctx.user?.target?.email != null
  - append:
      tag: append_related_user_34fcf415
      field: related.user
      value: "{{{user.email}}}"
      allow_duplicates: false
      if: ctx.user?.email != null

  # Populate related.hosts
  - append:
      tag: append_related_hosts_452ef445
      field: related.hosts
      value: "{{{host.name}}}"
      allow_duplicates: false
      if: ctx.host?.name != null
  - append:
      tag: append_related_hosts_897609bc
      field: related.hosts
      value: "{{{host.hostname}}}"
      allow_duplicates: false
      if: ctx.host?.hostname != null && ctx.host.hostname != ctx.host?.name
  - append:
      tag: append_related_hosts_23e97a1f
      field: related.hosts
      value: "{{{user.domain}}}"
      allow_duplicates: false
      if: ctx.user?.domain != null
  - append:
      tag: append_related_hosts_f2ac264a
      field: related.hosts
      value: "{{{user.target.domain}}}"
      allow_duplicates: false
      if: ctx.user?.target?.domain != null && ctx.user.target.domain != ctx.user?.domain
  - append:
      tag: append_related_hosts_b0d2e007
      field: related.hosts
      value: "{{{source.domain}}}"
      allow_duplicates: false
      if: ctx.source?.domain != null
  - append:
      tag: append_related_hosts_b0d7ba0b
      field: related.hosts
      value: "{{{destination.domain}}}"
      allow_duplicates: false
      if: ctx.destination?.domain != null
  - append:
      tag: append_related_hosts_e5210c4d
      field: related.hosts
      value: "{{{url.domain}}}"
      allow_duplicates: false
      if: ctx.url?.domain != null
  - append:
      tag: append_related_hosts_2ab61e3f
      field: related.hosts
      value: "{{{server.domain}}}"
      allow_duplicates: false
      if: ctx.server?.domain != null
  - append:
      tag: append_related_hosts_1d453937
      field: related.hosts
      value: "{{{client.domain}}}"
      allow_duplicates: false
      if: ctx.client?.domain != null

  # Populate related.hash
  - append:
      tag: append_related_hash_6af42da3
      field: related.hash
      value: "{{{file.hash.md5}}}"
      allow_duplicates: false
      if: ctx.file?.hash?.md5 != null
  - append:
      tag: append_related_hash_b56c7961
      field: related.hash
      value: "{{{file.hash.sha1}}}"
      allow_duplicates: false
      if: ctx.file?.hash?.sha1 != null
  - append:
      tag: append_related_hash_017aef51
      field: related.hash
      value: "{{{file.hash.sha256}}}"
      allow_duplicates: false
      if: ctx.file?.hash?.sha256 != null
  - append:
      tag: append_related_hash_24fd9395
      field: related.hash
      value: "{{{file.hash.sha512}}}"
      allow_duplicates: false
      if: ctx.file?.hash?.sha512 != null

  - remove:
      tag: remove_d0ecf5cd
      field:
        - _conf
        - _tmp
      ignore_missing: true
  - script:
      tag: script_e2ccbdd7
      description: Drops null/empty values recursively.
      lang: painless
      source: |
        boolean dropEmptyFields(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(value -> dropEmptyFields(value));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(value -> dropEmptyFields(value));
            return (((List) object).length == 0);
          }
          return false;
        }
        dropEmptyFields(ctx);
  - set:
      tag: set_event_kind_92954dfa
      field: event.kind
      value: pipeline_error
      if: ctx.error?.message != null
  - append:
      tag: append_tags_9fe66b2c
      field: tags
      value: preserve_original_event
      allow_duplicates: false
      if: ctx.error?.message != null
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}}failed with message '{{{ _ingest.on_failure_message }}}'
