interval: {{resource_interval}}

program: |
  "{{content_types}}".split(",").map(content_type_raw, content_type_raw.trim_space()).map(content_type,
    (request("POST", "https://manage.office.com/api/v1.0/{{oauth_azure_tenant_id}}/activity/feed/subscriptions/start?contentType=" + content_type + "&PublisherIdentifier={{oauth_azure_tenant_id}}")).do_request().as(start_subs_resp, 
      bytes(start_subs_resp.Body).decode_json().as(start_subs_resp_body, 
          (has(start_subs_resp_body.status) && start_subs_resp_body.status == "enabled") || (has(start_subs_resp_body.error) && has(start_subs_resp_body.error) && start_subs_resp_body.error.code == "AF20024") ?
              (request("GET", "https://manage.office.com/api/v1.0/{{oauth_azure_tenant_id}}/activity/feed/subscriptions/content?contentType=" + content_type + "&PublisherIdentifier={{oauth_azure_tenant_id}}")).do_request().as(list_contents_resp,
                      bytes(list_contents_resp.Body).decode_json().as(list_contents_resp_body, 
                          (size(list_contents_resp_body) > 0 && has(list_contents_resp_body[0].contentUri) && list_contents_resp_body[0].contentUri != "") ?
                              list_contents_resp_body.map(l1, 
                                  (request("GET", l1.contentUri)).do_request().as(content_resp, 
                                          bytes(content_resp.Body).decode_json()).map(content_resp_body, 
                                            content_resp_body.with({ "copy": {"o365audit" : content_resp_body}})
                                          ).map(content_resp_body_with_copy, content_resp_body_with_copy.copy)).flatten().drop_empty().as(contents,
                                              has(list_contents_resp_body[0].contentCreated) && list_contents_resp_body[0].contentCreated != "" ?
                                                        ({
                                                            "events_per_content_type": contents,
                                                            "content_type": content_type,
                                                            "max_created_time_per_content_type": { "temp" : list_contents_resp_body}.collate("temp.contentCreated").as(t, t.max()),
                                                           // "content_type_improved": { "temp" : list_contents_resp_body}.collate("temp.contentCreated").as(t, {content_type: t.max()})
                                                        })
                                                    : 
                                                    (
                                                        {
                                                            "events_per_content_type": contents
                                                        }
                                                    )
                                            )
                                    :
                                    (
                                        {
                                            "events_per_content_type": [list_contents_resp_body]
                                        } 
                                    )
                            )
                    )
                :
                (
                    {
                        "events_per_content_type": [start_subs_resp_body]
                    }
                )
            )
        )
    ).as(events_list, 
        {
            "events_no_collate": events_list.flatten().drop_empty(),
            "events": events_list.collate("events_per_content_type").flatten().drop_empty(),
            "cursor": {
                "content_types": events_list.collate("content_type"),
                "max_created_time_per_content_type": events_list.collate("max_created_time_per_content_type"),
                "content_type_improv": events_list.collate("content_type_improv"),
            }
        }
    )

{{#if state}}
state:
  {{state}}
{{/if}}

{{#if oauth_id}}
auth.oauth2.client.id: {{oauth_id}}
{{/if}}
{{#if oauth_secret}}
auth.oauth2.client.secret: {{oauth_secret}}
{{/if}}
auth.oauth2.provider: azure
{{#if oauth_scopes}}
auth.oauth2.scopes:
{{#each oauth_scopes as |scope|}}
  - {{scope}}
{{/each}}
{{/if}}
{{#if oauth_azure_tenant_id}}
auth.oauth2.azure.tenant_id: {{oauth_azure_tenant_id}}
{{/if}}
resource.url: {{resource_url}}
{{#if resource_ssl}}
resource.ssl: 
  {{resource_ssl}}
{{/if}}
{{#if resource_proxy_url}}
resource.proxy_url: {{resource_proxy_url}}
{{/if}}
{{#if resource_retry_max_attempts}}
resource.retry.max_attempts: {{resource_retry_max_attempts}}
{{/if}}
{{#if resource_retry_wait_min}}
resource.retry.wait_min: {{resource_retry_wait_min}}
{{/if}}
{{#if resource_retry_wait_max}}
resource.retry.wait_max: {{resource_retry_wait_max}}
{{/if}}
{{#if resource_redirect_forward_headers}}
resource.redirect.forward_headers: {{resource_redirect_forward_headers}}
{{/if}}
{{#if resource_redirect_headers_ban_list}}
resource.redirect.headers_ban_list:
{{#each resource_redirect_headers_ban_list as |item|}}
  - {{item}}
{{/each}}
{{/if}}
{{#if resource_redirect_max_redirects}}
resource.redirect.max_redirects: {{resource_redirect_max_redirects}}
{{/if}}
{{#if resource_rate_limit_limit}}
resource.rate_limit.limit: {{resource_rate_limit_limit}}
{{/if}}
{{#if resource_rate_limit_burst}}
resource.rate_limit.burst: {{resource_rate_limit_burst}}
{{/if}}

{{#if enable_request_tracer}}
resource.tracer.filename: "../../logs/httpjson/http-request-trace-*.ndjson"
{{/if}}

{{#if tags}}
tags:
{{#if preserve_original_event}}
  - preserve_original_event
{{/if}}
{{#each tags as |tag|}}
  - {{tag}}
{{/each}}
{{/if}}
{{#contains "forwarded" tags}}
publisher_pipeline.disable_host: true
{{/contains}}
{{#if processors}}
processors:
{{processors}}
{{/if}}
