---
description: Pipeline for parsing RabbitMQ logs
processors:
  - set:
      field: event.ingested
      value: '{{_ingest.timestamp}}'
  - set:
      field: ecs.version
      value: '8.11.0'
  - set:
      field: event.kind
      value: event
  - set:
      field: event.type
      value: ["info"]
  # Try to parse as JSON log first
  - json:
      field: message
      target_field: rabbitmq.log.json
      add_to_root: false
      ignore_failure: true
  # If JSON parsing succeeded, copy fields to ECS fields
  - set:
      field: event.original
      value: "{{message}}"
      if: "ctx.rabbitmq?.log?.json != null"
  - set:
      field: log.level
      value: "{{rabbitmq.log.json.level}}"
      if: "ctx.rabbitmq?.log?.json != null && ctx.rabbitmq.log.json.level != null"
  - set:
      field: message
      value: "{{rabbitmq.log.json.message}}"
      if: "ctx.rabbitmq?.log?.json != null && ctx.rabbitmq.log.json.message != null"
  - date:
      if: "ctx.rabbitmq?.log?.json != null && ctx.rabbitmq.log.json.timestamp != null"
      field: rabbitmq.log.json.timestamp
      target_field: "@timestamp"
      formats:
        - ISO8601
  # If not JSON, fall back to text parsing
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      if: 'ctx.event?.original == null && ctx.rabbitmq?.log?.json == null'
  - grok:
      field: event.original
      pattern_definitions:
        GREEDYMULTILINE: "(.|\n)*"
        ERL_PID: "\\<%{INT}+\\.%{INT}+\\.%{INT}+\\>"
      patterns:
      - "%{TIMESTAMP_ISO8601:timestamp} \\[%{WORD:log.level}\\] %{ERL_PID:rabbitmq.log.pid} %{GREEDYMULTILINE:message}"
      ignore_missing: true
      if: "ctx.rabbitmq?.log?.json == null"
  - date:
      if: "ctx.event.timezone == null && ctx.rabbitmq?.log?.json == null"
      field: timestamp
      target_field: "@timestamp"
      formats:
      - yyyy-MM-dd HH:mm:ss.SSSSSSZZZZZ
  - date:
      if: "ctx.event.timezone != null && ctx.rabbitmq?.log?.json == null"
      field: "timestamp"
      target_field: "@timestamp"
      timezone: "{{ event.timezone }}"
      formats:
      - yyyy-MM-dd HH:mm:ss.SSSSSSZZZZZ
  - remove:
      field:
        - timestamp
        - rabbitmq.log.json
      ignore_missing: true
on_failure:
- set:
    field: error.message
    value: "{{ _ingest.on_failure_message }}"
