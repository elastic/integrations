{
    "id": "kubernetes-statefulset-unavailable-replicas",
    "type": "alerting_rule_template",
    "attributes": {
        "name": "[Kubernetes] Statefulset Unavailable Replicas",
        "tags": [
            "Kubernetes",
            "Statefulset",
            "Availability"
        ],
        "ruleTypeId": ".es-query",
        "schedule": {
            "interval": "5m"
        },
        "params": {
            "searchType": "esqlQuery",
            "timeWindowSize": 10,
            "timeWindowUnit": "m",
            "esqlQuery": {
                "esql": "// Alert when statefulset desired replicas exceed ready replicas.\n//\n// What triggers this alert:\n// AVG(desired) - AVG(ready) > 0 means some pods are unavailable.\n//\n// What it means:\n// Statefulset not fully running \u2014 may affect stateful workloads like databases.\n//\n// Common causes:\n// Volume provisioning issues, resource constraints, image errors, node affinity.\n//\n// Handles edge cases: filters out zero-desired statefulsets.\nTS metrics-kubernetes.state_statefulset-*\n| WHERE `kubernetes.statefulset.replicas.desired` IS NOT NULL\n| STATS\n    avg_desired = AVG(`kubernetes.statefulset.replicas.desired`),\n    avg_ready = AVG(`kubernetes.statefulset.replicas.ready`)\n  BY `orchestrator.cluster.name`, `kubernetes.statefulset.name`, `kubernetes.namespace`\n| WHERE avg_desired IS NOT NULL AND avg_desired > 0\n| EVAL unavailable = avg_desired - avg_ready\n| WHERE unavailable > 0"
            },
            "groupBy": "row",
            "timeField": "@timestamp"
        },
        "alertDelay": {
            "active": 3
        }
    },
    "managed": true,
    "coreMigrationVersion": "8.8.0",
    "typeMigrationVersion": "10.1.0"
}
