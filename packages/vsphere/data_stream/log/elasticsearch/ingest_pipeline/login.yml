---
description: "Parse login and logout events from VMware vSphere/vCenter"
processors:
  - dissect:
      field: message
      pattern: "%{} user %{user.name}@%{user.domain}"
      if: ctx.message.contains('Authenticated user')
  - dissect:
      field: message
      pattern: "%{} [User %{user.name}@%{client.ip} %{_tmp.event} as %{user.agent.original}]"
      if: 'ctx.message.contains(''logged in as'') ?: false'
  - dissect:
      field: message
      pattern: "%{} [User %{user.name}@%{client.ip} %{_tmp.event} out (login time: %{event.start},
        number %{}: %{vsphere.api.invocations}, %{}: %{user.agent.original})]"
      if: 'ctx.message.contains(''logged out'') ?: false'
  - dissect:
      field: user.name
      pattern: "%{user.domain}\\%{user.name}"
      ignore_failure: true
  - set:
      field: event.outcome
      value: success
      if: 'ctx.event?.outcome?.toLowerCase()?.startsWith(''s'') ?: false'
  - set:
      field: event.outcome
      value: failure
      if: 'ctx.event?.outcome?.toLowerCase()?.startsWith(''f'') ?: false'
  - user_agent:
      field: user.agent.original
      if: ctx.user?.agent?.original != null
  - set:
      field: event.end
      value: "{{@timestamp}}"
      if: ctx.event?.start != null
  - script:
      source: "\n                ZonedDateTime start = ZonedDateTime.parse(ctx.event.start);\n
        \               ZonedDateTime end = ZonedDateTime.parse(ctx.event.end);\n                ctx.event.duration
        = ChronoUnit.NANOS.between(start, end);\n          "
      if: ctx.event?.end != null
  - set:
      field: event.action
      value: login
      if: ctx.log?.logger == 'vim.event.UserLoginSessionEvent'
  - set:
      field: event.action
      value: logout
      if: ctx.log?.logger == 'vim.event.UserLogoutSessionEvent'
  - set:
      field: event.kind
      value: event
      if: ctx.log?.logger != null && ['UserLogoutSessionEvent', 'UserLoginSessionEvent'].contains(ctx.log.logger)
