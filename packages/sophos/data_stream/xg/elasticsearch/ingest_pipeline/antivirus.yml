---
description: Pipeline for parsing sophos firewall logs (antivirus pipeline)
processors:
#######################
## ECS Event Mapping ##
#######################
- set:
    tag: set_event_kind_39295792
    field: event.kind
    value: alert
- set:
    tag: set_event_action_3c69f2d9
    field: event.action
    value: "{{{sophos.xg.log_subtype}}}"
    if: "ctx.sophos?.xg?.log_subtype != null"
- set:
    tag: set_event_outcome_a78e5234
    field: event.outcome
    value: success
    if: "ctx.sophos?.xg?.log_subtype != null"
- append:
    tag: append_event_category_a638e7b8
    field: event.category
    value:
      - malware
      - network
    if: "ctx.sophos?.xg?.log_subtype == 'Virus'"
- append:
    tag: append_event_type_1e18c440
    field: event.type
    value:
      - info
      - denied
      - connection
    if: "ctx.sophos?.xg?.log_subtype == 'Virus'"
- set:
    tag: set_event_kind_ef98b699
    field: event.kind
    value: event
    if: '["09002"].contains(ctx.event?.code)'
- append:
    tag: append_event_type_2247e261
    field: event.type
    value:
      - allowed
      - connection
    if: '["09002"].contains(ctx.event?.code)'
- append:
    tag: append_event_category_dbeff0d5
    field: event.category
    value: network
    if: '["09002"].contains(ctx.event?.code)'

#############################
## ECS Destination Mapping ##
#############################
- rename:
    tag: rename_sophos_xg_dst_ip_to_destination_ip_17b8be30
    field: sophos.xg.dst_ip
    target_field: destination.ip
    ignore_missing: true
    if: "ctx.sophos?.xg?.dst_ip != null"
- convert:
    tag: convert_sophos_xg_dst_port_to_destination_port_cea07508
    field: sophos.xg.dst_port
    target_field: destination.port
    type: long
    ignore_failure: true
    ignore_missing: true
    if: "ctx.sophos?.xg?.dst_port != null"
- rename:
    tag: rename_sophos_xg_dstdomain_to_destination_domain_336fd47c
    field: sophos.xg.dstdomain
    target_field: destination.domain
    ignore_failure: true
- rename:
    tag: rename_sophos_xg_dst_domainname_to_destination_domain_9c7fa79c
    field: sophos.xg.dst_domainname
    target_field: destination.domain
    ignore_failure: true

########################
## ECS Source Mapping ##
########################
- rename:
    tag: rename_sophos_xg_src_ip_to_source_ip_db814f5f
    field: sophos.xg.src_ip
    target_field: source.ip
    ignore_missing: true
    if: "ctx.sophos?.xg?.src_ip != null"
- convert:
    tag: convert_sophos_xg_src_port_to_source_port_c97a8dfb
    field: sophos.xg.src_port
    target_field: source.port
    type: long
    ignore_failure: true
    ignore_missing: true
    if: "ctx.sophos?.xg?.src_port != null"
- rename:
    tag: rename_sophos_xg_user_name_to_source_user_name_98774918
    field: sophos.xg.user_name
    target_field: source.user.name
    ignore_missing: true
    if: "ctx.sophos?.xg?.user_name != null"
- rename:
      tag: rename_sophos_xg_src_domainname_to_source_domain_0f644dfe
      field: sophos.xg.src_domainname
      target_field: source.domain
      ignore_failure: true

#######################
## ECS Email Mapping ##
#######################
- rename:
    tag: rename_sophos_xg_from_email_address_to_source_user_email_97624a63
    field: sophos.xg.from_email_address
    target_field: source.user.email
    ignore_missing: true
- rename:
    tag: rename_sophos_xg_to_email_address_to_destination_user_email_62e2176b
    field: sophos.xg.to_email_address
    target_field: destination.user.email
    ignore_missing: true
- append:
    tag: append_email_from_address_620b8c30
    field: email.from.address
    value: "{{{source.user.email}}}"
    if: "ctx?.source?.user?.email != null"
- append:
    tag: append_email_to_address_65b7cb39
    field: email.to.address
    value: "{{{destination.user.email}}}"
    if: "ctx?.destination?.user?.email != null"
- set:
    tag: set_email_subject_15d4cf78
    field: email.subject
    copy_from: sophos.xg.email_subject
    if: "ctx?.sophos.xg?.email_subject != null"
- set:
    tag: set_email_subject_2f9d7e59
    field: email.subject
    copy_from: sophos.xg.subject
    if: "ctx?.sophos.xg?.subject != null && ctx.email?.subject == null"

######################
## ECS Rule Mapping ##
######################
- rename:
    tag: rename_sophos_xg_fw_rule_id_to_rule_id_69aa6b49
    field: sophos.xg.fw_rule_id
    target_field: rule.id
    ignore_missing: true
    if: "ctx.rule?.id == null"

#####################
## ECS URL Mapping ##
#####################
- rename:
     tag: rename_sophos_xg_url_to_url_original_ca813017
     field: sophos.xg.url
     target_field: url.original
     ignore_missing: true
     if: "ctx.sophos?.xg?.url != null"
- uri_parts:
    tag: uri_parts_url_original_to_url_cabb1026
    if: ctx.url?.original != null && ctx.url.original.contains("://")
    field: url.original
    target_field: url
- set:
    tag: set_url_full_26ab774e
    if: ctx.url?.original != null && ctx.url.original.contains("://")
    field: url.full
    copy_from: url.original
    ignore_empty_value: true
- rename:
     tag: rename_sophos_xg_domainname_to_url_domain_dea39915
     field: sophos.xg.domainname
     target_field: url.domain
     ignore_failure: true

############################
## ECS User Agent Mapping ##
############################
- rename:
     tag: rename_sophos_xg_user_agent_to_user_agent_original_fa388785
     field: sophos.xg.user_agent
     target_field: user_agent.original
     ignore_missing: true
     if: "ctx.sophos?.xg?.user_agent != null"
- convert:
    tag: convert_sophos_xg_status_code_to_http_response_status_code_ef1ca740
    field: sophos.xg.status_code
    target_field: http.response.status_code
    type: long
    ignore_failure: true
    ignore_missing: true
    if: "ctx.sophos?.xg?.status_code != null && ctx.sophos?.xg?.status_code != ''"

######################
## ECS File Mapping ##
######################
- rename:
    tag: rename_sophos_xg_filename_to_file_name_0d28f4c6
    field: sophos.xg.filename
    target_field: file.name
    ignore_missing: true
    if: "ctx.sophos?.xg?.filename != null"
- convert:
    tag: convert_sophos_xg_file_size_to_file_size_9e10c8c4
    field: sophos.xg.file_size
    target_field: file.size
    type: long
    ignore_failure: true
    ignore_missing: true
    if: "ctx.sophos?.xg?.file_size != null"
- rename:
    tag: rename_sophos_xg_file_path_to_file_directory_27854f42
    field: sophos.xg.file_path
    target_field: file.directory
    ignore_missing: true
    if: "ctx.sophos?.xg?.file_path != null"

######################
## ECS Network Mapping
######################
- rename:
    tag: rename_sophos_xg_protocol_to_network_transport_9c443cec
    field: sophos.xg.protocol
    target_field: network.transport
    ignore_missing: true
- lowercase:
    tag: lowercase_sophos_xg_log_component_to_network_protocol_7530f65c
    field: sophos.xg.log_component
    target_field: network.protocol
    ignore_missing: true

#############
## Cleanup ##
#############
- lowercase:
      tag: lowercase_event_info_8cdf34c5
      field: event.info
      ignore_failure: true
- remove:
    tag: remove_a86fabaa
    field:
    - sophos.xg.domainname
    - sophos.xg.dst_port
    - sophos.xg.src_port
    - sophos.xg.status_code
    - sophos.xg.file_size
    - sophos.xg.from_email_address
    - sophos.xg.to_email_address
    ignore_missing: true
on_failure:
- set:
    field: event.kind
    value: pipeline_error
- append:
    field: error.message
    value: >-
      Processor '{{{ _ingest.on_failure_processor_type }}}'
      {{#_ingest.on_failure_processor_tag}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
      {{/_ingest.on_failure_processor_tag}}in pipeline '{{{ _ingest.pipeline }}}'
      failed with message '{{{ _ingest.on_failure_message }}}'
- append:
    field: tags
    value: preserve_original_event
    allow_duplicates: false
