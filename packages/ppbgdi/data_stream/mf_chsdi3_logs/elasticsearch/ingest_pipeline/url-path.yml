---
description: Pipeline for processing mf-chsdi3 url path
processors:
  - gsub:
      description: Remove trailing slash from url for easier parsing and aggregating
      field: url.path
      pattern: "/$"
      replacement: ""
  - grok:
      field: url.path
      patterns:
        - '^/rest/services/%{MF_CHSDI3_TOPIC}/MapServer$' # Layers Metadata
        - '^/rest/services/%{MF_CHSDI3_TOPIC}/MapServer/identify$' # Identify Features
        - '^/rest/services/%{MF_CHSDI3_TOPIC}/MapServer/find$' # Find
        - '^/rest/services/%{MF_CHSDI3_TOPIC}/MapServer/%{MF_CHSDI3_LAYER}$' # Layer Attributes
        - '^/rest/services/%{MF_CHSDI3_TOPIC}/MapServer/%{MF_CHSDI3_LAYER}/legend$' # Legend Resource
        - '^/rest/services/%{MF_CHSDI3_TOPIC}/MapServer/%{MF_CHSDI3_LAYER}/%{MF_CHSDI3_FEATURE}$' # Feature Resource
        - '^/rest/services/%{MF_CHSDI3_TOPIC}/MapServer/%{MF_CHSDI3_LAYER}/%{MF_CHSDI3_FEATURE}/htmlPopup$' # Htmlpopup Resource
      pattern_definitions:
        MF_CHSDI3_TOPIC: "(?<ppbgdi.app.topic.id>[^/]+)"
        MF_CHSDI3_LAYER: "(?<ppbgdi.app.layer.id>ch[^/]+)" # To avoid problems, assume features start with ch. To be improve if exceptions pop up.
        MF_CHSDI3_FEATURE: "(?<ppbgdi.app.feature.id>[^/]+)"
        MF_CHSDI3_LAYERSCONFIG_ENDPOINT: "(?<ppbgdi.app.endpoint.id>layersConfig)"
      trace_match: true
      ecs_compatibility: v1
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      description: Store the index of the matching grok pattern available for endpoint naming
      field: _ingest._grok_match_index
      target_field: temp.endpoint_index
      type: integer
      ignore_missing: true
  - script:
      description: Sets the endpoint name based on the index of the matching grok pattern
      source: >-
        ctx['ppbgdi.app.endpoint.id'] = params['endpoint_names'][ctx?.temp?.endpoint_index];
      params:
        endpoint_names:
          - layers_metadata
          - identify
          - find
          - layer_attributes
          - legend_resource
          - feature_resource
          - htmlpopup_resource
      if: ctx?.temp?.endpoint_index != null
  - dot_expander:
      description: Convert ppbgdi.app.endpoint.id into an object field
      field: ppbgdi.app.endpoint.id
  - remove:
      field: temp
      ignore_missing: true

on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: '{{ _ingest.on_failure_message }}'
