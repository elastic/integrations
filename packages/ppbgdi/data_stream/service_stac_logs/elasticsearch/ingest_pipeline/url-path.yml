---
description: Pipeline for processing service STAC url path
processors:
  - gsub:
      description: Remove trailing slash from url for easier parsing and aggregating
      field: url.path
      pattern: "/$"
      replacement: ""
  - grok:
      field: url.path
      pattern_definitions:
        STAC_VERSION: "v(?<ppbgdi.app.api.version>[0-9]([.][0-9])*)"
        STAC_ADMIN_ENDPOINT: "(?<ppbgdi.app.stac.endpoint>admin)"
        STAC_CHECKER_ENDPOINT: "(?<ppbgdi.app.stac.endpoint>checker)"
        STAC_METRICS_ENDPOINT: "(?<ppbgdi.app.stac.endpoint>metrics)"
        STAC_COLLECTIONS_ENDPOINT: "(?<ppbgdi.app.stac.endpoint>collections)"
        STAC_CONFORMANCE_ENDPOINT: "(?<ppbgdi.app.stac.endpoint>conformance)"
        STAC_SEARCH_ENDPOINT: "(?<ppbgdi.app.stac.endpoint>search)"
        STAC_COLLECTION: "/(?<ppbgdi.app.stac.collection.id>[^/]+)"
        STAC_FEATURE: "/(?<ppbgdi.app.stac.feature.id>[^/]+)"
        STAC_ASSET: "/(?<ppbgdi.app.stac.asset.id>[^/]+)"
        STAC_UPLOAD_ID: "/(?<ppbgdi.app.stac.upload.id>[^/]+)"
        STAC_UPLOAD_OPTION: "/(?<ppbgdi.app.stac.upload.option>abort|complete|parts)"

      patterns:
        - '^/%{STAC_CHECKER_ENDPOINT}$'
        - '^/%{STAC_METRICS_ENDPOINT}$'
        - '^/api/stac/%{STAC_VERSION}/?$'
        - '^/api/stac/%{STAC_VERSION}/%{STAC_CONFORMANCE_ENDPOINT}/?$'
        - '^/api/stac/%{STAC_VERSION}/%{STAC_COLLECTIONS_ENDPOINT}(%{STAC_COLLECTION}(/items%{STAC_FEATURE}?(/assets%{STAC_ASSET}?(/uploads%{STAC_UPLOAD_ID}?(%{STAC_UPLOAD_OPTION})?)?)?)?)?$'
        - '^/api/stac/%{STAC_VERSION}/%{STAC_SEARCH_ENDPOINT}$'
        - '^/api/stac/%{STAC_ADMIN_ENDPOINT}'
      on_failure:
        - set:
            field: event.kind
            value: pipeline_error
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: '{{ _ingest.on_failure_message }}'
