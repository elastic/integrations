---
description: Pipeline for processing service STAC url path
processors:
  - gsub:
      description: Remove trailing slash from url for easier parsing and aggregating
      field: url.path
      pattern: "/$"
      replacement: ""
  - grok:
      field: url.path
      patterns:
        - '^/api/stac/%{STAC_VERSION}$'
        - '^/api/stac/%{STAC_VERSION}/conformance$'
        - '^/api/stac/%{STAC_VERSION}/collections$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items/%{STAC_FEATURE_ID}$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items/%{STAC_FEATURE_ID}/assets$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items/%{STAC_FEATURE_ID}/assets/%{STAC_ASSET_ID}$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items/%{STAC_FEATURE_ID}/assets/%{STAC_ASSET_ID}/uploads$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items/%{STAC_FEATURE_ID}/assets/%{STAC_ASSET_ID}/uploads/%{STAC_UPLOAD_ID}$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items/%{STAC_FEATURE_ID}/assets/%{STAC_ASSET_ID}/uploads/%{STAC_UPLOAD_ID}/complete$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items/%{STAC_FEATURE_ID}/assets/%{STAC_ASSET_ID}/uploads/%{STAC_UPLOAD_ID}/abort$'
        - '^/api/stac/%{STAC_VERSION}/collections/%{STAC_COLLECTION_ID}/items/%{STAC_FEATURE_ID}/assets/%{STAC_ASSET_ID}/uploads/%{STAC_UPLOAD_ID}/parts$'
        - '^/api/stac/%{STAC_VERSION}/search$'
        - '^/api/stac/get-token$'
        - '^/checker$'
        - '^/metrics$'
        - '^/api/stac/admin'
      pattern_definitions:
        STAC_VERSION: "v(?<ppbgdi.app.api.version>[0-9]([.][0-9])*)"
        STAC_COLLECTION_ID: "(?<ppbgdi.app.stac.collection.id>[^/]+)"
        STAC_FEATURE_ID: "(?<ppbgdi.app.stac.feature.id>[^/]+)"
        STAC_ASSET_ID: "(?<ppbgdi.app.stac.asset.id>[^/]+)"
        STAC_UPLOAD_ID: "(?<ppbgdi.app.stac.upload.id>[^/]+)"
      trace_match: true # Adds the index of the matching pattern to _ingest._grok_match_index. Used to set endpoint names
      ecs_compatibility: v1
      on_failure:
        - set:
            field: event.kind
            value: pipeline_error
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag fail-{{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      description: Store the index of the matching grok pattern available for endpoint naming
      field: _ingest._grok_match_index
      target_field: temp_endpoint_index
      type: integer
      ignore_missing: true
  - script:
      description: Sets the endpoint name based on the index of the matching grok pattern
      source: >-
        ctx['ppbgdi.app.endpoint.id'] = params['endpoint_names'][ctx?.temp_endpoint_index];
      params:
        endpoint_names:
          - landing_page # GET
          - conformance # GET
          - collections # GET
          - collection # GET | PUT | PATCH
          - features # GET
          - feature # GET | PUT | PATCH | DELETE
          - assets # GET
          - asset # GET | PUT | PATCH | DELETE
          - asset_uploads # GET | POST
          - asset_upload # GET
          - complete_asset_upload # POST
          - abort_asset_upload # POST
          - get_upload_parts # GET
          - search # GET | POST
          - get_token # POST
          - checker
          - metrics
          - admin
      if: ctx?.temp_endpoint_index != null
  - dot_expander:
      description: Convert ppbgdi.app.endpoint.id into an object field
      field: ppbgdi.app.endpoint.id
  - remove:
      field: temp_endpoint_index
      ignore_missing: true

on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: '{{ _ingest.on_failure_message }}'
