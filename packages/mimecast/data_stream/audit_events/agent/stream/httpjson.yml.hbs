filebeat.inputs:
- type: httpjson
  enabled: true
  interval: 10s
  request.url: {{api_url}}/api/audit/get-audit-events
  request.method: "POST"
  request.transforms:
    - set:
        target: body.meta.pagination.pageSize
        value: 500
    - set:
        target: body.data
        value: '[{"endDateTime": "[[formatDate (now) "2006-01-02T15:04:05+0700"]]", "startDateTime":"[[.cursor.eventTime]]"}]'
        default: '[{"endDateTime": "[[formatDate (now) "2006-01-02T15:04:05+0700"]]", "startDateTime":"[[formatDate (now (parseDuration "-5m")) "2006-01-02T15:04:05+0700"]]"}]'
        value_type: json
    - set:
        target: header.x-mc-app-id
        value: "4784d44a-d5d0-4373-ab66-816f59e758aa"
    - set:
        target: header.x-mc-date
        value: '[[formatDate (now) "RFC1123"]]'
    - set:
        target: header.x-mc-req-id
        value: '[[uuid]]'
    - set:
        target: header.Content-Type
        value: application/json
    - set:
        target: header.Authorization
        value: 'MC {{access_key}}:[[hmacBase64 "sha1" (base64Decode {{secret_key}}) (sprintf "%s:%s:/api/audit/get-audit-events:{{app_key}} (.header.Get "x-mc-date") (.header.Get "x-mc-req-id"))]]'
        fail_on_template_error: true
  response.decode_as: application/json
  response.split:
    target: body.data
  response.pagination:
   - set:
       target: body.meta.pagination.pageToken
       value: '[[.last_response.body.meta.pagination.next]]'
       fail_on_template_error: true
  cursor:
    next_date:
        value: '[[.first_event.eventTime]]'