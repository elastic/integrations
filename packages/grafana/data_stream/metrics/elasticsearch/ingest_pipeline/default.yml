---
description: Pipeline for Grafana Prometheus metrics
processors:
  - set:
      field: event.ingested
      value: "{{_ingest.timestamp}}"
  - set:
      field: event.kind
      value: metric
  - set:
      field: event.module
      value: grafana
  - set:
      field: event.dataset
      value: grafana.metrics

  # Map prometheus.labels to ECS fields (use set+remove since agent may pre-populate these)
  - set:
      if: ctx.prometheus?.labels?.instance != null
      field: service.address
      copy_from: prometheus.labels.instance
      override: true
  - remove:
      field: prometheus.labels.instance
      ignore_missing: true
  - set:
      if: ctx.prometheus?.labels?.job != null
      field: service.name
      copy_from: prometheus.labels.job
      override: true
  - remove:
      field: prometheus.labels.job
      ignore_missing: true

  # --- Instance stats ---
  - rename:
      field: prometheus.metrics.grafana_stat_totals_dashboard
      target_field: grafana.stat.dashboards.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_total_users
      target_field: grafana.stat.users.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_active_users
      target_field: grafana.stat.users.active
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_datasource
      target_field: grafana.stat.datasources.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_alert_rules
      target_field: grafana.stat.alert_rules.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_total_orgs
      target_field: grafana.stat.orgs.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_total_teams
      target_field: grafana.stat.teams.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_total_playlists
      target_field: grafana.stat.playlists.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_total_service_accounts
      target_field: grafana.stat.service_accounts.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_folder
      target_field: grafana.stat.folders.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_annotations
      target_field: grafana.stat.annotations.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_admins
      target_field: grafana.stat.admins.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_editors
      target_field: grafana.stat.editors.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_viewers
      target_field: grafana.stat.viewers.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_active_admins
      target_field: grafana.stat.active_admins.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_active_editors
      target_field: grafana.stat.active_editors.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_active_viewers
      target_field: grafana.stat.active_viewers.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_dashboard_versions
      target_field: grafana.stat.dashboard_versions.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_library_panels
      target_field: grafana.stat.library_panels.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_public_dashboard
      target_field: grafana.stat.public_dashboards.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_rule_groups
      target_field: grafana.stat.rule_groups.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_correlations
      target_field: grafana.stat.correlations.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_data_keys
      target_field: grafana.stat.data_keys.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_stat_totals_repositories
      target_field: grafana.stat.repositories.total
      ignore_missing: true

  # --- Alerting ---
  - rename:
      field: prometheus.metrics.grafana_alerting_active_alerts
      target_field: grafana.alerting.active_alerts
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_result_total
      target_field: grafana.alerting.result.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_notification_sent_total
      target_field: grafana.alerting.notification.sent.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_notification_failed_total
      target_field: grafana.alerting.notification.failed.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_active_configurations
      target_field: grafana.alerting.active_configurations
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_alerts
      target_field: grafana.alerting.alerts
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_alerts_received_total
      target_field: grafana.alerting.alerts_received.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_alerts_invalid_total
      target_field: grafana.alerting.alerts_invalid.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_silences
      target_field: grafana.alerting.silences
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_schedule_alert_rules
      target_field: grafana.alerting.schedule.alert_rules
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_scheduler_behind_seconds
      target_field: grafana.alerting.scheduler.behind_seconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_execution_time_milliseconds_count
      target_field: grafana.alerting.execution_time.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_execution_time_milliseconds_sum
      target_field: grafana.alerting.execution_time.milliseconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_notification_latency_seconds_count
      target_field: grafana.alerting.notification_latency.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_notification_latency_seconds_sum
      target_field: grafana.alerting.notification_latency.seconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_alerting_ticker_interval_seconds
      target_field: grafana.alerting.ticker.interval_seconds
      ignore_missing: true

  # --- Database ---
  - rename:
      field: prometheus.metrics.grafana_database_conn_open
      target_field: grafana.database.connections.open
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_database_conn_in_use
      target_field: grafana.database.connections.in_use
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_database_conn_idle
      target_field: grafana.database.connections.idle
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_database_conn_max_open
      target_field: grafana.database.connections.max_open
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_database_conn_wait_count_total
      target_field: grafana.database.connections.wait_count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_database_conn_wait_duration_seconds
      target_field: grafana.database.connections.wait_duration_seconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_database_conn_max_idle_closed_total
      target_field: grafana.database.connections.max_idle_closed
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_database_conn_max_idle_closed_seconds
      target_field: grafana.database.connections.max_idle_closed_seconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_database_conn_max_lifetime_closed_total
      target_field: grafana.database.connections.max_lifetime_closed
      ignore_missing: true

  # --- Datasource ---
  - rename:
      field: prometheus.metrics.grafana_datasource_request_total
      target_field: grafana.datasource.request.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_db_datasource_query_by_id_total
      target_field: grafana.datasource.query_by_id.total
      ignore_missing: true

  # --- API ---
  - rename:
      field: prometheus.metrics.grafana_api_response_status_total
      target_field: grafana.api.response.status.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_get_milliseconds
      target_field: grafana.api.dashboard.get.milliseconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_get_milliseconds_count
      target_field: grafana.api.dashboard.get.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_get_milliseconds_sum
      target_field: grafana.api.dashboard.get.sum
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_save_milliseconds
      target_field: grafana.api.dashboard.save.milliseconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_save_milliseconds_count
      target_field: grafana.api.dashboard.save.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_save_milliseconds_sum
      target_field: grafana.api.dashboard.save.sum
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_search_milliseconds
      target_field: grafana.api.dashboard.search.milliseconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_search_milliseconds_count
      target_field: grafana.api.dashboard.search.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_search_milliseconds_sum
      target_field: grafana.api.dashboard.search.sum
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dataproxy_request_all_milliseconds
      target_field: grafana.api.dataproxy.request.milliseconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dataproxy_request_all_milliseconds_count
      target_field: grafana.api.dataproxy.request.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dataproxy_request_all_milliseconds_sum
      target_field: grafana.api.dataproxy.request.sum
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_login_post_total
      target_field: grafana.api.login.post.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_login_oauth_total
      target_field: grafana.api.login.oauth.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_models_dashboard_insert_total
      target_field: grafana.api.dashboard.insert.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_snapshot_create_total
      target_field: grafana.api.dashboard.snapshot.create.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_api_dashboard_snapshot_get_total
      target_field: grafana.api.dashboard.snapshot.get.total
      ignore_missing: true

  # --- HTTP ---
  - rename:
      field: prometheus.metrics.grafana_http_request_duration_seconds_count
      target_field: grafana.http.request.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_http_request_duration_seconds_sum
      target_field: grafana.http.request.duration.seconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_http_request_in_flight
      target_field: grafana.http.request.in_flight
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_http_response_size_bytes_count
      target_field: grafana.http.response.size.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_http_response_size_bytes_sum
      target_field: grafana.http.response.size.bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_page_response_status_total
      target_field: grafana.page.response.status.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_proxy_response_status_total
      target_field: grafana.proxy.response.status.total
      ignore_missing: true

  # --- Authentication ---
  - rename:
      field: prometheus.metrics.grafana_authentication_attempts
      target_field: grafana.authentication.attempts
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_authn_authn_successful_authentication_total
      target_field: grafana.authentication.successful.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_authn_authn_failed_authentication_total
      target_field: grafana.authentication.failed.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_authenticated_user_requests
      target_field: grafana.authentication.user_requests
      ignore_missing: true

  # --- Email ---
  - rename:
      field: prometheus.metrics.grafana_emails_sent_total
      target_field: grafana.emails.sent.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_emails_sent_failed
      target_field: grafana.emails.sent.failed
      ignore_missing: true

  # --- Live / WebSocket ---
  - rename:
      field: prometheus.metrics.grafana_live_node_num_channels
      target_field: grafana.live.channels
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_live_node_num_clients
      target_field: grafana.live.clients
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_live_node_num_subscriptions
      target_field: grafana.live.subscriptions
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_live_node_num_users
      target_field: grafana.live.users
      ignore_missing: true

  # --- Frontend ---
  - rename:
      field: prometheus.metrics.grafana_frontend_boot_load_time_seconds_count
      target_field: grafana.frontend.boot.load_time.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_frontend_boot_load_time_seconds_sum
      target_field: grafana.frontend.boot.load_time.seconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_frontend_boot_first_contentful_paint_time_seconds_count
      target_field: grafana.frontend.boot.fcp.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_frontend_boot_first_contentful_paint_time_seconds_sum
      target_field: grafana.frontend.boot.fcp.seconds
      ignore_missing: true

  # --- Other application metrics ---
  - rename:
      field: prometheus.metrics.grafana_public_dashboard_request_count
      target_field: grafana.public_dashboard.request_count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_rendering_queue_size
      target_field: grafana.rendering.queue_size
      ignore_missing: true

  # --- Process - Grafana-prefixed variants ---
  - rename:
      field: prometheus.metrics.grafana_process_cpu_seconds_total
      target_field: grafana.process.cpu.seconds.total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_process_resident_memory_bytes
      target_field: grafana.process.memory.resident_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_process_virtual_memory_bytes
      target_field: grafana.process.memory.virtual_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_process_open_fds
      target_field: grafana.process.open_fds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_process_max_fds
      target_field: grafana.process.max_fds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_process_start_time_seconds
      target_field: grafana.process.start_time_seconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_process_network_receive_bytes_total
      target_field: grafana.process.network.receive_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_process_network_transmit_bytes_total
      target_field: grafana.process.network.transmit_bytes
      ignore_missing: true
  # Process - standard Go variants (fallback if grafana_ prefix wasn't present)
  - rename:
      if: ctx.grafana?.process?.cpu?.seconds?.total == null
      field: prometheus.metrics.process_cpu_seconds_total
      target_field: grafana.process.cpu.seconds.total
      ignore_missing: true
  - rename:
      if: ctx.grafana?.process?.memory?.resident_bytes == null
      field: prometheus.metrics.process_resident_memory_bytes
      target_field: grafana.process.memory.resident_bytes
      ignore_missing: true
  - rename:
      if: ctx.grafana?.process?.memory?.virtual_bytes == null
      field: prometheus.metrics.process_virtual_memory_bytes
      target_field: grafana.process.memory.virtual_bytes
      ignore_missing: true
  - rename:
      if: ctx.grafana?.process?.open_fds == null
      field: prometheus.metrics.process_open_fds
      target_field: grafana.process.open_fds
      ignore_missing: true
  - rename:
      if: ctx.grafana?.process?.max_fds == null
      field: prometheus.metrics.process_max_fds
      target_field: grafana.process.max_fds
      ignore_missing: true
  - rename:
      if: ctx.grafana?.process?.start_time_seconds == null
      field: prometheus.metrics.process_start_time_seconds
      target_field: grafana.process.start_time_seconds
      ignore_missing: true
  - rename:
      if: ctx.grafana?.process?.network?.receive_bytes == null
      field: prometheus.metrics.process_network_receive_bytes_total
      target_field: grafana.process.network.receive_bytes
      ignore_missing: true
  - rename:
      if: ctx.grafana?.process?.network?.transmit_bytes == null
      field: prometheus.metrics.process_network_transmit_bytes_total
      target_field: grafana.process.network.transmit_bytes
      ignore_missing: true

  # --- Go runtime ---
  - rename:
      field: prometheus.metrics.go_goroutines
      target_field: grafana.go.goroutines
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_threads
      target_field: grafana.go.threads
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_heap_alloc_bytes
      target_field: grafana.go.memstats.heap_alloc_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_alloc_bytes
      target_field: grafana.go.memstats.alloc_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_alloc_bytes_total
      target_field: grafana.go.memstats.alloc_bytes_total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_sys_bytes
      target_field: grafana.go.memstats.sys_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_heap_idle_bytes
      target_field: grafana.go.memstats.heap_idle_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_heap_inuse_bytes
      target_field: grafana.go.memstats.heap_inuse_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_heap_objects
      target_field: grafana.go.memstats.heap_objects
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_heap_released_bytes
      target_field: grafana.go.memstats.heap_released_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_heap_sys_bytes
      target_field: grafana.go.memstats.heap_sys_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_stack_inuse_bytes
      target_field: grafana.go.memstats.stack_inuse_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_next_gc_bytes
      target_field: grafana.go.memstats.next_gc_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_mallocs_total
      target_field: grafana.go.memstats.mallocs_total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_frees_total
      target_field: grafana.go.memstats.frees_total
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_buck_hash_sys_bytes
      target_field: grafana.go.memstats.buck_hash_sys_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_gc_sys_bytes
      target_field: grafana.go.memstats.gc_sys_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_mcache_inuse_bytes
      target_field: grafana.go.memstats.mcache_inuse_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_mcache_sys_bytes
      target_field: grafana.go.memstats.mcache_sys_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_mspan_inuse_bytes
      target_field: grafana.go.memstats.mspan_inuse_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_mspan_sys_bytes
      target_field: grafana.go.memstats.mspan_sys_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_other_sys_bytes
      target_field: grafana.go.memstats.other_sys_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_stack_sys_bytes
      target_field: grafana.go.memstats.stack_sys_bytes
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_memstats_last_gc_time_seconds
      target_field: grafana.go.memstats.last_gc_time_seconds
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_gc_duration_seconds_count
      target_field: grafana.go.gc.duration.count
      ignore_missing: true
  - rename:
      field: prometheus.metrics.go_gc_duration_seconds_sum
      target_field: grafana.go.gc.duration.seconds
      ignore_missing: true

  # --- Build info ---
  - rename:
      field: prometheus.metrics.grafana_build_info
      target_field: grafana.build_info._value
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_build_timestamp
      target_field: grafana.build_info.timestamp
      ignore_missing: true
  - set:
      if: ctx.prometheus?.labels?.version != null
      field: grafana.build_info.version
      copy_from: prometheus.labels.version
      override: true
  - remove:
      field: prometheus.labels.version
      ignore_missing: true
  - set:
      if: ctx.prometheus?.labels?.edition != null
      field: grafana.build_info.edition
      copy_from: prometheus.labels.edition
      override: true
  - remove:
      field: prometheus.labels.edition
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_environment_info
      target_field: grafana.environment_info._value
      ignore_missing: true
  - rename:
      field: prometheus.metrics.grafana_instance_start_total
      target_field: grafana.instance.start_total
      ignore_missing: true

  # Drop remaining prometheus metrics (keep prometheus.labels for TSDS dimensions)
  # Only explicitly renamed metrics above are kept in the grafana.* namespace.
  - remove:
      field: prometheus.metrics
      ignore_missing: true

on_failure:
  - set:
      field: error.message
      value: "{{ _ingest.on_failure_message }}"
