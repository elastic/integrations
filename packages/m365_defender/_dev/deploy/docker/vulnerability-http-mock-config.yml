rules:
  - path: /tenant_id/oauth2/v2.0/token
    methods: [POST]
    responses:
      - status_code: 200
        headers:
          Content-Type:
            - "application/json"
        body: |-
          {"token_type":"Bearer","expires_in":3599,"ext_expires_in":3599,"access_token":"topsecretaccesstokenthatshouldnotbeleakedforabit"}
  # Refresh token to get access token: https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth2-auth-code-flow#refresh-the-access-token
  - path: /tenant_id/oauth2/token
    methods: [ POST ]
    query_params:
      refresh_token:
        - refresh_token_1
        - refresh_token_2
      grant_type: refresh_token
    request_headers:
      Authorization:
        - "Basic dGVzdC1hcHAtaWQ6dGVzdC1zZWNyZXQ="
      Content-Type:
        - "application/x-www-form-urlencoded"
    responses:
      - status_code: 200
        headers:
          Content-Type:
            - "application/json"
        body: |-
          {{ minify_json `
          {
            "access_token": "topsecretaccesstokenthatshouldnotbeleakedforabit",
            "token_type": "Bearer",
            "expires_in": 2,
            "scope": "https%3A%2F%2Fgraph.microsoft.com%2Fmail.read",
            "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
            "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
          }
          `}}
  - path: /api/machines/SoftwareVulnerabilitiesExport
    methods: ["GET"]
    query_params:
      sasValidHours: "2"
    request_headers:
      authorization: ["Bearer topsecretaccesstokenthatshouldnotbeleakedforabit"]
    responses:
      - status_code: 200
        headers:
          Content-Type:
            - "application/json"
        body: |-
          {{ minify_json `
          {
            "@odata.context": "https://api.security.microsoft.com/api/$metadata#microsoft.windowsDefenderATP.api.ExportFilesResponse",
            "exportFiles": [
                "http://svc-m365-defender-vulnerability-cel:8080/path/to/vuln"
            ],
            "generatedTime": "2025-10-09T00:00:00Z"
          }
          `}}
  - path: /path/to/vuln
    methods: ["GET"]
    responses:
      - status_code: 200
        headers:
          Content-Type:
            - "application/octet-stream"
        body: '{{file "/download-vulnerability.log.gz"}}'
