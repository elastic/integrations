---
description: Pipeline for processing Incident logs.
processors:
  - remove:
      field:
        - organization
        - division
        - team
      ignore_missing: true
      if: ctx.organization instanceof String && ctx.division instanceof String && ctx.team instanceof String
      tag: remove_agentless_tags
      description: >-
        Removes the fields added by Agentless as metadata,
        as they can collide with ECS fields.
  - set:
      tag: set_ecs_version_0f7334bb
      field: ecs.version
      value: '8.11.0'
  - rename:
      tag: rename_message_to_event_original_c74b1d7e
      field: message
      target_field: event.original
      ignore_missing: true
      if: 'ctx.event?.original == null'
      description: 'Renames the original `message` field to `event.original` to store a copy of the original message. The `event.original` field is not touched if the document already has one; it may happen when Logstash sends the document.'
  - remove:
      tag: remove_message_2ee3a7d4
      field: message
      ignore_missing: true
      if: 'ctx.event?.original != null'
      description: 'The `message` field is no longer required if the document has an `event.original` field.'
  - json:
      tag: json_event_original_to_json_5e54dc16
      field: event.original
      target_field: json
  - drop:
      tag: drop_d9b8968b
      if: ctx.json?.value != null && ctx.json.value.isEmpty()
  - remove:
      tag: remove_json_alerts_3223f53f
      field: json.alerts
      if: ctx.json?.alerts != null && ctx.json.alerts.isEmpty()
  - fingerprint:
      tag: fingerprint_a991fd6f
      fields:
        - json.id
        - json.lastUpdateDateTime
        - json.incidentWebUrl
        - json.createdDateTime
        - json.alerts.id
        - json.alerts.lastUpdateDateTime
      target_field: _id
      ignore_missing: true
  - set:
      tag: set_event_kind_39295792
      field: event.kind
      value: alert
  - append:
      tag: append_event_category_f8516cec
      field: event.category
      value: malware
      if: ctx.json?.determination != null && ['malware','malicioususeractivity'].contains(ctx.json.determination.toLowerCase())
  - append:
      tag: append_event_category_a2f224aa
      field: event.category
      value: email
      if: ctx.json?.determination != null && ctx.json.determination.toLowerCase() == 'phishing'
  - append:
      tag: append_event_category_e3b312a3
      field: event.category
      value: threat
      if: ctx.json?.determination != null && ctx.json.determination.toLowerCase() == 'apt'
  - append:
      tag: append_event_type_afbaa211
      field: event.type
      value: indicator
      if: ctx.event?.category != null && (ctx.event.category).contains('threat')
  - append:
      tag: append_event_type_e07a8062
      field: event.type
      value: info
      if: ctx.event?.category != null && ((ctx.event.category).contains('email') || (ctx.event.category).contains('malware'))
  - dot_expander:
      tag: dot_expander_odata_type_3e061147
      field: '@odata.type'
      path: json
      ignore_failure: true
      override: true
  - rename:
      tag: rename_json_odata_type_to_m365_defender_incident_odata_type_df323ac6
      field: json.@odata.type
      target_field: m365_defender.incident.odata_type
      ignore_missing: true
  - date:
      tag: date_json_lastUpdateDateTime_to_m365_defender_incident_last_update_datetime_8aa4fd36
      field: json.lastUpdateDateTime
      target_field: m365_defender.incident.last_update_datetime
      formats:
        - ISO8601
      if: ctx.json?.lastUpdateDateTime != null
      on_failure:
        - remove:
            tag: remove_json_lastUpdateDateTime_365215ad
            field: json.lastUpdateDateTime
            ignore_missing: true
        - append:
            tag: append_error_message_92a8b409
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      tag: set_timestamp_bb0275ef
      field: '@timestamp'
      copy_from: m365_defender.incident.last_update_datetime
      ignore_failure: true
  - rename:
      tag: rename_json_displayName_to_m365_defender_incident_display_name_d3256294
      field: json.displayName
      target_field: m365_defender.incident.display_name
      ignore_missing: true
  - set:
      tag: set_message_a43ab586
      field: message
      copy_from: m365_defender.incident.display_name
      ignore_failure: true
  - rename:
      tag: rename_json_tenantId_to_m365_defender_incident_tenant_id_c5efdac2
      field: json.tenantId
      target_field: m365_defender.incident.tenant_id
      ignore_missing: true
  - set:
      tag: set_cloud_account_id_949387a2
      field: cloud.account.id
      copy_from: m365_defender.incident.tenant_id
      ignore_failure: true
  - date:
      tag: date_json_createdDateTime_to_m365_defender_incident_created_datetime_c1c738dd
      field: json.createdDateTime
      target_field: m365_defender.incident.created_datetime
      formats:
        - ISO8601
      if: ctx.json?.createdDateTime != null
      on_failure:
        - remove:
            tag: remove_json_createdDateTime_c83d6ce9
            field: json.createdDateTime
            ignore_missing: true
        - append:
            tag: append_error_message_68e91a60
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      tag: set_event_created_86b4f339
      field: event.created
      copy_from: m365_defender.incident.created_datetime
      ignore_failure: true
  - rename:
      tag: rename_json_id_to_m365_defender_incident_id_681e17dd
      field: json.id
      target_field: m365_defender.incident.id
      ignore_missing: true
  - set:
      tag: set_event_id_7919481b
      field: event.id
      copy_from: m365_defender.incident.id
      ignore_failure: true
  - rename:
      tag: rename_json_alerts_serviceSource_to_m365_defender_incident_alert_service_source_80c39f93
      field: json.alerts.serviceSource
      target_field: m365_defender.incident.alert.service_source
      ignore_missing: true
  - set:
      tag: set_event_provider_6d36d6f3
      field: event.provider
      copy_from: m365_defender.incident.alert.service_source
      ignore_failure: true
  - lowercase:
      tag: lowercase_json_severity_to_m365_defender_incident_severity_4607249e
      field: json.severity
      target_field: m365_defender.incident.severity
      ignore_failure: true
  - script:
      lang: painless
      description: Script to set event.severity.
      tag: set_event_severity
      if: ctx.m365_defender?.incident?.severity instanceof String
      source: |-
        ctx.event = ctx.event ?: [:];
        String risk_score_value = ctx.m365_defender.incident.severity;
        if (risk_score_value.equalsIgnoreCase("low") || risk_score_value.equalsIgnoreCase("informational")) {
          ctx.event.severity = 21;
        } else if (risk_score_value.equalsIgnoreCase("medium")) {
          ctx.event.severity = 47;
        } else if (risk_score_value.equalsIgnoreCase("high")) {
          ctx.event.severity = 73;
        } else if (risk_score_value.equalsIgnoreCase("critical")) {
          ctx.event.severity = 99;
        }
      on_failure:
        - append:
            tag: append_error_message_ff963832
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - uri_parts:
      tag: uri_parts_json_incidentWebUrl_to_m365_defender_incident_web_url_1e7447fe
      field: json.incidentWebUrl
      target_field: m365_defender.incident.web_url
      if: ctx.json?.incidentWebUrl != null
      keep_original: true
      on_failure:
        - remove:
            tag: remove_json_incidentWebUrl_35b6da97
            field: json.incidentWebUrl
        - append:
            tag: append_error_message_fb3d52d3
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - set:
      tag: set_event_url_2155febd
      field: event.url
      copy_from: m365_defender.incident.web_url.original
      ignore_failure: true
  - rename:
      tag: rename_json_assignedTo_to_m365_defender_incident_assigned_to_5b9f46aa
      field: json.assignedTo
      target_field: m365_defender.incident.assigned_to
      ignore_missing: true
  - grok:
      tag: grok_m365_defender_incident_assigned_to_bf018620
      field: m365_defender.incident.assigned_to
      patterns:
        - '%{USERNAME:source.user.name}@%{HOSTNAME:source.user.domain}'
        - '%{GREEDYDATA:source.user.name}'
      ignore_missing: true
      ignore_failure: true
  - set:
      field: source.user.email
      copy_from: m365_defender.incident.assigned_to
      tag: copy_source_user_email
      if: ctx.m365_defender?.incident?.assigned_to != null && ctx.m365_defender.incident.assigned_to.indexOf("@") > 0
  - append:
      tag: append_related_user_fb2b187b
      field: related.user
      value: '{{{source.user.name}}}'
      allow_duplicates: false
      ignore_failure: true
      if: ctx.source?.user?.name != null
  - append:
      tag: append_related_user_f290fda3
      field: related.user
      value: '{{{source.user.email}}}'
      allow_duplicates: false
      ignore_failure: true
      if: ctx.source?.user?.email != null
  - rename:
      tag: rename_json_alerts_threatFamilyName_to_m365_defender_incident_alert_threat_family_name_c183d3ba
      field: json.alerts.threatFamilyName
      target_field: m365_defender.incident.alert.threat_family_name
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_category_to_m365_defender_incident_alert_category_5318bb3a
      field: json.alerts.category
      target_field: m365_defender.incident.alert.category
      ignore_missing: true
  - append:
      tag: append_threat_tactic_name_841337a0
      field: threat.tactic.name
      value: '{{{m365_defender.incident.alert.category}}}'
      allow_duplicates: false
      ignore_failure: true
  - rename:
      tag: rename_json_alerts_mitreTechniques_to_m365_defender_incident_alert_mitre_techniques_c8f2fa2b
      field: json.alerts.mitreTechniques
      target_field: m365_defender.incident.alert.mitre_techniques
      ignore_missing: true
  - set:
      tag: set_threat_technique_subtechnique_id_1e18b023
      field: threat.technique.subtechnique.id
      copy_from: m365_defender.incident.alert.mitre_techniques
      ignore_failure: true
  - rename:
      tag: rename_json_alerts_actorDisplayName_to_m365_defender_incident_alert_actor_display_name_d08c53de
      field: json.alerts.actorDisplayName
      target_field: m365_defender.incident.alert.actor_display_name
      ignore_missing: true
  - uri_parts:
      tag: uri_parts_json_alerts_alertWebUrl_to_m365_defender_incident_alert_alert_web_url_15daaa51
      field: json.alerts.alertWebUrl
      target_field: m365_defender.incident.alert.alert_web_url
      if: ctx.json?.alerts?.alertWebUrl != null
      keep_original: true
      on_failure:
        - remove:
            tag: remove_json_alerts_alertWebUrl_16872bf7
            field: json.alerts.alertWebUrl
        - append:
            tag: append_error_message_390fc78a
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      tag: rename_json_alerts_assignedTo_to_m365_defender_incident_alert_assigned_to_591c3835
      field: json.alerts.assignedTo
      target_field: m365_defender.incident.alert.assigned_to
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_classification_to_m365_defender_incident_alert_classification_0f8328c2
      field: json.alerts.classification
      target_field: m365_defender.incident.alert.classification
      ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_comments_bf061f74
      field: json.alerts.comments
      if: ctx.json?.alerts?.comments instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.createdByDisplayName}}}'
          allow_duplicates: false
          ignore_failure: true
  - rename:
      tag: rename_json_alerts_comments_to_m365_defender_incident_alert_comments_f5dee286
      field: json.alerts.comments
      target_field: m365_defender.incident.alert.comments
      ignore_missing: true
  - date:
      tag: date_json_alerts_createdDateTime_to_m365_defender_incident_alert_created_datetime_18ffd7e1
      field: json.alerts.createdDateTime
      target_field: m365_defender.incident.alert.created_datetime
      formats:
        - ISO8601
      if: ctx.json?.alerts?.createdDateTime != null
      on_failure:
        - remove:
            tag: remove_json_alerts_createdDateTime_cf19198c
            field: json.alerts.createdDateTime
            ignore_missing: true
        - append:
            tag: append_error_message_b7568088
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      tag: rename_json_alerts_description_to_m365_defender_incident_alert_description_2c05f3de
      field: json.alerts.description
      target_field: m365_defender.incident.alert.description
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_detectionSource_to_m365_defender_incident_alert_detection_source_3238f6bf
      field: json.alerts.detectionSource
      target_field: m365_defender.incident.alert.detection_source
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_detectorId_to_m365_defender_incident_alert_detector_id_4ea435dd
      field: json.alerts.detectorId
      target_field: m365_defender.incident.alert.detector_id
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_determination_to_m365_defender_incident_alert_determination_48b918be
      field: json.alerts.determination
      target_field: m365_defender.incident.alert.determination
      ignore_missing: true
  - script:
      lang: painless
      description: Drops empty string values recursively.
      tag: painless_remove_empty_from_evidence
      if: ctx.json?.alerts?.evidence != null
      source: |-
        boolean drop(Object object) {
          if (object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(v -> drop(v));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(v -> drop(v));
            return (((List) object).length == 0);
          }
          return false;
        }
        drop(ctx.json.alerts.evidence);
  - foreach:
      tag: foreach_json_alerts_evidence_8abbf466
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        date:
          field: _ingest._value.createdDateTime
          target_field: _ingest._value.created_datetime
          formats:
            - ISO8601
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_f4f59654
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.remediationStatus
          target_field: _ingest._value.remediation_status
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_221556c5
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.remediationStatusDetails
          target_field: _ingest._value.remediation_status_details
          ignore_missing: true
  - date:
      tag: date_json_alerts_firstActivityDateTime_to_m365_defender_incident_alert_first_activity_datetime_9d12d05c
      field: json.alerts.firstActivityDateTime
      target_field: m365_defender.incident.alert.first_activity_datetime
      formats:
        - ISO8601
      if: ctx.json?.alerts?.firstActivityDateTime != null
      on_failure:
        - remove:
            tag: remove_json_alerts_firstActivityDateTime_c34c70a8
            field: json.alerts.firstActivityDateTime
            ignore_missing: true
        - append:
            tag: append_error_message_e8ae3bfb
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      tag: rename_json_alerts_id_to_m365_defender_incident_alert_id_f264e084
      field: json.alerts.id
      target_field: m365_defender.incident.alert.id
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_incidentId_to_m365_defender_incident_alert_incident_id_60022b55
      field: json.alerts.incidentId
      target_field: m365_defender.incident.alert.incident_id
      ignore_missing: true
  - uri_parts:
      tag: uri_parts_json_alerts_incidentWebUrl_to_m365_defender_incident_alert_incident_web_url_83eca8e9
      field: json.alerts.incidentWebUrl
      target_field: m365_defender.incident.alert.incident_web_url
      if: ctx.json?.alerts?.incidentWebUrl != null
      keep_original: true
      on_failure:
        - remove:
            tag: remove_json_alerts_incidentWebUrl_2874a3b7
            field: json.alerts.incidentWebUrl
        - append:
            tag: append_error_message_d6de5c6e
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - date:
      tag: date_json_alerts_lastActivityDateTime_to_m365_defender_incident_alert_last_activity_datetime_bbd95506
      field: json.alerts.lastActivityDateTime
      target_field: m365_defender.incident.alert.last_activity_datetime
      formats:
        - ISO8601
      if: ctx.json?.alerts?.lastActivityDateTime != null
      on_failure:
        - remove:
            tag: remove_json_alerts_lastActivityDateTime_aa228414
            field: json.alerts.lastActivityDateTime
            ignore_missing: true
        - append:
            tag: append_error_message_68c7dc85
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - date:
      tag: date_json_alerts_lastUpdateDateTime_to_m365_defender_incident_alert_last_update_datetime_3128390e
      field: json.alerts.lastUpdateDateTime
      target_field: m365_defender.incident.alert.last_update_datetime
      formats:
        - ISO8601
      if: ctx.json?.alerts?.lastUpdateDateTime != null
      on_failure:
        - remove:
            tag: remove_json_alerts_lastUpdateDateTime_2b93c700
            field: json.alerts.lastUpdateDateTime
            ignore_missing: true
        - append:
            tag: append_error_message_ae7b119d
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      tag: rename_json_alerts_providerAlertId_to_m365_defender_incident_alert_provider_alert_id_764de052
      field: json.alerts.providerAlertId
      target_field: m365_defender.incident.alert.provider_alert_id
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_recommendedActions_to_m365_defender_incident_alert_recommended_actions_decb936d
      field: json.alerts.recommendedActions
      target_field: m365_defender.incident.alert.recommended_actions
      ignore_missing: true
  - date:
      tag: date_json_alerts_resolvedDateTime_to_m365_defender_incident_alert_resolved_datetime_0cfb10e3
      field: json.alerts.resolvedDateTime
      target_field: m365_defender.incident.alert.resolved_datetime
      formats:
        - ISO8601
      if: ctx.json?.alerts?.resolvedDateTime != null
      on_failure:
        - remove:
            tag: remove_json_alerts_resolvedDateTime_170defae
            field: json.alerts.resolvedDateTime
            ignore_missing: true
        - append:
            tag: append_error_message_7e6704fa
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - rename:
      tag: rename_json_alerts_severity_to_m365_defender_incident_alert_severity_119ae478
      field: json.alerts.severity
      target_field: m365_defender.incident.alert.severity
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_status_to_m365_defender_incident_alert_status_21e2aa26
      field: json.alerts.status
      target_field: m365_defender.incident.alert.status
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_tenantId_to_m365_defender_incident_alert_tenant_id_60f7b125
      field: json.alerts.tenantId
      target_field: m365_defender.incident.alert.tenant_id
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_threatDisplayName_to_m365_defender_incident_alert_threat_display_name_0b38a882
      field: json.alerts.threatDisplayName
      target_field: m365_defender.incident.alert.threat_display_name
      ignore_missing: true
  - rename:
      tag: rename_json_alerts_title_to_m365_defender_incident_alert_title_0a247a8a
      field: json.alerts.title
      target_field: m365_defender.incident.alert.title
      ignore_missing: true
  - rename:
      tag: rename_json_classification_to_m365_defender_incident_classification_fe0ed053
      field: json.classification
      target_field: m365_defender.incident.classification
      ignore_missing: true
  - foreach:
      tag: foreach_json_comments_8b3f6843
      field: json.comments
      if: ctx.json?.comments instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.createdByDisplayName}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_comments_e6153754
      field: json.comments
      if: ctx.json?.comments instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.createdBy}}}'
          allow_duplicates: false
          ignore_failure: true
  - rename:
      tag: rename_json_comments_to_m365_defender_incident_comments_e0638933
      field: json.comments
      target_field: m365_defender.incident.comments
      ignore_missing: true
  - rename:
      tag: rename_json_determination_to_m365_defender_incident_determination_898d1b6f
      field: json.determination
      target_field: m365_defender.incident.determination
      ignore_missing: true
  - rename:
      tag: rename_json_redirectIncidentId_to_m365_defender_incident_redirect_incident_id_80ca4653
      field: json.redirectIncidentId
      target_field: m365_defender.incident.redirect_incident_id
      ignore_missing: true
  - rename:
      tag: rename_json_status_to_m365_defender_incident_status_bd7492ab
      field: json.status
      target_field: m365_defender.incident.status
      ignore_missing: true
  - rename:
      tag: rename_json_tags_to_m365_defender_incident_tags_4b17c251
      field: json.tags
      target_field: m365_defender.incident.tags
      ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_a1672010
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        dot_expander:
          field: '@odata.type'
          path: _ingest._value
          ignore_failure: true
          override: true
  - foreach:
      tag: foreach_json_alerts_evidence_a2db0b0b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        rename:
          field: _ingest._value.@odata.type
          target_field: _ingest._value.odata_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_010d588a
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        date:
          field: _ingest._value.receivedDateTime
          target_field: _ingest._value.received_datetime
          formats:
            - ISO8601
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_39305e58
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: email.delivery_timestamp
          value: '{{{_ingest._value.received_datetime}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_fb9d7bc4
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.antiSpamDirection
          target_field: _ingest._value.antispam_direction
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_f5531816
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: email.direction
          value: '{{{_ingest._value.antispam_direction}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_ec199680
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: email.subject
          value: '{{{_ingest._value.subject}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_9c8b3445
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.recipientEmailAddress
          target_field: _ingest._value.recipient_email_address
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_dccf038b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.recipient_email_address}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_6b74fbce
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: email.to.address
          value: '{{{_ingest._value.recipient_email_address}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_9f1c82fe
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.attachmentsCount
          target_field: _ingest._value.attachments_count
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.attachmentsCount
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_9c3ff4ec
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.deliveryAction
          target_field: _ingest._value.delivery_action
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_94f07ef8
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.deliveryLocation
          target_field: _ingest._value.delivery_location
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_da50797b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.internetMessageId
          target_field: _ingest._value.internet_message_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_a3611723
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.networkMessageId
          target_field: _ingest._value.network_message_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_9e7edee8
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        dot_expander:
          field: '@odata.type'
          path: _ingest._value.p1Sender
          ignore_failure: true
          override: true
  - foreach:
      tag: foreach_json_alerts_evidence_fffa35fc
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        rename:
          field: _ingest._value.p1Sender.@odata.type
          target_field: _ingest._value.p1_sender.odata_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_5aaf2207
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        dot_expander:
          field: '@odata.type'
          path: _ingest._value.p2Sender
          ignore_failure: true
          override: true
  - foreach:
      tag: foreach_json_alerts_evidence_b22c25f6
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        rename:
          field: _ingest._value.p2Sender.@odata.type
          target_field: _ingest._value.p2_sender.odata_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_ee4d629b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.p1Sender.displayName
          target_field: _ingest._value.p1_sender.display_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_2e2fe50b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.p1_sender.display_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_21256efb
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.p1Sender.domainName
          target_field: _ingest._value.p1_sender.domain_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_465b8a21
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hosts
          value: '{{{_ingest._value.p1_sender.domain_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_d75a3b19
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.p1Sender.emailAddress
          target_field: _ingest._value.p1_sender.email_address
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_08fe3abc
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: email.from.address
          value: '{{{_ingest._value.p1_sender.email_address}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_62ac7120
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.p1_sender.email_address}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_e16785f1
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.p2Sender.displayName
          target_field: _ingest._value.p2_sender.display_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_f205d7ee
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.p2_sender.display_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_4fa9ddf7
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.p2Sender.domainName
          target_field: _ingest._value.p2_sender.domain_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_04b5b62a
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hosts
          value: '{{{_ingest._value.p2_sender.domain_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_f760b001
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.p2Sender.emailAddress
          target_field: _ingest._value.p2_sender.email_address
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_8ee17e17
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: email.from.address
          value: '{{{_ingest._value.p2_sender.email_address}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_6d5b27bb
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.p2_sender.email_address}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_a1b707c6
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.senderIp
          target_field: _ingest._value.sender_ip
          type: ip
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.senderIp
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_7074b98d
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.ip
          value: '{{{_ingest._value.sender_ip}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_3bca5391
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.threatDetectionMethods
          target_field: _ingest._value.threat_detection_methods
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_4c10de45
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.urlCount
          target_field: _ingest._value.url_count
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.urlCount
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_c5c85a40
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.instanceId
          target_field: _ingest._value.instance_id
          type: string
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.instanceId
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_3a23098e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: cloud.instance.id
          value: '{{{_ingest._value.instance_id}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_47527d5e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.instanceName
          target_field: _ingest._value.instance_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_b2116276
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: cloud.instance.name
          value: '{{{_ingest._value.instance_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_42e8bbae
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.appId
          target_field: _ingest._value.app_id
          type: string
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.appId
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_1b72e646
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.displayName
          target_field: _ingest._value.display_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_1133ba9d
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.saasAppId
          target_field: _ingest._value.saas_app_id
          type: string
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.saasAppId
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_c9dc4a37
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.vmMetadata.cloudProvider
          target_field: _ingest._value.vm_metadata.cloud_provider
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_4cf9abcb
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.mdeDeviceId
          target_field: _ingest._value.mde_device_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_5d670400
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.osPlatform
          target_field: _ingest._value.os_platform
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_ff17203b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: host.os.name
          value: '{{{_ingest._value.os_platform}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_2a9bcb76
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: host.os.version
          value: '{{{_ingest._value.version}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_45596747
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: device.id
          tag: append_azureAdDeviceId_into_device_id
          value: '{{{_ingest._value.azureAdDeviceId}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_json_alerts_evidence_6f1695c6
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.azureAdDeviceId
          target_field: _ingest._value.azure_ad_device_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_97bf5135
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.defenderAvStatus
          target_field: _ingest._value.defender_av_status
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_100576b3
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.deviceDnsName
          target_field: _ingest._value.device_dns_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_91282048
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hosts
          value: '{{{_ingest._value.device_dns_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_c644fa79
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: host.name
          value: '{{{_ingest._value.device_dns_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      field: json.alerts.evidence
      tag: foreach_evidence_append_device_dns_name_to_host_hostname
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: host.hostname
          tag: append_foreach_evidence_device_dns_name_to_host_hostname
          value: '{{{_ingest._value.device_dns_name}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_json_alerts_evidence_8aa50569
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        date:
          field: _ingest._value.firstSeenDateTime
          target_field: _ingest._value.first_seen_datetime
          formats:
            - ISO8601
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_b3e98b48
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.healthStatus
          target_field: _ingest._value.health_status
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_02ebd7fc
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        foreach:
          field: _ingest._value.loggedOnUsers
          ignore_failure: true
          ignore_missing: true
          processor:
            rename:
              field: _ingest._value.accountName
              target_field: _ingest._value.account_name
              ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_6e5325b1
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        foreach:
          field: _ingest._value.loggedOnUsers
          ignore_failure: true
          ignore_missing: true
          processor:
            append:
              field: user.name
              value: '{{{_ingest._value.account_name}}}'
              allow_duplicates: false
              ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_e8504b63
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        foreach:
          field: _ingest._value.loggedOnUsers
          ignore_failure: true
          ignore_missing: true
          processor:
            append:
              field: related.user
              value: '{{{_ingest._value.account_name}}}'
              allow_duplicates: false
              ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_df9684d6
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        foreach:
          field: _ingest._value.loggedOnUsers
          ignore_failure: true
          ignore_missing: true
          processor:
            rename:
              field: _ingest._value.domainName
              target_field: _ingest._value.domain_name
              ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_6bae05c4
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        foreach:
          field: _ingest._value.loggedOnUsers
          ignore_failure: true
          ignore_missing: true
          processor:
            append:
              field: related.hosts
              value: '{{{_ingest._value.domain_name}}}'
              allow_duplicates: false
              ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_13c1c475
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        foreach:
          field: _ingest._value.loggedOnUsers
          ignore_failure: true
          ignore_missing: true
          processor:
            dot_expander:
              field: '@odata.type'
              path: _ingest._value
              ignore_failure: true
              override: true
  - foreach:
      tag: foreach_json_alerts_evidence_ea8823d2
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        foreach:
          field: _ingest._value.loggedOnUsers
          ignore_failure: true
          ignore_missing: true
          processor:
            rename:
              field: _ingest._value.@odata.type
              target_field: _ingest._value.odata_type
              ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_6e04cc31
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.loggedOnUsers
          target_field: _ingest._value.logged_on_users
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_c1bbd306
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.onboardingStatus
          target_field: _ingest._value.onboarding_status
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_bf826be2
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.osBuild
          target_field: _ingest._value.os_build
          type: string
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.osBuild
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_59a48364
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.rbacGroupId
          target_field: _ingest._value.rbac_group.id
          type: string
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.rbacGroupId
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_a26c85f6
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.rbacGroupName
          target_field: _ingest._value.rbac_group.name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_2b29a72e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.riskScore
          target_field: _ingest._value.risk_score
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_873b54ca
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        dot_expander:
          field: '@odata.type'
          path: _ingest._value.vmMetadata
          ignore_failure: true
          override: true
  - foreach:
      tag: foreach_json_alerts_evidence_1fcc21c4
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        rename:
          field: _ingest._value.vmMetadata.@odata.type
          target_field: _ingest._value.vm_metadata.odata_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_4cd9c2e3
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.vmMetadata.resourceId
          target_field: _ingest._value.vm_metadata.resource_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_65fa1219
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.vmMetadata.subscriptionId
          target_field: _ingest._value.vm_metadata.subscription_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_f1929935
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.vmMetadata.vmId
          target_field: _ingest._value.vm_metadata.vm_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_8266eec8
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.detectionStatus
          target_field: _ingest._value.detection_status
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_c56c5c10
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: event.action
          value: '{{{_ingest._value.detection_status}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_a7f30a76
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        dot_expander:
          field: '@odata.type'
          path: _ingest._value.fileDetails
          ignore_failure: true
          override: true
  - foreach:
      tag: foreach_json_alerts_evidence_ded9159e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        rename:
          field: _ingest._value.fileDetails.@odata.type
          target_field: _ingest._value.file_details.odata_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_1c59cd80
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.fileDetails.sha1
          target_field: _ingest._value.file_details.sha1
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_be825919
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: file.hash.sha1
          value: '{{{_ingest._value.file_details.sha1}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_daeb8781
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hash
          value: '{{{_ingest._value.file_details.sha1}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_60e0cb20
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.fileDetails.sha256
          target_field: _ingest._value.file_details.sha256
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_fb2c64c9
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: file.hash.sha256
          value: '{{{_ingest._value.file_details.sha256}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_1ad1b0fb
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hash
          value: '{{{_ingest._value.file_details.sha256}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_83468816
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.fileDetails.fileName
          target_field: _ingest._value.file_details.name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_2369e501
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: file.name
          value: '{{{_ingest._value.file_details.name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_c1fc666e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.fileDetails.filePath
          target_field: _ingest._value.file_details.path
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_e7875ce0
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: file.path
          value: '{{{_ingest._value.file_details.path}}}\{{{_ingest._value.file_details.name}}}'
          allow_duplicates: false
          ignore_failure: true
  - script:
      tag: script_remove_backslash
      if: ctx.file?.path instanceof List
      source: |-
        ctx.file.path.removeIf(v -> v == '\\');
  - foreach:
      tag: foreach_json_alerts_evidence_78ab6d3a
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.fileDetails.fileSize
          target_field: _ingest._value.file_details.size
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.fileDetails.fileSize
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_7c0fafec
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.fileDetails.filePublisher
          target_field: _ingest._value.file_details.publisher
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_1266b300
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.fileDetails.issuer
          target_field: _ingest._value.file_details.issuer
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_5c1bcd9c
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.fileDetails.signer
          target_field: _ingest._value.file_details.signer
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_d0c4ab13
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.ipAddress
          target_field: _ingest._value.ip_address
          type: ip
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.ipAddress
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_1135257e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: source.ip
          value: '{{{_ingest._value.ip_address}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_7b0c511e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.ip
          value: '{{{_ingest._value.ip_address}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_8d1c8a58
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        dot_expander:
          field: '@odata.type'
          path: _ingest._value.userAccount
          ignore_failure: true
          override: true
  - foreach:
      tag: foreach_json_alerts_evidence_52f17fd4
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        rename:
          field: _ingest._value.userAccount.@odata.type
          target_field: _ingest._value.user_account.odata_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_2515683b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.userAccount.domainName
          target_field: _ingest._value.user_account.domain_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_6dce4ee1
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hosts
          value: '{{{_ingest._value.user_account.domain_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_64a98b81
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.userAccount.azureAdUserId
          target_field: _ingest._value.user_account.azure_ad_user_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_4126785c
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.user_account.azure_ad_user_id}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_70407370
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.userAccount.userPrincipalName
          target_field: _ingest._value.user_account.user_principal_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_032bc33b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.user_account.user_principal_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_05766122
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.primaryAddress
          target_field: _ingest._value.primary_address
          ignore_missing: true
  - foreach:
      field: json.alerts.evidence
      tag: foreach_evidence_append_primary_address_to_user_email
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: user.email
          tag: append_foreach_evidence_primary_address_to_user_email
          value: '{{{_ingest._value.primary_address}}}'
          allow_duplicates: false
  - foreach:
      field: json.alerts.evidence
      tag: foreach_evidence_append_primary_address_to_related_user
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          tag: append_foreach_evidence_primary_address_to_related_user
          value: '{{{_ingest._value.primary_address}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_json_alerts_evidence_127b1a0d
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.userAccount.accountName
          target_field: _ingest._value.user_account.account_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_4241348b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.userAccount.displayName
          target_field: _ingest._value.user_account.display_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_39cdc106
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.user_account.display_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_02f2f8ac
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.user_account.account_name}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_bdf2d64f
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.userAccount.userSid
          target_field: _ingest._value.user_account.user_sid
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_b526a117
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.user
          value: '{{{_ingest._value.user_account.user_sid}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_68c4a3ae
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.clusterBy
          target_field: _ingest._value.cluster_by
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_12ea28a9
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.clusterByValue
          target_field: _ingest._value.cluster_by_value
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_17585420
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.emailCount
          target_field: _ingest._value.email_count
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.emailCount
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_e4d27f3f
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.networkMessageIds
          target_field: _ingest._value.network_message_ids
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_91f5c95a
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.objectId
          target_field: _ingest._value.object_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_ef286996
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.processCommandLine
          target_field: _ingest._value.process.command_line
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_7c9f5b30
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: process.command_line
          value: '{{{_ingest._value.process.command_line}}}'
          allow_duplicates: false
          ignore_failure: true
  - script:
      lang: painless
      tag: set_process_name_from_command_line
      description: Set process.name from process.command_line.
      source: |
        ctx.process = ctx.process ?: [:];
        ctx.process.name = ctx.process.name ?: [];
        // Normalize process.name to a list
        def nameList = [];
        if (ctx.process.name != null) {
          if (ctx.process.name instanceof String) {
            nameList.add(ctx.process.name);
          } else if (ctx.process.name instanceof List) {
            nameList.addAll(ctx.process.name);
          }
        }

        // Deduplication using HashSet
        def currentNames = new HashSet();
        currentNames.addAll(nameList);
        // Handle process.command_line (string or list)
        if (ctx.process.command_line != null) {
          // Convert string to list for unified handling
          def cmdList = [];
          if (ctx.process.command_line instanceof String) {
            cmdList.add(ctx.process.command_line);
          } else if (ctx.process.command_line instanceof List) {
            cmdList.addAll(ctx.process.command_line);
          }
          for (cmd in cmdList) {
            if (cmd != null && cmd.length() > 0) {
              // Extract the first token
              def parts = cmd.trim().splitOnToken(" ");
              if (parts.length > 0) {
                def executable = parts[0];
                // If executable is a path, take only the last part
                if (executable.contains("/")) {
                  def slashParts = executable.splitOnToken("/");
                  executable = slashParts[slashParts.length - 1];
                }
                executable = /\"/.matcher(executable).replaceAll("");
                currentNames.add(executable);
              }
            }
          }
        }
        // Update process.name with unique list
        if (currentNames != null && currentNames.size() == 1) {
          ctx.process.name = currentNames.iterator().next();
        } else {
          ctx.process.name = new ArrayList(currentNames);
        }
      on_failure:
        - append:
            tag: append_error_message_6ff52099
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_a40d6a77
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        dot_expander:
          field: '@odata.type'
          path: _ingest._value.imageFile
          ignore_failure: true
          override: true
  - foreach:
      tag: foreach_json_alerts_evidence_5ecefbd0
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        rename:
          field: _ingest._value.imageFile.@odata.type
          target_field: _ingest._value.image_file.odata_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_92383204
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.imageFile.sha1
          target_field: _ingest._value.image_file.sha1
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_51ea5225
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: process.hash.sha1
          value: '{{{_ingest._value.image_file.sha1}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_47cf5f30
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hash
          value: '{{{_ingest._value.image_file.sha1}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_c101c758
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.imageFile.sha256
          target_field: _ingest._value.image_file.sha256
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_730e66e1
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: process.hash.sha256
          value: '{{{_ingest._value.image_file.sha256}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_6594b75e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hash
          value: '{{{_ingest._value.image_file.sha256}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_8cfd1c7e
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        dot_expander:
          field: '@odata.type'
          path: _ingest._value.parentProcessImageFile
          ignore_failure: true
          override: true
  - foreach:
      tag: foreach_json_alerts_evidence_cf4a2417
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      processor:
        rename:
          field: _ingest._value.parentProcessImageFile.@odata.type
          target_field: _ingest._value.parent_process.image_file.odata_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_bb5f493d
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.parentProcessImageFile.sha1
          target_field: _ingest._value.parent_process.image_file.sha1
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_8ef2fdb5
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: process.parent.hash.sha1
          value: '{{{_ingest._value.parent_process.image_file.sha1}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_04e83004
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hash
          value: '{{{_ingest._value.parent_process.image_file.sha1}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_7baea111
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.parentProcessImageFile.sha256
          target_field: _ingest._value.parent_process.image_file.sha256
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_18599ec9
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: process.parent.hash.sha256
          value: '{{{_ingest._value.parent_process.image_file.sha256}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_615f4f62
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: related.hash
          value: '{{{_ingest._value.parent_process.image_file.sha256}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_18bff8ef
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.parentProcessId
          target_field: _ingest._value.parent_process.id
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.parentProcessId
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_cdf1175b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        date:
          field: _ingest._value.parentProcessCreationDateTime
          target_field: _ingest._value.parent_process.creation_datetime
          formats:
            - ISO8601
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_710f8c90
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: process.parent.start
          value: '{{{_ingest._value.parent_process.creation_datetime}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_79f78a80
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.processId
          target_field: _ingest._value.process.id
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.processId
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_e81cdbce
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        date:
          field: _ingest._value.processCreationDateTime
          target_field: _ingest._value.process.creation_datetime
          formats:
            - ISO8601
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_449df185
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: process.start
          value: '{{{_ingest._value.process.creation_datetime}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_6f2db046
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.imageFile.fileName
          target_field: _ingest._value.image_file.name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_4ffb63f2
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.imageFile.filePath
          target_field: _ingest._value.image_file.path
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_b5106d06
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.imageFile.filePublisher
          target_field: _ingest._value.image_file.publisher
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_8795c90b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.imageFile.fileSize
          target_field: _ingest._value.image_file.size
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.imageFile.fileSize
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_8218fcb8
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.imageFile.issuer
          target_field: _ingest._value.image_file.issuer
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_16488b1c
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.imageFile.signer
          target_field: _ingest._value.image_file.signer
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_f1721513
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.parentProcessImageFile.fileName
          target_field: _ingest._value.parent_process.image_file.name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_e237d4bf
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.parentProcessImageFile.filePath
          target_field: _ingest._value.parent_process.image_file.path
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_e38995b1
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.parentProcessImageFile.filePublisher
          target_field: _ingest._value.parent_process.image_file.publisher
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_6ccccded
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        convert:
          field: _ingest._value.parentProcessImageFile.fileSize
          target_field: _ingest._value.parent_process.image_file.size
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.parentProcessImageFile.fileSize
            - append:
                field: error.message
                value: '{{{_ingest.on_failure_message}}}'
  - foreach:
      tag: foreach_json_alerts_evidence_b8dee4f1
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.parentProcessImageFile.issuer
          target_field: _ingest._value.parent_process.image_file.issuer
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_34d22b9f
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.parentProcessImageFile.signer
          target_field: _ingest._value.parent_process.image_file.signer
          ignore_missing: true
  - script:
      description: Set process and file ECS fields from evidence (executables, pids, file size).
      tag: script_set_process_fields_from_evidence
      lang: painless
      if: ctx.json?.alerts?.evidence instanceof List
      source: |
        def convertToOrderedArray(def list) {
          def result = new ArrayList();
          for (element in list) {
            result.add(element);
          }
          Collections.sort(result);
          return result;
        }

        String joinPathAndName(String path, String name) {
          if (path == null || name == null) {
            return null;
          }
          String separator = path.contains("\\") ? "\\" : "/";
          if (!path.endsWith(separator)) {
            path = path + separator;
          }
          return path + name;
        }

        void maybeAddExecutable(def destination, def imageFile) {
          if (imageFile == null) {
            return;
          }
          if (imageFile?.path != null && imageFile?.name != null) {
            destination.add(joinPathAndName(imageFile.path, imageFile.name));
          } else if (imageFile?.name != null) {
            destination.add(imageFile.name);
          }
        }

        def processExecutable = new HashSet();
        def processParentExecutable = new HashSet();
        def fileSize = new HashSet();
        def processPid = new HashSet();
        def processParentPid = new HashSet();

        for (evidence in ctx.json.alerts.evidence) {
          maybeAddExecutable(processExecutable, evidence?.image_file);
          maybeAddExecutable(processParentExecutable, evidence?.parent_process?.image_file);

          if (evidence?.odata_type == null) {
            continue;
          }
          if (evidence.odata_type == '#microsoft.graph.security.fileEvidence') {
            if (evidence?.file_details?.size != null) {
              fileSize.add(evidence.file_details.size);
            }
          } else if (evidence.odata_type == '#microsoft.graph.security.processEvidence') {
            if (evidence?.process?.id != null) {
              processPid.add(evidence.process.id);
            }
            if (evidence?.parent_process?.id != null) {
              processParentPid.add(evidence.parent_process.id);
            }
          }
        }

        ctx.file = ctx.file ?: [:];
        ctx.process = ctx.process ?: [:];
        ctx.process.parent = ctx.process.parent ?: [:];

        if (!fileSize.isEmpty()) {
          ctx.file.size = convertToOrderedArray(fileSize);
        }
        if (!processPid.isEmpty()) {
          ctx.process.pid = convertToOrderedArray(processPid);
        }
        if (!processParentPid.isEmpty()) {
          ctx.process.parent.pid = convertToOrderedArray(processParentPid);
        }
        if (!processExecutable.isEmpty()) {
          def execList = new ArrayList(processExecutable);
          Collections.sort(execList);
          if (execList.size() == 1) {
            ctx.process.executable = execList.get(0);
          } else {
            ctx.process.executable = execList;
          }
        }
        if (!processParentExecutable.isEmpty()) {
          def execList = new ArrayList(processParentExecutable);
          Collections.sort(execList);
          if (execList.size() == 1) {
            ctx.process.parent.executable = execList.get(0);
          } else {
            ctx.process.parent.executable = execList;
          }
        }
  - foreach:
      tag: foreach_json_alerts_evidence_3f4526de
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.registryHive
          target_field: _ingest._value.registry_hive
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_a4a1e319
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: registry.hive
          value: '{{{_ingest._value.registry_hive}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_c4e38f24
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.registryKey
          target_field: _ingest._value.registry_key
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_9174185f
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: registry.key
          value: '{{{_ingest._value.registry_key}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_758d13cf
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.registryValueType
          target_field: _ingest._value.registry_value_type
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_354c6451
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: registry.data.type
          value: '{{{_ingest._value.registry_value_type}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_ea866ff0
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.registryValue
          target_field: _ingest._value.registry_value
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_c2363a9b
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: registry.value
          value: '{{{_ingest._value.registry_value}}}'
          allow_duplicates: false
          ignore_failure: true
  - foreach:
      tag: foreach_json_alerts_evidence_006ff1af
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.registryValueName
          target_field: _ingest._value.registry_value_name
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_d26f466f
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        rename:
          field: _ingest._value.securityGroupId
          target_field: _ingest._value.security_group_id
          ignore_missing: true
  - foreach:
      tag: foreach_json_alerts_evidence_ce986880
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        append:
          field: group.id
          value: '{{{_ingest._value.security_group_id}}}'
          allow_duplicates: false
          ignore_failure: true
  - script:
      tag: script_3629e07c
      description: Map ecs fields based on evidence type.
      lang: painless
      if: ctx.json?.alerts?.evidence instanceof List
      source: |-
        def convertToOrderedArray(def list) {
          def result = new ArrayList();
          for (element in list) {
            result.add(element);
          }
          Collections.sort(result);
          return result;
        }
        if (!(ctx.cloud instanceof HashMap)) {
          ctx.cloud = new HashMap();
        }
        def cloudProvider = new HashSet();
        if (!(ctx.group instanceof HashMap)) {
          ctx.group = new HashMap();
        }
        def groupName = new HashSet();
        if (!(ctx.host instanceof HashMap)) {
          ctx.host = new HashMap();
        }
        def hostId = new HashSet();
        if (!(ctx.user instanceof HashMap)) {
          ctx.user = new HashMap();
        }
        def userDomain = new HashSet();
        def userName = new HashSet();
        def userId = new HashSet();
        if (!(ctx.process instanceof HashMap)) {
          ctx.process = new HashMap();
        }
        ctx.process.user = new HashMap();
        def processUserId = new HashSet();
        def processUserName = new HashSet();
        for (evidence in ctx.json.alerts.evidence) {
          if (evidence?.odata_type != null) {
            if (evidence.odata_type == '#microsoft.graph.security.securityGroupEvidence') {
              if (evidence?.display_name != null) {
                groupName.add(evidence.display_name);
              }
            }
            if (evidence.odata_type == '#microsoft.graph.security.deviceEvidence') {
              if (evidence?.mde_device_id != null) {
                hostId.add(evidence.mde_device_id);
              }
            }
            if (['#microsoft.graph.security.mailboxEvidence', '#microsoft.graph.security.userEvidence'].contains(evidence.odata_type)) {
              if (evidence?.user_account?.domain_name != null) {
                userDomain.add(evidence.user_account.domain_name);
              }
              if (evidence?.user_account?.user_principal_name != null) {
                userId.add(evidence.user_account.user_principal_name);
              }
              if (evidence?.user_account?.account_name != null) {
                userName.add(evidence.user_account.account_name);
              }
            }
            if (evidence.odata_type == '#microsoft.graph.security.processEvidence') {
              if (evidence?.user_account?.azure_ad_user_id != null) {
                processUserId.add(evidence.user_account.azure_ad_user_id);
              }
              if (evidence?.user_account?.account_name != null) {
                processUserName.add(evidence.user_account.account_name);
              }
            }
          }
          if (evidence?.vm_metadata?.cloud_provider != null && evidence.vm_metadata.cloud_provider.toLowerCase() == 'azure') {
            cloudProvider.add('azure');
          }
        }
        if (!cloudProvider.isEmpty()) {
          ctx.cloud.provider = convertToOrderedArray(cloudProvider);
        }
        if (!groupName.isEmpty()) {
          ctx.group.name = convertToOrderedArray(groupName);
        }
        if (!hostId.isEmpty()) {
          ctx.host.id = convertToOrderedArray(hostId);
        }
        if (!userDomain.isEmpty()) {
          ctx.user.domain = convertToOrderedArray(userDomain);
        }
        if (!userName.isEmpty()) {
          ctx.user.name = convertToOrderedArray(userName);
        }
        if (!userId.isEmpty()) {
          ctx.user.id = convertToOrderedArray(userId);
        }
        if (!processUserId.isEmpty()) {
          ctx.process.user.id = convertToOrderedArray(processUserId);
        }
        if (!processUserName.isEmpty()) {
          ctx.process.user.name = convertToOrderedArray(processUserName);
        }
  - foreach:
      field: process.pid
      tag: foreach_process_pid
      if: ctx.process?.pid instanceof List
      processor:
        append:
          field: process.entity_id
          tag: append_process_pid_to_entity_id
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
  - foreach:
      field: process.parent.pid
      tag: foreach_process_parent_pid
      if: ctx.process?.parent?.pid instanceof List
      processor:
        append:
          field: process.parent.entity_id
          tag: append_process_parent_pid_to_entity_id
          value: '{{{_ingest._value}}}'
          allow_duplicates: false
  - foreach:
      tag: foreach_json_alerts_evidence_0076b16f
      field: json.alerts.evidence
      if: ctx.json?.alerts?.evidence instanceof List
      ignore_failure: true
      processor:
        remove:
          field:
            - _ingest._value.createdDateTime
            - _ingest._value.receivedDateTime
            - _ingest._value.attachmentsCount
            - _ingest._value.firstSeenDateTime
            - _ingest._value.parentProcessCreationDateTime
            - _ingest._value.processCreationDateTime
            - _ingest._value.senderIp
            - _ingest._value.urlCount
            - _ingest._value.instanceId
            - _ingest._value.appId
            - _ingest._value.saasAppId
            - _ingest._value.osBuild
            - _ingest._value.rbacGroupId
            - _ingest._value.fileDetails.fileSize
            - _ingest._value.ipAddress
            - _ingest._value.emailCount
            - _ingest._value.parentProcessId
            - _ingest._value.processId
            - _ingest._value.imageFile.fileSize
            - _ingest._value.parentProcessImageFile.fileSize
          ignore_missing: true
  - lowercase:
      tag: lowercase_host_name_c780fa50
      field: host.name
      if: ctx.host?.name != null
  - rename:
      tag: rename_json_alerts_evidence_to_m365_defender_incident_alert_evidence_023ad7dc
      field: json.alerts.evidence
      target_field: m365_defender.incident.alert.evidence
      ignore_missing: true
  - remove:
      tag: remove_json_29cdffdc
      field: json
      ignore_missing: true
  - remove:
      tag: remove_4ad4a3a4
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      field:
        - m365_defender.incident.last_update_datetime
        - m365_defender.incident.tenant_id
        - m365_defender.incident.created_datetime
        - m365_defender.incident.id
        - m365_defender.incident.alert.service_source
        - m365_defender.incident.web_url
        - m365_defender.incident.assigned_to
        - m365_defender.incident.alert.category
        - m365_defender.incident.alert.mitre_techniques
      ignore_missing: true
  - foreach:
      tag: foreach_m365_defender_incident_alert_evidence_b95d1593
      field: m365_defender.incident.alert.evidence
      if: ctx.m365_defender?.incident?.alert?.evidence instanceof List && (ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields')))
      ignore_failure: true
      processor:
        foreach:
          field: _ingest._value.logged_on_users
          ignore_failure: true
          processor:
            remove:
              field:
                - _ingest._value.account_name
              ignore_missing: true
  - foreach:
      tag: foreach_m365_defender_incident_alert_evidence_8a1d0726
      field: m365_defender.incident.alert.evidence
      if: ctx.m365_defender?.incident?.alert?.evidence instanceof List && (ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields')))
      ignore_failure: true
      processor:
        remove:
          field:
            - _ingest._value.ip_address
            - _ingest._value.detection_status
            - _ingest._value.received_datetime
            - _ingest._value.antispam_direction
            - _ingest._value.subject
            - _ingest._value.recipient_email_address
            - _ingest._value.instance_id
            - _ingest._value.instance_name
            - _ingest._value.vm_metadata.cloud_provider
            - _ingest._value.os_platform
            - _ingest._value.version
            - _ingest._value.file_details.sha1
            - _ingest._value.file_details.sha256
            - _ingest._value.file_details.name
            - _ingest._value.file_details.path
            - _ingest._value.file_details.size
            - _ingest._value.process.command_line
            - _ingest._value.image_file.sha1
            - _ingest._value.image_file.sha256
            - _ingest._value.parent_process.image_file.sha1
            - _ingest._value.parent_process.image_file.sha256
            - _ingest._value.parent_process.id
            - _ingest._value.parent_process.creation_datetime
            - _ingest._value.process.id
            - _ingest._value.process.creation_datetime
            - _ingest._value.registry_value_type
            - _ingest._value.registry_hive
            - _ingest._value.registry_key
            - _ingest._value.registry_value
            - _ingest._value.security_group_id
          ignore_missing: true
  - script:
      tag: script_a3eb5add
      description: Drops null/empty values recursively.
      lang: painless
      source: |
        boolean dropEmptyFields(Object object) {
          if (object == null || object == "") {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(value -> dropEmptyFields(value));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(value -> dropEmptyFields(value));
            return (((List) object).length == 0);
          }
          return false;
        }
        dropEmptyFields(ctx);
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
  - append:
      field: error.message
      value: '{{{ _ingest.on_failure_message }}}'
