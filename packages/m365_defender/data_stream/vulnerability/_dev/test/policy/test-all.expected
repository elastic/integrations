inputs:
    - data_stream:
        namespace: ep
      meta:
        package:
            name: m365_defender
      name: test-all-m365_defender
      streams:
        - config_version: 2
          data_stream:
            dataset: m365_defender.vulnerability
          interval: 30s
          processors:
            - add_fields:
                fields:
                    id: "574734885120952459"
                    name: myproject
                target: project
            - add_tags:
                tags:
                    - web
                    - production
                target: environment
          program: "state.with(\n  state.?work_list.orValue([]).size() > 0 ?\n    request(\n      \"GET\",\n      state.work_list[0]\n    ).do_request().as(resp, resp.StatusCode == 200 ?\n      try(resp.Body.mime(\"application/gzip\").decode_json_stream(), \"decode_error\").as(decoded_body,\n        // 200 but decode error possible due to expired URLs. \n        // Error message should contain the resolution i.e., to increase the 'SAS Valid Hours' parameter.\n        type(decoded_body) == map && has(decoded_body.decode_error) ?\n          {\n            \"events\": {\n              \"error\": {\n                \"code\": string(resp.StatusCode),\n                \"id\": string(resp.Status),\n                \"message\": decoded_body.decode_error + \": Download URLs are likely expired. Try increasing the 'SAS Valid Hours' parameter to download more data.\",\n              },\n            },\n            // Empty the work_list as URLs are expired.\n            \"work_list\": [],\n            \"want_more\": false,\n          }\n        :\n          decoded_body.map(v,\n            {\"message\": dyn(v.encode_json())}\n          ).as(events, {\n            \"events\": events,\n            // Keep polling if more work.\n            \"want_more\": state.work_list.size() > 1,\n            \"work_list\": tail(state.work_list),\n          })\n      )\n    :\n      // Check if 403 happened because download URL signatures are not valid anymore.\n      resp.StatusCode == 403 && resp.Body.as(body, \n        string(body).contains_substr(\"Signature not valid in the specified key time frame\")\n      ) ?\n        {\n            \"events\": {\n              \"error\": {\n                \"code\": string(resp.StatusCode),\n                \"id\": string(resp.Status),\n                \"message\": \"Cannot fetch more data as signatures are not valid anymore. Try increasing the 'SAS Valid Hours' parameter to download more data.\",\n              },\n            },\n            // Empty the work_list as signatures are not valid anymore.\n            \"work_list\": [],\n            \"want_more\": false,\n          }\n    :\n      // Ignore remaining work_list and return error.\n      {\n        \"events\": {\n          \"error\": {\n            \"code\": string(resp.StatusCode),\n            \"id\": string(resp.Status),\n            \"message\": \"GET \"+ state.work_list[0] + \":\" + (\n              size(resp.Body) != 0 ?\n                string(resp.Body)\n              :\n                string(resp.Status) + ' (' + string(resp.StatusCode) + ')'\n            ),\n          },\n        },\n        \"work_list\": [], // Empty the work_list as URLs will likely be expired before polling again.\n        \"want_more\": false,\n      }\n    )\n  :\n    // Periodic poll. No work_list, so get new token and work_list.\n    (\n      has(state.oauth_endpoint_params) && size(state.oauth_endpoint_params) > 0 ?\n        {\n          \"client_id\": [state.client_id],\n          \"client_secret\": [state.client_secret],\n          \"scope\": state.token_scopes,\n        }.with(\n          !(\"grant_type\" in state.oauth_endpoint_params) ?\n            {\"grant_type\": [\"client_credentials\"]}\n          :\n            {}\n        ).with(zip(\n          state.oauth_endpoint_params.keys(),\n          state.oauth_endpoint_params.keys().map(k,\n            type(state.oauth_endpoint_params[k]) == list ?\n              state.oauth_endpoint_params[k]\n            :\n              [state.oauth_endpoint_params[k]]\n          )\n        ))\n      :\n        {\n          \"grant_type\": [\"client_credentials\"],\n          \"client_id\": [state.client_id],\n          \"client_secret\": [state.client_secret],\n          \"scope\": state.token_scopes,\n        }\n    ).as(params,\n      post_request(state.token_url.trim_right(\"/\"), \"application/x-www-form-urlencoded\",\n        params.format_query()\n      ).do_request().as(auth, auth.StatusCode == 200 ?\n      auth.Body.decode_json()\n    :\n      {\n        \"events\": {\n          \"error\": {\n            \"code\": string(auth.StatusCode),\n            \"id\": string(auth.Status),\n            \"message\": \"POST /oauth2/v2.0/token :\" +(\n              size(auth.Body) != 0 ?\n                string(auth.Body)\n              :\n                string(auth.Status) + ' (' + string(auth.StatusCode) + ')'\n            ),\n          },\n        },\n        \"want_more\": false,\n      }\n    ).as(token, !has(token.access_token) ? token :\n      request(\n        \"GET\",\n        state.url.trim_right(\"/\") + \"/api/machines/SoftwareVulnerabilitiesExport?\" + {\n          \"sasValidHours\": [string(duration(state.sas_valid_hours).getHours())],\n        }.format_query()\n      ).with({\n        \"Header\":{\n          \"Authorization\": [\"Bearer \" + string(token.access_token)],\n        }\n      }).do_request().as(resp, resp.StatusCode == 200 ?\n        resp.Body.decode_json().as(exportBody, exportBody.?exportFiles.orValue([]).size() == 0 ?\n          // Nothing to download. Don't poll again.\n          {\n            \"events\": [],\n            \"want_more\": false,\n          }\n        :\n          // Return new work_list to download.\n          {\n            \"events\": [{\"message\":\"retry\"}],\n            \"work_list\": exportBody.exportFiles,\n            \"want_more\": true,\n          }\n        )\n      :\n        {\n          \"events\": {\n            \"error\": {\n              \"code\": string(resp.StatusCode),\n              \"id\": string(resp.Status),\n              \"message\": \"GET /api/machines/SoftwareVulnerabilitiesExport :\" + (\n                size(resp.Body) != 0 ?\n                  string(resp.Body)\n                :\n                  string(resp.Status) + ' (' + string(resp.StatusCode) + ')'\n              ),\n            },\n          },\n          \"want_more\": false,\n        }\n      )\n    )\n  )\n)"
          publisher_pipeline.disable_host: true
          redact:
            fields:
                - client_id
                - client_secret
                - token.access_token
          resource.proxy_url: https://user:P%40ssword%23@0.0.0.0:0000
          resource.ssl:
            certificate: |
                -----BEGIN CERTIFICATE-----
                MIIDCjCCAfKgAwIBAgITJ706Mu2wJlKckpIvkWxEHvEyijANBgkqhkiG9w0BAQsF
                ADAUMRIwEAYDVQQDDAlsb2NhbGhvc3QwIBcNMTkwNzIyMTkyOTA0WhgPMjExOTA2
                MjgxOTI5MDRaMBQxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcNAQEB
                BQADggEPADCCAQoCggEBANce58Y/JykI58iyOXpxGfw0/gMvF0hUQAcUrSMxEO6n
                fZRA49b4OV4SwWmA3395uL2eB2NB8y8qdQ9muXUdPBWE4l9rMZ6gmfu90N5B5uEl
                94NcfBfYOKi1fJQ9i7WKhTjlRkMCgBkWPkUokvBZFRt8RtF7zI77BSEorHGQCk9t
                /D7BS0GJyfVEhftbWcFEAG3VRcoMhF7kUzYwp+qESoriFRYLeDWv68ZOvG7eoWnP
                PsvZStEVEimjvK5NSESEQa9xWyJOmlOKXhkdymtcUd/nXnx6UTCFgnkgzSdTWV41
                CI6B6aJ9svCTI2QuoIq2HxX/ix7OvW1huVmcyHVxyUECAwEAAaNTMFEwHQYDVR0O
                BBYEFPwN1OceFGm9v6ux8G+DZ3TUDYxqMB8GA1UdIwQYMBaAFPwN1OceFGm9v6ux
                8G+DZ3TUDYxqMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAG5D
                874A4YI7YUwOVsVAdbWtgp1d0zKcPRR+r2OdSbTAV5/gcS3jgBJ3i1BN34JuDVFw
                3DeJSYT3nxy2Y56lLnxDeF8CUTUtVQx3CuGkRg1ouGAHpO/6OqOhwLLorEmxi7tA
                H2O8mtT0poX5AnOAhzVy7QW0D/k4WaoLyckM5hUa6RtvgvLxOwA0U+VGurCDoctu
                8F4QOgTAWyh8EZIwaKCliFRSynDpv3JTUwtfZkxo6K6nce1RhCWFAsMvDZL8Dgc0
                yvgJ38BRsFOtkRuAGSf6ZUwTO8JJRRIFnpUzXflAnGivK9M13D5GEQMmIl6U9Pvk
                sxSmbIUfc2SGJGCJD4I=
                -----END CERTIFICATE-----
            certificate_authorities:
                - |
                  -----BEGIN CERTIFICATE-----
                  MIIDCjCCAfKgAwIBAgITJ706Mu2wJlKckpIvkWxEHvEyijANBgkqhkiG9w0BAQsF
                  ADAUMRIwEAYDVQQDDAlsb2NhbGhvc3QwIBcNMTkwNzIyMTkyOTA0WhgPMjExOTA2
                  MjgxOTI5MDRaMBQxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcNAQEB
                  BQADggEPADCCAQoCggEBANce58Y/JykI58iyOXpxGfw0/gMvF0hUQAcUrSMxEO6n
                  fZRA49b4OV4SwWmA3395uL2eB2NB8y8qdQ9muXUdPBWE4l9rMZ6gmfu90N5B5uEl
                  94NcfBfYOKi1fJQ9i7WKhTjlRkMCgBkWPkUokvBZFRt8RtF7zI77BSEorHGQCk9t
                  /D7BS0GJyfVEhftbWcFEAG3VRcoMhF7kUzYwp+qESoriFRYLeDWv68ZOvG7eoWnP
                  PsvZStEVEimjvK5NSESEQa9xWyJOmlOKXhkdymtcUd/nXnx6UTCFgnkgzSdTWV41
                  CI6B6aJ9svCTI2QuoIq2HxX/ix7OvW1huVmcyHVxyUECAwEAAaNTMFEwHQYDVR0O
                  BBYEFPwN1OceFGm9v6ux8G+DZ3TUDYxqMB8GA1UdIwQYMBaAFPwN1OceFGm9v6ux
                  8G+DZ3TUDYxqMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAG5D
                  874A4YI7YUwOVsVAdbWtgp1d0zKcPRR+r2OdSbTAV5/gcS3jgBJ3i1BN34JuDVFw
                  3DeJSYT3nxy2Y56lLnxDeF8CUTUtVQx3CuGkRg1ouGAHpO/6OqOhwLLorEmxi7tA
                  H2O8mtT0poX5AnOAhzVy7QW0D/k4WaoLyckM5hUa6RtvgvLxOwA0U+VGurCDoctu
                  8F4QOgTAWyh8EZIwaKCliFRSynDpv3JTUwtfZkxo6K6nce1RhCWFAsMvDZL8Dgc0
                  yvgJ38BRsFOtkRuAGSf6ZUwTO8JJRRIFnpUzXflAnGivK9M13D5GEQMmIl6U9Pvk
                  sxSmbIUfc2SGJGCJD4I=
                  -----END CERTIFICATE-----
            cipher_suites:
                - ECDHE-ECDSA-AES-128-CBC-SHA
                - ECDHE-ECDSA-AES-256-GCM-SHA384
            curve_types:
                - P-256
            enabled: true
            key: |
                -----BEGIN PRIVATE KEY-----
                MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDXHufGPycpCOfI
                sjl6cRn8NP4DLxdIVEAHFK0jMRDup32UQOPW+DleEsFpgN9/ebi9ngdjQfMvKnUP
                Zrl1HTwVhOJfazGeoJn7vdDeQebhJfeDXHwX2DiotXyUPYu1ioU45UZDAoAZFj5F
                KJLwWRUbfEbRe8yO+wUhKKxxkApPbfw+wUtBicn1RIX7W1nBRABt1UXKDIRe5FM2
                MKfqhEqK4hUWC3g1r+vGTrxu3qFpzz7L2UrRFRIpo7yuTUhEhEGvcVsiTppTil4Z
                HcprXFHf5158elEwhYJ5IM0nU1leNQiOgemifbLwkyNkLqCKth8V/4sezr1tYblZ
                nMh1cclBAgMBAAECggEBAKdP5jyOicqknoG9/G564RcDsDyRt64NuO7I6hBg7SZx
                Jn7UKWDdFuFP/RYtoabn6QOxkVVlydp5Typ3Xu7zmfOyss479Q/HIXxmmbkD0Kp0
                eRm2KN3y0b6FySsS40KDRjKGQCuGGlNotW3crMw6vOvvsLTlcKgUHF054UVCHoK/
                Piz7igkDU7NjvJeha53vXL4hIjb10UtJNaGPxIyFLYRZdRPyyBJX7Yt3w8dgz8WM
                epOPu0dq3bUrY3WQXcxKZo6sQjE1h7kdl4TNji5jaFlvD01Y8LnyG0oThOzf0tve
                Gaw+kuy17gTGZGMIfGVcdeb+SlioXMAAfOps+mNIwTECgYEA/gTO8W0hgYpOQJzn
                BpWkic3LAoBXWNpvsQkkC3uba8Fcps7iiEzotXGfwYcb5Ewf5O3Lrz1EwLj7GTW8
                VNhB3gb7bGOvuwI/6vYk2/dwo84bwW9qRWP5hqPhNZ2AWl8kxmZgHns6WTTxpkRU
                zrfZ5eUrBDWjRU2R8uppgRImsxMCgYEA2MxuL/C/Ko0d7XsSX1kM4JHJiGpQDvb5
                GUrlKjP/qVyUysNF92B9xAZZHxxfPWpdfGGBynhw7X6s+YeIoxTzFPZVV9hlkpAA
                5igma0n8ZpZEqzttjVdpOQZK8o/Oni/Q2S10WGftQOOGw5Is8+LY30XnLvHBJhO7
                TKMurJ4KCNsCgYAe5TDSVmaj3dGEtFC5EUxQ4nHVnQyCpxa8npL+vor5wSvmsfUF
                hO0s3GQE4sz2qHecnXuPldEd66HGwC1m2GKygYDk/v7prO1fQ47aHi9aDQB9N3Li
                e7Vmtdn3bm+lDjtn0h3Qt0YygWj+wwLZnazn9EaWHXv9OuEMfYxVgYKpdwKBgEze
                Zy8+WDm5IWRjn8cI5wT1DBT/RPWZYgcyxABrwXmGZwdhp3wnzU/kxFLAl5BKF22T
                kRZ+D+RVZvVutebE9c937BiilJkb0AXLNJwT9pdVLnHcN2LHHHronUhV7vetkop+
                kGMMLlY0lkLfoGq1AxpfSbIea9KZam6o6VKxEnPDAoGAFDCJm+ZtsJK9nE5GEMav
                NHy+PwkYsHhbrPl4dgStTNXLenJLIJ+Ke0Pcld4ZPfYdSyu/Tv4rNswZBNpNsW9K
                0NwJlyMBfayoPNcJKXrH/csJY7hbKviAHr1eYy9/8OL0dHf85FV+9uY5YndLcsDc
                nygO9KTJuUiBrLr0AHEnqko=
                -----END PRIVATE KEY-----
            supported_protocols:
                - TLSv1.2
          resource.timeout: 30s
          resource.tracer:
            enabled: false
            filename: ../../logs/cel/http-request-trace-*.ndjson
            maxbackups: 5
          resource.url: http://host.tld
          state:
            client_id: xxxx
            client_secret: ${SECRET_0}
            oauth_endpoint_params: null
            sas_valid_hours: 1h
            token_scopes:
                - https://securitycenter.onmicrosoft.com/windowsatpservice/.default
            token_url: https://login.microsoftonline.com/efgh/oauth2/v2.0/token
          tags:
            - preserve_original_event
            - preserve_duplicate_custom_fields
            - forwarded
            - m365_defender-vulnerability
            - test-policy
      type: cel
      use_output: default
output_permissions:
    default:
        _elastic_agent_checks:
            cluster:
                - monitor
        _elastic_agent_monitoring:
            indices: []
        uuid-for-permissions-on-related-indices:
            indices:
                - names:
                    - logs-m365_defender.vulnerability-ep
                  privileges:
                    - auto_configure
                    - create_doc
secret_references:
    - {}
