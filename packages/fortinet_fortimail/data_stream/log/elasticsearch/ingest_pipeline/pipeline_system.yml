---
description: Pipeline for processing System logs.
processors:
  - set:
      tag: set_event_outcome_82c7155e
      field: event.outcome
      value: unknown
  - set:
      tag: set_event_outcome_a02366c2
      field: event.outcome
      value: success
      if: ctx.fortinet_fortimail?.log?.sub_type == 'admin' && ctx.temp?.status.toLowerCase() == 'success'
  - set:
      tag: set_event_outcome_ab2ec938
      field: event.outcome
      value: failure
      if: ctx.fortinet_fortimail?.log?.sub_type == 'admin' && ctx.temp?.status.toLowerCase() == 'failure'
  - set:
      tag: set_event_category_08028495
      field: event.category
      value: [authentication]
      if: ctx.fortinet_fortimail?.log?.sub_type == 'admin' && (ctx.fortinet_fortimail.log.message.toLowerCase().contains('login') || ctx.fortinet_fortimail.log.message.toLowerCase().contains('logged'))
  - append:
      tag: append_event_type_88871742
      field: event.type
      value: end
      if: ctx.fortinet_fortimail?.log?.sub_type == 'admin' && (ctx.fortinet_fortimail.log.message.toLowerCase().contains('login successfully') || ctx.fortinet_fortimail.log.message.toLowerCase().contains('logged in') || ctx.fortinet_fortimail.log.message.toLowerCase().contains('login'))
      allow_duplicates: false
  - append:
      tag: append_event_type_e03135e5
      field: event.type
      value: info
      if: ctx.fortinet_fortimail?.log?.sub_type == 'admin' && ctx.event?.category != null
      allow_duplicates: false
  - append:
      tag: append_event_category_37b01657
      field: event.category
      value: configuration
      if: ctx.fortinet_fortimail?.log?.sub_type == 'config'
      allow_duplicates: false
  - set:
      tag: set_event_type_63c98742
      field: event.type
      value: [change]
      if: ctx.fortinet_fortimail?.log?.sub_type == 'config'
  - set:
      tag: set_event_type_3d393468
      field: event.type
      value: [deletion]
      if: ctx.fortinet_fortimail?.log?.sub_type == 'config' && ctx.fortinet_fortimail.log.message.toLowerCase().contains('delet')
      override: true
  - set:
      tag: set_event_category_139ba01e
      field: event.category
      value: [host]
      if: ctx.fortinet_fortimail?.log?.sub_type == 'system' && ctx.fortinet_fortimail.log.message.toLowerCase().contains('system')
  - set:
      tag: set_event_category_e21a3544
      field: event.category
      value: [configuration]
      if: (ctx.fortinet_fortimail?.log?.sub_type == 'system' && ctx.fortinet_fortimail.log.message.toLowerCase().contains('change')) || (ctx.fortinet_fortimail?.log?.sub_type == 'update' && ctx.fortinet_fortimail.log.message.toLowerCase().contains('update'))
      override: true
  - set:
      tag: set_event_type_0f6f6e93
      field: event.type
      value: [info]
      if: ctx.fortinet_fortimail?.log?.sub_type == 'system'
  - set:
      tag: set_event_type_e33a537c
      field: event.type
      value: [end]
      if: ctx.fortinet_fortimail?.log?.sub_type == 'system' && ctx.fortinet_fortimail.log.message.toLowerCase().contains('shutdown')
      override: true
  - set:
      tag: set_event_type_c5fda874
      field: event.type
      value: [change]
      if: (ctx.fortinet_fortimail?.log?.sub_type == 'system' && ctx.fortinet_fortimail.log.message.toLowerCase().contains('change')) || (ctx.fortinet_fortimail?.log?.sub_type == 'update' && ctx.fortinet_fortimail.log.message.toLowerCase().contains('update'))
      override: true
  - append:
      tag: append_fortinet_fortimail_log_user_2f9ddf12
      field: fortinet_fortimail.log.user
      value: '{{{temp.user}}}'
      allow_duplicates: false
      if: ctx.temp?.user != null
  - append:
      tag: append_user_name_9b60aa7e
      field: user.name
      value: '{{{temp.user}}}'
      allow_duplicates: false
      if: ctx.temp?.user != null
  - append:
      tag: append_related_user_4554486e
      field: related.user
      value: '{{{temp.user}}}'
      allow_duplicates: false
      if: ctx.temp?.user != null
  - grok:
      tag: grok_message_0070248e
      field: message
      ignore_missing: true
      ignore_failure: true
      patterns:
        - '^%{PREFIX} %{DATA}%{IP:fortinet_fortimail.log.ip}%{GREEDYDATA:temp.msg}$'
        - '^%{PREFIX}%{GREEDYDATA:temp.msg}$'
        - '^%{DATA}%{USER} %{DATA}%{IP:fortinet_fortimail.log.ip}%{GREEDYDATA:temp.msg}$'
        - '^authserver: %{BLOCK_ACTION:temp.block_action} block rule for %{IP:temp.block_ip}$'
        - '^authserver: %{BLOCK_ACTION:temp.block_action} block rule for %{IP:temp.block_ip} until %{GREEDYDATA}$'
        - '^%{DATA}%{USER} %{GREEDYDATA:temp.msg}$'
      pattern_definitions:
        PREFIX: '%{DATA}(?i)interface %{NUMBER:fortinet_fortimail.log.port:long}%{DATA} %{USER}'
        USER: '(?i)user %{NOTSPACE:temp.user}'
        BLOCK_ACTION: '(?:added|removed)'
  - set:
      tag: set_source_port_2d5659fd
      field: source.port
      copy_from: fortinet_fortimail.log.port
      ignore_empty_value: true
  - append:
      tag: append_related_ip_bf78f00c
      field: related.ip
      value: '{{{fortinet_fortimail.log.ip}}}'
      allow_duplicates: false
      if: ctx.fortinet_fortimail?.log?.ip != null
  - append:
      tag: append_related_ip_c9493339
      field: related.ip
      value: '{{{temp.block_ip}}}'
      allow_duplicates: false
      if: ctx.temp?.block_ip != null
  - append:
      tag: append_client_ip_e1408be5
      field: client.ip
      value: '{{{temp.block_ip}}}'
      allow_duplicates: false
      if: ctx.temp?.block_ip != null
  - set:
      tag: set_event_action_bd6b62e4
      field: event.action
      value: '{{{temp.block_action}}}_block_rule'
      if: ctx.temp?.block_ip != null
  - append:
      tag: append_fortinet_fortimail_log_user_2f9ddf13
      field: fortinet_fortimail.log.user
      value: '{{{temp.user}}}'
      allow_duplicates: false
      if: ctx.temp?.user != null
  - append:
      tag: append_user_name_9b60aa7f
      field: user.name
      value: '{{{temp.user}}}'
      allow_duplicates: false
      if: ctx.temp?.user != null
  - append:
      tag: append_related_user_4554486f
      field: related.user
      value: '{{{temp.user}}}'
      allow_duplicates: false
      if: ctx.temp?.user != null
  - rename:
      tag: rename_temp_action_to_fortinet_fortimail_log_action_d1d0a68f
      field: temp.action
      target_field: fortinet_fortimail.log.action
      ignore_missing: true
  - set:
      tag: set_event_action_6c0a2415
      field: event.action
      copy_from: fortinet_fortimail.log.action
      ignore_empty_value: true
      override: false
  - rename:
      tag: rename_temp_module_to_fortinet_fortimail_log_module_fb389af3
      field: temp.module
      target_field: fortinet_fortimail.log.module
      ignore_missing: true
  - rename:
      tag: rename_temp_submodule_to_fortinet_fortimail_log_sub_module_b2295dde
      field: temp.submodule
      target_field: fortinet_fortimail.log.sub_module
      ignore_missing: true
  - rename:
      tag: rename_temp_ui_to_fortinet_fortimail_log_ui_ecc5d28f
      field: temp.ui
      target_field: fortinet_fortimail.log.ui
      ignore_missing: true
  - rename:
      tag: rename_temp_reason_to_fortinet_fortimail_log_reason_a448343f
      field: temp.reason
      target_field: fortinet_fortimail.log.reason
      ignore_missing: true
  - rename:
      tag: rename_temp_status_to_fortinet_fortimail_log_status_b34786cf
      field: temp.status
      target_field: fortinet_fortimail.log.status
      ignore_missing: true
  - grok:
      tag: grok_fortinet_fortimail_log_ui_1434bd57
      field: fortinet_fortimail.log.ui
      ignore_missing: true
      patterns:
        - '^%{PROTOCOL:fortinet_fortimail.log.network}%{SPACE}\(%{SPACE}%{IP:fortinet_fortimail.log.ui_ip}%{SPACE}\)$'
        - '^%{WORD}%{SPACE}\(%{SPACE}%{IP:fortinet_fortimail.log.ui_ip}%{SPACE}\)$'
        - '^%{DATA}%{IP:fortinet_fortimail.log.ui_ip}%{GREEDYDATA:temp.msg}$'
      pattern_definitions:
        PROTOCOL: '(?i)(?:telnet|ssh|http)'
      ignore_failure: true
  - set:
      tag: set_source_ip_a1237bd8
      field: source.ip
      copy_from: fortinet_fortimail.log.ui_ip
      ignore_empty_value: true
  - geoip:
      tag: geoip_source_ip_to_source_geo_bace2435
      if: ctx.source?.ip != null
      field: source.ip
      target_field: source.geo
  - append:
      tag: append_related_ip_f8ea089a
      field: related.ip
      value: '{{{fortinet_fortimail.log.ui_ip}}}'
      allow_duplicates: false
      if: ctx.fortinet_fortimail?.log?.ui_ip != null
  - set:
      tag: set_network_protocol_5da2dd0c
      field: network.protocol
      copy_from: fortinet_fortimail.log.network
      ignore_empty_value: true
  - lowercase:
      tag: lowercase_network_protocol_49872259
      field: network.protocol
      ignore_missing: true
on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - append:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{#_ingest.on_failure_processor_tag}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{/_ingest.on_failure_processor_tag}}in pipeline '{{{ _ingest.pipeline }}}'
        failed with message '{{{ _ingest.on_failure_message }}}'
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
