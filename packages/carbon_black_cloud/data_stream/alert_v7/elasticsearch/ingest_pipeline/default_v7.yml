description: "Pipeline to map Carbon Black Cloud alerts v7 API response to ECS"
processors:
  - set:
      field: ecs.version
      value: '8.11.0'
  - rename:
      field: message
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - json:
      field: event.original
      target_field: json
      ignore_failure: true
  - fingerprint:
      fields:
        - json.id
        - json.detection_timestamp
        - json.last_event_timestamp
      target_field: _id
      ignore_missing: true
  - rename:
      field: "json.org_key"
      target_field: "event.org_id"
  - rename:
      field: "json.alert_url"
      target_field: "url.full"
  - rename:
      field: "json.id"
      target_field: "event.id"
  - date:
      field: "json.detection_timestamp"
      target_field: "@timestamp"
      formats:
        - "ISO8601"
      if : ctx.json?.detection_timestamp != null
      on_failure:
        - remove:
            field: json.detection_timestamp 
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - date:
      field: "json.backend_timestamp"
      target_field: "carbonblackcloud.backend_timestamp"
      formats:
        - "ISO8601"
  - date:
      field: "json.detection_timestamp"
      target_field: "carbonblackcloud.detection_timestamp"
      formats:
        - "ISO8601"
  - date:
      field: "json.first_event_timestamp"
      target_field: "carbonblackcloud.first_event_timestamp"
      formats:
        - "ISO8601"
  - date:
      field: "json.last_event_timestamp"
      target_field: "carbonblackcloud.last_event_timestamp"
      formats:
        - "ISO8601"
  - convert:
      field: "json.severity"
      target_field: "carbonblackcloud.severity"
      type: "integer"
  - rename:
      field: "json.reason"
      target_field: "carbonblackcloud.reason"
  - rename:
      field: "json.reason_code"
      target_field: "carbonblackcloud.reason_code"
  - rename:
      field: "json.threat_id"
      target_field: "carbonblackcloud.threat_id"
  - rename:
      field: "json.primary_event_id"
      target_field: "carbonblackcloud.primary_event_id"
  - rename:
      field: "json.policy_applied"
      target_field: "carbonblackcloud.policy_applied"
  - rename:
      field: "json.run_state"
      target_field: "carbonblackcloud.run_state"
  - rename:
      field: "json.sensor_action"
      target_field: "carbonblackcloud.sensor_action"
  - rename:
      field: "json.workflow.change_timestamp"
      target_field: "carbonblackcloud.workflow.change_timestamp"
  - rename:
      field: "json.workflow.changed_by_type"
      target_field: "carbonblackcloud.workflow.changed_by_type"
  - rename:
      field: "json.workflow.changed_by"
      target_field: "carbonblackcloud.workflow.changed_by"
  - rename:
      field: "json.workflow.closure_reason"
      target_field: "carbonblackcloud.workflow.closure_reason"
  - rename:
      field: "json.workflow.status"
      target_field: "carbonblackcloud.workflow.status"
  - rename:
      field: "json.determination.change_timestamp"
      target_field: "carbonblackcloud.determination.change_timestamp"
  - rename:
      field: "json.determination.value"
      target_field: "carbonblackcloud.determination.value"
  - rename:
      field: "json.determination.changed_by_type"
      target_field: "carbonblackcloud.determination.changed_by_type"
  - rename:
      field: "json.determination.changed_by"
      target_field: "carbonblackcloud.determination.changed_by"
  - rename:
      field: "json.tags"
      target_field: "tags"
  - convert:
      field: "json.alert_notes_present"
      target_field: "carbonblackcloud.alert_notes_present"
      type: "boolean"
  - convert:
      field: "json.threat_notes_present"
      target_field: "carbonblackcloud.threat_notes_present"
      type: "boolean"
  - convert:
      field: "json.is_updated"
      target_field: "carbonblackcloud.is_updated"
      type: "boolean"
  - rename:
      field: "json.device_id"
      target_field: "host.id"
  - rename:
      field: "json.device_name"
      target_field: "host.hostname"
  - rename:
      field: "json.device_uem_id"
      target_field: "carbonblackcloud.device_uem_id"
  - rename:
      field: "json.device_target_value"
      target_field: "carbonblackcloud.device_target_value"
  - rename:
      field: "json.device_policy"
      target_field: "carbonblackcloud.device_policy"
  - rename:
      field: "json.device_policy_id"
      target_field: "carbonblackcloud.device_policy_id"
  - rename:
      field: "json.device_os"
      target_field: "host.os.name"
  - rename:
      field: "json.device_os_version"
      target_field: "host.os.version"
  - rename:
      field: "json.device_username"
      target_field: "user.name"
  - rename:
      field: "json.device_location"
      target_field: "geo.location"
  - rename:
      field: "json.device_external_ip"
      target_field: "source.ip"
  - rename:
      field: "json.device_internal_ip"
      target_field: "destination.ip"
  - convert:
      field: "json.mdr_alert"
      target_field: "carbonblackcloud.mdr_alert"
      type: "boolean"
  - rename:
      field: "json.report_id"
      target_field: "carbonblackcloud.report_id"
  - rename:
      field: "json.report_name"
      target_field: "carbonblackcloud.report_name"
  - rename:
      field: "json.report_description"
      target_field: "carbonblackcloud.report_description"
  - rename:
      field: "json.ioc_id"
      target_field: "carbonblackcloud.ioc_id"
  - rename:
      field: "json.ioc_hit"
      target_field: "carbonblackcloud.ioc_hit"
  - foreach:
      field: "json.watchlists"
      processor:
        - rename:
            field: "id"
            target_field: "carbonblackcloud.watchlists.id"
        - rename:
            field: "name"
            target_field: "carbonblackcloud.watchlists.name"
  - rename:
      field: "json.process_guid"
      target_field: "process.hash.sha1"
  - rename:
      field: "json.process_pid"
      target_field: "process.pid"
  - rename:
      field: "json.process_name"
      target_field: "process.name"
  - rename:
      field: "json.process_sha256"
      target_field: "process.hash.sha256"
  - rename:
      field: "json.process_md5"
      target_field: "process.hash.md5"
  - rename:
      field: "json.process_effective_reputation"
      target_field: "carbonblackcloud.process_effective_reputation"
  - rename:
      field: "json.process_reputation"
      target_field: "carbonblackcloud.process_reputation"
  - rename:
      field: "json.process_cmdline"
      target_field: "process.command_line"
  - rename:
      field: "json.process_username"
      target_field: "process.user.name"
  - rename:
      field: "json.process_issuer_"
      target_field: "carbonblackcloud.process_issuer"
