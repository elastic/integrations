---
description: Pipeline for ForgeRock audit logs
processors: 
- set:
    field: event.ingested
    value: '{{_ingest.timestamp}}'
- set:
    field: ecs.version
    value: '8.4.0'
- set:
      field: observer.vendor
      value: ForgeRock Identity Platform
- rename:
    field: message
    target_field: event.original
    ignore_missing: true
- json:
    field: event.original.payload
    target_field: forgerock

- set:
    field: event.id
    copy_from: forgerock._id
    ignore_failure: true
- set: 
    field: transaction.id
    copy_from: forgerock.transactionId
    ignore_failure: true

## TODO
# timestamp to @timestamp


# AM - access
- pipeline:
    if: ctx.forgerock?.topic == "access" # TODO add grok for AM-*
    name: '{{ IngestPipeline "am_access" }}'
# AM - activity
- pipeline:
    if: ctx.forgerock?.topic == "activity" # TODO add grok for AM-*
    name: '{{ IngestPipeline "am_activity" }}'
# AM - authentication
- pipeline:
    if: ctx.forgerock?.topic == "authentication" # TODO add grok for AM-*
    name: '{{ IngestPipeline "am_authentication" }}'
# AM - config
- pipeline:
    if: ctx.forgerock?.topic == "config" # TODO add grok for AM-*
    name: '{{ IngestPipeline "am_config" }}'
# IDM - access
- pipeline:
    if: ctx.forgerock?.topic == "access" && ctx.forgerock?.eventName == "access"
    name: '{{ IngestPipeline "idm_access" }}'
# IDM - activity
- pipeline:
    if: ctx.forgerock?.topic == "activity" && ctx.forgerock?.eventName == "activity"
    name: '{{ IngestPipeline "idm_activity" }}'
# IDM - authentication
- pipeline:
    if: ctx.forgerock?.topic == "activity" && ctx.forgerock?.eventName == "activity"
    name: '{{ IngestPipeline "idm_activity" }}'
# IDM - config
- pipeline:
    if: ctx.forgerock?.topic == "config" && ctx.forgerock?.eventName == "CONFIG"
    name: '{{ IngestPipeline "idm_config" }}'
# IDM - sync
- pipeline:
    if: ctx.forgerock?.topic == "sync"
    name: '{{ IngestPipeline "idm_sync" }}'

- remove:
    field: message
    if: ctx.tags == null || !(ctx.tags.contains('preserve_original_event'))
    ignore_failure: true
    ignore_missing: true
on_failure:
  - set:
      field: error.message
      value: "{{ _ingest.on_failure_message }}"
  - set:
      field: event.kind
      value: pipeline_error