---
description: Pipeline for processing etcd v3 metrics.
processors:
  - set:
      field: event.module
      value: etcd
  - set:
      field: ecs.version
      value: "8.11.0"
  - rename:
      field: prometheus.etcd_mvcc_db_total_size_in_bytes.value
      target_field: etcd.disk.mvcc_db_total_size.bytes
      ignore_missing: true
  - rename:
      field: prometheus.etcd_disk_wal_fsync_duration_seconds.histogram
      target_field: etcd.disk.wal_fsync_duration_seconds.histogram
      ignore_missing: true
  - rename:
      field: prometheus.etcd_disk_backend_commit_duration_seconds.histogram
      target_field: etcd.disk.backend_commit_duration_seconds.histogram
      ignore_missing: true
  - rename:
      field: prometheus.go_memstats_alloc_bytes.value
      target_field: etcd.memory.go_memstats_alloc.bytes
      ignore_missing: true
  - rename:
      field: prometheus.go_memstats_alloc_bytes_total.counter
      target_field: etcd.memory.go_memstats_alloc.total.bytes
      ignore_missing: true
  - rename:
      field: prometheus.etcd_network_client_grpc_sent_bytes_total.counter
      target_field: etcd.network.client_grpc_sent.bytes
      ignore_missing: true
  - rename:
      field: prometheus.etcd_network_client_grpc_received_bytes_total.counter
      target_field: etcd.network.client_grpc_received.bytes
      ignore_missing: true
  - rename:
      field: prometheus.etcd_server_has_leader.value
      target_field: etcd.server.has_leader.count
      ignore_missing: true
  - rename:
      field: prometheus.etcd_server_leader_changes_seen_total.counter
      target_field: etcd.server.leader_changes.count
      ignore_missing: true
  - rename:
      field: prometheus.etcd_server_proposals_committed_total.value
      target_field: etcd.server.proposals_committed.count
      ignore_missing: true
  - rename:
      field: prometheus.etcd_server_proposals_pending.value
      target_field: etcd.server.proposals_pending.count
      ignore_missing: true
  - rename:
      field: prometheus.etcd_server_proposals_failed_total.counter
      target_field: etcd.server.proposals_failed.count
      ignore_missing: true
  - rename:
      field: prometheus.grpc_server_started_total.counter
      target_field: etcd.server.grpc_started.count
      ignore_missing: true
  - rename:
      field: prometheus.grpc_server_handled_total.counter
      target_field: etcd.server.grpc_handled.count
      ignore_missing: true
  - rename:
      field: prometheus.process_start_time_seconds.value
      target_field: etcd.process_start_time.sec
      ignore_missing: true
  - rename:
      field: prometheus.etcd_network_peer_round_trip_time_seconds.histogram
      target_field: etcd.network.peer_round_trip_time_seconds.histogram
      ignore_missing: true
  - rename:
      field: prometheus.etcd_server_proposals_applied_total.value
      target_field: etcd.server.proposals_applied_total
      ignore_missing: true
  - rename:
      field: prometheus.etcd_network_peer_received_bytes_total.counter
      target_field: etcd.network.peer_received_bytes_total
      ignore_missing: true
  - rename:
      field: prometheus.etcd_network_peer_sent_bytes_total.counter
      target_field: etcd.network.peer_sent_bytes_total
      ignore_missing: true
  - rename:
      field: prometheus.etcd_network_peer_sent_failures_total.counter
      target_field: etcd.network.peer_sent_failures_total
      ignore_missing: true
  - rename:
      field: prometheus.etcd_network_peer_received_failures_total.counter
      target_field: etcd.network.peer_received_failures_total
      ignore_missing: true
  - rename:
      field: prometheus.etcd_debugging_store_writes_total.counter
      target_field: etcd.store.writes_total
      ignore_missing: true
  - rename:
      field: prometheus.etcd_debugging_store_expires_total.counter
      target_field: etcd.store.expires_total
      ignore_missing: true
  - rename:
      field: prometheus.etcd_debugging_store_reads_total.counter
      target_field: etcd.store.reads_total
      ignore_missing: true
  - rename:
      field: prometheus.etcd_debugging_store_watchers.value
      target_field: etcd.store.watchers
      ignore_missing: true
  - rename:
      field: prometheus.labels
      target_field: etcd.labels
      ignore_missing: true
      ignore_failure: true
  - fingerprint:
      fields: ["etcd.labels"]
      target_field: "etcd.labels.fingerprint"
      ignore_missing: true
  - remove:
      field: prometheus
      ignore_missing: true
  - set:
      field: event.kind
      value: pipeline_error
      if: ctx.error?.message != null
on_failure:
  - set:
      field: error.message
      value: "{{{_ingest.on_failure_message}}}"
  - append:
      field: event.kind
      value: pipeline_error
      allow_duplicates: false
