# Service Info

The Snort integration allows you to ingest logs from Snort, an open-source network intrusion detection system (NIDS) and intrusion prevention system (IPS). By collecting these logs, security teams can gain visibility into malicious network activity, policy violations, and potential security breaches in real-time.

## Common use cases

- **Intrusion Detection Monitoring:** Real-time monitoring of network traffic for known attack signatures, protocol anomalies, and suspicious behavior across the infrastructure.
- **Incident Response and Forensics:** Leveraging detailed JSON or Alert Fast logs to investigate the root cause of security breaches, identifying source and destination IPs, and analyzing packet metadata.
- **Compliance and Auditing:** Maintaining long-term records of network alerts to meet regulatory requirements (such as PCI-DSS, HIPAA, or SOC2) that mandate the logging of security-relevant events.
- **Network Traffic Analysis:** Using Snort data to identify non-malicious but unauthorized network usage, such as the use of prohibited protocols or high-bandwidth applications that violate corporate policy.

## Data types collected

This integration can collect the following types of data:

*   **Intrusion Detection Logs:** High-priority alerts generated when network traffic matches Snort's rule definitions.
*   **Network Metadata:** Protocol information, source and destination IP addresses, and port numbers associated with security events.
*   **Alert Formats:** Supports JSON (Snort 3), CSV (pfSense), and Alert Fast (legacy Snort) formats.

## Compatibility

This module has been developed and tested against **Snort** v2.9 and v3. It is expected to work with other versions that utilize the supported output formats, including Alert Fast, Snort 3 JSON, and pfSense CSV.

## Scaling and Performance

To ensure optimal performance in high-volume environments, consider the following:

- **Transport/Collection Considerations:** For network-based collection via the `udp` input, ensure the network path between Snort and the Elastic Agent has sufficient bandwidth and low latency. While UDP offers high performance for syslog transmission, it does not guarantee delivery. In environments where log reliability is critical, it is recommended to use the `logfile` input with an Elastic Agent installed locally on the Snort host to read directly from the disk.
- **Data Volume Management:** To manage high volumes of log data and reduce processing overhead, use Snort's internal "threshold" and "suppression" configuration to limit the number of alerts generated by noisy rules. Additionally, ensure that only necessary log formats (e.g., JSON or Fast) are enabled at the source to prevent redundant data ingestion and storage.

# Set Up Instructions

## Vendor prerequisites

- **Administrative Access:** Root or sudo privileges on the Snort host are required to modify configuration files and restart the service.
- **Snort Installation:** An active installation of Snort v2.9 or v3.0 and newer must be running.
- **Network Connectivity:** If using the UDP/Syslog method, the Snort host must be able to reach the Elastic Agent over the configured UDP port (default **9514**).
- **Format Configuration:** Snort must be explicitly configured to output logs in a supported format (Alert Fast, JSON, or CSV).
- **Log Directory Permissions:** The Elastic Agent must have read permissions for the Snort log directory (e.g., `/var/log/snort/`).

## Elastic prerequisites

- **Elastic Agent:** An Elastic Agent must be installed and enrolled in Fleet.
- **Connectivity:** Ensure the Elastic Agent can communicate with the Elasticsearch cluster to ship the collected data.

## Vendor set up steps

### For Snort 3 (Lua Configuration):

1. **Access Configuration:** Open the `snort.lua` configuration file, typically located at `/usr/local/etc/snort/snort.lua` or `/etc/snort/snort.lua`.
2. **Configure JSON Logging (Recommended):** To output high-fidelity logs for the Elastic Agent, add the following block:
   ```lua
   alert_json = {
       file = true,
       fields = 'timestamp pkt_num proto pkt_gen pkt_len dir src_addr src_port dst_addr dst_port service rule action class b64_data',
       limit = 100
   }
   ```
3. **Configure Alert Fast:** Alternatively, for the Alert Fast format, add:
   ```lua
   alert_fast = {
       file = true,
       packet = false,
       limit = 100
   }
   ```
4. **Configure Syslog (Optional):** If forwarding via UDP, add:
   ```lua
   alert_syslog = {
       facility = 'local5',
       level = 'alert'
   }
   ```
5. **Verify and Restart:** Validate the configuration by running `snort -c /usr/local/etc/snort/snort.lua -T`. If successful, restart Snort using `sudo systemctl restart snort`.

### For Snort 2.9 (Classic Configuration):

1. **Access Configuration:** Open the `snort.conf` file, usually found at `/etc/snort/snort.conf`.
2. **Enable Alert Fast:** Locate the output section and uncomment or add the following line:
   ```conf
   output alert_fast: alert.fast
   ```
3. **Enable Syslog:** To send alerts to a local syslog facility for forwarding, add:
   ```conf
   output alert_syslog: LOG_LOCAL5 LOG_ALERT
   ```
4. **Restart Snort:** Apply the changes by running `sudo service snort restart` or `sudo systemctl restart snort`.

### For Syslog Forwarding (UDP):

1. **Configure Rsyslog:** If using the UDP input, create a configuration file at `/etc/rsyslog.d/50-snort.conf`.
2. **Define Forwarding:** Add the following line to forward the `local5` facility to the Elastic Agent:
   ```text
   local5.* @<ELASTIC_AGENT_IP_ADDRESS>:9514
   ```
3. **Restart Service:** Restart the rsyslog daemon to apply the forwarding rule: `sudo systemctl restart rsyslog`.

### Vendor Set up Resources

- [Alert Logging - Snort 3 Rule Writing Guide](https://docs.snort.org/start/alert_logging) - Official guide on configuring various alert outputs in Snort 3.
- [Configuration - Snort 3 Rule Writing Guide](https://docs.snort.org/start/configuration) - Detailed configuration steps for Snort 3.

## Kibana set up steps

### Collect Snort logs (input: logfile)
1.  In Kibana, navigate to **Integrations > Snort**.
2.  Click **Add Snort**.
3.  Select the **Collect Snort logs (input: logfile)** input.
4.  Configure the following variables:
    *   **Paths** (`paths`): The list of paths to Snort log files. Default: `['/var/log/snort/alert.log']`.
    *   **Multi-line Alert Full logs** (`multiline_full`): Set to `True` if you are reading the Snort "Alert Full" log format which spans multiple lines. Default: `False`.
    *   **Internal Networks** (`internal_networks`): Specify the internal IP subnet(s) of your network (e.g., `['10.0.0.0/8']`). Default: `['private']`.
    *   **Timezone Offset** (`tz_offset`): Set the timezone offset (e.g., `"Europe/Amsterdam"`, `"EST"`, or `"-05:00"`) if logs are from a different timezone than the host. Default: `local`.
    *   **Preserve original event** (`preserve_original_event`): If enabled, the raw copy of the original event is added to the field `event.original`. Default: `False`.
    *   **Tags** (`tags`): Custom tags to add to the events. Default: `['forwarded', 'snort.log']`.
    *   **Processors** (`processors`): Add optional processors to filter or enhance data before it leaves the agent.
5.  Save and deploy the integration to your Elastic Agent policy.

### Collect Snort logs (input: udp)
1.  In Kibana, navigate to **Integrations > Snort**.
2.  Click **Add Snort**.
3.  Select the **Collect Snort logs (input: udp)** input.
4.  Configure the following variables:
    *   **Syslog Host** (`syslog_host`): The interface address to listen on for UDP traffic. Default: `localhost`.
    *   **Syslog Port** (`syslog_port`): The UDP port to listen on. Default: `9514`.
    *   **Internal Networks** (`internal_networks`): Specify the internal IP subnet(s) of your network. Default: `['private']`.
    *   **Timezone Offset** (`tz_offset`): Set the timezone offset for correct datetime parsing. Default: `local`.
    *   **Preserve original event** (`preserve_original_event`): If enabled, preserves the raw original event in `event.original`. Default: `False`.
    *   **Tags** (`tags`): Custom tags to add to the events. Default: `['forwarded', 'snort.log']`.
    *   **Custom UDP Options** (`udp_options`): Specify custom configuration options like `read_buffer`, `max_message_size`, or `timeout`.
    *   **Processors** (`processors`): Add optional processors to enhance or reduce fields in the exported event.
5.  Save and deploy the integration to your Elastic Agent policy.

# Validation Steps

After configuration is complete, verify that data is flowing correctly.

### 1. Trigger Data Flow on Snort:
- **Generate Test Alert:** Use a tool like `curl` to access a known malicious URI if you have rules for it, or use `nmap` to perform a basic scan against the interface Snort is monitoring.
- **Trigger ICMP Alert:** If ICMP rules are active, perform a ping sweep or a large packet ping: `ping -s 1500 <target_ip>`.
- **Manual Log Entry:** For testing the logfile input, append a test entry to the monitored file:
  `echo "01/01-12:00:00.000000 [**] [1:1000001:1] TEST ALERT [**] [Priority: 0] {TCP} 192.168.1.1:12345 -> 192.168.1.2:80" >> /var/log/snort/alert.log`

### 2. Check Data in Kibana:
1. Navigate to **Analytics > Discover**.
2. Select the `logs-*` data view.
3. Enter the KQL filter: `data_stream.dataset : "snort.log"`
4. Verify logs appear. Expand a log entry and confirm these fields:
   - `event.dataset` (should be `snort.log`)
   - `source.ip` and/or `destination.ip`
   - `event.action`, `event.outcome`, or `event.type`

# Troubleshooting

## Common Configuration Issues

- **Port Binding Conflicts**: If using the UDP input and the Elastic Agent fails to start, check if another service is already using port 9514 by running `netstat -tulpn | grep 9514`.
- **Logfile Permissions**: If logs are not appearing when using the `logfile` input, ensure the `elastic-agent` user has read access to the directory: `sudo chmod -R +r /var/log/snort/`.
- **Snort Output Disabled**: Ensure that the `output` directive in `snort.conf` or the `alert_` module in `snort.lua` is not commented out, as Snort does not log alerts to disk by default in some installations.

## Ingestion Errors

- **Parsing Failures**: If logs appear in Kibana but are not parsed correctly (check for `tags: _grokparsefailure`), ensure the Snort log format (Alert Fast vs JSON) matches the configuration provided in the integration.
- **Timezone Mismatch**: If events appear with the wrong timestamp, verify the `tz_offset` variable. This is common when the Snort sensor and the Elastic Stack are in different geographic regions.
- **Field Mapping Issues**: If custom Snort rules are used, some non-standard fields might not map to ECS. Check the `error.message` field in Discover for specific mapping errors.

# Documentation sites

- [Official Snort Documentation](https://docs.snort.org/welcome)
- [Snort FAQ](https://snort.org/faq)
