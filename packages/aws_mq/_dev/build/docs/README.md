# Amazon MQ

## Overview

[Amazon MQ](https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/) is a fully managed message broker service that supports [Apache ActiveMQ](http://activemq.apache.org/) Classic and [RabbitMQ](https://www.rabbitmq.com/), making it easy to set up and operate message brokers in the cloud. It provides automated broker provisioning, maintenance, and scaling, allowing you to focus on building applications without managing the underlying infrastructure. With built-in security, reliability, and support for industry-standard messaging protocols, Amazon MQ enables seamless communication between distributed applications.

The Amazon MQ integration allows you to efficiently collect and monitor broker performance, queue activity, and message throughput by ingesting CloudWatch metrics into Elastic. This integration helps you gain deep insights into broker health, optimize message flow, and troubleshoot issues in real time.


**IMPORTANT: Extra AWS charges on API requests will be generated by this integration. Check [API Requests](https://www.elastic.co/docs/current/integrations/aws#aws-api-requests) for more details.**

## Setup

### ActiveMQ

To enable the `activemq_general_logs` and `activemq_audit_logs` integrations, you must configure your ActiveMQ broker to publish general logs and audit logs to Amazon CloudWatch Logs. Follow these steps:

1. **Assign Necessary Permissions**: Ensure the IAM user creating or managing the broker has the `logs:CreateLogGroup` permission. This allows Amazon MQ to create the required log groups in CloudWatch.

2. **Set Up a Resource-Based Policy**: Configure a policy that permits Amazon MQ to publish logs to your CloudWatch log groups. This involves granting `logs:CreateLogStream` and `logs:PutLogEvents` permissions.

3. **Enable Logging on the Broker**:

    - Navigate to the [Amazon MQ console](https://console.aws.amazon.com/amazon-mq/).
    - During broker creation or by editing an existing broker, expand the **Additional settings** section.
    - In the **Logs** section, select the option to publish **General logs** and **Audit logs** to Amazon CloudWatch Logs.

For detailed instructions, refer to the [Amazon MQ Developer Guide](https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/configure-logging-monitoring-activemq.html#security-logging-monitoring-configure-cloudwatch-structure).

## Compatibility

This integration presently supports Amazon MQ for [Apache ActiveMQ](http://activemq.apache.org/) and [RabbitMQ](https://www.rabbitmq.com/).

## Data streams

The Amazon MQ integration collects metrics and logs from Apache ActiveMQ and RabbitMQ.


Data streams:
 - `activemq_general_logs`: Collects ActiveMQ general logs, including system events, warnings, and errors, which are published to a designated Amazon CloudWatch log group. 
 - `activemq_audit_logs`: Collects ActiveMQ audit logs, including management actions performed via JMX or the Web Console.
 - `rabbitmq_general_logs`: Collects RabbitMQ general logs, including system events, warnings, errors, which are published to a designated Amazon CloudWatch log group.
 - `activemq_metrics`: Collects broker metrics and destination (queue and topic) metrics.
 - `rabbitmq_metrics`: Collects broker, queue and node metrics.


## Requirements

You need Elasticsearch for storing and searching your data and Kibana for
visualizing and managing it. You can use our hosted Elasticsearch Service on
Elastic Cloud, which is recommended, or self-manage the Elastic Stack on your
own hardware.

Before using any Amazon MQ integration you will need:

* **AWS Credentials** to connect with your AWS account.
* **AWS Permissions** to make sure the user you're using to connect has
  permission to share the relevant data.

For more details about these requirements, check the [AWS
integration
documentation](https://docs.elastic.co/integrations/aws#requirements).

* Elastic Agent must be installed. For detailed guidance, follow these [instructions](https://www.elastic.co/guide/en/fleet/current/elastic-agent-installation.html).
* You can install only one Elastic Agent per host.
* Elastic Agent is required to stream data from the S3 bucket and ship the
  data to Elastic, where the events will then be processed through the
  integration's ingest pipelines.

## Logs

### Collecting Amazon MQ ActiveMQ general logs and audit logs from CloudWatch

### ActiveMQ general logs

When general logging is enabled for your Amazon MQ ActiveMQ broker, it publishes the `activemq.log` file at the default `INFO` logging level to a designated log group. Please note that `DEBUG` logging is not supported.

{{event "activemq_general_logs"}}
{{fields "activemq_general_logs"}}

### ActiveMQ audit logs

When audit logging is enabled, ActiveMQ logs management actions performed via JMX or the ActiveMQ Web Console to a designated log group.

{{event "activemq_audit_logs"}}
{{fields "activemq_audit_logs"}}

### RabbitMQ general logs

When you enable CloudWatch logging for your RabbitMQ brokers, Amazon MQ uses a service-linked role to publish general logs to CloudWatch. If no Amazon MQ service-linked role exists when you first create a broker, Amazon MQ will automatically create one. All subsequent RabbitMQ brokers will use the same service-linked role to publish logs to CloudWatch.

For more details, refer to [Configuring Amazon MQ for RabbitMQ logs](https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/rabbitmq-logging-monitoring.html?utm_source=chatgpt.com#security-logging-monitoring-rabbitmq).

{{event "rabbitmq_general_logs"}}
{{fields "rabbitmq_general_logs"}}

## Metrics

### ActiveMQ metrics

Amazon MQ for ActiveMQ provides a range of broker and queue metrics that help monitor system performance, resource utilization, and message flow. These metrics can be used for various use cases, including:

- Tracking broker resource utilization, such as compute, memory, and storage.
- Monitoring message throughput and queue performance.
- Identifying connection patterns and active consumers for optimizing messaging workloads.

The following metrics are related to [Amazon MQ quotas](https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-limits.html). You can disable their collection by turning off **Collect ActiveMQ quota metrics** under **Advanced Options**:

- AmqpMaximumConnections
- MqttMaximumConnections
- OpenwireMaximumConnections
- StompMaximumConnections
- WsMaximumConnections

{{event "activemq_metrics"}}
{{fields "activemq_metrics"}}


### RabbitMQ metrics

Amazon MQ for RabbitMQ offers a variety of broker and queue metrics to monitor system performance, resource utilization, and message flow. These metrics are essential for:

- Assessing broker resource usage, including CPU, memory, and storage.
- Tracking message rates and queue depths to ensure efficient message processing.
- Analyzing connection counts and consumer activity to optimize messaging workloads.

{{event "rabbitmq_metrics"}}
{{fields "rabbitmq_metrics"}}