config_version: 2
interval: {{interval}}
{{#if enable_request_tracer}}
resource.tracer.filename: "../../logs/cel/http-request-trace-*.ndjson"
request.tracer.maxbackups: 5
{{/if}}
{{#if proxy_url}}
resource.proxy_url: {{proxy_url}}
{{/if}}
{{#if ssl}}
resource.ssl: {{ssl}}
{{/if}}
{{#if http_client_timeout}}
resource.timeout: {{http_client_timeout}}
{{/if}}
resource.url: {{url}}
resource.headers:
  Content-Type:
    - application/json
  X-Team-ID:
    - {{team_id}}
  X-API-Key:
    - {{api_key}}
state:
  limit: {{limit}}
  time_range: {{time_range}}
program: |
  state.?cursor.?offset.orValue(0).as(offset,
    state.with(
      request(
        "GET",
        state.url + "/v1/scans/vuln/changelogs?" + {
          "limit": [string(state.limit)],
          "offset": [string(offset)],
          "time": [state.time_range],
        }.format_query()
      ).do_request().as(resp, (resp.StatusCode == 200) ?
        resp.Body.decode_json().as(body,
          {
            "events": body.data.map(data, {"projectdiscovery": data}),
            "cursor": {
              "offset": size(body.data) == state.limit ? body.data.size() + int(offset) : 0,
            },
            "want_more": size(body.data) == state.limit,
          }
        )
      :
        {
          "events": {
            "error": {
              "code": string(resp.StatusCode),
              "id": string(resp.Status),
              "message": string(resp.Body),
            },
          },
          "next": {},
          "want_more": false,
        }
      )
    )
  )

tags:
{{#if preserve_original_event}}
  - preserve_original_event
{{/if}}
{{#if preserve_duplicate_custom_fields}}
  - preserve_duplicate_custom_fields
{{/if}}
{{#each tags as |tag|}}
  - {{tag}}
{{/each}}
