---
description: Pipeline for processing vulnerability changelog events.
processors:
  - set:
      field: ecs.version
      tag: set_ecs_version
      value: '9.2.0'
  - foreach:
      field: projectdiscovery.change_event
      tag: convert_each_change_event_from
      processor:
        convert:
          field: _ingest._value.from
          type: string
          ignore_missing: true
  - foreach:
      field: projectdiscovery.change_event
      tag: convert_each_change_event_to
      processor:
        convert:
          field: _ingest._value.to
          type: string
          ignore_missing: true

  # ECS mapping
  - set:
      tag: set_event_kind
      field: event.kind
      value: event
  - set:
      tag: set_event_category
      field: event.category
      value: ['vulnerability']
  - set:
      tag: set_event_type
      field: event.type
      value: ['info']

  # Field normalization
  - rename:
      tag: rename_curl_command
      field: projectdiscovery.event.curl-command
      target_field: projectdiscovery.event.curl_command
      ignore_missing: true
  - rename:
      tag: rename_extracted_results
      field: projectdiscovery.event.extracted-results
      target_field: projectdiscovery.event.extracted_results
      ignore_missing: true
  - rename:
      tag: rename_extractor_name
      field: projectdiscovery.event.extractor-name
      target_field: projectdiscovery.event.extractor_name
      ignore_missing: true
  - rename:
      tag: rename_matched_at
      field: projectdiscovery.event.matched-at
      target_field: projectdiscovery.event.matched_at
      ignore_missing: true
  - rename:
      tag: rename_matcher_name
      field: projectdiscovery.event.matcher-name
      target_field: projectdiscovery.event.matcher_name
      ignore_missing: true
  - rename:
      tag: rename_matcher_status
      field: projectdiscovery.event.matcher-status
      target_field: projectdiscovery.event.matcher_status
      ignore_missing: true
  - rename:
      tag: rename_template_id
      field: projectdiscovery.event.template-id
      target_field: projectdiscovery.event.template_id
      ignore_missing: true
  - rename:
      tag: rename_template_path
      field: projectdiscovery.event.template-path
      target_field: projectdiscovery.event.template_path
      ignore_missing: true
  - rename:
      tag: rename_classification_cve_id
      field: projectdiscovery.event.info.classification.cve-id
      target_field: projectdiscovery.event.info.classification.cve_id
      ignore_missing: true
  - rename:
      tag: rename_classification_cvss_score
      field: projectdiscovery.event.info.classification.cvss-score
      target_field: projectdiscovery.event.info.classification.cvss_score
      ignore_missing: true
  - rename:
      tag: rename_classification_cwe_id
      field: projectdiscovery.event.info.classification.cwe-id
      target_field: projectdiscovery.event.info.classification.cwe_id
      ignore_missing: true
  - rename:
      tag: rename_classification_epss_percentile
      field: projectdiscovery.event.info.classification.epss-percentile
      target_field: projectdiscovery.event.info.classification.epss_percentile
      ignore_missing: true
  - rename:
      tag: rename_classification_epss_score
      field: projectdiscovery.event.info.classification.epss-score
      target_field: projectdiscovery.event.info.classification.epss_score
      ignore_missing: true

  - fingerprint:
      tag: fingerprint_event
      fields:
        - projectdiscovery.scan_id
        - projectdiscovery.updated_at
        - projectdiscovery.vuln_hash
        - projectdiscovery.vuln_id
      target_field: _id
      ignore_missing: true

  # ECS mapping
  - set:
      tag: set_host_name
      field: host.name
      copy_from: projectdiscovery.event.host
      ignore_empty_value: true
  - set:
      tag: set_source_ip
      field: source.ip
      copy_from: projectdiscovery.event.ip
      if: ctx.projectdiscovery?.event?.ip != null
  - convert:
      tag: convert_source_port
      field: projectdiscovery.event.port
      type: long
      if: ctx.projectdiscovery?.event?.port instanceof String
  - set:
      tag: set_source_port
      field: source.port
      copy_from: projectdiscovery.event.port
      ignore_empty_value: true
  - set:
      tag: set_event_reason
      field: event.reason
      copy_from: projectdiscovery.event.name
      ignore_empty_value: true
  - set:
      tag: set_event_severity
      field: event.severity
      copy_from: projectdiscovery.event.severity
      ignore_empty_value: true
  - set:
      tag: set_event_start
      field: event.start
      copy_from: projectdiscovery.event.timestamp
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_report_id
      field: vulnerability.report_id
      copy_from: projectdiscovery.scan_id
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_id
      field: vulnerability.id
      copy_from: projectdiscovery.event.info.classification.cve_id
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_severity
      field: vulnerability.severity
      copy_from: projectdiscovery.event.info.severity
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_description
      field: vulnerability.description
      copy_from: projectdiscovery.event.info.description
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_reference
      field: vulnerability.reference
      copy_from: projectdiscovery.event.info.reference
      ignore_empty_value: true
  - convert:
      tag: convert_cvss_score
      field: projectdiscovery.event.info.classification.cvss_score
      type: float
      ignore_missing: true
  - set:
      tag: set_vulnerability_score_base
      field: vulnerability.score.base
      copy_from: projectdiscovery.event.info.classification.cvss_score
      ignore_empty_value: true
  - foreach:
      tag: append_projectdiscovery_tags
      field: projectdiscovery.event.info.tags
      ignore_missing: true
      processor:
        append:
          field: tags
          value: '{{{_ingest._value}}}'
          allow_duplicates: false

  - remove:
      tag: remove_vendor_fields
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      ignore_missing: true
      field:
        - projectdiscovery.event.host
        - projectdiscovery.event.ip
        - projectdiscovery.event.info.classification.cve_id
        - projectdiscovery.event.info.classification.cvss_score
        - projectdiscovery.event.info.description
        - projectdiscovery.event.info.reference
        - projectdiscovery.event.info.severity
        - projectdiscovery.event.info.tags
        - projectdiscovery.event.name
        - projectdiscovery.event.port
        - projectdiscovery.event.severity
        - projectdiscovery.scan_id
        - projectdiscovery.timestamp

  - script:
      tag: script_drop_null_values
      description: Drops null/empty values recursively.
      lang: painless
      source: |
        boolean dropEmptyFields(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(value -> dropEmptyFields(value));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(value -> dropEmptyFields(value));
            return (((List) object).length == 0);
          }
          return false;
        }
        dropEmptyFields(ctx);

on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - set:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        with tag '{{{ _ingest.on_failure_processor_tag }}}'
        in pipeline '{{{ _ingest.pipeline }}}'
        failed with message '{{{ _ingest.on_failure_message }}}'
