---
description: ProjectDiscovery Cloud vulnerability export â†’ ECS

processors:
  - set:
      field: ecs.version
      value: '9.2.0'

  # Move the raw line into event.original if it's not already there
  - rename:
      field: message
      tag: rename_message_to_event_original
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - remove:
      field: message
      tag: remove_message
      ignore_missing: true
      if: ctx.event?.original != null

  # Parse original JSON into ctx.json
  - json:
      field: event.original
      tag: json_event_original
      target_field: json
      if: ctx.event?.original != null
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # Standard metadata
  - set:
      field: event.module
      value: projectdiscovery_cloud
  - set:
      field: event.dataset
      value: projectdiscovery_cloud.export

  # Default tags
  - append:
      field: tags
      value:
        - projectdiscovery-cloud
        - vulnerability
        - export
        - forwarded
      allow_duplicates: false

  # ECS event framing (export = current state snapshot)
  - set:
      field: event.kind
      value: event
  - set:
      field: event.category
      value:
        - vulnerability
  - set:
      field: event.type
      value:
        - info

  # Timestamp - use created_at or updated_at
  - date:
      field: json.created_at
      target_field: '@timestamp'
      formats:
        - ISO8601
      if: ctx.json?.created_at != null && ctx.json.created_at != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: json.updated_at
      target_field: '@timestamp'
      formats:
        - ISO8601
      if: ctx.json?.created_at == null && ctx.json?.updated_at != null && ctx.json.updated_at != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # ECS vulnerability mapping (copy, don't rename yet)
  - set:
      field: vulnerability.id
      copy_from: json.id
      ignore_empty_value: true
  - set:
      field: vulnerability.description
      copy_from: json.description
      ignore_empty_value: true
  - set:
      field: vulnerability.reference
      copy_from: json.reference
      ignore_empty_value: true
  - set:
      field: vulnerability.severity
      copy_from: json.severity
      ignore_empty_value: true
  - append:
      field: vulnerability.category
      value: '{{{json.category}}}'
      allow_duplicates: false
      if: ctx.json?.category != null
  - set:
      field: vulnerability.scanner.vendor
      value: ProjectDiscovery

  # ECS host/asset mapping (from 'host' field or matched_at URL)
  - set:
      field: host.hostname
      copy_from: json.host
      ignore_empty_value: true
  
  # URL mapping from matched_at when it looks like a URL
  - set:
      field: url.full
      copy_from: json.matched_at
      ignore_empty_value: true
      if: ctx.json?.matched_at != null && ctx.json.matched_at.startsWith('http')

  # Ports (if present in export data)
  - convert:
      field: json.port
      type: long
      target_field: server.port
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # Vendor namespace copies (keep vendor fidelity after ECS copies)
  - rename:
      field: json.scan_id
      target_field: projectdiscovery.scan_id
      ignore_missing: true
  - rename:
      field: json.vuln_hash
      target_field: projectdiscovery.vuln_hash
      ignore_missing: true
  - rename:
      field: json.template_url
      target_field: projectdiscovery.template_url
      ignore_missing: true
  - rename:
      field: json.template_name
      target_field: projectdiscovery.template_name
      ignore_missing: true
  - rename:
      field: json.template_id
      target_field: projectdiscovery.template_id
      ignore_missing: true
  - rename:
      field: json.matcher_name
      target_field: projectdiscovery.matcher_name
      ignore_missing: true
  - rename:
      field: json.matcher_status
      target_field: projectdiscovery.matcher_status
      ignore_missing: true
  - rename:
      field: json.created_at
      target_field: projectdiscovery.created_at
      ignore_missing: true
  - rename:
      field: json.updated_at
      target_field: projectdiscovery.updated_at
      ignore_missing: true
  - rename:
      field: json.host
      target_field: projectdiscovery.host
      ignore_missing: true
  - rename:
      field: json.matched_at
      target_field: projectdiscovery.matched_at
      ignore_missing: true
  - rename:
      field: json.tags
      target_field: projectdiscovery.tags
      ignore_missing: true
  - rename:
      field: json.category
      target_field: projectdiscovery.category
      ignore_missing: true
  - rename:
      field: json.request
      target_field: projectdiscovery.request
      ignore_missing: true
  - rename:
      field: json.response
      target_field: projectdiscovery.response
      ignore_missing: true
  - rename:
      field: json.remediation
      target_field: projectdiscovery.remediation
      ignore_missing: true
  - rename:
      field: json.reference
      target_field: projectdiscovery.reference
      ignore_missing: true
  - rename:
      field: json.vuln_status
      target_field: projectdiscovery.vuln_status
      ignore_missing: true
  - set:
      field: projectdiscovery.scanner_type
      value: nuclei

  # Final message
  - set:
      field: message
      value: 'ProjectDiscovery export: {{vulnerability.id}} [{{vulnerability.severity}}] {{projectdiscovery.vuln_status}}'
      if: ctx.vulnerability?.id != null && ctx.projectdiscovery?.vuln_status != null
  - set:
      field: message
      value: ProjectDiscovery vulnerability export event
      if: ctx.vulnerability?.id == null

  # Remove duplicate custom fields if tag is not set
  - remove:
      field:
        - projectdiscovery.created_at
        - projectdiscovery.updated_at
      tag: remove_custom_duplicate_fields
      ignore_missing: true
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))

  # Remove json temporary field
  - remove:
      field: json
      tag: remove_json
      ignore_missing: true

  # Drop null/empty values recursively
  - script:
      tag: script_to_drop_null_values
      lang: painless
      description: Drops null/empty values recursively.
      source: |-
        boolean drop(def v) {
          if (v == null) return true;
          if (v instanceof String) return v.length() == 0;
          if (v instanceof List) {
            for (int i = v.size() - 1; i >= 0; i--) {
              if (drop(v.get(i))) { v.remove(i); }
            }
            return v.size() == 0;
          }
          if (v instanceof Map) {
            def it = v.entrySet().iterator();
            while (it.hasNext()) {
              def e = it.next();
              if (drop(e.getValue())) { it.remove(); }
            }
            return v.size() == 0;
          }
          return false;
        }
        drop(ctx);

  # Set pipeline error if needed
  - set:
      field: event.kind
      tag: set_pipeline_error_into_event_kind
      value: pipeline_error
      if: ctx.error?.message != null

on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      tag: set_pipeline_error_to_event_kind
      value: pipeline_error
