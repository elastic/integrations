# System Tests for ProjectDiscovery Cloud Vulnerability Data Stream

This directory contains system test configurations for the ProjectDiscovery Cloud vulnerability data stream.

## Overview

System tests validate the complete end-to-end data flow using the **real ProjectDiscovery Cloud API**:
1. Elastic Agent is configured to collect data from the live ProjectDiscovery Cloud API
2. Data flows through the ingest pipeline
3. Documents are indexed into Elasticsearch
4. Field mappings and data types are validated

**Note**: These tests use the real ProjectDiscovery Cloud API with test credentials, not a mock server. This ensures the integration is tested against actual API responses.

## Test Scenarios

### `test-default-config.yml`
- **Purpose**: Tests basic data collection with default configuration
- **Configuration**: Uses real ProjectDiscovery Cloud API
- **API Endpoint**: `https://api.projectdiscovery.io/v1/scans/vuln/changelogs`
- **Interval**: 1 minute
- **Batch Size**: 10 events per request
- **Request Tracer**: Enabled for debugging

### `test-pagination-config.yml`
- **Purpose**: Tests pagination behavior with smaller batch sizes
- **Configuration**: Uses real ProjectDiscovery Cloud API
- **Batch Size**: 5 events per request (forces pagination)
- **Request Tracer**: Enabled for debugging

## Prerequisites

1. **elastic-package CLI** installed
   ```bash
   go install github.com/elastic/elastic-package@latest
   ```

2. **Docker** and **Docker Compose** installed

3. **Elastic Stack** running
   ```bash
   elastic-package stack up -d
   ```

## Running Tests

### Run All System Tests

From the package root directory:

```bash
cd /Users/yahyaghani/Documents/projectdiscovery_cloud
elastic-package test system
```

### Run Specific Test Scenario

```bash
elastic-package test system --test-name test-default
```

### Run with Verbose Output

```bash
elastic-package test system -v
```

## Test Configuration Structure

Each test configuration file follows this structure:

```yaml
vars:
  api_key: "..."           # API key for ProjectDiscovery Cloud
  team_id: "..."           # Team ID for ProjectDiscovery Cloud
  base_url: "..."          # Mock API URL (uses placeholders)
  interval: 1m             # Collection interval
  batch_size: 10           # Events per API request

data_stream:
  vars: {}                 # Data stream-specific overrides
```

## Real API Configuration

The system tests connect to the **live ProjectDiscovery Cloud API**:

- **Base URL**: `https://api.projectdiscovery.io`
- **Endpoint**: `GET /v1/scans/vuln/changelogs`
- **Authentication**: 
  - Header: `x-api-key` (or `X-API-Key`)
  - Header: `x-team-id` (or `X-Team-Id`)
- **Pagination**: Supports `limit` and `offset` query parameters
- **Test Credentials**: Configured in test YAML files

### API Parameters

The integration supports these query parameters:
- `limit`: Number of events per request (default: 100)
- `offset`: Pagination offset (default: 0)
- `time`: Time window filter (e.g., "last_day")
- `event_type`: Event type filter (default: "vuln_status")
- `sort_desc`: Sort field (default: "created_at")

## Troubleshooting

### Test Fails with Authentication Error

Check that the credentials in `test-default-config.yml` match those in `_dev/deploy/docker/docker-compose.yml`.

### Network Connectivity Issues

If tests fail to connect to the ProjectDiscovery Cloud API:

1. Verify network connectivity:
   ```bash
   curl -H "x-api-key: 5fd67011-374c-4df6-9a32-195b2a25300c" \
        -H "x-team-id: d2o2nj8ddous73bejvm0" \
        "https://api.projectdiscovery.io/v1/scans/vuln/changelogs?limit=1"
   ```

2. Check firewall/proxy settings
3. Verify test credentials are valid

### No Events Collected

1. Verify the API is returning data:
   ```bash
   curl -H "x-api-key: 5fd67011-374c-4df6-9a32-195b2a25300c" \
        -H "x-team-id: d2o2nj8ddous73bejvm0" \
        "https://api.projectdiscovery.io/v1/scans/vuln/changelogs?limit=10&offset=0"
   ```

2. Check Elastic Agent logs for errors

3. Verify ingest pipeline is processing correctly

4. Check HTTP request tracer logs:
   ```bash
   cat logs/httpjson/http-request-trace-*.ndjson
   ```

## Expected Test Results

When tests pass, you should see:
- ✅ Elastic Agent configured and running
- ✅ Events collected from ProjectDiscovery Cloud API
- ✅ Documents indexed in Elasticsearch
- ✅ All field mappings validated
- ✅ No mapping conflicts
- ✅ ECS compliance verified

**Note**: The number of events collected will vary based on actual data in your ProjectDiscovery Cloud account.

## Cleanup

After testing:

```bash
elastic-package stack down
```

This removes all test containers and resources.
