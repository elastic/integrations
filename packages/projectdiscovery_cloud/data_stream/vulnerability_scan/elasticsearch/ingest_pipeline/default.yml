---
description: Pipeline for processing vulnerability scan exports.
processors:
  - set:
      field: ecs.version
      tag: set_ecs_version
      value: '9.2.0'
  - fingerprint:
      tag: fingerprint_event
      fields:
        - projectdiscovery.id
        - projectdiscovery.scan_id
        - projectdiscovery.vuln_hash
      target_field: _id
      ignore_missing: true

  # ECS mapping
  - set:
      tag: set_event_kind
      field: event.kind
      value: event
  - set:
      tag: set_event_category
      field: event.category
      value: ['vulnerability']
  - set:
      tag: set_event_type
      field: event.type
      value: ['info']
  - set:
      tag: set_event_reason
      field: event.reason
      copy_from: projectdiscovery.category
      ignore_empty_value: true
  - set:
      tag: set_event_start
      field: event.start
      copy_from: projectdiscovery.created_at
      ignore_empty_value: true
  - set:
      tag: set_host_name
      field: host.name
      copy_from: projectdiscovery.host
      ignore_empty_value: true
  - set:
      tag: set_event_id
      field: event.id
      copy_from: projectdiscovery.id
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_description
      field: vulnerability.description
      copy_from: projectdiscovery.description
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_reference
      field: vulnerability.reference
      copy_from: projectdiscovery.reference
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_report_id
      field: vulnerability.report_id
      copy_from: projectdiscovery.scan_id
      ignore_empty_value: true
  - set:
      tag: set_vulnerability_severity
      field: vulnerability.severity
      copy_from: projectdiscovery.severity
      ignore_empty_value: true
  - foreach:
      tag: append_projectdiscovery_tags
      field: projectdiscovery.tags
      ignore_missing: true
      processor:
        append:
          field: tags
          value: '{{{_ingest._value}}}'
          allow_duplicates: false

  - remove:
      tag: remove_vendor_fields
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))
      ignore_missing: true
      field:
        - projectdiscovery.category
        - projectdiscovery.created_at
        - projectdiscovery.description
        - projectdiscovery.host
        - projectdiscovery.id
        - projectdiscovery.reference
        - projectdiscovery.scan_id
        - projectdiscovery.severity
        - projectdiscovery.tags
  - script:
      tag: script_drop_null_values
      description: Drops null/empty values recursively.
      lang: painless
      source: |
        boolean dropEmptyFields(Object object) {
          if (object == null || object == '') {
            return true;
          } else if (object instanceof Map) {
            ((Map) object).values().removeIf(value -> dropEmptyFields(value));
            return (((Map) object).size() == 0);
          } else if (object instanceof List) {
            ((List) object).removeIf(value -> dropEmptyFields(value));
            return (((List) object).length == 0);
          }
          return false;
        }
        dropEmptyFields(ctx);

on_failure:
  - set:
      field: event.kind
      value: pipeline_error
  - set:
      field: error.message
      value: >-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        with tag '{{{ _ingest.on_failure_processor_tag }}}'
        in pipeline '{{{ _ingest.pipeline }}}'
        failed with message '{{{ _ingest.on_failure_message }}}'
