---
description: ProjectDiscovery Cloud vulnerability changelogs → ECS

processors:
  - set:
      field: ecs.version
      value: '9.2.0'

  # Move the raw line into event.original if it's not already there
  - rename:
      field: message
      tag: rename_message_to_event_original
      target_field: event.original
      ignore_missing: true
      if: ctx.event?.original == null
  - remove:
      field: message
      tag: remove_message
      ignore_missing: true
      if: ctx.event?.original != null

  # Parse original JSON into ctx.json
  - json:
      field: event.original
      tag: json_event_original
      target_field: json
      if: ctx.event?.original != null
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # Standard metadata (no input.type; rely on ecs@mappings)
  - set:
      field: event.module
      value: projectdiscovery_cloud
  - set:
      field: event.dataset
      value: projectdiscovery_cloud.changelogs

  # Default tags
  - append:
      field: tags
      value:
        - projectdiscovery-cloud
        - vulnerability
        - changelogs
        - forwarded
      allow_duplicates: false

  # ECS event framing
  - set:
      field: event.kind
      value: event
  - set:
      field: event.category
      value:
        - vulnerability
  - set:
      field: event.type
      value:
        - info

  # Timestamp
  - date:
      field: json.created_at
      target_field: '@timestamp'
      formats:
        - ISO8601
      if: ctx.json?.created_at != null && ctx.json.created_at != ''
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'

  # ECS vulnerability mapping
  - set:
      field: vulnerability.id
      copy_from: json.vuln_id
      ignore_empty_value: true
  - set:
      field: vulnerability.description
      copy_from: json.event.info.description
      ignore_empty_value: true
  - set:
      field: vulnerability.reference
      copy_from: json.event.info.reference
      ignore_empty_value: true
  - set:
      field: vulnerability.severity
      copy_from: json.event.info.severity
      ignore_empty_value: true
  - set:
      field: vulnerability.scanner.vendor
      value: ProjectDiscovery

  # Ports
  - convert:
      field: json.event.port
      type: long
      target_field: json.event.port
      ignore_missing: true
      on_failure:
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: server.port
      copy_from: json.event.port
      ignore_empty_value: true
      if: ctx.json?.event?.port != null

  # Vendor namespace copies (keep vendor fidelity after ECS copies)
  - rename:
      field: json.target
      target_field: projectdiscovery.target
      ignore_missing: true
  - rename:
      field: json.vuln_status
      target_field: projectdiscovery.vuln_status
      ignore_missing: true

  # ECS destination mapping
  - set:
      field: destination.address
      copy_from: projectdiscovery.target
      ignore_empty_value: true
      if: ctx.projectdiscovery?.target != null
  - convert:
      description: Copy destination.address to either destination.ip or destination.domain
      tag: convert_destination_address
      field: destination.address
      target_field: destination.ip
      type: ip
      ignore_missing: true
      on_failure:
        - set:
            copy_from: destination.address
            field: destination.domain
            override: true

  # Optional: Sanitize malformed target field (gated by tag)
  # Fixes upstream API issue where delimiters are replaced with numeric ASCII codes
  - script:
      tag: sanitize_target_field
      lang: painless
      description: Cleans up malformed target field by replacing numeric artifacts with proper delimiters
      if: ctx.tags != null && ctx.tags.contains('sanitize_target') && ctx.projectdiscovery?.target != null
      source: |
        String target = ctx.projectdiscovery.target;
        // Replace common numeric artifacts with delimiters
        // 45 = ASCII for '-' (hyphen)
        // 48 = ASCII for '0' (zero, often appears as artifact)
        target = target.replace('45mdns.', '-mdns.');
        target = target.replace('48mdns.', '.mdns.');
        target = target.replace('48dns.', '.dns.');
        target = target.replace('48aawww.', '.www.');
        target = target.replace('48.48', '.');
        target = target.replace('48.', '.');
        // Store back
        ctx.projectdiscovery.target = target;
      on_failure:
        - append:
            field: error.message
            value: 'Failed to sanitize target field: {{{_ingest.on_failure_message}}}'

  - rename:
      field: json.vuln_hash
      target_field: projectdiscovery.vuln_hash
      ignore_missing: true
  - rename:
      field: json.scan_id
      target_field: projectdiscovery.scan_id
      ignore_missing: true
  - set:
      field: vulnerability.report_id
      copy_from: projectdiscovery.scan_id
      ignore_empty_value: true
      if: ctx.projectdiscovery?.scan_id != null
  - rename:
      field: json.template_url
      target_field: projectdiscovery.template_url
      ignore_missing: true
  - rename:
      field: json.matcher_status
      target_field: projectdiscovery.matcher_status
      ignore_missing: true
  - rename:
      field: json.created_at
      target_field: projectdiscovery.created_at
      ignore_missing: true
  - rename:
      field: json.updated_at
      target_field: projectdiscovery.updated_at
      ignore_missing: true
  - rename:
      field: json.change_event
      target_field: projectdiscovery.change_event
      ignore_missing: true
  - rename:
      field: json.event
      target_field: projectdiscovery.event
      ignore_missing: true

  # Final message
  - set:
      field: message
      value: 'ProjectDiscovery changelog: {{vulnerability.id}} → {{projectdiscovery.vuln_status}}'
      if: ctx.vulnerability?.id != null && ctx.projectdiscovery?.vuln_status != null
  - set:
      field: message
      value: ProjectDiscovery vulnerability changelog event
      if: ctx.vulnerability?.id == null

  # Remove duplicate custom fields if tag is not set
  - remove:
      field:
        - projectdiscovery.created_at
        - projectdiscovery.updated_at
      tag: remove_custom_duplicate_fields
      ignore_missing: true
      if: ctx.tags == null || !(ctx.tags.contains('preserve_duplicate_custom_fields'))

  # Remove json temporary field
  - remove:
      field: json
      tag: remove_json
      ignore_missing: true

  # Drop null/empty values recursively
  - script:
      tag: script_to_drop_null_values
      lang: painless
      description: Drops null/empty values recursively.
      source: |-
        boolean drop(def v) {
          if (v == null) return true;
          if (v instanceof String) return v.length() == 0;
          if (v instanceof List) {
            for (int i = v.size() - 1; i >= 0; i--) {
              if (drop(v.get(i))) { v.remove(i); }
            }
            return v.size() == 0;
          }
          if (v instanceof Map) {
            def it = v.entrySet().iterator();
            while (it.hasNext()) {
              def e = it.next();
              if (drop(e.getValue())) { it.remove(); }
            }
            return v.size() == 0;
          }
          return false;
        }
        drop(ctx);

  # Set pipeline error if needed
  - set:
      field: event.kind
      tag: set_pipeline_error_into_event_kind
      value: pipeline_error
      if: ctx.error?.message != null

on_failure:
  - append:
      field: error.message
      value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - set:
      field: event.kind
      tag: set_pipeline_error_to_event_kind
      value: pipeline_error
