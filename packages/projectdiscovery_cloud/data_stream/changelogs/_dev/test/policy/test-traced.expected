inputs:
    - data_stream:
        namespace: ep
      meta:
        package:
            name: projectdiscovery_cloud
      name: test-traced-projectdiscovery_cloud
      streams:
        - config_version: 2
          data_stream:
            dataset: projectdiscovery_cloud.changelogs
          interval: 24h
          program: |-
            // Early validation: fail fast if required credentials are missing
            !has(state.api_key) || string(state.api_key) == "" ?
              {
                "events": [],
                "want_more": false,
                "error": {"message": "api_key is required but was not provided"},
              }
            : !has(state.team_id) || string(state.team_id) == "" ?
              {
                "events": [],
                "want_more": false,
                "error": {"message": "team_id is required but was not provided"},
              }
            :
              state.?cursor.?offset.orValue(int(state.offset)).as(current_offset,
                state.with(
                  {
                    "base": state.url.trim_right("/") + "/v1/scans/vuln/changelogs",
                    "query": {
                      "limit": [string(state.batch_size)],
                      "offset": [string(current_offset)],
                      "event_type": ["vuln_status"],
                      "sort_desc": ["created_at"],
                      ?"time": (state.time_window != "") ?
                        optional.of([string(state.time_window)])
                      :
                        optional.none(),
                    },
                  }.as(req,
                    request(
                      "GET",
                      req.base + "?" + req.query.format_query()
                    ).with(
                      {
                        "Header": {
                          "X-API-Key": [string(state.api_key)],
                          "X-Team-Id": [string(state.team_id)],
                        },
                      }
                    ).do_request().as(resp,
                    {
                      "status_ok": resp.StatusCode == 200,
                      "resp": resp,
                      "body": (size(resp.Body) != 0) ? bytes(resp.Body).decode_json() : {}
                    }.as(vars,
                      {
                        "items": (vars.status_ok && ("data" in vars.body) && vars.body["data"] != null) ? vars.body["data"] : []
                      }.as(x,
                        {
                          "events": x.items.map(e, {"message": e.encode_json()}),
                          "cursor": { "offset": int(current_offset) + x.items.size() },
                          "want_more": vars.status_ok && x.items.size() == int(state.batch_size),
                          ?"error": vars.status_ok ?
                            optional.none() :
                            optional.of({"message": "HTTP " + string(vars.resp.StatusCode) + " " + string(vars.resp.Body)}),
                          "api_key": ("api_key" in state) ? state["api_key"] : "",
                          "team_id": ("team_id" in state) ? state["team_id"] : "",
                          "url": ("url" in state) ? state["url"] : "",
                          "batch_size": state.batch_size,
                          "time_window": state.time_window,
                        }
                      )
                    )
                  )
                )
              )
          publisher_pipeline.disable_host: true
          redact:
            fields:
                - api_key
                - team_id
          resource.timeout: 10s
          resource.tracer:
            enabled: true
            filename: ../../logs/cel/http-request-trace-*.ndjson
            maxbackups: 5
          resource.url: https://api.projectdiscovery.io
          state:
            api_key: ${SECRET_0}
            batch_size: 50
            offset: 0
            team_id: traced_team
            time_window: 24h
            url: https://api.projectdiscovery.io
          tags:
            - projectdiscovery-cloud
            - vulnerability
            - changelogs
            - forwarded
      type: cel
      use_output: default
output_permissions:
    default:
        _elastic_agent_checks:
            cluster:
                - monitor
        _elastic_agent_monitoring:
            indices: []
        uuid-for-permissions-on-related-indices:
            indices:
                - names:
                    - logs-projectdiscovery_cloud.changelogs-ep
                  privileges:
                    - auto_configure
                    - create_doc
secret_references:
    - {}
