---
description: Pipeline for processing domain rdap feed
processors:
- json:
    field: message
    target_field: domaintools
    on_failure:
      - set:
          field: error.message
          value: "Failed to parse JSON from message: {{ ctx.message }} {{ error.message }}"

- set:
    field: domaintools.feed
    value: 'domainrdap'

- set:
    field: domaintools.first_request_timestamp
    copy_from: domaintools.raw_record.first_request_timestamp

- foreach:
    field: domaintools.raw_record.requests
    processor:
      append:
        field: domaintools.requests_url
        value: "{{ _ingest._value.url }}"


  ############################
  # Generic indicator fields #
  ############################

- set:
    field: threat.indicator.type
    value: domain-name
- set:
    if: ctx.domaintools != null && ctx.domaintools?.domain != null
    field: threat.indicator.name
    copy_from: domaintools.domain

  ######################
  # Threat feed fields #
  ######################

- set:
    field: threat.feed.description
    value: 'Changes to global domain registration information, populated by the Registration Data Access Protocol (RDAP). Compliments the 5-Minute WHOIS Feed as registries and registrars switch from Whois to RDAP.'
- set:
    field: threat.feed.name
    value: 'DomainTools domain RDAP'
- set:
    field: threat.feed.reference
    value: https://docs.techdocs.ci.domaintools.cloud/feeds/realtime/userguide/

  ####################
  # Event ECS fields #
  ####################

- set:
    field: ecs.version
    value: '8.11.0'
- set:
    field: event.kind
    value: enrichment
- set:
    field: event.category
    value: ['threat']
- set:
    field: event.type
    value: ['indicator']

- remove:
    field:
      - domaintools.raw_record
      - domaintools.parsed_record.parsed_fields.conformance
      - domaintools.parsed_record.parsed_fields.dnssec
      - domaintools.parsed_record.parsed_fields.domain
      - domaintools.parsed_record.parsed_fields.domain_statuses
      - domaintools.parsed_record.parsed_fields.links
      - domaintools.parsed_record.parsed_fields.unclassified_emails
      - domaintools.parsed_record.registrar_request_url
      - domaintools.parsed_record.registry_request_url
    ignore_missing: true

on_failure:
- set:
    field: error.message
    value: '{{ _ingest.on_failure_message }}'

