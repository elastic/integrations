---
description: Pipeline for processing Metadata object.
# Metadata object docs: https://schema.ocsf.io/1.5.0/objects/metadata
processors:
  - foreach:
      field: aws_securityhub.finding.metadata.data_classifications
      if: ctx.aws_securityhub?.finding?.metadata?.data_classifications instanceof List
      processor:
        convert:
          field: _ingest._value.category_id
          tag: convert_finding_metadata_data_classifications_category_id_to_string
          type: string
          ignore_missing: true
  - foreach:
      field: aws_securityhub.finding.metadata.data_classifications
      if: ctx.aws_securityhub?.finding?.metadata?.data_classifications instanceof List
      processor:
        convert:
          field: _ingest._value.confidentiality_id
          tag: convert_finding_metadata_data_classifications_confidentiality_id_to_string
          type: string
          ignore_missing: true
  - foreach:
      field: aws_securityhub.finding.metadata.data_classifications
      if: ctx.aws_securityhub?.finding?.metadata?.data_classifications instanceof List
      processor:
        convert:
          field: _ingest._value.size
          tag: convert_finding_metadata_data_classifications_size_to_long
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.size
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: aws_securityhub.finding.metadata.data_classifications
      if: ctx.aws_securityhub?.finding?.metadata?.data_classifications instanceof List
      processor:
        convert:
          field: _ingest._value.status_id	
          tag: convert_finding_metadata_data_classifications_status_id_to_string
          type: string
          ignore_missing: true
  - foreach:
      field: aws_securityhub.finding.metadata.data_classifications
      if: ctx.aws_securityhub?.finding?.metadata?.data_classifications instanceof List
      processor:
        convert:
          field: _ingest._value.total
          tag: convert_finding_metadata_data_classifications_total_to_long
          type: long
          ignore_missing: true
          on_failure:
            - remove:
                field: _ingest._value.total
                ignore_missing: true
            - append:
                field: error.message
                value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: aws_securityhub.finding.metadata.logged_time_dt
      tag: date_metadata_logged_time_dt
      target_field: aws_securityhub.finding.metadata.logged_time_dt
      formats:
        - ISO8601
        - UNIX_MS
        - yyyy-MM-dd HH:mm:ss[.SSSSSSSSS][.SSSSSSSS][.SSSSSSS][.SSSSSS][.SSSSS][.SSSS][.SSS][.SS][.S]X
      if: ctx.aws_securityhub?.finding?.metadata?.logged_time_dt != null && ctx.aws_securityhub.finding.metadata.logged_time_dt != ''
      on_failure:
        - remove:
            field: aws_securityhub.finding.metadata.logged_time_dt
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: aws_securityhub.finding.metadata.logged_time
      tag: date_metadata_logged_time
      target_field: aws_securityhub.finding.metadata.logged_time
      formats:
        - UNIX_MS
      if: ctx.aws_securityhub?.finding?.metadata?.logged_time != null && ctx.aws_securityhub.finding.metadata.logged_time != ''
      on_failure:
        - remove:
            field: aws_securityhub.finding.metadata.logged_time
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: aws_securityhub.finding.metadata.loggers
      if: ctx.aws_securityhub?.finding?.metadata?.loggers instanceof List
      processor:
        date:
          field: _ingest._value.logged_time_dt
          tag: date_metadata_loggers_logged_time_dt
          target_field: _ingest._value.logged_time_dt
          formats:
            - ISO8601
            - UNIX_MS
            - yyyy-MM-dd HH:mm:ss[.SSSSSSSSS][.SSSSSSSS][.SSSSSSS][.SSSSSS][.SSSSS][.SSSS][.SSS][.SS][.S]X
          on_failure:
            - remove:
                field: _ingest._value.logged_time_dt
                ignore_missing: true
  - foreach:
      field: aws_securityhub.finding.metadata.loggers
      if: ctx.aws_securityhub?.finding?.metadata?.loggers instanceof List
      processor:
        date:
          field: _ingest._value.logged_time
          tag: date_metadata_loggers_logged_time
          target_field: _ingest._value.logged_time
          formats:
            - UNIX_MS
          on_failure:
            - remove:
                field: _ingest._value.logged_time
                ignore_missing: true
  - foreach:
      field: aws_securityhub.finding.metadata.loggers
      if: ctx.aws_securityhub?.finding?.metadata?.loggers instanceof List
      processor:
        date:
          field: _ingest._value.transmit_time_dt
          tag: date_metadata_loggers_transmit_time_dt
          target_field: _ingest._value.transmit_time_dt
          formats:
            - ISO8601
            - UNIX_MS
            - yyyy-MM-dd HH:mm:ss[.SSSSSSSSS][.SSSSSSSS][.SSSSSSS][.SSSSSS][.SSSSS][.SSSS][.SSS][.SS][.S]X
          on_failure:
            - remove:
                field: _ingest._value.transmit_time_dt
                ignore_missing: true
  - foreach:
      field: aws_securityhub.finding.metadata.loggers
      if: ctx.aws_securityhub?.finding?.metadata?.loggers instanceof List
      processor:
        date:
          field: _ingest._value.transmit_time
          tag: date_metadata_loggers_transmit_time
          target_field: _ingest._value.transmit_time
          formats:
            - UNIX_MS
          on_failure:
            - remove:
                field: _ingest._value.transmit_time
                ignore_missing: true
  - date:
      field: aws_securityhub.finding.metadata.modified_time_dt
      tag: date_metadata_modified_time_dt
      target_field: aws_securityhub.finding.metadata.modified_time_dt
      formats:
        - ISO8601
        - UNIX_MS
        - yyyy-MM-dd HH:mm:ss[.SSSSSSSSS][.SSSSSSSS][.SSSSSSS][.SSSSSS][.SSSSS][.SSSS][.SSS][.SS][.S]X
      if: ctx.aws_securityhub?.finding?.metadata?.modified_time_dt != null && ctx.aws_securityhub.finding.metadata.modified_time_dt != ''
      on_failure:
        - remove:
            field: aws_securityhub.finding.metadata.modified_time_dt
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: aws_securityhub.finding.metadata.modified_time
      tag: date_metadata_modified_time
      target_field: aws_securityhub.finding.metadata.modified_time
      formats:
        - UNIX_MS
      if: ctx.aws_securityhub?.finding?.metadata?.modified_time != null && ctx.aws_securityhub.finding.metadata.modified_time != ''
      on_failure:
        - remove:
            field: aws_securityhub.finding.metadata.modified_time
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: aws_securityhub.finding.metadata.processed_time_dt
      tag: date_metadata_processed_time_dt
      target_field: aws_securityhub.finding.metadata.processed_time_dt
      formats:
        - ISO8601
        - UNIX_MS
        - yyyy-MM-dd HH:mm:ss[.SSSSSSSSS][.SSSSSSSS][.SSSSSSS][.SSSSSS][.SSSSS][.SSSS][.SSS][.SS][.S]X
      if: ctx.aws_securityhub?.finding?.metadata?.processed_time_dt != null && ctx.aws_securityhub.finding.metadata.processed_time_dt != ''
      on_failure:
        - remove:
            field: aws_securityhub.finding.metadata.processed_time_dt
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - date:
      field: aws_securityhub.finding.metadata.processed_time
      tag: date_metadata_processed_time
      target_field: aws_securityhub.finding.metadata.processed_time
      formats:
        - UNIX_MS
      if: ctx.aws_securityhub?.finding?.metadata?.processed_time != null && ctx.aws_securityhub.finding.metadata.processed_time != ''
      on_failure:
        - remove:
            field: aws_securityhub.finding.metadata.processed_time
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - convert:
      field: aws_securityhub.finding.metadata.sequence
      tag: convert_finding_metadata_sequence_to_long
      type: long
      ignore_missing: true
      on_failure:
        - remove:
            field: aws_securityhub.finding.metadata.sequence
            ignore_missing: true
        - append:
            field: error.message
            value: 'Processor {{{_ingest.on_failure_processor_type}}} with tag {{{_ingest.on_failure_processor_tag}}} in pipeline {{{_ingest.on_failure_pipeline}}} failed with message: {{{_ingest.on_failure_message}}}'
  - foreach:
      field: aws_securityhub.finding.metadata.transformation_info_list
      if: ctx.aws_securityhub?.finding?.metadata?.transformation_info_list instanceof List
      processor:
        date:
          field: _ingest._value.time_dt
          tag: date_metadata_transformation_info_list_time_dt
          target_field: _ingest._value.time_dt
          formats:
            - ISO8601
            - UNIX_MS
            - yyyy-MM-dd HH:mm:ss[.SSSSSSSSS][.SSSSSSSS][.SSSSSSS][.SSSSSS][.SSSSS][.SSSS][.SSS][.SS][.S]X
          on_failure:
            - remove:
                field: _ingest._value.time_dt
                ignore_missing: true
  - foreach:
      field: aws_securityhub.finding.metadata.transformation_info_list
      if: ctx.aws_securityhub?.finding?.metadata?.transformation_info_list instanceof List
      processor:
        date:
          field: _ingest._value.time
          tag: date_metadata_transformation_info_list_time
          target_field: _ingest._value.time
          formats:
            - UNIX_MS
          on_failure:
            - remove:
                field: _ingest._value.time
                ignore_missing: true
on_failure:
  - append:
      field: error.message
      value: |-
        Processor '{{{ _ingest.on_failure_processor_type }}}'
        {{{#_ingest.on_failure_processor_tag}}}with tag '{{{ _ingest.on_failure_processor_tag }}}'
        {{{/_ingest.on_failure_processor_tag}}}failed with message '{{{ _ingest.on_failure_message }}}'
  - set:
      field: event.kind
      tag: set_pipeline_error_to_event_kind
      value: pipeline_error
  - append:
      field: tags
      value: preserve_original_event
      allow_duplicates: false
