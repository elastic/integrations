# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json
name: integrations-schedule-daily

env:
  SETUP_GVM_VERSION: "v0.5.2"
  LINUX_AGENT_IMAGE: "golang:${GO_VERSION}"

# The pipeline is triggered by the scheduler every day
steps:
  - label: ":white_check_mark: Check go sources"
    key: "check"
    command: ".buildkite/scripts/check_sources.sh"
    agents:
      image: "${LINUX_AGENT_IMAGE}"
      cpu: "8"
      memory: "4G"

  # TODO: Once removing this step, review depends_on configuration in 9.x step
  - label: "Check integrations local stacks - Stack Version v7.17"
    key: "local-7-stack"
    trigger: "integrations"
    build:
      env:
        SERVERLESS: "false"
        FORCE_CHECK_ALL: "true"
        STACK_VERSION: 7.17.25-SNAPSHOT
    depends_on:
      - step: "check"
        allow_failure: false

  - label: "Check integrations local stacks - Stack Version v8.16"
    key: "local-8-stack"
    trigger: "integrations"
    build:
      env:
        SERVERLESS: "false"
        FORCE_CHECK_ALL: "true"
        STACK_VERSION: 8.16.0-SNAPSHOT
        PUBLISH_COVERAGE_REPORTS: "true"
    depends_on:
      - step: "check"
        allow_failure: false

  - label: "Check integrations local stacks - Stack Version v8.16 - LogsDB"
    key: "local-8-stack-logsdb"
    trigger: "integrations"
    build:
      env:
        SERVERLESS: "false"
        FORCE_CHECK_ALL: "true"
        STACK_VERSION: 8.16.0-SNAPSHOT
        STACK_LOGSDB_ENABLED: "true"
        PUBLISH_COVERAGE_REPORTS: "false"
    depends_on:
      - step: "check"
        allow_failure: false

  - label: "Check integrations local stacks - Stack Version v9.0"
    key: "local-9-stack-logsdb"
    trigger: "integrations"
    build:
      env:
        SERVERLESS: "false"
        FORCE_CHECK_ALL: "true"
        STACK_VERSION: 9.0.0-SNAPSHOT
        PUBLISH_COVERAGE_REPORTS: "false"
    depends_on: # TODO: once removed 7.x step , update depends_on.step value to "check" and allow_failure to false
      - step: "local-8-stack"
        allow_failure: true

  - label: "Check integrations in serverless - project: Observability"
    key: "trigger-integrations-serverless-obs"
    trigger: "integrations-serverless"
    build:
      env:
        SERVERLESS_PROJECT: observability
    depends_on:
      - step: "check"
        allow_failure: false

  - label: "Check integrations in serverless - project: Security"
    key: "trigger-integrations-serverless-security"
    trigger: "integrations-serverless"
    build:
      env:
        SERVERLESS_PROJECT: security
    depends_on:
      - step: "check"
        allow_failure: false

  - label: ":package: Publish missing packages"
    key: "trigger-integrations-publish"
    trigger: "integrations-publish"
    depends_on:
      - step: "check"
        allow_failure: false
