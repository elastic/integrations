#!/bin/bash

source .buildkite/scripts/common.sh

set -euo pipefail

if [[ "$BUILDKITE_PIPELINE_SLUG" == "integrations" ]]; then
    if [[ "$BUILDKITE_STEP_KEY" =~ test-integrations-serverless-(obs|security) ]]; then
        unset ELASTIC_PACKAGE_AWS_ACCESS_KEY
        unset ELASTIC_PACKAGE_AWS_SECRET_KEY
        unset AWS_ACCESS_KEY_ID
        unset AWS_SECRET_ACCESS_KEY

        # Ensure that kind cluster is deleted
        delete_kind_cluster

        # Ensure elastic stack is stopped
        if [ -f ${ELASTIC_PACKAGE_BIN} ]; then
            export EC_API_KEY=${EC_API_KEY_SECRET}
            export EC_HOST=${EC_HOST_SECRET}

            ${ELASTIC_PACKAGE_BIN} stack down -v

            unset EC_API_KEY
            unset EC_HOST
        fi
    fi
fi

if [[ "$BUILDKITE_PIPELINE_SLUG" == "integrations-schedule-daily" ]]; then
    if [[ "$BUILDKITE_STEP_KEY" =~ test-integrations-serverless-(obs|security) ]]; then
        unset ELASTIC_PACKAGE_AWS_ACCESS_KEY
        unset ELASTIC_PACKAGE_AWS_SECRET_KEY
        unset AWS_ACCESS_KEY_ID
        unset AWS_SECRET_ACCESS_KEY

        # Ensure that kind cluster is deleted
        delete_kind_cluster

        # Ensure elastic stack is stopped
        if [ -f ${ELASTIC_PACKAGE_BIN} ]; then
            export EC_API_KEY=${EC_API_KEY_SECRET}
            export EC_HOST=${EC_HOST_SECRET}

            ${ELASTIC_PACKAGE_BIN} stack down -v

            unset EC_API_KEY
            unset EC_HOST
        fi
    fi
fi

unset_secrets
cleanup
