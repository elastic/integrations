# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json
env:
  SETUP_GVM_VERSION: "v0.5.2"
  DOCKER_COMPOSE_VERSION: "v2.24.1"
  DOCKER_VERSION: "26.1.2"
  KIND_VERSION: 'v0.27.0'
  K8S_VERSION: 'v1.32.0'
  YQ_VERSION: 'v4.35.2'
  JQ_VERSION: '1.7'
  GH_CLI_VERSION: "2.29.0"

  # Agent images used in pipeline steps
  LINUX_AGENT_IMAGE: "golang:${GO_VERSION}"
  IMAGE_UBUNTU_X86_64: "family/core-ubuntu-2204"

  # Elastic package settings
  # Manage docker output/logs
  ELASTIC_PACKAGE_COMPOSE_DISABLE_VERBOSE_OUTPUT: "true"
  # Default license to use by `elastic-package build`
  ELASTIC_PACKAGE_REPOSITORY_LICENSE: "licenses/Elastic-2.0.txt"
  # Link definitions path (full path to be set in the corresponding step)
  ELASTIC_PACKAGE_LINKS_FILE_PATH: "links_table.yml"
  # Disable comparison of results in pipeline tests to avoid errors related to GeoIP fields
  ELASTIC_PACKAGE_SERVERLESS_PIPELINE_TEST_DISABLE_COMPARE_RESULTS: "true"
  # Enable independent Elastic Agents for all packages
  ELASTIC_PACKAGE_TEST_ENABLE_INDEPENDENT_AGENT: "true"
  # Set maximum number of parallel tests to run if package allows it
  ELASTIC_PACKAGE_MAXIMUM_NUMBER_PARALLEL_TESTS: "5"
  # Enable/Disable the usage of wolfi images for Elastic Agent
  ELASTIC_PACKAGE_DISABLE_ELASTIC_AGENT_WOLFI: "${ELASTIC_PACKAGE_DISABLE_ELASTIC_AGENT_WOLFI:-false}"
  # Disable checking for newer versions
  ELASTIC_PACKAGE_CHECK_UPDATE_DISABLED: "true"

steps:
  - label: "Get reference from target branch"
    key: "reference-target-branch"
    command: "echo 'Get reference from main'"
    agents:
      image: "${LINUX_AGENT_IMAGE}"

  - label: "Check integrations apache_tomcat"
    key: "test-integrations-apache_tomcat"
    command: ".buildkite/scripts/test_one_package.sh apache_tomcat origin/main d2b1504eae3fcd8b573c718f07b4b4f182a4c0ce"
    timeout_in_minutes: 240
    agents:
      provider: gcp
      image: ${IMAGE_UBUNTU_X86_64}
    env:
      STACK_VERSION: "${STACK_VERSION}"
      FORCE_CHECK_ALL: "false"
      SERVERLESS: "false"
      UPLOAD_SAFE_LOGS: 1
    plugins:
      # See https://github.com/elastic/oblt-infra/blob/main/conf/resources/repos/integrations/01-aws-buildkite-oidc.tf
      # This plugin creates the environment variables required by the service deployer (AWS_SECRET_ACCESS_KEY and AWS_SECRET_KEY_ID)
      - elastic/oblt-aws-auth#test/debug:
          duration: 10800 # seconds
    artifact_paths:
      - build/test-results/*.xml
      - build/test-coverage/*.xml
      - build/benchmark-results/*.json
      - build/elastic-stack-dump/*/logs/*.log
      - build/elastic-stack-dump/*/logs/fleet-server-internal/**/*
