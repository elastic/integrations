# Review Log for https://github.com/elastic/integrations/pull/14161
Date: 2025-09-07T17:12:00Z

## Reviewer: efd6

### packages/bitsight/LICENSE.txt
- L1: This doesn't need to be included.
  - Fix: Removed package-level LICENSE file.
  - Files: packages/bitsight/LICENSE.txt
  - Explanation: Package artifacts inherit licensing; a package-local LICENSE isn’t required and may be redundant.
  - Status: done

### packages/bitsight/_dev/build/build.yml
- L4: Add final new line.
  - Fix: Ensured trailing newline exists.
  - Files: packages/bitsight/_dev/build/build.yml
  - Explanation: Some tooling expects a newline-terminated last line.
  - Status: done

### packages/bitsight/_dev/deploy/docker/docker-compose.yml
- L3: suggestion: image: docker.elastic.co/observability/stream:v0.18.0
  - Fix: Bumped mock stream image to v0.18.0.
  - Files: packages/bitsight/_dev/deploy/docker/docker-compose.yml:3
  - Explanation: Use the latest vetted mock server image used across recent integrations.
  - Status: done
- L14: Add final new line.
  - Fix: Ensured trailing newline exists.
  - Files: packages/bitsight/_dev/deploy/docker/docker-compose.yml
  - Explanation: Formatting hygiene.
  - Status: done

### packages/bitsight/data_stream/vulnerability/_dev/test/pipeline/test-common-config.yml
- L3: Fleet adds event.ingested; want preserve_original_event here.
  - Fix: Removed dynamic_fields for event.ingested; added tags: [preserve_original_event].
  - Files: packages/bitsight/data_stream/vulnerability/_dev/test/pipeline/test-common-config.yml:1
  - Explanation: Align test harness to rely on preserve_original_event behavior; event.ingested is handled by Fleet.
  - Status: done

### packages/bitsight/data_stream/vulnerability/_dev/test/system/test-default-config.yml
- L13: Ensure more than one document for pagination.
  - Fix: Set hit_count: 2 and extended mock config to serve a second page.
  - Files: packages/bitsight/data_stream/vulnerability/_dev/test/system/test-default-config.yml:13; packages/bitsight/_dev/deploy/docker/files/config-vulnerability.yml
  - Explanation: Validates stateful pagination end-to-end.
  - Status: done

### packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs
- L130: use resp.Body.decode_json() (no bytes()).
  - Fix: Replaced bytes(resp.Body).decode_json() with resp.Body.decode_json().
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:130
  - Explanation: Current Agent/CEL versions handle decode directly from Body.
  - Status: done
- L200: same change.
  - Fix: Applied same replacement.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:200
  - Explanation: Consistency across all parsing sites.
  - Status: done
- L268: same change.
  - Fix: Applied same replacement.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:268
  - Explanation: Consistency across all parsing sites.
  - Status: done
- L158: improve error prefix.
  - Fix: Message now starts with GET <base>/ratings/v2/threats/ job: …
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:158
  - Explanation: Clearer endpoint context in logs.
  - Status: done
- L177: improve error prefix.
  - Fix: Message now starts with GET <base>/ratings/v2/threats/: …
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:177
  - Explanation: Clearer endpoint context in logs.
  - Status: done
- L117: Dequeue wording.
  - Fix: Reworded comment to “Dequeue the first job”.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:117
  - Explanation: Matches the LIFO queue semantics described.
  - Status: done
- L146, L213, L285: Guard links.next and check non-empty.
  - Fix: Use has(body.?links.next) && body.links.next != null && body.links.next != "".
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:146,213,285
  - Explanation: Robust pagination condition across endpoints.
  - Status: done
- L193, L261: Fix indentation below ':'.
  - Fix: Adjusted indentation in B and C branches.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:193,261
  - Explanation: Readability and style.
  - Status: done
- L190, L258: want_more: resp.StatusCode != 429 && resp.StatusCode < 500.
  - Fix: Updated conditions and comments.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:190,258,335
  - Explanation: Avoid hammering API on throttling/server errors; proceed on 4xx (except 429).
  - Status: done
- L220: Text: company records.
  - Fix: Corrected wording and implemented path to emit threat then continue.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:220–240
  - Explanation: Clean handling of empty companies result.
  - Status: done
- L229, L233, L248: Do encode in CEL; decode in pipeline; inline single-use macros.
  - Fix: CEL now always emits a JSON string in message; removed event.original from CEL; inlined evts blocks.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs
  - Explanation: Simpler CEL, consistent with CrowdStrike; the ingest pipeline owns parsing.
  - Status: done
- L42: tracer config map form.
  - Fix: resource.tracer: enabled/filename/maxbackups.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs:39–45
  - Explanation: Align with current CEL resource tracer options.
  - Status: done
- L387: Add final newline.
  - Fix: Ensured file ends with newline.
  - Files: packages/bitsight/data_stream/vulnerability/agent/stream/cel.yml.hbs
  - Explanation: Formatting hygiene.
  - Status: done

### packages/bitsight/data_stream/vulnerability/elasticsearch/ingest_pipeline/default.yml
- L1: Set event.* fields.
  - Fix: event.kind=event, event.category=vulnerability, event.type=info.
  - Files: packages/bitsight/data_stream/vulnerability/elasticsearch/ingest_pipeline/default.yml
  - Explanation: ECS categorization aligned with CrowdStrike’s vulnerability data stream.
  - Status: done
- L110: on_failure set event.kind=pipeline_error and tag preserve_original_event.
  - Fix: Added guarded on_failure processors to set event.kind and preserve_original_event tag.
  - Files: packages/bitsight/data_stream/vulnerability/elasticsearch/ingest_pipeline/default.yml (on_failure)
  - Explanation: Better error visibility; match guidance in reviewer’s suggestion.
  - Status: done
- Parse from event.original and preserve/remove behavior.
  - Fix: Rename message→event.original; json decode to bitsight when String; copy when Map; drop polling; remove event.original unless preserve_original_event tag is present.
  - Files: packages/bitsight/data_stream/vulnerability/elasticsearch/ingest_pipeline/default.yml:5–31
  - Explanation: Runtime parity with CrowdStrike; tests remain stable; “preserve original” honored.
  - Status: done

### packages/bitsight/img/bitsight.png
- L1: PNG not needed; SVG covers logo.
  - Fix: Removed PNG and screenshot reference from manifest.
  - Files: packages/bitsight/img/bitsight.png (removed), packages/bitsight/manifest.yml
  - Explanation: Prefer single SVG icon; avoid duplicate asset maintenance.
  - Status: done

### packages/bitsight/manifest.yml
- L52: type: bool, default: false for enable_request_tracer.
  - Fix: Added default: false.
  - Files: packages/bitsight/manifest.yml:46
  - Explanation: Disable verbose tracing by default; enable only for debugging.
  - Status: done

## Validation Summary
- format: PASS
- lint: PASS
- pipeline: PASS
- static: PASS
- asset: PASS
- system: PASS (with elastic-agent service running; mock links fixed)

