---
name: Validate Dashboard Compilation

on:
  pull_request:
    branches:
      - main
    paths:
      - 'packages/**/_dev/build/kibana/**/*.yaml'
      - 'packages/**/kibana/dashboard/*.json'
      - '.github/workflows/validate-yaml-dashboards.yml'

permissions:
  contents: read

jobs:
  validate-dashboards:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      # Note: Tool versions are pinned to @latest for now. Consider pinning to specific versions
      # for better reproducibility. Check available versions at:
      # - https://pypi.org/project/kb-dashboard-lint/
      # - https://pypi.org/project/kb-dashboard-cli/

      - name: Find changed YAML dashboard files
        id: find-changed
        run: |
          set -e
          
          # Find YAML files changed in the PR diff
          CHANGED_YAML_FILES=$(git diff --name-only origin/main...HEAD -- 'packages/**/_dev/build/kibana/**/*.yaml' 2>/dev/null || true)
          
          if [ -z "$CHANGED_YAML_FILES" ]; then
            echo "No YAML dashboard files changed in this PR"
            echo "changed_files=" >> $GITHUB_OUTPUT
            echo "unique_dirs=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found changed YAML dashboard files:"
          echo "$CHANGED_YAML_FILES"
          echo ""
          
          # Store the list of changed files for linting (we lint each file individually)
          CHANGED_FILES_ESCAPED=$(echo "$CHANGED_YAML_FILES" | tr '\n' ' ' | sed 's/ $//')
          echo "changed_files=$CHANGED_FILES_ESCAPED" >> $GITHUB_OUTPUT
          
          # Find unique input directories to avoid redundant compilation
          # Group files by their input directory (e.g., packages/aws_vpcflow_otel/_dev/build/kibana)
          UNIQUE_DIRS=$(echo "$CHANGED_YAML_FILES" | xargs -n1 dirname | sort -u | tr '\n' ' ' | sed 's/ $//')
          echo "Unique input directories (for compilation):"
          echo "$UNIQUE_DIRS"
          echo ""
          echo "unique_dirs=$UNIQUE_DIRS" >> $GITHUB_OUTPUT

      - name: Lint changed YAML dashboards
        id: lint
        if: steps.find-changed.outputs.changed_files != ''
        run: |
          set +e  # Don't exit on error, we'll handle it manually
          
          CHANGED_FILES="${{ steps.find-changed.outputs.changed_files }}"
          
          # Track linting results
          LINT_FAILED=0
          
          # Process each changed YAML file
          for yaml_file in $CHANGED_FILES; do
            echo "=========================================="
            echo "Linting: $yaml_file"
            echo "=========================================="
            echo ""
            
            # First, show all linting results (warnings, info, errors)
            # Using @latest - consider pinning to a specific version for reproducibility
            echo "Linting results:"
            uvx --from kb-dashboard-lint@latest kb-dashboard-lint check \
                --input-file "$yaml_file" || true
            echo ""
            
            # Then check specifically for warnings/errors (this will exit non-zero on warnings or errors)
            if ! uvx --from kb-dashboard-lint@latest kb-dashboard-lint check \
                --input-file "$yaml_file" \
                --severity-threshold warning > /dev/null 2>&1; then
              echo "❌ ERROR: Linting found warnings or errors in $yaml_file"
              LINT_FAILED=1
            else
              echo "✅ No warnings or errors found in $yaml_file (info may be present above)"
            fi
            
            echo ""
          done
          
          set -e  # Re-enable exit on error
          
          if [ $LINT_FAILED -eq 1 ]; then
            echo ""
            echo "=========================================="
            echo "❌ Dashboard linting FAILED (warnings or errors found)"
            echo "=========================================="
            exit 1
          else
            echo "=========================================="
            echo "✅ All dashboard linting PASSED (no warnings or errors)"
            echo "=========================================="
          fi

      - name: Compile changed YAML dashboards
        id: compile
        if: steps.find-changed.outputs.unique_dirs != ''
        run: |
          set -e
          
          UNIQUE_DIRS="${{ steps.find-changed.outputs.unique_dirs }}"
          
          # Track compilation results
          COMPILATION_FAILED=0
          COMPILED_DIRS=""
          
          # Create temporary directory for compiled outputs
          TEMP_DIR=$(mktemp -d)
          echo "Temporary compilation directory: $TEMP_DIR"
          
          # Process each unique input directory (avoids redundant compilation)
          for input_dir in $UNIQUE_DIRS; do
            echo "=========================================="
            echo "Compiling directory: $input_dir"
            echo "=========================================="
            
            # Extract package name from path (e.g., packages/aws_vpcflow_otel/_dev/...)
            package_name=$(echo "$input_dir" | sed 's|packages/\([^/]*\)/.*|\1|')
            temp_output_dir="$TEMP_DIR/${package_name}/kibana/dashboard"
            
            # Create temp output directory
            mkdir -p "$temp_output_dir"
            
            echo "Input directory: $input_dir"
            echo "Temp output directory: $temp_output_dir"
            echo ""
            
            # Compile entire directory to JSON format (compiles all YAML files in the directory)
            # Using @latest - consider pinning to a specific version for reproducibility
            if uvx --from kb-dashboard-cli@latest kb-dashboard compile \
                --input-dir "$input_dir" \
                --output-dir "$temp_output_dir" \
                --format json; then
              echo "✅ Compiled directory: $input_dir"
              COMPILED_DIRS="$COMPILED_DIRS $input_dir"
            else
              echo "❌ ERROR: Failed to compile directory $input_dir"
              COMPILATION_FAILED=1
            fi
            
            echo ""
          done
          
          # Store temp directory and compiled directories for comparison step
          echo "temp_dir=$TEMP_DIR" >> $GITHUB_OUTPUT
          if [ -n "$COMPILED_DIRS" ]; then
            COMPILED_DIRS_ESCAPED=$(echo "$COMPILED_DIRS" | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
            echo "compiled_dirs=$COMPILED_DIRS_ESCAPED" >> $GITHUB_OUTPUT
          fi
          
          if [ $COMPILATION_FAILED -eq 1 ]; then
            echo "❌ Compilation failed for one or more directories"
            rm -rf "$TEMP_DIR"
            exit 1
          fi

      - name: Compare compiled vs existing dashboards
        id: compare
        if: steps.compile.outputs.compiled_dirs != ''
        run: |
          set -e
          
          COMPILED_DIRS="${{ steps.compile.outputs.compiled_dirs }}"
          TEMP_DIR="${{ steps.compile.outputs.temp_dir }}"
          VALIDATION_FAILED=0
          
          # Process each compiled directory
          for input_dir in $COMPILED_DIRS; do
            echo "=========================================="
            echo "Comparing compiled output for: $input_dir"
            echo "=========================================="
            
            # Extract package name from path
            package_name=$(echo "$input_dir" | sed 's|packages/\([^/]*\)/.*|\1|')
            existing_output_dir="packages/${package_name}/kibana/dashboard"
            compiled_output_dir="$TEMP_DIR/${package_name}/kibana/dashboard"
            
            # Check if dashboard output directory exists
            if [ ! -d "$existing_output_dir" ]; then
              echo "❌ ERROR: Dashboard output directory does not exist: $existing_output_dir"
              VALIDATION_FAILED=1
              continue
            fi
            
            # Compare compiled files with existing files
            if diff -r "$compiled_output_dir" "$existing_output_dir" > /dev/null 2>&1; then
              echo "✅ PASSED: YAML dashboards in $input_dir compile correctly and match existing JSON files"
            else
              echo ""
              echo "❌ ERROR: Compiled output does not match existing JSON files in $existing_output_dir"
              echo ""
              echo "Differences found:"
              diff -r "$compiled_output_dir" "$existing_output_dir" || true
              echo ""
              echo "The YAML dashboard(s) were modified but the JSON was not updated."
              echo "Please run the following command to update the JSON files:"
              echo "  cd $input_dir && uvx --from kb-dashboard-cli@latest kb-dashboard compile --input-dir . --output-dir ../../kibana/dashboard --format json"
              echo ""
              VALIDATION_FAILED=1
            fi
            
            echo ""
          done
          
          # Clean up temp directory
          rm -rf "$TEMP_DIR"
          
          # Exit with error if any validation failed
          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo ""
            echo "=========================================="
            echo "❌ Dashboard validation FAILED"
            echo "=========================================="
            exit 1
          else
            echo "=========================================="
            echo "✅ All dashboard validations PASSED"
            echo "=========================================="
          fi
