---
name: Validate Dashboard Compilation

on:
  pull_request:
    branches:
      - main
    paths:
      - 'packages/**/_dev/build/kibana/**/*.yaml'
      - 'packages/**/kibana/dashboard/*.json'
      - '.github/workflows/validate-dashboards.yml'

permissions:
  contents: read

jobs:
  validate-dashboards:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Find and validate YAML dashboards
        run: |
          set -e
          
          # Find all YAML dashboard files in _dev/build/kibana directories
          YAML_FILES=$(find packages -type f -path "*/_dev/build/kibana/**/*.yaml" 2>/dev/null || true)
          
          if [ -z "$YAML_FILES" ]; then
            echo "No YAML dashboard files found to validate"
            exit 0
          fi
          
          echo "Found YAML dashboard files:"
          echo "$YAML_FILES"
          echo ""
          
          # Track if any validation fails
          VALIDATION_FAILED=0
          
          # Process each YAML file
          for yaml_file in $YAML_FILES; do
            echo "=========================================="
            echo "Validating: $yaml_file"
            echo "=========================================="
            
            # Extract package name from path (e.g., packages/aws_vpcflow_otel/_dev/...)
            package_name=$(echo "$yaml_file" | sed 's|packages/\([^/]*\)/.*|\1|')
            dashboard_output_dir="packages/${package_name}/kibana/dashboard"
            
            # Check if dashboard output directory exists
            if [ ! -d "$dashboard_output_dir" ]; then
              echo "❌ ERROR: Dashboard output directory does not exist: $dashboard_output_dir"
              VALIDATION_FAILED=1
              continue
            fi
            
            echo "Compiling YAML to JSON format..."
            echo "Output directory: $dashboard_output_dir"
            echo ""
            
            # Run kb-dashboard compile with --format json and --exit-non-zero-on-change
            # The --exit-non-zero-on-change flag will cause the command to exit with non-zero
            # if there are differences between the compiled output and existing files
            if uvx --from kb-dashboard-compiler kb-dashboard compile \
                --input-dir "$(dirname "$yaml_file")" \
                --output-dir "$dashboard_output_dir" \
                --format json \
                --exit-non-zero-on-change; then
              echo "✅ PASSED: $yaml_file compiles correctly and matches existing JSON files"
            else
              exit_code=$?
              echo ""
              echo "❌ ERROR: Compiled output does not match existing JSON files in $dashboard_output_dir"
              echo ""
              echo "The YAML dashboard was modified but the JSON was not updated."
              echo "Please run the following command to update the JSON files:"
              echo "  cd \$(dirname $yaml_file) && uvx --from kb-dashboard-compiler kb-dashboard compile --input-dir . --output-dir ../../kibana/dashboard --format json"
              echo ""
              VALIDATION_FAILED=1
            fi
            
            echo ""
          done
          
          # Exit with error if any validation failed
          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo ""
            echo "=========================================="
            echo "❌ Dashboard validation FAILED"
            echo "=========================================="
            exit 1
          else
            echo "=========================================="
            echo "✅ All dashboard validations PASSED"
            echo "=========================================="
          fi
