---
description: Set correlation keys and blended calculation weights.
processors:
  - set:
      field: indexing_weight
      value: "{{{_conf.indexing_weight}}}"
  - set:
      field: querying_weight
      value: "{{{_conf.querying_weight}}}"
  - set:
      field: storage_weight
      value: "{{{_conf.storage_weight}}}"
  - script:
      lang: painless
      source: >
        if (ctx.cluster_name != null) {
          ctx.deployment_id = ctx.cluster_name;
        }
        if (ctx['@timestamp'] != null) {
          def date = ZonedDateTime.parse(ctx['@timestamp']).toLocalDate().toString();
          ctx.composite_key = date + '_' + ctx.deployment_id;
          if (ctx.tier != null) ctx.composite_tier_key = ctx.composite_key + '_' + ctx.tier.replace('/', '_');
          if (ctx.datastream != null) ctx.composite_datastream_key = ctx.composite_key + '_' + ctx.datastream;
        }
      ignore_failure: true
  # - remove:
  #     field:
  #       - _conf